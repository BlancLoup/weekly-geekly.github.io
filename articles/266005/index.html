<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tyuni memory and network stack in Linux: the history of the transfer of high-loaded servers to a fresh distribution</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Until recently, Odnoklassniki used the partially updated OpenSuSE 10.2 as the main Linux distribution. However, it became increasingly difficult to ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tyuni memory and network stack in Linux: the history of the transfer of high-loaded servers to a fresh distribution</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/ff4/f8a/000/ff4f8a000a92a27f8f91112bd1d0c7cc.jpg" alt="image"><br><br>  Until recently, Odnoklassniki used the partially updated OpenSuSE 10.2 as the main Linux distribution.  However, it became increasingly difficult to maintain it, so from last year we moved to active migration to CentOS 7. At the preparatory stage of the transition, all internal procedures for CentOS were worked out, configs and configuration policies were prepared (we use CFEngine).  Therefore, in many cases, the migration from one distribution kit to another consists in installing the OS via kickstart and deploying the application using the deployment system of our development - everything else is done without human intervention.  This happens in many cases, although not in all. <br><br>  But we faced the biggest problems when migrating video distribution servers.  It took us half a year to solve them. <br><a name="habracut"></a><br>  Briefly about their configuration: <br><ul><li>  4 x 10 Gbps to users </li><li>  2 x 10 Gbps to the storage </li><li>  256 GB RAM - memory cache </li><li>  22 x 480 GB SSD cache on SSD </li><li>  2 x E5-2690 v2 </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Several metrics characterizing video distribution: <br><ul><li>  600 Gbit / s  - total peak video upload rate </li><li>  220M video views per day </li><li>  600K simultaneously viewed videos </li></ul><br><br><h4>  <font color="#f07d00">Problem 1 - a strong increase in CPU system time</font> </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/836/f96/55a/836f9655a3602d87c35f57407fda6431.jpg" alt="image"><br><br>  Shortly after the launch of the first server, the processor load began to grow strongly at system time. <br>  At the same time, a lot of migration and ksoftirqd processes were visible in the top.  At first we tried to spin the kernel settings.  What did not help us: <br><ul><li>  increase sched_migration_cost </li><li>  disable transparent_hugepage </li><li>  increase vfs_cache_pressure </li><li>  NUMA off </li></ul><br>  With the next increase in load, perf top showed a 50% load on isolate_freepages_block.  In itself, the name of the call to us, unfortunately, does not say anything.  But the word freepages was a bit confusing, because  There was about 45 GB of free memory on the server.  From our experience, we already knew that if there is a lot of free memory on the server, and the kernel still complains about its lack (sometimes this is expressed in the launch of the OOM killer), then, most likely, the <b>problem is in fragmentation</b> .  Resetting the disk cache ( <code>echo 3 &gt; /proc/sys/vm/drop_caches</code> ) instantly healed the server, which only confirmed our assumptions. <br><br>  Memory fragmentation is a common problem (and not only characteristic of Linux), and changes are regularly made to the kernel to combat it.  One of the culprits of fragmentation is the kernel itself, or rather the disk cache, which can neither be disabled nor limited in size.  This does not mean that the fragmentation in our case was caused by the disk cache, but the exact reasons were not so important.  More important was the decision - defragmentation.  Such a mechanism is in the kernel, but it is obvious that it did not cope (or instead of it, a memory release was launched - global reclaim).  Defragmentation starts only when the free memory drops below a certain mark (zone watermark), and in our case it happened too late.  The only way to make it start earlier is to <b>increase min_free_kbytes</b> via sysctl.  This parameter tells the kernel to try to keep part of the memory free, and to satisfy this requirement, it has to start defragmentation earlier.  In our case, enough values ‚Äã‚Äãin 1 GB. <br><br><h4>  <font color="#f07d00">Problem 2 - swap care</font> </h4><br>  For a start it is worth mentioning that we use vm.swappiness = 0, because we know for sure that for us the swap is evil.  So, there is about 45 GB of free memory on the server and yet it periodically goes into a swap.  How is this possible?  For a start it is worth recalling that memory in Linux is not one big chunk. <br><ul><li>  Memory is divided into nodes: one physical processor - one node. </li><li>  Each node is divided into zones (view for 64-bit systems) - ZONE_DMA (0-16 MB), ZONE_DMA32 (0-4 GB), ZONE_NORMAL (4+ GB). </li><li>  Each zone is divided into memory areas of the size of a power of two (order of 2), i.e.  2 <sup>0</sup> * PAGE_SIZE, 2 <sup>1</sup> * PAGE_SIZE ... 2 <sup>10</sup> * PAGE_SIZE (the current distribution can be found in / proc / buddyinfo).  The lack of free areas of large size - this is the fragmentation, which we discussed in the previous section. </li></ul><br><br>  At first, we again blamed fragmentation, but a further increase in min_free_kbytes, as well as an increase in vfs_cache_pressure, did not help us.  I had to get acquainted with the numastat ( <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> utility <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> <table><tbody><tr><th colspan="4"> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </th> </tr><tr><th></th><th> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </th> <th> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </th> <th> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </th> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code><b><font color="red">numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 Total <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></b></code></code> </td> <td> <code><code><b><font color="red">numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> 80319.76 <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></b></code></code> </td> <td> <code><code><b><font color="red">numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> 123461.82 <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></b></code></code> </td> <td> <code><code><b><font color="red">numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> 203781.58 Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></b></code></code> </td> </tr><tr><th colspan="4"> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </th> </tr><tr><th></th><th> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </th> <th> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </th> <th> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </th> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> <td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> </td> </tr></tbody></table> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> <h4> <code><code><font color="#f07d00">numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br>  3 ‚Äî      <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code></code> </h4> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code></code> <ol><li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> <li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> <li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> <li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> </ol> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <h5> <code><font color="#f07d00"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> Flow director <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code> </h5> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <h5> <code><font color="#f07d00"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> Perfect filter (ntuple) <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code> </h5> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <h5> <code><font color="#f07d00"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> Signature Filter <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code> </h5> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <blockquote> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </blockquote> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <h5> <code><font color="#f07d00"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> RPS (receive packet steering) <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code> </h5> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <h5> <code><font color="#f07d00"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> RFS (receive flow steering) <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code> </h5> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <table><tbody><tr><th> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </th> <th> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </th> </tr><tr><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </td><td> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </td></tr></tbody></table> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <h5> <code><font color="#f07d00"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> Accelerated RFS <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code> </h5> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <h4> <code><font color="#f07d00"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br>  4 ‚Äî   broken pipe <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code> </h4> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <h4> <code><font color="#f07d00"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br>  5 ‚Äî    <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code> </h4> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <ul><li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> <li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> <li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> <li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> </ul> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <h4> <code><font color="#f07d00"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br>  <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code> </h4> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <ol><li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> <li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> <li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> <li> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> </ol> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <h4> <code><font color="#f07d00"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br>  <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code> </h4> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <h4> <code><font color="#f07d00"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br>  <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></font></code> </h4> <code><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> <ol><li> <code><a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         </a><a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> <li> <code><a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         </a><a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD <a href="https://wiki.centos.org/About/Product">https://wiki.centos.org/About/Product</a></code> </li> <li> <code><a href="https://wiki.centos.org/About/Product"><code>numastat -m ). <br> <br>          .    tmpfs (   ),     1       . <br> <br>       numastat?  ,  <b>       </b> : <br> Per-node process memory usage (in MBs) for PID 7781 (java) Node 0 Node 1 Total Huge 0 0 0 Heap 0.20 0.14 0.34 Stack 118.82 137.87 256.70 Private 80200.73 123323.81 203524.55 <b><font color="red">Total</font></b> <b><font color="red">80319.76</font></b> <b><font color="red">123461.82</font></b> <b><font color="red">203781.58</font></b> Per-node system memory usage (in MBs): Node 0 Node 1 Total MemTotal 131032.75 131072.00 262104.75 MemFree 1228.93 639.84 1868.78 MemUsed 129803.82 130432.16 260235.98 Active 23224.13 121073.42 144297.55 Inactive 101138.88 3753.98 104892.85 Active(anon) 1690.50 120997.86 122688.36 Inactive(anon) 79528.66 3560.95 83089.61 Active(file) 21533.63 75.57 21609.20 Inactive(file) 21610.21 193.03 21803.24 Unevictable 0 0 0 Mlocked 0 0 0 Dirty 0.11 0.02 0.13 Writeback 0 0 0 FilePages 122397.46 124295.47 246692.93 Mapped 78436.03 122947.26 201383.29 AnonPages 1966.62 532.02 2498.64 Shmem 79251.21 123964.70 203215.90 KernelStack 2.44 2.57 5.01 PageTables 158.62 252.29 410.91 NFS_Unstable 0 0 0 Bounce 0 0 0 WritebackTmp 0 0 0 Slab 1801.95 1932.29 3734.23 SReclaimable 1653.13 1818.79 3471.92 SUnreclaim 148.82 113.49 262.31 AnonHugePages 1856.00 498.00 2354.00 HugePages_Total 0 0 0 HugePages_Free 0 0 0 HugePages_Surp 0 0 0 <br>        NUMA,       1   tmpfs  . <b>    interleave</b> (numactl ‚Äîinterleave=all,      )   . <br> <br> <font color="#f07d00"> 3 ‚Äî     </font> <br> , ,     ,        .        (   ,   ,     ): <br> <br> <b>CPU0    (  softirq).</b>   ,       ,     ,     .     (     ,   ethtool -l/-L</code> ). ,  1   Intel    8,  10   ‚Äî  128. <b>  .</b>  ,  ,    CPU0.   irq_balancer. <b>   .</b>   ,   ,   .     set_irq_affinity (  )   ‚Äî    RSS (receive side scaling) ‚Äî         </a><a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">https://www.kernel.org/doc/Documentation/networking/scaling.txt.</a> <b>    8  ,     8 ,      16 ,    .</b> <br> ?..    . <br>       16    ,  Intel     ( 10 ),  ,  ,  16. <br> <br>   16 ‚Äî    ,      RSS.   RSS- ,     4 ,    ,     ‚Äî 16.          . <br> <br>     Intel,     . -,              (     ,    ).     , ..   ,   ,  . <br> <br> -,    Flow director. <br> <br>  ,    ,   ,                 ,    . ,      . <br> <br> <font color="#f07d00">Flow director</font> <br> Flow director,    Intel,   2  ‚Äî Signature Filter (  ATR ‚Äî Application Targeted Receive)  Perfect filter. Flow director   -IP ,     .    /    flow director: <code>ethtool -S ethN|grep fdir</code> <br> <br> <font color="#f07d00">Perfect filter (ntuple)</font> <br>     8 000 .   Perfect filter /  <code>ethtool -u/U flow-type</code> . <br> <br> <font color="#f07d00">Signature Filter</font> <br>     32 000 .  , ATR ,    (   ) __ SYN           . <br> <br> During transmission of a packet (every 20 packets by default), a hash is calculated based on the 5-tuple. The (up to) 15-bit hash result is used as an index in a hash lookup table to store the TX queue. When a packet is received, a similar hash is calculated and used to look up an associated Receive Queue. For uni-directional incoming flows, the hash lookup tables will not be initialized and Flow Director will not work. For bidirectional flows, the core handling the interrupt will be the same as the core running the process handling the network flow. <br> [1] <br> <br> ..,        ,       SYN,   20  (      ,     AtrSampleRate).      ATR,     RSS (..   16 ).        .   flow director  <code>ethtool -S ethN | grep fdir</code> ,     fdir_miss. ..     ATR,    RSS.         16 .    ( <a href="https://sourceforge.net/p/e1000/bugs/464/">https://sourceforge.net/p/e1000/bugs/464/</a> ),      ,         ‚Äî RPS. <br> <br>     ,     ‚Äî    <code>ethtool -k ethN ntuple on</code> .      ATR,    Perfect filter, , ,      ,    . <br> <br> <font color="#f07d00">RPS (receive packet steering)</font> <br>   .   2 ( RSS)        ‚Äî scaling.txt. <br> <br>     (     irq_balancer). <br> <br>               . ,    ,   ,       16.     ,    ,     ,     ,   .  RPS,    RSS,     16 (..   ),     (  ,    rps_cpus  ,     ). <br> <br> ..     , , ,   ,   , ..    ‚Äî   ‚Äî    .    ,     scaling.txt    RFS. <br> <br> <font color="#f07d00">RFS (receive flow steering)</font> <br>         ?             ,     ,      ,   . ..      ,  ,   ,    . <br> <br>     [2]: <br> RPS RFS <img src="https://habrastorage.org/getpro/habr/post_images/337/157/e27/337157e278de30ebd46e60fb3ca30001.png" alt="RPS"> <img src="https://habrastorage.org/getpro/habr/post_images/cca/309/c70/cca309c709b4c105c0d98796aae9e634.png" alt="RFS"> <br> <br> <font color="#f07d00">Accelerated RFS</font> <br>      scaling.txt,      Accelerated RFS.     ?    RFS               .     Accelerated RFS    ,    .              Mellanox. <br> <br>   ,          .   ,       kernel panic. <br> <br>        ,            . ,    firmware         . <br> <br> <font color="#f07d00"> 4 ‚Äî   broken pipe</font> <br>    broken pipe      OpenSuSE,     CentOS      .     ,    ,  ‚Äú‚Äù    . <br> <br> Broken pipe ‚Äî  ,  ,        pipe.    pipe  ,   ‚Äî   .   ,    ,  ,    ,     pipe   broken pipe.       ,     ,       ( <b>half-duplex tcp close sequence</b> ),       - .                   ?        ?      , ..         ,    ,     .      . <br> <br>    ‚Äî  "packet reordering" ( <a href="http://en.wikipedia.org/wiki/Out-of-order_delivery">http://en.wikipedia.org/wiki/Out-of-order_delivery</a> ),   . ..  ,    ,  ,  ,  <b> RFS    broken pipe</b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e7c/753/a76/e7c753a767af4707f152b373b9f3a123.jpg" alt="image"> <br> <br>  ,       ‚Äî  interrupt coalescing.    ,    . <br> <br> <font color="#f07d00"> 5 ‚Äî   </font> <br>   ,    Counter Strike      latency,     (   ,     )    .    ,   <b>  </b> (   )  <b>  </b> (),   <b>     softirq</b> .         softirq   50%     . <br> <br> ,     CPU, ‚Äî   .      interrupt coalescing,    <code>ethtool -c/-C</code> . <b>   interrupt coalescing    ‚Äî    ,    </b> . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cde/a25/e1d/cdea25e1d694858868d63d012edf8225.jpg" alt="image"> <br> <br>  ,   softirq  ,     ,   . <br>  : <br> [rx|tx]-usecs ‚Äî           [rx|tx]-frames ‚Äî  ,      *-irq ‚Äî          *-[low|high] ‚Äî       <br> <br> <font color="#f07d00"></font> <br>      : <br> ,   2024  [3]    broken pipe  40     (    50   )       (   CFEngine    ) <br>               . <br> <br> <font color="#f07d00"></font> <br>       ,       ,   -,          .       ,   .    . <br> <br> <font color="#f07d00"></font> <br> <a href="https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf">https://networkbuilders.intel.com/docs/network_builders_RA_packet_processing.pdf</a> <a href="https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD">https://wiki.freebsd.org/201305DevSummit/NetworkReceivePerformance/ComparingMutiqueueSupportLinuxvsFreeBSD</a> https://wiki.centos.org/About/Product</code> </li> </ol></div><p>Source: <a href="https://habr.com/ru/post/266005/">https://habr.com/ru/post/266005/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265989/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 11. "Script's Twenty-Dollar Dumps"</a></li>
<li><a href="../265991/index.html">Making social buttons in three steps</a></li>
<li><a href="../265993/index.html">Compiled data bindings in Windows 10 applications</a></li>
<li><a href="../265997/index.html">Grokay RxJava, part four: Jet Android</a></li>
<li><a href="../266003/index.html">Sell ‚Äã‚Äãin 60 seconds. Call center in the cloud and a special SIM card</a></li>
<li><a href="../266007/index.html">Industrial control system: how we created a system for the exact calculation of the machine tool life of a large plant</a></li>
<li><a href="../266009/index.html">Apache Spark or the return of the prodigal user</a></li>
<li><a href="../266011/index.html">Takari: Maven on steroids</a></li>
<li><a href="../266013/index.html">Digest of grocery design, August 2015</a></li>
<li><a href="../266015/index.html">IBM Watson cognitive system: principles of working with natural language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>