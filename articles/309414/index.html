<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering of visual stories (part 2)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue our series of articles about how to get into the insides of game engines and pull out all sorts of content from them. For those who have j...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering of visual stories (part 2)</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/819/2fa/392/8192fa392bf549e58a2d3323fb75dce6.jpg" align="right">  We continue our series of articles about how to get into the insides of game engines and pull out all sorts of content from them.  For those who have just joined us, let me briefly remind you that we have studied such a funny genre as visual novels. </p><br><p>  Much time has passed since we <a href="https://habrahabr.ru/post/281595/">learned how to parse the archives of the Yuka visual novel engine</a> , it is time to take on the most interesting thing that we found there - the script itself.  Running a little ahead, I‚Äôll warn you right away that the script is, of course, much more complicated matter than just an archive with files, so we don‚Äôt understand it in one article, but today we will try to understand what parts it consists of and get access to text resources. </p><br><p>  Before diving into the depths of binary dumps, let's estimate how most of the visual novel engines work.  A visual novel in itself consists of text (heroes' replicas, dialogues, intermediate narration), graphics and sounds.  In order to reproduce it to the user, it is clearly necessary to bring it all together with the help of some kind of control action.  In theory, it would be possible to sew it all directly into an exe-file, but in 99% of cases (okay, I'm lying, I‚Äôm not 100% seen by me personally), but they still do not store such instructions separately as a separate script program.  As a rule, the script is written in a special programming language (specific to the engine), which looks something like this: </p><br><a name="habracut"></a><br><pre><code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$ </span></span>tarot = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">$ </span></span>memory = <span class="hljs-number"><span class="hljs-number">0</span></span> scene bg01_1 with dissolve play music <span class="hljs-comment"><span class="hljs-comment">"bgm/8.mp3"</span></span> fadein (<span class="hljs-number"><span class="hljs-number">2.0</span></span>) play ambience <span class="hljs-comment"><span class="hljs-comment">"amb/forest.mp3"</span></span> fadein (<span class="hljs-number"><span class="hljs-number">3.0</span></span>) <span class="hljs-comment"><span class="hljs-comment">"Morning."</span></span> <span class="hljs-comment"><span class="hljs-comment">"Not my favourite time of the day."</span></span> <span class="hljs-comment"><span class="hljs-comment">"The morning is when you're not awake enough to do anything..."</span></span></code> </pre> <br><p>  This is a fragment of the script source from one VN to <a href="https://www.renpy.org/">Ren'Py</a> - one of the most popular free / free engines.  Leaving beyond the scope of this article, the question of how good Ren'Py is in itself is, for the time being, just note what is usually included in the script of the visual novel and what we will need to find: </p><br><ul><li>  the text - it is still either not assigned to any character (ie, the text "from the narrator" - as in our example), or it is pronounced by someone </li><li>  commands to show graphics - background / sprite ( <code>scene bg01_1</code> ), sometimes with some special effect ( <code>with dissolve</code> ) </li><li>  commands to start playing music or sounds ( <code>play music</code> , <code>play ambience</code> ), sometimes also with some additional parameters, most often lengths of fade-in and fade-out (smoothly increasing volume) </li><li>  working with variables: setting ( <code>$ tarot = 0</code> , check, branch) </li><li><p>  there are still commands: </p><br><ul><li>  for reproduction of the speech made by heroes </li><li>  for management </li><li>  service things like comments, tags, macros </li></ul><br></li></ul><br><p>  Of course, in the real world, we often will not have access to the source code of the script.  People have already learned how to write compilers for 50 years (as opposed to interpreters), so usually the script source code is compiled into some binary code (byte code), which is then executed by the virtual machine inside the visual novel engine.  Sometimes lucky and for some popular engines there are legally or not so legally available tools - debuggers, compilers, decompilers, script validators, etc., but more often life is not so simple. </p><br><p>  So, back to our visual novel, which we began to explore in the last article - <a href="https://vndb.org/v13353">Koisuru Shimai no Rokujuso</a> .  We have already unpacked its archives and found inside both graphics, and sounds, and music, and, most importantly and incomprehensible so far - a handful of files with the extension .yks.  Presumably, they constitute the script novels.  By the way, there are a lot of files: </p><br><pre> <code class="hljs vhdl">YKS/ScriptStart.yks YKS/trial/Yoyaku.yks YKS/trial/trial_00100.yks YKS/trial/trial_00200.yks YKS/<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>/all_00010.yks ... YKS/<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>/all_02320.yks</code> </pre> <br><p>  Total 103 files in YKS / all /.  Let me remind you, we absolutely honestly downloaded and investigated the trial version - but, apparently, the developers were a bit lazy and, apparently, in the trial / lies the script for the trial version, and in all / - for the full one. </p><br><p>  Generally, based on the minimum experience, the builders of the visual story engines have 2 approaches: either everything is packaged in one giant file, or there are many files and each has its own scene or event.  Here it seems that the second.  In addition, there is still a separate ScriptStart.yks - but as such it will most likely be practically uninteresting to us: the fact is that developers often want to make the engine as versatile as possible and implement all sorts of user interfaces, load-save menus, and more .d  also using your own scripting language.  It is possible to deal with this, but rather boring and unproductive: therefore, I suggest taking the bull by the horns and starting with the actual game scenario. </p><br><p>  What can we say from the surface visual inspection?  First, because  Since the game runs under Windows, it‚Äôs quite realistic to run it and see how it looks.  We spend the n-th amount of time, we find the Windows machine, we start, we see what happens immediately after pressing the button to start the new game: </p><br><img src="https://habrastorage.org/files/9fd/069/bd8/9fd069bd85e14400935121fa3698495d.png" alt="Immediately after the start of the game"><br><p><br>  We seem to meet the beginning of the story.  Here is the background (after a brief search in BG / there is a file bg01_01.png with this background), and there is text.  We still need this text, so it is worth rewriting it from the screen: </p><br><pre> <code class="hljs">ÊÅã„Åô„ÇãÂßâÂ¶π„ÅÆÂÖ≠ÈáçÂ•è„Äå„Çª„ÇØ„Çπ„ÉÜ„ÉÉ„Éà„Äç‰ΩìÈ®ìÁâàVer2„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÈ†Ç„Åç„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ</code> </pre> <br><p>  Two notes: </p><br><ol><li><p>  If there are problems with typing Japanese text, I can recommend to learn three or four techniques that greatly simplify this matter and with a certain patience give the opportunity to type Japanese texts to those who absolutely have no idea what kind of squiggles are.  Each icon is viewed separately: </p><br><ul><li>  check whether this is a punctuation mark on the following table: „Äå...„Äç „ÄÅ ÔºàÔºâ„ÄÇ - if we are lucky, then copy;  Pay attention to the fact that "commas", and "points", and the brackets here are specific. </li><li>  if not, look in this table: „ÅÇ „ÅÑ „ÅÜ „Åà „Åä „Åã „Åç „Åè „Åë „Åì „Åï „Åó „Åô „Åõ „Åù „Åü „Å° „Å§ „Å¶ „Å® „Å™ „Å´ „Å¨ „Å≠ „Çç „ÅØ „Å≤ „ÇÅ „ÇÇ „Çè „ÇÜ „ÇÜ „Çà „Çä „Çã „Çí „Çå „Åæ „Åæ „Åø „ÇÄ „ÇÅ „ÇÇ </li><li>  Then we look for this:  „Ç§ „Ç¶ „Ç® „Ç™ „Ç´ „Ç≠ „ÇØ „Ç≥ „Çµ „Ç∑ „Çπ „Çª „ÇΩ „Çø „ÉÅ „ÉÑ „ÉÜ „Éà „Éä „Éã „Éå „Éç „Éé „Éè „Éí „Éï „Éò „Éõ „Éû „Éü „É† „É° „É° „É¢ „É§ „É¶ „ÉØ „ÉØ „Éõ „Éû „Éü „Éü </li><li>  if it didn't help - for example, got caught ÊÅã - then this is kanji;  then we increase the font by 300-500% so that all the fine details can be clearly seen and go to <a href="http://jisho.org/">jisho.org in the "search by radicals" section</a> ;  there we look at the table of constituent parts (radicals) and look for similar ones to what we see;  using  as an example - after a short meditation we find that it has an integral part of it from below  - we hold down the button with this component and from many thousands we have only a couple of dozen icons;  we look through their eyes and find the fifth sign from the beginning in the section "10" - this will be the required. </li></ul><br></li><li>  I'm not sure if there will be Ver2 or Ôº∂ÔΩÖÔΩíÔºí there - note, these are not different fonts, but suddenly so-called full-width characters - in Unicode they are somewhere in the U + FF01..U + FF5E region). </li></ol><br><p>  We will need the text for two things.  First, actually, as a text, understand what is happening (even if you don‚Äôt speak Japanese, you can insert it into Google translator and understand that we are thanked here for downloading the trial version of this game =&gt; i.e. this is not a real start plot, and a kind of introduction, "from the author").  Secondly, we can take this text or a piece of it, convert it to ShiftJIS (and most likely, as we found out in the previous article, everything will be exactly in this encoding) and search it in files.  Take a piece from the end and prepare what we look for: </p><br><pre> <code class="hljs ruby">$ echo <span class="hljs-string"><span class="hljs-string">'„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÈ†Ç„Åç„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô'</span></span> <span class="hljs-params"><span class="hljs-params">| iconv -t sjis |</span></span> hd <span class="hljs-number"><span class="hljs-number">00000000</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>f <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">45</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">93</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">81</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>b <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">68</span></span> <span class="hljs-number"><span class="hljs-number">92</span></span> b8 <span class="hljs-number"><span class="hljs-number">82</span></span> ab <span class="hljs-params"><span class="hljs-params">|._.E.....[.h....|</span></span> <span class="hljs-number"><span class="hljs-number">00000010</span></span> <span class="hljs-number"><span class="hljs-number">82</span></span> a<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">82</span></span> e8 <span class="hljs-number"><span class="hljs-number">82</span></span> aa <span class="hljs-number"><span class="hljs-number">82</span></span> c6 <span class="hljs-number"><span class="hljs-number">82</span></span> a4 <span class="hljs-number"><span class="hljs-number">82</span></span> b2 <span class="hljs-number"><span class="hljs-number">82</span></span> b4 <span class="hljs-number"><span class="hljs-number">82</span></span> a2 <span class="hljs-params"><span class="hljs-params">|................|</span></span> <span class="hljs-number"><span class="hljs-number">00000020</span></span> <span class="hljs-number"><span class="hljs-number">82</span></span> dc <span class="hljs-number"><span class="hljs-number">82</span></span> b7 <span class="hljs-params"><span class="hljs-params">|....|</span></span></code> </pre> <br><p>  We are looking for this line in all our .yks files and, of course, we do not find it.  Not so simple. </p><br><p>  Let us make another lyrical digression: let's take a look at how ShiftJIS encoding works.  In Japanese, obviously, there are much more icons than in European ones: in ShiftJIS, each of the icons is encoded with at least 1 byte, at most 2. As can be seen from <a href="http://www.kreativekorp.com/charset/encoding.php%3Fname%3DShift-JIS">this</a> label, the values ‚Äã‚Äãof bytes 00..7F coincide with ASCII, but bytes 81..9F and E0..EA means that this is a two-byte combination, and again for compatibility with binary reading, the second byte will <a href="http://www.kreativekorp.com/charset/encoding.php%3Fname%3DShift-JIS%26char%3D82">not</a> have <a href="http://www.kreativekorp.com/charset/encoding.php%3Fname%3DShift-JIS%26char%3D82">any desired value</a> , but something between 40 and FF. </p><br><p>  Microexcursion into Japanese: 3 groups of icons are used in the language: </p><br><ul><li>  hiragana - it looks something like this: „ÅÇ „Çä „Åå „Å® „ÅÜ „Åî „Åñ „ÅÑ „Åæ „Åô - i.e.  rounded simple written forms;  ~ 50 icons, but there are all sorts of variations like "big i = „ÅÑ, small i = „ÅÉ";  1 syllable = 1 character. </li><li>  katakana - it looks something like this: „ÉÄ „Ç¶ „É≥ „É≠ „Éº „Éâ - i.e.  chopped square, simple printing plates;  the sounds are about the same as hiragana, but used to write mostly borrowed words („ÉÄ „Ç¶ „É≥ „É≠ „Éº „Éâ = da-un-lo: -do = download). </li><li>  kanji - look something like this: ‰Ωì È®ì Áâà - i.e.  as a rule, complex square structures from a heap of different parts and nooks;  with them the hardest thing, here are just many thousands of them. </li></ul><br><p>  Plus, there are still punctuation marks, plus or minus are the same as in European languages: dot, comma, ellipsis <code>‚Ä¶</code> , quotes <code>„Äå„Äç</code> , exclamation and question marks, etc.  But there are usually no gaps.  The trick is that the text constantly alternates "important" words that are written kanji and particles that are written hiragana, as a result of which this mixture is obtained can be somehow disassembled.  For example, take the name of the game ÊÅã „Åô „Çã ÂßâÂ¶π „ÅÆ ÂÖ≠ ÈáçÂ•è: </p><br><ul><li> ÊÅã - kanji </li><li> „Åô „Çã - hiragana </li><li> ÂßâÂ¶π - kanji </li><li> „ÅÆ - hiragana </li><li> ÂÖ≠ ÈáçÂ•è - kanji </li></ul><br><p>  What does this give us in the dry residue?  Very simple: frequency table.  We take the ready-made script of the first visual novel in Japanese that we‚Äôve got, and we quickly look at the boundaries of the ranges of all three groups in Unicode and run such a script on it (sorry for the pun): </p><br><pre> <code class="ruby hljs">stats = {} $stdin.each_char { <span class="hljs-params"><span class="hljs-params">|c|</span></span> t = <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> c.ord <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">0x3041</span></span>..<span class="hljs-number"><span class="hljs-number">0x309F</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:hiragana</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">0x30A0</span></span>..<span class="hljs-number"><span class="hljs-number">0x30FF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:katakana</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">0x4E00</span></span>..<span class="hljs-number"><span class="hljs-number">0x9FCC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:kanji</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> stats[t] <span class="hljs-params"><span class="hljs-params">||</span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span> stats[t] += <span class="hljs-number"><span class="hljs-number">1</span></span> } p stats</code> </pre> <br><p>  and we get something like: </p><br><pre> <code class="hljs ruby">{<span class="hljs-literal"><span class="hljs-literal">nil</span></span>=&gt;<span class="hljs-number"><span class="hljs-number">72384</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:kanji=&gt;</span></span><span class="hljs-number"><span class="hljs-number">5731</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:hiragana=&gt;</span></span><span class="hljs-number"><span class="hljs-number">15377</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:katakana=&gt;</span></span><span class="hljs-number"><span class="hljs-number">2241</span></span>}</code> </pre> <br><p>  those.  in a typical text, it would be ~ 25% kanji, 65% hiragana and 10% katakana. </p><br><p>  It seems time to uncover the tools and dive headlong into the work.  <a href="http://kaitai.io/">Let me</a> briefly remind you that we use the new open source tool <a href="http://kaitai.io/">Kaitai Struct</a> for analyzing binary files with an incomprehensible structure - it allows you to describe templates in the markup language, which you can then apply to the files and quickly visualize their contents, arranged in the form of a tree, and as a mega-bonus then - compile a template directly into the source in virtually any popular programming language (since the previous article, Kaitai Struct began to support not only Java, JavaScript, Python and Ruby, but also C ++, C #, Perl and PHP).  That is, if you look at all the <a href="http://www.tiobe.com/tiobe-index/">lists of top-languages</a> - the top 10 is covered completely, from top 20, if you don‚Äôt take domain-specific things, you don‚Äôt have enough Delphi, Visual Basic (although I‚Äôm little one to imagine someone to do reverse engineering on Old Visual Basic is not .NET), Swift and Go. </p><br><p>  We studied the basic syntax of Kaitai Struct templates in the first part of the article, therefore, who missed / forgot about what it was about - it <a href="https://habrahabr.ru/post/281595/">'s time to familiarize yourself with / refresh it in memory</a> . </p><br><p>  So, we quickly look at the dumps of 3-4 files and we understand that as a starting point we can use this pattern: </p><br><pre> <code class="hljs scala">meta: id: yks application: <span class="hljs-type"><span class="hljs-type">Yuka</span></span> <span class="hljs-type"><span class="hljs-type">Engine</span></span> endian: le seq: - id: magic contents: [<span class="hljs-string"><span class="hljs-string">"YKS001"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - id: magic2 contents: [<span class="hljs-number"><span class="hljs-number">0x30</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0x30</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - id: unknown1 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown2 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown3 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown4 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown5 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown6 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown7 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4</code> </pre> <br><p>  You can immediately draw an analogy with the format YKC.  Since  there at the beginning there was a description of the "header", starting from its length, then most likely the fixed 0x30 found in magic2 everywhere is the length of the original header, so I suggest reading all to 0x30 at once.  It turns out 7 numbers, now it will try to guess what it is. </p><br><p>  For Yoyaku.yks (the file itself is 27741 bytes): </p><br><pre> <code class="hljs scala"> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>1 = <span class="hljs-number"><span class="hljs-number">1845</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>2 = <span class="hljs-number"><span class="hljs-number">7428</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>3 = <span class="hljs-number"><span class="hljs-number">795</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>4 = <span class="hljs-number"><span class="hljs-number">20148</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">7593</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>6 = <span class="hljs-number"><span class="hljs-number">25</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>7 = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  For trial_00100.yks (file 91267 bytes): </p><br><pre> <code class="hljs scala"> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>1 = <span class="hljs-number"><span class="hljs-number">6433</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>2 = <span class="hljs-number"><span class="hljs-number">25780</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>3 = <span class="hljs-number"><span class="hljs-number">2376</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>4 = <span class="hljs-number"><span class="hljs-number">63796</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">27471</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>6 = <span class="hljs-number"><span class="hljs-number">5</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>7 = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  And, for comparison, any file from all, for example all_00010.yks (12968 bytes): </p><br><pre> <code class="hljs scala"> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>1 = <span class="hljs-number"><span class="hljs-number">933</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>2 = <span class="hljs-number"><span class="hljs-number">3780</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>3 = <span class="hljs-number"><span class="hljs-number">353</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>4 = <span class="hljs-number"><span class="hljs-number">9428</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">3540</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>6 = <span class="hljs-number"><span class="hljs-number">1</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>7 = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  What is visible?  First, it‚Äôs all epic like shifts or sizes in a file, because  with a file size of 91K, the numbers float around 25-63K, and when the size of 12K is around 3-9K.  On closer inspection, offsets and sizes are most likely just unknown2, unknown4, unknown5 - they are divided into 4 and fairly large.  Secondly, unknown7 seems to always be 0. Thirdly, unknown6 seems to be asking for something very piece-like.  This may be, for example, the size of the virtual machine's reserved memory space for variables, the number of changing scenes / sprites / backgrounds or something else. </p><br><p>  Immediately after 0x30, even with the naked eye, a table of increasing (or almost always increasing numbers) is visible in the human hex editor.  It is unlikely that the byte code itself: for a byte code is characterized by just a constant repetition of the same sequences.  This is also most likely some offsets - for example, it can be offsets that determine the beginnings of commands in bytecode, or some beginnings-ends of lines of variable length or something else.  We have 7 unknown values, this is not so much - let's look and see if one of them looks like: </p><br><ul><li>  either the length of this section </li><li>  or the absolute offset of the end of this section = the beginning of a new </li><li>  or on the number of 4-byte integers in the region </li></ul><br><p>  Almost the very first attempt fits very well: unknown1 turns out to be the number of elements in this section, and unknown2 turns out to be a pointer to the beginning of the next section.  And, thus, it seems that in practice unknown2 = 0x30 + unknown1 * 4. Add the description immediately, at the same time transferring the header to the explicitly selected type header, and starting to open the sections we call sect1..sectX: </p><br><pre> <code class="hljs scala">seq: - id: header <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: header - id: sect1 size: header.sect2_ofs - <span class="hljs-number"><span class="hljs-number">0x30</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: sect1 types: header: seq: - id: magic contents: [<span class="hljs-string"><span class="hljs-string">"YKS001"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - id: magic2 contents: [<span class="hljs-number"><span class="hljs-number">0x30</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0x30</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - id: sect1_qty <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: sect2_ofs <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown3 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown4 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown5 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown6 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown7 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 sect1: seq: - id: entries <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 repeat: expr repeat-expr: _root.header.sect1_qty</code> </pre> <br><p>  As a result, trial_00100 begins to look like this: </p><br><pre> <code class="hljs scala"> [-] <span class="hljs-meta"><span class="hljs-meta">@header</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@magic</span></span> = <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>b <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@magic</span></span>2 = <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@sect</span></span>1_qty = <span class="hljs-number"><span class="hljs-number">6433</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@sect</span></span>2_ofs = <span class="hljs-number"><span class="hljs-number">25780</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>3 = <span class="hljs-number"><span class="hljs-number">2376</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>4 = <span class="hljs-number"><span class="hljs-number">63796</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">27471</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>6 = <span class="hljs-number"><span class="hljs-number">5</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>7 = <span class="hljs-number"><span class="hljs-number">0</span></span> [-] <span class="hljs-meta"><span class="hljs-meta">@sect</span></span>1 [-] <span class="hljs-meta"><span class="hljs-meta">@entries</span></span> (<span class="hljs-number"><span class="hljs-number">6433</span></span> = <span class="hljs-number"><span class="hljs-number">0x1921</span></span> entries) [.] <span class="hljs-number"><span class="hljs-number">0</span></span> = <span class="hljs-number"><span class="hljs-number">6</span></span> [.] <span class="hljs-number"><span class="hljs-number">1</span></span> = <span class="hljs-number"><span class="hljs-number">7</span></span> [.] <span class="hljs-number"><span class="hljs-number">2</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> [.] <span class="hljs-number"><span class="hljs-number">3</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> [.] <span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span> ... [.] <span class="hljs-number"><span class="hljs-number">6425</span></span> = <span class="hljs-number"><span class="hljs-number">2371</span></span> [.] <span class="hljs-number"><span class="hljs-number">6426</span></span> = <span class="hljs-number"><span class="hljs-number">2372</span></span> [.] <span class="hljs-number"><span class="hljs-number">6427</span></span> = <span class="hljs-number"><span class="hljs-number">34</span></span> [.] <span class="hljs-number"><span class="hljs-number">6428</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> [.] <span class="hljs-number"><span class="hljs-number">6429</span></span> = <span class="hljs-number"><span class="hljs-number">2373</span></span> [.] <span class="hljs-number"><span class="hljs-number">6430</span></span> = <span class="hljs-number"><span class="hljs-number">2374</span></span> [.] <span class="hljs-number"><span class="hljs-number">6431</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> [.] <span class="hljs-number"><span class="hljs-number">6432</span></span> = <span class="hljs-number"><span class="hljs-number">2375</span></span></code> </pre> <br><p>  In fact, now it is already noticeable that these are not just increasing values ‚Äã‚Äã‚Äî this may well be a bytecode.  In this file, noticeable increasing numbers apparently go from 0 or 1 and eventually increase to 2375. Suddenly, unknown3 = 2376 is very similar to the number of these very values.  Those.  bytecode refers to another table of some kind, in which there are 2376 different values ‚Äã‚Äã(apparently, from 0 to 2375 inclusive).  What could it be? </p><br><p>  We look at the next section, looking at what happens on the screen 3-4 ahead: </p><br><img src="https://habrastorage.org/files/3a0/1a3/572/3a01a357295f4179b299779ca2db7a78.png"><br><p><br>  In my opinion, it is more or less obvious that these are 16-byte records (1 line) in length, and there is again something strikingly similar to the clearly constantly unevenly increasing displacements or indices.  Will such records be 2376?  Check, rename unknown3 to sect2_qty and add a trivial piece to assemble sect2 from 16-byte records: </p><br><pre> <code class="hljs swift"> - id: sect2 size: <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>: expr <span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>-expr: header.sect2_qty</code> </pre> <br><p>  and, it seems, bingo, this is it very precisely: </p><br><img src="https://habrastorage.org/files/17f/3d1/9ae/17f3d19aecc44f6d8720ff6500590182.png"><br><p><br>  It is clearly visible to the naked eye that these slender 16-byte entries really end exactly after the sect2_qty pieces and then something completely different begins.  What do we see here?  These are clearly not long 4-byte numbers, just about all non-zero.  Some obviously periodic structure is also not visible, at least at first glance.  Abundance 0xaa.  Many 0x28, alternating through time.  We look at the end of the file, trying to find some more sections - it seems, no, at the end there is approximately the same texture: </p><br><img src="https://habrastorage.org/files/583/ca2/684/583ca26845494e30965e91d0efcb1cbc.png"><br><p><br>  That is, this is the third and last section of the file, nothing else will be in it.  And what we have not seen?  Text and lines.  Apparently, this is what they are, but obviously somehow encoded.  Compressed?  No, it doesn't.  There would be no such number of repeating 0x28 and 0xaa.  Yes, and repeating 0x28 in everyones there <code>28 08 28 1b 28 0e 28 6c 26 6f 28 07 3a 14 28 6b</code> look terribly suspicious.  For comparison, let us recall what the average Japanese text looks like in ShiftJIS: <code>82 a0 82 e8 82 aa 82 c6 82 a4 82 b2 82 b4 82 a2</code> .  Immediately, the hypothesis suggests itself that this is the simplest substitution cipher, where each byte is always converted to the same other byte.  What can it be, how to get from 0x82 =&gt; 0x28?  Humanity has not really come up with so many options: </p><br><ul><li>  addition / subtraction - add (or subtract the same) to each byte the same number, overflow simply does not take into account </li><li>  rol / ror - cyclic shift for some number of bits, in the most stupid variant, shift by 4 bits to the right or left changes 2 hexadecimal digits </li><li>  exclusive "or" (xor) - with each byte, perform the operation xor with some other fixed byte;  one of the most stupid, banal, somehow acting and therefore popular ways </li></ul><br><p>  In general, there is even "heavy" artillery in the form of programs like <a href="https://blog.didierstevens.com/programs/xorsearch/">XORSearch</a> , which try to guess such transformations by brute force, but here it is still more banal and I manage to guess the second time.  The abundance of 0xaa suggests that there are a lot of zeros, which are XORs with 0xaa, which gives 0xaa.  And suddenly 0x82 ^ 0xaa is just equal to 0x28.  0xaa is generally one of the most banal assumptions that should be checked for good in the first place, because  0xaa = 0b10101010, i.e.  xor with him stupidly turns every second bit. </p><br><p>  Fortunately, Kaitai Struct has built-in support for such transformations, activated through <code>process:</code>  Enough to write like this: </p><br><pre> <code class="hljs vhdl"> - id: sect3 size-eos: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">process</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>xaa)</code> </pre> <br><p>  after which we will finally be able to observe the rich inner world of the string constants of our client scripts: </p><br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">000000</span></span>: <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> c8 <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">47</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">62</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">61</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>.....GlobalFla <span class="hljs-number"><span class="hljs-number">000010</span></span>: <span class="hljs-number"><span class="hljs-number">67</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">3d</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ff ff <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">3d</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>b <span class="hljs-number"><span class="hljs-number">00</span></span> | g.=.........=.{. <span class="hljs-number"><span class="hljs-number">000020</span></span>: <span class="hljs-number"><span class="hljs-number">0d</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">57</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">77</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>e <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">6d</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> | ....WindowNameSe <span class="hljs-number"><span class="hljs-number">000030</span></span>: <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">97</span></span> f6 <span class="hljs-number"><span class="hljs-number">82</span></span> b7 <span class="hljs-number"><span class="hljs-number">82</span></span> e9 <span class="hljs-number"><span class="hljs-number">8</span></span>e <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">96</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">82</span></span> cc <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>a | t........o.....Z <span class="hljs-number"><span class="hljs-number">000040</span></span>: <span class="hljs-number"><span class="hljs-number">8f</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">62</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">4f</span></span> <span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">81</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>c | .dt(.fobO).| <span class="hljs-number"><span class="hljs-number">000050</span></span>: <span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">68</span></span> <span class="hljs-number"><span class="hljs-number">5f</span></span> <span class="hljs-number"><span class="hljs-number">6d</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> | File : trialh_ma <span class="hljs-number"><span class="hljs-number">000060</span></span>: <span class="hljs-number"><span class="hljs-number">79</span></span> <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>e <span class="hljs-number"><span class="hljs-number">79</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>b <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">7d</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> | yu.yks.}.....Dra <span class="hljs-number"><span class="hljs-number">000070</span></span>: <span class="hljs-number"><span class="hljs-number">77</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">70</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">47</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">70</span></span> <span class="hljs-number"><span class="hljs-number">68</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> | wStop.GraphicHid <span class="hljs-number"><span class="hljs-number">000080</span></span>: <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">54</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e | e.....Transition <span class="hljs-number"><span class="hljs-number">000090</span></span>: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>b <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> | .....d.......... <span class="hljs-number"><span class="hljs-number">0000</span></span>a0: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">47</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">70</span></span> <span class="hljs-number"><span class="hljs-number">68</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>c <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> | .GraphicLoad....</code> </pre> <br><p>  Fortunately, there among other things there is a cloud of ASCII lines, which greatly simplifies life.  At first glance, it seems that these are just C-style lines terminated by zeros, but upon closer examination it turns out that this is not quite the case.  There are lines and any incomprehensible inclusions of constants, for example: <code>ff ff 00 00 01 00 00 00</code> , or <code>02 00 00 00 64 00 00 00 0a 00 00 00 0b 00 00 00</code> , which, despite the presence of one printed ASCII character in the center ( <code>d</code> = 0x64) most likely the lines are not.  In addition, the most valuable - here they are - these are the lines in Japanese in ShiftJIS from <code>82</code> . </p><br><p>  Let's summarize what we got: </p><br><ol><li>  sect1, consisting of 4-byte integers (presumably this is bytecode), partially referring to 16-byte entries in sect2 by these numbers </li><li>  sect2, consisting of 16-byte entries with increasing numbers inside (presumably, some offsets) </li><li>  sect3, consisting mainly of null-terminated lines in ShiftJIS, but not quite (presumably - string resources and all other constants referenced by bytecode) </li></ol><br><p>  On this small victory, I think we will complete our today's research, since the article once again turns out indecently large.  To some extent - if, for example, the task is to translate a visual novel - what has been achieved today is enough to tear out the texts and give them to the translators.  Take sect3, find in it everything that looks like SJIS, carefully throw away everything else - voila: </p><br><pre> <code class="hljs css">ÊÅã„Åô„ÇãÂßâÂ¶π„ÅÆÂÖ≠ÈáçÂ•è(„Éá„Éê„ÉÉ„Ç∞)Ôºç<span class="hljs-selector-tag"><span class="hljs-selector-tag">File</span></span> : <span class="hljs-selector-tag"><span class="hljs-selector-tag">trialh_mayu</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yks</span></span>„Åæ„ÇÜ„Äå„Åç„ÇÉ„Å£‚Ä¶‚Ä¶ÔºÅÔºÅ„ÄçÊïôËÇ≤ÁöÑÊåáÂ∞é„ÇíÂÖº„Å≠„Å¶„ÄÅ„ÅäÊúõ„ÅøÈÄö„Çä„É°„ÉÅ„É£„ÇØ„ÉÅ„É£„Å´„Åó„Å¶„ÇÑ„Çç„ÅÜ„Åò„ÇÉ„Å™„ÅÑ„ÅãÔºÅÔºÅ „Äå„ÅÇ„Å£‚Ä¶‚Ä¶„Åä„ÄÅ„Åä„Å´„ÅÉ„Å£‚Ä¶‚Ä¶„ÄçËá™ÂàÜ„Åã„ÇâË™ò„Å£„Å¶„Åä„Åç„Å™„Åå„Çâ„ÄÅ‰∏çÂÆâ„Åù„ÅÜ„Å™Ë°®ÊÉÖ„ÇíÊµÆ„Åã„Åπ„Çã„Åæ„ÇÜ„ÄÇ„Åù„Çì„Å™„Åæ„ÇÜ„Çí„ÄÅ„ÇΩ„Éï„Ç°„Éº„Å´Êäº„Åó„Å§„Åë„Å¶‚Ä¶‚Ä¶ËÉ∏„ÇíÈú≤Âá∫„Åï„Åõ„ÄÅËÇ°Èñì„Åå‰∏∏Ë¶ã„Åà„Å´„Å™„Çã‰ΩìÂã¢„ÇíÂº∑„ÅÑ„Çã„ÄÇ „Äå„Çì„ÅÅ„Å£‚Ä¶‚Ä¶„Äç</code> </pre> <br><p>  Thanks to everyone who read to this place.  Next time we get to the bytecode itself and try to understand how sect1 and sect2 work.  See you! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/309414/">https://habr.com/ru/post/309414/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309404/index.html">Why the 35-year-old SoftBank company again spoils its reputation because of the ‚Äúcrazy‚Äù deal with ARM Holdings</a></li>
<li><a href="../309406/index.html">Anniversary Edition Intercepter-NG 1.0</a></li>
<li><a href="../309408/index.html">Manual Start Timer</a></li>
<li><a href="../309410/index.html">GrabDuck: How we make bookmarked articles</a></li>
<li><a href="../309412/index.html">GoTech.vc: Last week</a></li>
<li><a href="../309416/index.html">New security features Android 7</a></li>
<li><a href="../309420/index.html">Gentleman's set of R packages for automating business tasks</a></li>
<li><a href="../309422/index.html">React patterns</a></li>
<li><a href="../309424/index.html">Dear startups, stop math tasks to understand if I can program</a></li>
<li><a href="../309426/index.html">The role of content in website promotion and customer acquisition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>