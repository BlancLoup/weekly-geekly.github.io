<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Overview of the system architecture of the social network Campus.ru</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I present to your attention a review of the high-level system architecture of the social network www.campus.ru , developed by Creative Media LLC. In m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Overview of the system architecture of the social network Campus.ru</h1><div class="post__text post__text-html js-mediator-article"> I present to your attention a review of the high-level system architecture of the social network <a href="http://www.campus.ru/">www.campus.ru</a> , developed by Creative Media LLC.  In my opinion, this material is interesting because it allows to evaluate the applicability of the considered approaches and technologies in the development of Internet resources.  At least, when our company started the Campus project, I really lacked such information. <br><a name="habracut"></a><br>  The social network Campus.ru helps schoolchildren and students to build their future careers by holding special contests from large companies-employers, organizing work experience training and educational seminars, as well as through the necessary functionality for communication, information sharing and other educational needs - for example, drawing up a training schedule.  The functionality of Campus.ru mostly overlaps with the functionality of social networks we are used to: registered users can communicate, form communities, write blogs, post photos, etc.  However, since this social network was initially focused on schoolchildren and students, some things were implemented specifically to meet the needs of students, for example, ‚ÄúTraining Portfolio‚Äù - a folder for storing materials, or ‚ÄúPlanner‚Äù - a service for drawing up an educational timetable. <br><br>  An overview of the system architecture will begin with the information that Campus.ru is implemented on the Java platform.  Judging by general statistics, choosing a Java platform as a tool for implementing a media Web resource is a rather non-standard solution, but I chose this platform based on the following considerations: <br><br>  ‚Ä¢ My previous experience in developing high-load, fault-tolerant, horizontally scalable Java applications was successful. <br>  ‚Ä¢ The Java community has accumulated a huge code base of high-quality open source libraries and frameworks for almost all occasions. <br>  ‚Ä¢ When building a project team from scratch, finding in the labor market several suitable Java developers with the necessary qualifications, teamwork experience and knowledge in understanding software architecture (Design Patterns) is easier than, for example, to work with Ruby (because this language, according to the experience of colleagues, is not yet widely spread), or with PHP (from my own experience, there are too many low-skilled staff, who take up the exodus without months). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Assuming caustic comments regarding the performance of Java applications, I note that when making a decision in favor of Java, I clearly realized that the JVM is not the fastest and most economical interpreter.  However, firstly, JVM 6.0 is really sufficiently productive for the needs of a Web application, and secondly, the work of programmers is now more expensive than the cost of iron, so for a long time to invent expensive "bicycles" that allow you to win 5% -10% of performance, for a startup would be unreasonable.  I adhere to the principle ‚Äúit is better to work quickly with a minimum of code and beautiful architecture than to save 10% of hardware and get bogged down in debugging‚Äù. <br><br>  The main framework of the project was <a href="http://tapestry.apache.org/tapestry5/">Tapestry 5</a> .  The choice in favor of Tapestry 5 was made for a number of reasons, the main of which are: <br>  ‚Ä¢ Tapestry allows you to completely separate the layout and presentation logic.  There is no need to add special tags to HTML that are not interpreted by the browser, as in JSP.  This is especially important because  A web project in most cases involves a complex layout, which is usually performed and supported by an individual specialist.  By the way, in terms of layout optimization, we tried to follow <a href="http://developer.yahoo.com/performance/rules.html">best practice</a> . <br>  ‚Ä¢ Contains a number of architectural solutions aimed at high-performance work, such as, for example, the Page Pool. <br>  ‚Ä¢ Adequate and coherent framework architecture that allows you to focus on the business logic of the application, rather than on its configuration and integration of components with each other, thanks to the extensive use of annotations and naming conventions, as well as embedded IoC. <br>  Since none of us had any previous experience with Tapestry 5, the test prototype of the application was written first of all and its load testing was performed by the <a href="http://jakarta.apache.org/jmeter/">JMeter</a> utility.  Testing showed a fast response time, stable utilization of the hardware platform and the absence of locks, after which the decision to use Tapestry 5 was finally approved. <br><br>  Based on the above, the internal architecture of the Web application Campus.ru is dictated by the rules for developing applications for the Tapestry 5 framework. <br>  In addition to Tapestry, our web application uses the following libraries: <br>  ‚Ä¢ <a href="http://www.dojotoolkit.org/">DOJO 1.0</a> - JavaScript framework with AJAX <br>  The choice of DOJO as the main JavaScript framework was dictated by the presence of a large number of ready-made controls, including widgets, as well as the fact that DOJO allows you to perform all the stylistic transformation of components on the client side.  At the same time, when a resource is first accessed, all necessary CSS and Java scripts are loaded and cached in the browser, and then only HTML pages with minimal markup are loaded from the server.  This significantly reduces traffic and server load. <br>  In addition, and not least, the team already had experience with DOJO Of the difficulties - the integration part of the DOJO-Tapestry had to be invented independently;  in the future, we plan to issue it in the form of an open source project and put it in open access. <br>  ‚Ä¢ <a href="http://swfupload.org/">SwfUpload 2</a> - JavaScript component for uploading files to the server. <br>  ‚Ä¢ <a href="http://www.hibernate.org/">Hibernate 3</a> - ORM Framework.  Tapestry 5 seamlessly integrates with Hibernate.  For entity mapping use annotations. <br>  ‚Ä¢ <a href="http://www.hibernate.org/410.html">Hibernate Search 3</a> - Lucene-based full-text search engine.  Allows indexing the contents of Hibernate entities, conveniently configured by annotations in entities.  Can work in a cluster. <br>  ‚Ä¢ <a href="http://static.springsource.org/spring-security/site/">Spring Security 2.0</a> is an authentication and authorization system that integrates seamlessly with Tapestry 5 and is configured with annotations.  It has ample opportunities, but there was no suitable ACL mechanism for imposing personal user access rights to domain objects, we had to invent our own.  We plan in the future to lay out in the form of an open source project. <br>  ‚Ä¢ <a href="http://www.opensymphony.com/quartz/">Quartz 1.6</a> - Scheduler for performing background and asynchronous operations.  Long operations, such as sending mail, processing a file on the server, etc., we try to implement as asynchronously executed actions in order not to block the user interface for a long time. <br>  With good luck, the number of users (i.e. the number of requests) of the social network and the volume of user-related data grows like an avalanche.  In this regard, it was very important to ensure horizontal scaling of the system, as well as a sufficient level of its fault tolerance.  These goals were achieved both due to the presence of redundant hardware servers for critical system nodes, and through the use of special software at the OS level: haproxy, hartbeat, etc. So we are almost not afraid of accidents and growth illnesses <br><br>  Speaking of software.  In its infrastructure, Campus uses: <br>  ‚Ä¢ <a href="http://sysoev.ru/nginx/">Nginx 0.6</a> - load balancer (HTTP requests) and HTTP server for uploading static content (JavaScript, CSS, icons, etc.).  The balancing of HTTP requests to the Tomcat application servers is configured so that within one session all requests from one user fall on one instance of the Tomcat server.  This load balancing setting is called a sticky session.  This is done in order not to replicate user sessions between Tomcat servers.  Plus - saving resources and linear horizontal scaling.  Minus - in case of server failure, the user will have to re-login on the resource. <br>  ‚Ä¢ <a href="http://java.sun.com/javase/">JDK 6</a> is a set of development tools and a virtual java-machine (JVM) on which the J2EE application server runs. <br>  ‚Ä¢ <a href="http://tomcat.apache.org/">Tomcat 6</a> - J2EE application server (J2EE container for web applications).  Under his administration, the Campus.ru application works.  We did not combine the Tomcat server into a cluster for reasons of preserving linear horizontal scaling capabilities at this level. <br>  ‚Ä¢ <a href="http://www.postgresql.org/">PostgreSQL 8.3</a> - versioned DBMS.  Chose between MySQL and PostgreSQL.  We stopped at Postgres, analyzing various reviews, expert blogs and the availability of tools for clustering databases. <br>  ‚Ä¢ <a href="http://pgpool.projects.postgresql.org/">PgPool-II 3.4</a> , a load balancer and data replicator, is used to cluster two PostgreSQL servers into a cluster.  Requests to change data are simultaneously sent to both database servers, and read requests to one of the servers in turn.  Thus, the load is distributed between the two machines. <br>  ‚Ä¢ <a href="https://developer.skype.com/SkypeGarage/DbProjects/PgBouncer">PgBouncer 1.3</a> is a lightweight connection pool management system for PostgreSQL.  Simultaneous processing of user requests by a large number of application servers requires the support of a large number of database connections.  PgBouncer spends about 2 KB of memory on maintaining each connection, and significantly relieves the load from the PostgreSQL DBMS.  Thus, JDBC pools on Tomcat servers are configured to connect to PgBouncer, not to PgPool.  An additional advantage is that in case of a short-term inaccessibility of the database (for example, during a quick restart), the PgBouncer will continue to attempt to connect to the database, and if this happens before the set timeout, the application server will not even know that the database was temporarily unavailable. <br>  ‚Ä¢ <a href="http://activemq.apache.org/">ActiveMQ 5.2</a> - JMS-server.  Used for asynchronous JMS messaging in the Hibernate Search full-text search system configured in the JMS Master / Slave configuration mode ( <a href="http://www.hibernate.org/hib_docs/search/reference/en/html/search-configuration.html">details here</a> ).  It is also used to exchange information with the asynchronous task execution subsystem based on the Quartz framework. <br>  ‚Ä¢ Sendmail is a well-known mail server.  Use for mailings. <br>  ‚Ä¢ <a href="http://www.zabbix.com/">Zabbix 1.6</a> - system infrastructure monitoring system.  It monitors the status of the JVM, Tomcat via the JMX protocol through the MBeans interfaces.  Monitors up to 30 hosts for free. <br>  ‚Ä¢ <a href="http://www.freebsdsoftware.org/misc/smssend.html">Smssend</a> - a package for FreeBSD that allows you to send SMS.  We use to send SMS messages to the system administrator about problems on the resource. <br>  ‚Ä¢ <a href="http://chandlerproject.org/Developers/DownloadChandlerServer">Chandler Server</a> - Open source Web-application, which is a calendar server that communicates with the outside world using the open protocol CalDav.  In order not to reinvent the wheel, we use this server in our Planer service to store schedules of events for users and communities. <br>  ‚Ä¢ <a href="http://aws.amazon.com/s3/">Amazone S3</a> - used to securely store user files.  In addition, the use of this service helps to remove the load from the application servers, since  Files are downloaded by users directly from Amazon servers.  The file metadata is stored in the Campus database. <br>  To work with Amazon there is a <a href="http://docs.amazonwebservices.com/AmazonS3/2006-03-01/gsg/">client-side Java API</a> .  The service is paid, but not expensive for organization.  If you decide to organize something like this on your own, I recommend <a href="http://www.danga.com/mogilefs/">MogileFS</a> , there is also a Java API for it. <br>  ‚Ä¢ Fotki.com - photo hosting of our partners, providing storage and conversion of photos uploaded by users to photo albums.  Photo uploading to the browser again takes place directly from the photo hosting servers, which offloads the application servers of Campus.ru.  If I had to convert the photo myself, I would probably look in the direction of <a href="http://www.imagemagick.org/">ImageMagick</a> , the <a href="http://www.jmagick.org/">Java API is</a> also attached. <br><br>  All together it works like this: <br>  1) The user's request goes to the load balancer server.  Nginx checks if the request contains a header containing information about the user's binding to one of the Tomcat servers.  If not, such a header is added, and the request is redirected to the appropriate Tomcat server.  Initially, the server is selected on the principle of round-robin.  This mechanism provides a sticky session. <br>  2) On the Tomcat server, dynamic content is generated for the HTML page, in fact, only data, with minimal style markup.  If to generate a page, data from the database is required, the Campus.ru application takes a connection from the JDBC pool of this server.  Connections in the JDBC pool are made with PgBouncer, which in turn establishes a connection with PgPool, and PgPool with PostgreSQL.  Since the process of establishing connections in the JDBC pool occurs immediately when the Tomcat server starts, then while the application is running, the connection from the pool is very fast. <br>  3) If the user's request changes the information involved in full-text search, the application sends a JMS message to the Master Node search server, which is responsible for synchronizing full-text indexes on each of the cluster nodes. <br>  4) The content of the HTML page is returned to the user's browser.  After that, the user's browser starts downloading static content (JavaScript, CSS, images) from the Nginx server, if this content has not yet been cached by the browser, as well as photos and avatars from external photo hosting servers. <br>  5) The user's browser applies CSS and JavaScript transforms to the loaded DOM tree and eventually renders the page to the user. <br><br>  This scheme allows, firstly, to reduce the load on the application server and minimize traffic, and, secondly, to speed up the overall page load by overcoming the browser restriction, which allows downloading data from only four threads simultaneously from one resource.  The downside of the medal is a side effect observed on old browsers like IE 6, which do not have time to apply all dynamic style conversions to the page before its display, because of which the user can observe how the curved page turns into a beautiful page before his eyes.  In addition, the initial download of all CSS and Java scripts on slow channels may take some time. <br>  By the way, here I remembered the problem with updating cached static content (CSS, JS) in the user's browser.  To solve it, we add its version number to the URL of a static resource.  If changes are made to scripts, their version number in the URL changes, and the browser downloads updated files from the server. <br><br>  In order to make the above easier to keep within your head, the figure shows a high-level diagram of the deployment of the Web application Campus.ru.  In order not to complicate the diagram, some of the connections between the components are not shown. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b12/5bb/b84/b125bbb846b84ef7db076fb5b9508ed8.jpg" alt="Deployment Chart Campus.ru"><br>  Figure 1. Campus.ru Deployment Chart <br><br>  Experience shows that the JVM works efficiently with memory sizes up to 2 GB, taking into account the recommendation saying that each instance of JVM on the server should have at least two processor cores.  For these reasons, 4 instances of Tomcat application servers were deployed on each hardware server.  Campus and Chandler web applications were deployed in each Tomcat container.  In-situ testing showed that with the GC settings made, this configuration makes it possible to utilize the hardware resources almost linearly with increasing load and produce an acceptable result in response time. <br><br>  On all hardware servers, applications run under FreeBSD 7.1.  The choice in favor of FreeBSD, and not Linux, was made because, all other things being equal, all Linux systems have their own characteristics, and it would be more difficult for system administrators to transfer knowledge to each other.  In our company, all projects are still working on FreeBSD, so it has become something like a corporate standard.  Of the minuses of FreeBSD in a Java project, Sun does not release the JDK for FreeBSD, and the ports under FreeBSD lag behind the updates to Sun.  Also in the JDK ports there are not all debug utilities. <br><br>  Fault tolerance on load balancer servers is implemented through the <a href="http://www.freebsdsoftware.org/net/haproxy.html">HAProxy</a> utility. <br><br>  Campus hardware servers have the following configuration: <br>  1) Servers for load balancing and returning static content: <br>  CPU Intel Xeon Dual Core 2.67GHz \ RAM DDR 2 8Gb \ HDD 4xSAS 73gb 15000 rpm <br>  2) Servers for web application deployment: <br>  CPU 2xIntel Xeon Quad Core 2.66GHz \ RAM DDR 2 16Gb \ HDD 4xSATA 300gb 15000 rpm <br>  The main principle when choosing a server for a Web application - the more cores / processors and RAM - the better. <br>  3) Servers for DB: <br>  CPU 2xIntel Xeon Quad Core 2.66 GHz \ RAM DDR 2 16Gb \ HDD 8xSAS 147gb 15000 rpm <br>  The main principle when choosing a server for the database with the expectation of working with large amounts of data - the more disks and the faster they are, the better.  Be sure to have hardware RAID.  Then the priorities are the RAM, followed by the processors. <br><br>  Servers are hosted in the data center of a large Moscow Internet provider for a hardware firewall from Cisco. <br><br>  In conclusion, I would like to say that, despite the large volumes of work done, we still have something to improve.  For example, in connection with the release of IE 8, we outlined a painful transition to DOJO 1.3.  We also plan to make the layout of the site easier (removing shadows, translucency and unnecessary roundness) due to the fact that students in the regions actually have a channel at 128Kbit / s and IE 6 in schools / universities. In the very near future plans to implement data caching on <a href="http://www.danga.com/memcached/">Memcached</a> distributed database cache.  We also have not solved the problem of data sharding, if suddenly the volume of data starts to grow threateningly.  Therefore, in the future we intend to explore Hibernate Shards, PL \ Proxy and other means.  If someone has practical experience and a desire to share it, I will be very happy. <br><br>  In the next article, if you support me, I plan to talk about the management of the Campus project and our team. <br><br>  Thanks for attention! <br>  Technical Director, Creative Media LLC <br>  Sergey Sedov <br>  Published with the permission of Ivan Sokolov, Director General of Creative Media LLC </div><p>Source: <a href="https://habr.com/ru/post/57162/">https://habr.com/ru/post/57162/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../57153/index.html">Full Circle Magazine # 23 (RUS)</a></li>
<li><a href="../57154/index.html">Apple is developing a portable device that will occupy a niche between the iPhone / iPod touch and the MacBook!</a></li>
<li><a href="../57158/index.html">"The right driver." Project Diary. Initial promotion</a></li>
<li><a href="../57159/index.html">Twinbots: first experience</a></li>
<li><a href="../57161/index.html">How to quickly spend 1 GB of traffic</a></li>
<li><a href="../57165/index.html">How to transfer ESXi server to another server</a></li>
<li><a href="../57166/index.html">Do you buy printed editions of books on IT topics?</a></li>
<li><a href="../57167/index.html">Askin. Wallpaper</a></li>
<li><a href="../57168/index.html">Attempting to explain ‚Äúwhat is OpenID, how to use it‚Äù</a></li>
<li><a href="../57170/index.html">World Digital Library</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>