<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make friends with Realm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we would like to share the experience of using the increasingly popular library for data storage - Realm. Before any project at the b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make friends with Realm</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article, we would like to share the experience of using the increasingly popular library for data storage - Realm.  Before any project at the beginning of development there is a question <em>what to use for data storage</em> - something checked or to try tools from the category <em>for hipsters</em> . </p><br><p><img src="https://habrastorage.org/files/e0e/db1/773/e0edb17732ca4b3ca7b4f855f948294f.jpg" alt="image"></p><br><p>  <a href="http://www.fairbear.com/">We are a small startup</a> developing a kids launcher.  Although we are a startup and we have a small team, but we pay great attention to the quality of the code.  In two years of development, the requirements, functionality, and technologies chosen by us have changed quite a bit.  Up to the point that we switched from a fully native application to a hybrid one, based on Cordova.  Also, one of these changes was the transition from BaaS from Facebook Parse to Realm.  In this article we want to talk about the problems that we encountered when switching to Realm and whether it is worth trying new libraries if we‚Äôve already made friends with the old ones. <a name="habracut"></a></p><br><p>  <a href="https://realm.io/">Realm</a> is a library designed to facilitate data storage on a device, an analogue of ORM, with its own core and specificity.  Currently, its developers have given a solution for cloud storage of the same objects.  Everything is built on the ideology of "living objects", in this system you do not need to think about synchronization between threads, devices, users, everything is done for you - any change is automatically applied to all clients of this object.  In addition, the developers of this database promise a high sampling rate, thus sampling from the database can be done almost on the UI stream. </p><br><h3 id="chto-bylo-do-realm">  What was before Realm </h3><br><p>  Before that, we used <a href="http://parseplatform.org/">Parse</a> .  In it, objects were represented as dictionaries that were serialized as json's and either sent to the cloud or stored on the device.  Synchronization rested entirely on the shoulders of the application developer, but the SDK provided quite a few possibilities, besides, it was open-source, which we used sometimes and tried to facilitate the interaction between the server and the device by forking the SDK. </p><br><p>  <strong>Of the problems</strong> we encountered when using Parse, we can note: </p><br><p>  1) The difficulty of debugging - anonymous classes from <a href="https://github.com/BoltsFramework/Bolts-Android">Bolts are</a> very difficult to test and profile, it is impossible to understand what is coming from.  In addition, it was these classes that we spent in narrow places up to 40% of the execution time. <br>  2) Quite often, with a large amount of data, the processing speed left much to be desired. <br>  3) A lot of your code for synchronization between repositories. </p><br><p>  <strong>Tip: <em>initially think about synchronizing your repositories and databases, otherwise the incredible will happen later.</em></strong> </p><br><p>  We wanted to make the application as responsive as possible so that the user waited for the minimum time when receiving or changing data.  Architecturally it looked like this: </p><br><div class="spoiler">  <b class="spoiler_title">Some code</b> <div class="spoiler_text"><p>  We have two implementations of the interface for storing data: </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Storage</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelType</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueryType</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Transaction</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transact</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception</span></span>; } <span class="hljs-function"><span class="hljs-function">QueryType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QueryType query)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelType object, @Nullable SaveCallback callback)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveAllInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;? extends ModelType&gt; objects, @Nullable SaveCallback callback)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelType object)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> StorageException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;? extends ModelType&gt; objects)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> StorageException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelType object, @Nullable DeleteCallback callback)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteAllInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;? extends ModelType&gt; object, @Nullable DeleteCallback callback)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;? extends ModelType&gt; object)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> StorageException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelType object)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> StorageException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">discard</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> StorageException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">discardInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable DeleteCallback cb)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isDiscarded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><pre> <code class="java hljs">LocalStorage implements Storage&lt;...&gt; CloudStorage implements Storage&lt;...&gt;</code> </pre> </div></div><br><p>  <strong>Tip: <em>always hide your storage for the interface, even if you do not see the point.</em></strong>  <strong><em>Do not disassemble the Cursor in Fragment'e or View.</em></strong> </p><br><p>  The user interacts only with the local repository.  All interaction with the server takes place in the background thread and the user does not see any progress bars or other that block progress. </p><br><p>  A year ago, Parse <a href="http://blog.parse.com/announcements/moving-on/">announced the</a> closure of its service and we, without hesitation, decided to switch to Realm.  We represented the entire transition as " <em>rewrite LocalStorage for the specifics and interface of the Realm SDK</em> ".  But everything, as usual, turned out to be a little more difficult ... </p><br><h3 id="nemnogo-ob-ustroystve-realm">  Something about the device Realm </h3><br><p>  The transition itself took quite a bit of time - Realm API is very convenient and requires minimal gestures from the developer.  We immediately abandoned the asynchronous methods in our repository, deciding that everything will happen on the calling thread. </p><br><p>  Realm and the logic of obtaining objects from it works as follows: </p><br><p>  There is a Realm object - this is the entry point into the database, through which both the retrieval of objects and their preservation go.  All objects are bound to a Realm instance.  Moreover, each Realm is tied to the thread on which you received it.  Due to this, synchronization of all database objects is achieved.  Everything, once received objects on a specific Realm, is cached in memory and their next receipt is much faster.  Inside the Realm objects are synchronized between each other.  As the developers of Realm say, these synchronizations are almost instantaneous, but in our opinion, they sometimes occurred with delays. </p><br><p>  You can also set different configurations for these instances.  Realm developers advise you to use configuration sharing as much as possible.  Configuration is an analogue of the database.  For example, to store different types of objects in different configurations, or to separate the states of objects and, depending on the state, to move between them.  Thus, working with one database will not work with unnecessary objects.  In practice, the only thing we could divide into configurations is Realm for logging and for everything else. </p><br><p>  Objects Realm'a come in two types.  The one that you described in the code and that was generated when building the project.  At runtime, they differ in that your object does not look anywhere and it is a simple POJO object, an object of the type of the generated class is a proxy object, the so-called mediator, whose set and get methods look into the database.  That is, any change to an object instantly leads to a change in the database. </p><br><p>  The specific synchronization at this moment imposes a rather strong limitation - we can only change proxy objects from the stream on which we received them, but more on that below. </p><br><p>  In addition, to reset the in-memory cache, you need to call the close method on the Realm object with which you interacted.  Moreover, when the instance is received, the object counter on each thread is triggered.  That is, the close method works only when we called it as many times as many times called Realm.getInstance () on the same thread. </p><br><p>  This logic imposes enormous restrictions on the architecture of the application, which hides the database behind the interface.  The documentation also <a href="https://realm.io/docs/java/0.75.0/">shows a</a> very simple example of using this method. </p><br><p>  We nullified their logic with counting out objects by caching out issued instances in the ThreadLocal list.  For each stream we issue and hold exactly one realm instance.  When you close it, we delete it. </p><br><div class="spoiler">  <b class="spoiler_title">Some code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Context mContext; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;Realm&gt; mRealm = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadLocal&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RealmObject object)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> StorageException </span></span>{ Realm realm = getRealm(); realm.beginTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { realm.copyToRealmOrUpdate(object); realm.commitTransaction(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { realm.cancelTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageException(e); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Realm </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRealm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ initIfNeeded(mContext); Realm realm = mRealm.get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (realm == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Log.d(Tags.STORAGE(), <span class="hljs-string"><span class="hljs-string">"Init Realm on the thread: "</span></span> + Thread.currentThread().getName()); realm = Realm.getDefaultInstance(); mRealm.set(realm); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> realm; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">closeConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Realm realm = mRealm.get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (realm != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Log.d(Tags.STORAGE(), <span class="hljs-string"><span class="hljs-string">"Clos on finished thread: "</span></span> + Thread.currentThread().getName()); realm.close(); mRealm.remove(); } }</code> </pre> </div></div><br><p>  It remains to learn how to close it in time ... </p><br><p>  <strong>Tip: <em>monitor each thread that runs in the application ‚Äî group them into thread pools.</em></strong>  <strong><em>Never do it in the forehead.</em></strong> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() {...}).start()</code> </pre> <br><p>  It helped us a lot.  All running operations in other threads, we controlled through thread pools.  Thus, we can, without changing the business logic, clean Realm-objects after executing the thread in the pool. </p><br><p>  It looks like this: </p><br><div class="spoiler">  <b class="spoiler_title">Some code</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RealmCleanerThreadExecutor</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">val mStorageManager: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">StorageManager</span></span></span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">TAGS</span></span> = <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-string"><span class="hljs-string">"RealmCleanerThreadExecutor"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mCount: <span class="hljs-type"><span class="hljs-type">AtomicInteger</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AtomicInteger</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">CPU_COUNT</span></span> = <span class="hljs-type"><span class="hljs-type">Runtime</span></span>.getRuntime.availableProcessors <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">CORE_POOL_SIZE</span></span> = <span class="hljs-type"><span class="hljs-type">CPU_COUNT</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> threadFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">ThreadFactory</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mCount: <span class="hljs-type"><span class="hljs-type">AtomicInteger</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AtomicInteger</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newThread</span></span></span></span>(r: <span class="hljs-type"><span class="hljs-type">Runnable</span></span>): <span class="hljs-type"><span class="hljs-type">Thread</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Thread</span></span>(() =&gt; { r.run() mStorageManager.getRealm.closeConnection() }, <span class="hljs-string"><span class="hljs-string">"RealmCleanerThreadExecutor_N"</span></span> + mCount.incrementAndGet()) } } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> executor: <span class="hljs-type"><span class="hljs-type">ExecutorService</span></span> = <span class="hljs-type"><span class="hljs-type">Executors</span></span>.newFixedThreadPool(<span class="hljs-type"><span class="hljs-type">CORE_POOL_SIZE</span></span>, threadFactory) }</code> </pre> <br><p>  <em>Yes, we also have scala.</em> </p></div></div><br><p>  For those using <a href="https://cordova.apache.org/">Cordova</a> : </p><br><p>  In the heir of CordovaActivity, you need to override the method that creates the CordovaInterfaceImpl, you can pass the Executor we need into the input. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> CordovaInterfaceImpl </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeCordovaInterface</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CordovaInterfaceImpl(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, mRealmCleanThreadExecutor.executor()) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id, Object data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MainCordovaActivity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onMessage(id, data); } }; }</code> </pre> <br><p>  For those who use <a href="https://github.com/path/android-priority-jobqueue">JobManager</a> : </p><br><pre> <code class="java hljs">Context appContext = context.getApplicationContext(); Configuration.Builder builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration.Builder(appContext) .threadFactory(realmCleanerThreadExecutor.threadFactory()); mJobManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobManager(builder.build());</code> </pre> <br><p>  We don‚Äôt close the realm on the UI thread at all; due to this, we use the Realm instance heated up directly on the calling thread. </p><br><p>  Thus, we everywhere, after completion of work of a flow, we can reset the cache of Realm objects, without touching the client code. </p><br><p>  <strong>Tip: <em>transactions that are fairly frequent, but do not have a deadline, we spend on HandlerThread.</em></strong>  <strong><em>This reduces the number of threads created.</em></strong> </p><br><p>  As an example, we process push notifications on it and we do not clear the Realm attached to it either. </p><br><p>  One of the features of the SDK is filtering nested collections using this very SDK.  It looks like this </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> SessionState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSessionState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String groupUuid)</span></span></span><span class="hljs-function"> </span></span>{ RealmList&lt;SessionState&gt; sessionsState = getSessionsState(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionsState.where().contains(SessionState.GROUP_UUID,groupUuid).findFirst(); }</code> </pre> <br><p>  Reduces the amount of our code at times.  We immediately took advantage of this opportunity and forgot about looping through and filtering lists by hand.  And then we saw the following in their code: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RealmQuery&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">where</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (managedMode) { checkValidView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RealmQuery.createQueryFromList(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnsupportedOperationException(ONLY_IN_MANAGED_MODE_MESSAGE); } }</code> </pre> <br><p>  If we create the RealmList ourselves, then <em>managedMode = false</em> and any use of the specific methods of these lists leads to the exception <em>This method is only available in managed mode</em> .  As a result, we cannot fully use Realm objects in other threads and, also, we cannot, if it is detail from Realm.  In our opinion there are two strategies: </p><br><p>  1) Do not transfer objects between threads, work with proxy objects everywhere and be sure that you can use features from the SDK everywhere. </p><br><p>  2) Transfer <strong>detail</strong> objects between threads, but control the code, realizing that there can be both a ‚Äúreal-life object‚Äù and a regular java-object not tied to the database. </p><br><p>  We have not yet found the perfect solution.  Using the filtering capabilities of sdk breaks down the tests, as in the tests we have to completely get wet Realm.  You have to create wrappers so that in tests you can replace this behavior. </p><br><p>  At the same time, the transfer of detail objects complicates the understanding of the code. </p><br><p>  At the moment, we stopped at the option with the constant receipt of objects from Realm instances.  In the class field it stores its identifier, in functions we get it from the instance.  In this approach, the speed may fall, but you do not need to worry about synchronization. <br>  <em>We would love to listen to the experience of other projects in this place.</em> </p><br><p>  <strong>As for testing:</strong> JUnit and Robolectric are not friendly with Realm, it should be completely locked in the tests.  <a href="https://github.com/robolectric/robolectric/issues/1389">A ticket</a> for this is likely to be forever. </p><br><p>  <strong>Tip: <em>if you want to easily test and replace the behavior of objects, then ideally make all the creation of new objects in external dependencies.</em></strong>  <strong><em>In our example, we had to move methods that create sample objects for Realm objects into the factory.</em></strong> </p><br><p>  In fact, this library is noteworthy, it is actively developing, the bugs they learn about are closed in the next couple of days.  Yes, and in a large industrial project will not be the perfect technology. </p><br><p>  What else would I like to mention: </p><br><p>  <em>1) Generated Realm objects hit the DexCount quite painfully, to whom this is important.</em>  <em>Each object adds about 20 methods + method to each set \ get method of your source class.</em> <em><br></em>  <em>2) Problems with inheritance - multiple inheritance is not supported.</em> <em><br></em>  <em>3) Minor difficulties with storing primitives - you have to write wrapper classes (strangely, they have not done this yet).</em> <em><br></em>  <em>4) To change the list in a proxy object, it is necessary to open a transaction, that is, it must be placed on the shoulders of the repository and it is rather difficult to do this purely in the code of business logic.</em> <em><br></em>  <em>5) It is impossible to override the behavior of the set / get methods since they are generated.</em>  <em>We needed this in order to understand whether this object was different from the object on the server.</em>  <em>Although this is all solved.</em> </p><br><h3 id="v-zaklyuchenii">  In custody </h3><br><p>  Initially, this article was planned as a post that any technology can be entered into its architecture, but in the end we got a post with a small part of the problems that we encountered when switching to a completely different ORM in an already finished project.  As a result, we are almost satisfied with this transition.  The main inconvenience we have is the closing of the instances and working with objects in a multithreaded environment. </p><br><p>  Of the advantages compared with other solutions can be identified: </p><br><p>  <em>1) Convenience SDK - migration out of the box, synchronization, sampling, sorting, convenient architecture of connections between objects.</em> <em><br></em>  <em>2) Speed ‚Äã‚Äãof work.</em>  <em>We didn‚Äôt do exact calculations, but we do many operations on the UI stream, considering that there are a lot of animations in the application and other things, the user interface does not lose frames.</em> <em><br></em>  <em>3) Ability to subscribe to change objects, as defined, and any lists / selections.</em>  <em>Especially handy if you need to update the UI when changing the data set.</em> <em><br></em>  <em>4) Very fast help from Realm developers and high-quality documentation.</em> </p><br><p>  We very much hope for a lot of comments that we did everything wrong and could have been made easier. </p><br><p>  ‚Üí <a href="https://martinfowler.com/eaaCatalog/repository.html">You can read</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/326152/">https://habr.com/ru/post/326152/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326138/index.html">Pthreads: POSIX Threads</a></li>
<li><a href="../326142/index.html">JPoint 2017: remember everything</a></li>
<li><a href="../326146/index.html">How it works in the java world. Thread pool</a></li>
<li><a href="../326148/index.html">Advanced tunneling: attack the internal nodes of the corporate network</a></li>
<li><a href="../326150/index.html">We trace element resizing without setTimeout and frames</a></li>
<li><a href="../326154/index.html">Third Party Developer Projects</a></li>
<li><a href="../326156/index.html">IBM has created a cloud-based tool for centralized management of corporate employee devices.</a></li>
<li><a href="../326162/index.html">Introduction to React and Redux for Backend Developers</a></li>
<li><a href="../326164/index.html">Setting up remote access to Windows using noVNC</a></li>
<li><a href="../326166/index.html">Technical support for vulnerabilities: CMS. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>