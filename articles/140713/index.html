<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using ORM in the development of enterprise applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a lot of controversy about the pros and cons of ORM , let's try to focus on the pros when using it in ERP applications. 

 I have been develo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using ORM in the development of enterprise applications</h1><div class="post__text post__text-html js-mediator-article">  There is a lot of <a href="http://habrahabr.ru/post/123293/">controversy</a> about the pros and cons of <a href="http://ru.wikipedia.org/wiki/ORM">ORM</a> , let's try to focus on the pros when using it in ERP applications. <br><br>  I have been developing an ERP platform for 5 years, I have developed three versions of the platform.  It all started with EAV, after which there was a normal model, stored procedures, view-chi, and now evolved to use ORM.  Let me share the experience why ORM is good. <br><br>  To demonstrate the advantages of this approach, I developed a small application for a real estate agency (I drew inspiration from Cyan and a data model from it) and try to describe why, thanks to ORM, I did everything in 1 day. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/c64/8c2/2f4/c648c22f4aa4ec681c1150a88a69bc76.jpg" alt="image"><a name="habracut"></a><br>  I am a supporter of the CodeFirst approach, because  This is the only correct way to plan the structure of a business application. <br>  In our latest <a href="http://oreodor.com/">platform,</a> after a long selection, we decided to use ORM <a href="http://dataobjects.net/">DataObjects.Net</a> , but the essence of the article will be clear to any ORM supporter, be it NHibernate, the Entity Framework, etc. <br><br>  So, we plan a simple application for a real estate agency: <br>  Realtor real estate agency (Agent) - makes to the system proposals for the lease and waiting for requests from tenants. <br>  The tenant reviews the offers, selects interesting criteria for him according to a set of criteria and contacts the agent to make a deal. <br><br><h4>  Data model design </h4><br>  Creating a model is creating classes in C #, adding field properties, attributes, comments. <br><img src="https://habrastorage.org/getpro/habr/post_images/39d/4f7/e42/39d4f7e42072bd3fe85a11251ea3e66e.png" alt="Model classes for real estate agency"><br>  in code, it looks like this: <br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [HierarchyRoot] [Index("CreationTime", Clustered = true)] public abstract class RentOfferBase : DocumentBase { ‚Ä¶ </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [Hidden] [Field(Length = 64)] public string Name { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [Field] public DateTime CreationTime { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [Field(Scale = 0)] public decimal Price { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [Field(Scale = 0)] public decimal Comission { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [Field(Nullable = false)] public EnCurrency Currency { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [Field] public MetroLine Line { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">       </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [Field] public MetroStation Metro { get; set; } }</span></span></code> </pre> <br>  Some features that make sense to pay attention to: <br><ul><li>  Xml comments <br>  They are made not only for clarity of the code, but also for use in the system interface.  What is on the first line will be the displayed field name.  Everything in the following - a pop-up hint.  With this approach, we have simplified our support for code documentation and object name management. </li><li>  Attributes <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Field(Length = 64)</span></span>]</code> </pre>  Field - a general indication that the property will be a persistent property <br>  Length - the length of the string <br>  Scale = 0 - the number of decimal places in decimal <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Index(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CreationTime"</span></span></span><span class="hljs-meta">, Clustered = true)</span></span>]</code> </pre>  Attribute of an entity (class) indicating the creation of an index, key fields, type <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HierarchyRoot</span></span>]</code> </pre>  An attribute indicating that a class is the root of an entity hierarchy, i.e.  all instances of this class, as well as its heirs, are stored <br></li></ul><br>  In this example, I applied inheritance to offers from a landlord (RentOfferBase) - the basic offer contains some of the fields, more detailed offers, such as an apartment offer - contains specifying fields - Kitchen area, Number of rooms. <br><br><h5><a name="inheritance"></a>  Inheritance </h5><br>  When working with ORM, we can use such a powerful OOP tool as inheritance. <br>  For the base class, rental offers are creating heirs: Apartment offers and Room offers <br><img src="https://habrastorage.org/getpro/habr/post_images/d92/308/9b1/d923089b1b6032bed348e55bebc1de60.png" alt="image"><br>  With obvious simplicity, this approach allows to drastically reduce the amount of code and simplify the development of similar entities, this is especially effective when developing similar documents that differ in several fields. <br><br><h5>  Encapsulation </h5><br>  In addition to the familiar to many encapsulations from the OOP world, when using ORM, we also encapsulate the physical data storage model.  We can use any inheritance scheme for the same business code.  Those.  we change the structure of the database without changing the application code, or almost without changing it. <br>  From the previous class structure, it is not entirely clear how the tables containing the data from the landlord will look like, but they can look in three different ways, depending on the value of the attribute indicating the inheritance scheme: <br><br><h6>  Classtable </h6>  Used by default, and creates a table for each class, starting from the root of the hierarchy <br><img src="https://habrastorage.org/getpro/habr/post_images/649/520/450/6495204504b5e1cfee61e77f94d74ffb.png" alt="Table schema for the inheritance model ClassTable"><br><br><h6>  SingleTable </h6>  One table for all hierarchy classes <br><img src="https://habrastorage.org/getpro/habr/post_images/64a/508/edc/64a508edc463c625798020a9f504accb.png" alt="The table schema for the SingleTable inheritance model"><br><br><h6>  Concretetable </h6>  According to the table for each non-abstract class <br><img src="https://habrastorage.org/getpro/habr/post_images/861/e55/500/861e55500237c1e557b4a7a581393d98.png" alt="Table layout for the ConcreteTable inheritance model"><br><br><h6>  Why is all this necessary? </h6><br>  In some cases, it is convenient to store normalized data, and in others, for optimization, it is more convenient to denormalize tables.  The advantage of ORM is that it can be done very simply - just by changing one line - in our case <pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HierarchyRoot</span></span>]</code> </pre>  will be replaced by <pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HierarchyRoot(InheritanceSchema.SingleTable)</span></span>]</code> </pre>  and <pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HierarchyRoot(InheritanceSchema.ConcreteTable)</span></span>]</code> </pre>  respectively.  In this case, because  we write queries not in SQL, then all queries will be automatically translated to use the appropriate inheritance scheme.  Those.  A report on rental offers / apartments / rooms written on LINQ and working through ORM will work with each scheme and will not require any modifications. <br><br><h4>  Adding Business Logic </h4><br><h5>  Form Events </h5><br>  Most platforms (like ours) are able to automatically generate forms according to the model.  But we have few static forms, let's revive it, add dynamics.  In our system, we have introduced such a concept as a form event handler - a class that implements the handler interface with an indication of which fields are tied events.  By changing the data on the client, data is sent to the server, deserialization, .net object processing, serialization, sending data to the client. <br><br>  For example, change the <a href="http://demo.oreodor.com/RealEstate/Auth.aspx%3FRedirect%3DCreateRentOffer.aspx%3Foperation_id%3D4ac3a6e6-3ddd-493c-be6b-a54daa1f84dd">form</a> Cost, immediately, on the fly, recalculated interest.  And vice versa.  But how concisely it looks in the code: <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    Price  ComissionPercent </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [OnFieldChange("Price", "ComissionPercent")] public class RentalPriceFormEvent : RentOfferFormEventsBase</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;RentOfferBase&gt;</span></span></span><span class="hljs-comment"> { public override void OnFieldChange(RentOfferBase item) { if (item.ComissionPercent != decimal.Zero) { item.Comission = item.Price * 0.01m * item.ComissionPercent; } } }</span></span></code> </pre> <br>  This is an event of calculating the commission on interest and price, the logic is very simple, but we can write here any code on .net.  If necessary, make a request to the database or web-service. <br><br><h5>  Polymorphism </h5><br>  In the previous example, we wrote an event for only one RentOfferBase entity, this event will work with successors, but what if we have several price / commission entities?  Write the same code every time? <br>  Select the interface <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public interface IWithComission { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> decimal Price { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> decimal Comission { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment">%</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> decimal ComissionPercent { get; set; } }</span></span></code> </pre>  and rewrite the event as <pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    RentalPrice  ComissionPercent </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TEntity"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> [OnFieldChange("Price", "ComissionPercent")] public class RentalPriceFormEvent</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TEntity&gt;</span></span></span><span class="hljs-comment"> : RentOfferFormEventsBase</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TEntity&gt;</span></span></span><span class="hljs-comment"> where TEntity : DocumentBase, IWithComission { public override void OnFieldChange(TEntity item) { if (item.ComissionPercent != decimal.Zero) { item.Comission = item.Price * 0.01m * item.ComissionPercent; } } }</span></span></code> </pre><br>  Now this code will work for any entity that implements the IWithComission interface.  At the same time, if it is necessary to make changes to the logic of interest calculation, then it should be done in a single place, in all other places everything will be applied automatically.  For example, create an entity for the application for the purchase of an apartment. <br>  This approach can significantly reduce the amount of code and ensure convenient product support. <br><br><h5>  Entity events </h5><br>  Entity events are very similar to form events, but they are transactional at the time an entity changes.  This is a kind of analogue of the DB triggers, but, unlike the triggers, and similar to form events, you can use the OOP approach.  For example, we need to control the change of entities on the status ‚Äúclosed‚Äù so that no one except the administrator can change them.  Pretty simple code <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">       </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [FireOn(EntityEventAction.Updated)] public class CheckStatus</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TEntity&gt;</span></span></span><span class="hljs-comment"> : IEntityEvent</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TEntity&gt;</span></span></span><span class="hljs-comment"> where TEntity : EntityBase, IWithStatus { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="item"&gt;</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public void Execute(TEntity item) { if (item.Status.Name == "" &amp;&amp; !Roles.IsUserInRole("admin")) { throw new ErrorException("     ''!"); } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">       </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public EntityEventAction CurrentAction { get; set; } }</span></span></code> </pre> <br><br>  Which checks that if the entity being changed is on the ‚ÄúClosed‚Äù status and the user does not belong to the admin role, an exception is generated.  Similar to the events of the forms, the events of the entities will be applied to all entities compatible with them, in this case implementing the IWithStatus interface. <br><br><h5>  Code separation </h5><br>  Some approaches use RichDomainModel, we have it. Anemic <br>  and this means that there is practically no business logic in the entity class.  (For this there are Events Forms / Entities / Filters, etc.) <br>  The advantage of this approach is the ability to modify the behavior of external entities.  For example, one company developed the Addresses module and delivers it as a library, we do not have access to the source code of this library and want to add some behavior to the form, for example, when choosing an incorrect address to warn. <br>  To do this, we can write a form event that will be applied to the external component. <br><br><h5>  Filters </h5><br>  The use of ORM allows filtering to use such powerful .net tools as ExpressionTrees.  We can write a filtering expression in advance for use as constraints of business logic, we can filter the grid based on user actions. <br><br>  For example, to limit the visibility of irrelevant tickets, for the manager, the following filtering expression from the code is applied: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Expression&lt;Func&lt;TOffer, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; FilterOffers&lt;TOffer&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TOffer : RentOfferBase { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a =&gt; a.Creator.SysName == SecurityHelper.CurrentLogin || a.Status.Name == <span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre> <br><br>  This is a simple filter that is used to restrict access rights only to their <a href="http://demo.oreodor.com/RealEstate/Auth.aspx%3FRedirect%3DMain.aspx">applications</a> , or to applications on the ‚ÄúActual‚Äù status. <br>  This filter is not explicitly attached to any entity right now, the generic parameter only says that it can be used for RentOfferBase and any of its heirs.  For whom it will actually be applied will be determined later, at the time of setting up the application. <br><br>  We can also filter one <a href="http://demo.oreodor.com/RealEstate/Auth.aspx%3FRedirect%3DCreateRentOffer.aspx%3Foperation_id%3D8257d7dc-9fae-4368-976c-efe6a7333635">form</a> field depending on another. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">FilterFor(typeof(RentOfferBase), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Metro"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Expression&lt;Func&lt;MetroStation, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; MetroFilter([Source(<span class="hljs-string"><span class="hljs-string">"Line"</span></span>)]MetroLine line) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a =&gt; line == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || a.MetroLine == line; }</code> </pre> <br><br>  Here we filter metro stations depending on the selected branch, specifying entities and fields in the attributes, which are used as sources of values ‚Äã‚Äãand filtering objects. <br><br><h4>  Making changes to the system </h4><br>  ERP system, unlike other applications, requires frequent changes in business logic and data model, and this process should be simple and reliable. <br><br>  Here it must be said that not only ORM is important, but CodeFirst ideology.  In the previous version of our system, we also used ORM - Linq2SQL.  In this case, the Database-first approach was used, the database was stored as a ‚Äúmaster database‚Äù and update scripts.  A typical error encountered in this approach is that the code of the .net classes does not correspond to the database.  To solve the problem, we wrote our own validators for the database structure. <br><br>  What do we get in CodeFirst: <br><ul><li>  Fast entity development - we write .net class rarely thinking about the database </li><li>  A convenient way to store the database in the version control system - we store only the class code </li><li>  Validation of business logic at compile time </li></ul><br><br>  But what about the updates? <br><br><h5><a name="Update"></a>  Migration </h5><br>  Imagine that we are preparing an update that the customer installs on their database.  Simple migrations are performed fully automatically.  Those.  if we made safe changes to the model - then ORM itself will migrate the database to the new version. <br>  Secure changes.  these changes do not delete data from the database, for example: <br><ul><li>  Creating a new field </li><li>  Creating a new entity </li><li>  Increase accuracy / field length </li></ul><br>  Of course, these actions are not enough when developing serious applications, what to do with the task of renaming a field / entity? <br><ol><li>  Apply rename refactoring (we use ReSharper).  In this case, all uses of this field in our code are renamed. <br>  Including renamed uses in Filters, Form Events, Entity Events.  Difficulty can deliver only the field names in the Attributes found in the form of text, but if the field name is sufficiently unique, then there will be no problems.  In this case, after renaming, you can start the compilation and make sure that the fields in the attributes are renamed correctly. </li><li>  Add hint rename.  Hint is a tooltip for ORM, what to do with a database if there are differences between a schema built by classes and a real schema in SQL.  hint rename field looks like this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RenameFieldUpgrader</span></span> : <span class="hljs-title"><span class="hljs-title">ModelUpgraderBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> Version Version { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(<span class="hljs-string"><span class="hljs-string">"3.5.0.8764"</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddUpgradeHints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ISet&lt;UpgradeHint&gt; hints</span></span></span><span class="hljs-function">)</span></span> { hints.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RenameFieldHint(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(RentOfferBase), <span class="hljs-string"><span class="hljs-string">"OldName"</span></span>, <span class="hljs-string"><span class="hljs-string">"NewName"</span></span>)); } }</code> </pre> </li></ol><br>  With similar hints, we can indicate renaming the entity, deleting the field / entity.  If there is such a hint, the next time ORM starts, it automatically applies renaming refactoring for the database and renames the field with the data saved. <br><br><h4>  Results </h4><br>  As a result of the application of ORM, we received: <br><ul><li>  Convenient and fast development of both data model and business logic </li><li>  Convenient, easy and reliable application support </li><li>  Used the advantages of OOP at all stages </li><li>  Code reuse (excluded copy-paste) </li><li>  Code Validation at Compile Time </li><li>  Concise, clear code of business logic </li></ul></div><p>Source: <a href="https://habr.com/ru/post/140713/">https://habr.com/ru/post/140713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140708/index.html">Cloud - what is it and why?</a></li>
<li><a href="../140709/index.html">Distributions, updates and errata for Oracle Linux are now available for free</a></li>
<li><a href="../140710/index.html">Where would you get the first large round of investment for your startup? Comment!</a></li>
<li><a href="../140711/index.html">Cloud services are the priority of e-Style Telecom</a></li>
<li><a href="../140712/index.html">A brief guide to integrating the Twig template and Slim Micro Framework</a></li>
<li><a href="../140714/index.html">Rapid development environment deployment</a></li>
<li><a href="../140715/index.html">Introduction to CSS3 Grid Layout. We work with nets</a></li>
<li><a href="../140716/index.html">Skype 5.5 decrypted for reverse engineering</a></li>
<li><a href="../140717/index.html">Speech Synthesis through Microsoft Translator for Asterisk</a></li>
<li><a href="../140718/index.html">Runet Today, March 26, 2012. Experts of the issue: Pavel Cherkashin, Askar Tuganbayev</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>