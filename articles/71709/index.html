<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing KVM virtual machines under ubuntu server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, the use of virtualization in building server infrastructure is becoming more common. Flexibility, scalability, economy make this technology ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing KVM virtual machines under ubuntu server</h1><div class="post__text post__text-html js-mediator-article">  Recently, the use of virtualization in building server infrastructure is becoming more common.  Flexibility, scalability, economy make this technology very promising.  Now on the market there are a sufficient number of solutions, both proprietary and open source, allowing you to deploy virtual servers.  One of these options I want to consider in this article. <br><a name="habracut"></a><br>  Having played with the GUY virtualization platforms from Microsoft, VMware and Sun, I decided to try to do the same through the console.  Having installed the ubuntu distribution for a long time I liked linux, I began to choose which implementation of virtual machines (VM) to stop at.  There is an interesting <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BD%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B2%25D0%25B8%25D1%2580%25D1%2582%25D1%2583%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D1%2585_%25D0%25BC%25D0%25B0%25D1%2588%25D0%25B8%25D0%25BD">tablet on</a> Wikipedia, although after seeing the official <a href="https://help.ubuntu.com/9.04/serverguide/C/libvirt.html">help</a> to ubuntu, I realized that it is better to start with KVM. <br><br>  The installation procedure of the host server is generally standard, but there are some nuances.  During the installation, I turned on LVM (as I understood, guest OSs can be placed on LVM volumes, which will give additional flexibility), and in the selection window of the pre-installed software I noted OpenSSH server and Virtual Machine host. <img src="http://img59.imageshack.us/img59/8755/ubuntu.png" alt="image"><br><br>  The host server is configured with a static ip 172.16.4.24, which can be seen later in the configurations listed. <br>  After installing the host server, connect to it via ssh (with the same command from linux or putty / kitty from windows). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First you need to check if the server hardware supports hardware virtualization with the command <br>  <b>egrep '(vmx | svm)' / proc / cpuinfo</b> <br>  If the command output is not empty, then it supports. <br><br>  Download into the home folder an iso-image of the distribution of the operating system, which later will be a guest.  I have the same ubuntu-9.04-server-amd64.iso <br><br>  Install the necessary packages: <br>  <b>sudo apt-get install kvm libvirt-bin python-virtinst bridge-utils</b> <br><br>  Add a user who will drive virtuals (in the simplest case, this is the user we started during the installation of the system, and under which we perform all the described actions): <br>  <b>sudo adduser $ USER libvirtd</b> <br><br>  After this, it is better to rebuy. <br><br>  Check how KVM was established with the command: <br>  <b>virsh -c qemu: /// system list --all</b> <br>  The following should appear in the console: <br>  <i>az @ vsrvs: ~ $ virsh -c qemu: /// system list --all</i> <i><br></i>  <i>Connecting to uri: qemu: /// system</i> <i><br></i>  <i>Id Name State</i> <i><br></i>  <i>----------------------------------</i> <br>  if so, continue. <br><br>  In order for virtual servers to work in our real local area network on the host machine, we create a network bridge.  To do this, edit the file / etc / network / interfaces <br><br>  So he looked before the modification: <br><pre> # This file is the network interfaces available on your system
 # and how to activate them.  For more information, see interfaces (5).

 # The loopback network interface
 auto lo
 iface lo inet loopback

 # The primary network interface
 auto eth0
 iface eth0 inet static
        address 172.16.4.24
        netmask 255.255.255.192
        network 172.16.4.0
        broadcast 172.16.4.63
        gateway 172.16.4.1
</pre><br><br>  So after: <br><pre> # This file is the network interfaces available on your system
 # and how to activate them.  For more information, see interfaces (5).

 # The loopback network interface
 auto lo
 iface lo inet loopback

 # The primary network interface
 auto eth0
 iface eth0 inet manual

 auto br0
 iface br0 inet static
         address 172.16.4.24
         netmask 255.255.255.192
         network 172.16.4.0
         broadcast 172.16.4.63
         gateway 172.16.4.1
         bridge_ports eth0
         bridge_fd 9
         bridge_hello 2
         bridge_maxage 12
         bridge_stp off
</pre><br><br>  Next, proceed to the installation of VM: <br>  <b>sudo virt-install -n vsrv1 -r 384 -f vsrv1.img -s 10 -c ubuntu-9.04-server-amd64.iso --accelerate --os-type = linux --os-variant = generic26 -v - vnc -w bridge: br0</b> <br>  Where: <br>  -n vsrv1 - VM name; <br>  -r 384 - allocated amount of RAM for it; <br>  -f vsrv1.img - file that is a virtual hard disk for the guest OS; <br>  -s 10 - volume of this disk in gigabytes; <br>  -c ubuntu-9.04-server-amd64.iso - the cd image of the guest OS distribution, which is connected as a virtual cdrom; <br>  --accelerate --os-type = linux --os-variant = generic26 -v - we accelerate, optimize VM for a specific guest OS and enable hardware virtualization capabilities; <br>  --vnc - we start a vnc-server for VM; <br>  -w bridge: br0 - specify the use of a network bridge. <br><br>  If, after running this command, no errors occurred, but the following is displayed: <br>  <i>Starting install ...</i> <i><br></i>  <i>Creating domain ... 0 B 00:01</i> <i><br></i>  <i>/usr/lib/python2.6/dist-packages/virtinst/Guest.py:1086: DeprecationWarning: integer argument expected, got float</i> <i><br></i>  <i>for ignore in range (1, (5 / .25)): # 5 seconds, .25 second sleeps</i> <i><br></i>  <i>Unable to connect to graphical console: virt-viewer not installed.</i>  <i>Please install the 'virt-viewer' package.</i> <i><br></i>  <i>Domain installation still in progress.</i>  <i>You can reconnect to</i> <i><br></i>  <i>complete the installation process.</i> <br><br>  Everything is fine, the virtual machine has started, which can be checked with the command: <br>  <b>virsh -c qemu: /// system list --all</b> <br>  Therefore, we violate the installation of the guest OS. <br><br>  First you need to connect to the vnc server that displays the VM screen.  I did it from WinXP, although from almost any linux distribution, it is done in a similar way. <br><br>  Install (if you did not install at the very beginning, but set up a server locally) ssh-client, for example, <a href="http://www.9bis.net/kitty/%3Ffile%3Dkitty.exe">kitty</a> (modified putty version).  Run, customize: <br><ol><li>  In the Session tab, the Host Name (or IP address) is the address of our host server (in my case, 172.16.4.24). </li><li>  In the Windows Translation tab, select UTF-8. </li><li>  In the Connection-SSH-Tunnels tab - fill in the fields Source port 59000, Destination localhost: 5900, click Add.  The following entry should appear: <br><img src="http://img12.imageshack.us/img12/575/kittyf.png" alt="image"><br></li><li>  We press Open and we must connect via SSH to the host server.  At the same time, we will redirect the port 5900 of the host server (port of the vnc server) to our local 59000 port. </li></ol><br>  Note.  When you start another VM, the vnc server port will increase by 1, so in order to see its screen, you need to redirect the port 5901 of the host server to, for example, port 59001. <br><br>  Install the vnc client, for example <a href="http://www.uvnc.com/download/1065/1065full.html">UltraVNC</a> , run the UltraVNC Viewer and connect to localhost: 59000.  If everything is done correctly, then we will see the screen of our VM running the guest OS installer. <br><br>  Install the guest OS. <br><br>  So it starts to load after installation: <img src="http://img28.imageshack.us/img28/9238/vsrv1.png" alt="image"><br><br>  After installing and configuring the guest OS, the VM can be cloned with the command <br>  <b>sudo virt-clone -o vsrv1 -n vsrv2 -f vsrv2.img --connect = qemu: /// system</b> <br><br>  UPD: After cloning, in order for the network interface to work, you must delete the /etc/udev/rules.d/70-persistent-net.rules file on the clone and at the same time change the name of the server in / etc / hostname and in / etc / hosts new. <br><br>  TIP: <br>  Commands to control VM: <br><ul><li> <code><b>virsh -c qemu:///system help</b> <br>     <b>virsh -c qemu:///system list --all</b> <br>     <b>virsh -c qemu:///system start vsrv1</b> <br>   vsrv1 <b>virsh -c qemu:///system shutdown vsrv1</b> <br>      <b>virsh -c qemu:///system destroy vsrv1</b> <br>     <b>virsh -c qemu:///system undefine vsrv1</b> <br>   <br></code> </li> <li> <code><b>virsh -c qemu:///system help</b> <br>     <b>virsh -c qemu:///system list --all</b> <br>     <b>virsh -c qemu:///system start vsrv1</b> <br>   vsrv1 <b>virsh -c qemu:///system shutdown vsrv1</b> <br>      <b>virsh -c qemu:///system destroy vsrv1</b> <br>     <b>virsh -c qemu:///system undefine vsrv1</b> <br>   <br></code> </li> <li> <code><b>virsh -c qemu:///system help</b> <br>     <b>virsh -c qemu:///system list --all</b> <br>     <b>virsh -c qemu:///system start vsrv1</b> <br>   vsrv1 <b>virsh -c qemu:///system shutdown vsrv1</b> <br>      <b>virsh -c qemu:///system destroy vsrv1</b> <br>     <b>virsh -c qemu:///system undefine vsrv1</b> <br>   <br></code> </li> <li> <code><b>virsh -c qemu:///system help</b> <br>     <b>virsh -c qemu:///system list --all</b> <br>     <b>virsh -c qemu:///system start vsrv1</b> <br>   vsrv1 <b>virsh -c qemu:///system shutdown vsrv1</b> <br>      <b>virsh -c qemu:///system destroy vsrv1</b> <br>     <b>virsh -c qemu:///system undefine vsrv1</b> <br>   <br></code> </li> <li> <code><b>virsh -c qemu:///system help</b> <br>     <b>virsh -c qemu:///system list --all</b> <br>     <b>virsh -c qemu:///system start vsrv1</b> <br>   vsrv1 <b>virsh -c qemu:///system shutdown vsrv1</b> <br>      <b>virsh -c qemu:///system destroy vsrv1</b> <br>     <b>virsh -c qemu:///system undefine vsrv1</b> <br>   <br></code> </li> <li> <code><b>virsh -c qemu:///system help</b> <br>     <b>virsh -c qemu:///system list --all</b> <br>     <b>virsh -c qemu:///system start vsrv1</b> <br>   vsrv1 <b>virsh -c qemu:///system shutdown vsrv1</b> <br>      <b>virsh -c qemu:///system destroy vsrv1</b> <br>     <b>virsh -c qemu:///system undefine vsrv1</b> <br>   <br></code> </li> </ul> <code><b>virsh -c qemu:///system help</b> <br>     <b>virsh -c qemu:///system list --all</b> <br>     <b>virsh -c qemu:///system start vsrv1</b> <br>   vsrv1 <b>virsh -c qemu:///system shutdown vsrv1</b> <br>      <b>virsh -c qemu:///system destroy vsrv1</b> <br>     <b>virsh -c qemu:///system undefine vsrv1</b> <br>   <br></code> <br><br>  Used materials: <br><ol><li>  man-s of the programs presented </li><li>  <a href="https://help.ubuntu.com/9.04/serverguide/C/virtualization.html">https://help.ubuntu.com/9.04/serverguide/C/virtualization.html</a> </li><li>  <a href="">http://www.howtoforge.com/virtualization-with-kvm-on-ubuntu-9.04</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/71709/">https://habr.com/ru/post/71709/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../71700/index.html">Vertical block alignment in CSS</a></li>
<li><a href="../71701/index.html">Google introduces people to browsers</a></li>
<li><a href="../71704/index.html">When memory is more critical than time</a></li>
<li><a href="../71705/index.html">Books on programming from the German survey</a></li>
<li><a href="../71707/index.html">Memcached How to find the keys on the pattern?</a></li>
<li><a href="../71711/index.html">Kindle is available in Russia</a></li>
<li><a href="../71712/index.html">Murphy's Law</a></li>
<li><a href="../71713/index.html">Fujitsu's future mobile phone concepts</a></li>
<li><a href="../71714/index.html">Latest Chrome Extensions</a></li>
<li><a href="../71716/index.html">HUD and notes for road users</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>