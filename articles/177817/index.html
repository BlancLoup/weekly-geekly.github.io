<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Refactoring with a tambourine, or as we Hulk pacified</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think everyone will agree that most startups were originally made on the knee. Only then, in the event of a successful shooting, with proper guidanc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Refactoring with a tambourine, or as we Hulk pacified</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/85d/4bb/cec/85d4bbcec400facab579ec2834233d9f.jpg"><br><br>  I think everyone will agree that most startups were originally made on the knee.  Only then, in the event of a successful shooting, with proper guidance and understanding of the strategic goals, resource owners can decide to refactor an existing product.  Well, if this happened before turning Bruce Banner into the Hulk.  But what to do if such a moment was safely missed, and the resource is a huge green poorly controlled giant?  What to do in this situation? <a name="habracut"></a><br><br>  The first decision that comes to mind is to rewrite everything, holding Fowler and GOFA little books under your arm.  There is but: it is unlikely that such a proposal will be taken seriously.  The second solution, which is more acceptable, is to try to humiliate Alexander the Great in small steps, and nevertheless unravel the Gordian Knot. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article, I want to share the experience of converting a very convoluted solution into an application divided into obvious layers and covered with unit tests.  Naturally, the examples mentioned in the article are fairly simplified.  In my opinion, they are quite enough to understand the basic concept.  Before starting, it‚Äôs worth saying that the author considers unit testing as one of the most significant indicators of code quality.  It is also worth clarifying that the solution is written in ASP.NET using Webforms. <br><br>  So let's start our dances: <br><br><h4>  The first figure is tangled. </h4><br><br>  The very first problem that had to be encountered is the mixing of the code responsible for the html generation with the DAL code.  That is, here is such scribbling, located inside UserControl, met quite often: <br><br><pre><code class="cs hljs">StringBuilder content = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> persons = Database.Persons.GetListBySchool(school); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> person <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> persons) { content.AppendFormat(@‚Äù&lt;p&gt;{<span class="hljs-number"><span class="hljs-number">0</span></span>}&lt;/p&gt;‚Äù, person.Name); }</code> </pre> <br><br>  Naturally, in this situation, there is no need to dream of any change in the implementation of the receipt of the list of persons.  And about the coverage of this code with unit tests, I generally keep quiet.  Soon, I made a decision that would rather quickly and painlessly break the link between UI and DAL. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ICommand</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Command</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ICommand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Result { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ICommandExecutor</span></span> { T Run&lt;T&gt;(Command&lt;T&gt; command); }</code> </pre><br><br>  Each unit of business logic, for which reference to the database is necessary, became a separate team, and looked something like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GetListBySchool</span></span>: <span class="hljs-title"><span class="hljs-title">Command</span></span>&lt;<span class="hljs-title"><span class="hljs-title">List</span></span>&lt;<span class="hljs-title"><span class="hljs-title">DbPerson</span></span>&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSchool School { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Result = Database.Persons.GetListBySchool(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.School); } }</code> </pre><br><br>  Here is the implementation of ICommandExecutor: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Run&lt;T&gt;(Command&lt;T&gt; command) { command.Execute(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> command.Result; }</code> </pre><br><br>  When using this solution, the code inside user controls turned into: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICommandExecutor executor; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SchoolView</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ICommandExecutor executor</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (executor == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"executor"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.executor = executor; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPersonsHtmlList</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { StringBuilder content = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> persons = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.executor.Run(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GetListBySchool { School = school }); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> person <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> persons) { content.AppendFormat(@‚Äù&lt;p&gt;{<span class="hljs-number"><span class="hljs-number">0</span></span>}&lt;/p&gt;‚Äù, person.Name); }</code> </pre><br><br>  It seems to be all right, but immediately after replacing all direct access to the database with commands, it became clear that the updated code obtained was also impossible to test.  And the reason for this is the objects returned by the command.  The <b>DbPerson</b> class contained a lot of logic and properties that did not have a public setter.  The first few properties were successfully labeled as <b>virtual</b> and locks.  But the third property had a type that has only a <b>private</b> constructor - this was the stumbling block.  At that moment someone hit the table with his fist and said that, once they decided to do it without crutches, they should follow this direction.  The properties marked <b>virtual</b> were reset, and the brain started working in search of another option.  In fact, the decision initially lay on the surface, just no one had the courage to voice it, because it entailed a lot of tedious work.  And the solution is as follows: <b>DTO</b> .  This means that inside UserControls, we use objects that are a copy of DAL objects, but without any program logic, with public getters and setters.  To make this solution possible, we have created converters.  For convenience, extension-methods were used. <br><br>  The team began to look like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GetListBySchool</span></span>: <span class="hljs-title"><span class="hljs-title">Command</span></span>&lt;<span class="hljs-title"><span class="hljs-title">List</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Person</span></span>&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> SchoolId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbSchool = DataBase.Instance.GetSchoolById(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SchoolId); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Result = dbSchool.Network.Memberships .GetListBySchool(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.School) .Select(person =&gt; person.Convert()) .ToList(); } }</code> </pre><br><br>  Now our method <b>GetPersonsHtmlList has</b> become fully testable, however, another problem has appeared: there is not a single method inside UserControl, there are many of them.  And if before the <b>DbSchool</b> object <b>was</b> loaded only once, now it is loaded in each individual command, and this is not comme il faut.  To solve this problem, <b>IContextManager</b> comes to us with <br><br><pre> <code class="cs hljs">T GetFunctionResult&lt;T&gt;(Func&lt;T&gt; func) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>;</code> </pre><br><br>  With implementation, we didn‚Äôt really bother using <b>HttpContext.Current</b> .  That is, if the method is called for the first time, then the object is thrown into the context.  If the method is called a second or more times, then the object is taken from the context.  The implementation of <b>IContextManager</b> is set in the constructor of the <b>CommandExecutor</b> , and then passed to all commands (the base class of the command has a new property). <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Run&lt;T&gt;(Command&lt;T&gt; command) { command.Context = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.context; command.Execute(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> command.Result; }</code> </pre><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GetListBySchool</span></span>: <span class="hljs-title"><span class="hljs-title">Command</span></span>&lt;<span class="hljs-title"><span class="hljs-title">List</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Person</span></span>&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> SchoolId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbSchool = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Context.GetFunctionResult(() =&gt; DataBase.Instance.GetSchoolById(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SchoolId)); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Result = dbSchool.Network.Memberships .GetListBySchool(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.School) .Select(person =&gt; person.Convert()) .ToList(); } }</code> </pre><br><br>  As a result, at relatively low cost, we managed to separate the UI layer.  And, more importantly, we have the opportunity to cover this layer with unit tests.  We also have certain clues to highlight the layer of business logic.  In my opinion, having a set of individual commands, it is easier to combine them into various services than to think through a competent composition from scratch. <br><br><h4>  The second figure is obvious. </h4><br><br>  The next task was to get rid of the binding to the Request.Params collection.  But here no one had any questions, and the solution was as follows: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IParametersReader</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRequestValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RequestParametersReader</span></span> : <span class="hljs-title"><span class="hljs-title">IParametersReader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> HttpContextBase context; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestParametersReader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContextBase context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"context"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.context = context; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRequestValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.context.Request[key]; } }</code> </pre><br><br><h4>  The third figure is air. </h4><br><br>  As it usually happens, pages consist not of one UserControl, but of several.  They all need the same objects.  Initially, the following solution was invented and implemented: In the child UserControl, a method is created <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Bind</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbSchool school, DbPerson person</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.school = school; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.person = person; }</code> </pre><br><br>  The method is then called from the parent UserControl.  It seems that everything is fine, and such a decision has the right to exist.  However, you should not forget: when the nesting of controls is more than two levels, the possibility of making a mistake or forgetting to set the desired value increases significantly. As a solution, we used the rather interesting concept of Dependency Outjection.  Its main idea is not to receive data from a predetermined source, but from a general collection of objects that anyone can replenish.  Two classes were created for this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><br>  and <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OutAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><br>  Those properties that need to be hung in the air are marked with the Out attribute.  Those properties that need to be filled out of this air are, by analogy, marked with the In attribute. Next is just a matter of technology.  We created a class inherited from System.Web.UI.UserControl, and we added the following code to it: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnLoad</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    var inProperties = this.GetType() .GetProperties() .Where(prop =&gt; prop.GetCustomAttributes(typeof(InAttribute), false).Any()); foreach (var property in inProperties) { var inAttribute = property.GetCustomAttributes(typeof(InAttribute), false).First() as InAttribute; if (inAttribute == null) { continue; } property.SetValue( this, this.context.Get(string.IsNullOrWhiteSpace(inAttribute.Name) ? property.Name : inAttribute.Name), null); } base.OnLoad(e); //    var outProperties = this.GetType() .GetProperties() .Where(prop =&gt; prop.GetCustomAttributes(typeof(OutAttribute), false).Any()); foreach (var property in outProperties) { var outAttribute = property.GetCustomAttributes( typeof(OutAttribute), false).First() as OutAttribute; if (outAttribute == null) { continue; } this.context.Add(string.IsNullOrWhiteSpace(outAttribute.Name) ? property.Name : outAttribute.Name, property.GetValue(this, null)); } }</span></span></code> </pre><br><br><h4>  Epilogue: </h4><br><br>  This was the first stage of refactoring our <s>green monster</s> software.  The result of our work are: <br><br>  1. Ability to fully cover UserControls with unit tests. <br>  2. A clearer separation of the UI layer from everything else. <br>  3. Disposal of a rigid binding between nested UserContols. <br>  4. Improving code readability. <br>  5. Reducing moral torment and purification of conscience;) <br><br>  <i>The author of the article: Vitaly Lebedev, leading developer Diary.ru</i> </div><p>Source: <a href="https://habr.com/ru/post/177817/">https://habr.com/ru/post/177817/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177803/index.html">Just add meat or embedding on mode</a></li>
<li><a href="../177805/index.html">Creating a graphic captcha with a choice of extra</a></li>
<li><a href="../177807/index.html">Labyrus: 3D maze</a></li>
<li><a href="../177811/index.html">MegaFon Login (SP-A1): well, very budget Android</a></li>
<li><a href="../177813/index.html">Google joins FIDO Alliance to find a reliable alternative to user password authentication.</a></li>
<li><a href="../177819/index.html">Habrainterview with the creators of the game "Space Rangers" Alexei Dubov and representatives of the SNK</a></li>
<li><a href="../177821/index.html">YouTube turned 8 years old</a></li>
<li><a href="../177823/index.html">E. coli can produce diesel fuel.</a></li>
<li><a href="../177827/index.html">Nokia showed a $ 72 QWERTY phone</a></li>
<li><a href="../177829/index.html">Defragmentation of the brain. Soft building from the inside</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>