<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Organizing a large project on the Zend Framework 2/3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The idea of ‚Äã‚Äãsplitting large projects into small parts - the so-called microservice architecture - has recently become more and more popular among de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Organizing a large project on the Zend Framework 2/3</h1><div class="post__text post__text-html js-mediator-article">  The idea of ‚Äã‚Äãsplitting large projects into small parts - the so-called <b>microservice architecture</b> - has recently become more and more popular among developers.  This is a good approach for organizing code and developing as a whole, but what should those who have the code base start to take shape long before the peak of the popularity of the microservice architecture?  The same question can be attributed to those who are comfortable on the loads on one powerful server, and there is simply no time to rewrite the code.  Speaking of our own experience: now we are introducing microservices, but initially our monolith was designed ‚Äúmodular‚Äù, so that it was easy to maintain, regardless of volume.  Who cares how we organize the code - welcome under cat. <br><a name="habracut"></a><br>  Steve McConnell‚Äôs book Complete Code describes a bright philosophical idea that the main challenge facing the developer is managing the complexity of the code.  One way to manage complexity is decomposition.  Actually, the division of a large piece of code into simpler and smaller ones will be discussed. <br><br><h3>  Modules </h3><br>  Zend Framework offers us to divide our code into <b>modules</b> .  In order not to reinvent the wheel and go along with the framework, let our parts into which we want to logically cut the project be modules in terms of the Zend Framework.  Only we will <b>refine the inter-module interaction</b> so that each of them works exclusively in his area of ‚Äã‚Äãresponsibility and does not know anything about the other modules. <br><br>  Each module consists of a set of classes with a typical purpose: <b>controllers, event listeners, event handlers, command handlers, services, commands, events, filters, entities, and repositories</b> .  All the above types of classes are organized into a certain hierarchy, where the upper layer knows about the lower layers, but the lower layers do not know anything about the upper layers (yes, layered architecture, it is the same). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the top of the logical hierarchy are the <b>controllers</b> and <b>event listeners</b> .  The first accept commands from users in the form of http-requests, the second react to events in other modules. <br><br>  With the controller, everything is clear - this is the usual standard MVC controller provided by the framework.  Listener of the events, we decided to make one for all modules.  It implements the Zend \ EventManager \ ListenerAggregateInterface listener aggregator interface and binds event handlers to events by taking the description from the configuration of each module. <br><br><div class="spoiler">  <b class="spoiler_title">Listener ID</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListenerAggregator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListenerAggregateInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $eventsMap; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ContainerInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $container; <span class="hljs-comment"><span class="hljs-comment">/** * Attach one or more listeners * * Implementors may add an optional $priority argument; the EventManager * implementation will pass this to the aggregate. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> EventManagerInterface $events * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $priority */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EventManagerInterface $events, $priority = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $events-&gt;addIdentifiers([Event::DOMAIN_LOGIC_EVENTS_IDENTIFIER]); $map = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getEventsMap(); $container = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($map <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $eventClass =&gt; $handlers) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($handlers <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $handlerClass) { $events-&gt;getSharedManager()-&gt;attach(Event::EVENTS_IDENTIFIER, $eventClass, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($event)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($container, $handlerClass)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $handler EventHandlerInterface */</span></span> $handler = $container-&gt;get($handlerClass); $handler-&gt;handle($event); } ); } } } }</code> </pre> <br></div></div><br>  After that, in each of the modules, a map of the events to which the listeners of this module subscribe is set. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'events'</span></span> =&gt; [ UserRegisteredEvent::class =&gt; [ UserRegisteredHandler::class, ], ]</code> </pre><br>  In fact, the modules communicate with each other exclusively through controllers and events. <br>  If we need to pull up some kind of data visualization from another module (widget), then we use the controller's call to another module via forward () and add the result to the current model of the form: <br><br><pre> <code class="php hljs"> $comments = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;forward()-&gt;dispatch( <span class="hljs-string"><span class="hljs-string">'Dashboard\Controller\Comment'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'browse'</span></span>, <span class="hljs-string"><span class="hljs-string">'entity'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'blog_posts'</span></span>, <span class="hljs-string"><span class="hljs-string">'entityId'</span></span> =&gt; $post-&gt;getId() ] ); $view-&gt;addChild($comments, <span class="hljs-string"><span class="hljs-string">'comments'</span></span>);</code> </pre><br>  If we need to inform other modules that something has happened to us, we throw an event so that other modules respond. <br><br><h3>  Service classes </h3><br>  We reviewed the controllers and event listeners above; now let's go through the remaining module classes that occupy a lower layer in the logical hierarchy: event handlers, command handlers, services, and repositories. <br><br>  I will begin, perhaps, with the last.  Repositories  Conceptually, this is a collection for working with a certain type of entity that can store data somewhere in a remote repository.  In our case in the database.  They can be implemented, either using standard Zend-s TableGateway and QueryBuilder, or connecting any ORM.  Doctrine 2 is perhaps the best tool for working with databases in a large monolith.  And the repositories as a concept are already there out of the box. <br><br>  For example, in the context of Doctrine 2, the repository will look like this: <br><br><div class="spoiler">  <b class="spoiler_title">Repository code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> UserFilter $filter * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> City|null */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findOneUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserFilter $filter)</span></span></span><span class="hljs-function"> </span></span>{ $query = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createQuery($filter); <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> $query-&gt;getQuery()-&gt;getOneOrNullResult(); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> UserFilter $filter * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> \Doctrine\ORM\QueryBuilder */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserFilter $filter)</span></span></span><span class="hljs-function"> </span></span>{ $qb = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createQueryBuilder(<span class="hljs-string"><span class="hljs-string">'user'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($filter-&gt;getEmail()) { $qb-&gt;andWhere(<span class="hljs-string"><span class="hljs-string">'user.email = :email'</span></span>) -&gt;setParameter(<span class="hljs-string"><span class="hljs-string">'email'</span></span>, $filter-&gt;getEmail()); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($filter-&gt;getHash()) { $qb-&gt;andWhere(<span class="hljs-string"><span class="hljs-string">'user.confirmHash =:hash'</span></span>) -&gt;setParameter(<span class="hljs-string"><span class="hljs-string">'hash'</span></span>, $filter-&gt;getHash()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $qb; } }</code> </pre><br></div></div><br>  To retrieve entities from the repository, both simple type parameters and DTO objects can be used, which store a set of parameters that need to be sampled from the database.  In our terminology, these are filters (this is how they were named, because with their help we filter entities returned from the repository). <br><br>  <b>Services</b> are classes that either act as facades to the application logic, or encapsulate the logic of working with external libraries and APIs. <br><br>  <b>Event handlers and command handlers</b> are in fact a service with one public method, handle (), while they are engaged in changing the state of the system, which none of the other template classes do.  By changing the state of the system, we mean any actions to write to the database, to the file system, send commands to third-party APIs, which will lead to changes in the data returned by this API, etc. <br><br>  In our implementation, the event handler differs from the command handler only in that the DTO, which is passed to it as a parameter, is inherited from the Zend Event.  While the command handler can come a command in the form of any entity. <br><br><div class="spoiler">  <b class="spoiler_title">Sample event handler</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRegisteredHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventHandlerInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ConfirmEmailSender */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $emailSender; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> EventManagerInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $eventManager; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( ConfirmEmailSender $emailSender, EventManagerInterface $eventManager )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emailSender = $emailSender; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;eventManager = $eventManager; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Event $event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!($event <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> UserRegisteredEvent)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \RuntimeException(<span class="hljs-string"><span class="hljs-string">'   '</span></span>); } $user = $event-&gt;getUser(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$user-&gt;isEmailConfirmed()) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;send($user); } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User $user)</span></span></span><span class="hljs-function"> </span></span>{ $hash = md5($user-&gt;getEmail() . <span class="hljs-string"><span class="hljs-string">'-'</span></span> . time() . <span class="hljs-string"><span class="hljs-string">'-'</span></span> . $user-&gt;getName()); $user-&gt;setConfirmHash($hash); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emailSender-&gt;send($user); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;eventManager-&gt;triggerEvent(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfirmationEmailSentEvent($user)); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Sample command handler</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> UserRepository */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $userRepository; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> PasswordService */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $passwordService; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> EventManagerInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $eventManager; <span class="hljs-comment"><span class="hljs-comment">/** * RegisterCommand constructor. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> UserRepository $userRepository * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> PasswordService $passwordService * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> EventManagerInterface $eventManager */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( UserRepository $userRepository, PasswordService $passwordService, EventManagerInterface $eventManager )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userRepository = $userRepository; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;passwordService = $passwordService; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;eventManager = $eventManager; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RegisterCommand $command)</span></span></span><span class="hljs-function"> </span></span>{ $user = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> $command-&gt;getUser(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;validate($user); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;modify($user); $repo = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userRepository; $repo-&gt;saveAndRefresh($user); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;eventManager-&gt;triggerEvent(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserRegisteredEvent($user)); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">modify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User $user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;passwordService-&gt;encryptPassword($user); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> CommandException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User $user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$user) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParameterIsRequiredException(<span class="hljs-string"><span class="hljs-string">'   user   RegisterCommand'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;validateIdentity($user); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateIdentity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User $user)</span></span></span><span class="hljs-function"> </span></span>{ $repo = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userRepository; $persistedUser = $repo-&gt;findByEmail($user-&gt;getEmail()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($persistedUser) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EmailAlreadyExists(<span class="hljs-string"><span class="hljs-string">'   email  '</span></span>); } } }</code> </pre><br></div></div><br><h3>  DTO objects </h3><br>  Above we described typical classes that implement the logic of the application and the interaction of the application with external APIs and libraries.  But for the coordinated work of all of the above, ‚Äúglue‚Äù is needed.  This ‚Äúglue‚Äù is <b>Data Transfer Objects</b> , which typify communication between different parts of an application. <br><br>  In our project, they have a separation: <br><br>  - Entities - data that represents basic concepts in the system, such as: user, dictionary, word, etc.  Basically, they are selected from the database and presented in one form or another in the view scripts. <br>  - Events - DTO, inherited from the Event class, containing information about what has been changed in a module.  They can be thrown by command handlers or event handlers.  And only event handlers accept and work with them. <br>  - Commands - DTO, containing the data required by the processor.  Formed in controllers.  Used in command handlers. <br>  - Filters - DTO, containing the parameters of sampling from the database.  Anyone can form;  used in repositories to build a query to the database. <br><br><h3>  How does the interaction of parts of the system </h3><br>  Interaction with the system is divided into data reading and data modification.  If the requested URL should only give the data, then the interaction is structured as follows: <br><br>  1) The data from the user in the raw form come to the controller action. <br>  2) Using Zend InputFilter, filter them and validate. <br>  3) If they are valid, then in the controller we form a DTO filter. <br>  4) Then everything depends on whether the resulting data from one repository is obtained or compiled from several.  If from one, then we call the repository from the controller, passing in an object formed at the 3rd step to the search method.  If the data needs to be compiled, then we create a service that will act as a facade for several repositories, and we are already giving it a DTO.  Service also pulls the necessary repositories and assembles data from them. <br>  5) We return the received data in the ViewModel, after which the view script is rendered. <br>  You can visualize the components involved in the acquisition of data, as well as the movement of this data using the scheme: <br><br><img src="https://habrastorage.org/web/679/6f9/6b0/6796f96b09f24da6b32b815320f28a65.png"><br><br>  If the requested URL should change the state of the system: <br><br>  1) The data from the user in the raw form come to the controller action. <br>  2) Using Zend InputFilter, filter them and validate. <br>  3) If they are valid, then in the controller we form DTO commands. <br>  4) Run the command handler in the controller, passing the command to it.  It is considered correct to send a command to the command bus.  We used Tactician as a tire.  But in the end, we decided to directly launch the handler, since  although the teams received an additional level of abstraction, which theoretically gave us the opportunity to start some commands asynchronously, but in the end we were inconvenienced that we had to subscribe to the response from the team in order to find out the result of its development.  And since we do not have a distributed system and do something asynchronously - this is the exception rather than the rule, we decided to ignore the abstraction for the sake of usability. <br>  5) The command handler changes data using services and repositories, and generates an event, passing the modified data there.  Then throws an event into the event bus. <br>  6) The event handler (s) catches the event and performs its transformations.  If necessary, also throws an event with information about which transformations have been made. <br>  7) After all event handlers are processed, the control flow returns from the command to the controller, where, if necessary, the result returned by the command handler is taken and sent to the ViewModel. <br><br>  Schematically, the relationship between the elements, as well as how the calls between components occur, is shown in the figure: <br><br><img src="https://habrastorage.org/web/e5a/844/874/e5a8448746f549828c4be64f6467680e.png"><br><br><h3>  An example of intermodular interaction </h3><br>  The simplest and most illustrative example is the registration of a user with the sending of a letter to confirm an email address.  In this chain, two modules are worked out: User, who knows everything about users and has code that allows users to operate on user entities (including registering);  as well as the Email module, which knows how, what and to whom to send. <br><br>  The user module catches data from the registration form into its controller and saves the user to the database, after which it generates a UserRegisteredEvent ($ user) event, passing it the saved user. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RegisterCommand $command)</span></span></span><span class="hljs-function"> </span></span>{ $user = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> $command-&gt;getUser(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;validate($user); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;modify($user); $repo = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userRepository; $repo-&gt;saveAndRefresh($user); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;eventManager-&gt;triggerEvent(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserRegisteredEvent($user)); }</code> </pre><br>  From this event to this event can be subscribed from zero to several listeners in other modules.  In our example, the Email module, which generates a verification hash, sends the hash to the letter template and sends the generated email to the user.  After that, again, it generates a onfirmationEmailSentEvent ($ user) event, where the user entity to which the confirmation hash is added substitutes. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User $user)</span></span></span><span class="hljs-function"> </span></span>{ $hash = md5($user-&gt;getEmail() . <span class="hljs-string"><span class="hljs-string">'-'</span></span> . time() . <span class="hljs-string"><span class="hljs-string">'-'</span></span> . $user-&gt;getName()); $user-&gt;setConfirmHash($hash); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emailSender-&gt;send($user); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;eventManager-&gt;triggerEvent(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfirmationEmailSentEvent($user)); }</code> </pre><br>  After that, the User module will have to catch the event of sending the letter and save the confirmation hash to the database. <br><br>  On this intermodular interaction should be completed.  Yes, you often want to directly pull the code from the next module, but this will lead to the connectedness of the modules and kill at the root the possibility in the long run to bring each of the modules into a separate project. <br><br><h3>  Instead of conclusion </h3><br>  This, in fact, simple code structuring can be achieved by dividing the project into independent small parts.  A project cut into such parts is much easier to maintain than a project written in solid form. <br><br>  In addition, when developing code using this approach, it will be much easier to switch to the microservice approach.  Since  microservices will actually exist, albeit in the context of a single project.  It will only be necessary to bring each module into its own separate project and replace the Zend event bus with its own implementation, which will send events via HTTP or RabbitMQ.  But this is purely theoretical speculation and food for thought. <br><br><h2>  Bonuses for Habr's readers </h2><br>  <b>Online Courses</b> <br><br>  We give you access for a year to the English course for self-study "Online course". <br>  To access, simply follow the <a href="https://www.englishdom.com/myprofile/purchases/6habra12/%3Futm_medium%3Dblog%26utm_source%3Dhabrahabr">link</a> .  The activation period of the promotional code is until September 1, 2017. <br><br>  <b>Individually by Skype</b> <br><br>  Summer intensive English courses - we reserve the application according to the <a href="http://l.englishdom.com/lsummer/%3Futm_medium%3Dblog%26utm_source%3Dhabrahabr">link</a> . <br>  Classes are held at any time convenient for you. <br>  <b>Promo code</b> for 35% discount: <b>6habra25</b> <br>  Valid until May 22.  Enter it when paying or use the <a href="https://www.englishdom.com/myprofile/purchases/6habra25/%3Futm_medium%3Dblog%26utm_source%3Dhabrahabr">link</a> . </div><p>Source: <a href="https://habr.com/ru/post/328550/">https://habr.com/ru/post/328550/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328540/index.html">Security Week 19: Windows Defender launches someone else's code, a Trojan was in HandBrake, phishers attacked Gmail users</a></li>
<li><a href="../328542/index.html">About memory, tags and coherence</a></li>
<li><a href="../328544/index.html">Introducing 3CX V15.5 Beta</a></li>
<li><a href="../328546/index.html">Telegram of your business</a></li>
<li><a href="../328548/index.html">Get to know WannaCry</a></li>
<li><a href="../328552/index.html">Dirty game tricks</a></li>
<li><a href="../328554/index.html">Dark LinkedIn Patterns or Why You are Spammed by Friends, Encouraging You to Join LinkedIn</a></li>
<li><a href="../328556/index.html">Problems of Modern Data Science</a></li>
<li><a href="../328558/index.html">The best way to upload files to Ruby is with Shrine. Part 1</a></li>
<li><a href="../328560/index.html">Corporate telephone directory with a map</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>