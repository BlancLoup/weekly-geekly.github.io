<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Speech Recognition on STM32F4-Discovery</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to talk about how you can recognize speech on the microcontroller using the STM32F4 Discovery debug board. Since speech recogni...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Speech Recognition on STM32F4-Discovery</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/8f5/615/2c6/8f56152c657af4784ed6680aceddb96f.jpg" alt="image" align="right"><br>  In this article I want to talk about how you can recognize speech on the microcontroller using the STM32F4 Discovery debug board.  Since speech recognition is a rather complicated task even for a computer, in this case it is <b>performed using the Google service.</b>  Speech recognition in this way can be useful in different tasks, for example, in one of the ‚Äúsmart home‚Äù devices. <br><a name="habracut"></a><br>  The STM32F4-Discovery debug card differs markedly from the STM32-Discovery debug board that is often mentioned in the articles.  It is equipped with an STM32F407VGT6 microcontroller using the Cortex-M4F architecture, which has 1 MB of Flash and 192 KB of RAM.  The controller is able to work with a clock frequency of 168 MHz. <br><br>  An audio DAC with a built-in amplifier (its output is connected to the headphone jack) and a digital MEMS microphone are installed on the debug board, thanks to which, based on the STM32F4-Discovery, you can easily make a device that works with sound. <br><br>  Speech recognition using Google Voice Search is described here: <a href="http://mikepultz.com/2011/03/accessing-google-speech-api-chrome-11/">Article.</a> <br>  In order to recognize any said phrase using a microcontroller, you need to perform a number of actions: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <font color="black">‚Ä¢</font> Record sound to controller memory. <br>  <font color="black">‚Ä¢</font> Perform audio coding. <br>  <font color="black">‚Ä¢</font> Connect to the Google server. <br>  <font color="black">‚Ä¢</font> Send a POST request and encoded audio data to the server. <br>  <font color="black">‚Ä¢</font> Receive a response from the server. <br><br>  <b>Voice recording</b> <br>  Since the board already has a digital microphone, we will record the sound with it.  In this case, this is a PDM microphone.  It has only two signal outputs - clocking and data.  When a clock signal is present, a signal encoded with PDM modulation appears at the output of the microphone data (for more information, see Wikipedia: <a href="http://en.wikipedia.org/wiki/Pulse-density_modulation">Pulse-density modulation</a> ).  On the STM32F4-Discovery, the microphone is connected to SPI / I2S ‚Äî to receive data from the microphone, it is enough to configure I2S to receive data, and to receive data from the register from an I2S interrupt.  This data is stored in the memory of the controller, and after a sufficient amount of data is recorded, it is filtered, resulting in several audio data samples. <br>  Working with a microphone is described in the document AN3998 from ST - it explains the principle of operation of the microphone, the features of its connection and describes how to work with the filtering function. <br><br>  On the ST site, among the various examples for the board, there is an example of working with sound, only it is quite sophisticated - the example shows how to play the sound from the controller‚Äôs memory and from a USB flash drive connected to the board.  The sound recording on the USB flash drive is also demonstrated.  I took the code for playing and recording sound from there.  Only in this code there were a lot of errors and deficiencies - probably the example was written in a hurry. <br><br>  <b>Coding of recorded sound</b> <br>  Descriptions of working with the speech recognition service have already been cited on the Internet more than once.  In all cases, the authors use the FLAC audio codec, as Google uses non-standard Speex data encoding. <br>  This is evident from the Chromium browser code: <a href="">The code responsible for recording the sound.</a> <br>  The description of the POST request indicates that the data type is ‚Äúaudio / x-speex-with-header-byte‚Äù. <br>  That's just on the STM32 will not be able to encode the data in the format of FLAC - there are no such libraries.  But the Speex code is ported to STM32, so for encoding I used this particular codec.  From the Chromium code it is quite easy to understand what the modification of the codec is - before the beginning of each frame of the encoded audio data an additional byte is inserted, equal to the length of the frame in bytes. <br><br>  Audio is encoded and encoded at the same time ‚Äî using double buffering: while 160 audio data samples are written to one of the buffers, data from the other buffer is encoded into Speex format.  The encoded data is stored in the memory of the controller.  Record goes for 2 seconds, resulting in the formation of 2100 bytes of encoded audio data.  The sampling rate is 8 kHz. <br><br>  <b>Contacting Google</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/639/4d5/874/6394d58749c4b77adc30264f3fdc467c.jpg" alt="image" align="right"><br>  A debug board with a WIFI module - RN-XV is used to connect to the Internet.  It is equipped with a WIFI-module RN-171 (bottom of the board), an antenna, 3 diodes and pin connectors.  Communication with the module goes through the UART, so 4 wires are enough to work with it.  The cost of the board in sparkfun, from where I ordered it - $ 35.  WIFI itself - the module costs $ 30.  More information about the module can be found on the sparkfun website: <a href="http://www.sparkfun.com/products/10822">RN-XV WiFly Module.</a> <br><br>  In order to transfer data to the server, you need to connect to it via TCP, and then send a request of this type: <br><br> <code>POST http://www.google.com/speech-api/v1/recognize?xjerr=1&amp;client=chromium&amp;lang=ru-RU HTTP/1.1@#Content-type: audio/x-speex-with-header-byte; rate=8000@#Connection: close@#Content-length: 2100@#@#</code> <br> <br>  Characters @ # program replaces the CRLF.  After sending the request, you need to send 2100 bytes of encoded audio data to the server.  After receiving all the data, the server performs speech recognition, and transmits the recognized string along with additional information, after which the connection with the server is closed. <br><br>  After the server‚Äôs response is received, the program extracts the recognized string from it and outputs it via another UART microcontroller.  The data from this UART is transmitted to a computer at the terminal, in the window of which the recognized phrase appears.  After that, the controller is ready to start recording a new phrase. <br><br>  The resulting construction looks like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/110/8f1/0fe/1108f10fe2704a65e324ac489cd6bd8d.jpg" alt="image"><br><br>  And here is how it works: <br><iframe width="560" height="315" src="https://www.youtube.com/embed/nMN24wGEbM0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Update: <br><br>  Already after I posted the article, I was able to realize the launch of the recording when a loud sound (including speech) appears.  To do this, the program constantly records and encodes sound.  The encoded data is placed in an array.  After reaching its end, data begins to fit at its beginning.  At the same time, the program constantly checks whether a loud sound has appeared.  When it appears, the program saves the value of the record pointer and keeps a record for 2 seconds.  After stopping the recording, the program copies the data to another buffer.  Since it is known at what point the sound appeared, you can take the data shortly before.  Thus, the first sounds of the word are not lost. <br><br>  Video work VAD: <br><iframe width="560" height="315" src="https://www.youtube.com/embed/hjsu1DUczZA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  The program is written in IAR. <br>  The program allows you to play the recorded phrase before sending it to the server.  To do this, just uncomment some lines in the function main. <br><br>  There are several projects in the attached archive: <br>  my_audio_test - records and immediately reproduces sound from a microphone. <br>  speex_out - plays the Speex sound stored in the controller's flash memory. <br>  speex_rec - records and encodes sound with Speex for 2 seconds, then plays the recording. <br>  Speech_wifi is a speech recognition project itself, WIFI is used in this project. <br>  speech_wifi_vad is a speech recognition project with VAD, this project uses WIFI. <br><br>  <a href="">www.dropbox.com/s/xke5rq8lzi980x5/NEW_VOICE.zip?dl=0</a> </div><p>Source: <a href="https://habr.com/ru/post/146501/">https://habr.com/ru/post/146501/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../146495/index.html">Erlang decorators</a></li>
<li><a href="../146496/index.html">We write the emulator prefix P2, or a little about CHIP16</a></li>
<li><a href="../146497/index.html">Infographics - the danger of wireless networks in terms of security</a></li>
<li><a href="../146499/index.html">How to grow an IT manager in high school?</a></li>
<li><a href="../146500/index.html">What happens on the Internet in 1 minute? (infographics)</a></li>
<li><a href="../146502/index.html">Nikon Hand Strap II wrist strap as alternative to neck strap</a></li>
<li><a href="../146503/index.html">The data structure of the project OpenStreetMap, look under the skirt service</a></li>
<li><a href="../146504/index.html">Windows 8: Interface Design</a></li>
<li><a href="../146505/index.html">Video review of Asus N46 / N56 / N76 laptops</a></li>
<li><a href="../146506/index.html">Larry Page lost his voice</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>