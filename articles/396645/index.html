<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>50 shades of stub * Microchip microcontroller I / O ports</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- POIs - Peripherals Independent of the Core in Microchip microcontrollers, also known as CIP - Core Independent Peripheral. 


 The previous article ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>50 shades of stub * Microchip microcontroller I / O ports</h1><div class="post__text post__text-html js-mediator-article"><ul><li>  POIs - Peripherals Independent of the Core in Microchip microcontrollers, also known as CIP - Core Independent Peripheral. </li></ul><br><p>  The previous article [ <a href="https://geektimes.ru/post/278718/">1</a> ] (let's call it ‚Äúpart 1‚Äù of a series of articles, since I hope that there will be enough enthusiasm and strength for several articles) was devoted to the most obvious part of the Microchip Core Independent Microcontroller (MC) Core ‚Äî configurable logic cells. </p><br><p>  UPD.  here is part 3. <a href="https://geektimes.ru/post/280224/">ADC with calculator</a> </p><br><p>  Now let's look at some of the features of I / O ports and especially those that can help in the implementation of specific functions and simplify the construction of circuits using PIC microcontrollers. </p><a name="habracut"></a><br><h1>  Content </h1><br><ul><li>  Standard port functions </li><li>  Reassigning the functions of input / output ports, PPS </li><li>  control of current output driver port, CCDM </li><li>  examples of using </li><li>  reliability, self-diagnosis </li><li>  multivibrators (generators) </li><li>  sawtooth generator </li><li>  PWM modulator </li><li>  D-class amplifier </li></ul><br><h1>  Standard port functions </h1><br><p>  I / O ports can be called Peripheral Independent of the Kernel, since the port inputs are asynchronous, the state of the ports is kept in the sleeping state of the kernel.  Probably it is difficult to find unique opportunities at the ‚Äúport‚Äù periphery, but some of the ‚Äúchips‚Äù still deserve attention. </p><br><p>  Ports of modern PIC microcontrollers have a set of standard features: </p><br><ul><li>  Analog inputs <br><ul><li>  ADC inputs </li><li>  comparators inputs </li><li>  operational amplifier inputs </li><li>  voltage reference inputs </li></ul><br></li><li>  Analog outputs <br><ul><li>  OU outputs </li><li>  D / A Outputs </li><li>  voltage source outputs </li></ul><br></li><li>  Digital inputs <br><ul><li>  setting the type of input TTL or ST (trigger Schimtt) </li><li>  the possibility of including internal braces to Vdd </li><li>  voltage source outputs </li></ul><br></li><li>  Digital outputs <br><ul><li>  standard output or open drain type </li><li>  the possibility of limiting the rate of rise of the front / fall (a useful feature to reduce EMI interference) </li><li>  high output load capacity (usually, for PIC controllers, the inflowing / flowing current has an upper value of 25mA, but in some families the load capacity of a pair of port pins is increased to 50 or even 100mA) </li></ul><br></li></ul><br><h1>  Reassigning the functions of input / output ports, PPS </h1><br><p>  Among the ‚Äúnon-standard‚Äù, but very useful features, the possibility of reassigning port functions (Peripheral Pin Select, PPS) should be noted. <br>  The reassignment of port functions is interesting in that it provides the following features: </p><br><ul><li>  optimization of the PCB trace - the developer can ‚Äúdrag‚Äù certain inputs / outputs of the periphery along the controller pins </li><li>  reduction of interference (you can maximally remove high-frequency digital outputs (PWM, interfaces, etc.) from analog circuits </li><li>  the most complete use of the periphery (Microchip microcontrollers have always been famous for the abundance of peripheral modules, but due to the limited number of pins of microchips, the developer did not always manage to use the set of peripherals he needed, since different peripherals could use the same output of the microcircuit, i.e. donate something) </li><li>  increasing the load capacity of the port - the output of the periphery (UART, PWM, etc.) can be connected to several ports of the MC; these ports can be connected on the board and thereby increase the load capacity </li><li>  combining functions on one pin (for example, the same input can be connected to the UART input and the interrupt input) </li><li>  testing and debugging.  You probably already guess (or did I write about this earlier ??) that in the concept of a DEC, the periphery can be connected inside the MC and not have exits.  This is great for the final debugged device, since it minimizes the size of the MK case and the product (and hides the ability to understand the internal logic of the stub operation from competitors), but at the debugging stage it is useful to bring some of the ‚Äútest‚Äù signals through the PPS and debug the hardware. </li></ul><br><img src="https://habrastorage.org/files/855/d21/60e/855d2160e69846059a6bb57b27db69ac.png"><br><p>  Fig.1.  PPS configuration example in MPLAB X IDE development environment </p><br><h1>  Control current output port drivers </h1><br><p>  In some newer families, such as the PIC16F18855, a function hitherto unheard of in the PIC appeared - control of the output driver current, i.e.  control of flowing / flowing current (Current-Control Drive Mode, CCDM).  Now you can set what current will flow or flow into the port.  When this mode is enabled, for each output of the microcontroller, it is possible to turn on the current control, and it is possible to individually enable the monitoring of the inflowing and outflowing current. </p><br><p>  There are not so many options for the values ‚Äã‚Äãof the currents - you can choose the values ‚Äã‚Äãof 1, 2, 5 and 10 mA, in addition, the selected value will be the same for all monitored outputs. <br>  But, control of the current output port drivers gives a lot of possibilities: </p><br><ul><li>  self-diagnosis, reliability; </li><li>  reducing the number of current-limiting resistors on the board, simplifying the printed circuit board; </li><li>  reduction of radiated interference; </li><li>  possibility of forming sawtooth signals </li><li>  ... (to come up with more? ;-) </li></ul><br><p>  Best of all you can experience the possibilities of new functions of the ports with specific examples. </p><br><h1>  Examples </h1><br><h2>  Reliability, Self Diagnosis </h2><br><p>  Suppose a short circuit occurred on the board between two ports configured for output.  If one port is able to log.1, and the second to log.0, then a current will flow through the port.  With a load capacity of up to 25mA (actually up to 50mA), a large current will flow through the ports, which can lead to a port or controller failure. </p><br><p>  The current limit function can prevent damage to the port. <br>  In addition, you can organize the diagnosis of ports, the definition of load. </p><br><p>  If necessary, testing the port using similar schemes (see Figure 2).  In this case, you can give a signal to one port and consider the status of the other output port.  In principle, due to the structure of the Microchip MK ports, it is possible to test without an external resistor (send a log level to the port and read the input of the same port), but there will be no current limit on the output short-circuit. </p><br><img src="https://habrastorage.org/files/09b/a07/59a/09ba0759a3104e75ada6336edb443133.png" width="450"><br><p>  Fig.2.  Self-testing of the port MK. </p><br><p> With the port current limiting function, we can provide safe testing of the port, since the short-circuit current will be limited by the CCDM function. </p><br><img src="https://habrastorage.org/files/b7e/757/938/b7e7579386474261a9d782b18b2c9189.png" width="450"><br><p>  Fig.3.  Self test using port current limit. </p><br><p>  For example, in the program, we configure the port (RC7) to an output with current limitation, feed log.1, then read the state of the same port at the input. <br>  We can read both in digital form and with the help of an ADC, and in the second case we can determine the load resistance (since the supply voltage and the current through the port are known). </p><br><table><thead><tr><th>  digital input testing </th><th>  testing ADC </th></tr></thead><tbody><tr><td><img src="https://habrastorage.org/files/64b/4fb/053/64b4fb053cb747e0af2359b1a5a7cfe4.png"></td><td><img src="https://habrastorage.org/files/ceb/b15/5bd/cebb155bdb8c4de2927dba9f565e8750.png"></td></tr></tbody></table><br><p>  Fig.4.  Output RC7 port testing information to the terminal. </p><br><h2>  Generators </h2><br><p>  In the previous <a href="https://geektimes.ru/post/278718/">article devoted to CLC,</a> we have already considered various kinds of oscillators / multivibrators, consider how CCDM and PPS will simplify even before that simple schemes based on the PLC (CLC). </p><br><img src="https://habrastorage.org/files/c57/650/31f/c5765031f6f841b2ad743be59bb378ff.png" width="450"><br><p>  Figure 5. Multivibrator on two gates. </p><br><p>  Figure 5 shows the previously considered generator on the D trigger, the inverter and the RC chain (in this case, the circuit is slightly redrawn to display connections external to the microcontroller).  The generator frequency is determined by the parameters R and C. Resistor R sets the charge / discharge current of capacitor C. Now, if there is an integrated controller for the current port driver, we can remove the resistor and slightly simplify the circuit. </p><br><p>  <em>Note</em>  <em>Further in the figures, the output of the port with the CCDM function will be denoted as a resistor with the CCDM signature</em> </p><br><img src="https://habrastorage.org/files/45b/7d3/a82/45b7d3a8227b4fa1a347332b4e1c135c.png" width="450"><br><p>  Fig.6.  Multivibrator with limited output current port CLC2 </p><br><p>  It should be noted that it is not at all necessary for the CLC1 to use the D trigger, any variant of the non-inverting gate implementation will go. </p><br><img src="https://habrastorage.org/files/3e1/1aa/559/3e11aa559481485cbd36875b89354b6d.png" width="450"><br><p>  Fig.  7. Another version of the multivibrator on two logical gates. </p><br><p>  The ability to get rid of one resistor is not the purpose for which it would be worth considering this topic, but in this example we additionally have the following: </p><br><ul><li><p>  a decrease in the number of outputs used by the MK (yes, you remember that we have a part of the POU in the form of a PPS), that is, for the same case we can have more opportunities - to cram more into less. </p><br></li><li>  the possibility of software frequency changes!  If we change the charge / discharge current of the capacitor, then we change the rate of change of the voltage on the capacitor, which means the switching frequency of the multivibrator. </li></ul><br><img src="https://habrastorage.org/files/9a2/df5/798/9a2df5798d76402a981cd7bf1115346f.png"><br><img src="https://habrastorage.org/files/f7e/314/f58/f7e314f58cdd406683af16f500572abf.png"><br><p>  Fig.  8. Current control allows you to programmatically change the frequency of the multivibrator. </p><br><p>  In the original circuit, the microcontroller would need 3 pins, a modified circuit using PPS and CCDM only requires 2. </p><br><p>  In fact, the multivibrator can be made on one gate (Fig. 9), then the microcontroller will need only one external output.  The CLC output can be connected inside the MC to other peripherals.  On the capacitor, we will see a triangular signal, but we can make sure that a sequence of ‚Äúzeros‚Äù and ‚Äúones‚Äù is still present at the output of the CLC if the output of the same CLC is output to another ‚Äúcontrol‚Äù output of the MC using PPS. </p><br><img src="https://habrastorage.org/files/b03/e45/cce/b03e45cce7ff49608778ee05bb2b3922.png" width="450"><br><p>  Fig.9.  Multivibrator on one gate </p><br><img src="https://habrastorage.org/files/9d5/393/1fd/9d53931fd825487f8d5190aabebf2ba8.png"><br><p>  Fig.10.  The waveform on the multivibrator capacitor and the control output of the logic element. </p><br><h2>  Sawtooth generator </h2><br><p>  For the mode of control of the current driver of the port, we can set the fixation of the inflowing and flowing out current.  In the diagram in Fig.9, both currents are controlled.  If we turn on the control of the outgoing current only, we get the following picture (Fig. 11). </p><br><img src="https://habrastorage.org/files/451/efc/d78/451efcd7868d486caf7066a3006ea4db.png"><br><p>  Fig.  11. Generator sawtooth voltage. </p><br><p>  That is, in this case, the capacitor is charged with a limited current of 1mA, and discharges through the port without a current limit (note that the maximum permissible current for the port is 50mA, so a series resistor may be needed to limit the current). </p><br><p>  As you can see from the diagrams (fig. 10 and 11) on the capacitor we get a saw, the upper and lower voltage values ‚Äã‚Äãof which lie between the levels log 1 and 0 of the digital inputs. </p><br><p>  If we want to increase the amplitude, then we can additionally use two internal comparators (in part 1 we have already considered this generator circuit).  Now we will repeat this scheme, but using the output port driver current control function (CCDM), i.e.  without an external resistor and with a reduced number of enabled I / O ports. </p><br><img src="https://habrastorage.org/files/135/913/41d/13591341dfc84e69a192c9d639c76691.png" width="450"><br><p>  Fig.12.  Multivibrator with comparators. </p><br><p>  Due to the current control, we obtain a more linear sawtooth voltage generator than in the previously considered similar circuit (see [1]). <br>  As for the previous version of the multivibrator, we can change the frequency programmatically by changing the port current. </p><br><img src="https://habrastorage.org/files/d86/794/5c6/d867945c624b4569a227ec9b98024afd.png"><br><p>  Figure 13. Multivibrator output </p><br><h2>  Voltage controlled generator </h2><br><p>  If you change the reference voltage on the comparator, then we get a voltage controlled oscillator.  The support of the comparator can be changed as a built-in DAC, and served from the external circuits of the microcontroller. </p><br><img src="https://habrastorage.org/files/e1c/8e7/980/e1c8e7980f274bfdac0cd6e92ad701d6.png"><br><p>  Fig.  14. Changing the frequency of the generator by changing the reference voltage of the comparator. </p><br><p>  The multivibrator circuit on two comparators and the RS flip-flop can be slightly optimized.  Leave the lower threshold of the circuit (input R trigger) with control from the comparator, and the second from the port (S trigger input). </p><br><img src="https://habrastorage.org/files/4ee/8c4/0b6/4ee8c40b6ef84038be3ca0c0a950e91e.png" width="450"><br><p>  Fig.  15. Multivibrator version with one comparator. </p><br><p>  The released comparator, in conjunction with the saw generator built, can be used to build a PWM modulator. </p><br><h2>  PWM modulator </h2><br><p>  So, now if we apply a sawtooth-varying voltage to one input of the comparator, and a ‚Äúreference‚Äù voltage to the other, we will get a PWM modulator.  The duty cycle of the PWM will be determined by the level of the threshold voltage, and the frequency is determined by the frequency of the saw. </p><br><img src="https://habrastorage.org/files/0a6/fa7/c56/0a6fa7c5647a4220979219ab7dc13116.png" width="450"><br><p>  Fig.  16. PWM modulator of the saw generator and comparator. </p><br><img src="https://habrastorage.org/files/9bd/e42/011/9bde4201133446a2900f4764e558bdd7.png"><br><p>  Fig.  17. Diagram at the output of the PWM modulator. </p><br><h2>  D-Class Amplifier </h2><br><p>  The frequency of the saw considered generators is determined by the capacitance C and the current port.  We can form a saw with a frequency of hundreds of kilohertz. <br>  The reference signal can be both external and be formed, for example, a built-in DAC.  If the reference signal comes from a sound source, then we have very little left to build a Class D amplifier. </p><br><p>  Microcontrollers of the PIC16F188xx series have a Complementary Waveform Generator (CWG) module, which can generate bridge control signals from the input signal. </p><br><img src="https://habrastorage.org/files/4d6/b2c/fa2/4d6b2cfa27f64b1f889cf02b4896b5f2.png"><br><p>  Fig.  18. Diagram of a class D amplifier on a microcontroller using CIP. </p><br><img src="https://habrastorage.org/files/ce8/440/2e5/ce84402e57094f5dbdba1c17042c5f07.png"><br><p>  Fig.  19. Diagram of amplifier signals. </p><br><p>  So, from such parts of the PSI as a port with CCDM Output Current Control, Configurable Logic CLC Cells, Comparators, DACs, CWG Complementary Shaper, we got a class D amplifier. </p><br><h1>  Results </h1><br><p>  We looked at another part of the Peripheral Independent of the Core ‚Äî the I / O ports of the Microchip microcontrollers.  Most features, including reassignment of pin functions, are present in many PIC16F1xxx families, but a new ‚Äúfeature‚Äù - CCDM (current control of the output port driver), appeared quite recently in the PIC16F188xx family (PIC16F18855, etc.). </p><br><p>  Independence from the core is that we only need to initialize the necessary capabilities (PPS, CCDM, etc.), the rest of the operation does not depend on the clock frequency and the state of the MK core (Run, Sleep, Idle or Doze).  But in the process of work, we, nevertheless, have the opportunity to change the functioning of such a periphery. </p><br><p>  The periphery independent of the core is interesting in and of itself, but the possibility of synthesizing functional blocks, i.e.  sharing of several peripheral modules for solving specific tasks.  In this case, the clock frequency, speed, and bit depth of the core go into the background - the hardware performs specialized functions, and the core deals with software support for the product. </p><br><h1>  Literature: </h1><br><ol><li>  Configurable Logic Cells in PIC Controllers.  <a href="https://geektimes.ru/post/278718/">https://geektimes.ru/post/278718/</a> </li><li>  PIC16 (L) F18855 / 75 Data Sheet.  www.microchip.com </li><li>  TB3140.  Programmable Ramp Generator Technical Brief.  www.microchip.com </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/396645/">https://habr.com/ru/post/396645/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../396631/index.html">In China, launched a bus portal - and he was fake</a></li>
<li><a href="../396633/index.html">Seagate has introduced a new 60 TB SSD</a></li>
<li><a href="../396635/index.html">We manage NooLite devices from Zyxel Keenetic router</a></li>
<li><a href="../396637/index.html">Invented a very useful "acoustic prism"</a></li>
<li><a href="../396641/index.html">Another smart home, in several parts. Weather station from scrap materials</a></li>
<li><a href="../396647/index.html">FAS fined Google 438 million rubles</a></li>
<li><a href="../396649/index.html">Bitfinex bitcoin-exchange hacked and brought about $ 65 million in equivalent</a></li>
<li><a href="../396651/index.html">Look into the future to understand the past.</a></li>
<li><a href="../396653/index.html">IRotary project</a></li>
<li><a href="../396655/index.html">Study: level of physical activity should be five to seven times higher than what WHO recommends.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>