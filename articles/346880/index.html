<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flask Mega-Tutorial, Part 7: Error Handling (Edition 2018)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="blog.miguelgrinberg.com 
 Miguel grinberg 



 <<< previous next >>> 


 This article is a translation of the seventh part of the new edition of Migue...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flask Mega-Tutorial, Part 7: Error Handling (Edition 2018)</h1><div class="post__text post__text-html js-mediator-article"><p>  <a href="http://blog.miguelgrinberg.com/" title="blog.miguelgrinberg.com">blog.miguelgrinberg.com</a> </p><br><h3 id="miguel-grinberg">  <em>Miguel grinberg</em> </h3><br><hr><br><p>  <a href="https://habrahabr.ru/post/346348/">&lt;&lt;&lt; previous</a> <a href="https://habrahabr.ru/post/347450/">next &gt;&gt;&gt;</a> </p><br><p>  This article is a translation of the seventh part of the new edition of Miguel Greenberg‚Äôs textbook, the issue of which the author plans to complete in May 2018. <a href="https://habrahabr.ru/post/193242/" title="Previous translation">The previous translation</a> has long lost its relevance. </p><br><p>  I, for my part, will try to keep up with the translation. </p><br><hr><br><p>  This is the seventh chapter of the Mask-Tutorial series, in which I will tell you how to handle error handling in the Flask application. </p><a name="habracut"></a><br><p>  For reference, below is a list of articles in this series. </p><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text"><ul><li>  <a href="https://habrahabr.ru/post/346306/"><strong>Chapter 1: Hello world!</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346340/"><strong>Chapter 2: Templates</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346342/"><strong>Chapter 3: Web Forms</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346344/"><strong>Chapter 4: Database</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346346/"><strong>Chapter 5: User Logins</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346348/"><strong>Chapter 6: Profile Page and Avatars</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346880/"><strong>Chapter 7: Error Handling (This article)</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347450/"><strong>Chapter 8: Subscribers, Contacts, and Friends</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347926/"><strong>Chapter 9: Pagination</strong></a> </li><li>  <a href="https://habrahabr.ru/post/348566/"><strong>Chapter 10: Email Support</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349060/"><strong>Chapter 11: Reconstruction</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349604/"><strong>Chapter 12: Date and Time</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350148/"><strong>Chapter 13: I18n and L10n</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350626/"><strong>Chapter 14: Ajax</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351218/"><strong>Chapter 15: Improving Application Structure</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351900/"><strong>Chapter 16: Full Text Search</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352266/"><strong>Chapter 17: Deploying to Linux</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352830/"><strong>Chapter 18: Deploying to Heroku</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353234/"><strong>Chapter 19: Deploying to Docker Containers</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353804/"><strong>Chapter 20: JavaScript Magic</strong></a> </li><li>  <a href="https://habrahabr.ru/post/354322/"><strong>Chapter 21: User Notifications</strong></a> </li><li>  <a href="https://habrahabr.ru/post/354752/"><strong>Chapter 22: Background Tasks</strong></a> </li><li>  <a href="https://habrahabr.ru/post/358152/"><strong>Chapter 23: Application Programming Interfaces (APIs)</strong></a> </li></ul></div></div><br><p>  <em>Note 1: If you are looking for old versions of this course, this is <a href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world-legacy" title="here">here</a> .</em> </p><br><p>  <em>Note 2: If suddenly you would like to speak in support of my (Miguel) work on this blog, or simply do not have the patience to wait for a week of the article, I (Miguel Greenberg) offer a full version of this guide a packed e-book or video.</em>  <em>For more information, visit <a href="http://learn.miguelgrinberg.com/" title="learn.miguelgrinberg.com">learn.miguelgrinberg.com</a> .</em> </p><br><p>  In this chapter, I move from coding new features to my microblogging application and instead discuss several strategies for dealing with errors that invariably appear in any software project.  To illustrate this topic, I intentionally made a mistake in the code I added in <strong>Chapter 6</strong> .  Before you continue reading, see if you can find it! </p><br><p>  <em>GitHub links for this chapter:</em> <a href="">Browse</a> , <a href="">Zip</a> , <a href="">Diff</a> . </p><br><h1 id="obrabotka-oshibok-v-flask">  Error handling in Flask </h1><br><p>  What happens when an error occurs in the Flask application?  The best way to find out is to experience it yourself.  Run the application and make sure you have at least two registered users.  Log in as one of the users, open the profile page and click the "Edit" link.  In the profile editor, try changing the username to the existing name of another user who is already registered, and try to apply the fix!  This will lead to the terrible "Internal Server Error" page: </p><br><p><img src="https://habrastorage.org/webt/fe/97/5r/fe975roz261ahsmvdhboliipg4s.png"></p><br><p>  In the terminal session on which the application is running, you see the error stack trace.  Stack traces are extremely useful for debugging errors, since they show the sequence of calls in this stack, down to the line that caused the error: </p><br><pre><code class="hljs pgsql">(venv) $ flask run * Serving Flask app "microblog" * Running <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> http://<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">5000</span></span>/ (Press CTRL+C <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> quit) [<span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span><span class="hljs-number"><span class="hljs-number">-14</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>,<span class="hljs-number"><span class="hljs-number">027</span></span>] ERROR <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> app: <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> /edit_profile [POST] Traceback (most recent <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> last): File "/home/miguel/microblog/venv/lib/python3.6/site-packages/sqlalchemy/engine/base.py", <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">1182</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _execute_context context) File "/home/miguel/microblog/venv/lib/python3.6/site-packages/sqlalchemy/engine/default.py", <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">470</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> do_execute <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">statement</span></span>, parameters) sqlite3.IntegrityError: <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> failed: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.username</code> </pre> <br><p>  The stack trace indicates what caused the error.  The application allows the user to change the username without verifying that the new username does not match another user already in the system.  The error arises from SQLAlchemy, which attempts to write a new username to the database, but the database rejects it, because the username column is defined with unique = True. </p><br><p>  It is important that the error page presented to the user does not contain much information about the error, and this is correct.  I definitely do not want users to know that the crash was caused by a database error or which database I use, as well as the names of the tables and fields in my database.  All this information must be internal. </p><br><p>  There are several things that are far from ideal.  I have a page with an error that is ugly and does not correspond to the layout of the application.  I also have important traces of the stack of applications that are dumped on the terminal, and I need to constantly make sure that I do not miss any errors.  And, of course, I have a mistake.  I'm going to solve all these problems, but first we‚Äôll talk about the Flask debug mode. </p><br><h2 id="rezhim-otladki">  Debug mode </h2><br><p>  The way errors are processed above is great for a system that runs on a production server.  If there is an error, the user gets a page with an undefined error (although I'm going to make this error page more enjoyable), and the important error data is in the server output or in the log file. </p><br><p>  But when you develop an application, you can turn on debug mode, a mode in which Flask displays a really good debugger directly to your browser.  To activate debug mode, stop the application, and then set the following environment variable: </p><br><pre> <code class="hljs objectivec">(venv) $ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> FLASK_DEBUG=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  If you are running Microsoft Windows, remember to use <code>set</code> instead of exporting. </p><br><p>  After you have installed FLASK_DEBUG, restart the server.  The lines on your terminal will be slightly different from what you are used to seeing: </p><br><pre> <code class="hljs pgsql">(venv) microblog2 $ flask run * Serving Flask app "microblog" * Forcing <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> mode <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> * Running <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> http://<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">5000</span></span>/ (Press CTRL+C <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> quit) * Restarting <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> stat * Debugger <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> active! * Debugger PIN: <span class="hljs-number"><span class="hljs-number">177</span></span><span class="hljs-number"><span class="hljs-number">-562</span></span><span class="hljs-number"><span class="hljs-number">-960</span></span></code> </pre> <br><p>  Now let the application crash again to see the interactive debugger in your browser: </p><br><p><img src="https://habrastorage.org/webt/64/ec/um/64ecumjr_lxgo9dlmsectaksb1g.png"></p><br><p>  The debugger allows you to deploy each level of the stack and see the corresponding source code.  You can also open Python for any of the frames and execute any valid Python expressions, for example, to check the values ‚Äã‚Äãof variables. </p><br><p>  It is imperative that you never run the Flask application in debug mode on a production server.  The debugger allows you to remotely execute code on the server, so it can be an unexpected gift to an attacker who wants to penetrate your application or your server.  As an additional security measure, the debugger running in the browser will close, and when first used, it will request a PIN code, which you can see at the output of the <code>flask run</code> command. </p><br><p>  Since I'm talking about debug mode, I should mention the second important feature that is enabled in debug mode - reboot.  This is a very useful development feature that automatically restarts the application when the source file changes.  If you run <code>flask run</code> in debug mode, you can continue to work in your application and each time you save the file, the application will restart to pick up the new code. </p><br><h2 id="polzovatelskie-stranicy-oshibok">  Custom error pages </h2><br><p>  Flask provides an application mechanism for creating custom error pages, so your users do not need to see simple and boring defaults.  As an example, let's define custom error pages for HTTP errors 404 and 500, the two most common.  Defining pages for other errors works the same way. </p><br><p>  To declare a custom error handler, use the <code>@errorhandler</code> decorator.  I'm going to put the error handlers in the new <em>app / errors.py module</em> . </p><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> render_template <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app, db @app.errorhandler(<span class="hljs-number"><span class="hljs-number">404</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">not_found_error</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template(<span class="hljs-string"><span class="hljs-string">'404.html'</span></span>), <span class="hljs-number"><span class="hljs-number">404</span></span> @app.errorhandler(<span class="hljs-number"><span class="hljs-number">500</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">internal_error</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span><span class="hljs-function">:</span></span> db.session.rollback() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template(<span class="hljs-string"><span class="hljs-string">'500.html'</span></span>), <span class="hljs-number"><span class="hljs-number">500</span></span></code> </pre> <br><p>  Error functions work like browsing functions.  For these two errors, I return the contents of their respective templates.  Note that both functions return the second value after the pattern, which is the error code number.  For all the presentation functions that I have created so far, I did not need to add a second return value, because by default 200 (the status code for successful completion) is what I wanted.  Now these are error pages, so I want the response status code to reflect this. </p><br><p>  The error handler for the 500th error can be triggered after a database failure has occurred, which was actually caused by an intentional duplicate username.  To ensure that failed database sessions do not interfere with database access caused by the template, I issue a session rollback.  This resets the session to a clean state. </p><br><p>  Here is the template for 404 error: </p><br><pre> <code class="hljs django"><span class="xml"></span><span class="hljs-template-tag"><span class="xml"></span><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">extends</span></span></span></span></span><span class="hljs-template-tag"> "base.html" %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> content %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">File Not Found</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('index') }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Back</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre> <br><p>  And here is one of the 500 errors: </p><br><pre> <code class="hljs django"><span class="xml"></span><span class="hljs-template-tag"><span class="xml"></span><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">extends</span></span></span></span></span><span class="hljs-template-tag"> "base.html" %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> content %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">An unexpected error has occurred</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">The administrator has been notified. Sorry for the inconvenience!</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('index') }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Back</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre> <br><p>  Both templates inherit the <code>base.html</code> template, so the error page has the same look and feel as regular application pages. </p><br><p>  To get these error handlers registered in Flask, I need to import the new <code>app/errors.py</code> after creating an application instance: </p><br><pre> <code class="hljs swift"># ... from app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> routes, models, errors</code> </pre> <br><p>  If you set <code>FLASK_DEBUG = 0</code> in a terminal session and then again caused a duplicate username error, you will see a more pleasant error page. </p><br><p><img src="https://habrastorage.org/webt/ea/cn/vn/eacnvnhobuzutlix1tkqjznxl18.png"></p><br><p>  <em>Or so!</em>  <em>I recommend to come up with something of their own as an exercise.</em> </p><br><p><img src="https://habrastorage.org/webt/er/xx/3s/erxx3s-jcfrlcja1_vqbfq59yu4.png"></p><br><h2 id="otpravka-oshibok-po-elektronnoy-pochte">  Emailing bugs </h2><br><p>  Another problem with the default error handling provided by Flask is that there are no notifications!  The error stack trace is printed on the terminal, which means that the output of the server process should be monitored for error detection.  When you launch an application during development, this is normal, but once the application is deployed on a production server, no one will look at the result, so you need to create a more reliable solution. </p><br><p>  I think it is very important that I actively respond to errors.  If an error occurs in the production version of the application, I want to know right away.  Thus, my first solution would be to configure Flask to send me an email right after an error occurred with a trace of the error stack in the email. </p><br><p>  The first step is to add the email server data to the configuration file: </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): # ... MAIL_SERVER = os.environ.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'MAIL_SERVER'</span></span>) MAIL_PORT = int(os.environ.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'MAIL_PORT'</span></span>) or <span class="hljs-number"><span class="hljs-number">25</span></span>) MAIL_USE_TLS = os.environ.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'MAIL_USE_TLS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> not None MAIL_USERNAME = os.environ.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'MAIL_USERNAME'</span></span>) MAIL_PASSWORD = os.environ.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'MAIL_PASSWORD'</span></span>) ADMINS = [<span class="hljs-string"><span class="hljs-string">'your-email@example.com'</span></span>]</code> </pre> <br><p>  The configuration variables for email contain the server and port, a flag to enable encrypted connections, and an optional username and password.  Five configuration variables are derived from their mappings to environment variables.  If the email server is not installed in the environment, then I will use this as a sign that email errors should be turned off.  The e-mail server port can also be specified in the environment variable, but if it is not set, the standard port 25 is used. The default credentials of the mail server are not used, but can be provided if necessary.  The <code>ADMINS</code> configuration <code>ADMINS</code> is a list of email addresses that will receive error reports, so your own email address should be on this list. </p><br><p>  Flask uses the <code>logging</code> Python package to maintain its logs, and this package already has the ability to send logs by e-mail.  All I need to do to send emails that contain errors is to add an instance of <a href="https://docs.python.org/3.6/library/logging.handlers.html">SMTPHandler</a> to the Flask log object, which is <code>app.logger</code> : </p><br><pre> <code class="hljs lua">import logging from logging.handlers import SMTPHandler # ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> app.<span class="hljs-built_in"><span class="hljs-built_in">debug</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> app.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>[<span class="hljs-string"><span class="hljs-string">'MAIL_SERVER'</span></span>]: auth = None <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> app.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>[<span class="hljs-string"><span class="hljs-string">'MAIL_USERNAME'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> app.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>[<span class="hljs-string"><span class="hljs-string">'MAIL_PASSWORD'</span></span>]: auth = (app.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>[<span class="hljs-string"><span class="hljs-string">'MAIL_USERNAME'</span></span>], app.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>[<span class="hljs-string"><span class="hljs-string">'MAIL_PASSWORD'</span></span>]) secure = None <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> app.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>[<span class="hljs-string"><span class="hljs-string">'MAIL_USE_TLS'</span></span>]: secure = () mail_handler = SMTPHandler( mailhost=(app.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>[<span class="hljs-string"><span class="hljs-string">'MAIL_SERVER'</span></span>], app.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>[<span class="hljs-string"><span class="hljs-string">'MAIL_PORT'</span></span>]), fromaddr=<span class="hljs-string"><span class="hljs-string">'no-reply@'</span></span> + app.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>[<span class="hljs-string"><span class="hljs-string">'MAIL_SERVER'</span></span>], toaddrs=app.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>[<span class="hljs-string"><span class="hljs-string">'ADMINS'</span></span>], subject=<span class="hljs-string"><span class="hljs-string">'Microblog Failure'</span></span>, credentials=auth, secure=secure) mail_handler.setLevel(logging.ERROR) app.logger.addHandler(mail_handler)</code> </pre> <br><p>  As you can see, I turned on the email recorder only when the application is running without debug mode, which is defined by app in <code>app.debug</code> as <code>True</code> , and also when the email server exists in the configuration. </p><br><p>  Setting up a mail logger is somewhat tedious because of the need to handle advanced security settings that are present on many email servers.  But in essence, the above code creates an instance of <code>SMTPHandler</code> , sets its level so that it sends only error messages, not warnings, informational or debugging messages, and finally attached them to the <code>app.logger</code> from Flask. </p><br><p>  There are two approaches to testing the functionality of this function.  The easiest way is to use the debug SMTP server from Python.  This is a fake mail server that accepts emails, but instead of sending them, displays them to the console.  To start this server, open a second terminal session and run the following command on it: </p><br><pre> <code class="hljs swift">(venv) $ python -m smtpd -n -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-type"><span class="hljs-type">DebuggingServer</span></span> localhost:<span class="hljs-number"><span class="hljs-number">8025</span></span></code> </pre> <br><p>  Leave the debug SMTP server running and go back to your first terminal and set <code>export</code> <code>MAIL_SERVER = localhost</code> and <code>MAIL_PORT = 8025</code> (use <code>set</code> instead of <code>export</code> if you are using Microsoft Windows).  Make sure that the <code>FLASK_DEBUG</code> variable <code>FLASK_DEBUG</code> set to <code>0</code> or not set at all, as the application will not send emails in debug mode. <br>  Run the application and call the SQLAlchemy error again to find out how a terminal session on which a fake mail server is running shows an email with the full contents of the error stack. </p><br><p>  The second testing method for this feature is to configure a real mail server.  The following is the configuration for using the mail server for a <em>Gmail account</em> : </p><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_SERVER=smtp.googlemail.com <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_PORT=<span class="hljs-number"><span class="hljs-number">587</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_USE_TLS=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_USERNAME=&lt;your-gmail-username&gt; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_PASSWORD=&lt;your-gmail-password&gt;</code> </pre> <br><p>  If you are using Microsoft Windows, do not forget to use <code>set</code> instead of <code>export</code> in each of the instructions above. </p><br><p>  The security features of your Gmail account can prevent an application from sending email through it unless you explicitly allow less secure apps (‚Äúless secure applications‚Äù) access to your Gmail account.  You can read about it <a href="https://support.google.com/accounts/answer/6010255%3Fhl%3Den">here</a> , and if you are concerned about the security of your account, you can create a secondary account that you set up to check email only, or temporarily turn on the permission for less secure applications while this test is running, then return to default. </p><br><h2 id="zapis-loga-v-fayl">  Write log to file </h2><br><p>  Getting e-mail errors is useful, but sometimes not enough.  There are some failures that are not described by the exception of Python and are not a serious problem, but they can still be interesting enough to be saved for debugging purposes.  For this reason, I will also support the log file for the application. </p><br><p>  To enable the logging of another handler, this time the <code>RotatingFileHandler</code> type needs to enable the application logger in the same way as the email handler. </p><br><pre> <code class="hljs lua"># ... from logging.handlers import RotatingFileHandler import <span class="hljs-built_in"><span class="hljs-built_in">os</span></span> # ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> app.<span class="hljs-built_in"><span class="hljs-built_in">debug</span></span>: # ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>.exists(<span class="hljs-string"><span class="hljs-string">'logs'</span></span>): <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.mkdir(<span class="hljs-string"><span class="hljs-string">'logs'</span></span>) file_handler = RotatingFileHandler(<span class="hljs-string"><span class="hljs-string">'logs/microblog.log'</span></span>, maxBytes=<span class="hljs-number"><span class="hljs-number">10240</span></span>, backupCount=<span class="hljs-number"><span class="hljs-number">10</span></span>) file_handler.setFormatter(logging.Formatter( <span class="hljs-string"><span class="hljs-string">'%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'</span></span>)) file_handler.setLevel(logging.INFO) app.logger.addHandler(file_handler) app.logger.setLevel(logging.INFO) app.logger.info(<span class="hljs-string"><span class="hljs-string">'Microblog startup'</span></span>)</code> </pre> <br><p>  I am writing a log file called <code>microblog.log</code> in the <em>logs</em> directory, which I create if it does not already exist. </p><br><p>  The <code>RotatingFileHandler</code> class is convenient because it rewrites the logs, ensuring that the log files are not too large if the application has been running for a long time.  In this case, I limit the size of the log file to 10 KB and store the last ten log files as backup copies. </p><br><p>  The <code>logging.Formatter</code> class provides customization of the log message format.  Since these messages are sent to a file, I want them to contain as much information as possible.  So I use a format that includes a time stamp, a logging level, <br>  the message, the source file, and the line number from which the journal entry originated. </p><br><p>  To make the registration more useful, I also lower the logging level to the <code>INFO</code> category, both in the application registrar and in the file handler.  If you are not familiar with the categories of logging, this is <code>DEBUG</code> , <code>INFO</code> , <code>WARNING</code> , <code>ERROR</code> and <code>CRITICAL</code> in order of increasing severity. </p><br><p>  As the first useful use of a log file, the server writes a string to the log each time it is started.  When the application is launched on the production server, these log entries tell you when the server was restarted. </p><br><h2 id="ispravlenie-dublya-imeni-polzovatelya">  Fix doubled username </h2><br><p>  I have been using the username duplication error for too long.  Now that I have shown you how to prepare an application to handle such errors, I can finally fix it. </p><br><p>  If you remember, the <code>RegistrationForm</code> already checks for usernames, but the requirements of the editing form are slightly different.  During registration, I need to make sure that the username entered on the form does not exist in the database.  In the form of an editing profile, I have to perform the same check, but with one exception.  If the user leaves the original username intact, then the check should resolve it, since this username has already been assigned to that user.  Below you can see how I verified the username for this form: </p><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EditProfileForm</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FlaskForm</span></span></span><span class="hljs-class">): username = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">StringField</span></span></span><span class="hljs-class">('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Username</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validators</span></span></span><span class="hljs-class">=[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataRequired</span></span></span><span class="hljs-class">()]) about_me = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextAreaField</span></span></span><span class="hljs-class">('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">About</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">me'</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validators</span></span></span><span class="hljs-class">=[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class">=0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class">=140)]) submit = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SubmitField</span></span></span><span class="hljs-class">('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Submit</span></span></span><span class="hljs-class">') def __init__(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">original_username</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">, **</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kwargs</span></span></span><span class="hljs-class">): super(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EditProfileForm</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">).__init__(*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">, **</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kwargs</span></span></span><span class="hljs-class">) self.original_username = original_username def validate_username(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class">): if username.data != self.original_username: user = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class">.query.filter_by(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">).first() if user is not </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">None</span></span></span><span class="hljs-class">: raise </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ValidationError</span></span></span><span class="hljs-class">('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Please</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">use</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">different</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class">.')</span></span></code> </pre> <br><p>  The implementation is performed in a special test method, the super function in the class constructor, which takes the original user name as an argument.  This username is stored as an instance variable and verified in the <code>validate_username()</code> method.  If the username entered in the form matches the original username, there is no reason to check the database for duplicates. </p><br><p>  To use this new validation method, I need to add the original username argument to the function of the form where the form object is created: </p><br><pre> <code class="hljs ruby">@app.route(<span class="hljs-string"><span class="hljs-string">'/edit_profile'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) @login_required <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edit_profile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: form = EditProfileForm(current_user.username) <span class="hljs-comment"><span class="hljs-comment"># ...</span></span></code> </pre> <br><p>  Now the error has been fixed, and duplicates in the form of an editing profile will be prevented in most cases.  This is not an ideal solution, as it may not work when two or more processes simultaneously access the database.  In this situation <em>, the race condition</em> may lead to validation, but after a moment when you try to rename, the database has already been changed by another process and cannot rename the user.  This is somewhat unlikely, with the exception of very busy applications that have a lot of server processes, so I won‚Äôt worry about it yet. </p><br><p>  At this point, you can try to reproduce the error again to see how the form validation method prevents it. </p><br><p>  <a href="https://habrahabr.ru/post/346348/">&lt;&lt;&lt; previous</a> <a href="https://habrahabr.ru/post/347450/">next &gt;&gt;&gt;</a> </p><br><p>  PS </p><br><h2 id="rabota-nad-oshibkami">  Bug work </h2><br><p>  <em>From translator</em> </p><br><p>  I decided to check the receipt of error messages to the admin by mail.  For this, I have corrupted the <code>routes.py</code> module.  For this very ‚Äúcorruption‚Äù, I commented out the <code>@app.route('/edit_profile', methods=['GET', 'POST'])</code> decorator <code>@app.route('/edit_profile', methods=['GET', 'POST'])</code> before <code>def edit_profile()</code> .  As a result, I received an error and it all fell out in the log file, but the letter did not arrive.  I am using Python 3.3.  Perhaps in newer versions of this and not happen.  But in Windows 7 with the Russian layout, this happened. </p><br><p>  When I tried to send a message to the admin, the application received an encoding error while generating the message.  The console window contained the following lines: </p><br><p><img src="https://habrastorage.org/webt/pb/xi/wy/pbxiwyup8n2sa1-rhrpqfaordps.png"></p><br><p>  As you can see, the link points to the directory in the standard python, and not in the virtual environment. </p><br><p>  <code>logging</code> in version 3 is the standard Python library, so you do not need to install it using <code>pip</code> . </p><br><div class="spoiler">  <b class="spoiler_title">About standard modules</b> <div class="spoiler_text"><p>  And the logging module, which you can find in PyPI, is outdated, not Python3 compliant. </p><br><p>  (According to the README file, its latest version was released on March 2, 2005.) </p><br><p>  So just do not try to install logging. <br>  Take the new module in the standard library for granted.  If you need to use it in the virtual library. </p><br><p>  After the copy in <em>venv \ Lib</em> <code>logging</code> imported from the virtual environment </p><br><p><img src="https://habrastorage.org/webt/jz/ar/fc/jzarfczhqicy7f6mke2skzqdumo.png"></p><br><p>  I get an error again </p><br><p><img src="https://habrastorage.org/webt/x_/q0/k3/x_q0k3zhdps1-saypzabsa_n-nw.png"></p><br><p>  <code>logging</code> now virtual.  But <code>smtplib</code> standard. </p><br><p>  I do not think that it is necessary to drag all the libraries from the standard environment to the virtual one. <br>  Error from this will not disappear. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">About standard email module</b> <div class="spoiler_text"><p>  The problem with the encoding in the message is solved by using the standard <code>email</code> package to create a message indicating the preferred encoding. </p><br><p>  Here is <a href="http://python.su/forum/topic/6076/">an example</a> from the Internet for this package: </p><br><pre> <code class="hljs pgsql"># -*- coding: utf<span class="hljs-number"><span class="hljs-number">-8</span></span> -*- <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> email.mime.multipart <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MIMEMultipart <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> email.mime.text <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MIMEText <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> quopri def QuoHead(String): s = quopri.encodestring(String.encode(<span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> "=?utf-8?Q?" + s.decode(<span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>) + "?=" FIOin = " " emailout = "some@test.ru" emailin = "some2@test.ru" msg = MIMEMultipart() msg["Subject"] = QuoHead("  " + FIOin).replace(<span class="hljs-string"><span class="hljs-string">'=\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) msg["From"] = (QuoHead(" ") + " &lt;" + emailout + "&gt;").replace(<span class="hljs-string"><span class="hljs-string">'=\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) msg["To"] = (QuoHead(FIOin) + " &lt;" + emailin + "&gt;").replace(<span class="hljs-string"><span class="hljs-string">'=\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) m = """ .   . ,    .""" <span class="hljs-type"><span class="hljs-type">text</span></span> = MIMEText(m.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>), <span class="hljs-string"><span class="hljs-string">'plain'</span></span>, <span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>) msg.attach(<span class="hljs-type"><span class="hljs-type">text</span></span>) print(msg.as_string())</code> </pre> <br><p>  But, how to apply it to send error messages? <br>  Maybe someone will offer in the comments to the article. </p></div></div><br><p>  In the <code>flask-mail</code> module, this situation is kind of <a href="https://github.com/mattupstate/flask-mail/pull/85/commits/868e31590420a8e8d4b197cd2204d5d37140f370">fixed</a> .  But <code>logging</code> and <code>smtplib</code> are used here <code>smtplib</code> </p><br><p>  In the end, <strong>so far</strong> .  I corrected a line in the <code>smtplib.py</code> module. </p><br><p>  Added <code>encode('utf-8')</code> </p><br><p><img src="https://habrastorage.org/webt/bz/7v/yg/bz7vygxmlekgbi4de4e-ccgevby.png"></p><br><p>        ,  ,    . </p><br><p><img src="https://habrastorage.org/webt/jv/sz/qf/jvszqf-qylgybeec2iqg2kbbfzu.png"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346880/">https://habr.com/ru/post/346880/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346868/index.html">One-cloud - OS-level data center in Odnoklassniki</a></li>
<li><a href="../346870/index.html">How to replace the restaurant director with a robot?</a></li>
<li><a href="../346872/index.html">Things that cause mistrust and alienate your customers from the site</a></li>
<li><a href="../346876/index.html">How to take notes as a programmer</a></li>
<li><a href="../346878/index.html">Which diagram to use?</a></li>
<li><a href="../346882/index.html">Autopilot simulation on a flight simulator</a></li>
<li><a href="../346884/index.html">How we chose between Elastic and Tarantool, and made our (fastest) in-memory database. With Join and Full-Text Search</a></li>
<li><a href="../346888/index.html">Azure ML Workbench: Getting Started</a></li>
<li><a href="../346890/index.html">Writing code in the docker environment</a></li>
<li><a href="../346892/index.html">Lua. Brief introduction to metatables for dummies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>