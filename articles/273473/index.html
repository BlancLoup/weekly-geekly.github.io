<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PowerShell, AWS CLI and json</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When working with the Amazon cloud, it is often necessary to perform many routine operations through the Web console. But I want to automate them. 
 A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PowerShell, AWS CLI and json</h1><div class="post__text post__text-html js-mediator-article">  When working with the Amazon cloud, it is often necessary to perform many routine operations through the Web console.  But I want to automate them. <br>  AWS CLI, a command line interface, is good for this.  Of course, you can write an application on Scala, but in everyday tasks it is better to go without ‚Äúheavy artillery‚Äù. <br>  AWS teams can return data in various formats, including json.  You can use bash and <a href="https://stedolan.github.io/jq/">jq</a> , but the latter is not in the cygwin repository, and install laziness with your hands.  Meanwhile, PowerShell has great json support!  True, it turned out that taking advantage of it was not entirely easy. <a name="habracut"></a><br><pre><code class="hljs mel">C:\Users\mpotanin&gt; $instance = aws ec2 describe-instances --<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>-ids i-ecf1fe5c C:\Users\...&gt; ConvertFrom-Json $instance ConvertFrom-Json : Cannot convert <span class="hljs-string"><span class="hljs-string">'System.Object[]'</span></span> to the type <span class="hljs-string"><span class="hljs-string">'System.String'</span></span> required by parameter <span class="hljs-string"><span class="hljs-string">'InputObject'</span></span>.    . At line:<span class="hljs-number"><span class="hljs-number">1</span></span> char:<span class="hljs-number"><span class="hljs-number">19</span></span> + ConvertFrom-Json $instance + ~~~~~~~~~ + CategoryInfo : InvalidArgument: (:) [ConvertFrom-Json], ParameterBindingException + FullyQualifiedErrorId : CannotConvertArgument,Microsoft.PowerShell.Commands.ConvertFromJsonCommand</code> </pre> <br>  The fact is that json is issued in the form of several lines, and is treated as an array.  You can feed him in PowerShell in different ways: <br><pre> <code class="hljs perl">$instance | ConvertFrom-Json ConvertFrom-Json ($instance -<span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>) ConvertFrom-Json <span class="hljs-string"><span class="hljs-string">"$instance"</span></span></code> </pre><br>  Getting the right information is now not difficult: <br><pre> <code class="hljs sql">(aws ec2 <span class="hljs-keyword"><span class="hljs-keyword">describe</span></span>-instances <span class="hljs-comment"><span class="hljs-comment">--instance-ids i-ecf1fe5c | ConvertFrom-Json).Reservations[0].Instances[0].PublicIpAddress</span></span></code> </pre><br>  In simple cases, retrieving information can be reassigned to aws: <br><pre> <code class="hljs matlab">aws ec2 describe-instances --instance-ids <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>-ecf1fe5c --query <span class="hljs-string"><span class="hljs-string">'Reservations[0].Instances[0].PublicIpAddress'</span></span> | ConvertFrom-Json</code> </pre><br>  or even so <br><pre> <code class="hljs mel">aws ec2 describe-instances --<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>-ids i-ecf1fe5c --query <span class="hljs-string"><span class="hljs-string">'Reservations[0].Instances[0].PublicIpAddress'</span></span> --output=<span class="hljs-keyword"><span class="hljs-keyword">text</span></span></code> </pre><br>  So, watching the strange behavior of the autoscaling group through the console, I can copy the instance name with the mouse and access it via ssh: <br><pre> <code class="hljs matlab"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">address</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([String]$instanceId)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aws</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ec2</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">describe</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instances</span></span></span><span class="hljs-function"> --</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instance</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ids</span></span></span><span class="hljs-function"> $</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instanceId</span></span></span><span class="hljs-function"> --</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">query</span></span></span><span class="hljs-function"> '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reservations</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Instances</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PublicIpAddress</span></span></span><span class="hljs-function">' | </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertfrom</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">json</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssh</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">devkey</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pem</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ubuntu</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(get-address i-ecf1fe5c)</span></span></span></span></code> </pre><br><br>  In more complex cases, you have to write a non-trivial code.  For example, the output parameters of the cloud formation stack can be obtained as follows: <br><pre> <code class="hljs php"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reduce</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($f,$a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($a.Length -eq <span class="hljs-number"><span class="hljs-number">1</span></span>) { $a } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $p = $a[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($x in <span class="hljs-number"><span class="hljs-number">1.</span></span>.($a.Length<span class="hljs-number"><span class="hljs-number">-1</span></span>)) { $p = $f.Invoke($p,$a[$x])[<span class="hljs-number"><span class="hljs-number">0</span></span>] } $p } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">json</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data)</span></span></span><span class="hljs-function"> </span></span>{ ConvertFrom-json <span class="hljs-string"><span class="hljs-string">"$data"</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cf</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">outputs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($cfName)</span></span></span><span class="hljs-function"> </span></span>{ $o = (get-json(aws cloudformation describe-stacks --stack-name $cfName)).Stacks[<span class="hljs-number"><span class="hljs-number">0</span></span>].Outputs $r = <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($i in $o) { @{$i.OutputKey = $i.OutputValue} } reduce {param($a,$i); $a+$i } $r }</code> </pre><br>  Now I can get the parameters of the database connection with the command <br><pre> <code class="hljs swift">(<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-cf-outputs microservice-rds-dev).<span class="hljs-type"><span class="hljs-type">DatabaseEndpoint</span></span></code> </pre><br><br>  Passing json to the aws cli commands also surprises.  For example, an attempt to add an entry to the dynamodb table simply fails: <br><pre> <code class="hljs rust">C:\Users\...&gt; aws dynamodb put-item --table-name tableName --item '{<span class="hljs-string"><span class="hljs-string">"groupId"</span></span>:{<span class="hljs-string"><span class="hljs-string">"S"</span></span>:<span class="hljs-string"><span class="hljs-string">"5"</span></span>}, <span class="hljs-string"><span class="hljs-string">"ancestors"</span></span>:{<span class="hljs-string"><span class="hljs-string">"L"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"S"</span></span>:<span class="hljs-string"><span class="hljs-string">"5"</span></span>},{<span class="hljs-string"><span class="hljs-string">"S"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>}]}}' Error parsing parameter '--item': Invalid JSON: Expecting property name enclosed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> double quotes: line <span class="hljs-number"><span class="hljs-number">1</span></span> column <span class="hljs-number"><span class="hljs-number">2</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br>  That is, somewhere deep aws, cli interprets this line before passing it to the json library.  (If it were bash, I would understand, but why it may be needed in a python program is beyond my comprehension.) <br>  To get around this strange behavior, it is enough to escape special characters: <br><pre> <code class="hljs bash"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> put-item([string]<span class="hljs-variable"><span class="hljs-variable">$table</span></span>, <span class="hljs-variable"><span class="hljs-variable">$data</span></span>) { aws dynamodb put-item --table-name <span class="hljs-variable"><span class="hljs-variable">$table</span></span> --item (convertto-json -Depth 128 <span class="hljs-variable"><span class="hljs-variable">$data</span></span>).Replace(<span class="hljs-string"><span class="hljs-string">'\'</span></span>,<span class="hljs-string"><span class="hljs-string">'\\'</span></span>).Replace(<span class="hljs-string"><span class="hljs-string">'"'</span></span>,<span class="hljs-string"><span class="hljs-string">'\"'</span></span>) }</code> </pre><br>  In principle, there is also a <a href="http://aws.amazon.com/ru/documentation/powershell/">native AWS client</a> for PowerShell, but it seemed to me more complicated and less documented. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/273473/">https://habr.com/ru/post/273473/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273453/index.html">New features call history reports (CDR)</a></li>
<li><a href="../273455/index.html">Implement MVVM in iOS using RxSwift</a></li>
<li><a href="../273467/index.html">In workshops, start-up platforms, or what you need to get money from an investor</a></li>
<li><a href="../273469/index.html">Release DataGrip (ex-0xDBE) 1.0 - New IDE for SQL</a></li>
<li><a href="../273471/index.html">A collection of practical tips and notes on the layout</a></li>
<li><a href="../273477/index.html">Symfony2 Voters and Doctrine Filters on guard for security</a></li>
<li><a href="../273481/index.html">Full URL in the address bar, tabs on the right and other improvements in the assembly Vivaldi 1.0.352.3</a></li>
<li><a href="../273483/index.html">Requirements for game functionality</a></li>
<li><a href="../273485/index.html">PHP application for apps.com - features and rakes</a></li>
<li><a href="../273487/index.html">Objective-C questions for middle / senior level</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>