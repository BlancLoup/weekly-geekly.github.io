<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rails: DRY style ajax validation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I first started to think about joining the world of web development, and chose a language to begin with, one of the Wikipedia sang to me that the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rails: DRY style ajax validation</h1><div class="post__text post__text-html js-mediator-article"> When I first started to think about joining the world of web development, and chose a language to begin with, one of the Wikipedia sang to me that there are 2 principles at the heart of Rails philosophy: <b>Convention over configuration (CoC)</b> and <b>Don't Repeat Yourself (DRY)</b> .  As for the first one, I didn‚Äôt understand what I was talking about, but the second one understood, accepted and expected that in the depths of this wonderful framework I would find a native tool that allows me to write validation rules for attributes of a model once and then use these rules for both front and back checks. <br><a name="habracut"></a><br>  As it turned out later, I was disappointed.  There is no such thing in the rails out of the box, and all that was found on the topic during training is a railscast about <i>client_side_validations gem</i> . <br><br>  I then knew about javascript only what it is, so I had to silently screw the gems to the emerging blog and put the topic of dry-validations to a closer acquaintance with js.  And now this time has come: I needed a flexible tool for checking forms, and I was not going to rewrite every <code>validates_inclusion_of</code> in js-style.  And that heme is no longer supported. <br><br><h4>  Formulation of the problem </h4><br>  Find a way to: <br><ol><li>  in the validation of attributes use the same logic: both for the back and for the front </li><li>  quickly ‚Äúhang up‚Äù checks for different forms and flexibly adjust them (both logic and visual) </li></ol><br>  The solution is materialized in a small demo: <a href="http://sandbox.alexfedoseev.com/dry-validation/showoff">http://sandbox.alexfedoseev.com/dry-validation/showoff</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And a couple of explanatory paragraphs below. <br><br><h4>  Instruments </h4><br>  I forgot to mention that I'm moderately lazy, and writing my own js-validator was not originally my plan.  From ready-made solutions, my choice fell on the <a href="http://jqueryvalidation.org/"><b>jQuery Validation Plugin</b></a> . <br><br>  It can simply be thrown into js-assets or <a href="https://github.com/danryan/jquery-validation-rails">set as heme</a> . <br>  Nothing more is needed. <br><br>  I will carry the good light through an example.  Suppose we have a mailing list that stores email addresses and sets the frequency of mailing for each address (how many times a week a letter is sent). <br><br><h4>  Getting to the point </h4><br>  Accordingly, there is a model - <code>Email</code> <br>  And its two attributes: <br><ul><li>  <code>email</code> - email address </li><li>  <code>frequency</code> - the frequency with which the newsletter will go to this address </li></ul><br>  What are the limitations: <br><ul><li>  <code>email</code> required </li><li>  <code>email</code> must be unique </li><li>  <code>email</code> should be email (with a dog and other ryushechkami) </li><li>  <code>frequency</code> is optional, but if so, it should be in the range <b>from 1 to 7</b> </li></ul><br><br>  We embody: <br><br>  <b>app / models / email.rb</b> <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Email</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">before_save</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">downcase</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VALID_EMAIL_REGEX</span></span></span><span class="hljs-class"> = /\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class">[\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">w</span></span></span><span class="hljs-class">+\-.]+@[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">az</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">\-.]+\.[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">az</span></span></span><span class="hljs-class">]+\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">z</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validates</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">presence</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uniqueness</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case_sensitive</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> }, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">format</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VALID_EMAIL_REGEX</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validates_inclusion_of</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frequency</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">: 1..7, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">allow_blank</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">In the controller and view everything is absolutely standard.</b> <div class="spoiler_text">  <b>app / controllers / emails_controller.rb</b> <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmailsController</span></span></span><span class="hljs-class"> &lt; ApplicationController </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Email</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Email</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email_params</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">save</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">flash</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">success</span></span></span><span class="hljs-class">] = '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Email</span></span></span><span class="hljs-class"> !' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">redirect_to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">emails_url</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">else</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">render</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email_params</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">require</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">permit</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frequency</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br>  <b>app / views / emails / new.html.haml</b> <br><br><pre> <code class="ruby hljs">%h1   = form_for @email <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|f|</span></span> = render <span class="hljs-symbol"><span class="hljs-symbol">partial:</span></span> <span class="hljs-string"><span class="hljs-string">'shared/error_messages'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">locals:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">object:</span></span> f.object } %p= f.text_field <span class="hljs-symbol"><span class="hljs-symbol">:email</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">placeholder:</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> %p= f.text_field <span class="hljs-symbol"><span class="hljs-symbol">:frequency</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">placeholder:</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> %p= f.submit <span class="hljs-string"><span class="hljs-string">'!'</span></span></code> </pre><br></div></div><br><br>  The next step is to hang the validator on the form and see what's what. <br>  This is done simply: <code>$('#form').validate();</code> <br><blockquote>  I will repeat the <a href="http://jqueryvalidation.org/documentation/">link to the documentation for the plugin</a> in order not to return to it anymore.  There is a small problem with the structured content, but all the information is there. </blockquote><br>  So, we hang: <br><br>  <b>app / assets / javascripts / emails.js.coffee</b> <br><br><pre> <code class="coffeescript hljs">jQuery -&gt; validate_url = <span class="hljs-string"><span class="hljs-string">'/emails/validate'</span></span> $(<span class="hljs-string"><span class="hljs-string">'#new_email, [id^=edit_email_]'</span></span>).validate( debug: <span class="hljs-literal"><span class="hljs-literal">true</span></span> rules: <span class="hljs-string"><span class="hljs-string">'email[email]'</span></span>: required: <span class="hljs-literal"><span class="hljs-literal">true</span></span> remote: url: validate_url type: <span class="hljs-string"><span class="hljs-string">'post'</span></span> <span class="hljs-string"><span class="hljs-string">'email[frequency]'</span></span>: remote: url: validate_url type: <span class="hljs-string"><span class="hljs-string">'post'</span></span> )</code> </pre><br><br>  Let's go through each line: <br><ul><li> <code>validate_url = '/emails/validate'</code> <br>  the address to which we will send an ajax request to check the field values </li><li> <code>$('#new_email, [id^=edit_email_]').validate</code> <br>  we hang the validator on the form of a new email, and on the form for editing already existing addresses </li><li> <code>debug: true</code> <br>  the method disables submitting the form so that you can be entertained with the settings </li><li> <code>rules:</code> <br>  In the method, validation rules for fields are prescribed, the plugin has a lot of them out of the box (see docks), but so far we are only interested in 2 </li><li> <code>'email[email]':</code> <br>  name ‚Äì attribute of the form field (simple names are indicated without quotes, with special characters - we take them in quotes) </li></ul><br>  We will dwell on the following two methods. <br><br><h5>  remote </h5><br><pre> <code class="coffeescript hljs">remote: url: validate_url type: <span class="hljs-string"><span class="hljs-string">'post'</span></span></code> </pre><br>  First, let's talk about the main method of this post - <code>remote</code> .  With it, we can send ajax requests to the server and process the returned data. <br><br>  How it works: the method needs to feed the request url and its type (in our case, send a post-request).  This is enough to send the field value to the server for verification. <br><br>  In response, the method expects to get <code>json</code> : <br><ul><li>  the answer is <code>true</code> - it means that everything is ok with the field </li><li>  <code>false</code> , <code>undefined</code> or <code>null</code> responses, as well as any other <code>string'</code> are regarded by the method as a signal of failed validation </li></ul><br><br><h5>  required </h5><br><pre> <code class="coffeescript hljs">required: <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre><br>  The method of "required fields."  The only check that cannot (and should not) be performed through a call to the server is <code>validates_presence_of</code> (that is, presence validation).  This is due to the peculiarities of the validator - it pulls the <code>remote</code> method only if any data is entered in the field.  "Run by hand" this check is impossible, therefore, validation of availability is prescribed directly through this method.  By the way, it takes a function as an argument, so complex logical checks for presence can (and should) be performed through it. <br><br><h4>  We continue </h4><br>  The validator is hung, the ajax request goes to the server, which is further: <br><ul><li>  need to create a method in the controller that will process the request </li><li>  register route to this method </li></ul><br><br>  <b>app / controllers / emails_controller.rb</b> <br><br><pre> <code class="ruby hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">#   end</span></span></span></span></code> </pre><br><br>  <b>config / routes.rb</b> <br><br><pre> <code class="ruby hljs">resources <span class="hljs-symbol"><span class="hljs-symbol">:emails</span></span> post <span class="hljs-string"><span class="hljs-string">'emails/validate'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> <span class="hljs-string"><span class="hljs-string">'emails#validate'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">as:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:emails_validation</span></span></code> </pre><br><br>  Ok, now the server can accept post requests to the address <code>'/emails/validate'</code> <br>  Let's start the server, open the <code>Email</code> creation form in the browser (lvh.me Tre000/emails/new), type ‚Äúsomething‚Äù in the form field and run to the console - see what the validator reports to us. <br><br>  In general, this could be expected: <br><br><pre> <code class="bash hljs">Started POST <span class="hljs-string"><span class="hljs-string">"/emails/validate"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 127.0.0.1 at 2014-02-17 22:10:31 +0000 Processing by EmailsController<span class="hljs-comment"><span class="hljs-comment">#validate as JSON Parameters: {"email"=&gt;{"frequency"=&gt;"-"}}</span></span></code> </pre><br>  Now about the strategy: what we will do with this good - how to process and what to return: <br><ul><li>  from a <code>json</code> flown to the controller, we will create a new <code>Email</code> object in memory </li><li>  and remove its validation via <code>ActiveModel</code> </li><li>  an object of class <code>ActiveModel::Errors</code> (available through the <code>errors</code> method) is <code>ActiveModel::Errors</code> in memory, in which there will be a hash <code>@messages</code> - either with errors (if the attributes are not validated), or empty (if everything is fine with the object) </li><li>  we will analyze this hash and, if it is empty, we will answer the browser with <code>true</code> , and if there are errors in the attribute being checked, we will reply with the text of these errors, which will be considered by the plugin‚Äôs receiving method as failed validation.  And, moreover, the plugin uses the received string as the text of the error message. </li></ul><br>  Chocolate!  Not only that the validation rules are written once directly in the model, but also error messages are stored directly in the rail locale. <br><br>  By the way, let's write them. <br><br>  <b>config / locales / ru.yml</b> <br><br><pre> <code class="ruby hljs"><span class="hljs-symbol"><span class="hljs-symbol">ru:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">activerecord:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">attributes:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">email:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">email:</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-symbol"><span class="hljs-symbol">frequency:</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-symbol"><span class="hljs-symbol">errors:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">models:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">email:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">attributes:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">email:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">blank:</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-symbol"><span class="hljs-symbol">taken:</span></span> <span class="hljs-string"><span class="hljs-string">"    "</span></span> <span class="hljs-symbol"><span class="hljs-symbol">invalid:</span></span> <span class="hljs-string"><span class="hljs-string">"  "</span></span> <span class="hljs-symbol"><span class="hljs-symbol">frequency:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">inclusion:</span></span> <span class="hljs-string"><span class="hljs-string">"     1  7 "</span></span></code> </pre><br><blockquote>  Read about I18n in Rails guides: <a href="http://guides.rubyonrails.org/i18n.html">http://guides.rubyonrails.org/i18n.html</a> </blockquote><br>  The names of the attributes and messages are spelled out. <br>  Now the most interesting - we form the answer to the browser. <br><br>  Immediately throwing out the working code, which we will sort through the lines: <br><br>  <b>app / controllers / emails_controller.rb</b> <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">email</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Email</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(email_params)</span></span></span></span> email.valid? field = params[<span class="hljs-symbol"><span class="hljs-symbol">:email</span></span>].first[<span class="hljs-number"><span class="hljs-number">0</span></span>] @errors = email.errors[field] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @errors.empty? @errors = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> name = t(<span class="hljs-string"><span class="hljs-string">"activerecord.attributes.email.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{field}</span></span></span><span class="hljs-string">"</span></span>) @errors.map! { <span class="hljs-params"><span class="hljs-params">|e|</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{name}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{e}</span></span></span><span class="hljs-string">&lt;br /&gt;"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> respond_to <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|format|</span></span> format.json { render <span class="hljs-symbol"><span class="hljs-symbol">json:</span></span> @errors } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  Go. <br><br><pre> <code class="ruby hljs">email = Email.new(email_params) email.valid?</code> </pre><br>  Create an object in memory from the parameters arriving from the form and pull the validation check so that the <code>ActiveModel::Errors</code> object <code>ActiveModel::Errors</code> in the memory.  The <code>@messages</code> hash with errors, in addition to the ones we need for the attribute being checked, will contain messages for all other attributes (since the values ‚Äã‚Äãof all the others are <code>nil</code> , only the value of the attribute being checked arrives). <br><br>  Let's see what an object looks like to see how to disassemble it: <br><br><pre> <code class="ruby hljs">(<span class="hljs-symbol"><span class="hljs-symbol">rdb:</span></span><span class="hljs-number"><span class="hljs-number">938</span></span>) email.errors <span class="hljs-comment"><span class="hljs-comment">#=&gt; #&lt;ActiveModel::Errors:0x007fbbe378dfb0 </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@base</span></span></span><span class="hljs-comment">=#&lt;Email id: nil, email: nil, frequency: "-", created_at: nil, updated_at: nil&gt;, </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@messages</span></span></span><span class="hljs-comment">={:email=&gt;["", "  "], :frequency=&gt;["     1  7 "]}&gt;</span></span></code> </pre><br>  We see a hash with error messages, and the docks <a href="http://api.rubyonrails.org/classes/ActiveModel/Errors.html">tell</a> us <a href="http://api.rubyonrails.org/classes/ActiveModel/Errors.html">how to get them</a> : <br><br><pre> <code class="ruby hljs">(<span class="hljs-symbol"><span class="hljs-symbol">rdb:</span></span><span class="hljs-number"><span class="hljs-number">938</span></span>) email.errors[<span class="hljs-string"><span class="hljs-string">'frequency'</span></span>] <span class="hljs-comment"><span class="hljs-comment">#=&gt; ["     1  7 "]</span></span></code> </pre><br>  That is, in order to get errors for an attribute, we first need to get the name of this attribute. <br>  This is what we extract from the <code>params</code> hash: <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#    (rdb:938) params #=&gt; {"email"=&gt;{"frequency"=&gt;"-"}, "controller"=&gt;"emails", "action"=&gt;"validate"} #    ,    (rdb:938) params[:email] #=&gt; {"frequency"=&gt;"-"} #       ,    (rdb:938) params[:email].first #=&gt; ["frequency", "-"] #      ,     -&gt;  (rdb:938) params[:email].first[0] #=&gt; "frequency"</span></span></code> </pre><br>  Go back to the validation function in the controller: <br><br><pre> <code class="ruby hljs">field = params[<span class="hljs-symbol"><span class="hljs-symbol">:email</span></span>].first[<span class="hljs-number"><span class="hljs-number">0</span></span>] @errors = email.errors[field]</code> </pre><br>  First, we got the name of the checked attribute of the model, then pulled out an array with error messages. <br><br>  After that we will form the answer to the browser: <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @errors.empty? @errors = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> name = t(<span class="hljs-string"><span class="hljs-string">"activerecord.attributes.email.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{field}</span></span></span><span class="hljs-string">"</span></span>) @errors.map! { <span class="hljs-params"><span class="hljs-params">|e|</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{name}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{e}</span></span></span><span class="hljs-string">&lt;br /&gt;"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  If the array with errors is empty, then the <code>@errors</code> variable is <code>true</code> (this is the answer the plugin expects if there are no errors). <br><br>  If there are errors in the array, then: <br><ul><li>  if we give it up as just <code>@errors</code> , then we get the message <b>‚Äúmust be in the range from 1 to 7 inclusively‚Äù</b> (and if there are several, they just ‚Äústick together‚Äù when outputting) </li></ul><br>  That's why we: <br><ul><li>  We take out the name of the model attribute from the rail localization file: <br> <code>name = t("activerecord.attributes.email.#{field}")</code> </li> <li>  and in each array element with errors we add this name to the beginning with a space: <br> <code>@errors.map! { |e| "#{name} #{e} <br> " }</code> </li> <li>  You can also stick <code>br</code> at the end of each error, it depends on the layout, in short, add to taste </li></ul><br>  We end up with an array of messages in the format: <br>  <b>"The periodicity should be in the range of 1 to 7 inclusive</b> . <b>"</b> <br><br>  And the final touch - we pack all this in <code>json</code> : <br><br><pre> <code class="ruby hljs">respond_to <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|format|</span></span> format.json { render <span class="hljs-symbol"><span class="hljs-symbol">json:</span></span> @errors } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Rails responds to the browser. <br><br><h4>  Refractory </h4><br>  For one model it works, but we will have many models in the application.  In order to not repeat itself, you can rewrite the routing and validation method in the controller. <br><br><h5>  Routing </h5><br>  <b>config / routes.rb</b> <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  post 'emails/validate', to: 'emails#validate', as: :emails_validation #        post ':controller/validate', action: 'validate', as: :validate_form</span></span></code> </pre><br><br><h5>  Validation Method </h5><br>  We display the validation logic in <b>application_controller.rb</b> so that any application controllers can use it. <br><br>  <b>app / controllers / application_controller.rb</b> <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(object)</span></span></span></span> object.valid? model = object.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.name.underscore.to_sym field = params[model].first[<span class="hljs-number"><span class="hljs-number">0</span></span>] @errors = object.errors[field] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @errors.empty? @errors = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> name = t(<span class="hljs-string"><span class="hljs-string">"activerecord.attributes.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{model}</span></span></span><span class="hljs-string">.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{field}</span></span></span><span class="hljs-string">"</span></span>) @errors.map! { <span class="hljs-params"><span class="hljs-params">|e|</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{name}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{e}</span></span></span><span class="hljs-string">&lt;br /&gt;"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  <b>app / controllers / emails_controller.rb</b> <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">email</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Email</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(email_params)</span></span></span></span> validator(email) respond_to <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|format|</span></span> format.json { render <span class="hljs-symbol"><span class="hljs-symbol">json:</span></span> @errors } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  PS In order not to pull the server with each <code>onkeyup: false</code> entered by the user in the form fields, set the value of the <code>onkeyup: false</code> method <code>onkeyup: false</code> <br><br>  <b>jQuery Validation Plugin:</b> <br>  <a href="http://jqueryvalidation.org/">http://jqueryvalidation.org</a> <br><br>  <b>Demo with bows:</b> <br>  <a href="http://sandbox.alexfedoseev.com/dry-validation/showoff">http://sandbox.alexfedoseev.com/dry-validation/showoff</a> <br><br>  UPDATE: Edited header </div><p>Source: <a href="https://habr.com/ru/post/213077/">https://habr.com/ru/post/213077/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213065/index.html">Typing (defining properties) of an object by the hands of site users</a></li>
<li><a href="../213069/index.html">The risks of AI from LessWrong.com, part 1: an interview with Shane Legge from DeepMind</a></li>
<li><a href="../213071/index.html">Telephony integration in distributed call centers</a></li>
<li><a href="../213073/index.html">Get out of the room</a></li>
<li><a href="../213075/index.html">Backup and Restore Graylog Server</a></li>
<li><a href="../213081/index.html">BSA offers to earn up to $ 200,000, reporting on the use of pirated software</a></li>
<li><a href="../213083/index.html">Cash Transitions and Personal Transitions</a></li>
<li><a href="../213085/index.html">Search on Drupal 7 using Apache Solr Part 7 - full-text search in Russian</a></li>
<li><a href="../213097/index.html">10 anti-navigation patterns in Android</a></li>
<li><a href="../213099/index.html">10 million pokemon players</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>