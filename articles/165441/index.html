<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience of transferring large files using a secure protocol from 1C to the site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="During the creation of the next B2B system at the 1C: Enterprise 8.2 integration stage with the web interface, it became necessary to transfer large f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience of transferring large files using a secure protocol from 1C to the site</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/ef4/1f6/858/ef41f685849609f7e48de15b9fc7155c.png" alt="transfer of large files using a secure protocol from 1C to the site"><br>  During the creation of the next B2B system at the 1C: Enterprise 8.2 integration stage with the web interface, it became necessary to transfer large files from 1C to the web safely. <br>  To solve this problem, SFTP was chosen as a reliable and unlimited transfer file size. <br>  In the embedded language 1C: Enterprise 8.2, there are no functions for transmitting data via <a href="http://ru.wikipedia.org/wiki/SFTP">SFTP</a> , so I had to look for application tools. <a name="habracut"></a>  On the Internet resources devoted to programming 1C, there are examples of successful use of freeware utilities like <a href="http://winscp.net/eng/index.php">WinSCP</a> .  To use this method, you need to run the utility from the embedded language 1C with command line parameters. <br><br>  An example of running the WinCSP utility from 1C: <br><br><pre><code class="hljs 1c"> = <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>)+<span class="hljs-built_in"><span class="hljs-built_in"></span></span>()+<span class="hljs-string"><span class="hljs-string">"\"</span></span>+ <span class="hljs-string"><span class="hljs-string">"WinSCP.com"</span></span>+<span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>)+<span class="hljs-string"><span class="hljs-string">"/script="</span></span>+<span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>)+<span class="hljs-built_in"><span class="hljs-built_in"></span></span>()+<span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>)+<span class="hljs-string"><span class="hljs-string">"\script.txt "</span></span>+<span class="hljs-string"><span class="hljs-string">"/parameter "</span></span>+<span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>)++<span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>)+<span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>)++<span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>)+<span class="hljs-string"><span class="hljs-string">" "</span></span>+<span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>) +  + <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>) + <span class="hljs-string"><span class="hljs-string">" "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>) +  + <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-number"><span class="hljs-number">34</span></span>);</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The downside of such a solution is the lack of control over startup errors and execution from the embedded language 1C.  In this regard, it was decided to write an external DLL component for 1C: Enterprise 8.2. <br><br>  The 1C: Enterprise platform supports two technologies for creating external components of the Native API and COM.  The choice fell on the Native API, since the components created by this technology work both on the client and on the 1C server.  Using materials from the ITS disk about the technology of creating external components and the open source library C ++, the file SftpExtension.dll was created (you can download the source <a href="">here</a> ). <br><br>  <b>Creating a DLL Component</b> <br><br>  1. For use in the SFTP component of the protocol, we used two libraries. <br>  - libssh <a href="http://www.libssh2.org/">http://www.libssh2.org/</a> (Download ‚Äúgit clone git: //git.libssh2.org/libssh2.git‚Äù) <br>  - openssl <a href="http://www.openssl.org/">http://www.openssl.org/</a> (Download archive openssl-1.0.1c.tar.gz from <a href="http://www.openssl.org/">here</a> ) <br>  We connect libraries to the project. <br><br>  2. Each component object must be inherited from the abstract class IcomponentBase and IlanguageInterface. <br><ul><li>  IcomponentBase - implements the main methods of the component. </li><li>  IlanguageInterface - serves to localize the methods and properties of 1C and C ++ through the definition of arrays of correspondences and methods of accessors GetMethodName, GetPropName. </li></ul><br>  Part of the component code describing the possibility of calling C ++ functions from 1C in Russian: <br>  You can use other languages. <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *g_MethodNames[] = { <span class="hljs-string"><span class="hljs-string">L"SendFile"</span></span>,<span class="hljs-string"><span class="hljs-string">L"StartSession"</span></span>, <span class="hljs-string"><span class="hljs-string">L"EndSession"</span></span>, <span class="hljs-string"><span class="hljs-string">L"IsSessionStart"</span></span>,<span class="hljs-string"><span class="hljs-string">L"SetSshHost"</span></span>,<span class="hljs-string"><span class="hljs-string">L"SetSshLogin"</span></span>,<span class="hljs-string"><span class="hljs-string">L"SetSshPass"</span></span>,<span class="hljs-string"><span class="hljs-string">L"SetSftpPath"</span></span>,<span class="hljs-string"><span class="hljs-string">L"SetLocalPath"</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *g_MethodNamesRu[] = { <span class="hljs-string"><span class="hljs-string">L""</span></span>,<span class="hljs-string"><span class="hljs-string">L""</span></span>,<span class="hljs-string"><span class="hljs-string">L""</span></span>,<span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>,<span class="hljs-string"><span class="hljs-string">L""</span></span>,<span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>,<span class="hljs-string"><span class="hljs-string">L""</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WCHAR_T* SftpExtension::GetMethodName(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lMethodNum, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lMethodAlias) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lMethodNum &gt;= eMethLast) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *wsCurrentName = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; WCHAR_T *wsMethodName = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iActualSize = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(lMethodAlias) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-comment"><span class="hljs-comment">// First language wsCurrentName = g_MethodNames[lMethodNum]; break; case 1: // Second language wsCurrentName = g_MethodNamesRu[lMethodNum]; break; default: return 0; } iActualSize = wcslen(wsCurrentName)+1; if (m_iMemory &amp;&amp; wsCurrentName) { if(m_iMemory-&gt;AllocMemory((void**)&amp;wsMethodName, iActualSize * sizeof(WCHAR_T))) ::convToShortWchar(&amp;wsMethodName, wsCurrentName, iActualSize); } return wsMethodName; }</span></span></code> </pre> <br><br>  3. To call the required function from the component, use the CallAsFunc method from the IcomponentBase interface.  When calling methods from 1C components, this C ++ method is called. <br><br>  As parameters of the method are used: <br><ul><li>  lMethodNum - the number of the method in the array of matches. </li><li>  pvarRetValue - pointer to output parameters. </li><li>  paParams - parameters from the method in 1C. </li><li>  lSizeArray - the size of the array, if the input parameter is an array. </li></ul><br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> SftpExtension::CallAsFunc(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lMethodNum, tVariant* pvarRetValue,tVariant* paParams, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lSizeArray){ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(lMethodNum){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethSendFile: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lSizeArray || !paParams) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;local_path = toChar(paParams); WriteToServer(status, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;local_path); <span class="hljs-comment"><span class="hljs-comment">// pvarRetValue-&gt;pstrVal = status; //status pvarRetValue-&gt;strLen = strlen(pvarRetValue-&gt;pstrVal); TV_VT(pvarRetValue) = VTYPE_PSTR; ret = true; break; } } return ret; }</span></span></code> </pre> <br><br>  4. In our example of 1C, you can perform 4 methods that correspond to the C ++ methods in the DLL component. <br><br><table><tbody><tr><th>  1C (methods) </th><th>  C ++ methods </th></tr><tr><td>  Start Session () <br>  Beforehand, it is necessary to define the authorization parameters (host, login, password - either rsa keys, the path on the remote server). <br>  Therefore, the Start Session function acquires the following properties: Host, Login, Password, Remote Path <br></td><td>  StartSSHSession (status, this-&gt; ssh_host, this-&gt; ssh_login, this-&gt; ssh_pass); <br>  StartSftpSession (status, this-&gt; sftp_path) <br></td></tr><tr><td>  Send File (‚ÄúPath and file name on client machine‚Äù) <br></td><td>  WriteToServer (const char * &amp; status, const char * loclfile) <br></td></tr><tr><td>  IfSessionStart () </td><td>  isSessionStart () </td></tr><tr><td>  FinishSession () </td><td>  endSession () - ends an SFTP session and an SSH session </td></tr></tbody></table><br><br>  5. In C ++, you need to define access parameters (read / write) to the created properties; two methods, IsPropReadable and IsPropWritable, are responsible for this. <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> SftpExtension::IsPropReadable(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lPropNum) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(lPropNum) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ePropSshHost: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}</code> </pre><br><br>  Table of ratios of properties 1C and C ++ <br><table><tbody><tr><th>  1C (properties) </th><th>  C ++ properties </th></tr><tr><td>  Host </td><td>  ssh_host </td></tr><tr><td>  Login </td><td>  ssh_login </td></tr><tr><td>  Password </td><td>  ssh_pass </td></tr><tr><td>  Remote Path </td><td>  Sftp_path </td></tr></tbody></table><br><br>  The finished library can be downloaded <a href="">here</a> . <br><br>  <b>Work with a component in the embedded language 1C</b> <br><br>  1. We perform the connection and create an object of the external component using the standard commands of the embedded language 1C. <br><br><pre> <code class="hljs 1c"><span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-string"><span class="hljs-string">"C:\SftpExtension\SftpExtension.dll"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-class"><span class="hljs-class"></span></span>.Native);  = <span class="hljs-keyword"><span class="hljs-keyword"></span></span>(<span class="hljs-string"><span class="hljs-string">"AddIn..SftpExtension"</span></span>);</code> </pre><br><br>  2. Fill 4 properties of the object components Host, Login, Password, Remote Path. <br><pre> <code class="hljs objectivec">. = <span class="hljs-string"><span class="hljs-string">"192.168.0.1"</span></span>; . = <span class="hljs-string"><span class="hljs-string">"root"</span></span>; . = <span class="hljs-string"><span class="hljs-string">"123"</span></span>; . = <span class="hljs-string"><span class="hljs-string">"/var/www/company/data/www/import/data.xml"</span></span>;</code> </pre><br><br>  3. We open connection session <br><pre> <code class="hljs">.();</code> </pre> <br><br>  4. Send the file <br><pre> <code class="hljs objectivec">.(<span class="hljs-string"><span class="hljs-string">"C:\data.xml"</span></span>);</code> </pre> <br><br>  5. We send the following file, with a check if the session of the connection is open. <br><pre> <code class="hljs 1c"><span class="hljs-keyword"><span class="hljs-keyword"></span></span> .() <span class="hljs-keyword"><span class="hljs-keyword"></span></span> .(<span class="hljs-string"><span class="hljs-string">"C:\data2.xml"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword"></span></span> .(); .(<span class="hljs-string"><span class="hljs-string">"C:\data2.xml"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword"></span></span>;</code> </pre><br><br>  6. After sending files, close the session. <br><pre> <code class="hljs">.();</code> </pre> <br><br><blockquote>  As a result of the execution, the file with C: \ data2.xml in /var/www/company/data/www/import/data.xml was successfully transferred. </blockquote><br><br>  <b>Materials used</b> <br>  Literature: <br>  <a href="http://st.free-lance.ru/projects/upload/f_4d5118dcf1abb.pdf">Manual to create components</a> <br>  SFTP libraries: <br><ul><li>  libssh <a href="http://www.libssh2.org/">http://www.libssh2.org/</a> </li><li>  openssl <a href="http://www.openssl.org/">http://www.openssl.org/</a> </li></ul><br><br>  <b>Conclusion:</b> this implementation allows to transfer files from 1C: Enterprise 8.2.  large secure protocol SFTP.  Plus, it is possible to transfer part of the functionality from 1C to the external component, which protects the written code and allows you to implement additional, not available 1C functionality. </div><p>Source: <a href="https://habr.com/ru/post/165441/">https://habr.com/ru/post/165441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165427/index.html">Chrome Beta is available on Google Play</a></li>
<li><a href="../165431/index.html">HTC Desire SV - double charge</a></li>
<li><a href="../165435/index.html">Deanonimization on the World Wide Web - Closer and Closer</a></li>
<li><a href="../165437/index.html">Tame Tmux for everyday needs</a></li>
<li><a href="../165439/index.html">‚ÄúHow to make a channel‚Äù or recording and mixing: the maximum from the minimum</a></li>
<li><a href="../165443/index.html">Profession "Leader". Or "Leadership"? Let's see!</a></li>
<li><a href="../165445/index.html">"Valve Steam Box" - the future of the PC in the world of consoles? (great miracle in a small box)</a></li>
<li><a href="../165447/index.html">Aspects of restrictions on the value of accounting balances from the point of view of automation systems</a></li>
<li><a href="../165449/index.html">Parallel IEnumerable processing in .NET</a></li>
<li><a href="../165451/index.html">Howto Installing Redmine2.2.0 Debian + Apache + PostgreSQL + passenger</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>