<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple cache in memory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 

 It was necessary to make a very primitive cache here, so as not to climb into the database once again. At the same time, the data in the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple cache in memory</h1><div class="post__text post__text-html js-mediator-article"><h4>  Good day! </h4><br><br>  It was necessary to make a very primitive cache here, so as not to climb into the database once again.  At the same time, the data in the database is static, and the question is not so much in updating the data, but in when to drop them, just to not take up memory, and of course ease of use is important.  At first I wanted to use MemoryCache, but it seemed to me too confused, and even without strict typing. <br><br>  For an example of implementation, please under the cat. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Implementation </h5><br>  The general idea is this: the cache should be comfortable and transparent to use.  I was inspired by the interface class ThreadLocal.  Therefore, the constructor requires a factory method to get the original values, and then they are cached.  Again, in my case, I considered it quite logical to keep the data on weak links (WeakReference), so, as long as the data is needed, someone uses it, it will be available.  Further, as the allocation of new memory, the data from the cache will be pushed out. <br>  There are only two methods: the indexer, which will return data either from the source or from the cache. <br>  As well as the CleanCache method, to clear the dictionary of dead references and thus eliminate memory leaks.  In reality, it is not always necessary.  For example, in my conditions, new entries in the cache will appear only a few times a day, so even over the years the links will not devour a significant amount of memory. <br><br><h5>  Purpose of publication </h5><br>  Basically, I'm interested in hearing about my implementation, how would you do if there are any mistakes.  Well, if it helps someone, take it, use it :) <br><br><h5>  Source code </h5><br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WeakCache</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TKey</span></span>,<span class="hljs-title"><span class="hljs-title">TValue</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TValue</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cacheCleanInterval = <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Func&lt;TKey, TValue&gt; getter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;TKey, WeakReference&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, WeakReference&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ReaderWriterLockSlim rwLock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReaderWriterLockSlim(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DateTime lastCacheClean = DateTime.MinValue; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WeakCache</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func&lt;TKey,TValue&gt; getter</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getter = getter; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TValue <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[TKey key] { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { CleanCache(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { rwLock.EnterUpgradeableReadLock(); WeakReference wr; TValue val; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.TryGetValue(key, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> wr)) { val = (TValue)wr.Target; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { rwLock.EnterWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.TryGetValue(key, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> wr)) { val = (TValue)wr.Target; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val; } data[key] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeakReference(val = getter(key)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { rwLock.ExitWriteLock(); } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { rwLock.ExitUpgradeableReadLock(); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CleanCache</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((DateTime.Now - lastCacheClean).TotalSeconds &gt; cacheCleanInterval) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { rwLock.EnterWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((DateTime.Now - lastCacheClean).TotalSeconds &gt; cacheCleanInterval) { lastCacheClean = DateTime.Now; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> refs = data.ToArray(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> weakReference <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> refs) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!weakReference.Value.IsAlive) data.Remove(weakReference.Key); } } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { rwLock.ExitWriteLock(); } } } }</code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/185616/">https://habr.com/ru/post/185616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../185596/index.html">High load application architecture. Scaling of distributed systems. Part two</a></li>
<li><a href="../185598/index.html">Internal cuisine: a recipe for effective work with a remote employee. Part 2</a></li>
<li><a href="../185604/index.html">We saw Pan / Tilt webcam (which is spinning) + the ability to connect all sorts of sensors for ~ $ 15</a></li>
<li><a href="../185606/index.html">A little more automatic music generation</a></li>
<li><a href="../185608/index.html">Rating of Russian digital agencies in social media</a></li>
<li><a href="../185618/index.html">Google tech support or lack of it. Help Search Algorithms</a></li>
<li><a href="../185620/index.html">New type of audio advertising - broadcasting sound directly to the head</a></li>
<li><a href="../185622/index.html">Probabilistic models: the art of brackets</a></li>
<li><a href="../185624/index.html">Software routing: history of moving from hub-n-spoke (vyatta + openvpn) to fullmesh (mikrotik + tincvpn) - part 1</a></li>
<li><a href="../185626/index.html">Hadoop. Detailed guide. 3rd edition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>