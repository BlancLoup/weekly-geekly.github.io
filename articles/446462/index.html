<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Immersion in the driver: the general principle of the reverse example of the task NeoQUEST-2019</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Like all programmers, you love code. You are with him - best friends. But sooner or later in life there comes a moment when there will be no code with...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Immersion in the driver: the general principle of the reverse example of the task NeoQUEST-2019</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ql/w3/1t/qlw31t-4mz--bhpo4qa81o_ptse.gif"></div><br>  Like all programmers, you love code.  You are with him - best friends.  But sooner or later in life there comes a moment when there will be no code with you.  Yes, it's hard to believe, but there will be a huge gulf between you: you are outside, and he is deep inside.  From despair, you, like everyone, will have to go to the other side.  On the side of reverse engineering. <br><br>  Using the example of task number 2 from the online stage <a href="https://neoquest.ru/timeline.php%3Fyear%3D2019%26part%3D1">NeoQUEST-2019,</a> we analyze the general principle of reverse Windows driver.  Of course, the example is rather simplistic, but the essence of the process does not change from this - the only question is the amount of code that needs to be reviewed.  Armed with experience and good luck, let's get started! <a name="habracut"></a><br><h2>  Given </h2><br>  According to legend, we were given two files: a traffic dump and a binary file, which this very traffic generated.  First, look at the dump using Wireshark: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xb/4k/gs/xb4kgshocgnwhickftcvukhjqtk.png"></div><br>  The dump contains a stream of UDP packets, each of which contains 6 bytes of data.  These data, at first glance, represent some sort of random set of bytes ‚Äî it is not possible to pull something out of the traffic.  Therefore, we will turn our attention to the binary, which should tell you how to decipher everything. <br>  Open it in IDA: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/webt/pp/v_/cq/ppv_cqotco3m7vjdjxdwyxmmqpc.png"></div><br>  It seems that we face some kind of driver.  Functions prefixed with WSK relate to Winsock Kernel, the Windows Kernel-Mode Network Programming Interface.  <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wsk/">See the</a> MSDN for a description of the structures and functions used in the WSK. <br><br>  For convenience, you can load the Windows Driver Kit 8 (kernel mode) - wdk8_km (or any newer) library into IDA to use the types defined there: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zf/8e/gu/zf8egusvoa5plmcn2uadxwtmapk.png"></div><br><h2>  Caution, reverse! </h2><br>  As always, we start from the entry point: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z6/ry/e1/z6rye1bxurfesyaglba_f_4q9aq.png"></div><br>  Let's go in order.  At first, Wsk is initialized, a socket is created and bind, we will not describe these functions in detail, they do not carry any useful information for us. <br><br>  The sub_140001608 function sets 4 global variables.  Let's call it InitVars.  In one of them is written the value lying at the address 0xFFFFF78000000320.  A little googling this address, you can make the assumption that it recorded the number of ticks of the system timer since the system was booted.  For now let's name the variable TickCount. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/e5/7_/2x/e57_2xuaa7zyx0fxfz7ebyc9kqu.png"></div><br>  Next, EntryPoint installs functions for processing IRP packets (I / O Request Packet).  You can <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-major-function-codes">read</a> more about them on MSDN.  For all types of requests, a function is defined that simply passes the packet to the next driver in the stack. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/b3/xj/sa/b3xjsa1qqtxxc-r7zydxxlzu48w.png"></div><br>  But for the type IRP_MJ_READ (3) a separate function is defined;  call it IrpRead. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gi/a1/5y/gia15yhygs63v9qm5nooaxboay4.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hu/yd/9w/huyd9wgps6ubfztj72vrfl3pxfm.png"></div><br>  It, in turn, sets CompletionRoutine. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2l/5o/wq/2l5owqwqa0pqcmy3zrbfnen1h28.png"></div><br>  CompletionRoutine fills an unknown structure with data obtained from the IRP and places it on the list.  So far we do not know what is inside the package - we will return to this function later. <br>  Look further into EntryPoint.  After determining the IRP handlers, the sub_1400012F8 function is called.  Let's look inside and immediately notice that a device is created in it (IoCreateDevice). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xn/bv/hg/xnbvhgsku6con1ppuedpwuo2kw8.png"></div><br>  Let's call the function AddDevice.  If we correctly type, we will see that the device name is "\\ Device \\ KeyboardClass0".  This means that our driver interacts with the keyboard.  Googling about IRP_MJ_READ in the context of the keyboard, you can <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff542213(v%3Dvs.85).aspx">find</a> that the KEYBOARD_INPUT_DATA structure is transmitted in packets.  Let's return to CompletionRoutine and see what data it transmits. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/hi/rc/y1hirc1v347d7sqvedm0__ht01m.png"></div><br>  IDA is a poorly parsit structure here, but by offsets and further calls it can be understood that it consists of ListEntry, KeyData (the scan code of the key is stored here) and KeyFlags. <br>  After AddDevice in EntryPoint, the sub_140001274 function is called.  She creates a new thread. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/an/k2/bg/ank2bgcarpusbca9wgiydrkjmo0.png"></div><br>  Let's see what happens in ThreadFunc. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4b/ia/6f/4bia6fkojwowshkdfwfcj5e5xkq.png"></div><br>  It gets the value from the list and processes them.  Immediately pay attention to the function sub_140001A18. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oa/tp/6z/oatp6zuhwpkm-3yvwoi51heuqzw.png"></div><br>  It passes the processed data to the input of the sub_140001A68 function, along with a pointer to the WskSocket and the number 0x89E0FEA928230002.  Having examined the number-parameter by bytes (0x89 = 137, 0xE0 = 224, 0xFE = 243, 0xA9 = 169, 0x2328 = 9000), we get exactly the same address and port from the traffic dump: 169.243.224.137:9000.  It is logical to assume that this function sends a network packet to the specified address and port - we will not consider it in detail. <br>  We will understand how data is processed before sending. <br><br>  For the first two elements, perform an equivalent with the generated value.  Since the number of ticks is used for the calculation, we can assume that we are generating a pseudo-random number. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h1/vi/xa/h1vixaqacqmhbn6nr0p6nbw03py.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2f/xg/xr/2fxgxrgvu-0be2wb5r2bbnszljy.png"></div><br>  After generating the number, it overwrites the value of the variable we previously named TickCount.  Variables for the formula are set in InitVars.  If we return to the call of this function, we will know the values ‚Äã‚Äãfor these variables, and in the end we will get the following formula: <br><br>  <b><i>(54773 + 7141 * prev_value)% 259200</i></b> <br><br>  This is a linear congruential <a href="https://en.wikipedia.org/wiki/Linear_congruential_generator">pseudo-random number generator</a> .  It is initialized in InitVars using TickCount.  For each subsequent number, the previous value is used as the initial value (the generator returns a two-byte value, and the same is used for subsequent generation). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/td/pd/2f/tdpd2fq9xc9kvskq-tf4ax87xms.png"></div><br>  After an equivalence with a random number of two values ‚Äã‚Äãtransmitted from the keyboard, a function is called that forms the remaining two bytes of the message.  It simply produces the <i>xor of the</i> two already-encrypted parameters and some constant value.  This is unlikely to allow somehow decrypt the data, so the last two bytes of the message for us do not carry any useful information, and they can not be considered.  But what to do with the encrypted data? <br>  Let's take a closer look at what is encrypted.  KeyData is a scan code, it can take a fairly wide range of values, it is not easy to guess.  <a href="https://docs.microsoft.com/ru-ru/windows/desktop/api/ntddkbd/ns-ntddkbd-_keyboard_input_data">KeyFlags</a> is a bit field: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ww/rw/cp/wwrwcpfjwzk1ixnguh7jk-aafiw.png"></div><br>  If you look at the <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BA%25D0%25B0%25D0%25BD-%25D0%25BA%25D0%25BE%25D0%25B4">table of</a> scan codes, then you will notice that most often the flag will be either 0 (the key is omitted) or 1 (the key is raised).  KEY_E0 will be set up quite rarely, but it may happen, but to meet KEY_E1 the chances are very small.  Therefore, you can try to do the following: we go through the data from the dump, choose a value that is encrypted KeyFlags, produce an equivalent from 0, generate two successive PDHs.  First, KeyData is a single byte, and we can check the correctness of the generated PN on the high byte.  And secondly, the next encrypted KeyFlags, when making an equivalent with the correct PN, will take the same bit values.  If this is not the case, then we assume that the KeyFlags that we initially considered was 1, and so on. <br>  Let's try to implement our algorithm.  To do this, use python: <br><br><div class="spoiler">  <b class="spoiler_title">Algorithm implementation</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  -   keymap = [‚Ä¶] # ,   Wireshark traffic_dump = [‚Ä¶] #  def bxnor(a, b): return ((~a &amp; 0xffff) | b) &amp; (a | (~b &amp; 0xffff)) #   def brgen(a): return ((7141 * a + 54773) % 259200) &amp; 0xffff def decode(): #     for i in range(0, len(traffic_dump) - 1): #   KeyFlags probe = traffic_dump[i][1] #   - scancode = traffic_dump[i+1][0] #    KeyFlags tester = traffic_dump[i+1][1] fail = True #     (  KEY_E1) for flag in range(4): rnd_flag = bxnor(flag, probe) rnd_sc = brgen(rnd_flag) next_flag = bxnor(tester, brgen(rnd_sc)) #   KeyFlags if next_flag in range(4): sc = bxnor(rnd_sc, scancode) if sc &lt; len(keymap): sym = keymap[sc] if next_flag % 2 == 0: print(sym, end='') fail = False break #   -      KeyFlags   if fail: print('Something went wrong on {} pair'.format(i)) return print() if __name__ == "__main__": decode()</span></span></code> </pre> <br></div></div><br>  Run our script on the data received from the dump: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ht/ct/lp/htctlp99gtxcxje2krcgsjkqnpu.png"></div><br>  And in the decrypted traffic, we discover our most desirable line! <br><br>  <i><b>NQ2019DABE17518674F97DBA393415E9727982FC52C202549E6C1740BC0933C694B3DE</b></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z9/3u/ma/z93umaswtxopnn-zbqi4qwbanfu.jpeg"></div><br>  Soon there will be articles with analyzes of other tasks, do not miss it! <br><br>  PS And we remind that everyone who completed at least one task on NeoQUEST-2019 is entitled to a prize!  Check your mail for the presence of a letter, and if suddenly it did not come to you - write to <b>support@neoquest.ru</b> ! </div><p>Source: <a href="https://habr.com/ru/post/446462/">https://habr.com/ru/post/446462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446452/index.html">Lunar mission "Bereshit" - April 4, 2019 made a transition to lunar orbit, ahead of 7 days of flight, 6 maneuvers and 1 landing</a></li>
<li><a href="../446454/index.html">Web server development on Golang - from easy to hard</a></li>
<li><a href="../446456/index.html">Import substitution in practice. Part 1. Options</a></li>
<li><a href="../446458/index.html">Universal DRO based on Arduino Nano - shDRO. Part 2</a></li>
<li><a href="../446460/index.html">Product Design Digest March 2019</a></li>
<li><a href="../446464/index.html">15 parrots: choose a hosting provider for VPS / VDS servers</a></li>
<li><a href="../446466/index.html">Content marketing for business: habraseminar # 6 and its main points</a></li>
<li><a href="../446468/index.html">A practical guide on environment variables in Go</a></li>
<li><a href="../446470/index.html">Released the world's first propeller, created on a 3D printer</a></li>
<li><a href="../446472/index.html">Global update of the results display Lamptest.ru</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>