<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating extensions in PostgreSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, habracheloveki! The topic of this article will be the creation of extensions for PostgreSQL . As an example, we are implementing a small librar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating extensions in PostgreSQL</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/890/a02/abf/890a02abf9fb65612c78c7803aaa24c5.jpg"><br>  Hello, habracheloveki!  The topic of this article will be the creation of extensions for <b>PostgreSQL</b> .  As an example, we are implementing a small library for working with 3D vectors.  In parallel, user types, operators, and type casts will be considered.  It will not be superfluous to familiarize yourself with <a href="http://habrahabr.ru/post/196544">this</a> material, since the implementation of the stored functions will be in the C language. I hope the friends of the elephants will help to brighten up the gray technical text of the article. <br><a name="habracut"></a><br><h4>  <b>Description</b> </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/618/ede/48b/618ede48b4e3907b8bd854bf45bc59f8.jpg"><br>  <a href="http://www.postgresql.org/docs/9.3/static/extend-extensions.html">An extension</a> in <b>PostgreSQL</b> is a collection of several SQL objects (data types, functions, operators) combined into a script, a dynamically loaded library (if necessary) and a control file that specifies the name of the script, the path to the library, the default version, and others. options.  The use of extensions makes it easy to deploy additional logic in the database, do a migration to a newer version and, when the extension is deleted, correctly delete the dependent objects. <br><br>  We need to create a new vector3 data type and define such operations: <br><ul><li>  vector addition </li><li>  vectors subtraction </li><li>  multiplication of vector by scalar </li><li>  scalar product </li><li>  vector product </li><li>  finding the length of the vector </li><li>  vector normalization </li><li>  determining the distance between vectors </li></ul><br>  To improve performance, we will write all the logic in the C language and design it as a dynamically loadable math3d library.  Also, where it will be intuitive, create the operators.  And finally, we wrap it all in an extension. <br><br><h4>  <b>Type creation</b> </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/585/b82/5fd/585b825fd2c454f3a8cbe0c5ca284440.jpg"><br>  <b>PostgreSQL</b> DBMS allows you to define, in addition to composite types, enumeration types and range <a href="http://www.postgresql.org/docs/9.3/static/sql-createtype.html">types</a> , <a href="http://www.postgresql.org/docs/9.3/static/sql-createtype.html">new data types</a> .  The latter require the implementation of functions working with a type in a lower-level language than SQL, as a rule, in C. Defining a custom type requires at least two functions: input and output.  The input function has one parameter with the type C-string (byte array, ending in zero) and returns a custom type.  The output function has a parameter with a custom type and returns a C-string.  These functions are required to convert from external (text) display to internal representation and vice versa. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Some type parameters from the DBMS side: <br><ul><li>  <i>internallength</i> - the size of the internal representation </li><li>  <i>alignment</i> - alignment, valid values ‚Äã‚Äã1, 2, 4, 8 bytes </li><li>  <i>storage</i> - <i>storage</i> selection, plain (the only possible option for types with a fixed size) for storage without compression, extended allows compression and movement outside the table row where the type is declared, main allows compression but prohibits movement </li><li>  <i>receive</i> - <i>receive</i> function for binary input / output </li><li>  <i>send</i> - <i>send</i> function for binary input / output </li></ul><br>  In the source file <i>math3d.c, we define the vector3</i> type, text input / output functions, and binary input / output functions for this type: <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;postgres.h&gt; #include &lt;fmgr.h&gt; #include &lt;libpq/pqformat.h&gt; #include &lt;math.h&gt; #ifdef PG_MODULE_MAGIC PG_MODULE_MAGIC; #endif typedef struct { double x, y, z; } vector3; PG_FUNCTION_INFO_V1(vector3_in); PG_FUNCTION_INFO_V1(vector3_out); PG_FUNCTION_INFO_V1(vector3_recv); PG_FUNCTION_INFO_V1(vector3_send); Datum vector3_in(PG_FUNCTION_ARGS) { char *s = PG_GETARG_CSTRING(0); vector3 *v = (vector3*)palloc(sizeof(vector3)); if (sscanf(s, "(%lf,%lf,%lf)", &amp;(v-&gt;x), &amp;(v-&gt;y), &amp;(v-&gt;z)) != 3) { ereport(ERROR, (errcode(ERRCODE_INVALID_TEXT_REPRESENTATION), errmsg("Invalid input syntax for vector3: \"%s\"", s))); } PG_RETURN_POINTER(v); } Datum vector3_out(PG_FUNCTION_ARGS) { vector3 *v = (vector3*)PG_GETARG_POINTER(0); char *s = (char*)palloc(100); snprintf(s, 100, "(%lf,%lf,%lf)", v-&gt;x, v-&gt;y, v-&gt;z); PG_RETURN_CSTRING(s); } Datum vector3_recv(PG_FUNCTION_ARGS) { StringInfo buffer = (StringInfo)PG_GETARG_POINTER(0); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = pq_getmsgfloat8(buffer); v-&gt;y = pq_getmsgfloat8(buffer); v-&gt;z = pq_getmsgfloat8(buffer); PG_RETURN_POINTER(v); } Datum vector3_send(PG_FUNCTION_ARGS) { vector3 *v = (vector3*)PG_GETARG_POINTER(0); StringInfoData buffer; pq_begintypsend(&amp;buffer); pq_sendfloat8(&amp;buffer, v-&gt;x); pq_sendfloat8(&amp;buffer, v-&gt;y); pq_sendfloat8(&amp;buffer, v-&gt;z); PG_RETURN_BYTEA_P(pq_endtypsend(&amp;buffer)); }</span></span></span></span></code> </pre> <br>  We agree that the textual representation of the vector3 type will be in the form "(x, y, z)", where x, y, z, in fact, are the components of the vector.  In the <i>vector3_in</i> function, the components of the vector are extracted from the argument, of type C-string, using sscanf and the created vector (or more precisely, a pointer to it) is returned as the result of the function.  In <i>vector3_out</i> , the reverse action occurs - the vector is converted into a string and returned. <br><br>  Now let's go to the console, build the dynamically loadable math3d library and place it in the $ libdir directory (you can find out by running the <i>pg_config --pkglibdir command</i> ): <br><pre> <code class="bash hljs">cc -I/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/pgsql/include/server -fpic -c math3d.c cc -shared -L/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/pgsql/lib -lpq -o math3d.so math3d.o cp math3d.so /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/pgsql/lib/</code> </pre><br>  Now, let's create the vector3 type in the database: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> vector3; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_in ( s cstring ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_in'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_out ( v vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> cstring <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_out'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_recv ( p internal ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_recv'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_send ( v vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> bytea <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_send'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> vector3 ( internallength = <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> = vector3_in, <span class="hljs-keyword"><span class="hljs-keyword">output</span></span> = vector3_out, receive = vector3_recv, send = vector3_send );</code> </pre><br>  Note that you first need to declare a type in order to be able to create input and output functions.  When determining the type, we specify the size of the internal representation and the functions for input / output from the parameters. <br><br>  Perform a test query: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'(0.0,1.0,0.0)'</span></span>::vector3; <span class="hljs-comment"><span class="hljs-comment">-- (0.000000,1.000000,0.000000)   vector3</span></span></code> </pre><br><h4>  <b>Vector operations</b> </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/f47/258/47f/f4725847fa6e1407b0cf23be92090288.jpg"><br>  The type is created, but it is more than a cast to a textual view and vice versa, it is not yet capable.  We will make it more functional by expanding it with the required operations: <br><br><div class="spoiler">  <b class="spoiler_title">Implementing operations in math3d.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs">PG_FUNCTION_INFO_V1(vector3_minus); <span class="hljs-comment"><span class="hljs-comment">//   PG_FUNCTION_INFO_V1(vector3_add); //   PG_FUNCTION_INFO_V1(vector3_sub); //   PG_FUNCTION_INFO_V1(vector3_mul_left); //     PG_FUNCTION_INFO_V1(vector3_mul_right); //     PG_FUNCTION_INFO_V1(vector3_div_left); //     PG_FUNCTION_INFO_V1(vector3_div_right); //     PG_FUNCTION_INFO_V1(vector3_equal); //     PG_FUNCTION_INFO_V1(vector3_not_equal); //     PG_FUNCTION_INFO_V1(vector3_dot); //   PG_FUNCTION_INFO_V1(vector3_cross); //   PG_FUNCTION_INFO_V1(vector3_length); //   PG_FUNCTION_INFO_V1(vector3_normalize); //   PG_FUNCTION_INFO_V1(vector3_distance); //    Datum vector3_minus(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = -v0-&gt;x; v-&gt;y = -v0-&gt;y; v-&gt;z = -v0-&gt;z; PG_RETURN_POINTER(v); } Datum vector3_add(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;x + v1-&gt;x; v-&gt;y = v0-&gt;y + v1-&gt;y; v-&gt;z = v0-&gt;z + v1-&gt;z; PG_RETURN_POINTER(v); } Datum vector3_sub(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;x - v1-&gt;x; v-&gt;y = v0-&gt;y - v1-&gt;y; v-&gt;z = v0-&gt;z - v1-&gt;z; PG_RETURN_POINTER(v); } Datum vector3_mul_left(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); double k = PG_GETARG_FLOAT8(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;x * k; v-&gt;y = v0-&gt;y * k; v-&gt;z = v0-&gt;z * k; PG_RETURN_POINTER(v); } Datum vector3_mul_right(PG_FUNCTION_ARGS) { double k = PG_GETARG_FLOAT8(0); vector3 *v0 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = k * v0-&gt;x; v-&gt;y = k * v0-&gt;y; v-&gt;z = k * v0-&gt;z; PG_RETURN_POINTER(v); } Datum vector3_div_left(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); double k = PG_GETARG_FLOAT8(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;x / k; v-&gt;y = v0-&gt;y / k; v-&gt;z = v0-&gt;z / k; PG_RETURN_POINTER(v); } Datum vector3_div_right(PG_FUNCTION_ARGS) { double k = PG_GETARG_FLOAT8(0); vector3 *v0 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = k / v0-&gt;x; v-&gt;y = k / v0-&gt;y; v-&gt;z = k / v0-&gt;z; PG_RETURN_POINTER(v); } Datum vector3_equal(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); bool equal = true; equal &amp;= v0-&gt;x == v1-&gt;x; equal &amp;= v0-&gt;y == v1-&gt;y; equal &amp;= v0-&gt;z == v1-&gt;z; PG_RETURN_BOOL(equal); } Datum vector3_not_equal(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); bool not_equal = false; not_equal |= v0-&gt;x != v1-&gt;x; not_equal |= v0-&gt;y != v1-&gt;y; not_equal |= v0-&gt;z != v1-&gt;z; PG_RETURN_BOOL(not_equal); } Datum vector3_dot(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); double r = v0-&gt;x * v1-&gt;x + v0-&gt;y * v1-&gt;y + v0-&gt;z * v1-&gt;z; PG_RETURN_FLOAT8(r); } Datum vector3_cross(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;y * v1-&gt;z - v0-&gt;z * v1-&gt;y; v-&gt;y = v0-&gt;z * v1-&gt;x - v0-&gt;x * v1-&gt;z; v-&gt;z = v0-&gt;x * v1-&gt;y - v0-&gt;y * v1-&gt;x; PG_RETURN_POINTER(v); } Datum vector3_length(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); double len = sqrt(v0-&gt;x * v0-&gt;x + v0-&gt;y * v0-&gt;y + v0-&gt;z * v0-&gt;z); PG_RETURN_FLOAT8(len); } Datum vector3_normalize(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v = (vector3*)palloc(sizeof(vector3)); double len = sqrt(v0-&gt;x * v0-&gt;x + v0-&gt;y * v0-&gt;y + v0-&gt;z * v0-&gt;z); if (len &gt; 0.000001) { v-&gt;x = v0-&gt;y / len; v-&gt;y = v0-&gt;z / len; v-&gt;z = v0-&gt;x / len; } else { v-&gt;x = 0.0; v-&gt;y = 0.0; v-&gt;z = 0.0; } PG_RETURN_POINTER(v); } Datum vector3_distance(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;x - v1-&gt;x; v-&gt;y = v0-&gt;y - v1-&gt;y; v-&gt;z = v0-&gt;z - v1-&gt;z; double len = sqrt(v-&gt;x * v-&gt;x + v-&gt;y * v-&gt;y + v-&gt;z * v-&gt;z); pfree(v); PG_RETURN_FLOAT8(len); }</span></span></code> </pre><br></div></div><br>  Let me remind you that <i>palloc</i> should be used for memory allocation, for freeing, respectively <i>pfree</i> .  Why couples of functions vector3_mul_left / vector3_mul_right and vector3_div_left / vector3_div_right are needed will be explained further. <br><br>  Let's rebuild the math3d.so library and create these functions in the database, in a new session, so that the <b>PostgreSQL</b> server loads the new version of the library: <br><br><div class="spoiler">  <b class="spoiler_title">SQL code for creating operations</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_minus ( v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_minus'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_add ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_add'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_sub ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_sub'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_mul_left ( v0 vector3, k <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_mul_left'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_mul_right ( k <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_mul_right'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_div_left ( v0 vector3, k <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_div_left'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_div_right ( k <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_div_right'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_equal ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_equal'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_not_equal ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_not_equal'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_dot ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_dot'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_cross ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_cross'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> ( v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_length'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> normalize ( v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_normalize'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> distance ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'math3d'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_distance'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>;</code> </pre><br></div></div><br>  Now you can do different operations on the vector: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> vector3_add ( <span class="hljs-string"><span class="hljs-string">'(0.0,1.0,0.0)'</span></span>::vector3, <span class="hljs-string"><span class="hljs-string">'(0.5,0.5,0.0)'</span></span>::vector3 ); <span class="hljs-comment"><span class="hljs-comment">-- (0.500000,1.500000,0.000000) SELECT vector3_mul_right ( 5.0, '(0.2,0.2,1.33)'::vector3 ); -- (1.000000,1.000000,6.650000) SELECT vector3_cross ( '(1.0,0.0,0.0)'::vector3, '(0.0,1.0,0.0)'::vector3 ); -- (0.000000,0.000000,1.000000) SELECT length ( '(0.705,0.705,0.0)'::vector3 ); -- 0.9970206</span></span></code> </pre><br>  The functionality is available, but it doesn‚Äôt look very good, for example, to multiply a scalar by a vector, the record 5.0 * '(0.2.0.2,1.33)' :: vector3 would be more intuitive.  Let's define operators for this. <br><br><h4>  <b>User Operators</b> </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/f4e/a07/4c8/f4ea074c8384374f468328696935753b.jpg"><br>  <b>PostgreSQL</b> has the ability to define its own <a href="http://www.postgresql.org/docs/9.3/static/sql-createoperator.html">operators</a> using a sequence of characters + - * / &lt;&gt; = ~!  @ #% ^ &amp; |  `?  with a maximum length of 63. They are unary or binary.  You can create overloaded operators that have the same name but different arguments.  Here are some important operator parameters (for unary operators, you only need to specify <i>leftarg</i> or <i>rightarg</i> ): <br><ul><li>  <i>leftarg</i> - the type of the left argument </li><li>  <i>rightarg</i> - the type of the right argument </li><li>  <i>procedure</i> is a function that has one (unary operator) or two parameters (binary operator) with types that correspond to the <i>leftarg</i> and <i>rightarg</i> operator </li><li>  <i>commutator</i> - the hint to the optimizer that the expression <i>x A y is</i> equivalent to <i>y B x</i> , where A is the operator being declared, B is the operator for <i>commutator</i> </li><li>  <i>negator</i> is a hint to the optimizer that the expression <i>x A y is</i> equivalent <i>! (x B y)</i> , where A is the operator being declared, B is the operator for <i>negator</i> and both operators must return boolean </li></ul><br>  Create several statements: <br><div class="spoiler">  <b class="spoiler_title">SQL code to create statements</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   CREATE OPERATOR - ( rightarg = vector3, procedure = vector3_minus ); --   CREATE OPERATOR + ( leftarg = vector3, rightarg = vector3, procedure = vector3_add, commutator = + ); --   CREATE OPERATOR - ( leftarg = vector3, rightarg = vector3, procedure = vector3_sub ); --     CREATE OPERATOR * ( leftarg = vector3, rightarg = double precision, procedure = vector3_mul_left ); --     CREATE OPERATOR * ( leftarg = double precision, rightarg = vector3, procedure = vector3_mul_right ); --     CREATE OPERATOR / ( leftarg = vector3, rightarg = double precision, procedure = vector3_div_left ); --     CREATE OPERATOR / ( leftarg = double precision, rightarg = vector3, procedure = vector3_div_right ); --     CREATE OPERATOR = ( leftarg = vector3, rightarg = vector3, procedure = vector3_equal ); --     CREATE OPERATOR != ( leftarg = vector3, rightarg = vector3, procedure = vector3_not_equal ); --   CREATE OPERATOR * ( leftarg = vector3, rightarg = vector3, procedure = vector3_dot commutator = ); --   CREATE OPERATOR ** ( leftarg = vector3, rightarg = vector3, procedure = vector3_cross );</span></span></code> </pre><br></div></div><br>  And check their performance: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'(0.0,1.0,0.0)'</span></span>::vector3 + <span class="hljs-string"><span class="hljs-string">'(0.5,0.5,0.0)'</span></span>::vector3; <span class="hljs-comment"><span class="hljs-comment">-- (0.500000,1.500000,0.000000) SELECT 5.0 * '(0.2,0.2,1.33)'::vector3; -- (1.000000,1.000000,6.650000) SELECT '(1.0,0.5,0.1)'::vector3 * '(0.707,0.707,0.707)'::vector3; -- 1.1312 SELECT '(1.0,0.0,0.0)'::vector3 ** '(0.0,1.0,0.0)'::vector3; -- (0.000000,0.000000,1.000000)</span></span></code> </pre><br>  Already better.  By the way, we have declared two operators for multiplication with a scalar type argument, for the case when the scalar is on the left of the operator and when it is on the right.  And likewise for division.  Therefore, we needed a pair of functions vector3_mul_left / vector3_mul_right and vector3_div_left / vector3_div_right. <br><br>  The question may arise: how to get access to the components of the vector?  One could declare three C functions vector3_x, vector3_y and vector3_z, which would return each component, but there is a better way. <br><br><h4>  <b>Cast</b> </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/e1b/751/a03/e1b751a0327a55748ab568a7adf88a16.jpg"><br>  Another notable feature in <b>PostgreSQL</b> is the creation of <a href="http://www.postgresql.org/docs/9.3/static/sql-createcast.html">custom</a> type casting.  If both types have the same internal representation (for example, varchar and text), then there is no need for a function for type conversion.  Otherwise, this function must be defined.  It must return the type to which the conversion occurs and can have from one to three parameters: <br><ul><li>  <i>type which is given</i> </li><li>  <i>integer</i> - the modifier associated with the type to which the cast occurs or -1 </li><li>  <i>boolean</i> - true if the cast is explicit, false otherwise </li></ul><br>  A cast can participate only in an assignment context or in any context.  This behavior is indicated by the AS ASSIGNMENT and AS IMPLICIT parameters.  The WITH INOUT parameter instructs to use input / output functions for the cast. <br><br>  Define a new vector3c composite type and cast vector3 to it (and vice versa): <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> vector3c <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( x <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, y <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, z <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_cast_vector3c ( v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3c <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> s <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>[]; v vector3c; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> s := string_to_array ( <span class="hljs-keyword"><span class="hljs-keyword">trim</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">BOTH</span></span> <span class="hljs-string"><span class="hljs-string">'()'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> v0::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span> ), <span class="hljs-string"><span class="hljs-string">','</span></span> ); vx := s[1]; vy := s[2]; vz := s[3]; RETURN v; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plpgsql IMMUTABLE; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3c_cast_vector3 ( v0 vector3c ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> v vector3; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> v := v0::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>; RETURN v; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plpgsql IMMUTABLE; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span> ( vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> vector3c ) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_cast_vector3c ( v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> IMPLICIT; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span> ( vector3c <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3c_cast_vector3 ( v0 vector3c ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> IMPLICIT;</code> </pre><br>  In the <i>vector3_cast_vector3c</i> function <i>,</i> we first cast vector3 to the text, remove the first and last brackets, and then, using a comma separator, convert to an array of three elements, from which we take the components of the vector.  In <i>vector3c_cast_vector3</i> , for clarity, you can immediately convert vector3c to text and then result in vector3 (the text view for vector3c and vector3 has the same look). <br><br>  Check the type conversion: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (<span class="hljs-string"><span class="hljs-string">'(0.1,1.0,0.5)'</span></span>::vector3)::vector3c; <span class="hljs-comment"><span class="hljs-comment">-- (0.1,1,0.5) SELECT ('(0.707,0.0,0.0)'::vector3c)::vector3; -- (0.707000,0.000000,0.000000)</span></span></code> </pre><br><br><h4>  <b>Creating an extension</b> </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/5d7/86e/9e0/5d786e9e06a3aa079318f3766c355d34.jpg"><br>  When everything is ready and tested, it remains to wrap our library in the extension.  Collect all C-code in one file: <br><div class="spoiler">  <b class="spoiler_title">The math3d.c file (source C-code of the dynamically loaded extension library math3d)</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;postgres.h&gt; #include &lt;fmgr.h&gt; #include &lt;libpq/pqformat.h&gt; #include &lt;math.h&gt; #ifdef PG_MODULE_MAGIC PG_MODULE_MAGIC; #endif // types typedef struct { double x, y, z; } vector3; // declarations PG_FUNCTION_INFO_V1(vector3_in); PG_FUNCTION_INFO_V1(vector3_out); PG_FUNCTION_INFO_V1(vector3_recv); PG_FUNCTION_INFO_V1(vector3_send); PG_FUNCTION_INFO_V1(vector3_minus); PG_FUNCTION_INFO_V1(vector3_add); PG_FUNCTION_INFO_V1(vector3_sub); PG_FUNCTION_INFO_V1(vector3_mul_left); PG_FUNCTION_INFO_V1(vector3_mul_right); PG_FUNCTION_INFO_V1(vector3_div_left); PG_FUNCTION_INFO_V1(vector3_div_right); PG_FUNCTION_INFO_V1(vector3_equal); PG_FUNCTION_INFO_V1(vector3_not_equal); PG_FUNCTION_INFO_V1(vector3_dot); PG_FUNCTION_INFO_V1(vector3_cross); PG_FUNCTION_INFO_V1(vector3_length); PG_FUNCTION_INFO_V1(vector3_normalize); PG_FUNCTION_INFO_V1(vector3_distance); // implementation Datum vector3_in(PG_FUNCTION_ARGS) { char *s = PG_GETARG_CSTRING(0); vector3 *v = (vector3*)palloc(sizeof(vector3)); if (sscanf(s, "(%lf,%lf,%lf)", &amp;(v-&gt;x), &amp;(v-&gt;y), &amp;(v-&gt;z)) != 3) { ereport(ERROR, (errcode(ERRCODE_INVALID_TEXT_REPRESENTATION), errmsg("Invalid input syntax for vector3: \"%s\"", s))); } PG_RETURN_POINTER(v); } Datum vector3_out(PG_FUNCTION_ARGS) { vector3 *v = (vector3*)PG_GETARG_POINTER(0); char *s = (char*)palloc(100); snprintf(s, 100, "(%lf,%lf,%lf)", v-&gt;x, v-&gt;y, v-&gt;z); PG_RETURN_CSTRING(s); } Datum vector3_recv(PG_FUNCTION_ARGS) { StringInfo buffer = (StringInfo)PG_GETARG_POINTER(0); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = pq_getmsgfloat8(buffer); v-&gt;y = pq_getmsgfloat8(buffer); v-&gt;z = pq_getmsgfloat8(buffer); PG_RETURN_POINTER(v); } Datum vector3_send(PG_FUNCTION_ARGS) { vector3 *v = (vector3*)PG_GETARG_POINTER(0); StringInfoData buffer; pq_begintypsend(&amp;buffer); pq_sendfloat8(&amp;buffer, v-&gt;x); pq_sendfloat8(&amp;buffer, v-&gt;y); pq_sendfloat8(&amp;buffer, v-&gt;z); PG_RETURN_BYTEA_P(pq_endtypsend(&amp;buffer)); } Datum vector3_minus(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = -v0-&gt;x; v-&gt;y = -v0-&gt;y; v-&gt;z = -v0-&gt;z; PG_RETURN_POINTER(v); } Datum vector3_add(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;x + v1-&gt;x; v-&gt;y = v0-&gt;y + v1-&gt;y; v-&gt;z = v0-&gt;z + v1-&gt;z; PG_RETURN_POINTER(v); } Datum vector3_sub(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;x - v1-&gt;x; v-&gt;y = v0-&gt;y - v1-&gt;y; v-&gt;z = v0-&gt;z - v1-&gt;z; PG_RETURN_POINTER(v); } Datum vector3_mul_left(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); double k = PG_GETARG_FLOAT8(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;x * k; v-&gt;y = v0-&gt;y * k; v-&gt;z = v0-&gt;z * k; PG_RETURN_POINTER(v); } Datum vector3_mul_right(PG_FUNCTION_ARGS) { double k = PG_GETARG_FLOAT8(0); vector3 *v0 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = k * v0-&gt;x; v-&gt;y = k * v0-&gt;y; v-&gt;z = k * v0-&gt;z; PG_RETURN_POINTER(v); } Datum vector3_div_left(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); double k = PG_GETARG_FLOAT8(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;x / k; v-&gt;y = v0-&gt;y / k; v-&gt;z = v0-&gt;z / k; PG_RETURN_POINTER(v); } Datum vector3_div_right(PG_FUNCTION_ARGS) { double k = PG_GETARG_FLOAT8(0); vector3 *v0 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = k / v0-&gt;x; v-&gt;y = k / v0-&gt;y; v-&gt;z = k / v0-&gt;z; PG_RETURN_POINTER(v); } Datum vector3_equal(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); bool equal = true; equal &amp;= v0-&gt;x == v1-&gt;x; equal &amp;= v0-&gt;y == v1-&gt;y; equal &amp;= v0-&gt;z == v1-&gt;z; PG_RETURN_BOOL(equal); } Datum vector3_not_equal(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); bool not_equal = false; not_equal |= v0-&gt;x != v1-&gt;x; not_equal |= v0-&gt;y != v1-&gt;y; not_equal |= v0-&gt;z != v1-&gt;z; PG_RETURN_BOOL(not_equal); } Datum vector3_dot(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); double r = v0-&gt;x * v1-&gt;x + v0-&gt;y * v1-&gt;y + v0-&gt;z * v1-&gt;z; PG_RETURN_FLOAT8(r); } Datum vector3_cross(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;y * v1-&gt;z - v0-&gt;z * v1-&gt;y; v-&gt;y = v0-&gt;z * v1-&gt;x - v0-&gt;x * v1-&gt;z; v-&gt;z = v0-&gt;x * v1-&gt;y - v0-&gt;y * v1-&gt;x; PG_RETURN_POINTER(v); } Datum vector3_length(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); double len = sqrt(v0-&gt;x * v0-&gt;x + v0-&gt;y * v0-&gt;y + v0-&gt;z * v0-&gt;z); PG_RETURN_FLOAT8(len); } Datum vector3_normalize(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v = (vector3*)palloc(sizeof(vector3)); double len = sqrt(v0-&gt;x * v0-&gt;x + v0-&gt;y * v0-&gt;y + v0-&gt;z * v0-&gt;z); if (len &gt; 0.000001) { v-&gt;x = v0-&gt;y / len; v-&gt;y = v0-&gt;z / len; v-&gt;z = v0-&gt;x / len; } else { v-&gt;x = 0.0; v-&gt;y = 0.0; v-&gt;z = 0.0; } PG_RETURN_POINTER(v); } Datum vector3_distance(PG_FUNCTION_ARGS) { vector3 *v0 = (vector3*)PG_GETARG_POINTER(0); vector3 *v1 = (vector3*)PG_GETARG_POINTER(1); vector3 *v = (vector3*)palloc(sizeof(vector3)); v-&gt;x = v0-&gt;x - v1-&gt;x; v-&gt;y = v0-&gt;y - v1-&gt;y; v-&gt;z = v0-&gt;z - v1-&gt;z; double len = sqrt(v-&gt;x * v-&gt;x + v-&gt;y * v-&gt;y + v-&gt;z * v-&gt;z); pfree(v); PG_RETURN_FLOAT8(len); }</span></span></span></span></code> </pre><br></div></div><br>  We compile the dynamically loaded library itself and place it in the PGDIR / lib directory.  Similarly, create a file with SQL code: <br><div class="spoiler">  <b class="spoiler_title">File math3d - 1.0.sql (SQL script for math3d extension)</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> vector3; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_in ( s cstring ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_in'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_out ( v vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> cstring <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_out'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_recv ( p internal ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_recv'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_send ( v vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> bytea <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_send'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> vector3 ( internallength = <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> = vector3_in, <span class="hljs-keyword"><span class="hljs-keyword">output</span></span> = vector3_out, receive = vector3_recv, send = vector3_send ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_minus ( v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_minus'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPERATOR</span></span> - ( rightarg = vector3, <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> = vector3_minus ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_add ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_add'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPERATOR</span></span> + ( leftarg = vector3, rightarg = vector3, <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> = vector3_add, commutator = + ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_sub ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_sub'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPERATOR</span></span> - ( leftarg = vector3, rightarg = vector3, <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> = vector3_sub ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_mul_left ( v0 vector3, k <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_mul_left'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPERATOR</span></span> * ( leftarg = vector3, rightarg = <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> = vector3_mul_left, commutator = * ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_mul_right ( k <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_mul_right'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPERATOR</span></span> * ( leftarg = <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, rightarg = vector3, <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> = vector3_mul_right, commutator = * ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_div_left ( v0 vector3, k <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_div_left'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPERATOR</span></span> / ( leftarg = vector3, rightarg = <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> = vector3_div_left ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_div_right ( k <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_div_right'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPERATOR</span></span> / ( leftarg = <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, rightarg = vector3, <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> = vector3_div_right ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_equal ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_equal'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPERATOR</span></span> = ( leftarg = vector3, rightarg = vector3, <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> = vector3_equal ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_not_equal ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_not_equal'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPERATOR</span></span> != ( leftarg = vector3, rightarg = vector3, <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> = vector3_not_equal ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_dot ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_dot'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPERATOR</span></span> * ( leftarg = vector3, rightarg = vector3, <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> = vector3_dot, commutator = * ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_cross ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_cross'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPERATOR</span></span> ** ( leftarg = vector3, rightarg = vector3, <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> = vector3_cross, commutator = ** ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> ( v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_length'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> normalize ( v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_normalize'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> distance ( v0 vector3, v1 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'MODULE_PATHNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'vector3_distance'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C IMMUTABLE <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> vector3c <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( x <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, y <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, z <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_cast_vector3c ( v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3c <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> s <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>[]; v vector3c; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> s := string_to_array ( <span class="hljs-keyword"><span class="hljs-keyword">trim</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">BOTH</span></span> <span class="hljs-string"><span class="hljs-string">'()'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> v0::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span> ), <span class="hljs-string"><span class="hljs-string">','</span></span> ); vx := s[1]; vy := s[2]; vz := s[3]; RETURN v; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plpgsql IMMUTABLE; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3c_cast_vector3 ( v0 vector3c ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> v vector3; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> v := v0::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>; RETURN v; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plpgsql IMMUTABLE; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span> ( vector3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> vector3c ) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3_cast_vector3c ( v0 vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> IMPLICIT; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span> ( vector3c <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> vector3 ) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> vector3c_cast_vector3 ( v0 vector3c ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> IMPLICIT;</code> </pre><br></div></div><br>  The file name should be in the form &lt;extension_name&gt; - &lt;version&gt; .sql.  The version we will have is 1.0.  Place this file in the PGDIR / share / extension directory.  Notice that the name of the dynamically loaded library in the function declarations has changed to the variable MODULE_PATHNAME, which will be declared in the extension control file.  Create this file: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># math3d extension comment = '3D mathematics' default_version = '1.0' module_pathname = '$libdir/math3d' relocatable = true</span></span></code> </pre><br>  Among the options available are the following: <br><ul><li>  <i>default_version</i> - default version </li><li>  <i>comment</i> - comment </li><li>  <i>encoding</i> - script encoding if database encoding is not specified </li><li>  <i>module_pathname</i> is the name of the dynamically loaded library (it is inserted into the MODULE_PATHNAME variable in the script) </li><li>  <i>requires</i> - a list of extensions that the current one depends on </li><li>  <i>relocatable</i> - if true, the extension is not tied to a specific scheme and objects, after creation, can be moved to another scheme (false by default) </li><li>  <i>schema</i> - the schema in which extension objects are created (parameter has value if <i>relocatable is</i> set to false) </li></ul><br>  The name of the control file should be in the form &lt;extension_name&gt; .control, in this case math3d.control.  Place it in the directory PGDIR / share / extension.  In principle, the extension is ready for use. <br><br>  Create a new database, connect to it and load our extension: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION math3d;</code> </pre><br>  If there are no problems, you can use our new type vector3 - declare as a field of a table or a composite type, use functions in parameters and in other places.  Deleting an extension and dependent objects is done in the same way: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> EXTENSION math3d;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An extension may contain configuration tables that are modified after the extension is installed. Since ordinary tables created in the extension script and its data do not fall into the dump, the configuration tables must be specially marked:</font></font><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> user_setting ( username <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pg_catalog.pg_extension_config_dump ( <span class="hljs-string"><span class="hljs-string">'user_setting'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span> );</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second parameter pg_catalog.pg_extension_config_dump can contain a condition that filters the data falling into the dump, for example, 'WHERE username =' 'administrator' ''. </font><font style="vertical-align: inherit;">In our case, there is no need for configuration tables. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When upgrading an extension to a newer version, a script is created that has a name in the form &lt;extension_name&gt; - &lt;old_version&gt; - &lt;new_version&gt; .sql, which contains SQL commands for updating. </font><font style="vertical-align: inherit;">If we wanted to update math3d to version 1.1, we would need to create the file math3d - 1.0--1.1.sql and execute the SQL command in the database:</font></font><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> EXTENSION math3d <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> <span class="hljs-string"><span class="hljs-string">'1.1'</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The remaining commands for changing the extension (described in more detail </font></font><a href="http://www.postgresql.org/docs/9.3/static/sql-alterextension.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> EXTENSION &lt;_&gt; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SCHEMA</span></span> &lt; &gt;; <span class="hljs-comment"><span class="hljs-comment">--      ALTER EXTENSION &lt;_&gt; ADD &lt;&gt;; --     ALTER EXTENSION &lt;_&gt; DROP &lt;&gt;; --    </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Another good thing about an extension is that you can't accidentally delete an object that is part of an extension with a normal command (DROP TABLE, DROP FUNCTION, etc.). </font></font><br><br><h4>  <b>Conclusion</b> </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/851/8e2/2ce/8518e22ce7dfed64eab826028f5cdbaf.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If your database actively uses functionality based on stored functions and updatable views, it can be extended to an extension, getting some separation from other objects in the database and simplifying extensibility. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS Thank you for your attention.</font></font><br><br>  References: <br><ul><li> <a href="http://www.postgresql.org/docs/9.3/static"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Official Documentation</font></font></a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/198332/">https://habr.com/ru/post/198332/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198320/index.html">Creating a 1k / 4k intro for Linux, part 4</a></li>
<li><a href="../198322/index.html">Do you want to distribute elements, tied to their number, on the same styles? Yes, easily</a></li>
<li><a href="../198324/index.html">Nvidia announced full support for Linux on equal terms</a></li>
<li><a href="../198328/index.html">Dependency Injection in Objective-C with Magic and Blood</a></li>
<li><a href="../198330/index.html">6 tips for creating complex AJAX sites</a></li>
<li><a href="../198336/index.html">Apogee: Man Orchestra and Online Game Publisher 1987 (continued)</a></li>
<li><a href="../198338/index.html">Using the Haar cascade to compare images</a></li>
<li><a href="../198340/index.html">Standard charge for laptops</a></li>
<li><a href="../198346/index.html">Twitter Bootstrap 3 Compilation</a></li>
<li><a href="../198350/index.html">Apple will replace 64 and 128GB SSD for MacBook Air mid 2012 for free</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>