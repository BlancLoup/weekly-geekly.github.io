<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IoT cloud on Netty or 10k rec-sec per core</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. This post is about a server solution for the Internet of things, which I wrote on asynchronous sockets using the well-known Netty. I will talk ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IoT cloud on Netty or 10k rec-sec per core</h1><div class="post__text post__text-html js-mediator-article">  Hello.  This post is about a server solution for the Internet of things, which I wrote on asynchronous sockets using the well-known Netty.  I will talk about the task we set for ourselves, why I chose Netty, why it doesn‚Äôt have alternatives, what Netty‚Äôs disadvantages and advantages are and how to get the most out of it.  Now our server processes an average of 1.5 billion messages per month and the load is growing by 20% every month.  To attract attention - the load on one production server with 4 cores Xeon¬Æ CPU E5-2630L v2 @ 2.40GHz with a load of 500 rec-sec. <br><br><img src="https://habrastorage.org/files/2f2/4bd/bf6/2f24bdbf6abc4e94a049587dea7bc761.png" alt="Blynk load - to attract attention"><br><br>  So let's go. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It all started about 2 years ago, when they gave me an arduino.  I always wanted to do some interesting device with my own hands.  But all these soldering irons, resistors, volts-amps constantly scared me.  So it was, until arduino appeared.  With Arduina, I was finally able to control the electronics.  To say that it was very cool to say nothing.  I was happy.  But, as is often the case, after mastering the basic skills in microcontrollers, I wanted more - to control devices via the Internet from the phone.  Fast googling showed (it was 2 years ago) that currently there is not a single solution that would solve this problem.  Not counting the IoT cloud with HTTP API, which was not very convenient to use. <br><br>  Fortunately, I was not alone.  Quite by chance, in my work, I met people who were concerned about the same problems.  So our project appeared. <br><a name="habracut"></a><br><h2>  Problem </h2><br>  Remotely, the task was clear - control Arduina via the Internet from a mobile or tablet.  Well, for example, to be able to change the color of the skirt below. <br><img src="https://habrastorage.org/files/d74/75a/f5e/d7475af5ec2640df8eaec06cb2c8e5c2.png"><br><br>  At that stage, there were no more obvious and clear requirements.  After a brief discussion and analysis, we outlined several important points that the project architecture should provide: <br><br><h4>  Many parallel connections </h4><br>  I do not consider myself a geek.  But already then I had 2 arduinks, 2 phones and a tablet, which I would like to use for control.  A small survey among acquaintances showed that the average hardware vendor has 3-4 microcontrollers.  It became quite obvious that one potential user of our system can easily open 5-10 connections from different devices.  That is, the server must simultaneously handle thousands of parallel connections, even for several hundred users. <br><br><h4>  Pushing / polling </h4><br>  Despite its little experience with microcontrollers, it was obvious that the server solution should support 2 client operation modes - pushing and polling.  That is, the mobile client must be able to request a status from the piece of iron and, on its part, the piece of hardware should be able to send a message at any time and the mobile client to receive it. <br><br><h4>  Multi-protocol support </h4><br>  It was difficult to choose a protocol.  I really wanted to go the old trodden path - HTTP.  But HTTP has several architectural problems.  The minimum possible packet is 26 bytes (excluding TCP / IP headers), but in real life the minimum packet will be at least 50 bytes, and considering the weak capabilities of microcontrollers (for Arduino UNO, for example, 2kb RAM and 16 MHz processor) and a short battery life seemed superfluous.  Well, if with http poling, everything is fine, then web-scokets are needed with pushing, and this is essentially good old TCP / IP.  Among hardwarders, the MQTT protocol is very popular.  But I also refused it.  He seemed too sophisticated to me.  Yes, it was thought out for all occasions.  But then we did not need it.  Therefore, the server had to support at least several protocols so that we could switch to the necessary one if our choice were not correct. <br><br><h4>  Simplicity </h4><br>  Since we initially did the project for ourselves, one of the main conditions was the simplicity of setup and deployment.  So that even a completely new person, without any skills, could easily and within a few minutes begin to manage his piece of iron and, if necessary, could just as easily and easily deploy a server. <br><br><h2>  Choosing a solution </h2><br>  A little thought, it was decided to use asynchronous sockets.  I was guided by 2 factors.  We need to handle many parallel connections, which blocking sockets do not do very well due to the large stack (256kb) in Java and the cost of context switching between threads.  Business logic will be a bit.  After all, you just need to send a message from one socket to another (well, who does not make mistakes).  All the server‚Äôs work essentially comes down to ‚Äútake a message from socket A‚Äù and ‚Äúsend a message to socket B‚Äù + a little business logic from above. <br><br><h4>  What is on the market? </h4><br>  A quick analysis of existing solutions revealed the following: <br><br><ul><li>  Apache MINA is a dead project that has not been developed for a year already 4. </li><li>  Grizzly - I dropped it as I did not find the projects that use it. </li><li>  Xnio - rejected because of the 60 stars on the githaba.  And those, apparently the developers. </li><li>  Vert.x - at that time was positioned as a direct competitor to Netty.  And then he had either a closed or a paid core.  It was 2 years ago and I already forgot the details.  Now the situation has changed.  So maybe it makes sense to look again. </li><li>  Akka is a very interesting thing.  And quite a good solution, I preferred netty for a simple reason - Akka can be built on netty, but not on Akke netty.  Well, the very fact that the distributed actors in Akka use netty, as if it hints.  Well, netty uses thousands of projects around the world including facebook, linkedin and twitter. </li><li>  Netty - the choice is obvious </li></ul><br><img src="https://habrastorage.org/files/6b1/811/c7d/6b1811c7d48e4ce5afef8ea15aecaeef.png"><br><br><h2>  Disadvantages of netty </h2><br>  I've been working with netty for 2 years now.  And I have something to say.  I'll start with the cons. <br><br><h4>  Bad documentation </h4><br>  There is an excellent getting started and everything seems to be fine.  But as soon as you begin to take a step to the left, a step to the right, dozens of questions immediately arise.  There are no answers to which in the documentation and answers to which are scattered throughout the Internet.  Now the situation is much better than it was 2 years ago.  But the problem still remains. <br><br><h4>  Complexity </h4><br>  As an asynchronous framework, Netty makes it easy to work with asynchronous sockets.  Still, with a swoop immediately go to the business logic does not work.  It is necessary to study, understand and rethink many things.  Perhaps in my case it was the result of many years of work with the blocking API.  I do not know.  But I still learn something new about Netty. <br><br><h4>  Too many abstractions </h4><br>  Often, when working with netties, there is a need to look inside the ready handlers to understand how they work.  But the rather large and complex inheritance hierarchy greatly complicates the understanding of the code.  I don‚Äôt know about you, but if the class has a hierarchy of more than 3 levels of nesting, then my stack that is not full is full.  Netty is all saturated with this complex hierarchy.  In addition to everything, netty has its own separate package with 4 different types of buffers that netty uses. <br><br><h4>  Easy to shoot in the leg </h4><br>  At first, it's very easy to shoot yourself with a netty.  A small example: <br><br><pre><code class="java hljs">ByteBuf in ... in.readBytes(length); <span class="hljs-comment"><span class="hljs-comment">//  </span></span></code> </pre> <br><pre> <code class="java hljs">ByteBuf in ... in.readSlice(length); <span class="hljs-comment"><span class="hljs-comment">//  </span></span></code> </pre><br>  It turns out in the 4th netty (I started with the 3rd) by default, direct buffers are used, so you need to carefully monitor the buffers.  The problem of leaks in netty is generally very serious.  As a confirmation, Netty <a href="http://netty.io/wiki/reference-counted-objects.html">has a solution</a> that allows you to track leaks inside the framework.  Although if you use ready handlers (that is, you use ready-made HTTP, MQTT, SPDY, ...) protocols, then you will not encounter this. <br><br><h4>  There are still bugs </h4><br>  Due to its popularity, various kinds of bugs are often found in Netty.  Now on gitkhab open about <a href="https://github.com/netty/netty/issues">280</a> tickets.  I personally ran into 2 that had to start.  Fortunately, with fixes everything happens very quickly. <br><br><h2>  Netty Pros </h2><br>  Now for the good. <br><br><h4>  Full control </h4><br>  With Netty, you have absolutely complete control over the network stack.  And that's cool.  Because you have the opportunity to work in the abstractions of the framework while avoiding the entire complexity of direct work with sockets.  In addition, netty has a bunch of features out of the box that no one offers on the market, for example, the ability to include TCP_FASTOPEN, TCP_MD5SIG, TCP_CORK, SPLICE, support for native Epoll transport, OpenSSL, and a bunch of other things.  And it all works out of the box! <br><br><h4>  Multi-protocol support </h4><br>  TCP, UDP, UDT, SCTP?  Easy.  HTTP, HTTPS, HTTP / 2, SPDY, Memcached, MQTT?  Has already.  Connect any of these protocols for a few tens of minutes.  And all this has long been written, optimized and tested.  An interesting point with HTTP / 2.  He was added to the netty about 3 months ago.  In nginx for example, its support appeared literally 2 weeks ago.  I think it says a lot. <br><br><h4>  Many ready handlers </h4><br>  Need to add SSL?  Please - SslHandler.  Need to compress all traffic?  Choose any - JdkZlibEncoder, ZlibEncoder, SnappyFramedEncoder.  Need to parse Jason on the go?  - JsonObjectDecoder.  Need to close inactive sockets?  Please - ReadTimeoutHandler.  Do you need to completely subtract data from a socket and only then transfer control to the business logic?  - well, you understand ... <br><br><h4>  Fast </h4><br>  100k rek-s per core for simplest HTTP GET?  With netty, <a href="http://www.techempower.com/benchmarks/">this is true</a> . <br><br><img src="https://habrastorage.org/files/b84/0fa/64b/b840fa64bd2e4866a0cb682b0c6fed28.png"><br><br>  Mainly due to the fact that it is used in monsters like Facebook, Twitter, so much attention is paid to optimizations in netty.  Another important factor why netty is fast is the use of direct buffers, which greatly reduces the load on the GC.  In this case, the complexity of managing these buffers takes on netty. <br><br><h4>  No synchronize </h4><br>  One of the reasons why netty is fast is its asynchronous nature, which means that there are virtually no locks inside IO handlers (workers) and no loss when switching context between threads.  The very nature of Netty forces you to write code that must be thread-safe.  Of course, you can hardly avoid synchronization completely, but below I will tell you how to avoid this as much as possible. <br><br><h4>  Great community </h4><br>  To get a ticket and get an answer within an hour is the norm for Netty.  This is very cool and helps a lot in development.  Especially against the background of insufficient documentation.  In general, discussing any question about architecture, performance, or small refactoring is not at all a problem for developers. <br><br>  To be continued‚Ä¶ </div><p>Source: <a href="https://habr.com/ru/post/268895/">https://habr.com/ru/post/268895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268877/index.html">Thematic Cartography: Common Questions</a></li>
<li><a href="../268885/index.html">Manage HP ProLiant servers through open REST APIs or ‚ÄúiLO on steroids‚Äù</a></li>
<li><a href="../268889/index.html">Animate component resizing in Android</a></li>
<li><a href="../268891/index.html">PXE boot Thinstation depending on the hardware of the thin client</a></li>
<li><a href="../268893/index.html">Mastering the Data Science specialty on Coursera: personal experience (part 2)</a></li>
<li><a href="../268897/index.html">Difficulties of "translation"</a></li>
<li><a href="../268899/index.html">The scandal around Volkswagen and the role of programmers in it</a></li>
<li><a href="../268903/index.html">Hibernate Developer Documentation - Chapter V. Locks</a></li>
<li><a href="../268905/index.html">Do-it-yourself audio codec</a></li>
<li><a href="../268907/index.html">Security Week 42: SHA-1 collisions, practical hacking of routers, Android / Security / Sadness</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>