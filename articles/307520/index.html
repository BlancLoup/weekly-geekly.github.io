<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PosCardStealer: new malware and large-scale attacks threaten PoS systems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few weeks ago, we (PandaLabs Anti-Virus Lab) reported on an attack where hundreds of restaurants in the United States suffered, in which a malicious...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PosCardStealer: new malware and large-scale attacks threaten PoS systems</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/6b8/c66/250/6b8c6625017643e281ba094856197f72.jpg"><br><br>  A few weeks ago, we (PandaLabs Anti-Virus Lab) reported on an attack where <a href="https://habrahabr.ru/company/panda/blog/303948/">hundreds of restaurants</a> in the United States suffered, in which a malicious program called PunkeyPOS was used.  We did not report how PunkeyPOS was discovered: in fact, we are investigating a whole series of PoS attacks, which also affect hundreds of bars, restaurants and shops in the United States.  While we were analyzing one of these attacked systems, it was attacked by another cyber gang using PunkeyPOS.  In this article we are going to discuss another attack, which we are still exploring.  In this case, a PoS malware called PosCardStealer was used. <a name="habracut"></a><br><br><h3>  PosCardStealer: New PoS Attack </h3><br>  The first attack, which we were able to analyze, was September 30, 2015, and it affected 30 PoS systems.  The malware was installed using PowerShell, a popular Windows utility.  It was used to execute the file (MD5: 0B4F921CF2537FCED9CAACA179F6DFF4), which had a creation date two days earlier (09/28/2015 17:07:59) and was compiled using C ++. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The job of the installer is to infect the system with a malware program that is specifically designed for PoS systems.  For this, he uses various techniques in the functions of the PoS software installed in the system.  In particular, it searches for brain.exe (related to <a href="http://www.dinerware.com/">Dinerware</a> ) and scpwin.exe processes, and installs malware as follows, depending on which process it finds: <br><br>  ‚Ä¢ <b>brain.exe</b> : in this case, the actual process of the Dinerware program for loading PosCardStealer is performed.  To do this, it modifies a pair of Windows registry keys. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fd0/94b/8f5/fd094b8f5c9141dda44076fc129ee932.png"></div><br>  <b>The installer performs the following actions:</b> <br><br>  <strong>1.</strong> Enables automatic loading of the DLL, causing ENABLE_LOADAPPINIT_DLLS (0x004017A0), and modifies the following registry key: <br><br>  <b>SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Windows LoadAppInit_DLLs = 1</b> <br><br>  <strong>2.</strong> If the previous key was successfully changed, then it will install PosCardStealer to: <br><br>  <b>C: \ Windows \ utils.dll</b> <br><br>  <strong>3.</strong> After that, it calls SET_APPINIT_DLLS (0x00401850) to add a new DLL path to the registry so that it loads automatically: <br><br>  <b>SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Windows AppInit_DLLs = C: \ Windows \ utils.dll</b> <br><br>  <strong>4.</strong> Finally, he launches the PoS software (‚Äúbrain.exe‚Äù) again, which loads the newly installed DLL. <br><br>  ‚Ä¢ <b>scpwin.exe</b> : in this situation it will use a technique known as ‚ÄúDLL hijacking‚Äù.  After finding scpwin.exe in the attacked system, it will copy ‚ÄúCdrvhf32.dll‚Äù (legitimate DLL) from the Windows system folder to the folder where the same application can be found.  It will then modify the copied DLL so that PosCardStealer (utils.dll) can be loaded from there. <br><br>  In the following screenshot, we can see the pseudocode that is responsible for performing this action: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/8d4/7a0/29f/8d47a029f9d04864a23389d9dd6db062.png"></div><br>  <b>Now the procedure performs the following actions:</b> <br><br>  <strong>1.</strong> Verifies that the ‚Äúutils.dll‚Äù or ‚Äúccutils.dll‚Äù files exist in the folder with the PoS software <br>  <strong>2.</strong> If these DLLs are not found, then it changes the ‚Äú% windir% \ system32 \ Cdrvhf32.dll‚Äù and copies the ‚Äúspcwin.exe‚Äù folder. <br>  <strong>3.</strong> If it successfully changed the ‚ÄúCdrvhf32.dll‚Äù library, it will also copy the code of the ‚Äúutils.dll‚Äù malicious library into the ‚Äúspcwin.exe‚Äù folder.  The modified library ‚ÄúCdrvhf32.dll‚Äù has the same functions as the original one, but besides this it is also able to execute ‚Äúadditional‚Äù code: loading the malicious library ‚Äúutils.dll‚Äù <br>  <strong>4.</strong> After that, the date of creation / access / modification of the libraries ‚Äúcdrvhf32.dll‚Äù and ‚Äúutils.dll‚Äù will be changed to correspond to the date ‚Äúspcwin.exe‚Äù <br>  <strong>5.</strong> Finally, it will perform an ‚Äúexport‚Äù _Setup @ 16 from the ‚Äúutils.dll‚Äù library from the REGISTER_DLL_RUNDLL_SETUP procedure. <br><br>  This version of PosCardStealer (MD5: 81060E53D233711507F60C446418AFC6) is compiled in Visual C ++ and has the following internal date: 09/27/2015 12:26:09.  All this (plus some other evidence that is available in the PandaLabs anti-virus laboratory) indicates that the analyzed malicious samples were created specifically to attack the victim‚Äôs data. <br><br>  <b>A common feature on all attacked hardware:</b> <b>LogMeIn</b> software was installed everywhere.  This software is very popular and can be used for remote access to systems.  In the case of PoS systems, it could be used by the same company that provides PoS systems for restaurants to perform tasks of updating, support, etc. <br><br><h3>  LogMeIn: Remote Attacks </h3><br>  Although the use of LogMeIn could be episodic, in this case, we found out what it could be related to: about a month and a half after this attack, a new attack was carried out using LogMeIn.  In this case, not only 30 previously compromised PoS systems were affected, but also hundreds of others.  All of them were located in the USA and mostly belonged to bars and restaurants. <br><br>  In this new attack, criminals used the Multigrain malware, which we analyzed <a href="https://habrahabr.ru/company/panda/blog/307320/">here</a> .  The attack began on November 13, 2015 at 22:09 (GMT), and it took the criminals only 10 minutes to infect all the victims.  Here is the process that was used to perform the infection: <br><br>  ‚Ä¢ Connect to PoS using LogMeIn <br>  ‚Ä¢ Use LogMeIn to download the executable file (wme.exe, MD5: A0973ADAF99975C1EB12CC1E333D302F, Multigrain option). <br>  ‚Ä¢ Script execution via LogMeIn.  This script calls cmd.exe that performs wme.exe. <br><br>  14 hours later, an isolated attack on one of the PoS was launched.  This attack installed a new version of Multigrain (MD5: A3B944454729EA13AD847D01FFAC556A).  Half an hour later (we assume that this time was required to verify that everything is working correctly), the criminals automatically repeated the attack against all their victims, so that all the machines were infected with a new version of the malicious program after only 10 minutes. <br><br>  These systems have been in a compromised state for months.  When the people responsible for the PoS systems realized that they were attacked and cleaned the PoS systems, the hackers could ‚Äúreturn‚Äù again to where they were thrown from, and with the help of LogMeIn installed a new version of Multigrain (MD5: 4C722EA25EC857E1A7E73DE5886F9299). <br><br>  It should be clarified that the attack using LogMeIn was not carried out as a result of some kind of vulnerability, but due to the fact that hackers already had hacked computers and they had all the necessary registration data to access the system.  We advise LogMeIn users to follow the guidelines published in this <a href="https://secure.logmein.com/welcome/documentation/EN/pdf/common/LogMeIn_SecurityWhitepaper.pdf">document</a> . <br><br><h3>  Some tips to prevent cyber attacks </h3><br>  This type of attack allows you to steal information from thousands of bank cards in a fairly simple way.  PoS systems are critical systems, and they must be protected in case they need to install software for remote access.  All available security measures (two-factor authentication, restriction on IP addresses of connected devices, etc.) should be applied.  This should be mandatory in order to have full control over all programs that run on these terminals. <br><br>  Consider that your strength lies in knowing your infrastructure and environment.  The best way to ensure complete security in your entire IT park is to use <a href="http://www.pandasecurity.com/russia/enterprise/solutions/adaptive-defense-360/">Adaptive Defense</a> .  Activate the ‚ÄúLock‚Äù mode to prevent the execution of unknown processes ... This will ensure the protection and security of all information belonging to you and your customers. </div><p>Source: <a href="https://habr.com/ru/post/307520/">https://habr.com/ru/post/307520/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307502/index.html">Small but very useful patch in Selenium</a></li>
<li><a href="../307510/index.html">Webinar: acquaintance with Zabbix</a></li>
<li><a href="../307512/index.html">Compiler LLVM for MultiClet: WhetStone benchmark</a></li>
<li><a href="../307516/index.html">The other side of IT: 15 useful books and guides on marketing and project management</a></li>
<li><a href="../307518/index.html">Chargebox on Arduino</a></li>
<li><a href="../307522/index.html">HR errors by the eyes of the developer</a></li>
<li><a href="../307524/index.html">Introduction to binary technology</a></li>
<li><a href="../307526/index.html">8 tips to work more effectively with Git</a></li>
<li><a href="../307528/index.html">Analyzing NetFlow v.9 of Cisco ASA using Logstash (ELK)</a></li>
<li><a href="../307530/index.html">Writing a multiplatform bot for transferring money from card to card using Microsoft Bot Framework V1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>