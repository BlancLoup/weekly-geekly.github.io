<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rapid deployment of the telephone network to Asterisk + Cisco</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It so happened that in a short time it became necessary to transport 70 people with analog phones from one business center to another. The situation w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rapid deployment of the telephone network to Asterisk + Cisco</h1><div class="post__text post__text-html js-mediator-article">  It so happened that in a short time it became necessary to transport 70 people with analog phones from one business center to another.  The situation was aggravated by the fact that in the new office the owner did not have analog ports in the PBX, and the PBX in the old one belonged to the telephone company.  I had to quickly implement IP telephony with the transfer of all analog city lines to Asterisk.  The delivery of equipment was scheduled for the day preceding the day of the move, which meant that there would be very little time to deploy telephony. <br><br>  What came of it under the cut. <br>  A lot of material, so do not be alarmed. <br><a name="habracut"></a><br>  So the available configuration: <br><ul><li>  60 users with their computers. </li><li>  60 phones Cisco SPA 502G </li><li>  4 Cisco SPA500S Panels </li><li>  5 Siemens C610A bases with a pair of tubes for each. </li><li>  One server on FreeBSD. </li><li>  A pair of switches Cisco SF300-24P </li></ul><br><br>  Searching and reading a lot of documents related to autoprovision on the network, we decided to use the asterisk opportunity to auto-configure devices on our own.  All anything, but as it turned out auto-tuning through the sql database in asterisk does not allow monitoring the state of the extension on the doppanel.  Those.  hint cannot be configured (at least in August 2012 it was not supported).  Having a couple of phones available, we decided to write our own autoprovision. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We started with setting up the server and the switches.  Created 2 VLANs with numbers 204 and 214. The first for the local network, the second for IP telephony.  Since  phones have a built-in configurable switch, it was the best solution from our point of view. <br>  Put the ports on the switches to which users connect to the trunk and change the native vlan. <br><pre><code class="coffeescript hljs">interface fastethernet1 switchport trunk allowed vlan add <span class="hljs-number"><span class="hljs-number">204</span></span> switchport trunk native vlan <span class="hljs-number"><span class="hljs-number">214</span></span> exit</code> </pre>  We connected the server to the switch in the trunk port and changed the settings of <b>dhcpd.conf</b> <br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># Phones Subnet Vlan 214 subnet 172.16.214.0 netmask 255.255.255.0 { range 172.16.214.10 172.16.214.250; option routers 172.16.214.1; option tftp-server-name "http://172.16.214.1/XMLDefault.cnf.xml"; option domain-name "phones.mydomain.local"; option domain-name-servers 172.16.214.1; option broadcast-address 172.16.214.255; ddns-updates on; ddns-domainname "phones.mydomain.local"; ddns-rev-domainname "in-addr.arpa"; } # Computers Subnet Vlan 204 subnet 172.16.6.0 netmask 255.255.255.0 { range 172.16.6.12 172.16.6.240; option broadcast-address 172.16.6.255; option domain-name-servers 172.16.6.1; option domain-name "mydomain.local"; option routers 172.16.6.1; if option host-name = "" { option host-name = concat ("dev-", binary-to-ascii( 10, 8, "", substring( reverse( 1, leased-address), 0, 1))); ddns-hostname = concat ("dev-", binary-to-ascii( 10, 8, "", substring( reverse( 1, leased-address), 0, 1))); } }</span></span></code> </pre><br>  Fine.  Addresses are distributed, the phones are bugged, it's time to gash the basic config. <br>  Raise thttpd and put it in the root <b>XMLDefault.cnf.xml</b> <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">flat-profile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.sipura.net/xsd/SPA50x-30x-SIP"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.sipura.net/xsd/SPA50x-30x-SIP http://www.sipura.net/xsd/SPA50x-30x-SIP/SPA50x-30x-SIP-7-5-2.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Admin_Passwd</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>7654321<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Admin_Passwd</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SPCP_Auto-detect</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SPCP_Auto-detect</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Domain</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rw"</span></span></span><span class="hljs-tag">&gt;</span></span>phones.mydomain.local<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Domain</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Primary_DNS</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rw"</span></span></span><span class="hljs-tag">&gt;</span></span>172.16.214.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Primary_DNS</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Syslog_Server</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>172.16.214.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Syslog_Server</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Debug_Server</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>172.16.214.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Debug_Server</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Debug_Level</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Debug_Level</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Primary_NTP_Server</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>172.16.214.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Primary_NTP_Server</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_VLAN</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rw"</span></span></span><span class="hljs-tag">&gt;</span></span>Yes<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_VLAN</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_PC_Port_VLAN_Tagging</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>Yes<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_PC_Port_VLAN_Tagging</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_CDP</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_CDP</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_LLDP-MED</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_LLDP-MED</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PC_Port_VLAN_ID</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>204<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PC_Port_VLAN_ID</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Profile_Rule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>http://172.16.214.1/XMLDefault.cnf.xml<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Profile_Rule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Profile_Rule_B</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>http://172.16.214.1/cfg/cfg.cgi?SN=$SN&amp;MAC=$MA<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Profile_Rule_B</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Key_System_Auto_Discovery</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Key_System_Auto_Discovery</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">G722_Enable_1_</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>Yes<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">G722_Enable_1_</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">L16_Enable_1_</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">L16_Enable_1_</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">G726-16_Enable_1_</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">G726-16_Enable_1_</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">G726-24_Enable_1_</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">G726-24_Enable_1_</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">G726-32_Enable_1_</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">G726-32_Enable_1_</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">G726-40_Enable_1_</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">G726-40_Enable_1_</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_IP_Dialing_1_</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_IP_Dialing_1_</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Use_Remote_Pref_Codec_1_</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>Yes<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Use_Remote_Pref_Codec_1_</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Time_Format</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rw"</span></span></span><span class="hljs-tag">&gt;</span></span>24hr<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Time_Format</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Date_Format</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rw"</span></span></span><span class="hljs-tag">&gt;</span></span>day/month<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Date_Format</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Text_Logo</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>Company<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Text_Logo</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Time_Zone</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>GMT+04:00<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Time_Zone</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Upgrade_Rule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>( $SWVER ne 7.5.2b )? http://172.16.214.1/sw/spa50x-30x-7-5-2b.bin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Upgrade_Rule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">flat-profile</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Thus, after the phone takes the autoconfiguration parameters from dhcp and takes the basic config from the server, it will do the second iteration after the configuration file associated with the device‚Äôs serial number and its mac address.  After full initialization of the config, the phone will transfer the computer port to 204 VLAN, ensuring it works with the local network. <br>  Let's go to how the phones get their configuration file. <br>  Create an auxiliary file with the settings <b>/usr/local/etc/astprov.conf</b> <br><pre> <code class="bash hljs">sqlite=<span class="hljs-string"><span class="hljs-string">"/usr/local/bin/sqlite3"</span></span> ast_provisiondb=<span class="hljs-string"><span class="hljs-string">"/var/db/asterisk/asterisk_provision.sqlite3"</span></span> ast_ext_dialplan=<span class="hljs-string"><span class="hljs-string">"/var/db/asterisk/asterisk_ext_dialplan.conf"</span></span> ast_ext_accounts=<span class="hljs-string"><span class="hljs-string">"/var/db/asterisk/asterisk_ext_accounts.conf"</span></span> logger_tag=<span class="hljs-string"><span class="hljs-string">"astprov"</span></span> include=<span class="hljs-string"><span class="hljs-string">"/etc/rc.conf"</span></span></code> </pre><br><br>  Let's create the sqlite3 base of the following structure specified in the configuration file: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">PRAGMA</span></span> foreign_keys=<span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`provision`</span></span> ( <span class="hljs-string"><span class="hljs-string">`macaddress`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`serial`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`secret`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ext`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`fullname`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`callerid`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`callgroup`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'1'</span></span>, <span class="hljs-string"><span class="hljs-string">`pickupgroup`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'1'</span></span>, <span class="hljs-string"><span class="hljs-string">`context`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`subscribecontext`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'1'</span></span>, <span class="hljs-string"><span class="hljs-string">`ip`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre><br><br>  For the subsequent quick setup of workstations we create a file with phones <br><pre> <code class="coffeescript hljs"><span class="hljs-number"><span class="hljs-number">3027</span></span>|Buhgalter <span class="hljs-number"><span class="hljs-number">3097</span></span>|Igor <span class="hljs-number"><span class="hljs-number">3018</span></span>|Sergey <span class="hljs-number"><span class="hljs-number">3016</span></span>|Oleg <span class="hljs-number"><span class="hljs-number">3091</span></span>|Vladimir <span class="hljs-number"><span class="hljs-number">3014</span></span>|Ekaterina <span class="hljs-number"><span class="hljs-number">3012</span></span>|Andrey <span class="hljs-number"><span class="hljs-number">3015</span></span>|Maxim</code> </pre><br><br>  and feed it to the script as a parameter <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh set -x . /usr/local/etc/astprov.subr context='local_pool' callgroup=1 pickupgroup=1 subscribecontext=1 ip="none" cat $1 | while IFS= read -r line; do randomstr=`&lt; /dev/urandom tr -dc A-Za-z0-9 | head -c10` randompas=`&lt; /dev/urandom tr -dc A-Za-z0-9 | head -c10` ext=$(echo $line | cut -d '|' -f1 ) fullname=$(echo $line | cut -d '|' -f2 ) # fullname &lt;&lt;&lt; $(IFS=";"; echo $line) insertline="insert into provision values ('$randomstr','$randompas','$randompas',$ext,'$fullname','$fullname &lt;$ext&gt;',$callgroup,$pickupgroup,'$context',$subscribecontext,'$ip')" # echo $insertline $sqlitecmd "$insertline" done</span></span></code> </pre><br>  the script will automatically fill the base and give the ability to quickly connect new phones. <br><br>  Now a little witchcraft. <br>  Asterisk works under the asterisk: asterisk account, thttpd works under www: www.  Therefore we create the astprov group where we add asterisk and www. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chown -R asterisk.astprov /var/db/asterisk # chmod 0775 /var/db/asterisk # chmod 0664 /var/db/asterisk/*</span></span></code> </pre><br><br>  Now you need to personalize the phone settings. <br>  Create a script <b>/usr/local/www/data/cfg/cfg.cgi</b> , I love perl, therefore the configurator on pearl. <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use strict; #use Data::Dumper; use DBI; use vars qw/%sv %form %cookie %rq $sth $dbh $config/; use FileHandle; use Sys::Syslog qw(:standard); my $configfilename="/usr/local/etc/astprov.conf"; $config=_read_config_file($configfilename); &amp;systeminit; &amp;printhead; #$form{SN}='CBT1602095Z'; #$form{MAC}='649ef37761c2'; #$sv{ip}="172.16.214.10"; openlog("astprov", 'cons,pid'); exit(1) if (not defined $form{SN} or not defined $form{MAC}); &amp;baseconnect; &amp;get_info; &amp;baseclose; closelog(); exit(1); sub get_info { $form{SN} =~ s/[^0-9A-Za-z]//g; $form{MAC} =~ s/[^0-9A-Za-z]//g; my $dbdata; if($dbdata = &amp;request_phone_info) { &amp;print_xml($dbdata); } else { if(keys %{$dbdata} &lt; 1) { &amp;insert_new_phone; } $dbdata = &amp;request_phone_info; &amp;print_xml($dbdata); } #print Dumper $dbdata; } sub print_xml { my $dbdata=shift; my $additional; if(-f "/usr/local/www/data/cfg/additional".lc($form{MAC}).".xml") { open IN,"&lt;/usr/local/www/data/cfg/additional".lc($form{MAC}).".xml"; undef $/; $additional = &lt;IN&gt;; close IN; } my $hostname = "office-".$dbdata-&gt;{ext}; print &lt;&lt; "[end]"; &lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt; &lt;flat-profile xmlns="http://www.sipura.net/xsd/SPA50x-30x-SIP" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.sipura.net/xsd/SPA50x-30x-SIP http://www.sipura.net/xsd/SPA50x-30x-SIP/SPA50x-30x-SIP-7-5-2.xsd"&gt; &lt;HostName ua="rw"&gt;$hostname&lt;/HostName&gt; &lt;Phone-UI-readonly ua="na"&gt;Yes&lt;/Phone-UI-readonly&gt; &lt;Phone-UI-user-mode ua="na"&gt;Yes&lt;/Phone-UI-user-mode&gt; &lt;Proxy_1_ ua="na"&gt;172.16.214.1&lt;/Proxy_1_&gt; &lt;Display_Name_1_ ua="na"&gt;$dbdata-&gt;{fullname}&lt;/Display_Name_1_&gt; &lt;User_ID_1_ ua="na"&gt;$dbdata-&gt;{ext}&lt;/User_ID_1_&gt; &lt;Password_1_ ua="na"&gt;$dbdata-&gt;{secret}&lt;/Password_1_&gt; &lt;Dial_Plan_1_ ua="na"&gt;(7[0-9][0-9]xxxxS0|*8|*xx|xxxx|0xxxxxxxxxxxx.)&lt;/Dial_Plan_1_&gt; &lt;Station_Name ua="na"&gt;$dbdata-&gt;{ext}&lt;/Station_Name&gt; &lt;Station_Display_Name ua="na"&gt;$dbdata-&gt;{fullname}&lt;/Station_Display_Name&gt; &lt;Server_Type ua="na"&gt;Asterisk&lt;/Server_Type&gt; &lt;XML_Directory_Service_Name ua="na"&gt;My Company&lt;/XML_Directory_Service_Name&gt; &lt;XML_Directory_Service_URL ua="na"&gt;http://172.16.213.1/directory.cgi&lt;/XML_Directory_Service_URL&gt; $additional &lt;/flat-profile&gt; [end] } sub request_phone_info { my $cmd = "select ext,callerid,fullname,secret from provision where macaddress='".lc($form{MAC})."' and serial='".lc($form{SN})."'"; my $dbdata = $dbh-&gt;selectrow_hashref($cmd); if($dbh-&gt;err) { print "cmd = ",$cmd,"\n"; print "err = ",$dbh-&gt;err,"\n"; print "errstr = ",$dbh-&gt;errstr,"\n"; print "state = ",$dbh-&gt;state,"\n"; return undef; } return $dbdata; } sub insert_new_phone { my $maxnum = $dbh-&gt;selectrow_array("SELECT MAX(ext) FROM provision where ext &lt; 2000") || "1000"; $maxnum++; $dbh-&gt;do("INSERT INTO provision (ip,macaddress,serial,secret,ext,fullname,callerid,context) VALUES ('".join ("','",$sv{ip},lc($form{MAC}),lc($form{SN}),lc($form{SN}),$maxnum,'Unregistered','Unregistered &lt;'.$maxnum.'&gt;','unreg')."')"); syslog('info|local7',"New host added MAC:$form{MAC} SN:$form{SN}"); if($dbh-&gt;err) { print "err = ",$dbh-&gt;err,"\n"; print "errstr = ",$dbh-&gt;errstr,"\n"; print "state = ",$dbh-&gt;state,"\n"; exit(1); } } sub systeminit { $sv{"ip"} = $ENV{"REMOTE_ADDR"}; $sv{"userhost"} = $ENV{"REMOTE_HOST"}; $sv{"url"} = $ENV{"HTTP_HOST"}; $sv{"doc"} = $ENV{"DOCUMENT_ROOT"}; $sv{"ref"} = $ENV{"HTTP_REFERER"}; # ---------------------------------------------------------------------------------------- my $request_url = $ENV{"REQUEST_URI"}; $request_url =~ s/%(..)/pack("c",hex($1))/ge; $request_url =~ s/[^A-Za-z0-9\-\_\+\=\:\.\,\/\@]//g; $request_url =~ s/([\-\_\+\=\.\:\,\/\@\s]){2,}/$1/g; $request_url =~ s/\+/\&amp;/g; $request_url =~ s/^\/+//g; my $count = 0; while ($request_url =~ /^([\w\-\=\_\&amp;\.\,\:\@\s]+)\//) { $rq{$count} = $1; $request_url =~ s/$rq{$count}\///; $count++; } $request_url =~ s/^\s+$//g; chomp $request_url; $rq{$count} = $request_url if (length($request_url) &gt; 0); # ---------------------------------------------------------------------------------------- if ( defined($ENV{"HTTP_COOKIE"}) &amp;&amp; length($ENV{"HTTP_COOKIE"}) &gt; 0 ) { my @cookies = split(/;/,$ENV{"HTTP_COOKIE"}); foreach (@cookies) { my ($name,$value) = split(/=/,$_); $cookie{$name} = $value; } } # ---------------------------------------------------------------------------------------- if ((defined($ENV{"QUERY_STRING"}) &amp;&amp; length($ENV{"QUERY_STRING"}) != 0) || (defined($ENV{"CONTENT_LENGTH"}) &amp;&amp; $ENV{"CONTENT_LENGTH"} != 0)) { my $data = undef; my @data = undef; if ($ENV{"REQUEST_METHOD"} eq "GET") { $data = $ENV{"QUERY_STRING"}; } else { read(STDIN,$data,$ENV{"CONTENT_LENGTH"}); } @data = split(/&amp;/,$data); foreach (@data) { $_ =~ s/\+/ /g; my ($name, $value) = split(/=/,$_,2); $name =~ s/%(..)/pack("c",hex($1))/ge; $name =~ tr/[^A-Za-z0-9\-\_\$\+\=\~\.\,]//; $value =~ s/%(..)/pack("c",hex($1))/ge; $form{$name} .= "\0" if (defined($form{$name})); $form{$name} .= $value; } } } sub baseconnect { my $dbname = eval $config-&gt;{ast_provisiondb}; $dbh = DBI-&gt;connect("dbi:SQLite:dbname=$dbname","",""); $sth = $dbh-&gt;table_info('%', '%', 'provision'); my $result = $sth-&gt;fetchall_hashref('TABLE_NAME'); if(!defined($result-&gt;{'provision'})) { $dbh-&gt;do(" CREATE TABLE `provision` ( `macaddress` varchar(12) NOT NULL, `serial` varchar(12) NOT NULL, `secret` varchar(32) NOT NULL, `ext` int(11) NOT NULL, `fullname` varchar(64) NOT NULL, `callerid` varchar(64) NOT NULL, `callgroup` varchar(32) NOT NULL default '1', `pickupgroup` varchar(32) NOT NULL default '1', `context` varchar(32) NOT NULL, `subscribecontext` varchar(32) NOT NULL default 'internal_phones', `ip` varchar(15) NOT NULL) "); } } sub baseclose { if ($dbh-&gt;{Active} &amp;&amp; defined($sth)) { $sth-&gt;finish }; $dbh-&gt;disconnect; } sub printhead { print "Content-Type: text/plain; charset=UTF-8;\r\n\r\n"; } sub _read_config_file { my $file = shift or return; my $conf = {}; my $FH = new FileHandle; $FH-&gt;open("$file") or ( warn(loc(q[Could not open config file '%1': %2],$file,$!)), return {} ); while(&lt;$FH&gt;) { next if /\s*#/; next unless /\S/; chomp; s/^\s*//; s/\s*$//; my ($param,$val) = split /\s*=\s*/; ### add these to the config hash ### $conf-&gt;{ lc $param } = $val; } close $FH; return $conf; }</span></span></code> </pre><br><br>  The script receives from the request of the MAC device and its serial number, if the bundle is in the database, then the phone is given a config with the login / password and the parameters for connecting to the server.  If there is no bundle, then the phone is added to the database, a ‚Äúservice number‚Äù is assigned to it, in this case from 1000 to 2000 and the config is given to the phone.  If you put a file named <b>additional &lt;MAC&gt; .xml</b> in the " <b>cfg</b> " folder, then this file will be added to the config file.  We use this feature to load the panel settings into the phone.  For example: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Attendant_Console_Call_Pickup_Code</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>*8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Attendant_Console_Call_Pickup_Code</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_1</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>fnc=sd+cp+blf;sub=2010@172.16.213.1;nme=2010<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_2</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>fnc=sd+cp+blf;sub=2012@172.16.213.1;nme=2012<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_3</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>fnc=sd+cp+blf;sub=2014@172.16.213.1;nme=2014<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_4</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>fnc=sd+cp+blf;sub=2100@172.16.213.1;nme=2100<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_4</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_5</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>fnc=sd+cp+blf;sub=2110@172.16.213.1;nme=2110<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_5</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_6</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>fnc=sd+cp+blf;sub=2111@172.16.213.1;nme=2111<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_6</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_7</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>fnc=sd+cp+blf;sub=2112@172.16.213.1;nme=2112<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_7</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_8</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>fnc=sd+cp+blf;sub=2120@172.16.213.1;nme=2120<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_8</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_9</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>fnc=sd+cp+blf;sub=2121@172.16.213.1;nme=2121<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit_1_Key_9</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  or to change the port settings for transferring it to another VLAN <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_VLAN</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rw"</span></span></span><span class="hljs-tag">&gt;</span></span>Yes<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_VLAN</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_PC_Port_VLAN_Tagging</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>Yes<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_PC_Port_VLAN_Tagging</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_CDP</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_CDP</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_LLDP-MED</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>No<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Enable_LLDP-MED</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PC_Port_VLAN_ID</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ua</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"na"</span></span></span><span class="hljs-tag">&gt;</span></span>300<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PC_Port_VLAN_ID</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  We check whether phones are loaded correctly and whether the config is given correctly. <br>  You can do it by hand, looking at thttpd.log and copying the request into the browser. <br><br>  If everything is fine with us, then proceed to the most interesting part, namely, the automation and settings of the asterisk.  Everyone writes on what is convenient for him, but if we have the opportunity to steer sqlite3 through the console, I decided to write reinforced concrete shell scripts.  At first glance, scary, but in the end it turned out very compact.  The main part is occupied by error handling for interactive with asterisk.  All actions performed in the interactive control mode from asterisk are logged in the system log.  In almost all scripts, the stop mode is turned on when an internal error occurs.  If there is no path in the script name below, then it lies in <b>/ usr / local / etc / asterisk / scripts /</b> . <br><br>  In the config extensions.conf add <br>  <b>#include "/var/db/asterisk/asterisk_ext_dialplan.conf"</b> <br><br>  Add to sip.conf config <br>  <b>#include "/var/db/asterisk/asterisk_ext_accounts.conf"</b> <br><br>  In order to execute commands directly from asterisk, create a group of scripts: <br>  <b>/usr/local/etc/astprov.subr</b> - the main script containing all the procedures for working with the database. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh . /usr/local/etc/astprov.conf #set -x getvalue() { result= _request=$1 _ext=$2 selectcmd='select '${_request}' from provision where ext='${_ext}';' result=`$sqlitecmd "$selectcmd"` if [ "$result" ]; then echo $result return 0 else syslog "Error: SQL request cannot be made (request ${_request},extention ${_ext})" return 1 fi } checkvalue() { result= _request=$1 _ext=$2 selectcmd='select '${_request}' from provision where ext='${_ext}';' result=`$sqlitecmd "$selectcmd"` echo $result return 0 } setvalue() { result= _what=$1 _new=$2 _where=$3 _old=$4 updatecmd="update provision set ${_what}='${_new}' where ${_where}='${_old}';" $sqlitecmd "$updatecmd" if [ $? -ne 0 ]; then syslog "Error: SQL update cannot be made (set ${_what}=${_new} where ${_where}=${_old})" return 1 else return 0 fi } get_script_name() { result= result=`echo $0 | rev | cut -d/ -f1 | rev` echo $result } syslog() { result= _message=$@ logger -t $logger_tag `get_script_name`": ${_message}" } sqlitecmdcoln="$sqlite -column $ast_provisiondb" sqlitecmdline="$sqlite -line $ast_provisiondb" sqlitecmd="$sqlite $ast_provisiondb"</span></span></code> </pre><br><br>  <b>showall.sh</b> dump database for diagnostics <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh set -e . /usr/local/etc/astprov.subr $sqlitecmd 'select * from provision'</span></span></code> </pre><br>  <b>rebuildlist.sh</b> script update dynamic configuration for asterisk. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh set -e . /usr/local/etc/astprov.subr if [ -f $ast_ext_accounts -a ! -w $ast_ext_accounts ]; then syslog 'Cannot write to astprov extension database' exit 1 fi if [ -f $ast_ext_accounts ]; then mv $ast_ext_accounts $ast_ext_accounts.backup fi if [ -f $ast_ext_dialplan -a ! -w $ast_ext_dialplan ]; then syslog 'Cannot write to astprov extension dialplan' exit 1 fi if [ -f $ast_ext_dialplan ]; then mv $ast_ext_dialplan $ast_ext_dialplan.backup fi echo '[dynamic_internal_numbers]' &gt;&gt; $ast_ext_dialplan selectcmd='select ext from provision order by ext;' for ext in `$sqlitecmdcoln "$selectcmd"`; do echo 'exten =&gt; '$ext',1,dumpchan()' &gt;&gt; $ast_ext_dialplan echo 'same =&gt; n,Dial(SIP/'$ext',60,Tt)' &gt;&gt; $ast_ext_dialplan echo 'same =&gt; hint,SIP/'$ext &gt;&gt; $ast_ext_dialplan echo 'same =&gt; n,Hangup()' &gt;&gt; $ast_ext_dialplan echo ''&gt;&gt; $ast_ext_dialplan selectcmd='select callerid,fullname,macaddress,secret,context,callgroup,pickupgroup,subscribecontext,ip from provision where ext='$ext';' echo '['$ext'](all)' &gt;&gt; $ast_ext_accounts $sqlitecmdline "$selectcmd" | sed -E 's/ = /=/g' | while IFS= read -r line; do echo $line &gt;&gt; $ast_ext_accounts done echo &gt;&gt; $ast_ext_accounts done syslog 'Asterisk dynamic list succesfully updated'</span></span></code> </pre><br>  <b>changenumber.sh</b> script to replace the phone number to another. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #set -x . /usr/local/etc/astprov.subr oldname=`getvalue 'ext' $1` if [ "$?" -ne "0" ]; then echo -n GETERR exit fi numberexist=`checkvalue 'ext' $2` if [ -z "$numberexist" ]; then setvalue 'ext' $2 'ext' $1 if [ "$?" -ne "0" ]; then echo -n SETERR exit fi setvalue 'callerid' "$oldname &lt;$2&gt;" 'ext' $2 if [ "$?" -ne "0" ]; then echo -n SETERR exit fi syslog "Number $1 renamed to $2" echo -n OK else syslog "Number $1 cannot be renamed to $2. Number $2 already exist" echo -n NUMEXIST exit # return 1 fi</span></span></code> </pre><br>  <b>togglenumbers.sh is a</b> script for swapping phones.  let's say you need to swap ext 1023 from 2035. It is very convenient when employees change hands.  Phones remain in place, and numbers are swapped. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #set -x . /usr/local/etc/astprov.subr macaddress_from=`getvalue 'macaddress' $1` if [ "$?" -ne "0" ]; then echo -n GETERR ; exit ; fi macaddress_to=`getvalue 'macaddress' $2` if [ "$?" -ne "0" ]; then echo -n GETERR; exit; fi secret_from=`getvalue 'secret' $1` if [ "$?" -ne "0" ]; then echo -n GETERR; exit; fi secret_to=`getvalue 'secret' $2` if [ "$?" -ne "0" ]; then echo -n GETERR; exit; fi serial_from=`getvalue 'serial' $1` if [ "$?" -ne "0" ]; then echo -n GETERR; exit; fi serial_to=`getvalue 'serial' $2` if [ "$?" -ne "0" ]; then echo -n GETERR; exit; fi setvalue macaddress $macaddress_from'_'$macaddress_to macaddress $macaddress_from if [ "$?" -ne "0" ]; then echo -n SETERR; exit; fi setvalue macaddress $macaddress_to'_'$macaddress_from macaddress $macaddress_to if [ "$?" -ne "0" ]; then echo -n SETERR; exit; fi setvalue secret $secret_to macaddress $macaddress_from'_'$macaddress_to if [ "$?" -ne "0" ]; then echo -n SETERR; exit; fi setvalue secret $secret_from macaddress $macaddress_to'_'$macaddress_from if [ "$?" -ne "0" ]; then echo -n SETERR; exit; fi setvalue serial $serial_to macaddress $macaddress_from'_'$macaddress_to if [ "$?" -ne "0" ]; then echo -n SETERR; exit; fi setvalue serial $serial_from macaddress $macaddress_to'_'$macaddress_from if [ "$?" -ne "0" ]; then echo -n SETERR; exit; fi setvalue macaddress $macaddress_to macaddress $macaddress_from'_'$macaddress_to if [ "$?" -ne "0" ]; then echo -n SETERR; exit; fi setvalue macaddress $macaddress_from macaddress $macaddress_to'_'$macaddress_from if [ "$?" -ne "0" ]; then echo -n SETERR; exit; fi syslog "Phones $1($serial_from:$macaddress_from) and $2($serial_to:$macaddress_to) are reversed" echo -n OK</span></span></code> </pre><br><br>  Scripts are laid out.  In principle, you can use scripts and hands through <br>  <b>su -m asterisk</b> , but the best option is to integrate this feature into asterisk. <br>  Since  Since all new unregistered phones fall into the guest context "[unreg]", then you need to create a description of this context in asterisk. <br><br><pre> <code class="coffeescript hljs">;goto service menu exten =&gt; <span class="hljs-number"><span class="hljs-number">3999</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,Goto(unreg,_X.,<span class="hljs-number"><span class="hljs-number">1</span></span>) [unreg] exten =&gt; _X.,<span class="hljs-number"><span class="hljs-number">1</span></span>,Answer() ;same =&gt; n,Authenticate(<span class="hljs-number"><span class="hljs-number">040478</span></span>) same =&gt; n,NoOp(Entering Service Menu) same =&gt; n,Playback(ivr/prov-welcome-to-service-menu) same =&gt; n(menu),Background(ivr/change-number&amp;ivr/swap-numbers&amp;ivr/rebuild-list&amp;ivr/reboot-phone&amp;ivr/reload-server) same =&gt; n,Read(CHOICE,,<span class="hljs-number"><span class="hljs-number">1</span></span>,,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>) ; <span class="hljs-number"><span class="hljs-number">1</span></span> - Change Number ; <span class="hljs-number"><span class="hljs-number">2</span></span> - Swap Numbers ; <span class="hljs-number"><span class="hljs-number">3</span></span> - Rebuild extensions list ; <span class="hljs-number"><span class="hljs-number">4</span></span> - Reload phone ; <span class="hljs-number"><span class="hljs-number">5</span></span> - Reload server ; Rename Number exten =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,Read(RENAMETO,ivr/enter-dest-number,<span class="hljs-number"><span class="hljs-number">4</span></span>,,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${RENAMETO}"</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span>]?menu) same =&gt; n,Playback(ivr/entered-number) same =&gt; n,SayDigits(${RENAMETO}) same =&gt; n,Read(APPROVE,ivr/press<span class="hljs-number"><span class="hljs-number">-1</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>-accept,<span class="hljs-number"><span class="hljs-number">1</span></span>,,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${APPROVE}"</span></span> != <span class="hljs-string"><span class="hljs-string">"1"</span></span>]?menu) same =&gt; n,Set(CHGNM=${SHELL(/usr/local/etc/asterisk/scripts/changenumber.sh ${CALLERID(num)} ${RENAMETO})}) same =&gt; n,NoOp(${CHGNM}) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${CHGNM}"</span></span> = <span class="hljs-string"><span class="hljs-string">"GETERR"</span></span>]?geterr) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${CHGNM}"</span></span> = <span class="hljs-string"><span class="hljs-string">"SETERR"</span></span>]?seterr) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${CHGNM}"</span></span> = <span class="hljs-string"><span class="hljs-string">"NUMEXIST"</span></span>]?numexist) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${CHGNM}"</span></span> = <span class="hljs-string"><span class="hljs-string">"OK"</span></span>]?ok) same =&gt; n(ok),Playback(ivr/prov-saved&amp;privacy-thankyou) same =&gt; n,System(/usr/local/etc/asterisk/scripts/rebuildlist.sh) same =&gt; n,GotoIF($[<span class="hljs-string"><span class="hljs-string">"${SYSTEMSTATUS}"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?error) same =&gt; n,Playback(ivr/rebuild-ok) same =&gt; n,System(/usr/local/sbin/asterisk -rx <span class="hljs-string"><span class="hljs-string">"sip notify cisco-check-cfg ${CALLERID(num)}"</span></span>) same =&gt; n,GotoIF($[<span class="hljs-string"><span class="hljs-string">"${SYSTEMSTATUS}"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?error) same =&gt; n,Playback(ivr/send-phone-reboot-ok) same =&gt; n,System(/usr/local/sbin/asterisk -rx <span class="hljs-string"><span class="hljs-string">"reload"</span></span>) same =&gt; n,GotoIF($[<span class="hljs-string"><span class="hljs-string">"${SYSTEMSTATUS}"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?error) same =&gt; n,Playback(ivr/server-reload-ok) same =&gt; n,Hangup() same =&gt; n(geterr),Playback(ivr/script-get-error) same =&gt; n,Hangup() same =&gt; n(seterr),Playback(ivr/script-set-error) same =&gt; n,Hangup() same =&gt; n(numexist),Playback(ivr/prov-exist) same =&gt; n,Hangup() same =&gt; n(menu),Goto(_X.,menu) same =&gt; n,Hangup() same =&gt; n(error),Playback(ivr/script-error) same =&gt; n,Hangup() ; Reverse numbers exten =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,Read(SWAPTO,ivr/enter-dest-number,<span class="hljs-number"><span class="hljs-number">4</span></span>,,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${SWAPTO}"</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span>]?menu) same =&gt; n,Playback(ivr/entered-number) same =&gt; n,SayDigits(${SWAPTO}) same =&gt; n,Read(APPROVE,ivr/press<span class="hljs-number"><span class="hljs-number">-1</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>-accept,<span class="hljs-number"><span class="hljs-number">1</span></span>,,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${APPROVE}"</span></span> != <span class="hljs-string"><span class="hljs-string">"1"</span></span>]?menu) same =&gt; n,Set(CHGNM=${SHELL(/usr/local/etc/asterisk/scripts/togglenumbers.sh ${CALLERID(num)} ${SWAPTO})}) same =&gt; n,NoOp(${CHGNM}) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${CHGNM}"</span></span> = <span class="hljs-string"><span class="hljs-string">"GETERR"</span></span>]?geterr) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${CHGNM}"</span></span> = <span class="hljs-string"><span class="hljs-string">"SETERR"</span></span>]?seterr) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${CHGNM}"</span></span> = <span class="hljs-string"><span class="hljs-string">"OK"</span></span>]?ok) same =&gt; n(ok),Playback(ivr/prov-saved&amp;privacy-thankyou) same =&gt; n,System(/usr/local/etc/asterisk/scripts/rebuildlist.sh) same =&gt; n,GotoIF($[<span class="hljs-string"><span class="hljs-string">"${SYSTEMSTATUS}"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?error) same =&gt; n,Playback(ivr/rebuild-ok) same =&gt; n,System(/usr/local/sbin/asterisk -rx <span class="hljs-string"><span class="hljs-string">"sip notify cisco-check-cfg ${CALLERID(num)} ${SWAPTO}"</span></span>) same =&gt; n,GotoIF($[<span class="hljs-string"><span class="hljs-string">"${SYSTEMSTATUS}"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?error) same =&gt; n,Playback(ivr/send-phone-reboot-ok) same =&gt; n,System(/usr/local/sbin/asterisk -rx <span class="hljs-string"><span class="hljs-string">"reload"</span></span>) same =&gt; n,GotoIF($[<span class="hljs-string"><span class="hljs-string">"${SYSTEMSTATUS}"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?error) same =&gt; n,Playback(ivr/server-reload-ok) same =&gt; n,Hangup() same =&gt; n(geterr),Playback(ivr/script-get-error) same =&gt; n,Hangup() same =&gt; n(seterr),Playback(ivr/script-set-error) same =&gt; n,Hangup() same =&gt; n(error),Playback(ivr/script-error) same =&gt; n,Hangup() same =&gt; n(menu),Goto(_X.,menu) same =&gt; n,Hangup() exten =&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,System(/usr/local/etc/asterisk/scripts/rebuildlist.sh) same =&gt; n,NoOp(${SYSTEMSTATUS}) same =&gt; n,GotoIF($[<span class="hljs-string"><span class="hljs-string">"${SYSTEMSTATUS}"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?error) same =&gt; n,Playback(ivr/rebuild-ok) same =&gt; n,System(/usr/local/sbin/asterisk -rx <span class="hljs-string"><span class="hljs-string">"reload"</span></span>) same =&gt; n,GotoIF($[<span class="hljs-string"><span class="hljs-string">"${SYSTEMSTATUS}"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?error) same =&gt; n,Playback(ivr/server-reload-ok) same =&gt; n,Goto(_X.,menu) same =&gt; n(error),Playback(ivr/script-error) same =&gt; n,Goto(_X.,menu) exten =&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,System(/usr/local/sbin/asterisk -rx <span class="hljs-string"><span class="hljs-string">"sip notify cisco-check-cfg ${CALLERID(num)}"</span></span>) same =&gt; n,GotoIF($[<span class="hljs-string"><span class="hljs-string">"${SYSTEMSTATUS}"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?error) same =&gt; n,Playback(ivr/send-phone-reboot-ok) same =&gt; n,System(/usr/local/sbin/asterisk -rx <span class="hljs-string"><span class="hljs-string">"reload"</span></span>) same =&gt; n,GotoIF($[<span class="hljs-string"><span class="hljs-string">"${SYSTEMSTATUS}"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?error) same =&gt; n,Playback(ivr/server-reload-ok) same =&gt; n,Hangup() same =&gt; n(error),Playback(ivr/script-error) same =&gt; n,Goto(_X.,menu) same =&gt; n,Hangup() exten =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,System(/usr/local/sbin/asterisk -rx <span class="hljs-string"><span class="hljs-string">"reload"</span></span>) same =&gt; n,GotoIF($[<span class="hljs-string"><span class="hljs-string">"${SYSTEMSTATUS}"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?error) same =&gt; n,Playback(ivr/server-reload-ok) same =&gt; n,Goto(_X.,menu) same =&gt; n(error),Playback(ivr/script-error) same =&gt; n,Goto(_X.,menu) same =&gt; n,Hangup()</code> </pre><br><br>  Actually what does this set of letters and numbers. <br>  1. Change the number. <br>  You can change the existing registered work number to another.  Requested phone number for which you want to change.  After changing the number, the list of dynamic configuration is recreated, the server is reload and the phone automatically restarts. <br>  2. Swap phones <br>  The call is made from the phone to which you want to change with another phone.  When replacing phones within the database, the information given by the configuration script changes.  The phone‚Äôs login password does not move, only the information about callerid and ext changes. <br>  After changing the numbers, the list of dynamic configuration is re-created, the server is reloaded and the phones are automatically reloaded. <br>  3. Recreate the list of phones. <br>  Recreates dynamic configuration files.  It is convenient to use when many unregistered phones in the autoconfiguration stand and wait for their turn in service, but cannot register on the server.  It is executed from any phone. At runtime, the list of dynamic configuration is re-created, a reload is made on the server. <br>  4. Reboot the machine <br>  Reboots the device from which the call was made.  Automatically makes reload on the server. <br>  5. Updating the config on the server. <br>  Automatically makes reload on the server. <br><br>  In general, everything.  With the correct transfer of scripts to the server, raising telephony becomes an easy task.  Initially, you can simply create a dialplan and pour it into the database.  Further actions are completely transparent and understandable to anyone, not even familiar with the administration of asterisk.  There will be questions - write.  The scheme is quite portable to any other database that you like more. <br><br>  <font>Aborche 2013</font> <br><img src="http://habrastorage.org/getpro/habr/post_images/cff/19a/9b6/cff19a9b6d0354bbc4d1a45beda58acf.jpg"></div><p>Source: <a href="https://habr.com/ru/post/176019/">https://habr.com/ru/post/176019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176005/index.html">Ultrabook Acer Aspire S7-191 video review</a></li>
<li><a href="../176007/index.html">ASP.NET MVC Lesson 2. Dependency Injection</a></li>
<li><a href="../176013/index.html">#FailOverConf - how it was, presentations and videos</a></li>
<li><a href="../176015/index.html">Whatsapp not for sale</a></li>
<li><a href="../176017/index.html">ASP NET.MVC Lesson 3. Working with the Database</a></li>
<li><a href="../176021/index.html">ASP.NET MVC Lesson 4. Routing</a></li>
<li><a href="../176023/index.html">ASP.NET MVC Lesson 5. Creating a Database Entry</a></li>
<li><a href="../176029/index.html">Xbox Durango may be submitted on May 21st (+ vote)</a></li>
<li><a href="../176033/index.html">Lionel Messi managed to score a goal for the robot only from the fourth time - video</a></li>
<li><a href="../176035/index.html">Microsoft, Nokia and Oracle have filed a complaint with the European Commission on the monopoly of Android applications from Google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>