<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accounting system based on the OCR system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prologue 
 In the course of his work, he received the task to invent and implement a system for recording advertising information. Accounting was to c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accounting system based on the OCR system</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prologue </h4><br>  In the course of his work, he received the task to invent and implement a system for recording advertising information.  Accounting was to check the availability of the necessary information on the right billboard.  Shield and printing are numbered. <br>  As a source of information for the system it was proposed to use a photo.  After the <s>trade</s> coordination with the designers, it was agreed that both numbers would be located within the same frame.  The only thing that the frame could be anywhere on the shield. <br>  Actually, the statement of the problem ends there and the implementation narration begins. <br>  The problem is solved in three steps: <br><ol><li>  Finding the desired rectangle in the image. </li><li>  Text recognising. </li><li>  Verification of recognition. </li></ol><br><a name="habracut"></a><br><h4>  Act One - Search Engine </h4><br>  To find the desired rectangle in the picture, the easiest way is to find all the pieces that can be called rectangles, and then filter them by certain parameters.  To search for rectangles in the image, a slightly doped standard example from OpenCV - squares.cpp was used, from which the search function for rectangles was taken. <br>  The procedure for finding shapes is quite primitive, and if there is a complex image with a lot of color borders and transitions at the input, it gives out a bunch of rectangles, from which even before the recognition procedure, it is necessary to throw out the unnecessary. <br><br>  The waste is filtered by several criteria: <br>  1. The ratio of width and height. <br>  The program has a cutoff criterion (r.width &lt;5 * r.height), it can be improved and the condition with delta can be used more precisely. <br>  The main thing is that the photographer does not show imagination and does not shoot the object, turning the camera 90 <sup>o</sup> (take a picture of me with my legs). <br>  2. Remove approximately the same shape. <br><br>  Another point: before straightening, we straighten the rectangles, since the photographer‚Äôs hand may waver and the rectangle may have non-horizontal vertical borders in the photo. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next is cutting into a file of all the collected rectangles. <br>  It was experimentally established that the recognition utility works better for pictures in black and white format, for which the cvAdaptiveThreshold method is called before writing to the file.  The block size in the conversion procedure was selected experimentally. <br><br><pre><code class="cpp hljs">&lt;source lang=<span class="hljs-string"><span class="hljs-string">"cpp"</span></span>&gt; #include <span class="hljs-string"><span class="hljs-string">"cv.h"</span></span> #include <span class="hljs-string"><span class="hljs-string">"highgui.h"</span></span> #include &lt;iostream&gt; #include &lt;math.h&gt; #include &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.h&gt; #include &lt;stdio.h&gt; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> cv; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Point&gt; polygon; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;polygon&gt; polygonList; ... <span class="hljs-comment"><span class="hljs-comment">//     bool compareRect(const CvRect &amp;r1, const CvRect &amp;r2) { if (!r1.width || !r1.height) return false; if ((float)abs(r1.width- r2.width)/(float)r1.width &gt; 0.05) return false; if ((float)abs(r1.height - r2.height)/(float)r1.height &gt; 0.05) return false; if ((float)abs(r1.x - r2.x)/(float)r1.width &gt; 0.02) return false; if ((float)abs(r1.y - r2.y)/(float)r1.height &gt; 0.02) return false; return true; } //  CvRect getRect(const polygon&amp; poly) { CvPoint p1 = cvPoint(10000,10000); CvPoint p2 = cvPoint(-10000,-10000); for (size_t i=0; i &lt; poly.size(); i++) { const Point p = poly[i]; if (p1.x &gt; px) p1.x = px; if (p1.y &gt; py) p1.y = py; if (p2.x &lt; px) p2.x = px; if (p2.y &lt; py) p2.y = py; } return cvRect(p1.x,p1.y,p2.x-p1.x,p2.y-p1.y); } int main(int argc, char** argv) { if(argc &lt;= 3) { cout &lt;&lt; "Wrong Param Count: " &lt;&lt; argc &lt;&lt; endl; cout &lt;&lt; "Usage: findrect infile extension outfolder" &lt;&lt; endl; return 1; } char *fileIn = argv[1]; char *fileExt = argv[2]; char *dirOut = argv[3]; char fileOut[128]; polygonList squares; IplImage *Img = cvLoadImage(fileIn,1); Mat image(Img); if(image.empty()) { cout &lt;&lt; "Couldn't load " &lt;&lt; fileIn &lt;&lt; endl; return 1; } findSquares(image, squares); vector&lt;CvRect&gt; rectList; int p = 0; int adaptive_method = CV_ADAPTIVE_THRESH_GAUSSIAN_C; int threshold_type = CV_THRESH_BINARY; int block_size = 65; double offset = 10; for (int j=0; j&lt;squares.size(); j++) { //  CvRect r = getRect(squares[j]); if (r.width &lt; 5*r.height) continue; //     bool doContinue = false; for (int k=0; k&lt;rectList.size(); k++) if (compareRect(r, rectList[k])) { doContinue = true; break; } if (doContinue) continue; rectList.push_back(r); //     cvSetImageROI(Img, r); IplImage *dst = cvCreateImage(cvSize(r.width, r.height), Img-&gt;depth, Img-&gt;nChannels); IplImage *gray = cvCreateImage(cvSize(r.width, r.height), 8, 1); IplImage *bw = cvCreateImage(cvSize(r.width, r.height), 8, 1); cvCopy(Img, dst, NULL); cvResetImageROI(Img); //   ,        php sprintf(fileOut,"%s/%d.%s",dirOut, p, fileExt); cout &lt;&lt; fileOut &lt;&lt; endl; p++; //  - cvCvtColor(dst,gray,CV_RGB2GRAY); cvAdaptiveThreshold(gray, bw, 255, adaptive_method,threshold_type,block_size,offset); cvSaveImage(fileOut, bw); cvReleaseImage(&amp;dst); cvReleaseImage(&amp;gray); cvReleaseImage(&amp;bw); } return 0; }</span></span></code> </pre> <br><br><h4>  The second action is a recognition </h4><br>  Recognition utility comes in as normal content and garbage. <br><img src="http://hostingkartinok.com/image/01201107/46de7743bb899ce200d21b6a37b335c5.gif" alt="image"><br><br><img src="http://hostingkartinok.com/image/01201107/0f60dc1e6540abdef96cab938bec5bae.gif" alt="image"><br><br><img src="http://hostingkartinok.com/image/01201107/2273910128af95064db451d6609eeb5b.gif" alt="image"><br><br><img src="http://hostingkartinok.com/image/01201107/0d629750ed7dbb213385b4b5923e1c4a.gif" alt="image"><br><br>  As stated earlier, for recognition we use the utility from Google - tesseract. <br>  It was possible to use other means of recognition, cuniform was also tested. <br>  But tesseract was chosen for the reason that there was a lot of information on it and there was a clear instruction for its training on its own set of characters. <br><br>  Training on your own alphabet was made with several goals: <br><ol><li>  Dictionary for recognition of numbers - must consist of 10 characters, no letters and other symbols are needed.  Short set probability of error. </li><li>  In principle, it was possible to stop at the 1st - the tesseract has a digit-only recognition mode.  You could use it and not bother with creating your own dictionary. <br>  But the test results prompted another idea and the reason is as follows: regular fonts (included in the standard set) have the OCR symbols resembling each other: the number ‚Äú7‚Äù resembles ‚Äú1‚Äù under certain conditions, the number ‚Äú3 "To" 8 ", etc. <br>  Therefore, it was decided to use a font in which the character of the numbers would not resemble each other.  As a hint to find the font was the name thereof - ¬´OCR A Std¬ª.  This font is just used on the above cuts. <br>  Thus, we have another factor to reduce the likelihood of error. <br></li></ol><br>  As a result, a dictionary of 10 characters of this font was created for tesseract, and it can be seen on the clippings above. <br>  I will not give instructions for the training of the utility, the process is not creative, mechanical, there are many instructions in the network. <br><br><h4>  Action three - collective </h4><br>  The system has been tested under Ubuntu.  Running the threading and recognition utilities is done by php. <br>  It also performs the final verification of the recognized data using the checksum method. <br>  The crc-8 algorithm is used. <br><pre> <code class="php hljs">$imagesout = <span class="hljs-string"><span class="hljs-string">'/home/toor/www/out'</span></span>; $findrect = <span class="hljs-string"><span class="hljs-string">'/home/toor/OCR/OpenCV-2.2.0/samples/cpp/findrect'</span></span>; $uploaddir = <span class="hljs-string"><span class="hljs-string">'/home/toor/www/uploads/'</span></span>; $rectdir = <span class="hljs-string"><span class="hljs-string">'/home/toor/www/out/'</span></span>; $tesseract = <span class="hljs-string"><span class="hljs-string">'/home/toor/OCR/tesseract-3.00/api/tesseract'</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_FILES[<span class="hljs-string"><span class="hljs-string">'userfile'</span></span>][<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>])) { $uploadfile = $uploaddir. $_FILES[<span class="hljs-string"><span class="hljs-string">'userfile'</span></span>][<span class="hljs-string"><span class="hljs-string">'name'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!move_uploaded_file($_FILES[<span class="hljs-string"><span class="hljs-string">'userfile'</span></span>][<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>], $uploaddir . $_FILES[<span class="hljs-string"><span class="hljs-string">'userfile'</span></span>][<span class="hljs-string"><span class="hljs-string">'name'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">" !"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">" {$_FILES['userfile']['name']}  !"</span></span>; $cmd = <span class="hljs-string"><span class="hljs-string">"$findrect $uploadfile tif $imagesout"</span></span>; exec($cmd, $output); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> count($output).<span class="hljs-string"><span class="hljs-string">" "</span></span>; $datas = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($output <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $k =&gt; $f) { $recognized = <span class="hljs-string"><span class="hljs-string">"$rectdir$k.txt"</span></span>; $cmd = <span class="hljs-string"><span class="hljs-string">"$tesseract $f $rectdir$k -l nums.ocr"</span></span>; exec($cmd); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists($recognized)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"file: $recognized"</span></span>; $data = file_get_contents($recognized); $data = preg_replace(<span class="hljs-string"><span class="hljs-string">'/\D/'</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>,$data); $data = trim($data); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!strlen($data)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!array_key_exists($data,$datas)) $datas[$data] = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $datas[$data]++; } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($datas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $d =&gt; $v) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($r = crc_check($d, NUMBER_LEN_1, NUMBER_LEN_CRC_1)) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' : '</span></span>.$r; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($r = crc_check($d, NUMBER_LEN_2, NUMBER_LEN_CRC_2)) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' : '</span></span>.$r; } } }</code> </pre><br><br>  In general, in the test mode, the system has shown itself quite well. <br>  Worked out pictures from the most simple phones like this <br><img src="http://hostingkartinok.com/image/01201107/9184dd4664cef658ad178096c0c4d2fa.jpg"><br>  and up to several megabytes with digital cameras. <br><br><h4>  Links </h4><br>  <a href="http://code.google.com/p/tesseract-ocr/">Tesseract</a> <br>  <a href="http://sourceforge.net/projects/opencvlibrary/">Opencv</a> <br>  <a href="http://en.wikipedia.org/wiki/OCR-A_font">OCR A Std Font</a> </div><p>Source: <a href="https://habr.com/ru/post/123395/">https://habr.com/ru/post/123395/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123385/index.html">The architecture of the Aggregation-Access network of large providers</a></li>
<li><a href="../123386/index.html">Storage format for sharing in the cloud</a></li>
<li><a href="../123388/index.html">Sony is going to put into operation the Playstation Network and Qriocity by July 6</a></li>
<li><a href="../123391/index.html">Using MySQL events in practice</a></li>
<li><a href="../123394/index.html">Working with ShapeFile (* .shp) in Delphi</a></li>
<li><a href="../123396/index.html">Czech! Who is to blame and what should an IT specialist do abroad !?</a></li>
<li><a href="../123397/index.html">Determining GPS availability in Android</a></li>
<li><a href="../123400/index.html">Three.js - 3D do it yourself browser or WebGL gets closer</a></li>
<li><a href="../123401/index.html">Backing up Rails projects without a hitch</a></li>
<li><a href="../123403/index.html">Maps in your Android application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>