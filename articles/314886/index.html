<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development based on the COREmanager framework. How our partners created a solution for outsourcing technical support</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If someone decided to start his own business and wants to provide virtual hosting, start an online service for selling flowers or coffee in a franchis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development based on the COREmanager framework. How our partners created a solution for outsourcing technical support</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d82/2ad/713/d822ad71353241199d42e23f3d67c8be.jpg"><br><br>  <i>If someone decided to start his own business and wants to provide virtual hosting, start an online service for selling flowers or coffee in a franchise, there are many ready-made tools for organizing work.</i>  <i>On the other hand, if you start a business simply, you must be prepared for a large number of competitors in this area.</i>  <i>The chance to ‚Äúburn out‚Äù increases.</i> <i><br></i>  <i>If you enter some little developed area where there is less competition, then there may not be ready-made tools for automating tasks.</i>  <i>Yes, at first you can do everything manually, but when the number of customers grows up, you will have to seriously think about optimizing processes.</i> <i><br><br></i>  <i>When developing an automation tool, you can use the COREmanager framework as the basis, skeleton, product.</i>  <i>This will reduce the time spent on coding, as well as allow the use of different programming languages ‚Äã‚Äãto implement various functions.</i> <i>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </i>  <i>Under the cut - the details of developing a system for outsourcing technical support by ISPlicense.</i> <br><a name="habracut"></a><br>  <a href="https://www.isplicense.ru/">ISPlicense</a> is a prime example of a company offering non-standard services in a very competitive business area.  They chose the domain of hosting by building a business model to serve existing players and newcomers to the market.  The company began with reselling licenses of ISPsystem software products, becoming one of our major partners.  After a while, the company's service package was supplemented with the provision of <a href="https://www.isplicense.ru/services/administration/outsource/">technical support for outsourcing</a> , which turned out to be very popular.  Lack of resources, geographical distance from most clients and other reasons led many hosters to think seriously about giving technical support to a third-party organization. <br><br>  ISPlicense performs outsourcing technical support in two ways: <br><br><ol><li>  When working with a hoster, in which technical support is provided free of charge for end users, the time spent on responses and invoicing to the hoster according to the contract are recorded. </li><li>  If customer support is not free, the cost is based on a price list, where the fee depends on the time spent or on the list of services provided.  After completing the request, the client is billed on behalf of the host, ISPlicense receives a percentage of the amount. </li></ol><br>  Now let's assume how you can put the support process without using automation tools. <br><br>  At first, it is possible to organize cooperation with customers according to different schemes: someone gives the login password of his employee, someone gets a separate user, someone can connect with BILLmanager.  But imagine if the number of hosters hosted has increased so much that the technical support operator is confused in dozens of browser tabs and should at the same time keep track of new messages in tickets. <br><br>  To prevent this situation, ISPlicense has developed a technical support system based on COREmanager, integrated with BILLmanager and other billing systems.  The product is called TicketManager. <br><br>  Perhaps now it is worth telling a little more about <a href="https://www.ispsystem.ru/software/coremanager">COREmanager</a> .  It is written in a C ++ framework, constructor. <br><br>  Its development began in 2010.  COREmanager was created in order to bring the overall functionality of our products into a separate entity and thus ensure the consistency of the components.  BILLmanager, ISPmanager, VMmanager, DCImanager and other control panels have become extensions of the ‚Äúkernel‚Äù, which is written by a separate team of the most experienced developers of ISPsystem.  As a result, development time was reduced, the probability of bugs appearance decreased, and the speed of work of final products increased. <br><br>  COREmanager is distributed free of charge, has detailed documentation describing its methods of use and is applicable in the development of tools to solve almost any problem.  You can create a menu structure through a web interface or by writing an xml file, and you can use any programming language to implement the event handling mechanism if its interpreter is installed in the operating system. <br><br>  Therefore, ISPlicense chose COREmanager to create a TicketManager.  Yes, you could use ready-made solutions for technical support or solve the problem by writing plug-ins for BILLmanager, but the ISPlicense programmers really wanted to try out what COREmanager could do.  :) <br><br>  After the launch of the outsourcing service, over time, the problems that need to be addressed emerged, and there was a need to develop their technical support system.  The following prerequisites and tasks were formed: <br><br><ul><li>  Each time to enter the panel of each provider to consult users, it takes too much time.  In addition, when a tech support employee works with several providers, confusion may arise because the employee needs to open several browser tabs or windows.  In this case, hosters can use billing from different developers.  Therefore, it is required to aggregate the flow of tickets into one product and bring them to a single form. </li><li>  Since hourly support billing is required, you need to implement a convenient accounting of time spent on the ticket. </li><li>  For convenience and to save time, implement automatic billing that comes to end users (for example, for paid administration). </li><li>  Creating reports and accounts for hosters also automate. </li><li>  In order to avoid unnecessary questions both towards the provider and towards ISPlicense, the end customer should not be aware that the technical support is outsourced. </li></ul><br>  The resulting product consists of two parts: the ticket system itself and the processor that is installed in the customer‚Äôs billing.  There is also an API that allows you to integrate with another technical support system or billing. <br><br>  Let's get acquainted with the key features of the tech support panel. <br>  The list of tickets is minimalist; tools for fine work with requests are available in the menu of viewing the application. <br><br><img src="https://habrastorage.org/files/bb3/37e/ca6/bb337eca685e49b6a58278f5149f155f.png"><br><br>  Let's open any appeal for an example and see what actions you can take with it. <br><br><img src="https://habrastorage.org/files/efa/2a3/0c4/efa2a30c481f4989ad7d1f8424845a63.png"><br><br><ul><li>  <b>Reply</b> .  Blocks the ticket for the operator, opens the reply form and starts recording the time spent. </li><li>  <b>A note</b> .  Allows you to leave for colleagues a note associated with this request.  It will not be visible to either the provider or the end customer. </li><li>  <b>Customer</b>  Opens a large text box for notes tied to the end customer. </li><li>  <b>The project</b> .  Calls a similar field on the host. </li><li>  <b>Withdraw money</b>  Charges money for the provision of services from the end client in the hosting billing system. </li><li>  <b>Close</b> .  Returns to the list of open tickets. </li></ul><br>  In addition, the window shows all information about the initiator of the ticket.  When clicking on the client's id, a transition is made to its billing; when clicking on the server name, a transition is made to the control panel of this server. <br><br>  Information about the service in connection with which the request was received is also displayed, and information about the server where the service is deployed, including access data, is indicated. <br><br>  We block the ticket and look at the active elements of the opened response input form. <br><br><ul><li>  <b>Unlock</b>  Untie the ticket from the operator and allow you to take up the answer to another person. </li><li>  <b>Department</b>  Serves to transfer the application to another division of the hosting provider.  For example, from technical specialists to accounting, when it comes to solving financial issues. </li><li>  <b>Internal comment</b> .  Allows you to write a message on the ticket, which will be hidden from the client and from the provider. </li><li>  <b>Time Spent</b> .  The duration of the response to the ticket.  Measured in minutes.  When you manually change the value, the automatic time calculation stops. </li><li>  <b>Stop the time counter</b> .  It is used in situations where it is assumed that the operator will not take any action in the near future to address the request.  For example, an employee before deploying ISPmanager waits until the installation of the operating system on the virtual machine is completed. </li><li>  <b>Status</b> .  Ticket status. <br><br><ul><li>  <b>Opened</b>  Work is underway on the request. </li><li>  <b>Closed</b>  Request completed. </li><li>  <b>In the process</b> .  Used when a request is executed by a third party, the operation is lengthy, and process control is required.  The request is at the bottom of the list, so as not to distract from the "burning" tasks. </li><li>  <b>Postponed</b> .  The ticket is not displayed in the general list until the time specified in the ‚ÄúDelay until‚Äù field. </li></ul><br></li><li>  <b>Send an internal comment to the provider</b> .  The written will not be visible to the end user, but will be shown to the employees of the hosting provider. </li><li>  <b>Prohibit the closure of the ticket by the client</b> .  Used in dealing with debt issues or illegal activities. </li></ul><br>  During the consultation, the end user does not know that an ISPlicense specialist answers his questions;  He sees that the conversation goes with the employee of his hosting provider. <br><br>  The implementation of the product took about 5000 lines of code for the technical support panel and 500 lines each for the modules for integration with BILLmanager and other billing systems. <br><br>  Those <a href="https://github.com/bdolgov/ticketmgri/wiki/Client-API">interested</a> can learn <a href="https://github.com/bdolgov/ticketmgri/wiki/Client-API">the TicketManager API</a> , and below, under the spoilers, the source code of the integration module for BILLmanager. <br><br>  It turned out that more time was spent on tamping the necessary functionality into a single list than on coding, since the lion's share of the necessary functions was already implemented in COREmanager.  Well, the interface also did not need to write, just specify where the buttons should be. <br><br><div class="spoiler">  <b class="spoiler_title">Makefile</b> <div class="spoiler_text"><pre><code class="hljs pgsql">MGR = billmgr PLUGIN = ticketmgri VERSION = <span class="hljs-number"><span class="hljs-number">5.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> LIB += ticketmgri ticketmgri_SOURCES = ticketmgri.cpp <span class="hljs-keyword"><span class="hljs-keyword">WRAPPER</span></span> += ticketmgri_syncticket ticketmgri_syncticket_SOURCES = ticketmgri_syncticket.cpp ticketmgri_syncticket_LDADD = -lbase BASE ?= /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/mgr5 <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(BASE)/src/isp.mk</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">billmgr_mod_ticketmgri.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mgrdata</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">library</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ticketmgri"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mgrdata</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">ticketmgri.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;api/action.h&gt; #include &lt;api/module.h&gt; #include &lt;api/stdconfig.h&gt; #include &lt;billmgr/db.h&gt; #include &lt;mgr/mgrdb_struct.h&gt; #include &lt;mgr/mgrlog.h&gt; #include &lt;mgr/mgrtask.h&gt; MODULE("ticketmgri"); using namespace isp_api; namespace { StringVector allowedDepartments, hideDepartments; /** *  ,    LongTask ( )   sbin/ticketmgri_syncticket * * [in] _id   */ void SyncTicket(int _id) { string id = str::Str(_id); Warning("Sync %s", id.c_str()); if (!_id) return; mgr_task::LongTask("sbin/ticketmgri_syncticket", "ticket_" + id, "ticketmgri_sync") .SetParam(id) .Start(); } /** *            * *         */ struct eTicketEdit : public Event { /** *  * *         * * ev  ,      * elid_name      .     *            */ eTicketEdit(const string &amp;ev, const string &amp;elid_name = "elid") : Event(ev, "ticketmgri_" + ev), elid_name_(elid_name) { Warning("eTicketEdit created"); } /** *     * *    ,    * [in] ses   */ void AfterExecute(Session &amp;ses) const override { Warning("subm %d cb %s elid %s", ses.IsSubmitted(), ses.Param("clicked_button").c_str(), ses.Param("elid").c_str()); string button = ses.Param("clicked_button"); string elid; if (elid_name_ == "elid_ticket2user") { elid = db-&gt;Query("SELECT ticket FROM ticket2user WHERE id='" + ses.Param("elid") + "'") -&gt;Str(); } else { elid = ses.Param("elid"); } if ((ses.IsSubmitted() || ses.Param("sv_field") == "ok_message") &amp;&amp; (button == "ok" || button == "" || button == "ok_message")) { if (!ses.Has(elid_name_)) { SyncTicket(db-&gt;Query("SELECT MAX(id) FROM ticket")-&gt;Int()); } else { SyncTicket(str::Int(elid)); } } } string elid_name_; }; /** * ,    */ struct eClientTicketEdit : public eTicketEdit { eClientTicketEdit() : eTicketEdit("clientticket.edit") {} /** *    ,  ,   * *    ,    * * [in] ses   */ void AfterExecute(Session &amp;ses) const override { eTicketEdit::AfterExecute(ses); for (auto &amp;i : hideDepartments) { ses.xml.RemoveNodes("//slist[@name='client_department']/val[@key='" + i + "']"); } } }; /** * ,     */ struct aTicketintegrationSetFilter : public Action { aTicketintegrationSetFilter() : Action("ticketintegration.setfilter", MinLevel(lvAdmin)) {} /** *     * *        * * [in] ses   */ void Execute(Session &amp;ses) const override { InternalCall(ses, "account.setfilter", "elid=" + ses.Param("elid")); ses.Ok(ses.okTop); } }; /** *    */ struct aTicketintegrationPost : public Action { aTicketintegrationPost() : Action("ticketintegration.post", MinLevel(lvAdmin)) {} void Execute(Session &amp;ses) const override { Execute(ses, true); } /** *     * * [in] ses   * [in] retry ,       , *     */ void Execute(Session &amp;ses, bool retry) const { auto openTickets = db-&gt;Query("SELECT id FROM ticket2user WHERE ticket=" + ses.Param("elid") + " AND user IN (" + str::Join(allowedDepartments, ",") + ")"); string elid; if (openTickets-&gt;Eof()) { if (ses.Param("type") == "setstatus" &amp;&amp; ses.Param("status") == "closed") { ses.NewNode("ok"); return; } if (retry) { InternalCall(ses, "support_tool_responsible", "set_responsible_default=off&amp;sok=ok&amp;set_responsible=e%5F" + allowedDepartments[0] + "&amp;elid=" + ses.Param("elid")); Execute(ses, false); return; } else { throw mgr_err::Error("cannot_open_ticket"); } } else { elid = openTickets-&gt;Str(); } if (ses.Param("type") == "setstatus" &amp;&amp; ses.Param("status") == "new") { return; } auto ret2 = InternalCall( ses, "ticket.edit", string() + "sok=ok&amp;show_optional=on" + "&amp;clicked_button=" + (ses.Param("status") == "new" ? "ok_message" : "ok") + "&amp;" + (!ses.Checked("internal") ? "message" : "note_message") + "=" + str::url::Encode(ses.Param("message")) + "&amp;elid=" + elid); // TODO: attachments, sender_name ses.NewNode("ok"); } }; /** * ,  ,      */ struct TicketmgriLastNote : public mgr_db::CustomTable { mgr_db::ReferenceField Ticket; mgr_db::ReferenceField LastNote; TicketmgriLastNote() : mgr_db::CustomTable("ticketmgri_last_note"), Ticket(this, "ticket", mgr_db::rtRestrict), LastNote(this, "last_note", "ticket_note", mgr_db::rtRestrict) { Ticket.info().set_primary(); } }; /** * ,  last_note   ticketmgri_last_note */ struct aTicketintegrationLastNote : public Action { aTicketintegrationLastNote() : Action("ticketintegraion.last_note", MinLevel(lvSuper)) {} /** * ,     last_note   *   ticketmgri_last_note * * [in] ses   */ void Execute(Session &amp;ses) const override { auto t = db-&gt;Get&lt;TicketmgriLastNote&gt;(); if (!t-&gt;Find(ses.Param("elid"))) { t-&gt;New(); t-&gt;Ticket = str::Int(ses.Param("elid")); } if (ses.IsSubmitted()) { t-&gt;LastNote = str::Int(ses.Param("last_note")); t-&gt;Post(); ses.Ok(); } else { ses.NewNode("last_note", t-&gt;LastNote); } } }; /** * ,     ,     */ struct aTicketintegrationPushTasks : public Action { aTicketintegrationPushTasks() : Action("ticketintegraion.push_tasks", MinLevel(lvSuper)) {} /** *      ,      *    * * [in] ses   */ void Execute(Session &amp;ses) const override { mgr_xml::XPath xpath = InternalCall("longtask", "filter=yes&amp;state=err&amp;queue=ticketmgri_sync") .GetNodes("//elem[queue='ticketmgri_sync' and status='err']"); for (auto elem : xpath) { auto data = InternalCall("longtask.edit", "elid=" + elem.FindNode("pidfile").Str()); mgr_task::LongTask(data.GetNode("//realname"), data.GetNode("//id"), "ticketmgri_sync") .SetParam(data.GetNode("//params")) .Start(); } } }; /** *       */ struct aTicketintegrationGetBalance : public Action { aTicketintegrationGetBalance() : Action("ticketintegration.getbalance", MinLevel(lvAdmin)) {} /** *         * * [in] ses   */ void Execute(Session &amp;ses) const override { ses.NewNode("balance", InternalCall(ses, "account.edit", "elid=" + ses.Param("elid")) .GetNode("//balance") .Str()); } bool IsModify(const Session &amp;) const override { return false; } }; /** * ,      */ struct aTicketintegrationDeduct : public Action { aTicketintegrationDeduct() : Action("ticketintegration.deduct", MinLevel(lvAdmin)) {} /** *        * *   SQL-     . *          . *    ,   * * [in] ses   */ void Execute(Session &amp;ses) const override { auto openTickets = db-&gt;Query("SELECT id FROM ticket2user WHERE ticket=" + ses.Param("ticket") + " AND user IN (" + str::Join(allowedDepartments, ",") + ")"); if (openTickets-&gt;Eof()) { throw mgr_err::Value("ticket"); } string elid = openTickets-&gt;AsString(0); InternalCall(ses, "ticket.edit", "sok=ok&amp;show_optional=on&amp;elid=" + elid + "&amp;ticket_expense=" + ses.Param("amount")); } }; } // namespace // ,     , //     MODULE_INIT(ticketmgri, "") { Warning("Init TICKETmanager integtration"); mgr_cf::AddParam("TicketmgrUrl", "https://tickets.isplicense.ru:1500/ticketmgr"); mgr_cf::AddParam("TicketmgrLogin"); mgr_cf::AddParam("TicketmgrPassword"); mgr_cf::AddParam("TicketmgrBillmgrUrl"); mgr_cf::AddParam("TicketmgrUserId"); mgr_cf::AddParam("TicketmgrAllowedDepartments"); mgr_cf::AddParam("TicketmgrHideDepartments"); str::Split(mgr_cf::GetParam("TicketmgrAllowedDepartments"), ",", allowedDepartments); if (allowedDepartments.empty()) { allowedDepartments.push_back(0); } str::Split(mgr_cf::GetParam("TicketmgrHideDepartments"), ",", hideDepartments); db-&gt;Register&lt;TicketmgriLastNote&gt;(); new eClientTicketEdit; new eTicketEdit("ticket.edit", "elid_ticket2user"); new eTicketEdit("support_tool_responsible", "plid"); new aTicketintegrationSetFilter; new aTicketintegrationPost; new aTicketintegrationLastNote; new aTicketintegrationPushTasks; new aTicketintegrationGetBalance; new aTicketintegrationDeduct; }</span></span></span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">ticketmgri_syncticket.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;billmgr/db.h&gt; #include &lt;billmgr/defines.h&gt; #include &lt;billmgr/sbin_utils.h&gt; #include &lt;ispbin.h&gt; #include &lt;mgr/mgrclient.h&gt; #include &lt;mgr/mgrdb_struct.h&gt; #include &lt;mgr/mgrenv.h&gt; #include &lt;mgr/mgrlog.h&gt; #include &lt;mgr/mgrproc.h&gt; #include &lt;mgr/mgrrpc.h&gt; MODULE("syncticket"); using sbin::DB; using sbin::GetMgrConfParam; using sbin::Client; using sbin::ClientQuery; /** *         Ticketmanager * *           *   */ mgr_client::Client &amp;ticketmgr() { static mgr_client::Client *ret = []() { mgr_client::Remote *ret = new mgr_client::Remote(GetMgrConfParam("TicketmgrUrl")); ret-&gt;AddParam("authinfo", GetMgrConfParam("TicketmgrLogin") + ":" + GetMgrConfParam("TicketmgrPassword")); return ret; }(); return *ret; } /** *     TICKETmanager * *    ,  xml  c   , * , ,  ,  */ void PostTicket(const string &amp;elid) { //   , ,  auto ticket = DB()-&gt;Query("SELECT * FROM ticket WHERE id=" + elid); if (ticket-&gt;Eof()) throw mgr_err::Missed("ticket"); auto account = DB()-&gt;Query("SELECT * FROM account WHERE id=" + ticket-&gt;AsString("account_client")); if (account-&gt;Eof()) throw mgr_err::Missed("account"); auto user = DB()-&gt;Query("SELECT * FROM user WHERE account=" + account-&gt;AsString("id") + " ORDER BY id LIMIT 1"); if (user-&gt;Eof()) throw mgr_err::Missed("user"); // xml-       mgr_xml::Xml infoXml; auto info = infoXml.GetRoot(); auto customer = info.AppendChild("customer"); customer.AppendChild("id", account-&gt;AsString("id")); customer.AppendChild("name", account-&gt;AsString("name")); customer.AppendChild("email", user-&gt;AsString("email")); customer.AppendChild("phone", user-&gt;AsString("phone")); customer.AppendChild("link", GetMgrConfParam("TicketmgrBillmgrUrl") + "?startform=ticketintegration.setfilter&amp;elid=" + account-&gt;AsString("id")); if (!ticket-&gt;IsNull("item")) { auto item = DB()-&gt;Query("SELECT id, name, processingmodule FROM item WHERE id=" + ticket-&gt;AsString("item")); if (item-&gt;Eof()) throw mgr_err::Missed("item"); auto iteminfo = info.AppendChild("item"); //     iteminfo.SetProp("selected", "yes"); iteminfo.AppendChild("id", item-&gt;AsString("id")); iteminfo.AppendChild("name", item-&gt;AsString("name")); iteminfo.AppendChild("serverid", item-&gt;AsString("processingmodule")); //     ForEachQuery(DB(), "SELECT intname, value FROM itemparam WHERE item=" + ticket-&gt;AsString("item"), i) { if (i-&gt;AsString(0) == "ip") { iteminfo.AppendChild("ip", i-&gt;AsString(1)); } else if (i-&gt;AsString(0) == "username") { iteminfo.AppendChild("login", i-&gt;AsString(1)); } else if (i-&gt;AsString(0) == "password") { iteminfo.AppendChild("password", i-&gt;AsString(1)); } else if (i-&gt;AsString(0) == "domain") { iteminfo.AppendChild("domain", i-&gt;AsString(1)); } } } //      Ticketmanager StringMap args = {{"remoteid", ticket-&gt;AsString("id")}, {"department", ticket-&gt;AsString("responsible")}, {"info", infoXml.Str()}, {"subject", ticket-&gt;AsString("name")}}; ticketmgr().Query("func=clientticket.add&amp;sok=ok", args); } int ISP_MAIN(int ac, char **av) { if (ac != 2) { fprintf(stderr, "Usage: ticketmgri_syncticket ID"); return 1; } string elid = av[1]; try { mgr_log::Init("ticketmgri"); string status = "closed"; int lastmessage = 0; //  ,     string newStatus = DB()-&gt;Query("SELECT COUNT(*) FROM ticket2user WHERE ticket=" + elid + " AND user IN (" + GetMgrConfParam("TicketmgrAllowedDepartments") + ")") -&gt;Int() ? "new" : "closed"; bool inDepartment = DB()-&gt;Query("SELECT COUNT(*) FROM ticket WHERE id=" + elid + " AND responsible IN (" + GetMgrConfParam("TicketmgrAllowedDepartments") + ")") -&gt;Int(); if (newStatus != "new" &amp;&amp; !inDepartment) { LogNote("Skip ticket %s: status=%s, inDepartment=%d", elid.c_str(), newStatus.c_str(), inDepartment); return 0; } try { //     Ticketmanager auto r = ticketmgr().Query("func=clientticket.info&amp;remoteid=?", elid); status = r.value("status"); lastmessage = str::Int(r.value("lastmessage")); } catch (mgr_err::Error &amp;e) { if (e.type() == "missed" &amp;&amp; e.object() == "remoteid") { // ,       PostTicket(elid); } else { throw; } } // last_note   int lastnote = str::Int(Client() .Query("func=ticketintegraion.last_note&amp;elid=" + elid) .value("last_note")); //    auto msg = DB()-&gt;Query( string() + "SELECT ticket_message.id, user.realname AS username, user.level AS " "userlevel, message, 1 AS type, ticket_message.date_post " + "FROM ticket_message " + "JOIN user ON ticket_message.user=user.id " + "WHERE ticket_message.id &gt; " + str::Str(lastmessage) + " " + "AND user != " + GetMgrConfParam("TicketmgrUserId") + " " + "AND ticket = " + elid + " " + "UNION " "SELECT ticket_note.id, user.realname AS username, user.level AS " "userlevel, note AS message, 2 AS type, ticket_note.date_post " + "FROM ticket_note " + "JOIN user ON ticket_note.user=user.id " + "WHERE ticket_note.id &gt; " + str::Str(lastnote) + " " + "AND user != " + GetMgrConfParam("TicketmgrUserId") + " " + "AND ticket = " + elid + " " + "ORDER BY date_post"); //       ,     Ticketmanager if (msg-&gt;Eof() &amp;&amp; status != newStatus) { StringMap params = { {"remoteid", elid}, {"status", newStatus}, }; ticketmgr().Query( "func=clientticket.post&amp;sok=ok&amp;sender=staff&amp;sender_name=System&amp;type=" "setstatus", params); } else { //   Ticketmanager lastnote = 0; for (msg-&gt;First(); !msg-&gt;Eof(); msg-&gt;Next()) { StringMap params = { {"remoteid", elid}, {"status", newStatus}, {"sender_name", msg-&gt;AsString("username")}, {"sender", msg-&gt;AsInt("userlevel") &gt;= 28 ? "staff" : "client"}, {"message", msg-&gt;AsString("message")}, }; int attachments = 0; if (msg-&gt;AsInt("type") == 1) { params["messageid"] = msg-&gt;AsString("id"); //  ForEachQuery( DB(), "SELECT * FROM ticket_message_attach WHERE ticket_message=" + msg-&gt;AsString("id"), attach) { string id = str::Str(attachments++); auto info = ClientQuery("func=ticket.file&amp;elid=" + attach-&gt;AsString("id")); params["attachment_name_" + id] = info.xml.GetNode("//content/name").Str(); params["attachment_content_" + id] = str::base64::Encode( mgr_file::Read(info.xml.GetNode("//content/data").Str())); } } else { lastnote = std::max(lastnote, msg-&gt;AsInt("id")); params["internal"] = "on"; } params["attachments"] = str::Str(attachments); ticketmgr().Query("func=clientticket.post&amp;sok=ok&amp;type=message", params); } //  last_note if (lastnote) { Client().Query("func=ticketintegraion.last_note&amp;sok=ok&amp;elid=" + elid + "&amp;last_note=" + str::Str(lastnote)); } } } catch (std::exception &amp;e) { fprintf(stderr, "%s\n", e.what()); return 1; } return 0; }</span></span></span></span></code> </pre></div></div><br>  The result of the development is a product that made the work of technical support operators more convenient, provided automatic generation of documents, and requests from end users began to be processed faster. <br><br>  The future plans of ISPlicense include the implementation of a desktop mini-application that will give a signal when a new application is received, and will also allow you to stop and resume the accounting of time spent on one or another time in two clicks. <br><br>  In conclusion, I want to add that COREmanager has become the basis not only of TicketManager and all our products.  On its basis, a library fund accounting system, a service for interacting with translators, a tool for organizing joint trips, a task setting system for testers, and this is only a quarter of the list, is implemented.  Due to the fact that modules can be written in any language if you have an interpreter installed on the server, you can write a truly unique product that fits perfectly into your business model. <br><br>  In one of the following articles we will talk about the use of COREmanager in the gaming industry, using the example of an MMO project, in which the solution is used for user accounting, server management, analytics, and many other tasks. <br><br>  <b>PS</b> If you want to learn more about COREmanager, then you can use <a href="https://www.ispsystem.ru/software/coremanager/download">the installation instructions</a> and product <a href="http://doc.ispsystem.ru/index.php/%25D0%259A%25D0%25B0%25D1%2582%25D0%25B5%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%258F:COREmanager">documentation</a> . </div><p>Source: <a href="https://habr.com/ru/post/314886/">https://habr.com/ru/post/314886/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314876/index.html">While the Chinese IT labor market is still adopting American practice, in the US they hire programmers "effortlessly"</a></li>
<li><a href="../314878/index.html">Six issues for cloud security that organizations need to address</a></li>
<li><a href="../314880/index.html">How we implement ITSM. Four defects of service</a></li>
<li><a href="../314882/index.html">Blue screen of death when copying via Remote Desktop is now available on the server platform</a></li>
<li><a href="../314884/index.html">The protagonists of the modern online project</a></li>
<li><a href="../314888/index.html">Desktop virtualization: what's new, what are the trends and where are we going?</a></li>
<li><a href="../314892/index.html">You can download materials from the Nanometer ASIC workshop (RUSNANO / MISiS / Imagination Technologies) - educational program for all chips</a></li>
<li><a href="../314894/index.html">Many JS packages in one repository</a></li>
<li><a href="../314896/index.html">Mobile Antifraud Overview</a></li>
<li><a href="../314898/index.html">Alarm for fridge. Not life, but ‚Äúraspberry‚Äù with RaspberryPi 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>