<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Translation of legacy project to Dependency Injection. Sith Way</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I will also contribute to the trend of dark programming . 
 Many of you are familiar with the dilemma: whether to use DI in your project or not. 
 Rea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Translation of legacy project to Dependency Injection. Sith Way</h1><div class="post__text post__text-html js-mediator-article">  I will also contribute to the trend of <a href="http://habrahabr.ru/post/192320/">dark programming</a> . <br>  Many of you are familiar with the dilemma: whether to use DI in your project or not. <br>  Reasons for switching to DI: <ul><li>  creation of an advanced auto-test system </li><li>  code reuse in various environments, including various projects </li><li>  use of 3rd-party libraries built on DI </li><li>  learning DI </li></ul>  Arguments not to use DI: <ul><li>  complication of code understanding (at first) </li><li>  the need to configure the context </li><li>  learning DI </li></ul><br>  Suppose we have a large working draft, the decision was made: transfer to DI.  Developers feel their potential level midichlorian in the blood rolls over. <br><img src="https://habrastorage.org/getpro/habr/post_images/cc6/bdc/711/cc6bdc711f607edb74b597118a6794f9.jpg" width="400"><br>  <i>The path is waiting for you thorny and long, my young Padawan.</i> <br><br>  If the project is large and there are a lot of developers, it is unlikely to be able to do this refactoring with one commit.  Therefore, we use several bad practices, simplifying the transition, and then get rid of them. <br><a name="habracut"></a><br><h5>  Where to begin </h5>  DI has a remarkable feature to open architectural jambs in the code, so it makes sense to carry out the preparatory work.  In the concept of DI, all classes can be conditionally divided into two categories - let's call them services and bins.  The first exist, as a rule, in a single copy within the context and are attached to it.  The second ones store the processed data themselves and can refer to other bins, but not to services.  Sometimes there are mixed variations: <pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jetbrains.annotations.Nullable; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Jedi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long masterId; <span class="hljs-comment"><span class="hljs-comment">// fields, constructors, getters/setters, equals, hashCode, toString, etc... public long getId() { return id; } public String getName() { return name; } @Nullable public Long getMasterId() { return masterId; } @Nullable public Jedi getMaster() { if (masterId == null) { return null; } return DBJedi.getJedi(masterId); } }</span></span></code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/7c3/022/91e/7c302291e07c5db41437bbdd118e4e56.jpg" width="400"><br><br>  The decent Jedi getMaster method will remove it altogether or transfer it to another class (service).  As a result, the Jedi class will become just a bin with data.  If the transfer of the method for any reason is now impossible (for example, code that cannot be refactored depends on it), you can declare it deprecated and leave something for now (alternatively, declare the version in which this method will be removed, as the Guava developers do) ). <br>  Now let's deal with DBJedi: <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DBJedi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Jedi </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJedi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span><span class="hljs-function"> </span></span>{ DataSource dataSource = ConnectionPools.getDataSource(<span class="hljs-string"><span class="hljs-string">"jedi"</span></span>); Jedi jedi; <span class="hljs-comment"><span class="hljs-comment">// magic return jedi; } }</span></span></code> </pre>  It is logical to convert such a class into a classic singleton, for example, like this: <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.sql.DataSource; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DBJedi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DBJedi instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DBJedi(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ConnectionPools connectionPools; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DBJedi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.connectionPools = ConnectionPools.getInstance(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> DBJedi </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Jedi </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJedi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span><span class="hljs-function"> </span></span>{ DataSource dataSource = connectionPools.getDataSource(<span class="hljs-string"><span class="hljs-string">"jedi"</span></span>); Jedi jedi; <span class="hljs-comment"><span class="hljs-comment">// magic return jedi; } }</span></span></code> </pre>  As a result, we get a more coherent and readable code structure (a very controversial fact, of course).  If you finish what has been started, in general, the transition to DI can be done using standard guidelines. <br>  But if you are a Sith, then surely there are classes left (in our example, the Jedi class with the getMaster method), which are not translated in a standard way. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now you need to think again about the advisability of screwing DI.  If the desire is still left - continue. <br>  Examples will be mainly on Guice, partially duplicated on Spring.  As for choosing a framework, choose the one you know best. <br><br><h5>  Bad practice 1 - save static link to Injector </h5><img src="https://habrastorage.org/getpro/habr/post_images/852/79b/b22/85279bb22379eb75607eefdcf9034c42.jpg" width="400"><br>  At some point, the question arises - where to get the injector instance to pull out the singletones?  Let's get a utility class: <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jetbrains.annotations.NotNull; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jetbrains.annotations.TestOnly; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.inject.Injector; <span class="hljs-comment"><span class="hljs-comment">// import com.google.common.base.Preconditions; // guava public class InjectorUtil { private static volatile Injector injector; public static void setInjector(@NotNull Injector injector) { // Preconditions.checkNotNull(injector); // Preconditions.checkState(InjectorUtil.injector == null, "Injector already initialized"); InjectorUtil.injector = injector; } @TestOnly public static void rewriteInjector(@NotNull Injector injector) { // Preconditions.checkNotNull(injector); InjectorUtil.injector = injector; } @Deprecated // use fair injection, Sith! @NotNull public static Injector getInjector() { // Preconditions.checkState(InjectorUtil.injector != null, "Injector not initialized"); return InjectorUtil.injector; } }</span></span></code> </pre>  For Spring, the code will be similar, but instead of Injector, the ApplicationContext.  Or another option: <div class="spoiler">  <b class="spoiler_title">Perfectionist nightmare</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ApplicationContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ApplicationContextAware; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Named; <span class="hljs-meta"><span class="hljs-meta">@Named</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextUtil</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextAware</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> ApplicationContext applicationContext; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setApplicationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ ApplicationContextUtil.applicationContext = applicationContext; } <span class="hljs-meta"><span class="hljs-meta">@Deprecated</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ApplicationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getApplicationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Preconditions.checkState(applicationContext != null); return applicationContext; } }</span></span></code> </pre></div></div><br>  Now our singletons can be rewritten like this: <pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@javax</span></span>.inject.Singleton <span class="hljs-meta"><span class="hljs-meta">@javax</span></span>.inject.Named <span class="hljs-comment"><span class="hljs-comment">//   Spring component-scan,  Guice   public class DBJedi { private final ConnectionPools connectionPools; @javax.inject.Inject public DBJedi(ConnectionPools connectionPools) { this.connectionPools = connectionPools; } @Deprecated public static DBJedi getInstance() { return InjectorUtil.getInjector().getInstance(DBJedi.class); } public Jedi getJedi(long id) { DataSource dataSource = connectionPools.getDataSource("jedi"); Jedi jedi; // ... return jedi; } }</span></span></code> </pre>  Please note that the JSR-330 annotations are used, the javax.inject package.  Using them, you can later more easily switch from one DI to another, ideally abstracting from a specific framework altogether (assuming JSR-330 compatibility).  The Named annotation will allow not to record the bean in the spring-context.xml, if the xml configuration still implies such an entry, the annotation should be removed. <br><br><h5>  Bad Practice 2 - Bean Factory </h5><img src="https://habrastorage.org/getpro/habr/post_images/e66/ae0/81a/e66ae081a4f07a371ad4fe682475ea63.jpg" width="400"><br>  If the class is a bean with data, but at the same time refers to singleton objects, you can make a factory class: <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Jedi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long masterId; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DBJedi dbJedi; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Jedi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, String name, @Nullable masterId, DBJedi dbJedi)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.masterId = masterId; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbJedi = dbJedi; } <span class="hljs-comment"><span class="hljs-comment">//... public long getId() { return id; } public String getName() { return name; } @Nullable public Long getMasterId() { return masterId; } @Nullable public Jedi getMaster() { if (masterId == null) { return null; } return dbJedi.getJedi(masterId); } @Singleton @Named public static class Factory { private final DBJedi dbJedi; @Inject public Factory(DBJedi dbJedi) { this.dbJedi = dbJedi; } @Deprecated // refactor Jedi class to simple bean, Sith! public Jedi create(long id, String name, @Nullable masterId) { return new Jedi(id, name, masterId, dbJedi); } } }</span></span></code> </pre><br><h5>  Bad practice 3 - cyclic dependencies </h5><img src="https://habrastorage.org/getpro/habr/post_images/fe8/ba8/b2d/fe8ba8b2d98746e5c5bbc53874a0a469.jpg" width="400"><br>  In our example, a cyclical relationship is formed between the DBJedi and Jedi.Factory classes.  When we try to create these objects at runtime, we get a DI-container error, for example, StackOverflowError.  Here the Provider interface comes to the rescue: <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Singleton; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Named; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Inject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Provider; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.sql.DataSource; <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Named</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DBJedi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ConnectionPools connectionPools; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Provider&lt;Jedi.Factory&gt; jediFactoryProvider; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DBJedi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConnectionPools connectionPools, Provider&lt;Jedi.Factory&gt; jediFactoryProvider)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.connectionPools = connectionPools; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.jediFactoryProvider = jediFactoryProvider; } <span class="hljs-meta"><span class="hljs-meta">@Deprecated</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> DBJedi </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> InjectorUtil.getInjector().getInstance(DBJedi.class); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Jedi </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJedi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span><span class="hljs-function"> </span></span>{ DataSource dataSource = connectionPools.getDataSource(<span class="hljs-string"><span class="hljs-string">"jedi"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... final Jedi.Factory jediFactory = jediFactoryProvider.get(); return jediFactory.create(id, name, masterId); } }</span></span></code> </pre>  It is true to note that generic declarations are not available through Reflection.  As for Guice and Spring, they both read the bytecode of the class and thus get a generic type. <br><br><h5>  We write tests </h5><img src="https://habrastorage.org/getpro/habr/post_images/aa6/7d0/70b/aa67d070bab94749774a9e208a10ca4a.jpg" width="400"><br>  There is a great Guice annotation in testng that simplifies code testing.  For Spring - the artifact org.springframework: spring-test. <br>  Let's make a test for our classes: <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testng.annotations.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.inject.Injector; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.inject.AbstractModule; <span class="hljs-meta"><span class="hljs-meta">@Guice</span></span>(modules = JediTest.JediTestModule.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JediTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> JEDI_QUI_GON_ID = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> JEDI_OBI_WAN_KENOBI_ID = <span class="hljs-number"><span class="hljs-number">22</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Injector injector; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DBJedi dbJedi; <span class="hljs-meta"><span class="hljs-meta">@BeforeClass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setInjector</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ InjectorUtil.rewriteInjector(injector); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testJedi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Jedi obiWan = dbJedi.getJedi(JEDI_OBI_WAN_KENOBI_ID); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Jedi master = obiWan.getMaster(); Assert.assertEquals(master.getId(), JEDI_QUI_GON_ID); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JediTestModule</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ConnectionPools , ..      bind(ConnectionPools.class).toInstance(new ConnectionPools("pools.properties")); } } }</span></span></code> </pre><br><h5>  What is the result </h5>  As a result, we have two possible outcomes.  The first is to stay on top.  It happened in one of my projects, it was not possible to translate it entirely into an honest DI, there was a lot of legacy code in it.  I think this situation is familiar to many.  You can improve it a bit, for example, replacing the static field in InjectorUtil with ThreadLocal, thus solving the problem of concurrent testing with different DI-environments in the same static space. <br><div class="spoiler">  <b class="spoiler_title">Read more</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InjectorUtil</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;Injector&gt; threadLocalInjector = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InheritableThreadLocal&lt;Injector&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InjectorUtil</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-comment"><span class="hljs-comment">/** * Get thread local injector for current thread * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> IllegalStateException if not set */</span></span> <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Injector </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInjector</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IllegalStateException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Injector Injector = threadLocalInjector.get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Injector == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"Injector not set for current thread"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Injector; } <span class="hljs-comment"><span class="hljs-comment">/** * Set Injector for current thread * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Injector * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> java.lang.IllegalStateException if already set */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setInjector</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NotNull Injector injector)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IllegalStateException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (injector == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NullPointerException(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (threadLocalInjector.get() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"Injector already set for current thread"</span></span>); } threadLocalInjector.set(injector); } <span class="hljs-comment"><span class="hljs-comment">/** * Rewrite Injector for current thread, even if already set * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> injector * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> previous value if was set */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Injector </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rewriteInjector</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NotNull Injector injector)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (injector == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NullPointerException(); } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Injector prevInjector = threadLocalInjector.get(); threadLocalInjector.set(injector); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prevInjector; } <span class="hljs-comment"><span class="hljs-comment">/** * Remove Injector from thread local * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Injector if was set, else null */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Injector </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeInjector</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Injector prevInjector = threadLocalInjector.get(); threadLocalInjector.remove(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prevInjector; } }</code> </pre></div></div>  The second is to finish the job.  In our example, we‚Äôll first get rid of the Jedi.getMaster method, then Jedi will turn into a simple bean.  After that, remove the class Jedi.Factory.  Cyclic dependence will also disappear.  As a result, the InjectorUtil class itself will not be.  Projects without such a class are a reality.  It is not necessary to go through all these stages, but let me remind you that we are talking about the situation of the legacy project, in the new project such a problem can be avoided from the very beginning. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ed6/f4b/644/ed6f4b6449c2d732bb9b39d16fc0ba87.jpg" width="400"><br><br>  In fact, this is not all.  If the project that you are translating to DI is a general library, it makes sense to abstract from the DI itself, but this is already a topic for a separate post. <br><br><div class="spoiler">  <b class="spoiler_title">Those who read to the end</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/be1/e5f/13e/be1e5f13efb8d336306506c478766048.jpg" width="400"></div></div><br>  <i>May the --force be with you.</i> </div><p>Source: <a href="https://habr.com/ru/post/217523/">https://habr.com/ru/post/217523/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217507/index.html">Is Dripstat a performance monitoring service for a JVM or MMO game?</a></li>
<li><a href="../217515/index.html">lodash (underscore) - know your standard library</a></li>
<li><a href="../217517/index.html">Useful for Android Developer # 2</a></li>
<li><a href="../217519/index.html">Activate multiplayer on your smartphone with Android 4</a></li>
<li><a href="../217521/index.html">Optimize LIMIT offset</a></li>
<li><a href="../217525/index.html">Comparative testing of 32 GB SDHC memory cards of UHS-I standard</a></li>
<li><a href="../217527/index.html">Wu-tang Clan plans to sell only one copy of his new album.</a></li>
<li><a href="../217529/index.html">Cheat Miguel?</a></li>
<li><a href="../217535/index.html">For what in Dart metadata</a></li>
<li><a href="../217537/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ102 (March 23 - 29, 2014)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>