<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple USB Keyboard Emulation with PIC18F2550 in Android CarPC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear members of Habrahabr. 

 Given that Habr is a portal focused on programmers, I noticed that recently there are many articles about program...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple USB Keyboard Emulation with PIC18F2550 in Android CarPC</h1><div class="post__text post__text-html js-mediator-article"> Hello, dear members of Habrahabr. <br><br>  Given that Habr is a portal focused on programmers, I noticed that recently there are many articles about programming microcontrollers and creating devices based on them.  I decided to share one of his development.  In the past, I wrote a lot for MK, I even worked as a software and circuit design developer at one of the firms, and before that I had a programmer on AFM under Z80 and i8080.  Now, in adulthood, I mostly write in PHP / MySQL for my own Internet projects and programming MK has not returned for a long time.  I cannot call myself a full-fledged programmer, because  for example, I could not master OOP, but I write some C as needed. <br><br>  Some time ago I had a task to create a USB keyboard emulator for the CarPC project.  It had to be used in the Becker BE2580 radio tape recorder installed on German-made cars of the 2000s.  The emulator had to poll regular radio buttons and generate clicks on a virtual USB keyboard connected to an Android-based CarPC motherboard.  What came out of it, under the cut. <br><a name="habracut"></a><br>  Briefly about CarPC itself: initially, I had the seditious idea to plug a new-fashioned Android-based recorder into the car with a removable front-panel tablet, which recently began to be produced by Chinese manufacturers.  However, the comrades in the auto-community dissuaded me from this idea, urging me not to disturb the classic look of the car‚Äôs interior and the design conceived by the manufacturer.  As a result, the motherboard from the Iconbit Toucan Nano media player was built into the radio, I installed it in place of the cassette tape player.  At the same time, he noted how progress is progressing: I decided to check the cassette for the sake of interest, but at home there was not a single cassette. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Toucan Nano is an ideal candidate for use in CarPC, at a price of about $ 100 (in the Russian Federation) it has a TV output (composite), a component (subtractive with a dedicated clock signal), though, unfortunately, there is no RGB needed for output images on the display in the radio itself.  There is HDMI, USB host (2 ports).  The PL2303 chip support (USB2COM converter, ie RS232) was compiled back into the core - which allowed connecting an external GPS receiver, as well as supporting WiFi whistles on the Ralink chip (I used Dlink DWA-140).  The board was installed in the radio, the signal from the TV output was fed to the RGB inputs of the standard monitor of the radio using the self-assembled TV -&gt; RGB converter based on the TDA8362.  In the radio, a video signal switch is provided, so the entire native functionality of the radio tape recorder has been saved.  It looks like this: <br><br><img src="https://habrastorage.org/storage2/ce8/f9c/584/ce8f9c584d116251b73f9f35d4c25b36.jpg"><br><br>  The red color shows what is placed on the second floor (under the board).  With the Toucan Nano in the kit comes a remote, paired with a radio whistle.  The console features an interesting Fly Mouse technology: the mouse reacts to an accelerometer built into the console, thus simply tilting the console, moving the mouse around the screen of the device, it turns out something like a pointer.  However, it seemed uncomfortable and stupid to use it in the car: it‚Äôs still a radio tape recorder, not a computer!  Therefore, it was decided to assemble a radio keyboard keyboard emulator that would connect to the USB port and behave like a standard PC keyboard, while polling the radio button.  In fact, this solution is universal and can be used with any OS: it‚Äôs no secret that many CarPC systems are built on Intel platforms. <br><br>  It so happened that at that time I had no experience with PIC microcontrollers, in my youth I was an Atmel programmer, but this experience was no longer relevant today, since  10 years have passed and now, probably, nobody remembers my favorite AT89c2051 now.  The programs were then written strictly on ASMe, since  On C, it would just be harder, for 2051 there are only 2K ROMs.  In those years, the PIC also existed, but we refused to use it, because  the development tools were too expensive, and for 2051 I then developed a ROM emulator on my own based on the i51 with an external ROM that had the same instruction set as the Atmel 89c2051.  Now, having understood that I will have to go through this path practically anew, I gathered my spirit and sat down for literature.  I think that the experience will be useful to the readers because I am painting everything in steps, in development. <br><br>  At first I began to study the Internet on the topic of microcontrollers with USB support and immediately came across a device from the glorious company PIC, it was 18F2550.  Its declared functions turned out to be very good: USB 2.0 support, 1K RAM, a fully configurable USB port, in fact, the 2550 can become <i>any</i> USB device.  Plus all the standard PIC features.  This chip can be purchased in a DIP28 package, which is convenient for mounting and desoldering, and the price is quite low.  In ancient times, microcontrollers were sewed by the programmer, but now bootloaders have become popular.  The meaning of the bootloader is that it is enough to write it into the microcontroller only once, after which you can access it by any other means (in our case via the USB port) and update the firmware of the device without removing it from the circuit.  Ready-made whales with pre-flashed microcontrollers and ready-made software for uploading firmware through a bootloader are sold, but I didn‚Äôt want to look for such a whale (or rather, wait for it to be sent).  So I just went to the nearest radio store and bought a clean PIC18F2550. <br><br>  Next, it was necessary to assemble a programmer to fill the bootloader.  Poshariv on an Internet, found this: <br><br>  <a href="http://products.foxdelta.com/progparallel.htm">products.foxdelta.com/progparallel.htm</a> <br><br>  The scheme is attached there.  Simplified it, of course, removing unnecessary details, because  soldering was too lazy.  In fact, the pins of the microcontroller connected directly to the LPT.  Software used WinPic800.  About the bootloader itself is a separate story.  It is loaded from the address 0x000, respectively, the program itself must begin with the address 0x800, which is indicated in the compiler settings.  I found several different bootloaders, they pour the firmware in different modes (for example, HID), respectively, designed for different IDEs.  USB PIC Driver for the stitching computer can also be used differently, because  PIC "turns" into different USB devices.  I constantly came across bootloaders for 18F4550, and its config is different and the bootloader does not work on it from my MK.  As a result, I stopped at the bootloader and the firmware loader based on the MCHPUSB PIC-based demo board.  The bootloader itself had to be slightly modified under my circuitry (since I placed the bootloader button on another pin of the microcontroller).  In general, there turned out to be many different parameters (for example, the type of a quartz resonator, a frequency multiplier, and a lot of similar nonsense).  If these parameters are incorrectly specified, the device is sewn and even the LED flashes according to the program, but then refuses to work as a USB device, producing my ‚Äúfavorite‚Äù error ‚ÄúUSB device not recognized‚Äù, since  frequencies are wrong.  With this problem, I spent a couple of days, until I finally found a workable configuration.  As a result, my bootloader is designed for quartz 4Mhz.  The LED is soldered on the RA5, the button for activating the firmware mode for the bootloader is on the RA3 (and 1kOhm plus), 26 feet to the ground (for operation in LVP mode).  In order for the MC to enter the bootloader mode, hold down the reset, press the specified button on the RA3.  The LVP bit (turning off the low-voltage firmware mode) for some reason failed to reflash me, well, okay.  In theory, it is needed to protect the bootloader from overwriting.  The multiplier is tuned to a maximum frequency of 48 Mhz.  Unfortunately, if the microcontroller is used in USB mode, the frequency cannot be raised, because  USB frequencies are fixed, and the multiplier has multiplicity, but it turned out and is not necessary. <br><br>  As a result, the bootloader corrected, the driver for the computer from Microchip installed.  As a basis for the program, I immediately took a free sample from Bradley A. Minch, which sequentially issues the symbols 'f', 'o', 'o', 'b', 'a', 'r' to the virtual keyboard.  The source code of this program can be found here: <br><br>  <a href="">code.google.com/p/picusb/source/browse/lab2_pickit2/lab2.asm?spec=svn69&amp;r=69</a> <br><br>  Having compiled the program, having previously configured a bunch of PIC configuration registers, I achieved that it started typing <i>foobar</i> on my computer in a loop!  Hooray!  In reality, all this did not happen in one day either, but I omit the details.  And here I was apprehended for a second by the fear that all this miracle might not work on Iconbit, which can, without explanation, just ignore almost a week of my work - and I will never know why.  But, having connected the device to the Android motherboard, I saw that everything worked: a search window opened right away in which the familiar letters of foobar ran.  Android on pressing any keys responds by opening the search window. <br><br>  Then it was necessary to modify the program to my needs, in particular, to write code that will read data from the radio itself.  How it will work, at that time I had no idea.  I thought I would have to connect to the matrix of the radio and read from it.  Typically, such devices use a dynamic scan of the matrix, when along the X axis "runs" one, and on the Y axis information is read.  Ie, say, 16 keys can be processed with 8 pins (4 + 4).  To simultaneously read such a matrix, you also need 8 pins, but tuned to the input.  However, having rummaged on the board of the radio tape recorder, I found that the caring Germans had isolated a separate processor for processing the entire keyboard, the only thing is that the encoder handles went directly to the central percent.  As a result, at the keyboard of the radio, I found an exit on which impulses appear when I press any keys of the radio.  The pulse repetition rate turned out to be quite high and, to begin with, I just stupidly connected them to the converter based on PL2303, i.e.  just served on the RS-232 port and started experimenting with the port settings.  As a result, it turned out that meaningful bytes can be seen by setting the port to 480 kbps.  For me, still a mystery why the Germans needed to transfer data from the keyboard at such a high speed. <br><br>  In order to write a program for the PIC, we had to analyze in detail the nature of the pulses of the keyboard processor of the radio.  For this, I bought an oscilloscope.  In my youth, of course, I had all these devices, but all this remained with my parents, and I already moved 5 years ago to Moscow.  Therefore, I decided to slowly collect an instrument park: I return to radio amateur from time to time. <br><br>  As a result, it turned out that the processor in front of each packet of information (which consists of 2 bytes), gives a long pulse, which serves as a ‚Äúpilot‚Äù warning about the beginning of the transfer of a block of information.  It was surprising that the length of this block (as well as the intervals between bytes) change in an arbitrary manner, even when you press the same button.  Another problem was that the PIC could not programmatically reliably read data at that speed.  After all, he must also manage to maintain the USB bus!  If a key is pressed at the wrong moment, it simply skips it.  As I wrote above, I raised the core frequency to the maximum with the help of multipliers, but even with this setting, the processor worked at the limit and sometimes skipped bits, as a result, the probability of correctly defining the buttons was about 70%, which is unacceptable in a car.  Here I have already collected my mind and thought that, probably, there is a second signal (strobe).  So it turned out.  But initially I did not find him because for some reason the impulses are constantly present on it, but it would be logical if they would appear when the buttons are pressed.  Apparently, the radio processor polls the keyboard in a continuous cycle and generates a pulse when any bit is transmitted, even if the state of the keys does not change.  Ie, just sending zeros if there is no activity.  In general, the processor gates every transmitted bit, as a result they can be read absolutely clearly.  I rewrote the PIC program, after which everything began to work stably and beautifully.  When a button is pressed, one code is formed, when released, another.  Thus, it was possible to still implement the button holding mode, but I did not do this, because  buttons and so it turned out to be abundant. <br><br>  Here I will give excerpts from my program, the parts that I wrote.  You can see the original of the program at the link above.  In the program, I have, of course, a table that compares the read key codes and USB codes that need to be transferred to the head device.  Immediately, I note that I usually write comments in English (in order not to lose time on switching the register).  If someone is interested in the full version of the program, I can send it without any problems.  The full text is not given here for reasons of copyright compliance.  I can also send a bootloader and a program for its firmware, a program for uploading firmware. <br><br>  Recoding buttons. <br><br><pre><code class="hljs pgsql">unsigned <span class="hljs-type"><span class="hljs-type">char</span></span> recode(long n) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x3550</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Q'</span></span>; // &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">REVERSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x1580</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'U'</span></span>; // up - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x6aa0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'X'</span></span>; // next - <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x2540</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'D'</span></span>; // down - <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x4a80</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Z'</span></span>; // prev - <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x1570</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'L'</span></span>; // left - <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x0560</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'R'</span></span>; // right - <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x4520</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'H'</span></span>; // home <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x0ac0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'A'</span></span>; // player <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x6500</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'T'</span></span>; // TEL ?? <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x5530</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'N'</span></span>; // navi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x7510</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'S'</span></span>; // settings <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x1b28</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'B'</span></span>; // back <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x4500</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'E'</span></span>; // enter <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x28e0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'M'</span></span>; // (MAP) ?? <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x1320</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'O'</span></span>; // notification area - REPEAT <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">0x0330</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'F'</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">search</span></span>/find - <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-type"><span class="hljs-type">int</span></span> remap(<span class="hljs-type"><span class="hljs-type">int</span></span> n) { // launcher <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'S'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x3a</span></span>; // F1 settings/menu <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'F'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x3b</span></span>; // F2 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'O'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x3c</span></span>; // F3 notification area // programs <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'H'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x3D</span></span>; // F4 home <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'A'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x3f</span></span>; // F6 audio/player <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'N'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x40</span></span>; // F7 navi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'M'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x44</span></span>; // F11 map <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'T'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x45</span></span>; // F12 tel // player controls <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'Z'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x3e</span></span>; // F5 prev song <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'X'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x43</span></span>; // F10 next song //<span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'L'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x50</span></span>; // left <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'R'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x4f</span></span>; // right <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'U'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x52</span></span>; // up <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'D'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x51</span></span>; // down <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'E'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x28</span></span>; // enter <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-string"><span class="hljs-string">'B'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x29</span></span>; // ESC back <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x0</span></span>; }</code> </pre> <br><br>  Configs: <br><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config DEBUG = OFF // 1L 30000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config PLLDIV = 1 // PLL prescaler //#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CPUDIV = OSC3_PLL4 // sysclock postscaler - working #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CPUDIV = OSC1_PLL2 // sysclock postscaler #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config USBDIV = 2 // usb clock comes from PLL div 2 // 1H 30001 // #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config FOSC = XTPLL_XT // low speed mode #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config FOSC = HSPLL_HS // highspeed mode #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config FCMEN = OFF // fail safe clock #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config IESO = OFF // int/ext oscillator // 2L 30002 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config PWRT = OFF // power up timer #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config BOR = OFF // brown out #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config BORV = 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config VREGEN = ON // usb voltage regulator // 2H 30003 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WDT = OFF // watchdog #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WDTPS = 32768 // 3H 30005 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CCP2MX = ON // ccp2 mux #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config PBADEN = OFF // portb a/d enable #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config LPT1OSC = ON // low power timer 1 oscillator #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config MCLRE = ON // MCLR pin enable // 4L 30006 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config STVREN = ON // stack full #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config LVP = ON #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config XINST = OFF // extended instructions // 30008 //#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config ICPRT = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CP0 = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CP1 = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CP2 = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CP3 = OFF // 30009 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CPB = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CPD = OFF // 3000a #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WRT0 = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WRT1 = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WRT2 = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WRT3 = OFF // 3000b #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WRTB = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WRTC = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WRTD = OFF // 3000c #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config EBTR0 = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config EBTR1 = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config EBTR2 = OFF #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config EBTR3 = OFF // 3000d #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config EBTRB = OFF //#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SHOW_ENUM_STATUS #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED PORTAbits.RA5 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CAR PORTAbits.RA0 // keypad data </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EN1 PORTAbits.RA1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EN2 PORTAbits.RA2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SYN PORTAbits.RA3 // keypad strobe </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span></span></code> </pre> <br><br>  Part of the configs is redefined by the programmer when uploading the bootloader. <br><br>  Transfer key code to USB interface: <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> SendKeyBuffer(<span class="hljs-type"><span class="hljs-type">void</span></span>) { unsigned <span class="hljs-type"><span class="hljs-type">char</span></span> n; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n&lt;<span class="hljs-number"><span class="hljs-number">8</span></span>; n++) BD1I.address[n] = Key_buffer[n]; // <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span> Key_buffer <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> EP1 <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> buffer BD1I.bytecount = <span class="hljs-number"><span class="hljs-number">0x08</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> the EP1 <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> byte count <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> BD1I.status = ((BD1I.status&amp;<span class="hljs-number"><span class="hljs-number">0x40</span></span>)^<span class="hljs-number"><span class="hljs-number">0x40</span></span>)|<span class="hljs-number"><span class="hljs-number">0x88</span></span>; // toggle the DATA01 <span class="hljs-type"><span class="hljs-type">bit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the EP1 <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> status register <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> the UOWN <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> DTS bits } <span class="hljs-type"><span class="hljs-type">int</span></span> sendKey1(unsigned <span class="hljs-type"><span class="hljs-type">char</span></span> c) { <span class="hljs-type"><span class="hljs-type">int</span></span> n; long timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n&lt;<span class="hljs-number"><span class="hljs-number">8</span></span>; n++) Key_buffer[n] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; // clear key buffer // ?? hang place <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((BD1I.status&amp;<span class="hljs-number"><span class="hljs-number">0x80</span></span>)) { // wait <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> see <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> UOWN <span class="hljs-type"><span class="hljs-type">bit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> EP1 <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> status register <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> clear, (ie, PIC owns EP1 <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> buffer) timeout++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timeout&gt;<span class="hljs-number"><span class="hljs-number">250000</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } ServiceUSB(); } *(Key_buffer+<span class="hljs-number"><span class="hljs-number">2</span></span>)=c; SendKeyBuffer(); ServiceUSB(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-type"><span class="hljs-type">int</span></span> sendKey(unsigned <span class="hljs-type"><span class="hljs-type">char</span></span> c) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sendKey1(c)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (sendKey1(<span class="hljs-number"><span class="hljs-number">0x00</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><br>  Subroutines read radio buttons.  To maximize speed <br>  the loop is not used.  Every beat is important. <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">char</span></span> readByte() { unsigned <span class="hljs-type"><span class="hljs-type">char</span></span> b = <span class="hljs-number"><span class="hljs-number">0</span></span>; // unsigned <span class="hljs-type"><span class="hljs-type">char</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">0</span></span>); b = (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) | CAR; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">0</span></span>); b = (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) | CAR; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">0</span></span>); b = (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) | CAR; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">0</span></span>); b = (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) | CAR; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">0</span></span>); b = (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) | CAR; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">0</span></span>); b = (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) | CAR; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">0</span></span>); b = (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) | CAR; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">0</span></span>); b = (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) | CAR; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SYN==<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> b; } <span class="hljs-type"><span class="hljs-type">int</span></span> countZero() { unsigned short i=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (CAR==<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; i++); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i/<span class="hljs-number"><span class="hljs-number">4</span></span>; } <span class="hljs-type"><span class="hljs-type">int</span></span> readCar() { <span class="hljs-type"><span class="hljs-type">int</span></span> i; <span class="hljs-type"><span class="hljs-type">int</span></span> d = <span class="hljs-number"><span class="hljs-number">0</span></span>; unsigned <span class="hljs-type"><span class="hljs-type">char</span></span> k; unsigned <span class="hljs-type"><span class="hljs-type">char</span></span> r; unsigned long vl; //#define analyzer //#define dbg // <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> mode <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CAR==<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; #ifdef analyzer <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;<span class="hljs-number"><span class="hljs-number">110</span></span>;i++) { carbuff[i]=readByte(); carbuff[i+<span class="hljs-number"><span class="hljs-number">110</span></span>]=ssd; // strobe data } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;<span class="hljs-number"><span class="hljs-number">221</span></span>;i++) { printHex(carbuff[i]); } crlf(); crlf(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; #endif // <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> analyzer <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (CAR==<span class="hljs-number"><span class="hljs-number">1</span></span>); // short intro <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (CAR==<span class="hljs-number"><span class="hljs-number">0</span></span>); // short intro <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (CAR==<span class="hljs-number"><span class="hljs-number">1</span></span>); // long intro <span class="hljs-number"><span class="hljs-number">1</span></span> vl = readByte() * <span class="hljs-number"><span class="hljs-number">0x100</span></span> + readByte(); k = recode(vl); #ifdef dbg printDword(vl); // dbg crlf(); // dbg #endif <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (k!=<span class="hljs-number"><span class="hljs-number">0</span></span>) { #ifdef dbg printChar(k); // dbg crlf(); // dbg #endif #ifndef dbg r=remap(k); // send actual keys we need <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sendKey(r); #endif } }</code> </pre><br><br>  CAR - pin to which the signal from the keyboard of the radio tape recorder is connected.  SYN - strobe signal from the keyboard processor radio. <br><br>  In the process of debugging, I ran into a number of problems.  In some cases, the microcontroller hung and the USB device simply disappeared.  The USB exchange protocol is very complicated and it was not easy to delve into all its nuances.  Through trial and error, I found problem areas and added a software watchdog there, which simply restarted the processor in case of a hang in these places.  As a result, I have achieved a stable trouble-free operation of the program without lags with the accuracy of determining keystrokes 99%.  The USB port in the Toucan itself does not work very well, especially since I used a USB splitter.  Sometimes even ‚Äúserious‚Äù devices like USB mouse whistle disappear until the next reboot.  What to say about my homemade.  However, I managed to achieve stability at the level of factory USB devices. <br><br>  Next, it was necessary to connect the encoder.  I decided to send the data from the encoder to emulate the ‚Äúup‚Äù and ‚Äúdown‚Äù buttons, and press the encoder knob to the Enter key.  Well, pressing processes the processor, i.e.  it is already working.  As for the encoder, it is easy to implement its reading.  If its pins are connected to two bits, it outputs the sequence 0, 1, 3, 2 (in binary code 00 01 11 10).  The two with the three is reversed, it turns out 0 1 2 3. Next, we subtract the current result from the previous one, if the difference is 1 or -3, then the rotation in one direction, if -1 or 3, is in the other.  I saw that reading the encoder is implemented by some kind of table, in general, nothing needs to be done.  Here is the procedure: <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">int</span></span> readEncoder() { <span class="hljs-type"><span class="hljs-type">int</span></span> k; <span class="hljs-type"><span class="hljs-type">int</span></span> enc; <span class="hljs-type"><span class="hljs-type">int</span></span> subb; <span class="hljs-type"><span class="hljs-type">int</span></span> res = <span class="hljs-number"><span class="hljs-number">1</span></span>; static <span class="hljs-type"><span class="hljs-type">int</span></span> enc1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; static <span class="hljs-type"><span class="hljs-type">int</span></span> init = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!init) { // prevent encoder key command sent <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> startup init = <span class="hljs-number"><span class="hljs-number">1</span></span>; enc1 = enc = EN1 + EN2 * <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enc==<span class="hljs-number"><span class="hljs-number">3</span></span> || enc==<span class="hljs-number"><span class="hljs-number">2</span></span>) enc=enc ^ <span class="hljs-number"><span class="hljs-number">1</span></span>; } enc = EN1 + EN2 * <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enc==<span class="hljs-number"><span class="hljs-number">3</span></span> || enc==<span class="hljs-number"><span class="hljs-number">2</span></span>) enc=enc ^ <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enc != enc1) { subb = enc - enc1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (subb==<span class="hljs-number"><span class="hljs-number">1</span></span> || subb==<span class="hljs-number"><span class="hljs-number">-3</span></span>) k=<span class="hljs-string"><span class="hljs-string">'U'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (subb==<span class="hljs-number"><span class="hljs-number">-1</span></span> || subb==<span class="hljs-number"><span class="hljs-number">3</span></span>) k=<span class="hljs-string"><span class="hljs-string">'D'</span></span>; res = sendKey(remap(k)); // send up <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> down key command } enc1 = enc; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; }</code> </pre> <br><br>  Now PowerAMP is controlled clearly: a pen-encoder and it is enter!  Use the pen to go through the folders with the music, with the button we enter them and launch the songs.  Dream! <br><br>  I will add that the codes generated by the virtual keyboard are not ASCII codes or even Android key codes (which also differ from ASCII codes).  These are separate USB keyboard codes.  You can find them in this table: <br><br>  <a href="http://www.win.tue.nl/~aeb/linux/kbd/scancodes-14.html">www.win.tue.nl/~aeb/linux/kbd/scancodes-14.html</a> <br><br>  Accordingly, in Android there is a special config that is responsible for handling specials.  keys.  Of course, I had to launch both navigation and use the Home button and launch the player.  For this purpose, you need to edit the keylayout file, a description of these files is here: <br><br>  <a href="http://source.android.com/tech/input/key-layout-files.html">source.android.com/tech/input/key-layout-files.html</a> <br><br>  Here is my config: <br><br>  <i>key 1 BACK # ESC ("AC" button)</i> <i><br></i>  <i>key 59 MENU # F1 ("BC" button)</i> <i><br></i>  <i>#key 60 CAMERA # F2 ("CALL" button)</i> <i><br></i>  <i>key 61 NOTIFICATION # F3 ("repeat" key on deck)</i> <i><br></i>  <i>key 62 HOME # F4 ("main" button)</i> <i><br></i>  <i>key 63 MEDIA_PREVIOUS # F5 ("4" button)</i> <i><br></i>  <i>key 64 HEADSETHOOK # PLAY / PAUSE F6 ("audio" button)</i> <i><br></i>  <i>#key 65 INFO # F7 ("navi" button)</i> <i><br></i>  <i>key 66 VOLUME_UP # F8 ??</i> <i><br></i>  <i>key 67 VOLUME_DOWN # F9 ??</i> <i><br></i>  <i>key 200 HEADSETHOOK # hardware key # MEDIA_STOP not working</i> <i><br></i>  <i>key 68 MEDIA_NEXT # F10 ("6" button)</i> <i><br></i>  <i>key 87 POWER # F11 ('map' key on deck)</i> <i><br></i>  <i>#key 88 EMAIL # F12 ("tel" button)</i> <br><br>  Of course, you can edit this file only on rooted devices. <br><br>  It so happened that some keys do not work after installing the latest update on Toucan Nano.  Why - I never managed to find out.  For example, the most important HOME button has stopped working.  Therefore, I wrote a simple command file that starts with me when I start the system.  Here he is: <br><br>  <i>#! / system / bin / sh</i> <i><br></i>  <i>stty -F / dev / ttyUSB0 ispeed 4800</i> <i><br></i>  <i>chmod 0777 / dev / ttyUSB0</i> <i><br><br></i>  <i>sleep 20</i> <i><br></i>  <i>am broadcast -a info.mapcam.droid.SERVICE_START # mapcam.info</i> <i><br><br></i>  <i>while true</i> <i><br><br></i>  <i>do</i> <i><br><br></i>  <i>s = $ (getevent -v0 -c1) # read one event from all input devices</i> <i><br></i>  <i># -v0 so that it does not sprinkle a bunch of unnecessary garbage</i> <i><br><br></i>  <i>s = $ (echo $ s | awk '{print $ 4}') # select the keycode</i> <i><br><br></i>  <i>case $ s in # execute the necessary command</i> <i><br></i>  <i>0007003f) am start -a android.intent.action.MAIN -c android.intent.category.HOME -n com.maxmpz.audioplayer / .StartupActivity # AUDIO</i> <i><br></i>  <i># am start -a android.intent.action.MAIN -c android.intent.category.HOME -n com.maxmpz.audioplayer / .PlayListActivity # AUDIO</i> <i><br></i>  <i>sleep 1</i> <i><br></i>  <i>;;</i> <i><br><br></i>  <i>00070040) am start -n ru.yandex.yandexmaps / .MapActivity # NAVI</i> <i><br></i>  <i>sleep 1</i> <i><br></i>  <i>;;</i> <i><br><br></i>  <i>0007003d) am start -a android.intent.action.MAIN -c android.intent.category.HOME</i> <i><br></i>  <i>sleep 1</i> <i><br></i>  <i>;;</i> <i><br><br></i>  <i>00070045) am start -a android.intent.action.MAIN -n com.speedsoftware.rootexplorer / .RootExplorer # TEL</i> <i><br></i>  <i>sleep 1</i> <i><br></i>  <i>;;</i> <i><br><br></i>  <i>0007003b) am startservice -a "org.broeuschmeul.android.gps.usb.provider.nmea.intent.action.START_GPS_PROVIDER"</i> <i><br></i>  <i>sleep 5</i> <i><br></i>  <i>am broadcast -a info.mapcam.droid.SERVICE_START</i> <i><br></i>  <i># am start -n info.mapcam.droid / .SpeedometrActivity # CALL</i> <i><br></i>  <i>sleep 1</i> <i><br></i>  <i>;;</i> <i><br></i>  <i>esac</i> <i><br><br></i>  <i>done</i> <br><br>  This emulator has been successfully used on the machine for almost a year.  Plans to emulate a mouse so that it can be moved around the screen with buttons.  Integrating the touchscreen into the system, I, unfortunately, have not mastered it yet.  Unfortunately, a number of programs (for example, Rambler Maps) are not controlled by buttons and require a touchscreen.  Therefore, all the same for such cases in the car have to carry a USB mouse. <br><br>  About the Android project, I can somehow tell you separately if it will be interesting. <br><br><img src="http://habrastorage.org/storage2/fa8/538/82c/fa853882c23541436d44efe2ca255e6c.jpg"><br><br></div><p>Source: <a href="https://habr.com/ru/post/162003/">https://habr.com/ru/post/162003/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../161989/index.html">Perl6 - I / O Modules</a></li>
<li><a href="../161991/index.html">Weather Station Thunder-2M (Anemometer)</a></li>
<li><a href="../161993/index.html">Programmable microcontroller STM32 - right off the bat</a></li>
<li><a href="../161997/index.html">Comfortable lighting for work and leisure</a></li>
<li><a href="../161999/index.html">256 colors in the terminal ‚áí nightmare level</a></li>
<li><a href="../162005/index.html">Copyright history. Part 1: The Black Death</a></li>
<li><a href="../162007/index.html">The future is near: Queen Elizabeth is broadcasting in 3D</a></li>
<li><a href="../162009/index.html">Anonymous collective signature algorithm</a></li>
<li><a href="../162011/index.html">Copyright history. Part 2: Bloody Mary</a></li>
<li><a href="../162013/index.html">Valve plans to release a "living room PC for Linux"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>