<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Big Brother is watching yourself ... or a map with a history of movements in HomeAssistant</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 For my home automation, I have been using HomeAssistant for a long time. Once a friend asked me, saying, why does HomeAssistant have th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Big Brother is watching yourself ... or a map with a history of movements in HomeAssistant</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  For my home automation, I have been using HomeAssistant for a long time.  Once a friend asked me, saying, why does HomeAssistant have the ability to indicate only the current position of the tracker on the map, but you cannot display the entire route?  Since then, this idea captured me.  And once I realized that I myself really want to have this function right now.  Anyone who cares what came of it, welcome under the cat‚Ä¶ <br><a name="habracut"></a><br><h3>  Intelligence service </h3><br>  Actually, to display the route you need to have a set of points with coordinates, so the first step was to find out where HomeAssistant stores the necessary data (if it stores at all) and how to get it from there.  A brief study of the original source immediately led to a solution: the included recorder module is needed to record the states of the necessary sensors in the database at different points in time, as well as the history module, which allows you to receive data from the database in a beautiful way.  The history module has a well-documented <a href="https://developers.home-assistant.io/docs/en/external_api_rest.html">REST API</a> .  Exactly what is needed! <br><br>  Next, you need to somehow display the data on the map.  There are many different services that allow you to display the history of movements.  I‚Äôve probably tried far from all of them, but I‚Äôll allow myself a few words about what I‚Äôve tested: <br>  <b>A.</b>  yandex and google.  Actually, for my needs there is everything and even more, but due to paid services and strong limitations of free versions, they did not suit me right away.  Yandex, for example, allows free use only for open source projects (that is, anyone should be able to open your resource and take advantage of its capabilities at any time), not to mention other limitations in the number of requests.  Only lazy didn‚Äôt write about changes in Google‚Äôs api policy.  At the moment, as I understand it, each request to maps api or directions api is paid, the more requests - the cheaper.  However, each user with a bank card connected to the account is given a free limit of $ 200 per month.  Everything on top is immediately paid from your card.  Linking a card to an account is not our way. <br><br>  Correct, if I made a mistake somewhere about google and / or yandex. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>B.</b>  A bunch of <a href="https://openrouteservice.org/">OpenRouteService</a> and OpenRouteService maps.  In principle, the possibilities are not much different from google or yandex (in any case, I did not notice).  Completely free (there are restrictions on the number of requests per day and per minute, above which it is advised to contact support ... there is no description of any paid tariffs at all).  However, the use of the OpenRouteService maps resource turned out to be inconvenient (long application loading and annoying wide menu on the left, which opens by default and is not disabled by API, besides, the service does not open correctly from mobile devices).  To be fair, OpenRouteService maps can be put on your server and it is quite possible that it is allowed to configure everything for yourself. <br><br>  <b>C.</b>  <a href="https://github.com/MapBBCode/mapbbcode">Mapbbcode</a> .  I stumbled upon an interesting implementation of maps in a simple format.  In principle, the project is absolutely suitable for my task, but from this article I learned about <a href="https://leafletjs.com/">Leaflet</a> and decided to turn to the original source.  I finally stopped on it ... <br><br>  <b>G.</b>  Leaflet.  Very good open-source js library for maps, easy to learn and well documented.  From chips: allows you to use tiles from many services (openstreetmaps, yandex, google, mapbox, microsoft, etc., etc.).  Additionally, I used the <a href="https://github.com/bbecquet/Leaflet.PolylineDecorator">leaflet.polylineDecorator</a> plugin to indicate the direction of movement on the map. <br><br>  It is worth mentioning that the last two considered resources do not support ‚Äúroutes‚Äù, that is, they do not know how to connect points along existing roads and / or sidewalks, but simply connect points with a straight line.  For me personally, this is not a problem, but a deliberate step.  If you just need to navigate the roads, then you need to look towards the paid google, yandex or free openrouteservice. <br><br><h3>  Implementation </h3><br>  The request to the history module through the REST-API is quite simple (hereinafter, the code will be in the HomeAssistant language, i.e. python) and allows you to get an answer in the form of easy-to-understand JSON: <br><br><pre><code class="python hljs">response = requests.get(self._haddr + <span class="hljs-string"><span class="hljs-string">'/api/history/period/'</span></span> + dayBegin + <span class="hljs-string"><span class="hljs-string">'?filter_entity_id='</span></span> + self._myid, headers={<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: <span class="hljs-string"><span class="hljs-string">'Bearer '</span></span> + self._token, <span class="hljs-string"><span class="hljs-string">'content-type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>}) data = response.json()[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre> <br>  here self._haddr is the address of your HA the same as specified in the frontend settings, self._myid is the device_tracker device id whose route we will build, dayBegin is the beginning of the period for displaying the route, I chose the beginning of the current day by default, self._token is a long-life token for accessing the api, which can be obtained from the HomeAssistant interface. <br><br>  When the object whose history we are trying to display on the map is stationary for a long time or moves extremely slowly, we will get a bunch of points closely spaced and clogging the map.  To correct the situation, let us pass the resulting array of coordinates through the filter: if the distance between the previous point and the next is less than 100 meters, then do not display the point on the map.  To calculate the distances between two neighboring points, we use a simplified formula with <a href="http://www.movable-type.co.uk/scripts/latlong.html">equiangular approximation</a> .  The approximation is applicable when the distance between adjacent points does not exceed a few km: <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDistance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, latA, lonA, latB, lonB)</span></span></span><span class="hljs-function">:</span></span> dst = <span class="hljs-number"><span class="hljs-number">0</span></span> latRadA = math.radians(latA) lonRadA = math.radians(lonA) latRadB = math.radians(latB) lonRadB = math.radians(lonB) x = latRadB - latRadA y = (lonRadB-lonRadA)*math.cos((latRadB+latRadA)*<span class="hljs-number"><span class="hljs-number">0.5</span></span>) dst = <span class="hljs-number"><span class="hljs-number">6371</span></span>*math.sqrt(x*x+y*y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dst</code> </pre> <br>  Here dst distance in km. <br><br>  Describe the Leaflet API here does not see the point.  Behind this - on the <a href="https://leafletjs.com/reference-1.4.0.html">official site</a> .  The module works as follows: Every n seconds (I have been set to 300), a request is made to the current history of the object of interest to me.  The resulting array of coordinates is run through the distance filter, reducing the number of points.  Further, in the folder with the HomeAssistant configuration, 2 files are created in the www folder: index.html and route.html.  The route.html file contains all the logic for creating a map.  And the index.html file is a lifehack warning of page caching.  By default, HomeAssistant caches everything that is possible, and only resetting the cache helped to update the data on the card, which, of course, is unacceptable.  In the index.html file, the contents of route.html are invoked, however, with a randomly dynamically generated parameter that allows you to always request the current version of the route.html file from the server: <br><br><pre> <code class="xml hljs">src = 'route.html?datetime=' + (new Date()).getTime() + Math.floor(Math.random() * 1000000)</code> </pre> <br><h3>  Little security </h3><br>  HomeAssistant is designed so that all files within the www directory are public, that is, any file within the www directory can be opened in any browser without any authorization, knowing the direct link.  In the case of my module, this link is: <a href="https://your_address_homeassistant/local/route/index.html">your_address_homeassistant / local / route / index.html</a> .  If this is not critical for you, you can skip this section.  I went a little further and screwed the authorization to the page with routes.  For this, I used nginx (you can choose another web server with support for reverse proxy) as a proxy server.  The HomeAssistant website has official <a href="https://www.home-assistant.io/docs/ecosystem/nginx/">instructions</a> for setting up this configuration.  After setting up the proxy and checking the operation in the nginx configuration, you need to add authorization for the necessary pages: <br><br><pre> <code class="plaintext hljs">location /local/route/route.html { proxy_pass http://localhost:8123/local/route/route.html; proxy_set_header Host $host; proxy_redirect http:// https://; proxy_http_version 1.1; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; auth_basic "Unauthorized"; auth_basic_user_file /etc/nginx/.htpasswd; }</code> </pre> <br>  Then create the file "/etc/nginx/.htpasswd", and in the console execute the following commands in sequence: <br><br><pre> <code class="bash hljs">sh -c <span class="hljs-string"><span class="hljs-string">"echo -n 'admin:' &gt;&gt; /etc/nginx/.htpasswd"</span></span> sh -c <span class="hljs-string"><span class="hljs-string">"openssl passwd -apr1 &gt;&gt; /etc/nginx/.htpasswd"</span></span></code> </pre> <br>  admin - replace with the desired login. <br><br>  After that, we restart nginx and check: when trying to open a page with a route, the browser must request a login and password.  I note that this is a separate authorization, not related to the authorization of the HomeAssistant itself. <br><br><h3>  Conclusion </h3><br>  Perhaps all that you can tell about this module. <br>  Anyone interested, <a href="https://yadi.sk/d/buRKuNkJ7xDLzg">here is the link</a> to the module.  The file should be located along the path: config_folder_homeassistant / custom_components / route / sensor.py, do not forget about the rights. <br><br>  If it does not exist, create the folder config_folder_homeassistant / www and grant the corresponding rights to it. <br><br>  Register the following lines in the configuration.yaml configuration file: <br><br><pre> <code class="plaintext hljs">sensor: - platform: route name: route entityid: your_device_tracker_entity_id haddr: your_address_homeassistant token: your_long_life_token</code> </pre> <br>  here your_device_tracker_entity_id is the ID of your device device_tracker, your_address_homeassistant is the external address of your HomeAssistant, your_long_life_token is the access token previously received in the frontend of HomeAssistant to use REST API. <br><br>  After that, restart HomeAssistant and enjoy.  The map will be available through a direct link: <a href="https://your_address_homeassistant/local/route/index.html">your_address_homeassistant / local / route / index.html</a> .  If you wish, you can add it to the HA menu using panel_iframe or to any HA window via the lovelace card ‚Äúiframe‚Äù. <br>  That's all, thank you for your attention. </div><p>Source: <a href="https://habr.com/ru/post/448656/">https://habr.com/ru/post/448656/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448642/index.html">Mandatory distribution model of rights in FreeBSD</a></li>
<li><a href="../448644/index.html">Applicative regular expressions as a free alternative functor</a></li>
<li><a href="../448648/index.html">How to spread all on science and not to turn the office into a hotbed of hatred</a></li>
<li><a href="../448652/index.html">Mozilla WebThings on Raspberry Pi - Getting Started</a></li>
<li><a href="../448654/index.html">Mozilla WebThings - gateway setup</a></li>
<li><a href="../448658/index.html">What can be done through the OBD connector in the car</a></li>
<li><a href="../448660/index.html">In this position, you will be a bad developer.</a></li>
<li><a href="../448662/index.html">"Russia 404": the option is not for show</a></li>
<li><a href="../448664/index.html">Making cards like Tinder on Swift</a></li>
<li><a href="../448666/index.html">How we chose the service for electronic document management with customers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>