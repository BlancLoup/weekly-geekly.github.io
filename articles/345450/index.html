<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Technoporn with WebAssembly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the request of workers, I am writing about the internal structure of WebAssembly. 


 WebAssembly - bytecode for the stack virtual machine. So, to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Technoporn with WebAssembly</h1><div class="post__text post__text-html js-mediator-article"><p>  At the request of workers, I am writing about the internal structure of WebAssembly. </p><br><p>  WebAssembly - bytecode for the stack virtual machine.  So, to run such a code, an interpreter, a stack, and a code storage are needed.  If we want to interact with the outside world, we need an interface to the external machine, the host.  Additionally, the standard defines two structures: continuous memory and tables.  In the MVP version of the standard, there may be one each, or not at all. </p><br><p>  As a result, our technoborel looks like this: </p><br><img src="https://habrastorage.org/webt/4v/rn/y5/4vrny5vvcvx1ymc3vv2h2fynei4.png" align="right" width="320"><br><ul><li>  Interpreter </li><li>  Host interface </li><li>  Stack </li><li>  Code storage </li><li>  Memory </li><li>  Table </li></ul><br><p>  Let's do business! </p><a name="habracut"></a><br><h2 id="stekovaya-virtualnaya-mashina">  Stack virtual machine. </h2><br><p>  There are two basic types of machine architectures: stack and register.  We are interested in stack. </p><br><p> <a href="http://www.sternkn.com/stack-based-vs-register-based-virtual-machine-architecture-and-the-dalvik-vm/"><img src="https://habrastorage.org/getpro/habr/post_images/c19/61c/f77/c1961cf77d690ce1660340fe1ab27a90.png" alt="image"></a> </p><br><p>  All stack machine operations obviously work with a stack of variables.  The WebAssembly virtual machine has two features: </p><br><ul><li>  Formalization: the code can always unambiguously calculate the stack size and value types at any stage of execution </li><li>  Stack independence: variables on the stack can not be addressed by pointer </li></ul><br><p>  The remaining principles of the machine are usual: before performing the operation, the operands must be pushed onto the stack.  The operation takes the arguments from the stack, runs and puts the result on the stack. </p><br><p>  When you call a function from WebAssembly, the interpreter: </p><br><ol><li>  Puts function arguments on stack </li><li>  Supplements them with local variables. </li><li>  Performs work </li><li>  Removes local variables and parameters from the stack, leaving only the result </li></ol><br><p>  There are only 4 types of variables in the standard: </p><br><ul><li>  i32: 32-bit integer </li><li>  i64: 64-bit integer </li><li>  f32: 32-bit floating point </li><li>  f64: 64-bit floating point </li></ul><br><p>  Neither the character nor the types of 16-bit and 8-bit values ‚Äã‚Äãare defined.  All this is at the mercy of the source language compiler.  In the case of C / C ++ / Rust, local variables will be extended to 32-bit values.  Pointers are represented as i32, which allows only 4GB of memory to be addressed.  A version of wasm64 with 64-bit pointers in development. </p><br><p>  Let's look at an example: </p><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value + <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><pre> <code class="hljs swift">(module ;; <span class="hljs-type"><span class="hljs-type">C</span></span> :   i32,   i32 (type (;<span class="hljs-number"><span class="hljs-number">0</span></span>;) (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(param i32)</span></span></span></span> (result i32))) ;;   -   (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(;</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">;)</span></span></span></span> (type <span class="hljs-number"><span class="hljs-number">0</span></span>) (param i32) (result i32) (local i32 i32) i32.const <span class="hljs-number"><span class="hljs-number">1</span></span> ;;  <span class="hljs-number"><span class="hljs-number">1</span></span>   set_local <span class="hljs-number"><span class="hljs-number">1</span></span> ;;    <span class="hljs-number"><span class="hljs-number">1</span></span>,     get_local <span class="hljs-number"><span class="hljs-number">0</span></span> ;;     <span class="hljs-number"><span class="hljs-number">0</span></span> (  ) get_local <span class="hljs-number"><span class="hljs-number">1</span></span> ;;     <span class="hljs-number"><span class="hljs-number">1</span></span> i32.add ;;       set_local <span class="hljs-number"><span class="hljs-number">2</span></span> ;;    <span class="hljs-number"><span class="hljs-number">2</span></span>    get_local <span class="hljs-number"><span class="hljs-number">2</span></span> ;;     <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>) ;;   ,   (export <span class="hljs-string"><span class="hljs-string">"incr_decr"</span></span> (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> 0)))</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Trivia</b> <div class="spoiler_text"><p>  The syntax is highlighted for ocaml, which is built on the same <a href="https%253A%252F%252Fru.wikipedia.org%252Fwiki%252FS-%2525D0%2525B2%2525D1%25258B%2525D1%252580%2525D0%2525B0%2525D0%2525B6%2525D0%2525B5%2525D0%2525BD%2525D0%2525B8%2525D0%2525B5%26amp%3Busg%3DAOvVaw0X9i5v-boa4mVb6TIuQMWZ">S-expressions</a> as the WebAssembly text format.  Suddenly such a dirty hack someone come in handy. </p><br><p>  As you can see, the compiler creates quite a lot of unnecessary code for managing local variables.  To eliminate this, <a href="https://github.com/WebAssembly/binaryen/commit/a0de358f7d73222501775e5f21ed4ec9838311cb">an optimizer pass</a> has recently been <a href="https://github.com/WebAssembly/binaryen/commit/a0de358f7d73222501775e5f21ed4ec9838311cb">added</a> to binaryen. </p><br><p>  I cite examples not in the handwritten form of S-expressions, but in the form of decompiling a binary format using WABT.  So it is easier to understand from the habit, IMHO. </p></div></div><br><h2 id="ustroystvo-koda">  Device code. </h2><br><p>  The code in WebAssembly is the commands for the virtual machine that control the state of affairs on the stack.  Traditionally they are called opcodes (from the operation code).  The standard set of codes is less than 255, so when binary encoding such codes occupy one byte.  Extension sets (SIMD, streams, exceptions) define their sets of opcodes for which single-byte prefixes are used.  That is, the opcode extension takes two bytes. </p><br><p>  All basic operations are represented by opcodes: arithmetic, type conversions, work with local variables and memory, function calls, execution flow control. </p><br><p>  Opcodes are grouped into functions.  Each function has a sequence number and signature: a list of parameters and return values ‚Äã‚Äãwith an indication of the type.  Based on the signature, it is determined how many values ‚Äã‚Äãto take from the stack, and how many to return. </p><br><p>  Functions are called with the <code>call</code> and <code>call_indirect</code> .  First put the arguments on the stack, and as a result, the arguments will be dropped, and the result <del>  laid </del>  added to stack </p><br><pre> <code class="hljs go"> (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(;0;)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">type</span></span></span></span><span class="hljs-function"><span class="hljs-params"> 0)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(param f64 f32)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result f32)</span></span></span><span class="hljs-function"> ;;       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_local</span></span></span><span class="hljs-function"> 1 ) </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">func</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (;1;)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">type</span></span></span></span><span class="hljs-function"><span class="hljs-params"> 1)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result f32)</span></span></span><span class="hljs-function"> ;;      </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f64</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x1p</span></span></span><span class="hljs-function">+6 </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(;=64;)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f32</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x1p</span></span></span><span class="hljs-function">+5 </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(;=32;)</span></span></span><span class="hljs-function"> ;;   0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> 0 ;;     , ;;       )</span></span></code> </pre> <br><p>  In the traditional assembler, cycles and conditional transitions are organized using <code>goto</code> analogs.  But in WebAssembly <del>  out of hate for goto </del>  went the other way. </p><br><p>  Inside the function, the code is organized into blocks.  There are three types of blocks: </p><br><ul><li>  <code>block .. end</code> - a normal block, with the help of which conditional transitions are organized, sets the label of the transition to the opcode <code>end</code> </li><li>  <code>loop .. end</code> is a block for organizing loops, sets the transition label to the <code>loop</code> opcode (that is, the block interrupt command actually restarts this block) </li><li>  <code>if .. else .. end</code> - a dedicated block for conditions; interrupting a block causes a transition to the <code>end</code> opcode, as for a normal block. </li></ul><br><p>  There are transition commands for blocks: </p><br><ul><li>  <code>br</code> - unconditional transition </li><li>  <code>br_if</code> - conditional jump, take the value from the stack and interrupt the target block if the value is not zero </li><li>  <code>br_table</code> - table transition, used for switch analogs, interrupts a block determined by an index taken from the stack </li></ul><br><p>  A jump command parameter is a block that it interrupts.  The block is indicated by the depth of nesting: 0 - the last open block, 1 - immediately before the last open one. </p><br><p>  Blocks serve as stack limiters and can return values.  Inside the block it is impossible to remove from the stack the arguments that were on the stack at the time of entering the block.  If the return value is not specified by the block, the stack size at the input to the block will correspond to the size at the exit of the block.  Return values ‚Äã‚Äãwill be added to the stack above. </p><br><p>  The system came out quite unusual for those who are used to the traditional <code>if-else-end</code> and <code>while</code> , and for those who are used to working with <code>goto</code> . </p><br><p>  It looks like this: </p><br><pre> <code class="hljs lisp">(<span class="hljs-name"><span class="hljs-name">func</span></span> (<span class="hljs-name"><span class="hljs-name">type</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">param</span></span> i32) (<span class="hljs-name"><span class="hljs-name">result</span></span> i32) i32.const <span class="hljs-number"><span class="hljs-number">1</span></span> block (<span class="hljs-name"><span class="hljs-name">result</span></span> i32) <span class="hljs-comment"><span class="hljs-comment">;;    i32.const 2 drop ;;      i32.const 4 block (result i32) ;;    i32.const 8 get_local 0 ;;       br_if 1 ;;         ;;    ,     8   drop ;;   8   i32.const 1 ;;    end br_if 0 ;;      0,   1 drop i32.const 16 end i32.add ;;    )</span></span></code> </pre> <br><p>  Moving to the table is a bit more complicated: </p><br><pre> <code class="hljs kotlin">(func (type <span class="hljs-number"><span class="hljs-number">5</span></span>) (param i32) (result i32) block ;;   <span class="hljs-number"><span class="hljs-number">4</span></span> block ;;   <span class="hljs-number"><span class="hljs-number">3</span></span> block ;;   <span class="hljs-number"><span class="hljs-number">2</span></span> block ;;   <span class="hljs-number"><span class="hljs-number">1</span></span> block ;;   <span class="hljs-number"><span class="hljs-number">0</span></span> get_local <span class="hljs-number"><span class="hljs-number">0</span></span> ;;   ;;         ;;    ,   ;;  (<span class="hljs-number"><span class="hljs-number">4</span></span>   ) br_table <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> i32.<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-number"><span class="hljs-number">99</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> end i32.<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> end i32.<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-number"><span class="hljs-number">101</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> end i32.<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-number"><span class="hljs-number">102</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> end i32.<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-number"><span class="hljs-number">103</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> end i32.<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-number"><span class="hljs-number">104</span></span> )</code> </pre> <br><p>  To understand, in C it looks like this: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">switch_test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> l0)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(l0) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">103</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">102</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">101</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">104</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre> <br><p>  Further, the cycles look like this: </p><br><pre> <code class="hljs go">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(;16;)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">type</span></span></span></span><span class="hljs-function"><span class="hljs-params"> 2)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(param i64)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result i64)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(local i64)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i64</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_local</span></span></span><span class="hljs-function"> 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">block</span></span></span><span class="hljs-function"> ;;     </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function">    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function"> ;;    </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0)</span></span></span><span class="hljs-function">:    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_local</span></span></span><span class="hljs-function"> 0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i64</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eqz</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">br_if</span></span></span><span class="hljs-function"> 1 ;;     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_local</span></span></span><span class="hljs-function"> 0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_local</span></span></span><span class="hljs-function"> 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i64</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mul</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_local</span></span></span><span class="hljs-function"> 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_local</span></span></span><span class="hljs-function"> 0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i64</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i64</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_local</span></span></span><span class="hljs-function"> 0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">br</span></span></span><span class="hljs-function"> 0 ;;     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unreachable</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_local</span></span></span><span class="hljs-function"> 1 )</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Details from the kitchen of writing the interpreter</b> <div class="spoiler_text"><p>  Although you are bursting, but in the code for execution, all the interpreters I have seen convert all the control instructions into goto analogues even at the reading stage.  So faster and more familiar to machine code.  What are the reasons for choosing such a format of control structures for bytecode?  Is it only for beautiful <em>handwriting</em> ? </p></div></div><br><h2 id="pamyat">  Memory </h2><br><p>  Complex operations in WebAssembly are performed through continuous memory.  For WebAssembly, continuous blocks of memory of 64 kilobytes are allocated from host memory.  According to the requirements of the standard, the blocks should be allocated only for special needs; neither the stack, nor the tables, nor external resources should be stored in them.  Addressing inside the memory is strictly controlled, receiving or recording at an address outside the block is considered an error.  Thus, a sandbox is created for safe work with memory.  So that the malware on wasm does not have access to the host memory. </p><br><p>  Since the stack is limited to basic data types, all operations on complex and composite types are performed through memory.  In the same memory are stored static and global variables, string literals. </p><br><p>  From the inside, opcodes of the type <code>TYPE.storeN</code> and <code>TYPE.loadN</code> work with memory.  The first one writes a variable or its part into memory at a given offset, the second one loads at a given offset. </p><br><p>  Memory is the only way to transfer large enough objects of complex types between WebAssembly and a host.  On a host, memory is usually represented by an array of bytes.  Pointers to memory are <code>i32</code> type <code>i32</code> that store the offset within this array.  WebAssembly can request more memory with the <code>grow_memory</code> operation.  In this case, usually, a new array is allocated with a new size; old data is copied to a new array. </p><br><p>  Having knowledge of the memory device, you can finally write the most famous program: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello_world</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>; }</code> </pre> <br><pre> <code class="hljs swift">(module (type (;<span class="hljs-number"><span class="hljs-number">0</span></span>;) (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result i32)</span></span></span></span>)) (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(;</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">;)</span></span></span></span> (type <span class="hljs-number"><span class="hljs-number">0</span></span>) (result i32) ;;         ;;          i32.const <span class="hljs-number"><span class="hljs-number">16</span></span> ;;     <span class="hljs-number"><span class="hljs-number">16</span></span> -      <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>) (memory (;<span class="hljs-number"><span class="hljs-number">0</span></span>;) <span class="hljs-number"><span class="hljs-number">1</span></span>) (export <span class="hljs-string"><span class="hljs-string">"hello_world"</span></span> (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> 0)) ;;         , ;;       . ;;      16 </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(i32.const </span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">16</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span></span></span> <span class="hljs-string"><span class="hljs-string">"Hello World!\00"</span></span>))</code> </pre> <br><h2 id="tablicy">  Tables </h2><br><p>  A table is a continuous container for items of a specific type (one of the basic types of WebAssembly).  Tables, like memory, can be used to communicate with a host.  Unlike memory, tables are strongly typed.  From a design point of view, lists of links for garbage collection, lists of external resources like file descriptors and sockets can be made based on tables.  Now the table is allowed only one and it is used with a strictly defined goal: for the work <code>call_indirect</code> . </p><br><p>  <code>call_indirect</code> , which is indirect or virtual call, is a tool for calling code that cannot be given a name when compiling.  This can be shown on the example of virtual functions in C ++.  At compilation, we determine the offset of the function in the virtual functions table, and the table itself can be determined while the program is running. </p><br><p>  <code>call_indirect</code> is also used to call function pointers.  In this way, you can organize a call to a pointer to a host function that was not imported into the module directly: put this function in a table during code execution and use <code>call_indirect</code> . </p><br><p>  Understand easier by example: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Vec2</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y; Vec2(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y) : x(x), y(y) { } <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~Vec2() { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sq_dist</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x * x + y * y; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_3d</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Vec3</span></span></span><span class="hljs-class"> :</span></span> Vec2 { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> z; Vec3(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> z) : Vec2(x, y), z(z) { } <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~Vec3() { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sq_dist</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Vec3::sq_dist() + z * z; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_3d</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }; <span class="hljs-function"><span class="hljs-function">Vec2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeVec2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Vec2 ( x, y ); } <span class="hljs-function"><span class="hljs-function">Vec3 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeVec3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> z)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Vec3 ( x, y, z ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sq_dist</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Vec2 &amp;vec)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vec.sq_dist(); }</code> </pre> <br><pre> <code class="hljs bash">(module (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> (;0;) (func (param i32) (result f32))) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> (;1;) (func (param i32))) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> (;2;) (func)) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> (;3;) (func (param i32) (result i32))) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> (;4;) (func (param i32 f32 f32))) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> (;5;) (func (param i32 f32 f32 f32))) (import <span class="hljs-string"><span class="hljs-string">"env"</span></span> <span class="hljs-string"><span class="hljs-string">"_ZdlPv"</span></span> (func (;0;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 1))) (func (;1;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 4) (param i32 f32 f32) ... <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) (func (;2;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 3) (param i32) (result i32) ... <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) (func (;3;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 1) (param i32) ... <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) (func (;4;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 0) (param i32) (result f32) ... <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) (func (;5;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 3) (param i32) (result i32) ... <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) (func (;6;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 5) (param i32 f32 f32 f32) ;;   Vec3(<span class="hljs-built_in"><span class="hljs-built_in">float</span></span> x, <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> y, <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> z) ;;      ;;   -   ,      (<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> i32 i32 i32 i32) i32.const 36 ;;       Vec3 i32.const 8 ;;  8       ;;    i32.add ;;       set_local 7 ;;     ;;     Vec3     ;;  , x     4  get_local 0 get_local 1 f32.store offset=4 ;;   x get_local 0 get_local 2 f32.store offset=8 ;;   y get_local 0 get_local 7 i32.store ;;     get_local 0 get_local 3 f32.store offset=12 ;;   z <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) (func (;7;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 1) (param i32) ... <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) (func (;8;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 0) (param i32) (result f32) ... <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) (func (;9;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 3) (param i32) (result i32) ... <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) (func (;10;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 0) (param i32) (result f32) ;; <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> sq_dist(const Vec2 &amp;vec) ;;  -     (<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> i32 i32 f32) get_local 0 i32.load ;;     set_local 2 get_local 2 i32.load offset=8 ;;         8 ;;  ,        set_local 1 get_local 0 get_local 1 call_indirect (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 0) ;;      <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) (func (;11;) (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 2) ;;          ;; ,     unreachable) (table (;0;) 8 8 anyfunc) (memory (;0;) 1) (<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-string"><span class="hljs-string">"memory"</span></span> (memory 0)) (<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-string"><span class="hljs-string">"_Z7sq_distRK4Vec2"</span></span> (func 10)) ;;   .   0     ;;   3  6 -  sq_dist    ;; (         8, ;;      8,    16     ;;  3,    - 6) (elem (i32.const 0) 11 2 3 4 5 7 8 9) ;;     Vec2 (data (i32.const 12) <span class="hljs-string"><span class="hljs-string">"\00\00\00\00\00\00\00\00\01\00\00\00\02\00\00\00\03\00\00\00\04\00\00\00"</span></span>) ;;     Vec3 (data (i32.const 36) <span class="hljs-string"><span class="hljs-string">"\00\00\00\00\00\00\00\00\01\00\00\00\05\00\00\00\06\00\00\00\07\00\00\00"</span></span>))</code> </pre> <br><h2 id="globalnye-peremennye">  Global variables </h2><br><p>  Global variables are local, only for all.  The module has a list of global variables, which can be accessed by any function in the module using the <code>get_global</code> and <code>set_global</code> .  Global variables are changeable and constant.  The type of global variables, as well as local ones, is limited to base ones.  If you need to store something more complicated, memory is used, and the variable will be a pointer to it. </p><br><p>  The main purpose of global variables is to transfer the global state to the host and from the host.  If you use a global variable when compiling your module, the compiler will most likely place it in linear memory and will not create a global object. </p><br><div class="spoiler">  <b class="spoiler_title">Post Comment</b> <div class="spoiler_text"><p>  I did not manage to force LLVM to create a global variable inside the module, only imported.  On the one hand, this is understandable, and global variables in a general sense are global evil.  But if there is a mechanism, there must be a way to use it.  And then there is a word, but there is no word. </p></div></div><br><p>  Let's go... </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> valueChar; <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> valueShort; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> valueInt; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> valueLong; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> valueLongLong; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> valueUnsignedChar; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> valueUnsignedShort; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> valueUnsignedInt; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> valueUnsignedLong; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> valueUnsignedLongLong; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> valueFloat; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> valueDouble; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *valueCharPointer; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> valueCharArray[<span class="hljs-number"><span class="hljs-number">25</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> valueIntArray[<span class="hljs-number"><span class="hljs-number">3</span></span>]; } test_struct; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> test_struct g_importedStruct; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> test_struct g_internalStruct = { .valueChar = <span class="hljs-number"><span class="hljs-number">-1</span></span>, .valueShort = <span class="hljs-number"><span class="hljs-number">-2</span></span>, .valueInt = <span class="hljs-number"><span class="hljs-number">-3</span></span>, .valueLong = <span class="hljs-number"><span class="hljs-number">-4</span></span>, .valueLongLong = <span class="hljs-number"><span class="hljs-number">-5</span></span>, .valueUnsignedChar = <span class="hljs-number"><span class="hljs-number">1</span></span>, .valueUnsignedShort = <span class="hljs-number"><span class="hljs-number">2</span></span>, .valueUnsignedInt = <span class="hljs-number"><span class="hljs-number">3</span></span>, .valueUnsignedLong = <span class="hljs-number"><span class="hljs-number">4</span></span>, .valueUnsignedLongLong = <span class="hljs-number"><span class="hljs-number">5</span></span>, .valueFloat = <span class="hljs-number"><span class="hljs-number">123.0f</span></span>, .valueDouble = <span class="hljs-number"><span class="hljs-number">5.0</span></span>, .valueCharPointer = <span class="hljs-string"><span class="hljs-string">"StringValue"</span></span> }; <span class="hljs-function"><span class="hljs-function">test_struct *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_imported_by_ptr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;g_importedStruct; } <span class="hljs-function"><span class="hljs-function">test_struct </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_imported_by_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> g_importedStruct; } <span class="hljs-function"><span class="hljs-function">test_struct *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_internal_by_ptr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;g_internalStruct; } <span class="hljs-function"><span class="hljs-function">test_struct </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_internal_by_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> g_internalStruct; } <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> g_importedFloat; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_imported_float</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> g_importedFloat; }</code> </pre><br><pre> <code class="hljs css">(<span class="hljs-selector-tag"><span class="hljs-selector-tag">module</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span> (;0;) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">param</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span>) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">result</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span>))) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span> (;1;) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">result</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span>))) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span> (;2;) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">param</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span>))) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span> (;3;) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">result</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">f32</span></span>))) ;;       , ;;   <span class="hljs-selector-tag"><span class="hljs-selector-tag">memcpy</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   ;;  <span class="hljs-selector-tag"><span class="hljs-selector-tag">webassembly</span></span>       ;;        (<span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">env</span></span>" "<span class="hljs-selector-tag"><span class="hljs-selector-tag">memcpy</span></span>" (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> (;0;) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span> 0))) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">env</span></span>" "<span class="hljs-selector-tag"><span class="hljs-selector-tag">g_importedStruct</span></span>" (<span class="hljs-selector-tag"><span class="hljs-selector-tag">global</span></span> (;0;) <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span>)) ;;  <span class="hljs-selector-tag"><span class="hljs-selector-tag">g_importedStruct</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">env</span></span>" "<span class="hljs-selector-tag"><span class="hljs-selector-tag">g_importedFloat</span></span>" (<span class="hljs-selector-tag"><span class="hljs-selector-tag">global</span></span> (;1;) <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span>)) ;; <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span>... (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> (;1;) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span> 1) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">result</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span>) ;; <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_imported_by_ptr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_global</span></span> 0 ;;       <span class="hljs-selector-tag"><span class="hljs-selector-tag">return</span></span>) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> (;2;) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span> 2) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">param</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span>) ;; <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_imported_by_value</span></span> ;;  ,    ,      ;;   . ,   , <span class="hljs-selector-tag"><span class="hljs-selector-tag">RVO</span></span>, ,  , ;;        ;;   <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_local</span></span> 0 ;;  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    ,     <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_global</span></span> 0 ;;   <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>      <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.const</span></span> 112 ;;   <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> 0 ;;  <span class="hljs-selector-tag"><span class="hljs-selector-tag">memcpy</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">dest</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">source</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">size</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">drop</span></span> ;;    <span class="hljs-selector-tag"><span class="hljs-selector-tag">return</span></span>) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> (;3;) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span> 1) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">result</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span>) ;; <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_internal_by_ptr</span></span> ;;   ,      ;;      <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.const</span></span> 16 ;;    <span class="hljs-selector-tag"><span class="hljs-selector-tag">return</span></span>) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> (;4;) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span> 2) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">param</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span>) ;; <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_internal_by_value</span></span> ;;   ,    <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_imported_by_value</span></span>, ;;      <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_local</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.const</span></span> 16 <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.const</span></span> 112 <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">drop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">return</span></span>) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> (;5;) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span> 3) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">result</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">f32</span></span>) ;; <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_imported_float</span></span> ;;     <span class="hljs-selector-tag"><span class="hljs-selector-tag">f32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.load</span></span>,  <span class="hljs-selector-tag"><span class="hljs-selector-tag">g_importedFloat</span></span>   <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.const</span></span> 0 ;;  ,      <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> ;; .  ,      , ;;   <span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>  . <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_global</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">f32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.load</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">return</span></span>) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">memory</span></span> (;0;) 1) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">export</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">memory</span></span>" (<span class="hljs-selector-tag"><span class="hljs-selector-tag">memory</span></span> 0)) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">export</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">get_imported_by_ptr</span></span>" (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> 1)) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">export</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">get_imported_by_value</span></span>" (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> 2)) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">export</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">get_internal_by_ptr</span></span>" (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> 3)) (<span class="hljs-selector-tag"><span class="hljs-selector-tag">export</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">get_internal_by_value</span></span>" (<span class="hljs-selector-tag"><span class="hljs-selector-tag">func</span></span> 4)) ;;   ,   <span class="hljs-selector-tag"><span class="hljs-selector-tag">g_internalStruct</span></span>    (<span class="hljs-selector-tag"><span class="hljs-selector-tag">data</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.const</span></span> 16) "\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\00\<span class="hljs-selector-tag"><span class="hljs-selector-tag">fe</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">fd</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">fc</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\00\00\00\00\<span class="hljs-selector-tag"><span class="hljs-selector-tag">fb</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span>\01\00\02\00\03\00\00\00\04\00\00\00\00\00\00\00\05\00\00\00\00\00\00\00\00\00\<span class="hljs-selector-tag"><span class="hljs-selector-tag">f6B</span></span>\00\00\00\00\00\00\00\00\00\00\14@\<span class="hljs-keyword"><span class="hljs-keyword">80</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">00</span></span>") ;;       ,    ;;    (<span class="hljs-selector-tag"><span class="hljs-selector-tag">data</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">i32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.const</span></span> 128) "<span class="hljs-selector-tag"><span class="hljs-selector-tag">StringValue</span></span>\00"))</code> </pre> <br><h2 id="obschenie-s-hostom">  Communication with the host </h2><br><p>  The highest form of organization is WebAssembly - module.  WebAssembly is distributed, loaded, and executed as modules. </p><br><p>  In total, we had 4 types of objects in WebAssembly: functions, memory, tables, and global variables.  Each of these objects can be imported and exported (and even imported and exported at the same time). </p><br><p>  The module contains all the objects defined in it, and describes the structure of imports and exports.  As you can see, all objects (and even signatures that are <code>type</code> ) have their own sequence numbers.  Each room has its own space.  That is, function 2 has nothing to do with either global variable 2 or signature 2. The space of numbers usually begins with imported objects. </p><br><p>  From a code point of view, calling a host function or getting a global host variable is no different from normal: just <code>call N</code> or <code>get_global N</code>  The interpreter, based on the module's metadata, will determine whether it is necessary to call the host function, or even the function of another module that is loaded by this host. </p><br><p>  Memory and tables are more complicated.  When sharing several modules of one memory or one table, you need to determine the regions in which each module stores its global data.  There is a <a href="http://webassembly.org/docs/dynamic-linking/">recommendation for this</a> , but for the time being it is poorly supported by compilers. </p><br><p>  As a result, for communication between the module and the host: </p><br><ul><li>  The host can define and modify global variables imported by the module. </li><li>  A host can call exported functions from a module, and a module can import and call host functions </li><li>  The host can write data to the memory and tables of the module, and read from them </li></ul><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  With the main guts I finished.  Almost every item you can write a huge list of additions and features of the compilation, but this is a special case.  As you can see, although the technology is called <strong>Web</strong> Assembly, there are no bindings inside the web. </p><br><p>  The WABT and LLVM 5.0 package was used to compile and decompile the examples.  I do not use Emscripten, because it just creates a bunch of everything designed exclusively for web modules that are run in conjunction with JavaScript. </p><br><p>  Next, we will discuss what is needed in the standard library, how to allocate memory, and how to run all this bedlam on mobile platforms. </p><br><p>  PS I wanted to write something for the front-fenders who want to deal with this technology.  Not sure what happened.  If you are a fender, and something is not clear to you - write in the comment boldly, I will be corrected. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/345450/">https://habr.com/ru/post/345450/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345438/index.html">Translation: Setting up your applications and games for devices with a long screen</a></li>
<li><a href="../345440/index.html">3CX V15.5 SP3 alpha and 3CX Session Border Controller Update</a></li>
<li><a href="../345442/index.html">Machine training in sewers (in a good way)</a></li>
<li><a href="../345446/index.html">Create a Q & A bot: step by step instructions</a></li>
<li><a href="../345448/index.html">Common examples of using advanced JQL queries</a></li>
<li><a href="../345452/index.html">Machine learning and chocolates</a></li>
<li><a href="../345454/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ294 (December 18 - 24, 2017)</a></li>
<li><a href="../345458/index.html">The story of the victory at the annual competition Russian AI Cup 2017</a></li>
<li><a href="../345460/index.html">We comprehend C deeper using assembler. Part 2 (conditions)</a></li>
<li><a href="../345462/index.html">PHP Digest number 122 (December 11 - 25, 2017)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>