<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>When docker-compose is missing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What will be discussed 


 Here periodically there are posts in which the authors share their approaches to the use of docker . Well, here's another o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>When docker-compose is missing</h1><div class="post__text post__text-html js-mediator-article"><h2 id="o-chem-poydet-rech">  What will be discussed </h2><br><p>  Here periodically there are posts in which the authors share their approaches to the use of <a href="https://www.docker.com/">docker</a> .  Well, here's another one.  Below, I will tell you about our experience in using the docker environment, the inconvenience we faced, how we struggled with them, and what it turned out to be.  And also I will share a small, but so useful tool for us. </p><br><p><img src="https://habrastorage.org/web/db7/9e4/3c6/db79e43c6fcd48da85f51fc25a4fc07b.jpg" alt="image"></p><a name="habracut"></a><br><h2 id="kak-my-zhili-do-etogo">  How we lived before </h2><br><p>  First, a little history.  It so happened that on duty, we in varying degrees, develop and support several projects at the same time.  All of them have different ages, requirements and accordingly work in different environments.  In this connection, there were some inconveniences when deploying a local copy.  When you switch to a project that you haven‚Äôt previously worked with, you have to tinker with setting it up, as well as setting up the working environment.  And if within the team it could be resolved rather quickly, then with occasionally connected freelance developers it is more and more difficult.  It was decided to transfer the development to the docker-environment.  Here we did not invent anything, but went the standard way.  Each service went up in a separate container.  Docker-compose was used for the bundle. </p><br><p>  For parallel work on several projects requires the installation of all the services necessary for each of them.  First of all, we created a repository in which the configuration file for docker-compose was located, as well as the configuration of the images required for operation.  Everything worked pretty quickly and for a while it suited us.  As it turned out, in the future, this approach solved our problem partially.  As projects were added to the new ecosystem, this repository was filled with configuration files and various supporting scripts.  This led to the fact that when working on a single project, the developer had to either drag the dependencies of all projects, or edit docker-compose.yml, disabling unnecessary services.  In the first case, we had to put extra containers, which seemed to us not the best solution, and in the second we needed to know which containers are required for the application to work.  I wanted to have a more flexible solution that allows you to install only the necessary components, and also, if not exclude, then minimizes manual work.  And what we have come to ... </p><br><h2 id="ddk">  ddk </h2><br><p>  ddk (Docker Development Kit) is a tool designed to simplify setting up the environment and automate the deployment of the development environment for projects running in the docker environment.  Sounds, probably, strongly.  In fact, ddk is a kind of wrapper over git and docker and provides a number of additional commands for conveniently managing packages, configuration files and projects.  In some ways, it is the environment dependency manager for docker-compose projects and services. </p><br><p>  Initially, ddk is a set of python scripts, but the end user gets a single executable file that he works with.  Now, in addition to installing docker itself and docker-compose, the developer needs to initialize ddk, creating a configuration file.  This task is solved by invoking the init command. </p><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /var/projects/ddk ddk init</code> </pre> <br><p>  After that, the connection to the new project is as follows: </p><br><pre> <code class="bash hljs">ddk project get my.project.ru ddk compose --up</code> </pre> <br><p>  Also, if necessary, we redirect the new domain to localhost. </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 127.0.0.1 my.project.ddk &gt;&gt; /etc/hosts</code> </pre> <br><p>  The first team clones the project and executes its initialization.  The second generates a configuration for docker-compose and starts the necessary services.  During the execution process all missing components will be loaded.  Upon completion of the build, the developer receives a fully working local copy of the project, which is available at my.project.ddk. </p><br><p>  A little about how it works. </p><br><p>  When using ddk, the working directory is the directory in which the configuration file is generated, generated by the init command.  The executable file itself can be located in any convenient place.  The configuration search is performed starting from the current directory, and then ddk climbs the directory tree until it finds the file you are looking for or reaches the root of the file system.  Git and docker-compose work in a similar way.  After the configuration file is found, ddk creates some directories for storing packages and source code for projects, resolves and installs dependencies.  Components are installed by simple cloning of a git repository, whose address is determined by concatenating the component name and the prefix from the configuration file. </p><br><pre> <code class="hljs css"># "<span class="hljs-selector-tag"><span class="hljs-selector-tag">project-repo-prefix</span></span>": <span class="hljs-selector-attr"><span class="hljs-selector-attr">["git@github.com/vendor-name/"]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ddk</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">project</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">get</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">my</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.project</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ru</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">git</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">clone</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">git</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">github</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">com</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">vendor</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">my</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">project</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">ru</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">git</span></span></code> </pre> <br><p>  Of course, ddk is not a simple shortcut for git clone, and it has additional functionality, which is why it was intended.  About how, why and why - just below, but here I will add only that as a result a directory will be formed in which all the projects will be collected, as well as the configuration files necessary for their work.  This directory can easily be moved to another directory or to another machine. </p><br><h2 id="ddk-pakety">  ddk packages </h2><br><p>  The first thing I wanted to achieve was to make the whole environment as modular as possible.  We selected the description of each service into separate configuration files and brought them to independent repositories.  A colleague called them packages.  These very packages formed the basis of the work of our instrument.  When building docker-compose.yml, ddk goes through all the required packages and generates a final configuration file based on them. </p><br><p>  As a rule, there is no need to install separate packages on your own, since all missing components are automatically loaded during assembly.  However, it is possible to install and update them. </p><br><pre> <code class="bash hljs">ddk package install package-name ddk package update</code> </pre> <br><p>  Now about the content.  At the root is always the configuration file ddk.json, in which the name of the container and the used docker image are indicated.  Below is an example of a package with minimal configuration. </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"container_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"memcached.ddk"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"image"</span></span>: <span class="hljs-string"><span class="hljs-string">"memcached:latest"</span></span> }</code> </pre> <br><p>  As you probably noticed, in fact, this is part of the configuration from docker-compose.yml presented in JSON format.  This approach makes it possible to set any parameters supported by docker-compose.  Here is an example of a more complex package that uses a separate Dockerfile and mounts directories. </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"build"</span></span>: <span class="hljs-string"><span class="hljs-string">"${PACKAGE_PATH}"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"container_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nginx.ddk"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"volumes"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"${SHARE_PATH}/var/www:/var/www"</span></span>, <span class="hljs-string"><span class="hljs-string">"${PACKAGE_PATH}/storage/etc/nginx/conf.d:/etc/nginx/conf.d:ro"</span></span>, <span class="hljs-string"><span class="hljs-string">"${PACKAGE_PATH}/storage/etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro"</span></span>, <span class="hljs-string"><span class="hljs-string">"${PACKAGE_PATH}/storage/var/log/nginx:/var/log/nginx"</span></span> ] }</code> </pre> <br><p>  Listing package directory: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>/ etc/ nginx/ conf.d/ site.ddk.sample nginx.conf ddk.json Dockerfile</code> </pre> <br><p>  Keys that have the prefix "ddk-" are used to specify special directives.  Currently, the only supported key is "ddk-post-install", which stores a list of commands that are executed after installing and updating the package. </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"ddk-post-install"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"echo 'Done'"</span></span> ] }</code> </pre> <br><p>  One of the options for using this option is given in the "Agreement" section. </p><br><h2 id="proekty">  Projects </h2><br><p>  Now we will consider how to use ddk on the example of a specific project.  To deploy an existing project, just call the <code>get</code> command. </p><br><pre> <code class="bash hljs">ddk project get project-id</code> </pre> <br><p>  This command clones the project into the share / var / www directory, after which the configuration file is searched (by default in the project root), and all the necessary commands from the on-init section are launched.  At this stage, the setting of individual project parameters is performed (generation of .env, installation of rights to files, database configuration, etc.). </p><br><p>  In addition to the commands for initialization, the ddk.json file contains a list of packages on which the project‚Äôs work depends.  If any of the packages are missing, it will be automatically installed.  Below is an example of the configuration of the project. </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"packages"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"mysql5.5"</span></span>, <span class="hljs-string"><span class="hljs-string">"memcached"</span></span>, <span class="hljs-string"><span class="hljs-string">"apache-php5.5"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"on-init"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"${PROJECT_PATH}/init.sh ${PACKAGES_PATH} ${PROJECT_DIR}"</span></span> ] }</code> </pre> <br><p>  Despite the fact that the on-init section allows you to send several commands, we usually specify only one.  In the example above, you can see that when the project is initialized, a deployment script will run, which will perform the basic configuration.  Such an approach turned out to be more convenient, since it gives greater flexibility and allows you to add an interactive to the project initialization process. </p><br><p>  If you need to expand the configuration of a package, you can do this by specifying it as an object.  This object must have a name attribute containing the name of the package.  All other attributes will be perceived as a configuration. </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"packages"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nginx"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"depends_on"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"php-fpm7.1"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"environment"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"SOME_VAR=Hello"</span></span> ] } ] }</code> </pre> <br><p>  Thus, we have the opportunity to influence the work of services without changing the original configuration of the package. </p><br><h2 id="soglasheniya">  Agreements </h2><br><p>  In the process of working in the docker-environment, we have developed several agreements, which we try to adhere to. </p><br><p>  Firstly, when mounting any files and directories of a package or project, their structure must match the structure inside the container.  Those.  package-name / storage corresponds to the root directory of the package-name container.  The share directory also corresponds to the container root directory.  That is why all projects are located in share / var / www.  This rule can be traced in the examples above. </p><br><p>  The next point is that when installing packages in which containers the file system is supposed to be modified, a special user is created whose credentials correspond to the data of the user of the host system.  In other words, we map username, user ID and group ID from the host system to the container.  In the future, all commands in the container are recommended to be executed using this data.  This approach allows you to avoid problems with access rights when accessing files outside the container.  If at least one of the projects is configured in this way, a share / home / &lt;user-dir&gt; directory will be created, which is mounted in a container and used as a home directory.  Below is an example of how we implemented it. </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"container_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"php71-fpm.ddk"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"command"</span></span>: <span class="hljs-string"><span class="hljs-string">"map-user.sh"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"env_file"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"${PACKAGE_PATH}/env/user.env"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"ddk-post-install"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"mkdir -p ${PACKAGE_PATH}/env"</span></span>, <span class="hljs-string"><span class="hljs-string">"echo USER_NAME=`whoami` &gt; ${PACKAGE_PATH}/env/user.env"</span></span>, <span class="hljs-string"><span class="hljs-string">"echo USER_ID=`id -u` &gt;&gt; ${PACKAGE_PATH}/env/user.env"</span></span>, <span class="hljs-string"><span class="hljs-string">"echo GROUP_ID=`id -g` &gt;&gt; ${PACKAGE_PATH}/env/user.env"</span></span> ] }</code> </pre> <br><p>  As you can see, after installing the package, a file with user data is generated.  When the container is started, the map-user.sh script checks and, if necessary, creates an account using the data obtained. </p><br><h2 id="schepotka-magii">  Pinch of magic </h2><br><p>  The last thing you want to do is run all the necessary services using the usual docker-compose.  To generate startup parameters, use the compose command.  When it is called, ddk goes through all active projects, collects data about the packages and their parameters, combines all the information received with the configurations of the packages themselves and on the basis of this data generates the final docker-compose.yml.  This file is used at startup. </p><br><pre> <code class="bash hljs">ddk compose docker-compose up -d</code> </pre> <br><p>  If the corresponding option is specified during configuration, you can get by with one command. </p><br><pre> <code class="bash hljs">ddk compose --up</code> </pre> <br><h2 id="hello-world">  Hello, world </h2><br><p>  Those who want to see ddk in action can deploy a demo project. </p><br><p>  Downloading the latest build: </p><br><pre> <code class="bash hljs">wget https://github.com/simbigo/ddk/raw/master/dist/ddk chmod +x ddk</code> </pre> <br><p>  We configure the future domain: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 127.0.0.1 hello.ddk &gt;&gt; /etc/hosts</code> </pre> <br><p>  We develop the project: </p><br><pre> <code class="bash hljs">./ddk init ./ddk project get hello ./ddk compose --up</code> </pre> <br><p>  After successfully assembling all the images, the project is available at <a href="http://hello.ddk/">http: //hello.ddk</a> </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  What have achieved: </p><br><ol><li>  Modular environment. </li><li>  Configuration of a single team. </li><li>  The absence of reusable handmade. </li><li>  Minimum time to include a developer in the project. </li></ol><br><p>  What is worth the work: </p><br><ol><li>  There is practically no error handling in ddk. </li><li>  We planned to implement the correct work on MacOS, but at the moment there is no Mac driver in our team, and the tool in this system has not been tested.  Most likely, some features will emerge, and refinement will be required. </li><li>  The addresses of the repositories for packages and projects are transferred as an array, but in fact work is done only with the first element.  It is necessary to implement a correct check of the existence of the repository and search by a set of addresses. </li><li>  Removing excess containers. </li><li>  There is quite a lot of duplicate code in initialization scripts.  Maybe it makes sense to render common functions in ddk. </li></ol><br><p>  For those who have an overwhelming desire to see, do better, or just criticize the code, I attach a link to github.  We will be happy if the tool will be useful to someone else besides us. </p><br><p>  <a href="https://github.com/simbigo/ddk">Visit github</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/330452/">https://habr.com/ru/post/330452/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330440/index.html">Virtualization opportunities for IT savings</a></li>
<li><a href="../330444/index.html">Effective technical support tools</a></li>
<li><a href="../330446/index.html">Turla's cybercamping: updated Firefox extension uses Instagram</a></li>
<li><a href="../330448/index.html">Designer's blood, sweat and tears</a></li>
<li><a href="../330450/index.html">UltraVNC as a replacement for TeamViewer</a></li>
<li><a href="../330454/index.html">10 rules for the organization of effective customer support</a></li>
<li><a href="../330456/index.html">Ecosystem: more participants - more profit! Why does Skyeng open API</a></li>
<li><a href="../330458/index.html">Roskomnadzor white list: conclusions and losses</a></li>
<li><a href="../330460/index.html">10 tools for startups and startups</a></li>
<li><a href="../330462/index.html">How to adopt a law or data processing in distributed systems in an understandable language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>