<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Happy end of my story with a script for comfortable reading Habr</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my first post I described why I chose the option of studying JavaScript with the fulfillment of the task I had set myself to write a browser extens...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Happy end of my story with a script for comfortable reading Habr</h1><div class="post__text post__text-html js-mediator-article">  In my <a href="http://habrahabr.ru/post/189258/">first post</a> I described why I chose the option of studying JavaScript with the fulfillment of the task I had set myself to write a browser extension.  Since that time, I have never had the idea that everything is in vain.  As the script was being written, the mandatory points of ordinary study ‚Äî thematic articles and educational materials ‚Äî did not go anywhere.  However, in this case there was an excellent catalyst - your own imagination. <br>  Since I constantly read Habr, some, in my humble opinion, roughness in usability immediately found a place in the list of irresistible desires for improvement. <br><a name="habracut"></a><br>  And the place of honor was taken by the idea of ‚Äã‚Äãdisplaying tracker updates without the need for additional transitions and, preferably, in one block. <br>  Of course, the whole point was how to get the data, but you need to show them somewhere.  Therefore, the path from simple to complex began with a container for the received updates: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> trackerLink = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'.userpanel &gt; .top &gt; a.count'</span></span>); trackerLink.href = <span class="hljs-string"><span class="hljs-string">'#tracker_updates'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updates = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'ul'</span></span>); updates.className = <span class="hljs-string"><span class="hljs-string">'updates'</span></span>; updates.style.display = <span class="hljs-string"><span class="hljs-string">'none'</span></span>; userpanel.appendChild(updates); trackerLink.onclick = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ event.preventDefault(); updates.style.display = (updates.style.display != <span class="hljs-string"><span class="hljs-string">'none'</span></span> ? <span class="hljs-string"><span class="hljs-string">'none'</span></span> : <span class="hljs-string"><span class="hljs-string">'block'</span></span>); };</code> </pre> <br><br>  And logically I started writing the function of parsing the tracker pages: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUpdates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, getUrl</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xmlhttp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xmlhttp.responseType = <span class="hljs-string"><span class="hljs-string">'document'</span></span>; xmlhttp.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xmlhttp.readyState == <span class="hljs-number"><span class="hljs-number">4</span></span> &amp;&amp; xmlhttp.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tracks = xmlhttp.responseXML.querySelectorAll(url); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; tracks.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> post = tracks[i]; post.removeChild(post.firstElementChild); updates.appendChild(post); post.outerHTML = post.outerHTML.replace(<span class="hljs-regexp"><span class="hljs-regexp">/td/g</span></span>, <span class="hljs-string"><span class="hljs-string">"li"</span></span>); } } } xmlhttp.open(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, getUrl, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xmlhttp.send(); } getUpdates(<span class="hljs-string"><span class="hljs-string">'tr.new &gt; td.event_type'</span></span>, <span class="hljs-string"><span class="hljs-string">'/tracker/subscribers/'</span></span>); getUpdates(<span class="hljs-string"><span class="hljs-string">'tr.new &gt; td.mention_type'</span></span>, <span class="hljs-string"><span class="hljs-string">'/tracker/mentions/'</span></span>);</code> </pre><br><br>  The result was a list of updates to subscribers and new references to the user.  That's right, the main thing - the update posts.  And with them everything happened a little differently, as it was required to still display the counter of new comments for each post: <br><br><pre> <code class="javascript hljs"> (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xmlhttp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xmlhttp.responseType = <span class="hljs-string"><span class="hljs-string">'document'</span></span>; xmlhttp.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xmlhttp.readyState == <span class="hljs-number"><span class="hljs-number">4</span></span> &amp;&amp; xmlhttp.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tracks = xmlhttp.responseXML.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'tr.new &gt; td.post_title'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> commentCounts = xmlhttp.responseXML.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'tr.new &gt; td.comment_count'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; tracks.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> track = tracks[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> commentCount = commentCounts[i].firstChild.nextSibling; commentCount.className = <span class="hljs-string"><span class="hljs-string">'count'</span></span>; track.appendChild(commentCount); updates.appendChild(track); track.outerHTML = track.outerHTML.replace(<span class="hljs-regexp"><span class="hljs-regexp">/td/g</span></span>, <span class="hljs-string"><span class="hljs-string">"li"</span></span>); } }; xmlhttp.open(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-string"><span class="hljs-string">'/tracker/'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xmlhttp.send(); })();</code> </pre><br><br>  I wrapped the request in an anonymous self-calling function because all the parts described earlier were executed as a single named function. <br><div class="spoiler">  <b class="spoiler_title">Here's what it looks like in the screenshot.</b> <div class="spoiler_text"><img src="http://habrastorage.org/getpro/habr/post_images/7d6/8f5/d36/7d68f5d36eed2881974829ae3387abd9.png" alt="image"></div></div><br><br>  Everything is good, but surely not everyone wants every time to click the button to display all the hidden pictures or to expand the tree of answers to comments.  Suddenly you need only a custom panel.  And here it was decided to finally add management settings, so that comfort was truly such.  Almost immediately came to the option of storing the settings in local storage, and then the process got up, since it would be more appropriate to use the methods for working with local storage for each browser.  I started by studying the Chrome Storage API and ... ... I finished it too, because it‚Äôs too expensive to build an amusement park for everyone, but I wanted a happy future for everyone at once.  There were some ideas, but due to lack of experience and just for the sake of the advice of the experienced he turned to <a href="http://habrahabr.ru/users/spmbt/" class="user_link">spmbt</a> for help.  He just suggested to me an elegant version in the form of three simple functions: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> setLocStor = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, hh</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!localStorage) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; localStorage[<span class="hljs-string"><span class="hljs-string">'custom_'</span></span>+ name] = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify({<span class="hljs-attr"><span class="hljs-attr">h</span></span>: hh}); }, getLocStor = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(localStorage &amp;&amp; localStorage[<span class="hljs-string"><span class="hljs-string">'custom_'</span></span>+ name] ||<span class="hljs-string"><span class="hljs-string">'{}'</span></span>)).h; } ,removeLocStor = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">)</span></span>{localStorage.removeItem(<span class="hljs-string"><span class="hljs-string">'custom_'</span></span>+ name);}</code> </pre><br><br>  As far as I understand, in the case of using the Chrome Storage API, requests will be executed asynchronously (please correct me, as I can be wrong). <br><br>  I will not torture you with footcloths with the code and briefly mention that I created named checkboxes with the default value disabled, and to disable the feature, the value was changed to enabled.  When you click on each checkbox, a key-value pair is written to local storage.  When the settings block is called, the local storage records are read and the corresponding states are assigned to the checkboxes (if the value of the disabled key is set, the checkbox is false and if enabled is true).  The functions responsible for the feature ‚Äúlisten‚Äù to the value of their key in local storage and are performed only if the value is disabled, that is, the checkbox ‚Äúdisable‚Äù in the settings is not set. <br><div class="spoiler">  <b class="spoiler_title">Screenshot with settings</b> <div class="spoiler_text"><img src="http://habrastorage.org/getpro/habr/post_images/ae6/ff2/7c9/ae6ff27c9b9400586eaa39b497f2ab20.png" alt="image"></div></div><br><br>  And at the end of a long story a small bonus in the form of displaying current karma and user rating by clicking on the user's avatar in his comments. <br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="http://habrastorage.org/getpro/habr/post_images/57e/107/492/57e107492e8575d47f744cc4557fba99.png" alt="image"></div></div><br><br>  Well, that's all, I was convinced that combining the pleasant with the useful in learning is not only possible, but necessary.  It is more interesting to study if there is an incentive that comes every day in the form of a couple of ideas.  Even if the result of the work was useful only to you and a few friends, then there is absolutely no reason to think about the dubiousness of the event - you have received not just another studied minimum, but a new hobby. <br><br>  Now, the development of the script will depend on the free time and new offers / womens, and I will continue to consolidate the knowledge gained in practice and invent more complex tasks for myself to further study JavaScript. <br><br>  Thanks to everyone who read it and, I hope, convinced someone to repeat the ‚Äúsamurai way‚Äù. <br>  I would appreciate constructive criticism and recommendations. <br><br>  <a href="https://chrome.google.com/webstore/detail/habralite/lpbcmeihkgpndiagnaknkfpkhbdcmjhi">Chrome webstore link</a> <br>  <a href="https://github.com/glebcha/habralite">Github Link</a> <br><br>  <b><i><u>Update</u></i></b> - now the karma and user rating are displayed by clicking on his avatar (previously the event ‚Äúblocked‚Äù click on the user name and the button to display a link to this comment).  I hope this small change arrived in time. </div><p>Source: <a href="https://habr.com/ru/post/192444/">https://habr.com/ru/post/192444/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192430/index.html">Cellular Test Base Station: What's Inside</a></li>
<li><a href="../192432/index.html">Google interface update</a></li>
<li><a href="../192436/index.html">Android 4.4 got the name Kit Kat (+1 billion activated devices)</a></li>
<li><a href="../192440/index.html">GitHub adds two-factor authentication</a></li>
<li><a href="../192442/index.html">Survey: Do you have a 3D printer and would you like to print for others?</a></li>
<li><a href="../192446/index.html">Its Certificate Authority - in 5 OpenSSL teams</a></li>
<li><a href="../192448/index.html">How did I count the time of arrival by the Monte Carlo method</a></li>
<li><a href="../192450/index.html">Runetology (207): Timofey Gorshkov, co-founder of inSales</a></li>
<li><a href="../192454/index.html">Having bought Nokia for 7.17 billion dollars, Microsoft leads the Trojan horse home</a></li>
<li><a href="../192456/index.html">RosSpam.org or how to complain about SMS spam in a couple of clicks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>