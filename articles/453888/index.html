<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Maximum speed machine learning: Predictive Maintenance for four months</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Author: Lyudmila Dezhkina, Solution Architect, DataArt 

 For about six months, our team has been working on the Predictive Maintenance Platform, a sy...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Maximum speed machine learning: Predictive Maintenance for four months</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/a5/ma/w3/a5maw3b31cc8lsqgqkdb5kbl-5w.jpeg"><br><br>  <i>Author: Lyudmila Dezhkina, Solution Architect, DataArt</i> <br><br>  For about six months, our team has been working on the Predictive Maintenance Platform, a system that should predict possible errors and equipment failures.  This direction is at the junction of IoT and Machine Learning, we have to work here with hardware and, in fact, with software.  How we build Serverless ML with the Scikit-learn library on AWS will be discussed in this article.  I will talk about the difficulties that we faced, and about the tools that are used, saved time. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Just in case, a little about yourself.</b> <div class="spoiler_text">  I have been programming for more than 12 years, and during this time I participated in various projects.  Including gaming, e-commerce, highload and Big Data.  For about three years I have been involved in projects related to Machine Learning and Deep Learning. <br></div></div><br><img src="https://habrastorage.org/webt/v2/n9/ya/v2n9yaw20xe0knokse1jroameye.jpeg"><br><br>  <i>This is how the requirements put forward by the customer from the very beginning</i> <br><br>  The interview with the client was difficult, basically we talked about machine learning, we were asked a lot about algorithms and specific personal experience.  But I will not be shy - in this part we initially understand very well.  The first stumbling block was a piece of Hardware, which contains the system.  Still, my experience with iron is not so diverse. <br><br>  The customer explained to us: ‚ÄúSee, we have a pipeline.‚Äù  A conveyor belt at the checkout in the supermarket immediately occurred to me.  What and what can you teach there?  But it quickly became clear that the whole sorting center with an area of ‚Äã‚Äã300‚Äì400 square meters was hidden behind the word conveyor.  m, and in fact, there are many pipelines.  That is, you need to connect with each other many pieces of equipment: sensors, robots.  The classic illustration of the concept of <a href="https://www.forbes.com/sites/bernardmarr/2018/08/13/the-4th-industrial-revolution-is-here-are-you-ready/">"Industrial Revolution 4.0"</a> , within which IoT and ML come together. <br><br>  The topic of Predictive Maintenance will definitely be on the rise for at least another two to three years.  Each conveyor is decomposed into elements: from a robot or a motor driving a conveyor belt to a separate bearing.  At the same time, if any of these parts fail, the whole system stops, and in some cases the idle time of a conveyor can cost a million and a half dollars (this is no exaggeration!). <br><br>  One of our customers is engaged in cargo transportation and logistics: on its base, robots unload 40 trucks in 8 minutes.  There can be no delays here, the cars should come and go according to a very tight schedule, nobody repairs anything in the process of unloading.  In general, on this base there are only two or three people with tablets.  But there is a slightly different world, where everything looks not so fashionable, and where mechanics in gloves and without computers are directly on the site. <br><br>  Our first small prototype project consisted of about 90 sensors, and everything went fine until the project had to be scaled.  To equip the smallest separate part of the real sorting center, sensors require about 550 already. <br><br><h2>  PLC and sensors </h2><br>  Programmable logic controller - a small computer with a built-in cyclic program - most often used to automate the process.  Actually, with the help of PLC, we take readings from the sensors: for example, acceleration and speed, voltage level, vibration along the axes, temperature (in our case - 17 indicators).  The sensors are often wrong.  Although our project is more than 8 months old, we still have our own laboratory where we experiment with sensors, selecting the most suitable models.  Now, for example, we are considering the possibility of using ultrasonic sensors. <br><br>  Personally, I first saw the PLC, only when I got on the customer‚Äôs site.  As a developer, I had never encountered them before, and it was rather unpleasant: as soon as we went further in conversation, two, three, and four-phase motors, I began to lose the thread.  Approximately 80% of the words were still understandable, but the general meaning stubbornly eluded.  In general, this is a serious problem, the roots of which are at a rather high threshold for entering the PLC programming - such a microcomputer, where you can really do something, costs at least 200‚Äì300 dollars.  The programming itself is simple, and problems begin only when the sensor is attached to a real conveyor or motor. <br><br><img src="https://habrastorage.org/webt/rn/hh/p1/rnhhp1tzi_-qky6eszerqhvppyg.jpeg"><br><br>  <i>Standard set of sensors "37 in 1"</i> <br><br>  Sensors, as you know, are different.  The simplest ones we managed to find cost from $ 18.  The main characteristic is ‚Äúbandwidth and resolution‚Äù - how much data the sensor transmits per minute.  From my own experience, I can say that if a manufacturer claims, say, 30 datapot per minute, in reality their number is unlikely to be more than 15. And this also has a serious problem: the topic is fashionable, and some companies are trying to capitalize on this hype.  We tested the sensors at a cost of $ 158, the bandwidth of which theoretically allowed us to simply throw out a part of our code.  But in actual fact, they turned out to be an absolute analogue of those devices for $ 18 apiece. <br><br><h2>  The first stage: we fix the sensors, collect data </h2><br>  Actually, the first phase of the project was to install hardware, the installation itself was a long and tedious process.  This is also a whole science - how you attach the sensor to a motor or box may depend on the data that it eventually collects.  We had a case where one of two identical sensors was attached inside the box, and the other outside.  Logic suggests that inside the temperature should be higher, but the collected data suggested the opposite.  It turned out that the system failed, but when the developer arrived at the factory, he saw that the sensor was not just in the box, but directly on the fan located there. <br><br><img src="https://habrastorage.org/webt/r-/qr/3g/r-qr3gto5oa6lxqmvrkyw3fz_ny.jpeg"><br><br>  This illustration shows how the first data entered the system.  We have a gateway, there are PLC and sensors associated with it.  Then, of course, cash - equipment usually works on mobile cards and all data is transmitted via the mobile Internet.  Since one of the customer‚Äôs sorting centers is located in an area where there are often hurricanes, and the connection can break, we accumulate data on the gateway until it is restored. <br><br>  Next we use the Greengrass service from Amazon, which lets the data inside the cloud system (AWS). <br><br>  Once the data is inside the cloud, a bunch of events are triggered.  For example, we have an event for raw data, which saves file system data.  There is a ‚Äúheartbeat‚Äù to indicate the normal operation of the system.  There is a ‚Äúdownsampling‚Äù, which is used for showing on the UI, and for processing (take the average value, say, per minute for a particular indicator).  That is, besides the raw data, we have downsampled data that falls on the screens of users who monitor the system. <br><br>  Raw data is stored in parquet format.  At first we chose JSON, then we tried CSV, but in the end we came to the conclusion that it was the ‚Äúparquet‚Äù that satisfied both the analytics team and the development team. <br><br>  Actually, the first version of the system was built on DynamoDB, and I don‚Äôt want to say anything bad about this database.  Simply, as soon as we had analysts ‚Äî mathematicians who must work with the data ‚Äî it turned out that the query language for DynamoDB was too complicated for them.  They had to specially prepare data for ML and analytics.  Therefore, we stopped at Athena - the query editor in AWS.  For us, its advantages are that it allows you to read Parquet data, write SQL, and collect the results in a CSV file.  Just what the analyst team needs. <br><br><h2>  Stage two: what do we analyze? </h2><br>  So, from one small object we collected about 3 GB of raw data.  Now we know a lot about temperature, vibration and acceleration along the axes.  It means that the time has come for our mathematicians to come together to understand how, in fact, what we are trying to predict on the basis of this information. <br><br>  <i>The goal is to minimize equipment downtime.</i> <br><br><img src="https://habrastorage.org/webt/x0/5j/t3/x05jt3aaezuzpdwok7l-wtuqf4g.jpeg"><br><br>  <i>People enter this Coca-Cola plant only when they receive a signal of breakage, oil leakage or, say, a puddle on the floor.</i>  <i>The cost of one robot starts at $ 30,000 dollars, but almost all production is built on them</i> <br><br><img src="https://habrastorage.org/webt/zf/st/co/zfstcoyb2v_0ei4hqi7lh3kd3uu.jpeg"><br><br>  <i>About 10,000 people work at six Tesla factories, and for production of such a scale it is quite a bit.</i>  <i>Interestingly, Mercedes plants are automated to a much greater extent.</i>  <i>It is clear that all robots involved need constant monitoring.</i> <br><br>  The more expensive the robot, the less its working part vibrates.  With simple actions, this may not be decisive, but more subtle operation, say, with the neck of the bottle, requires that it be kept to a minimum.  Of course, the vibration level of expensive cars must be constantly monitored. <br><br><h2>  Time-saving services </h2><br>  We launched the first installation in just over three months, and I believe that this is fast. <br><br><img src="https://habrastorage.org/webt/dl/ca/6l/dlca6lwxu8db9a8urijocy9p1io.jpeg"><br><br>  <i>Actually, these are the main five points, which allowed to save developer efforts</i> <br><br>  The first, due to which we have reduced the time - most of the system is built on AWS, which scales on its own.  As soon as the number of users exceeds a certain threshold, auto-scaling works, and no one from the team has to spend time on it. <br><br>  I would like to draw attention to two nuances.  First, we work with large amounts of data, and in the first version of the system we had pipelines in order to make backups.  After some time, the data became too much, and keeping copies for them became too expensive.  Then we simply left Raw data lying in the bucket, read-only, forbidding them to be deleted, and refused backups. <br><br>  Our system involves continuous integration, to support the new site and the new installation takes not so much time. <br><br>  It is clear that realtime is built on events.  Although, of course, there are difficulties due to the fact that some events are triggered twice or the system loses touch, for example, due to weather conditions. <br><br>  Data encryption, which the customer required, automatically takes place in AWS.  Each client has its own bake, and we don‚Äôt do anything to encrypt data. <br><br><h2>  Meeting with analysts </h2><br>  We received the very first code in PDF format along with the request to implement this or that model.  While we did not start receiving the code in the form of .ipynb, it was alarming, but the fact is that analysts are mathematicians far from programming.  All our operations take place in the cloud, we do not allow downloading data.  Together, all these moments pushed us to try the SageMaker platform. <br><br>  SageMaker allows out of the box to use about 80 algorithms, it includes frameworks: Caffe2, Mxnet, Gluon, TensorFlow, Pytorch, Microsoft cognitive tool kit.  We currently use Keras + TensorFlow, but all but the Microsoft cognitive toolkit have had time to try.  Such wide coverage allows us not to limit our own analytical team. <br><br><img src="https://habrastorage.org/webt/ja/pd/is/japdisyszpehfqtquzcmlyl5sru.jpeg"><br><br>  For the first three or four months, all the work was done by people with the help of simple mathematics; no ML really existed yet.  Part of the system is based on purely mathematical laws, and it is designed for statistical data.  That is, we monitor the average temperature level, and if we see that it goes off scale, alerts will be triggered. <br><br>  Then follows the training model.  Everything looks easy and simple, and it seems so before the start of implementation. <br><br><h3>  Build, train, deploy ... </h3><br><img src="https://habrastorage.org/webt/d4/ol/db/d4oldbfr8ks7xilugkd92hhbqge.png"><br><br>  Briefly tell you how we got out of the situation.  Look at the second column: collect data, process, clean, use S3 bucket and Glue to launch events and create ‚Äúpartitions‚Äù.  We have all the data decomposed into partitions for Athena, this is also an important nuance, because Athena is built on top of S3.  Athena itself is very cheap.  But we pay for what we read the data and get them from S3, t. H. Each request can be very expensive.  Therefore, we have a large partitions system. <br><br>  We have a downsampler.  And Amazon EMR, which allows you to quickly collect data.  Actually, for feature engineering in our cloud, for every analyst, Jupyter Notebook is raised - this is their own instance.  And they analyze everything directly in the cloud. <br><br>  Thanks to SageMaker, we were primarily able to skip the Training Clusters stage.  If we didn‚Äôt use this platform, we would have to raise clusters in Amazon, and some of the DevOps engineers would have to keep an eye on them.  SageMaker allows you to raise a cluster using the parameters of the method on the Docker image, you just have to specify the number of instances in the parameter you want to use. <br><br>  Next, we do not have to do scaling.  If we want to process a large algorithm or we need to urgently calculate something, we turn on auto-scaling (everything depends on whether you want to use a CPU or a GPU). <br><br>  In addition, all our models are encrypted: it also goes out of the box in SageMaker - the binaries that are in S3. <br><br><h3>  Model Deployment </h3><br>  We are getting to the first model, deployed in the environment.  Actually, SageMaker allows you to save model artifacts, but just at this stage we had a lot of controversy, because SageMaker has its own model format.  We wanted to get away from it, getting rid of restrictions, so our models are stored in pickle format, so that if we want we can use at least Keras, even TensorFlow or something else.  Although we used the first model from SageMaker, as it is, through the native API. <br><br>  SageMaker makes it easy to work in three more steps.  Every time you try to predict something, you have to start some process, give the data and get the prediction values.  With this, everything went fine until you needed custom algorithms. <br><br><img src="https://habrastorage.org/webt/k_/an/8t/k_an8tdryy5zy84x7q5jhdx9trk.jpeg"><br><br>  Analysts know that they have a CI and a repository.  In the CI repository there is a folder where they should upload three files.  Serve.py is a file that allows SageMaker to raise the Flask service and communicate with SageMaker itself.  Train.py‚Äî class with the train method, in which they have to put everything they need for a model.  Finally, predict.py - with its help they raise this class, within which there is a method.  Having access, they bring up all sorts of resources from S3 - inside SageMaker we have an image that allows you to run anything from the interface and programmatically (we do not limit them). <br><br>  From SageMaker we get access to predict.py - inside image - it‚Äôs just an application on Flask that allows you to call predict or train with certain parameters.  All this is tied to S3 and, in addition, they have the ability to save models from Jupyter Notebook.  That is, in Jupyter Notebook, analysts have access to all the data, and they can do some kind of experiment. <br><br>  In production, it all falls as follows.  We have users, there is a predict values ‚Äã‚Äãendpoint.  The data lie on S3 and get Athena.  Every two hours, an algorithm is launched that counts the prediction for the next two hours.  Such a time step is due to the fact that in our case, about 6 hours of analytics are enough to say that something is wrong with the motor.  Even at the moment of switching on, the motor heats up for 5‚Äì10 minutes, and there are no sharp jumps. <br><br>  In systems that are critical, for example, when Air France checks the turbines of an aircraft, the prediction is done at the rate of 10 minutes.  In this case, the accuracy is 96.5%. <br><br>  If we see that something is going wrong, the notification system is activated.  Then someone from the set of users on the clock or another device receives a notification that a particular motor behaves abnormally.  He goes and checks his condition. <br><br><h3>  Manage Notebook Instances </h3><br><img src="https://habrastorage.org/webt/ue/l4/kz/uel4kzfs0p98y9urjewk2d6kk9o.jpeg"><br><br>  In fact, everything is very simple.  Coming to work, the analyst runs the instance on Jupyter Notebook.  He gets the role and session, so two people cannot edit the same file.  Actually, we now have an instance for each analyst. <br><br><h3>  Create Training Job </h3><br>  SageMaker has an understanding of training jobs.  Its result, if you use just an API - a binary that is stored on S3: from the parameters you provide, your model is obtained. <br><br><pre><code class="python hljs">sagemaker = boto3.client(<span class="hljs-string"><span class="hljs-string">'sagemaker'</span></span>) sagemaker.create_training_job(**create_training_params) status = sagemaker.describe_training_job(TrainingJobName=job_name)[<span class="hljs-string"><span class="hljs-string">'TrainingJobStatus'</span></span>] print(status) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: sagemaker.get_waiter(<span class="hljs-string"><span class="hljs-string">'training_job_completed_or_stopped'</span></span>).wait(TrainingJobName=job_name) <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: status = sagemaker.describe_training_job(TrainingJobName=job_name)[<span class="hljs-string"><span class="hljs-string">'TrainingJobStatus'</span></span>] print(<span class="hljs-string"><span class="hljs-string">"Training job ended with status: "</span></span> + status) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status == <span class="hljs-string"><span class="hljs-string">'Failed'</span></span>: message = sagemaker.describe_training_job(TrainingJobName=job_name)[<span class="hljs-string"><span class="hljs-string">'FailureReason'</span></span>] print(<span class="hljs-string"><span class="hljs-string">'Training failed with the following error: {}'</span></span>.format(message)) <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception(<span class="hljs-string"><span class="hljs-string">'Training job failed'</span></span>)</code> </pre> <br><h3>  Training Params Example </h3><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"AlgorithmSpecification"</span></span>: { <span class="hljs-string"><span class="hljs-string">"TrainingImage"</span></span>: image, <span class="hljs-string"><span class="hljs-string">"TrainingInputMode"</span></span>: <span class="hljs-string"><span class="hljs-string">"File"</span></span> }, <span class="hljs-string"><span class="hljs-string">"RoleArn"</span></span>: role, <span class="hljs-string"><span class="hljs-string">"OutputDataConfig"</span></span>: { <span class="hljs-string"><span class="hljs-string">"S3OutputPath"</span></span>: output_location }, <span class="hljs-string"><span class="hljs-string">"ResourceConfig"</span></span>: { <span class="hljs-string"><span class="hljs-string">"InstanceCount"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"InstanceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"ml.c4.8xlarge"</span></span>, <span class="hljs-string"><span class="hljs-string">"VolumeSizeInGB"</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> }, <span class="hljs-string"><span class="hljs-string">"TrainingJobName"</span></span>: job_name, <span class="hljs-string"><span class="hljs-string">"HyperParameters"</span></span>: { <span class="hljs-string"><span class="hljs-string">"k"</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-string"><span class="hljs-string">"feature_dim"</span></span>: <span class="hljs-string"><span class="hljs-string">"784"</span></span>, <span class="hljs-string"><span class="hljs-string">"mini_batch_size"</span></span>: <span class="hljs-string"><span class="hljs-string">"500"</span></span>, <span class="hljs-string"><span class="hljs-string">"force_dense"</span></span>: <span class="hljs-string"><span class="hljs-string">"True"</span></span> }, <span class="hljs-string"><span class="hljs-string">"StoppingCondition"</span></span>: { <span class="hljs-string"><span class="hljs-string">"MaxRuntimeInSeconds"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> }, <span class="hljs-string"><span class="hljs-string">"InputDataConfig"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"ChannelName"</span></span>: <span class="hljs-string"><span class="hljs-string">"train"</span></span>, <span class="hljs-string"><span class="hljs-string">"DataSource"</span></span>: { <span class="hljs-string"><span class="hljs-string">"S3DataSource"</span></span>: { <span class="hljs-string"><span class="hljs-string">"S3DataType"</span></span>: <span class="hljs-string"><span class="hljs-string">"S3Prefix"</span></span>, <span class="hljs-string"><span class="hljs-string">"S3Uri"</span></span>: data_location, <span class="hljs-string"><span class="hljs-string">"S3DataDistributionType"</span></span>: <span class="hljs-string"><span class="hljs-string">"FullyReplicated"</span></span> } }, <span class="hljs-string"><span class="hljs-string">"CompressionType"</span></span>: <span class="hljs-string"><span class="hljs-string">"None"</span></span>, <span class="hljs-string"><span class="hljs-string">"RecordWrapperType"</span></span>: <span class="hljs-string"><span class="hljs-string">"None"</span></span> } ] }</code> </pre> <br>  <b>Options.</b>  The first is the role: you must specify what your SageMaker instance has access to.  That is, in our case, if the analyst works with two different productions, he should see one bucket and not see the other.  Output config is where you save all the metadata of the model. <br><br>  We skip the autoscale and we can simply indicate the number of instances where you want to run this training job.  At first, we generally used middle instances without TensorFlow or Keras, and that was enough. <br><br>  <b>Hyperparameters.</b>  You specify the Docker image in which you want to run.  Amazon usually provides a list of algorithms and images with them, that is, you must specify hyperparameters - the parameters of the algorithm itself. <br><br><h3>  Create Model </h3><br><pre> <code class="python hljs">%%time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> boto3 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> gmtime, strftime job_name = <span class="hljs-string"><span class="hljs-string">'kmeans-lowlevel-'</span></span> + strftime(<span class="hljs-string"><span class="hljs-string">"%Y-%m-%d-%H-%M-%S"</span></span>, gmtime()) print(<span class="hljs-string"><span class="hljs-string">"Training job"</span></span>, job_name) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sagemaker.amazon.amazon_estimator <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_image_uri image = get_image_uri(boto3.Session().region_name, <span class="hljs-string"><span class="hljs-string">'kmeans'</span></span>) output_location = <span class="hljs-string"><span class="hljs-string">'s3://{}/kmeans_example/output'</span></span>.format(bucket) print(<span class="hljs-string"><span class="hljs-string">'training artifacts will be uploaded to: {}'</span></span>.format(output_location)) create_training_params = \ { <span class="hljs-string"><span class="hljs-string">"AlgorithmSpecification"</span></span>: { <span class="hljs-string"><span class="hljs-string">"TrainingImage"</span></span>: image, <span class="hljs-string"><span class="hljs-string">"TrainingInputMode"</span></span>: <span class="hljs-string"><span class="hljs-string">"File"</span></span> }, <span class="hljs-string"><span class="hljs-string">"RoleArn"</span></span>: role, <span class="hljs-string"><span class="hljs-string">"OutputDataConfig"</span></span>: { <span class="hljs-string"><span class="hljs-string">"S3OutputPath"</span></span>: output_location }, <span class="hljs-string"><span class="hljs-string">"ResourceConfig"</span></span>: { <span class="hljs-string"><span class="hljs-string">"InstanceCount"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"InstanceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"ml.c4.8xlarge"</span></span>, <span class="hljs-string"><span class="hljs-string">"VolumeSizeInGB"</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> }, <span class="hljs-string"><span class="hljs-string">"TrainingJobName"</span></span>: job_name, <span class="hljs-string"><span class="hljs-string">"HyperParameters"</span></span>: { <span class="hljs-string"><span class="hljs-string">"k"</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-string"><span class="hljs-string">"feature_dim"</span></span>: <span class="hljs-string"><span class="hljs-string">"784"</span></span>, <span class="hljs-string"><span class="hljs-string">"mini_batch_size"</span></span>: <span class="hljs-string"><span class="hljs-string">"500"</span></span>, <span class="hljs-string"><span class="hljs-string">"force_dense"</span></span>: <span class="hljs-string"><span class="hljs-string">"True"</span></span> }, <span class="hljs-string"><span class="hljs-string">"StoppingCondition"</span></span>: { <span class="hljs-string"><span class="hljs-string">"MaxRuntimeInSeconds"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> }, <span class="hljs-string"><span class="hljs-string">"InputDataConfig"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"ChannelName"</span></span>: <span class="hljs-string"><span class="hljs-string">"train"</span></span>, <span class="hljs-string"><span class="hljs-string">"DataSource"</span></span>: { <span class="hljs-string"><span class="hljs-string">"S3DataSource"</span></span>: { <span class="hljs-string"><span class="hljs-string">"S3DataType"</span></span>: <span class="hljs-string"><span class="hljs-string">"S3Prefix"</span></span>, <span class="hljs-string"><span class="hljs-string">"S3Uri"</span></span>: data_location, <span class="hljs-string"><span class="hljs-string">"S3DataDistributionType"</span></span>: <span class="hljs-string"><span class="hljs-string">"FullyReplicated"</span></span> } }, <span class="hljs-string"><span class="hljs-string">"CompressionType"</span></span>: <span class="hljs-string"><span class="hljs-string">"None"</span></span>, <span class="hljs-string"><span class="hljs-string">"RecordWrapperType"</span></span>: <span class="hljs-string"><span class="hljs-string">"None"</span></span> } ] } sagemaker = boto3.client(<span class="hljs-string"><span class="hljs-string">'sagemaker'</span></span>) sagemaker.create_training_job(**create_training_params) status = sagemaker.describe_training_job(TrainingJobName=job_name)[<span class="hljs-string"><span class="hljs-string">'TrainingJobStatus'</span></span>] print(status) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: sagemaker.get_waiter(<span class="hljs-string"><span class="hljs-string">'training_job_completed_or_stopped'</span></span>).wait(TrainingJobName=job_name) <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: status = sagemaker.describe_training_job(TrainingJobName=job_name)[<span class="hljs-string"><span class="hljs-string">'TrainingJobStatus'</span></span>] print(<span class="hljs-string"><span class="hljs-string">"Training job ended with status: "</span></span> + status) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status == <span class="hljs-string"><span class="hljs-string">'Failed'</span></span>: message = sagemaker.describe_training_job(TrainingJobName=job_name)[<span class="hljs-string"><span class="hljs-string">'FailureReason'</span></span>] print(<span class="hljs-string"><span class="hljs-string">'Training failed with the following error: {}'</span></span>.format(message)) <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception(<span class="hljs-string"><span class="hljs-string">'Training job failed'</span></span>) %%time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> boto3 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> gmtime, strftime model_name=job_name print(model_name) info = sagemaker.describe_training_job(TrainingJobName=job_name) model_data = info[<span class="hljs-string"><span class="hljs-string">'ModelArtifacts'</span></span>][<span class="hljs-string"><span class="hljs-string">'S3ModelArtifacts'</span></span>] print(info[<span class="hljs-string"><span class="hljs-string">'ModelArtifacts'</span></span>]) primary_container = { <span class="hljs-string"><span class="hljs-string">'Image'</span></span>: image, <span class="hljs-string"><span class="hljs-string">'ModelDataUrl'</span></span>: model_data } create_model_response = sagemaker.create_model( ModelName = model_name, ExecutionRoleArn = role, PrimaryContainer = primary_container) print(create_model_response[<span class="hljs-string"><span class="hljs-string">'ModelArn'</span></span>])</code> </pre><br>  Creating a model is the result of a training job.  After the last one is completed, and when you monitor it, it is saved on S3, and you can use it. <br><br><img src="https://habrastorage.org/webt/5e/w7/1g/5ew71gojdaow2t1mriz0qfuifmi.jpeg"><br><br>  That's how it looks from the perspective of analysts.  Our analysts come to the models, and they say: I want to launch this model in this image.  They simply point to the S3 folder, Image, and enter parameters into the GUI.  But there are nuances and difficulties, so we switched to custom algorithms. <br><br><h3>  Create Endpoint </h3><br><pre> <code class="python hljs">%%time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time endpoint_name = <span class="hljs-string"><span class="hljs-string">'KMeansEndpoint-'</span></span> + strftime(<span class="hljs-string"><span class="hljs-string">"%Y-%m-%d-%H-%M-%S"</span></span>, gmtime()) print(endpoint_name) create_endpoint_response = sagemaker.create_endpoint( EndpointName=endpoint_name, EndpointConfigName=endpoint_config_name) print(create_endpoint_response[<span class="hljs-string"><span class="hljs-string">'EndpointArn'</span></span>]) resp = sagemaker.describe_endpoint(EndpointName=endpoint_name) status = resp[<span class="hljs-string"><span class="hljs-string">'EndpointStatus'</span></span>] print(<span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + status) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: sagemaker.get_waiter(<span class="hljs-string"><span class="hljs-string">'endpoint_in_service'</span></span>).wait(EndpointName=endpoint_name) <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: resp = sagemaker.describe_endpoint(EndpointName=endpoint_name) status = resp[<span class="hljs-string"><span class="hljs-string">'EndpointStatus'</span></span>] print(<span class="hljs-string"><span class="hljs-string">"Arn: "</span></span> + resp[<span class="hljs-string"><span class="hljs-string">'EndpointArn'</span></span>]) print(<span class="hljs-string"><span class="hljs-string">"Create endpoint ended with status: "</span></span> + status) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status != <span class="hljs-string"><span class="hljs-string">'InService'</span></span>: message = sagemaker.describe_endpoint(EndpointName=endpoint_name)[<span class="hljs-string"><span class="hljs-string">'FailureReason'</span></span>] print(<span class="hljs-string"><span class="hljs-string">'Training failed with the following error: {}'</span></span>.format(message)) <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception(<span class="hljs-string"><span class="hljs-string">'Endpoint creation did not succeed'</span></span>)</code> </pre> <br>  So much code is needed to create an Endpoint that jerks from any lambda and from the outside.  Every two hours we have an event that jerks Endpoint. <br><br><h3>  Endpoint View </h3><br><img src="https://habrastorage.org/webt/tw/_n/rf/tw_nrfder3poxjeli61cpr8jtle.jpeg"><br><br>  So analysts see it.  They simply indicate the algorithm, time and pull it with the hands from the interface. <br><br><h3>  Invoke endpoint </h3><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json payload = np2csv(train_set[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span>]) response = runtime.invoke_endpoint(EndpointName=endpoint_name, ContentType=<span class="hljs-string"><span class="hljs-string">'text/csv'</span></span>, Body=payload) result = json.loads(response[<span class="hljs-string"><span class="hljs-string">'Body'</span></span>].read().decode()) print(result)</code> </pre><br>  And this is how it is done from lambda.  That is, we have Endpoint inside, and every two hours we send a payload in order to make a prediction. <br><br><h3>  Useful SageMaker Links: links to github </h3><br>  These are very important links.  Honestly, after we started using the usual Sagemaker GUI, everyone understood that sooner or later we would come to the custom algorithm, and all this would be assembled by hand.  These links can be used to find not only the use of algorithms, but also the assembly of custom images: <br><br>  <a href="https://github.com/awslabs/amazon-sagemaker-examples">github.com/awslabs/amazon-sagemaker-examples</a> <br><br>  <a href="https://github.com/aws-samples/aws-ml-vision-end2end">github.com/aws-samples/aws-ml-vision-end2end</a> <br><br>  <a href="https://github.com/juliensimon">github.com/juliensimon</a> <br><br>  <a href="https://github.com/aws/sagemaker-spark">github.com/aws/sagemaker-spark</a> <br><br><h2>  What's next? </h2><br>  We have come to the fourth production and now, apart from analytics, we have two ways of development.  First, we are trying to get logs from the mechanics, that is, we are trying to come to the training with support.  The first Mantainence logs that we received look like this: something broke on Monday, I went there on Wednesday, started repairing it on Friday.  We are now trying to deliver a CMS to the customer - a content management system that will allow logging breakdown events. <br><br>  How it's done?  As a rule, as soon as a breakdown happens, the mechanic comes in and changes the part very quickly, but he can fill out all paper forms, say, in a week.  By this time, the person simply forgets what exactly happened to the part.  CMS, of course, takes us to a new level of interaction with the mechanics. <br><br>  Secondly, we are going to install ultrasonic sensors on the motors, which read the sound and are engaged in spectral analysis. <br><br>  It is possible that Athena will give up, because on large data, using S3 is expensive.  At the same time, Microsoft recently announced its own services, and one of our customers wants to try to do roughly the same thing already on Azure.  Actually, one of the advantages of our system is that it can be disassembled and assembled elsewhere, like from cubes. </div><p>Source: <a href="https://habr.com/ru/post/453888/">https://habr.com/ru/post/453888/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453876/index.html">How Yandex.Practicum won the front-end desync: acrobatic number with Redux-Saga, postMessage and Jupyter</a></li>
<li><a href="../45388/index.html">Flower router</a></li>
<li><a href="../453882/index.html">Big guide to the profession of decision architect (+ list of useful links)</a></li>
<li><a href="../453884/index.html">Google Camera - HYIP or replacement SLR?</a></li>
<li><a href="../453886/index.html">The program works</a></li>
<li><a href="../45389/index.html">TRAC installation for FreeBSD for beginners</a></li>
<li><a href="../453890/index.html">Soviet dreams of the future</a></li>
<li><a href="../453892/index.html">ISTQB certification. Part 2: How to prepare for ISTQB certification? Practice Stories</a></li>
<li><a href="../453896/index.html">Development of high-speed printed circuit boards through the eyes of a circuit design engineer. Maintaining the integrity of electrical signals</a></li>
<li><a href="../4539/index.html">Personal search engine using Live Search Macros</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>