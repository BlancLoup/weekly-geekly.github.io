<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reading large amounts of data in Python / Postgresql</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Stack of technologies under consideration : Postgresql 9.3, Python 2.7 with the ‚Äúpsycopg2‚Äù module installed. 

 Problem 
 How often in your practice d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reading large amounts of data in Python / Postgresql</h1><div class="post__text post__text-html js-mediator-article">  <b>Stack of technologies under consideration</b> : Postgresql 9.3, Python 2.7 with the ‚Äúpsycopg2‚Äù module installed. <br><br><h1>  Problem </h1><br>  How often in your practice did you encounter the task of processing large tables (more than 10 million records)?  I think you will agree that this task is quite resource-intensive both in terms of processing time and the system resources involved.  Today I will try to show an alternative way to solve the problem. <br><br><h1>  Sentence: </h1><br>  DBMS Postgresql has an excellent operator for working with large volumes of information, namely ‚ÄúCOPY‚Äù.  The use of this operator allows us to read and write huge amounts of information in a table.  In this article we will consider the reading mode. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      According to the documentation of the ‚ÄúCOPY‚Äù operator, we have several read modes available in the file or in the STDOUT stream, as well as various formats, including ‚Äúcsv‚Äù.  Just we will try to use it with maximum benefit. <br><a name="habracut"></a><br><h1>  Training: </h1><br>  As a ‚Äúguinea pig‚Äù, we will create a table with 1 million records and write a small script reflecting the essence of the method.  The sql file can be found in my git repository (the link can be found at the bottom of the article). <br><br>  Also do not forget to install the psycopg2 extension! <br><br><h1>  Implementation: </h1><br>  To fetch the data, we will use the wonderful function ‚Äúcopy_expert‚Äù, which allows us to execute ‚ÄúCOPY‚Äù requests from the Python client. <br><br><pre><code class="python hljs">query = <span class="hljs-string"><span class="hljs-string">""" SELECT * from big_data inner join big_data as t1 USING(fname) """</span></span> output = StringIO() self.cursor.copy_expert(<span class="hljs-string"><span class="hljs-string">"COPY (%s) TO STDOUT (FORMAT 'csv', HEADER true)"</span></span> % query, output) data = output.getvalue() output.close() result = list() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> getResults(data): <span class="hljs-comment"><span class="hljs-comment"># do whatever we need item = {k: None if v == "" else v for k, v in item.items()} result.append(item)</span></span></code> </pre> <br>  Explanation of the code: <br><br><ol><li>  In the query, we do a join for ourselves, for its complication (it is noted that the advantage in speed is directly proportional to the complexity of the query); </li><li>  For the buffer, use the ‚ÄúStringIO‚Äù object, where we will write data from the cursor; </li><li>  Parse string will be the generator "getResults"; </li><li>  For convenience of interpretation, I convert all blank lines to the ‚ÄúNone‚Äù type, since  after using ‚ÄúCOPY‚Äù we get the string values; </li><li>  I want to note that the format I will use ‚Äúcsv‚Äù with the leading header line, why you will understand that way, a little later. </li></ol><br>  Generator code: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getResults</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stream)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" get result generator """</span></span> f = StringIO(stream) result = csv.DictReader(f, restkey=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> result: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> item f.close()</code> </pre><br>  Explanations: <br><br><ol><li>  As you can see from the listing, again we use the already familiar ‚ÄúStringIO‚Äù buffer; </li><li>  To convert the string ‚Äúcsv‚Äù into a dictionary (dictionary) we use the ‚ÄúDictReader‚Äù method of the native csv library.  By default, this method takes the first line as a list of dictionary fields. </li></ol><br>  That's all we need! <br><br>  <b>My configuration</b> : MacBook Air 2013 Processor: 1.3 GHz Intel Core i5, Ram: 4 GB 1600 MHz DDR3, SSD. <br><br>  <b>PS:</b> <br>  I want to note that this approach to speeding up reading does not always work, namely, if you have a fairly simple table of 3-5 fields, you will not notice a tangible difference (at least up to 1 million).  However, this method shows just a crazy increase in speed, with complex queries, the acceleration reaches up to 10-20 times!  Also, the configuration of the hardware on which the script runs is very strongly affected. <br><br>  All code can be found in the git repository <a href="https://github.com/drizgolovicha/python_bulk_read">https://github.com/drizgolovicha/python_bulk_read</a> . <br><br>  I would be happy with comments and suggestions for optimization! <br><br>  Thank you for reading to the end. <br><br>  <b>UPD</b> : <br>  Results of measurements sample (14k) records: <br><ol><li>  Direct SELECT, Where the condition for the non-indexed field is 21.4s </li><li>  COPY previous request - 13.1s </li><li>  Selection of the same SELECT, but from the materialized view with an index across the field - 12.6 s </li><li>  COPY materialized view - 1.8c </li></ol></div><p>Source: <a href="https://habr.com/ru/post/280822/">https://habr.com/ru/post/280822/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280812/index.html">Mythbusters: Automatic Google Recaptcha Solution</a></li>
<li><a href="../280814/index.html">Framework fastcgi container</a></li>
<li><a href="../280816/index.html">About the UHD-resolution restaurant table and other interactive technologies from Kodisoft</a></li>
<li><a href="../280818/index.html">As I wrote the library under IEC 870-5-104 on Arduino using Wireshark</a></li>
<li><a href="../280820/index.html">The digest of interesting materials from the world of MODX # 1</a></li>
<li><a href="../280824/index.html">IL2CPP: generated code tour</a></li>
<li><a href="../280826/index.html">Announcement of the Russian-language catalog of solutions of independent developers certified for Microsoft Azure</a></li>
<li><a href="../280828/index.html">New big css book</a></li>
<li><a href="../280830/index.html">RING buffer - 2D case</a></li>
<li><a href="../280832/index.html">Critical vulnerability in TrendMicro antivirus allows remote code execution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>