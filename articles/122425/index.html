<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with KVM virtual machines. Virtual Machine Resource Limiting</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous series of publications, we discussed with you the issues of preparing a host machine , creating and cloning virtual machines. Today I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with KVM virtual machines. Virtual Machine Resource Limiting</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/576/9e5/f39/5769e5f39262c9b34438d2d5df34f87f.png" align="left"><br><br>  In the previous <s>series of</s> publications, we discussed with you the issues of <a href="http://habrahabr.ru/blogs/virtualization/120717/">preparing a host machine</a> , creating and <a href="http://habrahabr.ru/blogs/virtualization/121218/">cloning</a> virtual machines.  Today I will tell about not less important question - about restriction of use of resources by virtual computers. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Introduction to cgroups </h4><br><br>  To limit the resources used by virtual machines, I suggest using <b><a href="http://www.kernel.org/doc/Documentation/cgroups/">cgroups</a></b> , a kernel subsystem that uses the scheduling linux tasks to set the required limits. <br><br>  In runet, the work of <b>cgroups is</b> practically not covered, on foreign Internet, basically, everything is limited to the description of the famous patch ‚Äú <a href="http://marc.info/%3Fl%3Dlinux-kernel%26m%3D128978361700898%26w%3D2">200 lines kernel patch that does wonders</a> ‚Äù, except, perhaps, the <a href="http://berrange.com/posts/2009/12/03/using-cgroups-with-libvirt-and-lxckvm-guests-in-fedora-12/">article by Daniel Berrange</a> . <br><br>  In this article, I want to consider working with <b>cgroups</b> in relation to virtual machines, but this does not prevent us from using this subsystem to perform common desktop tasks. <br><br>  In fact, <b>cgroups</b> is a hierarchical file system, similar to / sys or / proc, which provides a simple interface for accessing the internal mechanisms for allocating resources in the kernel.  To understand what this file system is, an example will help us: create mount points and mount two controllers there - <b>cpu</b> and <b>blkio</b> , and see what's inside. <br><br> <code># mkdir /cgroup <br> # mkdir /cgroup/cpu <br> # mkdir /cgroup/blkio <br> # mount -t cgroup -ocpu cgroup /cgroup/cpu <br> # mount -t cgroup -oblkio cgroup /cgroup/blkio <br> # ls /cgroup/cpu <br> cgroup.clone_children cgroup.event_control cgroup.procs cpu.rt_period_us cpu.rt_runtime_us cpu.shares notify_on_release release_agent sysdefault tasks <br> # ls /cgroup/blkio <br> blkio.io_merged blkio.io_service_time blkio.throttle.io_service_bytes blkio.throttle.write_bps_device blkio.weight_device tasks blkio.io_queued blkio.io_wait_time blkio.throttle.io_serviced blkio.throttle.write_iops_device cgroup.clone_children notify_on_release blkio.io_service_bytes <br> blkio.reset_stats blkio.throttle.read_bps_device blkio.time cgroup.event_control release_agent <br> blkio.io_serviced blkio.sectors blkio.throttle.read_iops_device blkio.weightcgroup.procs sysdefault <br></code> <br><br>  The <b>tasks</b> file in each branch of the tree contains the PID of the processes that will be managed through a specific group in cgroups.  Thus it is possible to implement a hierarchical structure of limiting processes.  It should be borne in mind that limits apply to all processes in a group. <br><br><h4>  CPU load limiting </h4><br><br>  A little bit about how you can limit the process.  This can be done very simply: <br><br><ul><li>  Select the PID that we want to put in cgroups. </li><li>  We put it in tasks. </li><li>  We set limits (we assign a process weight, it can be set arbitrarily, but the value must be greater than zero). </li></ul><br><br> <code># echo $$ &gt; /cgroup/cpu/tasks <br> # echo 100 &gt; /cgroup/cpu/cpu.shares <br></code> <br><br>  Where <b>100</b> is the weight assigned to the current bash process. <br><br>  There are some special features in adding PID to tasks.  For example, you can bind at most one process at a time, that is, <i>echo PID1 PID2 ...</i> will not work.  In addition, it should be noted that echo does not return the correct result of writing - for the most correct implementation, use the write () system call. <br><br>  This limiting method has a significant disadvantage: the limits cannot be strictly defined.  This limits their use in the service provision scheme, when a virtual amount of resources is assumed to be allocated for a virtual machine.  The <b>cgroups</b> developers assume that the processor will be used 100% (for which it is, in fact, needed), and not to stand idle.  This is implemented using the mechanism of scales. <br><br>  But this minus is often a big plus.  For example, take three virtual machines with weights of 50, 30, and 20, respectively, and one processor core.  If all machines have a maximum load, then each will be allocated, respectively, 50, 30 and 20 percent of the CPU. <br><br>  Often it is possible that a virtual machine does not need resources at some point in time.  Let's say it will be the second car (with a weight of 30).  Thus, two machines with weights of 50 and 20 will work: 71% (50 / (50 + 20)) of processor resources will be allocated to one machine, the second - 100% - 71% = 29%.  This nuance of resource allocation will allow the virtual machine, if necessary, to use up to the full power of the kernel. <br><br><h4>  Disk Subsystem Limiting </h4><br><br>  With disks, the situation is more complicated, although the implementation of limits there may be more stringent. <br><br>  Let's see what we have inside the blkio controller, which is responsible for managing disk IO. <br><br> <code># cd /cgroup/blkio <br> # ls <br> blkio.io_merged blkio.io_service_bytes blkio.io_service_time blkio.reset_stats blkio.time <br> blkio.weight_device cgroup.event_control release_agent blkio.io_queued <br> blkio.io_serviced blkio.io_wait_time blkio.sectors blkio.weight cgroup.clone_children <br> cgroup.procs notify_on_release tasks <br></code> <br><br>  As you can see, there are several parameters for limiting the performance of the disk subsystem, namely - <br><br><ul><li>  <b>iops</b> is the number of I / O operations per second </li><li>  <b>bps</b> - bandwidth </li><li>  <b>weight</b> is the weight of the system. </li></ul><br><br>  To indicate for which disk and which process <b>iops</b> or <b>bps</b> should be set, you need to determine the <i>major</i> and <i>minor</i> disk (see about <a href="http://www.kernel.org/pub/linux/docs/device-list/devices.txt">device classification</a> ) and send them to a special file (example for bps): <br><br> <code># ls -la /dev/sda <br> brw-rw---- 1 root disk <b>8</b> , <b>0</b>  11 13:59 /dev/sda <br> # echo $$ &gt; /cgroup/blkio/tasks <br> # echo 3 &gt; /proc/sys/vm/drop_caches <br> # echo "8:0 1000000" &gt; /cgroup/blkio/blkio.throttle.read_bps_device <br> # echo "8:0 1000000" &gt; /cgroup/blkio/blkio.throttle.write_bps_device <br> # dd if=/dev/zero of=/tmp/zerofile bs=4K count=102400 oflag=direct <br> # dd if=/tmp/zerofile of=/tmp/zerofile2 bs=4K count=102400 <br> 25426+0   <br> 25425+0   <br>  104140800  (104 MB), 102,21 c, 1,0 MB/c <br></code> <br><br>  Therefore, if you need to use hard limits, the virtual machine should use a separate block device (for example, an LVM partition), which will have <i>major</i> and <i>minor</i> .  For images as files, only the <b>blkio.weight</b> controller can be used. <br><br>  There is a logical question why dd adheres to the same limits that we asked for the bash interpreter.  Everything is very simple: <b>cgroups</b> keeps track of children that are forked by the parent and automatically bring them into tasks. <br><br>  It should be noted that blkio.throttling * appears if you enable the <b>CONFIG_BLK_CGROUP</b> and <b>CONFIG_BLK_DEV_THROTTLING</b> parameters in the kernel.  I recommend searching for menuconfig for the sake of interest according to CGROUP and BLK - by default there are a lot of interesting things disabled. <br><br>  Unfortunately, <b>cgroups</b> limits only disk access without using caching.  If you do not reset the caches or specify dd <b>oflag = direct</b> or <b>iflag = direct</b> , limits will not be applied.  Read more about it <a href="https://www.redhat.com/archives/libvir-list/2011-February/msg00177.html">here</a> and <a href="http://www.mjmwired.net/kernel/Documentation/cgroups/blkio-controller.txt">here</a> . <br><br>  <b>Everything</b> is simpler with <b>blkio.weight</b> : everything works in the same way as cpu.shares. <br><br><h4>  Work with cgroups from an unprivileged user </h4><br><br>  In <b>cgroups, an</b> unprivileged user cannot write.  But there is a set of utilities included in the <a href="http://libcg.sourceforge.net/">libcg</a> project that allow working with <b>cgroups</b> without administrative privileges.  On Debian, they can be installed along with the <b>cgroup-bin</b> package. <br><br>  Having installed the package, let's see which utilities are included in its composition: <br><br> <code>$ ls /usr/*bin/cg* <br> /usr/bin/cgclassify /usr/bin/cgdelete /usr/bin/cgget /usr/bin/cgsnapshot /usr/sbin/cgconfigparser <br> /usr/bin/cgcreate /usr/bin/cgexec /usr/bin/cgset /usr/sbin/cgclear /usr/sbin/cgrulesengd <br></code> <br><br>  The most useful for us will be <b>cgcreate</b> and <b>cgdelete</b> , as well as a script that, after reading the configuration file, will automatically create the necessary groups when the system starts up - <b>cgconfigparser</b> . <br><br>  <b>Perform cgconfig</b> configuration so that when you start the system we automatically mount the necessary file system: <br><br> <code>$ cat /etc/cgconfig.conf <br> mount { <br> cpu = /cgroup/cpu; <br> cpuacct = /cgroup/cpuacct; <br> devices = /cgroup/devices; <br> #   memory = /cgroup/memory; <br> blkio = /cgroup/blkio; <br> #   freezer = /cgroup/freezer; <br> cpuset = /cgroup/cpuset; <br> } <br> $ sudo /etc/init.d/cgconfig restart <br></code> <br><br>  We don‚Äôt really need the freezer and memory controllers, and the memory, moreover, refuses to be mounted automatically, and we will need to mount it manually if necessary. <br><br>  Let's create a group so that our unprivileged user <s>% username%</s> username can do self-improvement: <br><br> <code>$ sudo cgcreate -f 750 -d 750 -a username:libvirt -t username:libvirt -g cpu,blkio:username <br></code> <br><br>  Where: <br><br><ul><li>  -f and -d set permissions on files and directories within a group, respectively; </li><li>  -a and -t set the owner for the subsystem parameters and the tasks file </li><li>  -g creates groups for the specified cpu and blkio controllers relative to the root (for example, in this case, they will be / cgroup / cpu / username and / cgroup / blkio / username, respectively). </li></ul><br><br>  After this, you will see that the username directory has been created in the / cgroup / cpu and / cgroup / blkio directories, to which the specified user username can write tasks for cgroups. <br><br>  It is very convenient to create a group when starting a virtual machine and set limits there, and when stopped, delete the group: <br><br> <code>$ sudo cgdelete cpu,blkio:username <br></code> <br><br>  When using cgroups in servicing virtual machines, you can somewhat automate the process of setting limits and creating groups.  In the /etc/libvirt/qemu.conf file, you can specify controllers with which qemu can work.  You can also add a list of devices to which the virtual machine can access: <br><br> <code>cgroup_controllers = [ "cpu", "devices", "memory", "cpuset", "blkio" ] <br> cgroup_device_acl = [ <br> "/dev/null", "/dev/full", "/dev/zero", <br> "/dev/random", "/dev/urandom", <br> "/dev/ptmx", "/dev/kvm", "/dev/kqemu", <br> "/dev/rtc", "/dev/hpet", "/dev/net/tun", <br> ] <br></code> <br><br>  It is convenient to use virsh for setting cpu and blkio weights (part of the libvirt library, see the article about <a href="http://habrahabr.ru/blogs/virtualization/120717/">preparing the host system</a> ): <br><br> <code>$ virsh schedinfo --set cpu_shares=1024 debian_guest <br> $ virsh blkiotune debian_guest --weight 1024 <br></code> <br><br>  At the same time, the value in <b>/cgroup/cpu/sysdefault/libvirt/qemu/debian_guest/cpu.shares</b> will change to 1024. But, unfortunately, an ordinary user cannot change the settings in the sysdefault tree. <br><br><h4>  Network load limiting </h4><br><br>  With the resources of the processor and the disk, we slowly figured out.  Now the most important thing is the network.  It is important for us to get a hard band delimitation and at the same time acceptable values ‚Äã‚Äãof delay and load on the server.  What we are going to do now is scientifically called shaping and QoS (Quality of Service).  Selecting a band is easy - it is much more difficult to consider various scenarios for using a virtual machine. <br><br>  Suppose we need to allocate a band of 5 Mbps to a virtual machine.  Theoretically, the question is simple; it is solved by adding a rule for <a href="http://lartc.org/howto/">tc</a> (a strip with minimal delay): <br><br> <code>tc qdisc add dev debian_guest root handle 1: htb default 20 <br> tc class add dev debian_guest parent 1: classid 1:1 htb rate 5mbit burst 15k <br></code> <br><br>  But research into the question shows that such a simple separation is not enough. <br><br>  Suppose that we have a large flow of HTTP traffic, and it is difficult to reach the server. <br>  This is decided by prioritization. <br><br> <code>tc class add dev debian_guest parent 1:1 classid 1:10 htb rate 5mbit burst 15k prio 1 <br></code> <br><br>  Other: <br><br> <code>tc class add dev debian_guest parent 1:1 classid 1:20 htb rate 5mbit burst 15k prio 2 <br> tc qdisc add dev debian_guest parent 1:10 handle 10: sfq perturb 10 <br></code> <br><br>  SSH should be set higher: <br><br> <code>tc filter add dev debian_guest parent 1:0 protocol ip prio 10 u32 match ip tos 0x10 0xff flowid 1:10 <br></code> <br><br>  ICMP packets also need to be put higher: <br><br> <code>tc filter add dev debian_guest parent 1:0 protocol ip prio 10 u32 match ip protocol 1 0xff flowid 1:10 <br></code> <br><br>  TCP ACK also have the highest priority: <br><br> <code>tc filter add dev debian_guest parent 1: protocol ip prio 10 u32 match ip protocol 6 0xff match u8 0x05 0x0f at 0 match u16 0x0000 0xffc0 at 2 match u8 0x10 0xff at 33 flowid 1:10 <br></code> <br><br>  And let all the others go ... With the second priority. <br><br>  And this is our incoming traffic: <br><br> <code>tc qdisc add dev debian_guest handle ffff: ingress <br> tc filter add dev debian_guest parent ffff: protocol ip prio 50 u32 match ip src 0.0.0.0/0 police rate 5mbit burst 15k drop flowid :1 <br></code> <br><br>  You can add another 100,500 different rules, but you need to take into account the specifics of the virtual machine - maybe something needs to be closed, etc. <br><br>  In general, it does not hurt to close all sorts of IRC ports (6667-6669), torrents (6881-6889), and other godless services. <br><br>  When you stop, you can delete rules that are not required in the future: <br><br> <code>tc qdisc del dev debian_guest root <br> tc qdisc del dev debian_guest ingress <br></code> <br><br>  Statistics on the interface can be easily viewed: <br><br> <code>tc -s -d qdisc show dev debian_guest <br> tc -s -d class show dev debian_guest <br> tc -s -d filter show dev debian_guest <br></code> <br><br>  Accordingly, you can see how much traffic enters the interface and leaves it, and it is easy to set up all sorts of graphs. <br><br>  Very conveniently, you can combine the rules with iptables and tc using the mangle module (help Google) and then manage this traffic through tc.  For example, we need to mark traffic for bittorent and allocate for it a band of 1 kilobit: <br><br> <code>tc class add dev debian_guest parent 1:1 classid 1:30 htb rate 1kbit prio 3 <br> tc qdisc add dev debian_guest parent 1:30 handle 30: sfq perturb 10 <br> iptables -t mangle -A POSTROUTING -o debian_guest --sport 6881:6889 -j MARK --set-mark 30 <br> iptables -t mangle -A POSTROUTING -o debian_guest --dport 6881:6889 -j MARK --set-mark 30 <br></code> <br><br><h4>  In conclusion </h4><br><br>  After reading a series of articles ( <a href="http://habrahabr.ru/blogs/virtualization/120432/">1</a> , <a href="http://habrahabr.ru/blogs/virtualization/120717/">2</a> , <a href="http://habrahabr.ru/blogs/virtualization/121218/">3,</a> and <a href="http://habrahabr.ru/blogs/virtualization/122425/">4</a> ), you can install and configure the KVM virtualization system, the libvirt toolkit manager, and build your own virtual machine image.  All this will allow you to save resources, increase the reliability of the system (due to live migration of guest systems), simplify the creation of backups (for example, using LVM snapshots). <br><br>  I hope I managed to convey some useful information to you, and my experience in this series of articles will help you save your time. <br><br>  This concludes the first series of articles.  If something is interesting - ask in the comments, I am always ready to answer any questions that may arise. </div><p>Source: <a href="https://habr.com/ru/post/122425/">https://habr.com/ru/post/122425/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122418/index.html">The world's largest directory of sites Open Directory Project (dmoz) moved to Creative Commons Attribution</a></li>
<li><a href="../122419/index.html">Adobe added iPhone and iPad support in Flash Builder and Flex framework</a></li>
<li><a href="../122421/index.html">Requires small beta testing from unique specialists</a></li>
<li><a href="../122423/index.html">Unknown attackers uploaded compromised Wordpress plugins to the repository</a></li>
<li><a href="../122424/index.html">Accidentally deleted production base? What's next?</a></li>
<li><a href="../122426/index.html">WebMoney Escrow Secure Transaction Service</a></li>
<li><a href="../122428/index.html">Why are the processors so small?</a></li>
<li><a href="../122429/index.html">First Summer Feedback</a></li>
<li><a href="../122432/index.html">RURU: Payment system from Alfa-Bank and Beeline</a></li>
<li><a href="../122433/index.html">A first look at the Nokia N9: a couple of videos and a couple of thoughts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>