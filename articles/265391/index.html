<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ruby on Rails and interaction with REST Qiwi Shop</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have a great desire to talk about how easy it is to work with the QIWI Shop using Ruby on Rails. 

 What is QIWI Shop for? For example, you have you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ruby on Rails and interaction with REST Qiwi Shop</h1><div class="post__text post__text-html js-mediator-article">  I have a great desire to talk about how easy it is to work with the QIWI Shop using Ruby on Rails. <br><br>  What is QIWI Shop for?  For example, you have your own online store and you need to accept payments from users.  Qiwi is quite common in the world.  He does not require a personal certification for withdrawal of funds, as, for example, require WebMoney.  Therefore, QIWI is attractive enough for integration into online stores. <br><br><img src="https://habrastorage.org/files/d1a/c23/6b3/d1ac236b3cac484987b84232ca3d0b96.png"><br><a name="habracut"></a><br>  <b>Pros:</b> <br>  - Qiwi payment service is represented in <b>8</b> countries: Russia, Kazakhstan, Moldova, Romania, Belarus, USA, Brazil, Jordan. <br>  - Thousands of terminals throughout the country (Russia), which facilitates the replenishment of wallets without additional interest. <br>  - A person does not need to be familiar with the Internet in order to pay for the purchase in a minute or replenish the balance from another city - it is enough to walk to the terminal in the nearest store. <br>  - Lack of interest between transfers from one wallet to another. <br>  - An additional level of protection with one-time SMS passwords. <br>  - Free notification of transactions with Qiwi wallet. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I am developing on Ruby on Rails, so the examples I‚Äôll give will be in Ruby. <br><br>  <b>Qiwi offers several ways to integrate:</b> <br>  REST protocol <br>  HTTP protocol <br>  Billing form <br>  SOAP protocol (obsolete) <br><br>  <b>A few words about each method:</b> <br>  Form - allows you to generate the HTML code of a form that can be placed on the website of your online store, without resorting to programming.  After that, the status of the account can be monitored in the personal account of the store, or by receiving email notifications. <br><br>  HTTP protocol - allows you to create accounts using regular HTTP requests.  It is a simple request using the GET method, which is formed on the website of the online store based on the list of products selected by the user.  Easy to implement in any programming language sites.  Account status can also be monitored in your account, or by receiving email notifications. <br><br>  REST protocol is the most complete protocol.  Provides all available functionality for online stores.  Supports the implementation of a REST server on the side of a store that supports automated ordering logic.  Implementation can be done, for example, using Java, C #, PHP, Ruby, and others. <br><br>  Consider REST, which provides many functions and allows you to comfortably work with the store Qiwi. <br>  <b>Functions that we consider:</b> <br>  - Create an account. <br>  - Poll account status. <br><br>  It makes no sense to consider all the methods, because  in their likeness, they can be easily realized.  As the documentation of Qiwi itself says, the complexity of implementing REST is high, but nothing of the kind, everything looks quite simple and concise.  Consider an example. <br><br>  To get started, you need to get your APP_ID and APP_PASSWORD and SHOP_ID in your Qiwi Shop personal account, and for this you need to register with the Qiwi Shop and wait for approval from Qiwi. <br><br><img src="https://habrastorage.org/files/5f2/176/96c/5f217696c8e14caa859e4dfd9b9dd2fe.png"><br><br>  For authorization, you need to encrypt the store data in base64 as follows: <br>  user_creds = Base64.encode64 (Codename :: Application :: APP_ID + ':' + Codename :: Application :: APP_PASSWORD) <br><br><pre><code class="ruby hljs">Codename::Application::APP_ID -    application.rb</code> </pre> <br>  In the future, these data will be transmitted in the header for authorization.  After encryption, you need to create headers for authorization in the system: <br><br><pre> <code class="ruby hljs">headers = { <span class="hljs-symbol"><span class="hljs-symbol">:accept</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:json</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:authorization</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Basic '</span></span> + user_creds, <span class="hljs-symbol"><span class="hljs-symbol">:content_type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded; charset=utf-8'</span></span> }</code> </pre><br>  You also need an account id, which is the usual unique line by which it will be possible to identify the payment for further operations (check the payment on the account, mark the account, etc.).  Form: <br><pre> <code class="ruby hljs">bill_id = current_user.email.split(<span class="hljs-string"><span class="hljs-string">"@"</span></span>).first + <span class="hljs-string"><span class="hljs-string">'-'</span></span> + SecureRandom.hex(<span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre><br>  In my case, the formation of bills_id is as follows. <br><br>  The first part of the user's email is taken and a unique string is added to it with a hyphen.  It turns out at the output: 'snowacat-03a765e046'.  We form a link to create an account: <br><pre> <code class="ruby hljs">url = <span class="hljs-string"><span class="hljs-string">"https://w.qiwi.com/api/v2/prv/"</span></span> + Codename::Application::SHOP_ID + <span class="hljs-string"><span class="hljs-string">"/bills/"</span></span> + bill_id</code> </pre><br>  Payment Lifetime (time during which payment can be made): <br><pre> <code class="ruby hljs">life_time = Time.now.utc + Codename::Application::PAYMENTS_DAYS.day</code> </pre><br>  Important: lifetime should be in <b>iso8601</b> format. <br><br>  In our case, the payment time is week: <br><pre> <code class="ruby hljs">Codename::Application::PAYMENTS_DAYS.day = <span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre><br>  Other required parameters: <br><pre> <code class="ruby hljs">phone_number = <span class="hljs-string"><span class="hljs-string">'+79181234567'</span></span> amount = <span class="hljs-number"><span class="hljs-number">50</span></span></code> </pre><br>  Form the request body: <br><pre> <code class="ruby hljs">data = { <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'tel:'</span></span> + phone_number, <span class="hljs-symbol"><span class="hljs-symbol">amount:</span></span> amount, <span class="hljs-symbol"><span class="hljs-symbol">ccy:</span></span> <span class="hljs-string"><span class="hljs-string">'RUB'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">comment:</span></span> <span class="hljs-string"><span class="hljs-string">'User email: '</span></span> + current_user.email, <span class="hljs-symbol"><span class="hljs-symbol">lifetime:</span></span> life_time.iso8601, <span class="hljs-symbol"><span class="hljs-symbol">pay_source:</span></span> <span class="hljs-string"><span class="hljs-string">'qw'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">prv_name:</span></span> <span class="hljs-string"><span class="hljs-string">'Super Mortal Kombat Shop'</span></span> }</code> </pre><br>  Perform a transaction using the Rest Client gem: <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> result = RestClient.put url, data, headers <span class="hljs-keyword"><span class="hljs-keyword">rescue</span></span> =&gt; e payments_logger.info(<span class="hljs-string"><span class="hljs-string">'Creating bill failed! Email: '</span></span> + current_user.email + <span class="hljs-string"><span class="hljs-string">' Error: '</span></span> + e.message ) flash[<span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>] = <span class="hljs-string"><span class="hljs-string">'   . : '</span></span> + e.message redirect_to <span class="hljs-symbol"><span class="hljs-symbol">action:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:pay</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  That's all.  All major actions dismantled.  Now consider the additional and necessary to understand the full method of creating an account. <br><br>  Model Payment: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Payment</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">STATUSES</span></span></span><span class="hljs-class"> = [</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DEFAULT</span></span></span><span class="hljs-class"> = 0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PAID</span></span></span><span class="hljs-class"> = 1] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">belongs_to</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validates</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numericality</span></span></span><span class="hljs-class"> =&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">greater_than</span></span></span><span class="hljs-class">: 0 } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Table structure: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreatePayments</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Migration </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">change</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create_table</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payments</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">integer</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreign_key</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">float</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class"> =&gt; 0.0, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bill_id</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">limit</span></span></span><span class="hljs-class"> =&gt; 256, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">phone_number</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">limit</span></span></span><span class="hljs-class"> =&gt; 256, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">integer</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">limit</span></span></span><span class="hljs-class"> =&gt; 1, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class"> =&gt; 0, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timestamps</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  The complete code of the method in which an unpaid invoice is canceled, if the user has one. <br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_bill</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">require</span></span></span><span class="hljs-function"> '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rest</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">-</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">' </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">require</span></span></span><span class="hljs-function"> '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base64</span></span></span><span class="hljs-function">' </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">require</span></span></span><span class="hljs-function"> '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">securerandom</span></span></span><span class="hljs-function">' </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">user_creds</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Base64</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode64</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Codename::Application::APP_ID + </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">':'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> + Codename::Application::APP_PASSWORD)</span></span></span></span> headers = { <span class="hljs-symbol"><span class="hljs-symbol">:accept</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:json</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:authorization</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Basic '</span></span> + user_creds, <span class="hljs-symbol"><span class="hljs-symbol">:content_type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded; charset=utf-8'</span></span> } <span class="hljs-comment"><span class="hljs-comment"># Delete old bill, if current user have it bill = current_user.payments.where(status: Payment::DEFAULT).first if bill # Cancel bill url = "https://w.qiwi.com/api/v2/prv/" + Codename::Application::SHOP_ID + "/bills/" + bill.bill_id data = { status: 'rejected' } begin RestClient.patch url, data, headers bill.delete rescue =&gt; e payments_logger.info('Cancelling bill failed! Email: ' + current_user.email + ' Error: ' + e.message ) flash[:error] = '    .    . : ' + e.message redirect_to action: :pay return end end bill_id = current_user.email.split("@").first + '-' + SecureRandom.hex(5) payment = current_user.payments.new( amount: params[:amount], bill_id: bill_id, phone_number: params[:user_phone] ) # Validate data if payment.invalid? flash[:error] = ' ' redirect_to action: :pay return end url = "https://w.qiwi.com/api/v2/prv/" + Codename::Application::SHOP_ID + "/bills/" + payment.bill_id life_time = Time.now.utc + Codename::Application::PAYMENTS_DAYS.day data = { user: 'tel:' + payment.phone_number, amount: payment.amount, ccy: 'RUB', comment: 'User email: ' + current_user.email, lifetime: life_time.iso8601, pay_source: 'qw', prv_name: ' Super Mortal Kombat Shop' } # Start transaction begin result = RestClient.put url, data, headers rescue =&gt; e payments_logger.info('Creating bill failed! Email: ' + current_user.email + ' Error: ' + e.message ) flash[:error] = '   . : ' + e.message payment.delete redirect_to action: :pay return end result = JSON.parse(result) if result["response"]["result_code"] == 0 payment.save flash[:notice] = ' ' redirect_to action: :pay else payment.delete flash[:error] = '   .  : ' + result["response"]["result_code"] redirect_to action: :pay end end</span></span></code> </pre><br>  Explanations: <br><br>  To cancel the account, use the previously generated bill_id and patch request. <br><br>  After successful invoicing, you need to check the payment.  To do this, create a payment_grabber.rb model with the self.get_payments method, which will be called by the scheduler (for example, using the rufus-sheduler scheduler). <br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_payments</span></span></span><span class="hljs-function"> ... ... </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  We receive all unpaid invoices from the database and check them: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># Get all payments with default statuses bills = Payment.where(status: Payment::DEFAULT) bills.each do |bill| url = "https://w.qiwi.com/api/v2/prv/" + Codename::Application::SHOP_ID + "/bills/" + bill.bill_id begin bill_status = RestClient.get url, headers rescue =&gt; e grabber_logger.info('Check bill failed! Error: ' + e.message) next end bill_status = JSON.parse(bill_status) if bill_status["response"]["bill"]["status"] == 'paid' bill.update(status: Payment::PAID) user = User.find_by_id(bill.user_id) new_amount = user.money_real + bill.amount user.update_attribute(:money_real, new_amount) elsif bill_status["response"]["bill"]["status"] == 'waiting' next elsif bill_status["response"]["bill"]["status"] == 'expired' || bill_status["response"]["bill"]["status"] == 'unpaid' || bill_status["response"]["bill"]["status"] == 'rejected' bill.delete else next end</span></span></code> </pre><br>  Scheduler Code: <br><pre> <code class="ruby hljs">scheduler.every Codename::Application::GRABBER_INTERVAL <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> PaymentGrabber.get_payments <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Variables that are stored in application.rb <br><pre> <code class="ruby hljs">SHOP_ID = <span class="hljs-string"><span class="hljs-string">'111111'</span></span> APP_ID = <span class="hljs-string"><span class="hljs-string">'00000000'</span></span> APP_PASSWORD = <span class="hljs-string"><span class="hljs-string">'XXXXXXXXXXXX'</span></span> <span class="hljs-comment"><span class="hljs-comment"># Count days for payments PAYMENTS_DAYS = 7 # Grabber interval in minutes. How othen sheduler will check payments GRABBER_INTERVAL = '3m'</span></span></code> </pre><br>  This article will help Rails developers integrate Qiwi Shop into online stores.  At the time of this writing, examples of ready-made code on Ruby On Rails were not (not found) on the network, and in Qiwi ready-made solutions there was only a list of CMS. <br><br>  Thank you for your attention, that's all. </div><p>Source: <a href="https://habr.com/ru/post/265391/">https://habr.com/ru/post/265391/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265381/index.html">Webix + databoom = rapid application prototyping. Part 2</a></li>
<li><a href="../265383/index.html">To help the analyst: we write our automatic download of Yandex.Metrica reports using AWS for free</a></li>
<li><a href="../265385/index.html">Atlassian JIRA Service Desk: brief information and some tricks for usability (using sil-scripts and sql)</a></li>
<li><a href="../265387/index.html">Practice Mikrotik settings for dummies</a></li>
<li><a href="../265389/index.html">How to feed cats. Manual for programmers leading other programmers</a></li>
<li><a href="../265393/index.html">Why do routine work when it can be charged to a car?</a></li>
<li><a href="../265395/index.html">Development of browser online games on meteor</a></li>
<li><a href="../265397/index.html">RailsClub 2015: Interview with Sam Pippen</a></li>
<li><a href="../265399/index.html">Riak and Riak Search Yokozuna: First acquaintance</a></li>
<li><a href="../265401/index.html">Scaling up to 24 controllers in the new ETERNUS DX storage system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>