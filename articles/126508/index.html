<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transition from UFS to ZFS, dangerous operations with a ROOT partition</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today decided to consider an interesting question regarding the transition to ZFS. 
 To get started, let's look at what we have for the relevant exper...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transition from UFS to ZFS, dangerous operations with a ROOT partition</h1><div class="post__text post__text-html js-mediator-article">  Today decided to consider an interesting question regarding the transition to ZFS. <br>  To get started, let's look at what we have for the relevant experiment, there is a SunFire T2000 server, with 4 SAS disks. <br><br><img src="http://img546.imageshack.us/img546/6920/b8isowwkkgrhquokj0ezlep.jpg" alt="image"><br><a name="habracut"></a><br><br>  View available drives: <br><pre>  root @ T2000 # format
 Searching for disks ... done

 AVAILABLE DISK SELECTIONS:
        0. c0t0d0 &lt;SUN72G cyl 14087 alt 2 hd 24 sec 424&gt; main
           / pci @ 780 / pci @ 0 / pci @ 9 / scsi @ 0 / sd @ 0.0
        1. c0t1d0 &lt;SUN72G cyl 14087 alt 2 hd 24 sec 424&gt;
           / pci @ 780 / pci @ 0 / pci @ 9 / scsi @ 0 / sd @ 1.0
        2. c0t2d0 &lt;SUN72G cyl 14087 alt 2 hd 24 sec 424&gt; Filename
           / pci @ 780 / pci @ 0 / pci @ 9 / scsi @ 0 / sd @ 2.0
        3. c0t3d0 &lt;SUN72G cyl 14087 alt 2 hd 24 sec 424&gt;
           / pci @ 780 / pci @ 0 / pci @ 9 / scsi @ 0 / sd @ 3.0 </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The system is installed on the zero disk: <br><br><pre> root @ T2000 # uname -a
 SunOS T2000 5.10 Generic_142909-17 sun4v sparc SUNW, Sun-Fire-T200 </pre><br><br>  Patched to all Oracle standards using EIS-DVD. <br>  The ultimate goal is to get a working system on ZFS, with a mirror installed by zfs. <br>  We prepare our hard disks for migration of the root file system to them, in our case these are disks 2 and 3. We will do this with the help of the format utility: <br><br><pre>  format&gt; disk

 AVAILABLE DISK SELECTIONS:
        0. c0t0d0 &lt;SUN72G cyl 14087 alt 2 hd 24 sec 424&gt; main
           / pci @ 780 / pci @ 0 / pci @ 9 / scsi @ 0 / sd @ 0.0
        1. c0t1d0 &lt;SUN72G cyl 14087 alt 2 hd 24 sec 424&gt;
           / pci @ 780 / pci @ 0 / pci @ 9 / scsi @ 0 / sd @ 1.0
        2. c0t2d0 &lt;SUN72G cyl 14087 alt 2 hd 24 sec 424&gt; Filename
           / pci @ 780 / pci @ 0 / pci @ 9 / scsi @ 0 / sd @ 2.0
        3. c0t3d0 &lt;SUN72G cyl 14087 alt 2 hd 24 sec 424&gt;
           / pci @ 780 / pci @ 0 / pci @ 9 / scsi @ 0 / sd @ 3.0
 Specify disk (enter its number) [0]: 2
 selecting c0t2d0: filename
 [disk formatted]
 format&gt; p
 partition&gt; 0
 Part Tag Flag Cylinders Size Blocks
   0 unassigned wm 0 0 (0/0/0) 0
 Enter partition id tag [unassigned]: root
 Enter partition permission flags [wm]: 
 Enter new starting cyl [0]: 
 Enter partition size [28665792b, 2817c, 2816e, 13996.97mb, 13.67gb]: 7850c
 partition&gt; p </pre><br><br>  Let me explain why the size is 7850c, so that in the future it will allow without problems to copy there all the information from the existing root system, and sections relating to it. <br><br><pre>  partition&gt; label
 Ready to label disk, continue?  y
 partition&gt; name
 Enter table name (remember quotes): ZFS
 partition&gt; q
 format&gt; save
 Saving new disk and partition definitions
 Enter file name ["./ format.dat"]: </pre><br><br>  Exactly the same operation will be done for the disk number 3.  And we create our pool mirror from the slices we created on these two disks. <br><br><pre>  root @ T2000 # zpool create -f mainpool mirror c0t2d0s0 c0t3d0s0
 root @ T2000 # zpool list
 NAME SIZE ALLOC FREE CAP HEALTH ALTROOT
 mainpool 38G 1.69G 36.3G 4% ONLINE - </pre><br><br>  Next, create a bootable environment (BE).  There is a special command for this, which we will run with the keys we need: <br><br><pre>  root @ T2000 # lucreate -c ufsBE -n zfsBE -p mainpool
 Analyzing system configuration.
 Comparing source boot environment &lt;ufsBE&gt; file systems with the file 
 system (s) you specified for the new boot environment.  Determining which 
 file systems should not be in the new boot environment.
 Updating boot environment description database on all BEs.
 Updating system configuration files.
 The device &lt;/ dev / dsk / c0t2d0s0&gt; is not a device;  cannot get BE ID.
 Creating configuration for boot environment &lt;zfsBE&gt;.
 Source boot environment is &lt;ufsBE&gt;.
 Creating boot environment &lt;zfsBE&gt;.
 Creating file systems on boot environment &lt;zfsBE&gt;.
 Creating &lt;zfs&gt; file system for &lt;/&gt; in zone &lt;global&gt; on &lt;mainpool / ROOT / zfsBE&gt;.
 Populating file systems on boot environment &lt;zfsBE&gt;.
 Checking selection integrity.
 Integrity check OK.
 Populating contents of mount point &lt;/&gt;.
 Copying.
 Creating shared file system mount points.
 Creating databases for boot environment &lt;zfsBE&gt;.
 Creating compare database for file system &lt;/ var&gt;.
 Creating compare database for file system &lt;/&gt;.
 Updating compare databases on boot environment &lt;zfsBE&gt;.
 Making boot environment &lt;zfsBE&gt; bootable.
 Creating boot_archive for /.alt.tmp.b-tDb.mnt
 updating /.alt.tmp.b-tDb.mnt/platform/sun4v/boot_archive
 Population of boot environment &lt;zfsBE&gt; successful.
 Creation of boot environment &lt;zfsBE&gt; successful. </pre><br><br>  Check out what we did. <br><br><pre>  root @ T2000 # lustatus
 Boot Environment Is Active Active Can Copy      
 Name Complete Now On Reboot Delete Status    
 -------------------------- -------- ------ --------- - ----- ----------
 ufsBE yes yes yes no -         
 zfsBE yes no no yes - </pre><br><br>  Having observed that everything went well, we can activate the new zfsBE boot environment. <br><br><pre>  root @ T2000 # luactivate zfsBE
 A Live Upgrade Sync &lt;zfsBE&gt;.


 ************************************************** ********************

 The target boot environment has been activated.  It will be used when you 
 reboot.  NOTE: You must NOT use the reboot, halt, or uadmin commands.  You 
 MUST USE either the init or the shutdown command when you reboot.  If you 
 the system will not boot up using the 
 target BE.

 ************************************************** ********************

 In case of a failure 
 needs to be followed fallback to the currently working boot environment:

 1. Enter the PROM monitor (ok prompt).

 2. Change the boot device back to original boot environment by typing:

      setenv boot-device disk: a

 3. Boot to original boot environment by typing:

      boot

 ************************************************** ********************

 Modifying boot archive service
 Activation of boot environment &lt;zfsBE&gt; successful. </pre><br><br>  This message tells us that don‚Äôt worry, if something goes wrong, you still have the opportunity to boot from an old source.  Well, of course we try, reboot: <br><br>  root @ T2000 # init 6 <br><br>  And after we booted we check our system for the correct boot. <br><br><pre>  root @ T2000 # lustatus
 Boot Environment Is Active Active Can Copy      
 Name Complete Now On Reboot Delete Status    
 -------------------------- -------- ------ --------- - ----- ----------
 ufsBE yes no no yes -         
 zfsBE yes yes yes no - </pre><br><br>  Here we see that at the moment the main boot environment is zfsBE, just created by us.  Now we can safely remove ufsBE. <br>  As a result, we got a system that has all the charms of the ZFS system without any problems and with minimal downtime. <br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/126508/">https://habr.com/ru/post/126508/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126500/index.html">A group of 27,612 South Koreans sued Apple</a></li>
<li><a href="../126501/index.html">C ++: Leash Pattern</a></li>
<li><a href="../126503/index.html">Important nuances of "computer help"</a></li>
<li><a href="../126504/index.html">Oatmeal - Why I believe all printers are from hell</a></li>
<li><a href="../126506/index.html">Avatar for car computer</a></li>
<li><a href="../126509/index.html">Opening Offshore Bank Accounts with Payweb.com</a></li>
<li><a href="../126510/index.html">TeamWox SaaS Agent: how to build SaaS farms for free and quickly</a></li>
<li><a href="../126511/index.html">The main direction of your work as a programmer.</a></li>
<li><a href="../126513/index.html">Changes in accounting for Google Analytics sessions</a></li>
<li><a href="../126514/index.html">Facebook TOS (terms of service) in human English</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>