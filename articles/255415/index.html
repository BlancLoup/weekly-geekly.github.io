<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are switching from STM32 to the Russian K1986BE92QI microcontroller. System Timer (SysTick)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In the previous article we blinked the LED, but did not quite correctly. The fact is that as a delay, we used an empty cycle, which we ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are switching from STM32 to the Russian K1986BE92QI microcontroller. System Timer (SysTick)</h1><div class="post__text post__text-html js-mediator-article"><h5>  Introduction </h5><br>  <a href="http://habrahabr.ru/post/255323/">In the previous article</a> we blinked the LED, but did not quite correctly.  The fact is that as a delay, we used an empty cycle, which we have to select for each time interval.  This method is also not suitable when we need accurate time intervals.  To solve this problem, our microcontroller has three full-timers and one system timer at once.  For a start, let's set a small subtask.  We need to get a flashing LED at one second intervals.  The task is very simple and for this we have enough of the system timer.  Because of its lightness, it is ideal for this type of task.  Consider it in more detail. <br><a name="habracut"></a><br><h5>  Learning and tuning </h5><br>  Let's see what is written about this timer in the documentation. <br><blockquote>  The processor has a 24-bit system timer, SysTick, which counts down from the value loaded into it to zero;  the reset (return to the beginning) of the value in the LOAD register occurs on the next edge of the clock signal, then the count continues on the subsequent front. <br>  When the processor is stopped for debugging, the timer is not decremented. </blockquote><br>  Not a lot, but we have enough.  It's time to set it up.  Take a look at the register map. <br><br><img src="https://habrastorage.org/files/0d5/68c/8d9/0d568c8d985c4f4eb6d716eac57c451a.JPG"><br><br>  Only four registers, but we need only two of them.  Consider them in more detail. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/572/302/ad8/572302ad89e64211add80d93abf0d20c.JPG"><br><br>  This is the main register setting.  As we can see, we need to select the clock source, enable interrupts and turn on the counter.  We will clock the timer from HCLK.  By default, this source has a clocking frequency of the core, that is, 8 MHz.  We will need interrupts to create our own exact delay function.  In view of the fact that I could not find the register bits, I decided to register them myself. <br><br><img src="https://habrastorage.org/files/a1c/01e/41e/a1c01e41e95841c2912af05dbb1b3927.JPG"><br><br>  We create a separate function for setting the timer and enter our design into it. <br><br>  <b>void Init_SysTick (void)</b> <b><br></b>  <b>{</b> <b><br></b>  <b>SysTick-&gt; CTRL | = CLKSOURCE | TCKINT | ENABLE;</b> <b><br></b>  <b>}</b> <br>  We look at the following register: <br><br><img src="https://habrastorage.org/files/042/106/95d/04210695db084a61b72149992437761c.JPG"><br><br>  This is where we need to load the delay value.  To make our function more universal, we set the timer to interrupt once every one millisecond.  We set up our clocking timer from HCLK - this is the clocking frequency of the microcontroller core.  By default, it is equal to 8 MHz = 8000000 cycles per second.  In one second, one thousand milliseconds =&gt; 8000000 (number of ticks per second) / 1000 (number of milliseconds per second) = the number of ticks in one millisecond.  But you need to remember to subtract "1", as described in the example above.  It turns out the following. <br><br>  <b>SysTick-&gt; LOAD = (8000000/1000) -1;</b> <br><br>  I think that this setting will be better placed before turning on the timer. <br><br>  Total, our function takes the following form. <br><img src="https://habrastorage.org/files/63e/9d4/ae8/63e9d4ae82b444709bba5193600c59ba.PNG"><br><br><h5>  We write the delay function. </h5><br>  We set up our timer to show interrupts, but never mentioned anywhere what will happen when this interrupt appears.  To do this, go to the startup file. <br><img src="https://habrastorage.org/files/548/ec0/72e/548ec072e0c842739045cff432680805.PNG"><br><br>  Slightly scrolling down, we can see a long column. <br><img src="https://habrastorage.org/files/8c6/2c8/647/8c62c864730b4eee93fb9776ae96c596.PNG"><br><br>  These are called interrupt vectors.  When some external / internal urgent event (interrupt) appears, the microcontroller interrupts the execution of the main program, goes to this table and looks where it needs to go further.  For example, when an interrupt from our timer appears, it goes to the item named ‚ÄúSysTick_Handler‚Äù.  If the vector is not registered by us in the program (there is no function with that name) - the controller ignores it and continues the execution of its program.  But if the program has a function with this name, then it proceeds to its execution. <br><br>  Create a function in the main folder named SysTick_Handler.  Next, we declare a global variable of 32 bits width.  In order for the project to ‚Äúcompress‚Äù it does not touch the compiler, we add ‚Äúvolatile‚Äù in front of it.  If this is not done, then in the future we will observe various errors.  In the function itself, we write a condition: if the variable is not yet zero, subtract 1. <br><br>  Thus, every millisecond the controller will drop the main program and check if the meter is still not empty - take 1 away from it. <br><br>  Now you need to write the delay function itself, which will use this interrupt. <br><img src="https://habrastorage.org/files/d8c/5bd/2ad/d8c5bd2ad988423f8884fe8fbc37c5dd.PNG"><br><br>  This function takes the delay time (in milliseconds), copies it to a variable, from which the function takes 1 every millisecond from interrupts of the system timer.  After the delay is exhausted, the program continues its work.  This delay is not the best way to spend CPU time.  But in the initial stages it is enough. <br><br>  Now it's up to you.  Replace cycles with our delays. <br><img src="https://habrastorage.org/files/86c/d24/2f3/86cd242f39d541898aa97a8a5efe9818.PNG"><br><br>  On this with a system timer for now.  Source of the project can be found <a href="">here</a> . <br>  Understanding the system timer, I was based on the knowledge gained from studying STM32 from <a href="http://www.youtube.com/watch%3Fv%3DBd8YxrMES70%26list%3DPL8OgDYWys_b6XtOjCejd37aVv0ic24jqV%26index%3D4">this video tutorial</a> . <br><div class="spoiler">  <b class="spoiler_title">List of previous articles.</b> <div class="spoiler_text">  1. <a href="http://habrahabr.ru/post/255199/">We turn from STM32F103 to K1986BE92QI.</a>  <a href="http://habrahabr.ru/post/255199/">Or the first acquaintance with the Russian microcontroller.</a> <br>  2. <a href="http://habrahabr.ru/post/255323/">We are switching from STM32 to the Russian K1986BE92QI microcontroller.</a>  <a href="http://habrahabr.ru/post/255323/">Setup project in keil and flashing LED.</a> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/255415/">https://habr.com/ru/post/255415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255405/index.html">ThinkServer RD650: Anatomy of a New Generation Server from Lenovo</a></li>
<li><a href="../255407/index.html">Real-world tasks: how in practice do systems consider reliability (reliability, MTTF, failure rate)?</a></li>
<li><a href="../255409/index.html">Backup and Restore Virtualized Microsoft Exchange Using Veeam Backup & Replication</a></li>
<li><a href="../255411/index.html">Overview of wireless Wi-Fi camera Oco for office and home</a></li>
<li><a href="../255413/index.html">GitHub announces storage for large files (LFS)</a></li>
<li><a href="../255417/index.html">Research android virus</a></li>
<li><a href="../255419/index.html">Configuring volume replication in Windows Server vNext</a></li>
<li><a href="../255423/index.html">Motion Blur Effect with SVG</a></li>
<li><a href="../255425/index.html">PODAM Java Objects for Unit Testing</a></li>
<li><a href="../255427/index.html">Features of working with virtual disks VirtualBox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>