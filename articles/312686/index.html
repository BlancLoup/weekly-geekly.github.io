<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse Engineering "Kazakov", part three: thimbles in the LAN</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the courtyard of the end of 2016, finally, having caused a storm of delight among fans, the third part of ‚ÄúCossacks‚Äù came out ... And I still had n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse Engineering "Kazakov", part three: thimbles in the LAN</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/20c/b3a/4cc/20cb3a4cca2d468da7ed47e8674cec57.png"></div><br>  In the courtyard of the end of 2016, finally, <s>having caused a storm of delight among fans,</s> the third part of ‚ÄúCossacks‚Äù came out ... And I still had no rest a strange mistake in the network component of the first part.  The oddity was that when creating a game on a local network, only two people could start the game normally.  With three players, the download indicator grew painfully slowly, and starting from four, it remained at 0%.  Well, let's start the investigation! <a name="habracut"></a><br><br><h3>  Error </h3><br>  The symptoms of the problem are several.  The ‚Äúmax ping‚Äù value that is displayed in the game room is too high and grows in proportion to the number of players.  Although all players are connected to the same switch and the usual icmp ping gives consistently less than 1 ms, delays of up to 350 ms are displayed in the game room.  If there are only two players in the room, then ‚Äúmax ping‚Äù is first ~ 90 ms, then drops by seconds to ~ 10 ms. <br><br>  The second symptom is the display of the warning ‚Äúno direct connection established with: <i>player name</i> ‚Äù.  The three of us get a chance to get it somewhere around 50%, and if there are four players in a room, then it is shown constantly.  Although this warning can be ignored by holding down the Ctrl key while clicking on ‚ÄúStart‚Äù, this indicates a certain ‚Äúproblem of perception‚Äù of the quality of the connection from the side of the game. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The third symptom is a slow download speed.  When all the players clicked "Start", the game host displays a percentage indicator.  It increases in steps of ~ 8%, reaches 100%, and only after that you can start the game.  Considering that this indicator primarily displays the progress of transferring a file of a randomly created card from the host to the players, and the size of this file for a regular card is approximately 3.5 MB, then even 5 seconds of loading on a gigabit local network is a problem.  And in the time it takes to ‚Äúload‚Äù three players, you can copy the entire game folder. <br><br><h3>  Starting from the end </h3><br>  With your permission, I will spare you the details of the beginning of this reverse and the problems that have arisen.  I can only say that I was wrong in thinking that it would be fun to disassemble the network component.  Calling functions through pointers.  Multithreading  Working with sendto () and recvfrom () at the same time using DirectPlay.  The absence of any intelligible documentation for this dinosaur, not to mention debug information.  My kung fu here was clearly not enough. <br><br>  So we will work in the old manner.  We open everyone's favorite, the <abbr title="IDA Pro">most beautiful program</abbr> , press Alt + T and look for "no direct connection".  We find the region of memory containing the string, then through <abbr title="Cross References (caused by the X key)">xref we</abbr> exit directly to the pointer, and then to the volume function of 32 kilobytes.  Among other things, it initializes the elements of the game room interface, processes the messages and arranges the lines before they are displayed on the screen.  Let's call it LanLobby ().  Below you can see the algorithm for deciding whether to show a warning to a player and whether to deactivate the "Start" key: <br><br>  <sub><strong>Note: The</strong> disassembler listings shown in the article were processed to improve readability.</sub> <br><br><img src="https://habrastorage.org/files/1ff/625/7ce/1ff6257ce85a4545839a452064c8531a.png" align="left"><ol><li>  Called a small function-loop SomeI changing ().  Looking ahead, I will say that there is a call to a similar function in her body, let's call it ImportantIteration ().  If the latter returns zero at least once, then SomeIteration () immediately leaves the loop and also returns zero.  In this case, the transition is not made and we risk receiving a warning. <br><br></li><li>  Next, check the state of the Ctrl button.  If it is clamped, the ‚ÄúStart‚Äù button will not be disabled. <br><br></li><li>  Deactivating the "Start" button.  The variable hStartButton is initialized above the result of the function with the talking name "addVideoButton". <br><br></li><li>  The timer is checked against the passage of two seconds.  Above the PreviousTick variable is assigned the current value of GetTickCount () each time the number of players in a room changes.  If less than two seconds have passed since then, a transition is made and a warning is not displayed. <br><br></li><li>  In the end, the warning line is copied to the line to be displayed on the screen as the status bar of the game room. </li></ol><br clear="all"><br>  <strong>Conclusion:</strong> After taking the player into the room, the game gives itself two seconds to establish the connection.  Then, if the ImportantIteration () still returns zero, a warning of the absence of a direct connection is displayed. <br><br><h3>  Stumbling block </h3><br>  At this stage of the reverse, it was not clear to me what was happening in ImportantIteration () and I decided to find the layout of the load indicator line and continue to work from there.  Earlier, in a vain attempt to analyze the max ping calculation algorithm, I noticed that all lines with numeric variables are first compiled via sprintf (), and then placed on the target line.  Given the syntax of the format string, we look for the text ‚Äú%%‚Äù and find a match in our LanLobby ().  This is the code snippet that decides whether to show a number in percent in the load indicator field or a tick signaling the ‚Äúreadiness‚Äù of the game: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ddf/b8c/f37/ddfb8cf3761f4209a1414cc9734d4887.png"></div><br>  It turns out that the result of the function GetLoadPercentage (), if it is less than 100, one to one is transferred to the screen.  The second branch must be drawing a tick.  I wonder what is calculated in this function?  GetLoadPercentage () consists of a loop that goes through an array of player data and ... oops! <br><br><img src="https://habrastorage.org/files/634/4f9/0a6/6344f90a6d064561a4594e363592b247.png" align="left">  And here the ImportantIteration () solves the issue.  Yes, we were not mistaken with the name.  Considering arithmetic, ImportantIteration () returns the player‚Äôs loading status in the range from 0x00 to 0x0C, that is, on this ‚Äúscale‚Äù there are only 12 steps.  Now it is clear why the percentage indicator increases in steps of ~ 8%. <br><br>  Now that we understand what ImportantItration () should do, let's see where it is still used. <br clear="all"><br>  In addition to the known calls for checking the quality of the connection and calculating the percentages, ImportantIteration () is called in two cases: when formulating a warning about a bad connection ‚Äî there it is used to make a list of players for the status bar ‚Äî and to check if all players are ready.  The latter is carried out in a function with a small cycle that runs through all the players and compares the load level with 0x0C.  If even one player has less, then the cycle returns zero.  We can safely assume that the result of the last function directly affects the activation of the ‚ÄúStart‚Äù button on the host and the ability to start the game. <br><br><h3>  Decision </h3><br>  So, the simplest solution is to make corrections to the logic, depending on the result of ImportantIteration ().  Fortunately, in all cases, transitions are carried out with a positive result, that is, we only need to change all transitions from conditional to unconditional.  In the case of the so-called "Windows 7 version" of the dmcr.exe file, the entire patch can be described as follows: <br><br><pre><code class="markdown hljs"> |  |  |  ---------+-----------+-----------+----------------------------- 0x00CEEA | 0x7D | 0xEB |      0x098792 | 0x0F 0x8D | 0x90 0xE9 |     100% 0x09C389 | 0x0F 0x85 | 0x90 0xE9 |   </code> </pre> <br>  And since all changes relate only to the logic of the game room for games on the local network, and the network message itself takes place in parallel and does not depend on it, there is no need to fear any side effects.  The file of a randomly created card is distributed over the network almost instantly, and the room allows you to start the game without any delay.  Here you can wash your hands, but ... <br><br><h3>  What is in the box? </h3><br>  After all, it is curious how the game room determines the status of loading players.  Meet the ImportantIteration (), the hero of today's article: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c9e/26c/5e8/c9e26c5e88cd458aa6c203d7c4e2078e.png"></div><br>  Here you can notice a few interesting things: <br><br><ul><li>  One of the two parameters is passed through the ecx register. </li><li>  All the necessary data is in memory next to each other, so why do we need to store their addresses?  Instead of pointers Pointer_A and Pointer_B, we will have Pointer_A and (Pointer_A + 4). </li><li>  The memory region pointed to by the PlayersDataStruct pointer parameter is written in parallel streams and does not depend on what happens in LanLobby (). </li></ul><br>  When trying to understand what is happening in the specified region of memory, something similar to an array of structures was discovered.  Each element has a size of 0x84 bytes, and inside it stores among other things the player's name, the name of the random map file used, the version of the client of the game, the value of the ping, several variables of Boolean type, as well as several integer values ‚Äã‚Äãand / or pointers.  All attempts to track records in this region run into memcpy () calls from other threads, and it is quite difficult to statically analyze it - xref gives 82 82 references, and except for initialization with the value 0x12345678, all of them are readable.  Those.  the address of the structure is loaded into registers, calculations of the address of the desired element are carried out, and only after this reading, writing, calling other functions with a pointer as a variable, or all of the above listed immediately. <br><br>  In the end, I just put the tracking on the record in a certain part of this structure, and in the body of ImportantIteration () I added several conditional breakpoints.  I turned off the debugger itself, and indicated a small <abbr title="Built-in IDA Pro C-like language">IDC</abbr> function as a condition that displays the contents of the register in the message window: <br><br><pre> <code class="markdown hljs">Message("EDX: %08X\n", EDX), 0</code> </pre><br>  After that, I started the game and connected to a host on the local network for a few seconds.  Then I stopped the debugger and, after reviewing the tracking results and the contents of the message window (‚ÄúTrace window‚Äù and ‚ÄúOutput window‚Äù), I came to the following conclusion: <br><br>  The region of memory, from which data is extracted, among other things, and ImportantIteration (), is constantly changing.  However, some values ‚Äã‚Äãare first reset before recording new data.  Probably somewhere in the processing of network messages before storing new information, this region of memory is first reinitialized.  And since we have DirectPlay and multithreading, these zeros may well be there just during the execution of our cycle, which leads to the behavior described at the beginning of the article. <br><br><h3>  Afterword </h3><br>  So, what moral can be learned from this fable?  <s>You do not need to be a Yakuza to call in to the Yakuza.</s> It is not always necessary to dig out the roots of a problem in order to solve it.  By the way, in the process of reversing, a piece of code responsible for ‚Äúauto-losing‚Äù when the game was minimized for more than a couple of seconds caught my eye.  So now you can safely change the music during the game.  True, I'm not sure about the benefits of such a patch for the gaming community, as it may facilitate the manipulation of the game using third-party programs. <br><br>  Finally I would like to return to the issue of timing of the game, raised in the <a href="https://habrahabr.ru/post/277067/">first article</a> .  Then I did not fully understand the role of the functions QueryPerformanceFrequency () and QueryPerformanceCounter ().  As Andrei <a href="https://habrahabr.ru/users/smi1e/" class="user_link">Smi1e</a> correctly <a href="https://habrahabr.ru/post/277067/">noted</a> , it did not seem to influence timing.  Now I can say for sure that these functions are used in the game room of the first "Kazaks" as a pseudo-random number generator to create a random map file and / or the name of this file, and the game itself is timed exclusively via GetTickCount (). <br><br>  That's all, see you soon! <br><br><h3>  Links </h3><br><ul><li>  <a href="http://gafferongames.com/networking-for-game-programmers/">Several articles about the device of network games (eng.)</a> </li><li>  <abbr title="The most common words: warning, deprecated, obsolete"><a href="https://msdn.microsoft.com/de-de/library/windows/desktop/ms805688.aspx">Official DirectPlay Documentation on MSDN (English)</a></abbr> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/312686/">https://habr.com/ru/post/312686/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312672/index.html">As an Android developer, time management got carried away, and what came of it</a></li>
<li><a href="../312674/index.html">Python-crib. Part 1 - Language and Object Types</a></li>
<li><a href="../312676/index.html">1990 Great Hacker War</a></li>
<li><a href="../312680/index.html">Scrum from a military pilot: The art of doing twice the work twice as fast</a></li>
<li><a href="../312684/index.html">As we came up with and made our first game on Android. Part 1: Game Mechanics</a></li>
<li><a href="../312694/index.html">Women and murder: is there a relationship here? [part 2 of 2]</a></li>
<li><a href="../312696/index.html">Let's write a small but very useful plugin for Wordpress 4.6. *?</a></li>
<li><a href="../312698/index.html">IoT security issues: the researcher discovered serious vulnerabilities in MatrixSSL</a></li>
<li><a href="../312700/index.html">Security Week 41: patch week, 12-year-old vulnerability in sshd returns, StrongPity APT</a></li>
<li><a href="../312702/index.html">Councils of Western consulting companies. Part 1, theoretical</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>