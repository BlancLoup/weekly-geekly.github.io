<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We continue to check Microsoft projects: PowerShell analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For Microsoft, it has recently become a ‚Äúgood tradition‚Äù to open the source codes of their software products. Here you can remember about CoreFX, .Net...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We continue to check Microsoft projects: PowerShell analysis</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/7b0/875/2b0/7b08752b0c6944a69b8b997e226428e4.png"></div><br>  For Microsoft, it has recently become a ‚Äúgood tradition‚Äù to open the source codes of their software products.  Here you can remember about CoreFX, .Net Compiler Platform (Roslyn), Code Contracts, MSBuild and other projects.  For us, the developers of the PVS-Studio static analyzer, this is an opportunity to check known projects, tell people (and developers including) about errors found and test the analyzer.  Today we will talk about errors found in another Microsoft project - PowerShell. <br><a name="habracut"></a><br><h2>  Powershell </h2><br>  PowerShell is a Microsoft cross-platform project consisting of a shell with a command line interface and a related scripting language.  Windows PowerShell is built on the Microsoft <a href="https://ru.wikipedia.org/wiki/.NET_Framework">.NET Framework</a> and integrated with it.  Additionally, PowerShell provides convenient access to <a href="https://ru.wikipedia.org/wiki/Component_Object_Model">COM</a> , <a href="https://ru.wikipedia.org/wiki/WMI">WMI,</a> and <a href="https://ru.wikipedia.org/wiki/ADSI">ADSI</a> , as well as allowing you to perform normal command line commands to create a unified environment in which administrators can perform various tasks on local and remote systems. <br><br>  The project code is available for download from the <a href="https://github.com/PowerShell/PowerShell">repository on GitHub</a> . <br><br><h2>  PVS-Studio </h2><br>  According to the statistics of the project repository, approximately 93% of the code is written using the C # programming language. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p></p><div style="text-align:center;"><img src="https://habrastorage.org/files/2af/d49/6e2/2afd496e24d445f4b2c86f1a8d134092.png"></div><p></p><br><br>  The PVS-Studio static code analyzer was used for the verification.  A version was being developed.  That is, it is no longer PVS-Studio 6.08, but also not PVS-Studio 6.09.  Such an approach allows a wider approach to testing the most recent version of the analyzer, and, if possible, correct the defects found.  Of course, this does not negate the use of a multi-level test system (see the seven testing methods in the <a href="http://www.viva64.com/ru/b/0415/">article</a> on the development of the Linux version), but is another way to test the analyzer. <br><br>  The current version of the analyzer can be <a href="http://www.viva64.com/ru/pvs-studio-download/">downloaded here</a> . <br><br><h2>  Preparation for analysis </h2><br>  The analyzer has been updated, the project code has been loaded.  But sometimes difficulties may arise in the process of preparing a project for analysis - at the stage of its assembly.  Before checking it is desirable to assemble a project.  Why is it important?  So the analyzer will be available more information, therefore, it becomes possible to conduct a more in-depth analysis. <br><br>  The most familiar (and convenient) way to use the analyzer is to test a project from the Visual Studio development environment.  It is fast, easy and convenient.  But then an unpleasant nuance surfaced. <br><br>  As it turned out, the developers themselves do not recommend using the Visual Studio development environment for building the project, which they directly write on GitHub about: ‚ÄúWe would not recommend building the PowerShell solution from Visual Studio.‚Äù <br><br>  But the temptation of assembling through Visual Studio and checking out from under it was too great, so I decided to try.  The result is shown in the figure below: <br><br><p><img src="https://habrastorage.org/files/5ee/484/409/5ee484409abf4e499af0336d345bc4ac.png"></p><br>  <font color="#999999"><i>Figure 1. Compile project errors using Visual Studio.</i></font> <br><br>  Unpleasant  What did it mean to me?  The fact that just because all the possibilities of the analyzer on the project will not be able to reveal.  There are several possible scenarios. <br><br>  <b>Scenario 1. Checking an unassembled project.</b> <br><br>  We tried to build a project.  Not going?  Well, okay, check it out. <br><br>  What are the advantages of this approach?  No need to bother with the assembly, figuring out what is the problem, how to solve it, or how to dodge and check the assembled project.  This saves time, and besides, there are no guarantees that, after being taken long enough, the project will still be able to be collected, and then time will be wasted. <br><br>  The disadvantages of this solution are also obvious.  Firstly, it is an inadequate analysis.  Some errors will slip away from the analyzer.  Perhaps there will be a certain number of false positives.  Secondly, in this case it makes no sense to give the statistics of false / positive positives, since it can change in any way on the assembled project. <br><br>  However, even with this scenario, you can find enough errors and write about this article. <br><br>  <b>Scenario 2. Deal and assemble the project.</b> <br><br>  The pros and cons are opposite to those described above.  Yes, you have to spend more time on assembly, but it‚Äôs not a fact that the desired result will be achieved.  But if successful, you will be able to check the source code more thoroughly and, perhaps, find some more interesting errors. <br><br>  Unambiguous advice on how to proceed is not here, everyone decides for himself. <br><br>  Having suffered from the assembly, I still decided to check the project 'as is'.  For writing an article this option is quite acceptable. <br><br>  <b>Note.</b>  Despite the fact that the project is not going out from under Visual Studio, it is quite calmly going through a script ( <i>build.sh</i> ), which lies at the root. <br><br>  <b>Note 2.</b> One of the developers (thanks a lot to him for this) suggested that the * .sln-file is necessary for ease of operation, but not for assembly.  This is another argument in favor of the correct choice of the analysis scenario. <br><br><h2>  Analysis results </h2><br>  <b>Duplicate Subexpressions</b> <br><br>  Projects in which the warning <a href="http://www.viva64.com/ru/d/0381/">V3001</a> does not find suspicious places should be issued medals.  PowerShell, alas, in this case would have remained without a medal and that is why: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> Version BaseMinimumVersion { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> Version BaseMaximumVersion { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessRecord</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (BaseMaximumVersion != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; BaseMaximumVersion != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; BaseMaximumVersion &lt; BaseMinimumVersion) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> message = StringUtil.Format( Modules.MinimumVersionAndMaximumVersionInvalidRange, BaseMinimumVersion, BaseMaximumVersion); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PSArgumentOutOfRangeException(message); } .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0381/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0381/">V3001</a> There are identical Sub-expressions 'BaseMaximumVersion! = Null' operator.  System.Management.Automation ImportModuleCommand.cs 1663 <br><br>  <a href="http://bit.ly/2fmjpLA">Link to GitHub code</a> . <br><br>  As you can see from the code snippet, the <i>BaseMaximumVersion</i> reference was checked twice for the <i>null</i> inequality, although it was clear that the <i>BaseMinimumVersion</i> reference had to be checked <i>instead</i> .  Due to a successful set of circumstances, this error may not manifest itself for a long time.  However, when the error manifests itself, the <i>BaseMinimumVersion</i> information <i>will</i> not be <i>included</i> in the message text used in the exception, since the <i>BaseMinimumVersion</i> reference will be <i>null</i> .  As a result, we will lose some useful information. <br><br>  I want to note that when writing an article I corrected the code formatting, so it became easier to notice the error.  In the project code, the entire condition is written in one line.  This is another reminder of how important good code design is.  It not only facilitates the reading and understanding of the code, but also helps to notice errors faster. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RemoteDataNameStrings</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> MinRunspaces = <span class="hljs-string"><span class="hljs-string">"MinRunspaces"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> MaxRunspaces = <span class="hljs-string"><span class="hljs-string">"MaxRunspaces"</span></span>; .... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExecuteConnect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( connectRunspacePoolObject.Data .Properties[RemoteDataNameStrings.MinRunspaces] != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; connectRunspacePoolObject.Data .Properties[RemoteDataNameStrings.MinRunspaces] != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { clientRequestedMinRunspaces = RemotingDecoder.GetMinRunspaces( connectRunspacePoolObject.Data); clientRequestedMaxRunspaces = RemotingDecoder.GetMaxRunspaces( connectRunspacePoolObject.Data); clientRequestedRunspaceCount = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } .... } .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0381/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0381/">V3001</a> operator.  System.Management.Automation serverremotesession.cs 633 <br><br>  <a href="http://bit.ly/2fmnq2J">Link to GitHub code</a> . <br><br>  Due to a typo, the same test was again performed twice.  Most likely, in the second case, the <i>MaxRunspaces</i> constant field of the static class <i>RemoteDataNameStrings</i> should have been used. <br><br>  <b>Unused value returned by method</b> <br><br>  There are errors characteristic of the fact that the return value of the method is not used.  The causes, as well as the consequences, can be very different.  Sometimes a programmer forgets that <i>String</i> type objects are immutable, and string editing methods return a new sink as a result, rather than changing the current one.  A similar case is the use of LINQ, when the result of the operation is a new collection.  Similar errors met here. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> CatchClauseAst </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CatchBlockRule</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">.... </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> List&lt;TypeConstraintAst&gt; errorAsts</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorAsts == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { errorAsts = exceptionTypes; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { errorAsts.Concat(exceptionTypes); <span class="hljs-comment"><span class="hljs-comment">// &lt;= } .... }</span></span></code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0406/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0406/">V3010</a> The return value of the function 'Concat' is required to be utilized.  System.Management.Automation Parser.cs 4973 <br><br>  <a href="http://bit.ly/2fmm0p3">Link to GitHub code</a> . <br><br>  Immediately I want to draw attention to the fact that the <i>errorAsts</i> parameter <i>is</i> used with the <i>ref</i> keyword, which implies changing the link in the method body.  The code logic is simple - if the <i>errorAsts</i> reference is null, then we assign it a link to another collection, otherwise we add the elements of the <i>exceptionTypes</i> collection to the existing one.  True, with the second part came the pad.  The <i>Concat</i> method returns a new collection without modifying the existing one.  Thus, the <i>errorAsts</i> collection will remain unchanged, and the new one (containing the <i>errorAsts</i> and <i>exceptionTypes</i> elements) will be ignored. <br><br>  The problem can be solved in several ways: <br><br><ul><li>  Use the <i>List</i> class's <i>AddRange</i> method, which will add new items to the current list; </li><li>  Use the result of the <i>Concat</i> method, without forgetting to call the <i>ToList</i> method, to bring it to the desired type. </li></ul><br>  <b>Checking the wrong link after casting using the</b> <b><i>as</i></b> <b>operator</b> <br><br>  Gold Medal Diagnostic Rule <a href="http://www.viva64.com/ru/d/0388/">V3019</a> !  Surely I will not say, but almost in all C # projects, on which I wrote articles, this error was encountered.  Regular readers should already learn by heart about the need to carefully recheck whether you are checking the link for <i>null</i> equality after casting with the <i>as</i> operator. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> List&lt;Job&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetJobsForComputer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String computerName</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Job j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ChildJobs) { PSRemotingChildJob child = j <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> PSRemotingChildJob; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (j == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.Equals(child.Runspace .ConnectionInfo .ComputerName, computerName, StringComparison.OrdinalIgnoreCase)) { returnJobList.Add(child); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> returnJobList; }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0388/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0388/">V3019</a> Possibly an incorrect variable is compared to null after type conversion using 'as' keyword.  Check variables 'j', 'child'.  System.Management.Automation Job.cs 1876 <br><br>  <a href="http://bit.ly/2dOfN4O">Link to GitHub code</a> . <br><br>  The result of casting <i>j</i> to type <i>PSRemotingChildJob is</i> written to the <i>child</i> reference, which means that the value <i>null</i> can be written there (if the initial reference is <i>null</i> or if the casting could not be performed).  However, the initial reference, <i>j</i> , is checked below for the <i>null</i> inequality, and the appeal to the <i>Runspace</i> property of the <i>child</i> object goes even lower.  Thus, if <i>j! = Null</i> , and <i>child == null</i> , checking <i>j == null</i> will not help, and an exception of the type <i>NullReferenceException</i> will be generated when accessing the member members of the derived reference. <br><br>  Two more similar places met: <br><br><ul><li>  V3019 Possibly incorrectly variable conversion compared to null after type conversion using 'as' keyword.  Check variables 'j', 'child'.  System.Management.Automation Job.cs 1900 </li><li>  V3019 Possibly incorrectly variable conversion compared to null after type conversion using 'as' keyword.  Check variables 'j', 'child'.  System.Management.Automation Job.cs 1923 </li></ul><br>  <b>Invalid order of operations</b> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyFileFromRemoteSession</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... ArrayList remoteFileStreams = GetRemoteSourceAlternateStreams(ps, sourceFileFullName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((remoteFileStreams.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; (remoteFileStreams != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0414/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0414/">V3027</a> The variable 'remoteFileStreams' has been used.  System.Management.Automation FileSystemProvider.cs 4126 <br><br>  <a href="http://bit.ly/2fmm5ZT">Link to GitHub code</a> . <br><br>  If you‚Äôre lucky, the code will work fine; if you‚Äôre unlucky, when you try to dereference a zero reference, you will get an exception of type <i>NullReferenceException</i> .  The <i>remoteFileStreams! = Null</i> subexpression does not play any role in this expression, nor does it protect against an exception.  Obviously, to work properly, you need to swap subexpressions in some places. <br><br>  Well, we are all human, and everyone makes mistakes.  And analyzers are needed to find these errors. <br><br>  <b>Possible dereference of the zero reference</b> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SafeForExport</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DisplayEntry.SafeForExport() &amp;&amp; ItemSelectionCondition == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || ItemSelectionCondition.SafeForExport(); }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0480/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0480/">V3080</a> Possible null dereference.  Consider inspecting 'ItemSelectionCondition'.  System.Management.Automation displayDescriptionData_List.cs 352 <br><br>  <a href="http://bit.ly/2ehY8ia">Link to GitHub code</a> . <br><br>  Potential exception of type <i>NullReferenceException</i> .  The <i>ItemSelectionCondition.SafeForExport () subexpression</i> will only be evaluated if the result of the first subexpression is <i>false</i> .  It follows that if <i>DisplayEntry.SafeForExport ()</i> returns <i>false</i> and <i>ItemSelectionCondition</i> == <i>null</i> , the second subexpression will be calculated - <i>ItemSelectionCondition.SafeForExport ()</i> , where the problem of dereferencing the zero reference will arise (and as a result, an exception will be generated). <br><br>  A similar code met once again.  Corresponding warning: <a href="http://www.viva64.com/ru/d/0480/">V3080</a> Possible null dereference.  Consider inspecting 'EntrySelectedBy'.  System.Management.Automation displayDescriptionData_Wide.cs 247 <br><br>  Another case. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> Collection&lt;ProviderInfo&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> PSSnapinQualifiedName providerName</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (providerName == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ProviderNotFoundException e = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProviderNotFoundException( providerName.ToString(), SessionStateCategory.CmdletProvider, <span class="hljs-string"><span class="hljs-string">"ProviderNotFound"</span></span>, SessionStateStrings.ProviderNotFound); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> e; } .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0480/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0480/">V3080</a> Possible null dereference.  Consider inspecting 'providerName'.  System.Management.Automation SessionStateProviderAPIs.cs 1004 <br><br>  <a href="http://bit.ly/2eM1hYe">Link to GitHub code</a> . <br><br>  Sometimes there is a code like this - they wanted to generate an exception of one type, but it turned out another.  Why?  In this case, it is checked that the <i>providerName</i> reference is <i>null</i> , but below, when an exception object is created, the instance method <i>ToString is</i> called on the same reference.  The result will be an <i>NullReferenceException</i> type <i>exception</i> , not a <i>ProviderNotFoundException</i> , as planned. <br><br>  Another similar code snippet met.  Corresponding warning: <a href="http://www.viva64.com/ru/d/0480/">V3080</a> Possible null dereference.  Consider inspecting a job.  System.Management.Automation PowerShellETWTracer.cs 1088 <br><br>  <b>Using a link before checking for</b> <b><i>null</i></b> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> ComplexViewEntry </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateView</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...., FormattingCommandLineParameters inputParameters</span></span></span><span class="hljs-function">)</span></span> { _complexSpecificParameters = (ComplexSpecificParameters)inputParameters.shapeParameters; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxDepth = _complexSpecificParameters.maxDepth; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputParameters != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) mshParameterList = inputParameters.mshParameterList; .... }</code> </pre> <br>  <b>PVS-Studio Warning:</b> <a href="http://www.viva64.com/ru/d/0504/">V3095</a> The 'inputParameters' object was verified against null.  Check lines: 430, 436. System.Management.Automation FormatViewGenerator_Complex.cs 430 <br><br>  <a href="http://bit.ly/2dOfbw1">Link to GitHub code</a> . <br><br>  The <i>inputParameters! = Null</i> check implies that the link being checked can be <i>null</i> .  Reinsured so that when accessing the <i>mshParameterList</i> field, <i>you</i> do not get a <i>NullReferenceException</i> exception.  All right  Here are just above already turned to another instance field of the same object - <i>shapeParameters</i> .  Since <i>inputParameters</i> between these two operations does not change, if the link was initially <i>null</i> , checking for <i>null</i> inequality will not save the exception. <br><br>  A similar case: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CommandMetadata</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CommandMetadata other</span></span></span><span class="hljs-function">)</span></span> { .... _parameters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, ParameterMetadata&gt;( other.Parameters.Count, StringComparer.OrdinalIgnoreCase); <span class="hljs-comment"><span class="hljs-comment">// deep copy if (other.Parameters != null) .... }</span></span></code> </pre> <br>  <b>PVS-Studio Warning:</b> <a href="http://www.viva64.com/ru/w/V3095/">V3095</a> The 'other.Parameters' object was used against null.  Check lines: 189, 192. System.Management.Automation CommandMetadata.cs 189 <br><br>  <a href="http://bit.ly/2dOd9fm">Link to GitHub code</a> . <br><br>  Verify that the <i>Parameters</i> property of the <i>other</i> object is not <i>null</i> , but a couple of lines above refer to the <i>Count</i> instance property.  Something is clearly wrong here. <br><br>  <b>Unused constructor parameter</b> <br><br>  It is nice to see the results of the new diagnostic rules immediately after their appearance.  It happened with the diagnostics <a href="http://www.viva64.com/ru/w/V3117/">V3117</a> . <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PopulateProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> Exception exception, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> targetObject, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fullyQualifiedErrorId, ErrorCategory errorCategory, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorCategory_Activity, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorCategory_Reason, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorCategory_TargetName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorCategory_TargetType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorCategory_Message, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorDetails_Message, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorDetails_RecommendedAction, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorDetails_ScriptStackTrace</span></span></span><span class="hljs-function">)</span></span> { .... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ErrorRecord</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> Exception exception, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> targetObject, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fullyQualifiedErrorId, ErrorCategory errorCategory, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorCategory_Activity, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorCategory_Reason, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorCategory_TargetName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorCategory_TargetType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorCategory_Message, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorDetails_Message, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorDetails_RecommendedAction</span></span></span><span class="hljs-function">)</span></span> { PopulateProperties( exception, targetObject, fullyQualifiedErrorId, errorCategory, errorCategory_Activity, errorCategory_Reason, errorCategory_TargetName, errorCategory_TargetType, errorDetails_Message, errorDetails_Message, errorDetails_RecommendedAction, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V3117/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V3117/">V3117</a> Constructor parameter 'errorCategory_Message' is not used.  System.Management.Automation ErrorPackage.cs 1125 <br><br>  ¬ª <a href="http://bit.ly/2ehXsZW">Link to GitHub code</a> . <br><br>  In the <i>ErrorRecord</i> constructor, the <i>PopulateProperties</i> method is <i>called</i> , which performs field initialization and some other actions.  The analyzer warns that one of the constructor parameters, <i>errorCategory_Message,</i> is not used in its body.  Indeed, if you take a close look at the call to the <i>PopulateProperties</i> method, you will notice that the <i>errorDetails_Message</i> argument is passed 2 times to the method, but the <i>errorCategory_Message</i> is not passed.  We look at the parameters of the <i>PopulateProperties</i> method and make sure that there is an error. <br><br>  <b>Condition which is always false</b> <br><br>  One of the features of PVS-Studio, which helps to implement complex diagnostics and find interesting errors, is the so-called 'virtual values', with which you can find out what ranges of values ‚Äã‚Äãa variable can take at a certain stage of program execution.  More information can be obtained from the article <a href="http://www.viva64.com/ru/b/0394/">"Search for errors using the calculation of virtual values"</a> .  Based on this mechanism, diagnostic rules such as <a href="http://www.viva64.com/ru/d/0391/">V3022</a> and <a href="http://www.viva64.com/ru/d/0461/">V3063 are built</a> .  With their help, it is often possible to find interesting errors.  It happened this time too, therefore, I propose to consider one of the errors found: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> RunspacePoolState { BeforeOpen = <span class="hljs-number"><span class="hljs-number">0</span></span>, Opening = <span class="hljs-number"><span class="hljs-number">1</span></span>, Opened = <span class="hljs-number"><span class="hljs-number">2</span></span>, Closed = <span class="hljs-number"><span class="hljs-number">3</span></span>, Closing = <span class="hljs-number"><span class="hljs-number">4</span></span>, Broken = <span class="hljs-number"><span class="hljs-number">5</span></span>, Disconnecting = <span class="hljs-number"><span class="hljs-number">6</span></span>, Disconnected = <span class="hljs-number"><span class="hljs-number">7</span></span>, Connecting = <span class="hljs-number"><span class="hljs-number">8</span></span>, } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAvailableRunspaces</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stateInfo.State == RunspacePoolState.Opened) { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (pool.Count + unUsedCapacity); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stateInfo.State != RunspacePoolState.BeforeOpen &amp;&amp; stateInfo.State != RunspacePoolState.Opening) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException( HostInterfaceExceptionsStrings.RunspacePoolNotOpened); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stateInfo.State == RunspacePoolState.Disconnected) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException( RunspacePoolStrings.CannotWhileDisconnected); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maxPoolSz; } .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0391/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0391/">V3022</a> Expression 'stateInfo.State == RunspacePoolState.Disconnected' is always false.  System.Management.Automation RunspacePoolInternal.cs 581 <br><br>  ¬ª <a href="http://bit.ly/2e3QSbY">Link to GitHub code</a> . <br><br>  The analyzer states that the expression <i>stateInfo.State == RunspacePoolState.Disconnected is</i> always false.  Is it so?  Of course, otherwise, why would I write out this code! <br><br>  The developer made a miscalculation in the previous condition.  The fact is that if <i>stateInfo.State == RunspacePoolState.Disconnected</i> , the previous <i>if statement</i> will always be executed.  To correct the error, it is enough to swap the last two <i>if</i> ( <i>else if</i> ) <i>statements</i> . <br><br><h2>  More mistakes? </h2><br>  Yes, there are many more places that the analyzer found suspicious.  Those who regularly read our articles know that often we do not write out all the errors.  Maybe up to the size of the <a href="http://www.viva64.com/ru/b/0431/">article about checking Mono</a> it would not have come, but the writing material still remained.  The greatest interest in all warnings should arise from the developers, the rest of the readers, I just try to show the most interesting suspicious places. <br><br><h2>  ‚ÄúDid you tell the developers?‚Äù </h2><br>  Oddly enough, we are still periodically asked this question.  We always inform the developers about the errors found, but this time I decided to go a little further. <br><br>  I talked to one of the developers (hello, Sergey!) Personally through <a href="https://gitter.im/">Gitter</a> .  The advantages of this solution are obvious - you can discuss the errors found, get feedback about the analyzer, maybe something to correct in the article.  It's nice when people understand the benefits of static analysis.  The developers noted that the code snippets found by the analyzer were indeed errors, thanked them, and said that errors would be corrected over time.  And I, in turn, decided to help them a little by giving links to these code fragments in the repository.  We talked a little about the use of the analyzer.  It's great that people understand that static analysis should be used regularly.  I hope it will be so, and the analyzer will be embedded in the development process. <br><br>  Here is a mutually beneficial cooperation. <br><br><h2>  Conclusion </h2><br>  As expected, the analyzer was able to detect a number of suspicious places.  And the point is not that someone writes the wrong code or has insufficient qualifications (of course, it happens, but, I think, not in this case) - the human factor is to blame for everything.  This is the essence of man, everyone is mistaken.  Static analysis tools try to compensate for this flaw by pointing out errors in the code.  Therefore, their regular use is the way to the best code.  And it's better to see once than to hear 100 times, so I suggest <a href="http://www.viva64.com/ru/pvs-studio-download/">trying PVS-Studio on your</a> own. <br><br><h2>  Analysis of other Microsoft projects </h2><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/files/ee7/fd5/325/ee7fd53254e14e34a23718c65e06c241.png"></div><p></p><br><br><h3>  C ++ </h3><br><ul><li>  <a href="http://www.viva64.com/ru/b/0372/">CNTK verification</a> ; </li><li>  <a href="http://www.viva64.com/ru/b/0370/">Check ChakraCore</a> ; </li><li>  <a href="http://www.viva64.com/ru/b/0310/">CoreCLR validation</a> ; </li><li>  <a href="http://www.viva64.com/ru/b/0199/">Check Windows 8 Driver Samples</a> ; </li><li>  <a href="http://www.viva64.com/ru/b/0245/">Microsoft Word Verification 1.1a</a> ; </li><li>  Checking Visual C ++ libraries: <a href="http://www.viva64.com/ru/b/0163/">1</a> , <a href="http://www.viva64.com/ru/b/0288/">2</a> ; </li><li>  <a href="http://www.viva64.com/ru/b/0189/">Check Casablanca</a> ; </li></ul><br><h3>  C # </h3><br><ul><li>  <a href="http://www.viva64.com/ru/b/0365/">CoreFX validation</a> ; </li><li>  <a href="http://www.viva64.com/ru/b/0363/">Check .Net Compiler Platform (Roslyn)</a> ; </li><li>  <a href="http://www.viva64.com/ru/b/0361/">Checking Code Contracts</a> ; </li><li>  <a href="http://www.viva64.com/ru/b/0424/">MSBuild check</a> ; </li><li>  <a href="http://www.viva64.com/ru/b/0407/">WPF Samples Check</a> . </li></ul><br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0447/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Sergey Vasiliev.  <a href="http://www.viva64.com/en/b/0447/">We continue checking Microsoft projects: analysis of PowerShell</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. </div></div></div><p>Source: <a href="https://habr.com/ru/post/314226/">https://habr.com/ru/post/314226/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314216/index.html">How we adjusted the process from storage to software licensing: SupplyLab project</a></li>
<li><a href="../314218/index.html">Optimal Spline Approximation</a></li>
<li><a href="../314220/index.html">goader - console benchmark with a bias for writing and reading files</a></li>
<li><a href="../314222/index.html">Artificial intelligence in the search. How Yandex learned to use neural networks in order to search by meaning, not by words</a></li>
<li><a href="../314224/index.html">Video recordings of the best reports of the .NET conference DotNext 2016 Piter</a></li>
<li><a href="../314228/index.html">Google learned how to filter fake installations on Android</a></li>
<li><a href="../314230/index.html">Corporate Laboratories - Program Update</a></li>
<li><a href="../314232/index.html">My experience with getting PMP</a></li>
<li><a href="../314234/index.html">5 amazing ways to manage time enjoyed by successful people</a></li>
<li><a href="../314236/index.html">Kivy. From creation to production one step. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>