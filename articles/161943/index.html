<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Navigation without rebooting using expressjs, jade and History.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have never had the opportunity to use the HTML5 feature like the History API in my work. And then came the time to figure it out and conduct a small...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Navigation without rebooting using expressjs, jade and History.js</h1><div class="post__text post__text-html js-mediator-article">  I have never had the opportunity to use the HTML5 feature like the History API in my work.  And then came the time to figure it out and conduct a small experiment.  The result of this experiment, I decided to share with you. <br><br>  And so what we want: <br>  - Site navigation using history api <br>  - Receive data from the server in the form of a json object, followed by rendering on the client <br>  - With a direct transition, the render should occur on the server <br>  - To make everything easy and simple <br><a name="habracut"></a><br>  We have decided on the range of needs, now we will define the technologies: <br>  - The server will work expressjs under nodejs <br>  - as a jade template <br>  - For client History.js <br><br><h5>  Server </h5><br>  For those who have never worked with nodejs, it's worth installing it first.  How to do it quickly under Ubuntu can be found <a href="http://forum.nodejs.ru/index.php/topic,2940.msg11329.html">here</a> .  Create a folder for the project and go into it.  Next, install the necessary modules: <br>  <b>npm i express jade</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And create two directories: <br>  - view - there will be templates <br>  - public - there will be static content <br><br>  Next, write the server and dwell only on the main points. <br>  The first thing I wanted to make my life easier is not to think about how ajax request came to us or not.  To do this, we intercept the standard res.render <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="javascript hljs">app.all(<span class="hljs-string"><span class="hljs-string">'*'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceRender</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> render = res.render, view = req.path.length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> ? req.path.substr(<span class="hljs-number"><span class="hljs-number">1</span></span>).split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>): []; res.render = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v, o</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data; res.render = render; <span class="hljs-comment"><span class="hljs-comment">//         //  if ('string' === typeof v) { if (/^\/.+/.test(v)) { view = v.substr(1).split('/'); } else { view = view.concat(v.split('/')); } data = o; } else { data = v; } // res.locals      //    s (res.locals.title) data = merge(data || {}, res.locals); if (req.xhr) { //     json res.json({ data: data, view: view.join('.') }); } else { //   ,    // (   history api) data.state = JSON.stringify({ data: data, view: view.join('.') }); //    .       . view[view.length - 1] = '_' + view[view.length - 1]; //   res.render(view.join('/'), data); } }; next(); });</span></span></code> </pre> <br></div></div><br><br>  res.render was overloaded, now we can calmly call <b>res.render (data)</b> or <b>res.render ('view name', data)</b> in our controllers, and the server itself either derends or returns json to the client depending on the type of request. <br><br>  Let's look at the code again, and I will try to explain why the prefix '_' to the templates is needed in the case of "server rendering". <br>  The problem is as follows.  There are no layouts in jade, blocks are used instead, blocks can expand, replace or complement each other (all this is well described in the <a href="">documentation</a> ). <br><br>  Consider an example. <br>  Suppose we have the following mapping structure: <br><div class="spoiler">  <b class="spoiler_title">option A</b> <div class="spoiler_text">  <b>layout.jade</b> <br><pre> <code class="diff hljs"><span class="hljs-addition"><span class="hljs-addition">!!! 5 html head title Page title body #content block content</span></span></code> </pre><br><br>  <b>index.jade</b> <br><pre> <code class="diff hljs">extends layout block content hello world</code> </pre><br></div></div><br>  If we now render index.jade, it will be rendered along with layout.jade.  This is not a problem unless we want to export index.jade to the client and render it there, but <b>without</b> layout.jade.  So I decided to add another template that would allow it to be done easily and simply. <br><br><div class="spoiler">  <b class="spoiler_title">option B</b> <div class="spoiler_text">  <b>layout.jade</b> <br><pre> <code class="diff hljs"><span class="hljs-addition"><span class="hljs-addition">!!! 5 html head title Page title body #content block content</span></span></code> </pre><br><br>  <b>_index.jade</b> <br><pre> <code class="diff hljs">extends layout block content include index</code> </pre><br><br>  <b>index.jade</b> <br><pre> <code class="diff hljs">hello world</code> </pre><br></div></div><br>  Now, if we want to render the block with the layout, we will render the _index.jade file, if we do not need the layout, then we need to render index.jade.  Such a method seemed to me the most simple and understandable.  If you stick to the rule that only templates with the "_" prefix expand layout.jade, you can safely export everything else to the client.  (There are undoubtedly other ways to do this, you can tell about them in the comments, it will be interesting to know) <br><br>  The next point I‚Äôll focus on is the export of templates to the client.  To do this, we write a function that will receive the path to the template relative to the viewdir at the input, and the output will return the compiled function reduced to the string. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadTemplate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">viewpath</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fpath = app.get(<span class="hljs-string"><span class="hljs-string">'views'</span></span>) + viewpath, str = fs.readFileSync(fpath, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>); viewOptions.filename = fpath; viewOptions.client = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jade.compile(str, viewOptions).toString(); }</code> </pre><br></div></div><br>  Now we will write a controller that will collect javascript file with templates. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text">  (I ask you not to pay attention to the fact that everything is handled, this is just an experiment, in a real project, of course, you should not do this) <br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'/templates'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str = <span class="hljs-string"><span class="hljs-string">'var views = { '</span></span> + <span class="hljs-string"><span class="hljs-string">'"index": (function(){ return '</span></span> + loadTemplate(<span class="hljs-string"><span class="hljs-string">'/index.jade'</span></span>) + <span class="hljs-string"><span class="hljs-string">' }()),'</span></span> + <span class="hljs-string"><span class="hljs-string">'"users.index": (function(){ return '</span></span> + loadTemplate(<span class="hljs-string"><span class="hljs-string">'/users/index.jade'</span></span>) + <span class="hljs-string"><span class="hljs-string">' }()),'</span></span> + <span class="hljs-string"><span class="hljs-string">'"users.profile": (function(){ return '</span></span> + loadTemplate(<span class="hljs-string"><span class="hljs-string">'/users/profile.jade'</span></span>) + <span class="hljs-string"><span class="hljs-string">' }()),'</span></span> + <span class="hljs-string"><span class="hljs-string">'"errors.error": (function(){ return '</span></span> + loadTemplate(<span class="hljs-string"><span class="hljs-string">'/errors/error.jade'</span></span>) + <span class="hljs-string"><span class="hljs-string">' }()),'</span></span> + <span class="hljs-string"><span class="hljs-string">'"errors.notfound": (function(){ return '</span></span> + loadTemplate(<span class="hljs-string"><span class="hljs-string">'/errors/notfound.jade'</span></span>) + <span class="hljs-string"><span class="hljs-string">' }())'</span></span> + <span class="hljs-string"><span class="hljs-string">'};'</span></span> res.set({ <span class="hljs-string"><span class="hljs-string">'Content-type'</span></span>: <span class="hljs-string"><span class="hljs-string">'text/javascript'</span></span> }).send(str); });</code> </pre><br></div></div><br>  Now when the client requests / template, in response, he will receive the following object: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> view = { <span class="hljs-string"><span class="hljs-string">' '</span></span>: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name"></span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> };</span></span></code> </pre><br>  And on the client to render the desired template, it will be enough to call <b>view ['template name'] (data);</b> <br><br>  Finish consider the server part, because  everything else is not particularly relevant and is not directly related to our task.  Especially the code can be viewed <a href="">here</a> . <br><br><h5>  Customer </h5><br>  Since we export already compiled templates to the client, we do not need to connect the template itself, it is enough to connect its <a href="">runtime</a> and do not forget to load our templates by connecting them as a regular javascript file. <br><br>  The next library from the list is <a href="https://github.com/balupton/History.js/">History.js</a> , whose name speaks for itself.  I chose the version only for <a href="https://github.com/balupton/history.js/tree/master/scripts/bundled/html5">html5</a> browsers, these are all modern browsers, although the library can work in older browsers through the url hash. <br><br>  There are very few client code left. <br>  The first is the <b>render ()</b> function.  It is quite simple and renders the specified template in the content block. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> render = (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">view, data</span></span></span><span class="hljs-function">) </span></span>{ $(<span class="hljs-string"><span class="hljs-string">'#content'</span></span>).html(views[view](data)); } }());</code> </pre><br><br>  Now the code initializing work with History.js <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">$(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> initState; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (History.enabled) { $(<span class="hljs-string"><span class="hljs-string">'a'</span></span>).live(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> el = $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>), href = el.attr(<span class="hljs-string"><span class="hljs-string">'href'</span></span>); $.get(href, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) </span></span>{ History.pushState(result, result.data.title, href); }, <span class="hljs-string"><span class="hljs-string">'json'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }); History.Adapter.bind(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>,<span class="hljs-string"><span class="hljs-string">'statechange'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> state = History.getState(), obj = state.data; render(obj.view, obj.data); }); <span class="hljs-comment"><span class="hljs-comment">//init initState = $('body').data('init'); History.replaceState(initState, initState.data.title, location.pathname + location.search); } });</span></span></code> </pre><br></div></div><br>  The code is quite simple.  The first thing we do is see if the browser supports history api.  If not, we change nothing and the client works in the old manner. <br>  And if it supports, we intercept all the clicks on <b>a</b> , send an AYAX request to the server. <br><br>  We do not forget to attach the statechange event handler, at this moment we need to redraw our content block, and add initialization of the initial state, I decided to store it in the <b>body</b> tag, the <b>data-init</b> attribute, the initial values ‚Äã‚Äãare written here when rendering on the server. <br>  <b>Line data.state = JSON.stringify ({data: data, view: view.join ('.')});</b>  in the <b>replaceRender</b> function <br><br>  That's all. <br><br>  The working example is <a href="http://express_app1.redzerg.ru/">here</a> (If it dies, it means it has covered its effect :)) <br>  Code can be found <a href="https://github.com/zxcabs/4fun/tree/master/express/app1">here</a> </div><p>Source: <a href="https://habr.com/ru/post/161943/">https://habr.com/ru/post/161943/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../161923/index.html">Adaptive speakers</a></li>
<li><a href="../161931/index.html">We are friends of Python 3 with MS Visual C ++. Build bridge in Boost.Python with automatic transcoding</a></li>
<li><a href="../161935/index.html">About censorship and methods of dealing with the Forbidden Registry</a></li>
<li><a href="../161939/index.html">Course lectures "Startup". Peter Thiel. Stanford 2012. Session 9</a></li>
<li><a href="../161941/index.html">Techniques and tools parallax</a></li>
<li><a href="../161947/index.html">LUT on vinyl or homemade Arduino Mini</a></li>
<li><a href="../161949/index.html">Achievement system (achievements) in Linderdaum Puzzle</a></li>
<li><a href="../161951/index.html">Ping-Pong on AVR</a></li>
<li><a href="../161953/index.html">Apple and Google will buy Kodak patents together</a></li>
<li><a href="../161955/index.html">Individually undertaking? In the cashier!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>