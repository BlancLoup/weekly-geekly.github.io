<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bobaos - KNX TP / UART, Raspberry Pi and Unix Domain Socket</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first article I talked about the goal, made a short description of the project. In this publication I will talk about the current state of affa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bobaos - KNX TP / UART, Raspberry Pi and Unix Domain Socket</h1><div class="post__text post__text-html js-mediator-article"><p>  In the <a href="https://habr.com/post/346680/">first article</a> I talked about the goal, made a short description of the project.  In this publication I will talk about the current state of affairs and the development of the project. </p><br><p><img src="https://habrastorage.org/webt/df/fi/gc/dffigctmrnb6bzmhvia3lr8igpg.png"></p><br><blockquote>  History does not repeat, history improves. </blockquote><p>  Quote from a pack of tobacco.  Next, I will show what has improved in four months of working on the project. </p><a name="habracut"></a><br><h3 id="repozitoriy-na-github">  Github repository </h3><br><p>  At the moment, all the source code of the project are located <a href="https://github.com/bobaos">at</a> . </p><br><h3 id="struktura">  Structure </h3><br><p>  Since the serial port holds only one connection, it was decided to create the <a href="">bdsd.sock</a> service.  The service keeps the serial port connection with the Weinzierl KNX BAOS 838 kBerry module on the one hand, and on the other hand, listens to the UNIX socket at $ XDG_RUNTIME_DIR / bdsd.sock.  Clients communicate with the socket using the BDSM (Bobaos Datapoint Sdk Message) protocol.  <a href="">Description</a> . </p><br><h3 id="servernaya-chast-bdsdsock">  Server part: bdsd.sock </h3><br><p>  The service serves to make it possible to connect simultaneously with several clients.  Suppose you need to run the CLI for debugging and, at the same time, another service, for example - a plugin to support socket.io or mqtt. </p><br><p>  Installation: </p><br><pre><code class="bash hljs">$ sudo npm install -g bdsd.sock --unsafe-perm</code> </pre> <br><p>  Run: </p><br><pre> <code class="bash hljs">$ bdsd.sock</code> </pre> <br><p>  To automatically start at system startup, you can use systemd capabilities.  Instructions, as well as the service file are available in the repository. </p><br><p>  Naturally, for the service to work, you need to configure access to the UART Raspberry Pi.  Instructions for setting is in the previous publication. </p><br><p>  In addition to IPC added support for data types.  When the bdsd.sock service is started, it polls the BAOS module about the stored dataphone (GetDatapointDescription.Req) and then stores all of its values, including the type (DPT1, DPT5, etc.).  For the client, this means that it is not necessary to manually convert the set of bytes, bdsd.sock does this work by itself. </p><br><p>  It was: </p><br><pre> <code class="bash hljs">bobaos&gt; setDatapointValue -s 2 -v 128 -t dpt5</code> </pre> <br><p>  It became: </p><br><pre> <code class="bash hljs">bobaos&gt; setValue -s 2 -v 128</code> </pre> <br><p>  It was: </p><br><pre> <code class="bash hljs">bobaos&gt; getDatapointValue -s 1 { service: <span class="hljs-string"><span class="hljs-string">'GetDatapointValue.Res'</span></span>, direction: <span class="hljs-string"><span class="hljs-string">'response'</span></span>, error: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, start: 1, number: 1, payload: [ { id: 1, state: 16, length: 2, value: &lt;Buffer 0c 56&gt; } ] }</code> </pre> <br><p>  It became: </p><br><pre> <code class="bash hljs">bobaos&gt; getValue -s 1 { id: 1, value: 22.2, raw: { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: <span class="hljs-string"><span class="hljs-string">'Buffer'</span></span>, data: [ 12, 86 ] } }</code> </pre> <br><h3 id="klientskaya-chast-bdsdclient">  Client part: bdsd.client </h3><br><p>  bdsd.client - client library for nodejs projects.  Available in npm. </p><br><p>  Installation: </p><br><pre> <code class="bash hljs">$ npm install --save bdsd.client</code> </pre> <br><p>  Example: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> myClient = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'bdsd.client'</span></span>)(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> myInterval = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; myClient.on(<span class="hljs-string"><span class="hljs-string">'connect'</span></span>, _ =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'connected to bdsd.sock'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (myInterval === <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { myInterval = setInterval(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_</span></span></span><span class="hljs-function"> =&gt;</span></span> { myClient .getValue(<span class="hljs-number"><span class="hljs-number">42</span></span>) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">payload</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> myClient .setValue(payload.id, !payload.value); }) .catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'an error occurred'</span></span>, e); }); }, <span class="hljs-number"><span class="hljs-number">5000</span></span>); } });</code> </pre> <br><p>  In this example, we invert the datapoint value 42 every 5 seconds.  The client API is implemented on promises, the description is available on <a href="https://github.com/bobaos/bdsd.client">the repository page</a> . </p><br><p>  There are no client libraries for other programming languages, but, since  open source project, the ability to write is welcome.  <a href="">Description of the protocol</a> . </p><br><h3 id="klientskaya-chast-bdsd-io">  Client part: bdsd-io </h3><br><p>  Socket.io interface for interacting with clients of other machines, for example, in the local network. </p><br><p>  Installation: </p><br><pre> <code class="bash hljs">$ sudo npm install -g bdsd-io --unsafe-perm $ bdsd-io</code> </pre> <br><p>  Customer example: </p><br><pre> <code class="hljs lua">const socket = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'socket.io-client'</span></span>)(<span class="hljs-string"><span class="hljs-string">'http://&lt;RPi ip address&gt;:49199'</span></span>); socket.on(<span class="hljs-string"><span class="hljs-string">'connect'</span></span>, _ =&gt; { console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Connected to bobaos server!'</span></span>); socket.emit(<span class="hljs-string"><span class="hljs-string">'get value'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err, payload)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { throw new Error(err) } console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Got datapoint 1 value: '</span></span>, payload); }); //       socket.on(<span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(payload)</span></span></span></span>{ console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'got broadcasted value:'</span></span>, payload); }); })</code> </pre><br><p>  bdsd-io supports the following methods: </p><br><ul><li>  'get datapoints' - get a list of all datapoints </li><li>  'get description' - get a description of one datpoint </li><li>  'get value' - get value </li><li>  'set value' - set value </li><li>  'read value' - send a read request to the KNX bus </li></ul><br><h3 id="klientskaya-chast-bdsd-cli">  Client part: bdsd-cli </h3><br><p>  Replaced by bobaos-cli came the new command line interface <a href="https://github.com/bobaos/bdsd-cli">bdsd-cli</a> .  I use it on each object for debugging.  It is more convenient to set, read, and receive values ‚Äã‚Äãfrom the KNX bus than from the ETS in that it is controlled via the command line, which significantly increases the speed of work. </p><br><p>  Installation and use: </p><br><pre> <code class="bash hljs">$ sudo npm install -g bdsd-cli --unsafe-perm $ bdsd-cli connected bobaos&gt; setValue -s 999 -v <span class="hljs-string"><span class="hljs-string">'Hello, friend'</span></span> { id: 999 } bobaos&gt; getValue -s 999 { id: 999, value: <span class="hljs-string"><span class="hljs-string">'Hello, friend'</span></span>, raw: { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: <span class="hljs-string"><span class="hljs-string">'Buffer'</span></span>, data: [ 72, 101, 108, 108, 111, 44, 32, 102, 114, 105, 101, 110, 100, 0 ] } } bobaos&gt; getDescription -s 999 { id: 999, value: { id: 999, dpt: <span class="hljs-string"><span class="hljs-string">'dpt16'</span></span>, flags: { priority: <span class="hljs-string"><span class="hljs-string">'low'</span></span>, communication: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">read</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, write: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, readOnInit: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, transmit: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, update: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }, length: 14 } } broadcasted value: { id: 1, value: 22.3, raw: { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: <span class="hljs-string"><span class="hljs-string">'Buffer'</span></span>, data: [ 12, 91 ] } } bobaos&gt; setProgrammingMode -v 1 Set programming mode: success bobaos&gt; setProgrammingMode -v 0</code> </pre> <br><p>  List of commands: </p><br><ul><li>  getDatapoints - get all datapoints </li><li>  getDescription - description of a single object </li><li>  getValue - get the value of a single object </li><li>  setValue - set the value of the object </li><li>  readValue - read request to the KNX bus </li><li>  setProgrammingMode - programming mode.  Allows you to record the physical address from the ETS without physically pressing the button. </li></ul><br><h3 id="itog">  Total </h3><br><p>  Over time, many things improve and develop.  Including the bobaos-project, the work on which is in full swing and the ideas of practical application are being actively implemented.  As an example, with a half-kick, you can raise a bot for a telegram notifying about events in your home :) </p><br><p>  There is an interesting trail for the project ahead and I will keep you updated on the progress.  Until the following publications. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/354246/">https://habr.com/ru/post/354246/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354236/index.html">Why the creation of a simple preview on the links in Wikipedia took four years</a></li>
<li><a href="../354238/index.html">Victor Gamov on Apache Kafka on jug.msk.ru</a></li>
<li><a href="../354240/index.html">Ode to young professionals</a></li>
<li><a href="../354242/index.html">Hi, SaaS | Russian SaaS 2017 - results</a></li>
<li><a href="../354244/index.html">HABR coin</a></li>
<li><a href="../354248/index.html">The story about the repository of images. Or how the bike saved from the crutch</a></li>
<li><a href="../354250/index.html">Hack me if you can or what is penetration testing</a></li>
<li><a href="../354252/index.html">Vivaldi 1.15 - nice and comfortable</a></li>
<li><a href="../354254/index.html">Do not waste days worrying about the years. Or where success is born</a></li>
<li><a href="../354256/index.html">Casinos hacked through a thermostat in an aquarium</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>