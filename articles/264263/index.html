<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerate the launch of BeagleBone or runit not for dummies</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Devices that we develop and produce require a quick start after a cold start. For devices without a full-fledged operating system (in which we use Nut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerate the launch of BeagleBone or runit not for dummies</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/266/746/a49/266746a4900c461ca3c34df4803f73b3.jpg"><br><br>  Devices that we develop and produce require a quick start after a cold start.  For devices without a full-fledged operating system (in which we use NutOS, also known as EtherNut), there is no such problem - they are ready to work in a couple of seconds after switching on.  But in more complex and advanced, with linux inside, and especially in portable measuring systems, the issue of acceleration of initialization algorithms is more than relevant. <br>  In the pilot version of our 10G ethernet switch, we used the well-known <a href="http://beagleboard.org/bone">Beaglebone</a> board and the boot process, except for the qemu-emulator, was happy to debug it.  By the way, this pilot version of a 10-gigabit switch with a control beaglebone board (in the photo for the article) has been in our server room and has been working successfully for a couple of years, <br>  I‚Äôll say <a href="http://smarden.org/runit">right away</a> that the switch to <a href="http://smarden.org/runit">runit</a> gave an acceleration of the launch of the system on a 500MHz arm processor <b>from half a minute to six kopecks seconds</b> . <br><br>  <i>Disclaimer: this note was written for our company's internal wiki, and since not all software developers are system administrators, I found it necessary to explain some points in the most simple and understandable language.</i> <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Introduction: how to eat and what can be changed </h2><br>  I will try to briefly describe the problem. <br>  Normally the linux system is loaded as follows: <br><ol><li>  bootloader (lilo, grub, u-boot, ...) </li><li>  core </li><li>  init program </li><li>  everything else (as described in / etc / inittab) is started by this same init program </li></ol><br><br>  I will not talk about runlevels.  There is a man for this: man runlevel, man init, man inittab. <br><br>  init is the main process of the system and it, in one way or another, manages all other programs, and even the process number is 1. If it‚Äôs completely simplified, then its task is to start and restart the programs listed in the / etc / inittab file. <br><br>  But back to the boot process. <br><br>  For some reason, the authors of the distributions sticking to the so-called System V (sysv) boot order decided that init should invoke the same rc script with a parameter defining the runlevel level.  This can be interpreted in the same way as, for example, if all the children went to school with one textbook, only opened it on different pages, depending on what class they are in.  One can imagine how thick such a textbook should have been! <br><br>  With the startup sequence of the linux system is almost the same situation. <br><br>  Here, for example, is a piece of / etc / inittab: <br><br><pre> id: 2: initdefault:

 # Boot-time system configuration / initialization script.
 # This is a run first except when booting in emergency (-b) mode.
 si :: sysinit: /etc/init.d/rcS

 # What to do in single-user mode.
 ~~: S: wait: / sbin / sulogin

 # Runlevel 0 is halt.
 # Runlevel 1 is single-user.
 # Runlevels 2-5 are multi-user.
 # Runlevel 6 is reboot.

 l0: 0: wait: /etc/init.d/rc 0
 l1: 1: wait: /etc/init.d/rc 1
 l2: 2: wait: /etc/init.d/rc 2
 l3: 3: wait: /etc/init.d/rc 3
 l4: 4: wait: /etc/init.d/rc 4
 l5: 5: wait: /etc/init.d/rc 5
 l6: 6: wait: /etc/init.d/rc 6
</pre><br><br>  The /etc/init.d/rc script contains more than 300 (!) Lines of shell code.  And he does, in general, nothing at all: sequentially runs programs from /etc/rc?.d, depending on the stage of execution (runlevel'a). <br><br>  We go further.  At the initial stage (runlevel S, see above or inside / etc / inittab) everything that is in the /etc/rcS.d/ directory is executed.  these are 20 scripts from the hostname to mount nfs and initialize the random generator. <br><br>  After this part of the boot process is completed, init goes into multi-user mode and executes scripts from /etc/rc2.d/.  In the simplest case, there are about ten of them. <br><br>  When adding new programs (services, daemons etc) installation packages usually add one or two more scripts to the boot process and the system startup time increases again. <br><br>  If a desktop computer or laptop or even a server may not be in a hurry to boot, the devices we produce should be ready for operation after switching on as soon as possible.  for devices such as <a href="http://metrotek.spb.ru/b3et.html">Bercut-ET</a> , there are no problems - there we completely control the process, and for <a href="http://metrotek.spb.ru/b45.html">Bercut-MMT the</a> question of a quick start remained open until recently. <br><br>  So, a set of programs runit allows you to most easily and fully manage the procedure for starting the system. <br><br>  In fact, starting linux (not only linux, you can also download bsd-like, in general) when using runit comes down to starting the kernel with the program runit-init, which controls the operation of three shell scripts: <br><ol><li>  / etc / runit / 1 - initial start </li><li>  / etc / runit / 2 - multi-user mode (similar to runlevel 2) </li><li>  / etc / runit / 3 - shutdown / reboot (poweroff, shutdown, halt) </li></ol><br><br>  Each script usually takes one or two command screens and does only what is needed.  Due to simplicity, transparency and, most importantly, a small amount of scripts, the administrator or developer of the installation image of the system can easily and completely manage the process. <br><br>  The rest of the programs and services usually start under the control of the <a href="http://smarden.org/runit/runsvdir.8.html">runsvdir</a> program, and dependencies, priorities, and the startup order are determined by the administrator.  An example of working with runsvdir is <a href="http://habrahabr.ru/post/83775/">already</a> on Habr√©, so I will not describe it in detail here. <br><br>  In the Bercut.BeagleBone download log, you can pay attention to the time it took the system to execute the initial script (/ etc / runit / 1) and the time until the ‚Äúlogin:‚Äù prompt appears: <br><br><pre> 20: 06: 22.33157 Uncompressing Linux ... done, booting the kernel.
 20: 06: 22.99351 - runit: $! Id: 25da3b86f7bed4038b8a039d2f8e8c9bbcf0822b $: booting.
 20: 06: 22.99351 - runit: enter stage: / etc / runit / 1
 20: 06: 24.07955 - runit: leave stage: / etc / runit / 1
 20: 06: 24.07955 - runit: enter stage: / etc / runit / 2
 20: 06: 25.41956
 20: 06: 25.41957 Debian GNU / Linux 7.0 x10-02 ttyO0
 20: 06: 25.41957
 20: 06: 25.41957 x10-02 login:
</pre><br><br>  As you can see, the system boot process (processor arm 500 MHz) took about three seconds.  And this is taking into account the start of the kernel! <br><br><h2>  The transition process: step by step </h2><br>  The process is specifically described in general terms to make you think and understand how it works, and not <s>stupidly</s> copylessly copy scripts into the system and wonder why it does not work. <br><br><h3>  Step 1 </h3><br>  Install the system runit.  Whatever, in the form of <s>stuffed or carcass</s> package or collect from <a href="http://smarden.org/runit/install.html">source</a> . <br><br><h3>  Step 2 </h3><br>  Ensure that the services under the control of <a href="http://smarden.org/runit/runsvdir.8.html">runsvdir</a> start, work and log for them.  If you have never used programs from the daemontools or runit series (without replacing init), then you can stop reading. <br><br><h3>  Step 3 </h3><br>  Configure the service for the console login.  If you have never used programs from the daemontools or runit series (without replacing init), then it will be hard for you and you can stop reading.  Sorry. <br><br>  The run script for the fifth console (Alt-F5) may, for example, look like this: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh exec 2&gt;&amp;1 exec setsid /sbin/agetty --nohostname tty5 38400 linux</span></span></code> </pre> <br><br><h3>  Step 4 </h3><br>  Install shell scripts with memorable names 1, 2, 3 (one, two, three) in the / etc / runit directory.  In the examples, these are bash scripts, but, in principle, no one bothers them to be sh-scripts or even perl-programs.  But why? <br><br>  Script <b>1</b> is executed at the first stage of loading (similar to rcS, single-user mode), script <b>2</b> is the main mode of the system, <b>3</b> is shutdown, reboot and poweroff. <br><br><h3>  Step 5 </h3><br>  Reboot the system by passing the init = / sbin / runit-init parameter to the kernel. <br><br><h3>  Step 6 </h3><br>  Look at the result and try to understand what is wrong;) <br><br><h3>  Step 7 </h3><br>  If you manage to figure out what's wrong and get an invitation to enter your login on the 5th console, then I congratulate you: Most of the work is done!  Now you can tie the remaining services (udev etc.) <br><br>  Scripts 1, 2, 3 - at the bottom of this page under the spoilers (see below).  Pay attention to the amount of code.  surprisingly, this is enough for a full load of the operating system! <br><br><h2>  Bercut.BeagleBone Boot Log </h2><br>  From the moment of the ‚Äúcold‚Äù start until the login: prompt appears, it takes only 6.1019 seconds.  In my opinion, very good. <br><br><pre> 20: 06: 19.31769 U-Boot SPL 2011.09-00000-gf63b270-dirty (Apr 24 2012 - 09:51:01)
 20: 06: 19.52354 Texas Instruments Revision detection unimplemented
 20: 06: 19.94867 No AC power, disabling frequency switch
 20: 06: 19.94868 OMAP SD / MMC: 0
 20: 06: 19.94868 reading u-boot.img
 20: 06: 19.94868 reading u-boot.img
 20: 06: 19.94868
 20: 06: 19.94868
 20: 06: 19.94869 U-Boot 2011.09-00000-gf63b270-dirty (Apr 24 2012 - 09:51:01)
 20: 06: 20.20756
 20: 06: 20.20756 I2C: ready
 20: 06: 20.20756 DRAM: 256 MiB
 20: 06: 20.39067 No daughter card present
 20: 06: 20.39067 NAND: HW ECC Hamming Code selected
 20: 06: 20.39067 nand_get_flash_type: unknown NAND device: Manufacturer ID: 0x10, Chip ID: 0x10
 20: 06: 20.39970 No NAND device found !!!
 20: 06: 20.39970 0 MiB
 20: 06: 20.39970 MMC: OMAP SD / MMC: 0
 20: 06: 20.39970 *** Warning - readenv () failed, using default environment
 20: 06: 20.65954
 20: 06: 20.65954 Net: cpsw
 20: 06: 20.65955 Hit any key to stop autoboot: 0
 20: 06: 21.54266 SD / MMC found on device 0
 20: 06: 21.54266 reading uEnv.txt
 20: 06: 21.54266
 20: 06: 21.54266 202 bytes read
 20: 06: 21.54266 Loaded environment from uEnv.txt
 20: 06: 21.54266 Importing environment from mmc ...
 20: 06: 21.74756 reading uimage
 20: 06: 21.87867
 20: 06: 21.87868 3083432 bytes read
 20: 06: 21.87869 ## Booting kernel from Legacy Image at 80007fc0 ...
 20: 06: 21.87870 Image Name: Angstrom / 3.2.18 / beaglebone
 20: 06: 21.88761 Image Type: ARM Linux Kernel Image (uncompressed)
 20: 06: 21.88761 Data Size: 3083368 Bytes = 2.9 MiB
 20: 06: 21.94465 Load Address: 80008000
 20: 06: 21.94465 Entry Point: 80008000
 20: 06: 21.94465 Verifying Checksum ... OK
 20: 06: 21.94465 XIP Kernel Image ... OK
 20: 06: 22.33156 OK
 20: 06: 22.33156
 20: 06: 22.33156 Starting kernel ...
 20: 06: 22.33156
 20: 06: 22.33157 Uncompressing Linux ... done, booting the kernel.
 20: 06: 22.99351 - runit: $! Id: 25da3b86f7bed4038b8a039d2f8e8c9bbcf0822b $: booting.
 20: 06: 22.99351 - runit: enter stage: / etc / runit / 1
 20: 06: 24.07955 - runit: leave stage: / etc / runit / 1
 20: 06: 24.07955 - runit: enter stage: / etc / runit / 2
 20: 06: 25.41956
 20: 06: 25.41957 Debian GNU / Linux 7.0 x10-02 ttyO0
 20: 06: 25.41957
 20: 06: 25.41957 x10-02 login:
</pre><br><br><h2>  Runit script examples </h2><br><div class="spoiler">  <b class="spoiler_title">/ etc / runit / 1</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # system one time tasks PATH=/sbin:/bin:/usr/sbin:/usr/bin # re-exec this script with a controlling tty if [ "$(tty)" = "/dev/console" ]; then mountpoint -q /sys || \ mount -t sysfs sys /sys -o nosuid,noexec,nodev mountpoint -q /proc || \ mount -t proc proc /proc -o nosuid,noexec,nodev tty=$(&lt;/sys/class/tty/console/active) tty=/dev/${tty##* } exec setsid sh -c "exec bash /etc/runit/1 &lt;$tty &gt;$tty 2&gt;&amp;1" fi trap : INT TSTP QUIT trap 'sulogin -p &lt;&gt;$(tty) 2&gt;&amp;1' ERR mountpoint -q /proc || \ mount -t proc proc /proc -o nosuid,noexec,nodev mountpoint -q /sys || \ mount -t sysfs sys /sys -o nosuid,noexec,nodev mountpoint -q /dev || \ mount -t devtmpfs dev /dev -o mode=0755,nosuid test -e /dev/fd || ln -s /proc/self/fd /dev/fd exec 2&gt; &gt;(sed 's/^/:: /') # set -v . /etc/rc.conf mountpoint -q /run || \ mount -t tmpfs run /run -o mode=0755,nosuid,nodev mountpoint -q /dev || \ mount -t devtmpfs dev /dev -o mode=0755,nosuid mkdir -p -m0755 /run/runit /run/lock /run/user /dev/pts /dev/shm \ /run/network /run/runit mountpoint -q /dev/pts || mount -n -t devpts devpts /dev/pts -o mode=0620,gid=5,nosuid,noexec mountpoint -q /dev/shm || \ mount -n -t tmpfs shm /dev/shm -o mode=1777,nosuid,nodev mkdir -p -m 0755 /var/lib/supervise mountpoint -q /var/lib/supervise || \ mount -n -t tmpfs tmpfs /var/lib/supervise -o mode=1777,nosuid,nodev #mkdir -p -m 0755 /var/log #mountpoint -q /var/log || \ # mount -n -t tmpfs tmpfs /var/log -o mode=1777,nosuid,nodev mount -o remount,ro / ip link set up dev lo echo $HOSTNAME &gt; /proc/sys/kernel/hostname mount -o remount,rw / mount -a -t "nosysfs,nonfs,nonfs4,nosmbfs,nocifs" -O no_netdev #cp /var/lib/random-seed /dev/urandom &amp;&gt;/dev/null || true #( umask 077; dd if=/dev/urandom of=/var/lib/random-seed count=1 #bs=512 &amp;&gt;/dev/n ull ) install -m0664 -o root -g utmp /dev/null /var/run/utmp install -m0 /dev/null /run/runit/stopit install -m0 /dev/null /run/runit/reboot install -m0644 -o root -g utmp /dev/null /var/log/lastlog dmesg &gt; /var/log/dmesg</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">/ etc / runit / 2</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash PATH=/bin:/sbin:/usr/bin:/usr/sbin exec 2&gt; &gt;(sed 's/^/:: /') # set -v . /etc/rc.conf # sysctl --system for i in ${DAEMONS[@]}; do d=/var/lib/supervise/${i} mkdir -p $d ${d}.log l=/var/log/${i} mkdir -p $l done exec env - PATH=$PATH \ runsvdir -P /service 'log: ...........................................................................................................................................................................................................................................................................................................................................................................................................'</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">/ etc / runit / 3</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash PATH=/sbin:/bin:/usr/sbin:/usr/bin exec 2&gt; &gt;(sed 's/^/:: /') # set -v LAST=0 test -x /etc/runit/reboot &amp;&amp; LAST=6 echo 'Waiting for services to stop...' sv -w196 force-stop /etc/service/* sv exit /etc/service/* stty onlcr echo Shutdown... udevadm control --exit killall5 -15 i=10; while killall5 -18 &amp;&amp; (( i-- )) ; do echo -n .; sleep 0.5; done; echo killall5 -9 umount /tmp mount -o remount,ro / sleep 1 sync</span></span></code> </pre><br></div></div><br><br><h2>  Links </h2><br><br>  <a href="http://cr.yp.to/daemontools.html">cr.yp.to/daemontools.html</a> - ancestor runit (from DJ Bernstein) <br>  <a href="http://smarden.org/runit/">smarden.org/runit</a> - runit in person <br>  <a href="http://smarden.org/socklog/">smarden.org/socklog</a> - alternative to syslog <br>  <a href="https://github.com/chneukirchen/ignite">github.com/chneukirchen/ignite</a> - a set of init scripts for runit <br>  <a href="http://lwn.net/Articles/331818/">lwn.net/Articles/331818</a> - about how you can live without udevd <br>  <a href="http://metrotek.spb.ru/x10-24.html">metrotek.spb.ru/x10-24.html</a> - 10G switch, which uses the described mechanism <br>  <a href="http://habrahabr.ru/post/21205/">habrahabr.ru/post/21205</a> - How Linux boots <br></div><p>Source: <a href="https://habr.com/ru/post/264263/">https://habr.com/ru/post/264263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264253/index.html">Analysis of all tasks of the final round of Yandex. Algorithm 2015</a></li>
<li><a href="../264255/index.html">Best practices from Google to develop Android applications</a></li>
<li><a href="../264257/index.html">How site developers create the future of TV</a></li>
<li><a href="../264259/index.html">Banana Pi: via U-Boot to Arch Linux</a></li>
<li><a href="../264261/index.html">Research gaming settings</a></li>
<li><a href="../264269/index.html">Your cloud hosting in 5 minutes. Part 3: Consul, Registrator, Consul-Template</a></li>
<li><a href="../264271/index.html">Preparing ASP.NET5, issue number 2 - repeat the basics for the most beginners</a></li>
<li><a href="../264273/index.html">ESET & Intel Security on Black Hat USA 2015</a></li>
<li><a href="../264275/index.html">SIP registration, trunk, softphone and other scary words of cloud PBX</a></li>
<li><a href="../264277/index.html">HP is the leader of the Gartner Magic Quadrant for modular servers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>