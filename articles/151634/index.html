<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About how I ported Java to donet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A long time ago ... how long? yesterday! (C), that is, a couple of years ago, I ported one modest library from Java to .NET. And not just on .NET, but...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About how I ported Java to donet</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/029/6bd/882/0296bd882063d7ada6b6676b33d06e09.png" alt="image" align="left"><br><br>  A long time ago ... how long?  yesterday!  (C), that is, a couple of years ago, I ported one modest library from Java to .NET.  And not just on .NET, but on version 1.1. <br><br>  The approach is known - we take Sharpen in the mouth (or a converter from a visual studio of 2003, who likes what), and then with a jigsaw. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      About the obviousness with iterators, structures (" <b>System.Drawing.Size</b> is not an object") and I will not talk in streams - banalism.  But about some surprises - welcome. <br><br><a name="habracut"></a><br><br><h4>  Kultur-multur, who made you up? </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/c07/98f/9e6/c0798f9e62071b92bac2cb0b50874787.png" alt="image" align="right"><br>  Let's start with the simplest, for the seed.  From translating numbers to strings and back. <br><br><pre><code class="cs hljs">CultureInfo oldCulture = CurrentThread.CurrentCulture; CultureInfo oldCultureUI = CurrentThread.CurrentUICulture; CurrentThread.CurrentCulture = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CultureInfo(<span class="hljs-string"><span class="hljs-string">"en-US"</span></span>); CurrentThread.CurrentUICulture = CurrentThread.CurrentCulture; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { render_impl(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { CurrentThread.CurrentCulture = oldCulture; CurrentThread.CurrentUICulture = oldCultureUI; }</code> </pre> <br><br>  Well, why this crutch? <br><br>  And to write 100,500 times wrong, why else.  Like not to write <br><br><pre> <code class="cs hljs">(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) System.Double.Parse(foo_string, NumberStyles.Float, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CultureInfo(<span class="hljs-string"><span class="hljs-string">"en-US"</span></span>));</code> </pre>  and <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Double(foo_number).ToString(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CultureInfo(<span class="hljs-string"><span class="hljs-string">"en-US"</span></span>));</code> </pre><br>  Author lazy and parasite?  Otozh.  And what did you want - a week term, and joy fell down <br><br><pre> <code class="bash hljs">find ~/pd4ml/sources -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -<span class="hljs-built_in"><span class="hljs-built_in">print</span></span> | xargs cat | wc -l 420242</code> </pre> <br><br>  Why is this hack needed?  Because it is necessary to generate PDF, and the acrobat reader somehow does not respect the national commas in the form of separators of the fractional and integer parts.  And in HTML / CSS the same <i>local</i> - <i>specificity</i> somehow did not take root, hehe. <br><br><h4>  Features of paranoia in architecture </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/643/5b2/5a6/6435b25a61899aafc80d5cddf38ff508.png" alt="image" align="left"><br>  The original library <s>file contains neonku in</s> an obvious way.  If you need to give out a pack of different files, and also print to a printer and show on the screen, then <b>java.awt.Graphics2D is</b> inherited and there is a pack of <b>PDFDevice</b> , <b>RTFDevice</b> , etc. Obviously, <s>where did I go</s> that this method doesn‚Äôt work in detail?  <s>Together we say thank you to the Hindu who stuck the <b>sealed</b> anywhere.</s> <br><br>  I had to invent my own <b>abstract MegaDevice</b> , in which to bring the <b>System.Drawing.Context</b> contract and inherit from it.  Time spent on it was - guard.  And this is despite the fact that the output to the screen and to the printer just had to be thrown away. <br><br>  The logical question is: why was the Detnetov contract taken, not from java? <br><br>  The answer here is simple - the envelope is masterfully changed. <br><br><pre> <code class="java hljs"> g.drawString( prefix + index + <span class="hljs-string"><span class="hljs-string">" "</span></span>, x, y );</code> </pre><br>  on <br><pre> <code class="cs hljs"> g.DrawString( prefix + index + <span class="hljs-string"><span class="hljs-string">" "</span></span>, SupportClass.GraphicsManager.manager.GetFont(g), SupportClass.GraphicsManager.manager.GetBrush(g), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PointF(x, y));</code> </pre><br>  so I had to adapt to it.  The source code has not changed fundamentally - and then do not understand what is being ported, either the original glitches, or the introduced bugs. <br><br><h4>  State machines and signed / unsigned </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/e97/e11/17f/e97e1117f59454e7d4c6165c9f8767e9.png" alt="image" align="right"><br>  The following rake appeared with CSS parser.  Exactly the same ( <b>com.steadystate. *</b> ) Did not exist at the time of porting to the dotnet.  Yes, I know - it would be right to rewrite the grammar from JavaCC to ANTLR.  Watch for two or three hours, taking into account the timing and time lost in the previous step. <br><br>  But my laziness suggested to me another option - to convert an auto-generated footwoman.  It is only a kilobyte of three hundred, it is easy well.  And here - flooded. <br><br>  That is <s>, bits - they are different</s> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">URShift</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> number, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bits</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( number &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> number &gt;&gt; bits; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (number &gt;&gt; bits) + (<span class="hljs-number"><span class="hljs-number">2L</span></span> &lt;&lt; ~bits); }</code> </pre> <br>  and such - I do not forget to cast a long one with a sign in a long one without a sign, at the same time I tidy away the managed Identity: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>)active0 &amp; (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>)(<span class="hljs-number"><span class="hljs-number">0x8000103000000000</span></span>L)) != <span class="hljs-number"><span class="hljs-number">0L</span></span>) { jjmatchedKind = <span class="hljs-number"><span class="hljs-number">66</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">577</span></span>; }</code> </pre> <br>  I freshen up <b>goto</b> and <b>break label</b> in my memory, and then the generalka sculpts them everywhere: <br><br><pre> <code class="cs hljs">EOFLoop : <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { ... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((jjtoSkip[URShift(jjmatchedKind, <span class="hljs-number"><span class="hljs-number">6</span></span>)] &amp; (<span class="hljs-number"><span class="hljs-number">1L</span></span> &lt;&lt; (jjmatchedKind &amp; <span class="hljs-number"><span class="hljs-number">63</span></span>))) != <span class="hljs-number"><span class="hljs-number">0L</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (jjnewLexState[jjmatchedKind] != - <span class="hljs-number"><span class="hljs-number">1</span></span>) curLexState = jjnewLexState[jjmatchedKind]; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> EOFLoop; } ... } }</code> </pre> <br>  And rewrite the function FillBuf, and then streams - they also have ma-a-little differences.  From which the machine is sick and it never reaches the end of the file.  To be completely precise, it comes to the end and continues to try to read: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(inputStream == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.IO.IOException(<span class="hljs-string"><span class="hljs-string">"EOF"</span></span>); i = inputStream.ReadBlock(buffer, maxNextCharInd, available - maxNextCharInd); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">/* was == -1 */</span></span>) { inputStream.Close(); inputStream = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IOException(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> maxNextCharInd += i; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { --bufpos; backup(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tokenBegin == - <span class="hljs-number"><span class="hljs-number">1</span></span>) tokenBegin = bufpos; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> e; }</code> </pre><br>  This is how mass replacements in the text editor resolved the issue of porting the parser.  With "easy" - I still sat in a puddle, yes.  Day killed, but how killed - for a muddy job.  <s>"The expression <i>crap</i> was replaced with <i>garbage</i> 132 times, click OK</s> . <s>"</s> <br><br><h4>  Symbols and numbers and non-obviousness around them </h4><br><img src="http://openclipart.org/image/250px/svg_to_png/172244/Birne.png" alt="image" align="left"><br>  The next step was to support Unicode and right-to-left.  And here I was in for a surprise in the form of <b>java.lang.Character</b> .  Not only that between him and <b>System.Char in</b> common only in the title.  So also in dotnet <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">digit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> codePoint, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radix)</span></span></span></span></code> </pre><br>  in epsilon-neighborhood is not visible (and not only). <br><br>  Fifteen minutes googling did not suggest what this method can be replaced with, and a big stick went into action.  Namely, a piece of <b>java.lang. *</b> Was sported, relating to this function.  That is, <b>java.lang.Character</b> and <b>java.lang.CharacterData *</b> adjacent to it with all internal tables. <br><br>  <i>(ironically) And who said that Java is a worthless open source?</i> <br><br>  In the same scenario, <b>java.math.BigDecimal</b> was migrated.  These little differences - they are not encouraging, especially if in the code there are many where you come.  Yes, I have already said - am I a lazy man and a parasite?  This is it again. <br><br>  With BigDecimal, the magic setScale and the faithful toString () were needed: <br><br><pre> <code class="cs hljs"> BigDecimal d1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(currentLineThickness / <span class="hljs-number"><span class="hljs-number">2</span></span> + x ); BigDecimal d2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(currentLineThickness / <span class="hljs-number"><span class="hljs-number">2</span></span> + y ); d1 = d1.SetScale(<span class="hljs-number"><span class="hljs-number">4</span></span>, BigDecimal.ROUND_UP); d2 = d2.SetScale(<span class="hljs-number"><span class="hljs-number">4</span></span>, BigDecimal.ROUND_UP); buf.Append(d1.ToString()).Append(<span class="hljs-string"><span class="hljs-string">" "</span></span>); buf.Append(d2.ToString()).Append(<span class="hljs-string"><span class="hljs-string">" m\n"</span></span>);</code> </pre><br><br><h4>  Hashtable and tostring </h4><br><img src="http://openclipart.org/image/250px/svg_to_png/172073/exploration.png" alt="image" align="right"><br>  The next moment, which brought a lot of unpleasant moments, is the well-known commonplace with collections.  However, the Unknown Author (TM) masterfully made a knight's move - he built a cache around HTML attributes, and used ToString () as a key. <br><br>  <i>(thought out loud) I don‚Äôt like to add Hashmaps to Hashmaps, but many people like them.</i>  <i>Either enlightenment has not yet reached, or something else, but - I do not like.</i> <br><br>  Obviously, attributes are a set of <i>name = value</i> pairs.  That is - HashMap.  What does java do with its toString ()?  prints the contents of the collection.  And in dotnet - well, you know.  <i>Indian style coding detected</i> ? <br><br>  The solution was obvious and simple. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Hashtable map</span></span></span><span class="hljs-function">)</span></span> { String hta_str = <span class="hljs-string"><span class="hljs-string">"["</span></span>; IEnumerator ie = map.Keys.GetEnumerator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(ie.MoveNext()) { Object o = map[ie.Current]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(o <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Array) { Array al = (Array)o; hta_str += ie.Current + <span class="hljs-string"><span class="hljs-string">"=["</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> jjk=<span class="hljs-number"><span class="hljs-number">0</span></span>;jjk&lt;al.Length;++jjk) hta_str += al.GetValue(jjk) + <span class="hljs-string"><span class="hljs-string">","</span></span>; hta_str += <span class="hljs-string"><span class="hljs-string">"]"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> hta_str += ie.Current + <span class="hljs-string"><span class="hljs-string">"="</span></span> + o + <span class="hljs-string"><span class="hljs-string">","</span></span>; } hta_str += <span class="hljs-string"><span class="hljs-string">"]"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hta_str; }</code> </pre><br><br>  I didn‚Äôt even bother to copy ‚Äúas in Zhave‚Äù - I just needed some kind of display in the text instead of Hashtable @ address. <br><br><h4>  Sweet - work with fonts </h4><br><img src="http://openclipart.org/image/250px/svg_to_png/172104/sextant.png" alt="image" align="left"><br>  And at the end of the curtain - I want to please with another pearl - work with fonts.  For half of the library is only engaged in magic - substitutions, selections, switching from left-to-right in right-to-left and vice versa, Arabic, Chinese, automatic change of Arial to Mincho and so on and so forth. <br><br>  Without half a liter to eat this - it was something with something. <br><br>  <i>By the way, it immensely delivers that Windows OpenType itself is eating with a whistle, but .NET - alas.</i>  <i>Although he is in the variation of <s>"sausage"</s> silverlight - yes.</i>  <i>And this is in 4.0, what can we say about archaic 1.1!</i>  <i>Waiting for 5.0 - maybe there will add?</i>  . <br><br>  Here, for example, I had to completely rewrite the code for getting fonts from the specified directory. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">listFonts</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DirectoryInfo dd, String mask, Hashtable listOfFontFaces</span></span></span><span class="hljs-function">)</span></span> { FileInfo[] files = dd.GetFiles(mask); FontFamily newFN = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> TtC = mask.Equals(<span class="hljs-string"><span class="hljs-string">"*.ttc"</span></span>); Hashtable foundFonts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Hashtable(); System.Drawing.Text.PrivateFontCollection tmpPfc = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> jjk=<span class="hljs-number"><span class="hljs-number">0</span></span>;jjk&lt;files.Length;++jjk) { tmpPfc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Drawing.Text.PrivateFontCollection(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { tmpPfc.AddFontFile(files[jjk].FullName); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception <span class="hljs-comment"><span class="hljs-comment">/* e */</span></span>) {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> jjv=<span class="hljs-number"><span class="hljs-number">0</span></span>;jjv&lt;tmpPfc.Families.Length;++jjv) { newFN = tmpPfc.Families[jjv]; FontFamilySpec spec = (FontFamilySpec)foundFonts[newFN.Name]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(spec == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { spec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FontFamilySpec(newFN.Name); foundFonts[spec.Family] = spec; } String fn = files[jjk].Name; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(TtC) fn += <span class="hljs-string"><span class="hljs-string">"_"</span></span> + jjv; spec.Files.Add(fn); spec.Files.Sort(); } tmpPfc.Dispose(); } ... }</code> </pre> <br>  The code is obviously undocumented <s>, but it works</s> . <br><br>  And here is another magic: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = content[ <span class="hljs-number"><span class="hljs-number">0</span></span> ]; UnicodeCategory prevUB = Char.GetUnicodeCategory(c); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lastCutPosition = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; content.Length; i++ ) { c = content[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( c == <span class="hljs-number"><span class="hljs-number">0xAD</span></span> || c == <span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-comment"><span class="hljs-comment">// soft hyphen continue; byte dirct = java.lang.Character.getDirectionality((int)c); if ( dirct == java.lang.Character.DIRECTIONALITY_RIGHT_TO_LEFT_ARABIC || dirct == java.lang.Character.DIRECTIONALITY_RIGHT_TO_LEFT || dirct == java.lang.Character.DIRECTIONALITY_RIGHT_TO_LEFT_EMBEDDING || dirct == java.lang.Character.DIRECTIONALITY_RIGHT_TO_LEFT_OVERRIDE ) // sick of fighting with. // the only expected conflict is a combining of chinese and arabic in a single paragraph break; UnicodeCategory ub = Char.GetUnicodeCategory(c); if ( ub != prevUB ) { String pattern = ""; for ( int j = 0; j &lt; content.Length; j++ ) { char ch = content[j]; if ( prevUB == Char.GetUnicodeCategory(c) ) pattern += ch; } ... prevUB = ub; } } ...</span></span></code> </pre><br>  Here, in general, compote came out - and pre-Net tools, and ported in insolently from Java6 sources - each creature in a pair.  Very unobvious tricks. <br><br>  <i>To tame this fish was not easy at all.</i>  <i>I swear to my cocked hat!</i>  <i>(WITH)</i> <br><br><h4>  Results </h4><br><img src="http://openclipart.org/image/250px/svg_to_png/172012/prize.png" alt="image" align="left"><br>  Alas, I didn‚Äôt shamefully invest in the allotted week, grabbed another weekend, and a couple of days after them.  And then a couple of times came back with catching unobvious rake. <br><br>  The client then sent my experiments to the authors, and they soon had an official version under the dotnet.  No relation to further development, etc. I have not. <br><br>  General impressions from acquaintance with the original code were very positive.  Nowadays, universal webkitization to make your own HTML 4 render with HTML 5 elements, with CSS 2.1 support, and all this pure Java is real old school. <br><br>  Not a single animal suffered during porting. <br><br>  I hope this information will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/151634/">https://habr.com/ru/post/151634/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151628/index.html">Neurobiology and artificial intelligence: part one - educational program</a></li>
<li><a href="../151629/index.html">We glue several pdf files into one using Mac OS</a></li>
<li><a href="../151631/index.html">Common Event Format inside</a></li>
<li><a href="../151632/index.html">Office 365 sync with AD DS, use AD FS 2.0 to create a Single Sign-On</a></li>
<li><a href="../151633/index.html">2GIS data on Rambler Maps</a></li>
<li><a href="../151635/index.html">Erasmus Mundus Scholarship for Higher Education in Europe</a></li>
<li><a href="../151637/index.html">Apple encodes video using JPEG, JSON and <canvas></a></li>
<li><a href="../151638/index.html">How Larry Laffer spoke in Russian or About the interpreters of the Sierra quests</a></li>
<li><a href="../151639/index.html">A simple but illustrative example of using TDD</a></li>
<li><a href="../151640/index.html">Stencil Buffer Implementation Example with CUDA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>