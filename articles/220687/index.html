<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Custom types in Qt over D-Bus</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√© there were articles about D-Bus in Qt ( once ) and slightly affected the user types ( two ). Here we will consider the implementation of the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Custom types in Qt over D-Bus</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/4bd/72e/04f/4bd72e04f0248ce3ea2a17ae5c2f0dce.png" alt="image" align="left">  On Habr√© there were articles about D-Bus in Qt ( <a href="http://habrahabr.ru/post/185212/">once</a> ) and slightly affected the user types ( <a href="http://habrahabr.ru/post/185950/">two</a> ).  Here we will consider the implementation of the transfer of custom types, related features, workarounds. <br>  The article will be in the form of a memo, with a small inset of snippets, both for yourself and for your colleagues. <br>  <sub>Note: It was studied under Qt 4.7 (Thanks to Squeeze for this ...), so some actions may be useless.</sub> <br><a name="habracut"></a><br><br><h4>  Introduction </h4><br>  Standard types, for the transfer of which no unnecessary gestures are required, are in the <a href="http://qt-project.org/doc/qt-4.7/qdbustypesystem.html">dock</a> .  Also implemented the ability to transfer via D-Bus type QVariant ( <a href="http://qt-project.org/doc/qt-4.7/qdbusvariant.html">QDBusVariant</a> ).  This allows you to transfer the types that QVariant can take in the constructor - from the QRect to QVariantList and QVariantMap (two-dimensional arrays do not work as expected).  There is a temptation to transfer your types by converting them to QVariant.  Personally, I would recommend to refuse such a method, since the receiving party will not be able to distinguish between several different types - they will all be for her QVariant.  In my opinion, this can potentially lead to errors and complicate support. <br><br><h4>  Cooking your types </h4><br>  First we describe the types that will be used in applications. <br>  The first type will be Money <br><div class="spoiler">  <b class="spoiler_title">[Money]</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Money</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> summ; QString type; Money() : summ(<span class="hljs-number"><span class="hljs-number">0</span></span>) , type() {} };</code> </pre> </div></div><br>  First you need to declare it in the type system: <br> <code>&lt;Q_DECLARE_METATYPE(Money)&gt;</code> <br>  Before the start of the transfer type, you must call the function to register the type <br> <code>&lt;qRegisterMetaType&lt;Money;&gt;("Money"); <br> qDBusRegisterMetaType&lt;Money;&gt;();&gt;</code> <br>  To be able to transfer it via D-Bus, you need to add methods for parsing and collecting it into <a href="http://qt-project.org/doc/qt-4.7/qdbustypesystem.html">standard types</a> (marshalling &amp; demarshalling). <br><div class="spoiler">  <b class="spoiler_title">marshalling &amp; demarshalling</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> QDBusArgument&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &lt;&lt;(QDBusArgument&amp; argument, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Money&amp; arg) { argument.beginStructure(); argument &lt;&lt; arg.summ; argument &lt;&lt; arg.type; argument.endStructure(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> argument; } <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QDBusArgument&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &gt;&gt;(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QDBusArgument&amp; argument, Money&amp; arg) { argument.beginStructure(); argument &gt;&gt; arg.summ; argument &gt;&gt; arg.type; argument.endStructure(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> argument; }</code> </pre></div></div><br>  In order not to be so boring, add a few more types.  Completely files with types look like this: <br><div class="spoiler">  <b class="spoiler_title">[types.h]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;QString&gt; #include &lt;QDateTime&gt; #include &lt;QMap&gt; #include &lt;QMetaType&gt; #include &lt;QtDBus&gt; //   D-Bus     namespace dbus { static QString serviceName() { return "org.student.interface"; } static QString servicePath() { return "/org/student/interface"; } } struct Money { int summ; QString type; Money() : summ(0) , type() {} friend QDBusArgument &amp;operator&lt;&lt;(QDBusArgument &amp;argument, const Money &amp;arg); friend const QDBusArgument &amp;operator&gt;&gt;(const QDBusArgument &amp;argument, Money &amp;arg); }; Q_DECLARE_METATYPE(Money) struct Letter { Money summ; QString text; QDateTime letterDate; Letter() : summ() , text() , letterDate() {} friend QDBusArgument &amp;operator&lt;&lt;(QDBusArgument &amp;argument, const Letter &amp;arg); friend const QDBusArgument &amp;operator&gt;&gt;(const QDBusArgument &amp;argument, Letter &amp;arg); }; Q_DECLARE_METATYPE(Letter) //      typedef QList&lt;QVariant&gt; Stuff; Q_DECLARE_METATYPE(Stuff) struct Parcel { Stuff someFood; Letter letter; Parcel() : someFood() , letter() {} friend QDBusArgument &amp;operator&lt;&lt;(QDBusArgument &amp;argument, const Parcel &amp;arg); friend const QDBusArgument &amp;operator&gt;&gt;(const QDBusArgument &amp;argument, Parcel &amp;arg); }; Q_DECLARE_METATYPE(Parcel)</span></span></span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">[types.cpp]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"types.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;QMetaType&gt; #include &lt;QtDBus&gt; //    static struct RegisterTypes { RegisterTypes() { qRegisterMetaType&lt;Money&gt;("Money"); qDBusRegisterMetaType&lt;Money&gt;(); qRegisterMetaType&lt;Letter&gt;("Letter"); qDBusRegisterMetaType&lt;Letter&gt;(); qRegisterMetaType&lt;Stuff&gt;("Stuff"); qDBusRegisterMetaType&lt;Stuff&gt;(); qRegisterMetaType&lt;Parcel&gt;("Parcel"); qDBusRegisterMetaType&lt;Parcel&gt;(); } } RegisterTypes; //------------------------ QDBusArgument&amp; operator &lt;&lt;(QDBusArgument&amp; argument, const Money&amp; arg) { argument.beginStructure(); argument &lt;&lt; arg.summ; argument &lt;&lt; arg.type; argument.endStructure(); return argument; } const QDBusArgument&amp; operator &gt;&gt;(const QDBusArgument&amp; argument, Money&amp; arg) { argument.beginStructure(); argument &gt;&gt; arg.summ; argument &gt;&gt; arg.type; argument.endStructure(); return argument; } //------------------------ QDBusArgument&amp; operator &lt;&lt;(QDBusArgument&amp; argument, const Letter&amp; arg) { argument.beginStructure(); argument &lt;&lt; arg.summ; argument &lt;&lt; arg.text; argument &lt;&lt; arg.letterDate; argument.endStructure(); return argument; } const QDBusArgument&amp; operator &gt;&gt;(const QDBusArgument&amp; argument, Letter&amp; arg) { argument.beginStructure(); argument &gt;&gt; arg.summ; argument &gt;&gt; arg.text; argument &gt;&gt; arg.letterDate; argument.endStructure(); return argument; } //------------------------ QDBusArgument&amp; operator &lt;&lt;(QDBusArgument&amp; argument, const Parcel&amp; arg) { argument.beginStructure(); argument &lt;&lt; arg.someFood; argument &lt;&lt; arg.letter; argument.endStructure(); return argument; } const QDBusArgument&amp; operator &gt;&gt;(const QDBusArgument&amp; argument, Parcel&amp; arg) { argument.beginStructure(); argument &gt;&gt; arg.someFood; argument &gt;&gt; arg.letter; argument.endStructure(); return argument; }</span></span></span></span></code> </pre></div></div><br>  I note that for the use of arrays QList can be used and they do not require marshallization and unmarshallization, if variables already have transformations. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/27d/882/43d/27d88243d140d55b2bb22f2184a008e9.png" align="right"><h4>  We start to build </h4><br>  Suppose there are two Qt applications that need to communicate via D-Bus.  One application will be registered as a service, and the second will interact with this service. <br><br>  I'm lazy and I'm too lazy to create a separate QDBus adapter.  Therefore, in order to separate the internal methods and the D-Bus interface, I note the interface methods with the Q_SCRIPTABLE macro. <br><div class="spoiler">  <b class="spoiler_title">[student.h]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;QObject&gt; #include "../lib/types.h" class Student : public QObject { Q_OBJECT Q_CLASSINFO("D-Bus Interface", "org.student.interface") public: Student(QObject *parent = 0); ~Student(); signals: Q_SCRIPTABLE Q_NOREPLY void needHelp(Letter reason); void parcelRecived(QString parcelDescription); public slots: Q_SCRIPTABLE void reciveParcel(Parcel parcelFromParents); void sendLetterToParents(QString letterText); private: void registerService(); };</span></span></span></span></code> </pre></div></div><br>  The Q_NOREPLY tag notes that D-Bus should not wait for a response from the method. <br>  To register a service with methods marked Q_SCRIPTABLE, the following code is used: <br><div class="spoiler">  <b class="spoiler_title">[Registration service]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Student::registerService() { QDBusConnection connection = QDBusConnection::connectToBus(QDBusConnection::SessionBus, dbus::serviceName()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!connection.isConnected()) qDebug()&lt;&lt;(QString(<span class="hljs-string"><span class="hljs-string">"DBus connect false"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> qDebug()&lt;&lt;(QString(<span class="hljs-string"><span class="hljs-string">"DBus connect is successfully"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!connection.registerObject(dbus::servicePath(), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, QDBusConnection::ExportScriptableContents)) { qDebug()&lt;&lt;(QString(<span class="hljs-string"><span class="hljs-string">"DBus register object false. Error: %1"</span></span>).arg(connection.lastError().message())); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> qDebug()&lt;&lt;(QString(<span class="hljs-string"><span class="hljs-string">"DBus register object successfully"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!connection.registerService(dbus::serviceName())) { qDebug()&lt;&lt;(QString(<span class="hljs-string"><span class="hljs-string">"DBus register service false. Error: %1"</span></span>).arg(connection.lastError().message())); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> qDebug()&lt;&lt;(QString(<span class="hljs-string"><span class="hljs-string">"DBus register service successfully"</span></span>)); }</code> </pre></div></div><br>  Fully cpp file looks like this: <br><div class="spoiler">  <b class="spoiler_title">[student.cpp]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"student.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;QDBusConnection&gt; #include &lt;QDebug&gt; #include &lt;QDBusError&gt; Student::Student(QObject *parent) : QObject(parent) { registerService(); } Student::~Student() { } void Student::reciveParcel(Parcel parcelFromParents) { QString letterText = parcelFromParents.letter.text; letterText.append(QString("\n Money: %1 %2").arg(parcelFromParents.letter.summ.summ).arg(parcelFromParents.letter.summ.type)); Stuff sendedStuff = parcelFromParents.someFood; QString stuffText; foreach(QVariant food, sendedStuff) { stuffText.append(QString("Stuff: %1\n").arg(food.toString())); } QString parcelDescription; parcelDescription.append(letterText); parcelDescription.append("\n"); parcelDescription.append(stuffText); emit parcelRecived(parcelDescription); } void Student::sendLetterToParents(QString letterText) { Letter letterToParents; letterToParents.text = letterText; letterToParents.letterDate = QDateTime::currentDateTime(); emit needHelp(letterToParents); } void Student::registerService() { QDBusConnection connection = QDBusConnection::connectToBus(QDBusConnection::SessionBus, dbus::serviceName()); if (!connection.isConnected()) qDebug()&lt;&lt;(QString("DBus connect false")); else qDebug()&lt;&lt;(QString("DBus connect is successfully")); if (!connection.registerObject(dbus::servicePath(), this, QDBusConnection::ExportScriptableContents)) { qDebug()&lt;&lt;(QString("DBus register object false. Error: %1").arg(connection.lastError().message())); } else qDebug()&lt;&lt;(QString("DBus register object successfully")); if (!connection.registerService(dbus::serviceName())) { qDebug()&lt;&lt;(QString("DBus register service false. Error: %1").arg(connection.lastError().message())); } else qDebug()&lt;&lt;(QString("DBus register service successfully")); }</span></span></span></span></code> </pre></div></div><br>  This class can successfully work on D-Bus using standard constructions. <br>  To call the method of its interface, you can use QDBusConnection :: send: <br><div class="spoiler">  <b class="spoiler_title">[Call D-Bus method without response]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString studentMethod = <span class="hljs-string"><span class="hljs-string">"reciveParcel"</span></span>; QDBusMessage sendParcel = QDBusMessage::createMethodCall(dbus::serviceName(), dbus::servicePath(), <span class="hljs-string"><span class="hljs-string">""</span></span>, studentMethod); QList&lt;QVariant&gt; arg; arg.append(qVariantFromValue(parentsParcel)); sendParcel.setArguments(arg); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !QDBusConnection::sessionBus().send(sendParcel) ) { qDebug()&lt;&lt;QString(<span class="hljs-string"><span class="hljs-string">"D-bus %1 calling error: %2"</span></span>).arg(studentMethod).arg(QDBusConnection::sessionBus().lastError().message()); }</code> </pre></div></div><br>  The qVariantFromValue method using black magic, void pointers and what we registered type, converts it into QVariant.  You can get it back through the QVariant :: value method template or through qvariant_cast. <br><br>  If you need a method response, you can use other QDBusConnection methods for a synchronous call and for an asynchronous callWithCallback, asyncCall. <br><div class="spoiler">  <b class="spoiler_title">[Synchronous call D-Bus method waiting for an answer]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString studentMethod = <span class="hljs-string"><span class="hljs-string">"reciveParcel"</span></span>; QDBusMessage sendParcel = QDBusMessage::createMethodCall(dbus::serviceName(), dbus::servicePath(), <span class="hljs-string"><span class="hljs-string">""</span></span>, studentMethod); QList&lt;QVariant&gt; arg; arg.append(qVariantFromValue(parentsParcel)); sendParcel.setArguments(arg); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> timeout = <span class="hljs-number"><span class="hljs-number">25</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   ,    - 25  QDBusReply&lt;int&gt; reply = QDBusConnection::sessionBus().call(sendParcel, QDBus::Block, timeout); //QDBus::Block   (event loop)    if (!reply.isValid()) { qDebug()&lt;&lt;QString("D-bus %1 calling error: %2").arg(studentMethod).arg(QDBusConnection::sessionBus().lastError().message()); } int returnedValue = reply.value();</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">[Asynchronous call D-Bus method]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString studentMethod = <span class="hljs-string"><span class="hljs-string">"reciveParcel"</span></span>; QDBusMessage sendParcel = QDBusMessage::createMethodCall(dbus::serviceName(), dbus::servicePath(), <span class="hljs-string"><span class="hljs-string">""</span></span>, studentMethod); QList&lt;QVariant&gt; arg; arg.append(qVariantFromValue(parentsParcel)); sendParcel.setArguments(arg); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> timeout = <span class="hljs-number"><span class="hljs-number">25</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   ,    - 25  bool isCalled = QDBusConnection::sessionBus().callWithCallback(sendParcel, this, SLOT(standartSlot(int)), SLOT(errorHandlerSlot(const QDBusMessage&amp;)), timeout) if (!isCalled) { qDebug()&lt;&lt;QString("D-bus %1 calling error: %2").arg(studentMethod).arg(QDBusConnection::sessionBus().lastError().message()); }</span></span></code> </pre></div></div><br>  You can also use methods of the QDBusAbstractInterface class, in which QDBusMessage is not involved. <br>  By the way, to send signals there is no need to register the interface, they can be sent using the same send method: <br><div class="spoiler">  <b class="spoiler_title">[Sending signal]</b> <div class="spoiler_text"><pre> <code class="cpp hljs">QDBusMessage msg = QDBusMessage::createSignal(dbus::servicePath(), dbus::serviceName(), <span class="hljs-string"><span class="hljs-string">"someSignal"</span></span>); msg &lt;&lt; signalArgument; QDBusConnection::sessionBus().send(msg);</code> </pre></div></div><br>  Let's go back to the example.  Below is the class that interacts with the interface Student class. <br><div class="spoiler">  <b class="spoiler_title">[parents.h]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;QObject&gt; #include "../lib/types.h" class Parents : public QObject { Q_OBJECT public: Parents(QObject *parent = 0); ~Parents(); private slots: void reciveLetter(const Letter letterFromStudent); private: void connectToDBusSignal(); void sendHelpToChild(const Letter letterFromStudent) const; void sendParcel(const Parcel parentsParcel) const; Letter writeLetter(const Letter letterFromStudent) const; Stuff poskrestiPoSusekam() const; };</span></span></span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">[parents.cpp]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"parents.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;QDBusConnection&gt; #include &lt;QDebug&gt; Parents::Parents(QObject *parent) : QObject(parent) { connectToDBusSignal(); } Parents::~Parents() { } void Parents::reciveLetter(const Letter letterFromStudent) { qDebug()&lt;&lt;"Letter recived: "; qDebug()&lt;&lt;"Letter text: "&lt;&lt;letterFromStudent.text; qDebug()&lt;&lt;"Letter date: "&lt;&lt;letterFromStudent.letterDate; sendHelpToChild(letterFromStudent); } void Parents::connectToDBusSignal() { bool isConnected = QDBusConnection::sessionBus().connect( "", dbus::servicePath(), dbus::serviceName(), "needHelp", this, SLOT(reciveLetter(Letter))); if(!isConnected) qDebug()&lt;&lt;"Can't connect to needHelp signal"; else qDebug()&lt;&lt;"connect to needHelp signal"; } void Parents::sendHelpToChild(const Letter letterFromStudent) const { Parcel preparingParcel; preparingParcel.letter = writeLetter(letterFromStudent); preparingParcel.someFood = poskrestiPoSusekam(); sendParcel(preparingParcel); } void Parents::sendParcel(const Parcel parentsParcel) const { const QString studentMethod = "reciveParcel"; QDBusMessage sendParcel = QDBusMessage::createMethodCall(dbus::serviceName(), dbus::servicePath(), "", studentMethod); QList&lt;QVariant&gt; arg; arg.append(qVariantFromValue(parentsParcel)); sendParcel.setArguments(arg); if ( !QDBusConnection::sessionBus().send( sendParcel) ) { qDebug()&lt;&lt;QString("D-bus %1 calling error: %2").arg(studentMethod).arg(QDBusConnection::sessionBus().lastError().message()); } } Letter Parents::writeLetter(const Letter letterFromStudent) const { QString text = "We read about you problem so send some help"; Letter parentLetter; parentLetter.text = text; Money summ; summ.summ = letterFromStudent.text.count(",")*100; summ.summ += letterFromStudent.text.count(".")*50; summ.summ += letterFromStudent.text.count(" ")*5; summ.type = "USD"; parentLetter.summ = summ; parentLetter.letterDate = QDateTime::currentDateTime(); return parentLetter; } Stuff Parents::poskrestiPoSusekam() const { Stuff food; food&lt;&lt;"Russian donuts"; food&lt;&lt;"Meat dumplings"; return food; }</span></span></span></span></code> </pre></div></div><br>  You can download an example <a href="https://docs.google.com/file/d/0B62_ua_jXsGjR3lITlJaQ1dXQ00/edit%3Fpli%3D1">from here</a> . <br><img src="https://habrastorage.org/getpro/habr/post_images/224/995/629/2249956291e04023433bd1e66e1f5f4c.png" align="right"><h4>  If everything is not going so smoothly </h4><br>  When developing, I had a problem: when accessing the D-Bus interface of the program with custom types, the program crashed.  This was all decided by adding an xml interface description to the class using the Q_CLASSINFO macro.  For the example above, it looks like this: <br><div class="spoiler">  <b class="spoiler_title">[student.h]</b> <div class="spoiler_text"><pre> <code class="cpp hljs">‚Ä¶ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Student</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QObject { <span class="hljs-function"><span class="hljs-function">Q_OBJECT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q_CLASSINFO</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"D-Bus Interface"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"org.student.interface"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q_CLASSINFO</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"D-Bus Introspection"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"&lt;interface name=\"org.student.interface\"&gt;\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" &lt;signal name=\"needHelp\"&gt;\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" &lt;arg name=\"reason\" type=\"((is)s((iii)(iiii)i))\" direction=\"out\"/&gt;\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" &lt;annotation name=\"com.chameleon.QtDBus.QtTypeName.Out0\" value=\"Letter\"/&gt;\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" &lt;/signal&gt;\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" &lt;method name=\"reciveParcel\"&gt;\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" &lt;arg name=\"parcelFromParents\" type=\"(av((is)s((iii)(iiii)i)))\" direction=\"in\"/&gt;\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" &lt;annotation name=\"org.qtproject.QtDBus.QtTypeName.In0\" value=\"Parcel\"/&gt;\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" &lt;annotation name=\"org.freedesktop.DBus.Method.NoReply\" value=\"true\"/&gt;\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" &lt;/method&gt;\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Student</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QObject *parent = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; ‚Ä¶</code> </pre></div></div><br>  The type parameter of the arguments is their signature, it is described by <a href="http://dbus.freedesktop.org/doc/dbus-specification.html">the D-Bus specification</a> .  If you have a type marshalization, you can find out its signature using the undocumented features of QDBusArgument, namely its currentSignature () method. <br><div class="spoiler">  <b class="spoiler_title">[Getting type signature]</b> <div class="spoiler_text"><pre> <code class="cpp hljs">QDBusArgument arg; arg&lt;&lt;Parcel(); qDebug()&lt;&lt;<span class="hljs-string"><span class="hljs-string">"Parcel signature: "</span></span>&lt;&lt;arg.currentSignature();</code> </pre></div></div><br><br><h5>  Testing an interface with custom types </h5><br><h6>  Signal testing </h6><br>  To test the signals, you can use qdbusviewer - it can connect to the signal and show what kind of structure it sends.  Also, dbus-monitor may be suitable for this - after specifying an address, it will show all outgoing interface messages. <br><br><h6>  Testing methods </h6><br>  qdbusviewer does not call methods with custom types.  For these purposes, you can use d-feet.  Despite the fact that it is difficult for him to find intelligible documentation, he knows how to call methods with types of any complexity.  When working with him you need to consider some features: <br><div class="spoiler">  <b class="spoiler_title">[Work with d-feet]</b> <div class="spoiler_text">  Variables are separated by commas. <br><br>  Basic types (in brackets the designation in the signature): <br>  int (i) is a number (example: 42); <br>  bool (b) - 1 or 0; <br>  double (d) is a number with a dot (example: 3.1415); <br>  string (s) - string in quotes (example: "string"); <br>  Structures are taken in brackets ‚Äú(‚Äú and ‚Äú)‚Äù, variables are separated by a comma, commas must be put even when there is one element in the structure. <br>  Arrays are brackets ‚Äú[‚Äú and ‚Äù]‚Äù, variables separated by commas. <br><br>  Types Variant and Dict did not study, as there was no need. <br></div></div><br><br>  Thanks for attention. <br><br>  Used materials: <br>  <a href="http://habrahabr.ru/post/185212/">QtDbus - darkness, covered with mystery.</a>  <a href="http://habrahabr.ru/post/185212/">Part 1</a> , <a href="http://habrahabr.ru/post/185950/">Part 2</a> <br>  <a href="http://qt-project.org/doc/">Qt docs</a> <br>  <a href="http://dbus.freedesktop.org/doc/dbus-specification.html">D-Bus Specification</a> <br>  <a href="http://techbase.kde.org/Development/Tutorials/D-Bus">KDE D-Bus Tutorial</a> in general and <a href="http://techbase.kde.org/Development/Tutorials/D-Bus/CustomTypes">CustomTypes</a> in particular </div><p>Source: <a href="https://habr.com/ru/post/220687/">https://habr.com/ru/post/220687/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220673/index.html">NASA has published a long-term plan for landing a man on Mars</a></li>
<li><a href="../220675/index.html">Customer interaction with an outsourcing company</a></li>
<li><a href="../220679/index.html">Application launch in Vkontakte</a></li>
<li><a href="../220681/index.html">Common Web Designer Mistakes or How to Please the Layout Designer</a></li>
<li><a href="../220685/index.html">Network between offices with VLANs based on Mikrotik equipment</a></li>
<li><a href="../220689/index.html">As I wrote a custom locker</a></li>
<li><a href="../220695/index.html">HR research. The most popular programming language in the Siberian region, the average wage level and where our programmers want to move</a></li>
<li><a href="../220697/index.html">My [Credit] Cards for Android application</a></li>
<li><a href="../220699/index.html">How we increased conversion</a></li>
<li><a href="../220701/index.html">Fody and its plugins</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>