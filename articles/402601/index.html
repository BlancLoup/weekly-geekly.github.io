<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Visual Studio Code takes 13% of CPU resources due to cursor flicker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The fun problem # 22900 this week has attracted particular attention from Github users. 

 A detailed description of the problem is in the repository ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Visual Studio Code takes 13% of CPU resources due to cursor flicker</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/geektimes/post_images/3dc/383/0f6/3dc3830f6313207fe36950c4401543da.png"><br><br>  The fun problem <a href="https://github.com/Microsoft/vscode/issues/22900"># 22900</a> this week has attracted particular attention from Github users. <br><br>  A detailed description of the problem is in the repository of the Visual Studio Code <a href="https://github.com/Microsoft/vscode">Editor</a> ( <a href="https://github.com/Microsoft/vscode">vscode</a> ).  Open source developer Joe Liss (Jo Liss) is known as the creator of Broccoli and other free libraries.  On the project page, she noticed that Visual Studio Code uses 13% of the processor‚Äôs computational resources if the window is in focus.  Because of this, the battery on the laptop is wasted.  What could be the reason for such a strange behavior of the program? <br><a name="habracut"></a><br>  Joe Liss suggested that the CPU activity is associated with rendering the cursor flicker - the cursor state changes twice a second, that is, every 500 ms (2 fps). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To reproduce the problem, do the following steps: <br><br><ol><li>  Close all Visual Studio Code windows. </li><li>  Open a new window (File ‚Üí New Window). </li><li>  Open a new tab with an empty file (File ‚Üí New Tab).  The cursor is blinking. </li><li>  In the resource monitor, you will see a non-zero consumption of computing resources (13% on a weak laptop with OS X, about <a href="https://github.com/Microsoft/vscode/issues/22900">5-7%</a> on the powerful GNOME Shell with Wayland (Ivy Bridge Graphics)). </li><li>  Switch to another application window (Cmd + Tab).  The cursor is no longer visible. </li><li>  CPU consumption by the Visual Studio Code is reduced to almost zero. </li></ol><br>  Someone needs it, here are the Timeline records in the Developer Tools: <a href="">TimelineRawData-20170321T114212.json.zip</a> (see screenshot above). <br><br>  If you bring one frame closer, you can see that despite the flicker frequency of 2 fps, the main thread does some work at 60 fps, that is, it renders something every 16 ms. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/4f9/540/768/4f95407680850a6bce4d375e3f93ddb6.png"><br><br>  If you bring more closer, then you can see the concrete big work that the cursor renders at 60 frames / s.  These are periodic cycles ‚ÄúUpdate Layer Tree‚Äù / ‚ÄúPaint‚Äù / ‚ÄúComposite Layers‚Äù, i.e. update of the layer tree <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/b01/b71/cde/b01b71cde2c01ac92c37ee9c1ecae11e.png"><br><br>  The developer notes that in other macOS Sierra 10.12.3 applications, including Chrome and TextEdit, the cursor flickers without a noticeable consumption of CPU resources. <br><br>  Users of the Visual Studio Code Editor can disable cursor flickering in the program.  In this case, the CPU consumption is reduced to 0%.  The "Update Layer Tree" / "Paint" / "Composite Layers" cycles still work, but only every 500 ms, not every 16 ms. <br><br> <code>"editor.cursorBlinking": "solid"</code> <br> <br>  This funny glitch in Visual Studio Code resembles the classic <a href="https://github.com/npm/npm/issues/8826">problem with the brake indicator</a> in npm.  In the npm version 3.5.2, with the progress indicator turned on, this operation was performed approximately 50% slower than without the indicator. <br><br><pre> <code class="hljs sql">$ rm -r node_modules $ npm <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> progress=<span class="hljs-literal"><span class="hljs-literal">false</span></span> $ <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> <span class="hljs-number"><span class="hljs-number">19.91</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">2.66</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span>% cpu <span class="hljs-number"><span class="hljs-number">31.667</span></span> total $ rm -r node_modules $ npm <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> progress=<span class="hljs-literal"><span class="hljs-literal">true</span></span> $ <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> <span class="hljs-number"><span class="hljs-number">33.26</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">3.19</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span>% cpu <span class="hljs-number"><span class="hljs-number">48.733</span></span> total</code> </pre> <br><h1>  What is the reason </h1><br>  Of course, the consumption of CPU resources when the cursor is blinking has completely different reasons than slowing down npm with an active progress indicator.  The reasons for the problems with the cursor can be guessed if you look at <a href="https://bugs.chromium.org/p/chromium/issues/detail%3Fid%3D500259">almost the same bug</a> with the animation of the CSS keyframe in the Chrome browser.  There, the developers write that in JavaScript the flickering cursor takes away the normal 1.2% of CPU resources, and in CSS for some reason is 6 times more, that is, 7-8%. <br><br>  The code seems to be correct: <br><br><pre> <code class="hljs css">@<span class="hljs-keyword"><span class="hljs-keyword">keyframes</span></span> monaco-cursor-blink { 50% { <span class="hljs-attribute"><span class="hljs-attribute">opacity</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; } 100% { <span class="hljs-attribute"><span class="hljs-attribute">opacity</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-selector-class"><span class="hljs-selector-class">.cursor-blink</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">animation</span></span>: monaco-cursor-blink <span class="hljs-number"><span class="hljs-number">1s</span></span> step-start <span class="hljs-number"><span class="hljs-number">0s</span></span> infinite; }</code> </pre> <br>  But the problem is that the Chromium engine forcibly translates this animation at 60 fps, forcing it to perform work every 16 ms. <br><br>  So, Visual Studio Code Editor, obviously, uses the most logical approach for implementing the flickering cursor function: this is the <code>step</code> function with CSS keyframe animation.  But this bug in Chromium <a href="https://bugs.chromium.org/p/chromium/issues/detail%3Fid%3D361587">has not yet been completely fixed</a> , although it has been dragging on for more than two years.  So Chrome performs a full rendering cycle every 16 ms, as it should be for 60 frames per second.  Perhaps the current discussion will draw attention to the old bug - and the developers finally get their hands on it. <br><br>  The developers of Visual Studio Code <a href="https://github.com/Microsoft/vscode/issues/22900">admitted</a> that this feature was originally implemented in JavaScript, but about a year ago they switched to CSS.  In the current implementation, if the window is out of focus, then the animation is deactivated and there is no excessive consumption of processor resources, but the actual window is really a problem.  The developers believe that in such a situation, it makes sense to go back with CSS back to JS. <br><br>  Colleagues <a href="https://github.com/Microsoft/vscode/issues/22900">are advised</a> to think also about how to implement the cursor in the form of an animated gif.  You can generate such a file automatically, depending on the color of the editor.  True, there may be difficulty with zooming: still, raster graphics will become blurry when zooming. <br><br>  But in the end, the developers at Microsoft decided to return to the good old JS-method setInterval for cursor flicker - and the CPU consumption immediately <a href="https://github.com/Microsoft/vscode/issues/22900">decreased several times</a> . </div><p>Source: <a href="https://habr.com/ru/post/402601/">https://habr.com/ru/post/402601/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../402591/index.html">Anatomy of charm</a></li>
<li><a href="../402593/index.html">What will thawing permafrost lead to?</a></li>
<li><a href="../402595/index.html">Apple said that exploits published by WikiLeaks have long been closed</a></li>
<li><a href="../402597/index.html">Twitter plans to create a paid version of TweetDeck for professionals</a></li>
<li><a href="../402599/index.html">Ask Ethan: Does the climax of the movie "Gravity" violate the simple laws of physics?</a></li>
<li><a href="../402603/index.html">History of a single spectrum analyzer</a></li>
<li><a href="../402605/index.html">IBM and Visa will turn IoT devices into payment terminals</a></li>
<li><a href="../402607/index.html">Photo amateur photographer at various stages of its evolution</a></li>
<li><a href="../402609/index.html">WhatsApp, Telegram and front camera: how it works, how it should work and a little more about the correspondence with support</a></li>
<li><a href="../402611/index.html">Allocacoc PowerHUB: Mobile USB Splitter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>