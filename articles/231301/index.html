<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Migrating VMs from Xen 3.2 to XenServer 6.2 in Hetzner</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A bit of background 
 In 2010, for a private project, I got myself a small dedicated server at hezner.de. As time went on, hardware improved, Linux di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Migrating VMs from Xen 3.2 to XenServer 6.2 in Hetzner</h1><div class="post__text post__text-html js-mediator-article"><h4>  A bit of background </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/52a/241/7a3/52a2417a32e50ff564fb95c819413bca.gif" align="left">  In 2010, for a private project, I got myself a small dedicated server at hezner.de.  As time went on, hardware improved, Linux distributions were removed from those.  support, new tasks and opportunities appeared, and the resources for the full upgrade of software on the server were sorely lacking. <br><br>  Since the old server was virtualized, it was thought to take a new server and migrate all the old equipment to it, especially since hetzner had an EX40 server at an interesting price.  Compared to the old X3, the rental price grew slightly (about 8 euros if paid without VAT), but in terms of performance, this was a huge breakthrough.  The lack of a large amount of free time and a bit of installation cost (setup fee) per server hampered migration. <br><br>  A couple of weeks ago, I accidentally discovered that Hetzner is holding a campaign in July and is giving these pieces of iron without a setup fee.  Laziness and the toad were defeated, and there was some free time to carry out the saber process. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The action is held only in July, so who needs it - fly around, do not skimp, buy a painting! <br><a name="habracut"></a><br><h4>  Installing XenServer </h4><br>  Much has been written about the installation and configuration of XenServer, so this point can be omitted.  Detailed instructions for installation and configuration are also given in <a href="http://wiki.hetzner.de/index.php/Citrix_XenServer/en">the hetzner Wiki</a> . <br><br>  I posted the XenServer distribution kit and the answer file on the old server; there were no problems with the installation speed. <br><br>  Immediately after installing XenServer, I recommend adding an unprivileged user and close root access to ssh, as well as close access to the server for all networks except their own (if this is possible, of course).  In the future, you can install OpenVPN on one of the virtual machines and use all the advantages of managing via VPN.  After setting up these simplest server protection mechanisms, you can safely proceed to the preparation of the patient. <br><br>  I recommend combining disks (by the way, I‚Äôve got new ones) in RAID and split it with this consideration so that there is still some room left for connecting to dom0 as a repository of ISO images, backups, uploading software updates, and so on. <br><br>  Over the past year, since the release of 6.2, many updates have been released, so immediately after installing XenServer, it is highly recommended to update the software and install all the patches.  It is better to start with SP1, after installing which, a list of patches can be viewed through XenCenter and downloaded from the web at the indicated links (Tools / Check for Updates menu). <br>  Automatic update if you have not purchased TP, is impossible via XenCenter.  You must use CLI. <br>  To update the software, you need to copy all the patches in the dom0, unpack and execute the following commands for each patch: <br><pre><code class="bash hljs">xe patch-upload file-name=/mnt/disk/1.xsupdate xe patch-pool-apply uuid=UUID___</code> </pre> <br>  After installing updates, you need to restart the services with the command: <br><pre> <code class="bash hljs">xe-toolstack-restart</code> </pre><br>  The list of installed patches can be checked with the command: <br><pre> <code class="bash hljs">xe patch-list</code> </pre><br>  The XenServer 6.2 version uses Open vSwitch by default, so 99% of articles and comments on configuring the network environment do not fully fit (the part about configuring the xebr0: 1 network interface, although you can probably live with the dummy interface).  This problem is quite easy to manage: you can add additional local networks and interfaces to XenCenter (you need to select a server and open the Networking tab). <br>  After setting up an additional network, do not forget to configure iptables (Firewall and NAT) to communicate with the outside world (if you use private networks). <br><br><h4>  Migration of virtual machines </h4><br>  At the time of the idea of ‚Äã‚Äãmigrating virtual machines, my sclerosis remembered that I had virtualized my servers using LVM (almost guessed :).  Fortunately, logging on to the machine, I found that I had Xen 3.2 installed (para-virtualization was used), and this greatly simplified the task. <br><br>  To import virtual machines, I used the xva.py script, which can be downloaded <a href="http://www-archive.xenproject.org/files/xva/">here</a> . <br>  On the Xen 3.2 server for each virtual machine, you need to run the command: <br><pre> <code class="bash hljs">python xva.py -c /etc/xen/VM.cfg -n --sparse -s IP_XenServer --username=root --password=<span class="hljs-string"><span class="hljs-string">"Password"</span></span></code> </pre><br>  The virtual machine will automatically be transferred to the new server in a few minutes.  The export through the file took place many times longer (it didn‚Äôt measure the time, but the VM with a 32Gb disk was exported for more than an hour). <br>  If immediately after starting the script falls out with the message <br><pre> <code class="bash hljs">Unauthorised response from server. Exiting</code> </pre><br>  Check if you are using a password.  I had a problem with a dot ("."). <br><br>  If, after successfully completing the export / import, you received the message below, then you will need to tweak something else on the dom0 and in the virtual machine. <br><pre> <code class="bash hljs">VM Successfully streamed With the options you supplied, you will need to SFTP/SCP the kernel/initrd to the server manually Create the /boot/guest/208f7a74-126e-11e4-8a8c-002185153241 directory Copy /boot/vmlinuz-2.6.26-2-xen-amd64 to /boot/guest/208f7a74-126e-11e4-8a8c-002185153241/vmlinuz and copy /boot/initrd.img-2.6.26-2-xen-amd64 to /boot/guest/208f7a74-126e-11e4-8a8c-002185153241/initrd Copy these to _all_ the nodes <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the pool</code> </pre><br>  Namely, copy the vmlinuz- * and initrd- * files from dom0 Xen 3.2 to dom0 XenServer. <br>  Since I needed to transfer 3 virtual machines with one kernel, I did not create separate directories for them (maybe in vain), but created one / boot / guest / lenny directory into which I placed the specified files. <br><br>  In order for these virtual machines to boot, you need to properly configure the settings of the PV-kernel, PV-ramdisk.  In my case, I also had to clear the PV-bootloader parameter, which interfered with my work. <br>  To configure the parameters of virtual machines, you must run the following commands: <br><pre> <code class="bash hljs">xe vm-param-set uuid=UUID_VM PV-bootloader xe vm-param-set uuid=UUID_VM PV-kernel=<span class="hljs-string"><span class="hljs-string">"/boot/guest/lenny/vmlinuz"</span></span> xe vm-param-set uuid=UUID_VM PV-ramdisk=<span class="hljs-string"><span class="hljs-string">"/boot/guest/lenny/initrd"</span></span></code> </pre><br>  UUID_VM - virtual machine identifier (can be viewed with the xe vm-list command) <br><br>  Now you can try to boot.  In case of failure, do not turn off the virtual machine, but look at the path to the root device, under which disks / partitions in your virtual machine are visible (in the XenCenter, the Storage tab, ‚ÄúDevice Path‚Äù parameter).  You must edit the PV-args parameter or via CLI or XenCenter.  I set the following parameters: <br><pre> <code class="bash hljs">root=/dev/xvda ro clocksource=jiffies</code> </pre><br>  We are trying to load again. <br>  After successfully loading the OS, do not forget to fix the / etc / fstab file (specify the correct location of the swap) and install the XenServer Tools.  For Debian Lenny, the xe-guest-utilities_6.2.0-1137_amd64.deb package is suitable. <br><br>  It seems to be all.  It remains only until the end of the month to backup the old server and give back to Hetzner. <br>  Vadim pavlov </div><p>Source: <a href="https://habr.com/ru/post/231301/">https://habr.com/ru/post/231301/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231289/index.html">Experience in the development and production of prototypes of BLE sockets</a></li>
<li><a href="../231293/index.html">E-Commerce Today: Art and Science</a></li>
<li><a href="../231295/index.html">Images in the layout. Enough tolerating this</a></li>
<li><a href="../231297/index.html">Squares game</a></li>
<li><a href="../231299/index.html">Overview of manufacturers of consumables for FDM 3D printers</a></li>
<li><a href="../231303/index.html">Hackspace Dim Sum Labs in Hong Kong</a></li>
<li><a href="../231305/index.html">Creating a project management system for Yandex Tolstoy Camp. Part 2</a></li>
<li><a href="../231309/index.html">Replacing HDD through official service and support of Western Digital in Russia</a></li>
<li><a href="../231311/index.html">Android and MikroTik</a></li>
<li><a href="../231313/index.html">"Building successful distributed teams" by Matthew Aldridge, in Kiev on July 31</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>