<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SSH VPN over Internet (SSH tun tunneling)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There was a need to organize a tunnel between your work computer and the home server, with the subsequent transport of all work traffic through the ho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SSH VPN over Internet (SSH tun tunneling)</h1><div class="post__text post__text-html js-mediator-article"> There was a need to organize a tunnel between your work computer and the home server, with the subsequent transport of all work traffic through the home server to the Internet. <br><br>  To solve this problem, the best technology is Vitual Private Network (VPN).  But with what help to implement this technology? <br>  - I chose SSH. <br>  The fact is that OpenSSH since version 4.3 supports tun tunneling.  I took advantage of this ... <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Schematically it will look like this: <br><br><img src="https://habrastorage.org/storage3/0b4/902/32f/0b490232f7eff5e98e3094cb86047e15.jpg"><br><br>  First you need to install OpenSSH on the server.  I have Ubuntu Server, and I do it like this: <br><br> <code>sudo aptitude install openssh-server <br></code> <br>  Although, most likely, it is already installed.  I have - exactly installed;) <br><br>  Take a look at a more detailed scheme, and discuss it. <br><br><img src="https://habrastorage.org/storage3/888/4d8/238/8884d8238e0c6bffc3cd232551652187.png"><br><br>  As can be seen from the figure, the work computer has IP 172.16.0.1 with a mask of 255.255.255.0 and a default gateway of 172.16.0.254, and IP 8.8.8.8 is specified as the DNS <br><br> <code> Work: <br> IP address: 172.16.0.1 <br> Netmask: 255.255.255.0 <br> Default Gateway: 172.16.0.254 <br> DNS: 8.8.8.8 <br></code> <br>  Client routing table (Work): <br><br><pre>   172.16.0.0 0.0.0.0 255.255.255.0 U 1 0 0 eth0
   169.254.0.0 0.0.0.0 255.255.0.0 U 1000 0 0 eth0
   0.0.0.0 172.16.0.254 0.0.0.0 UG 0 0 0 eth0 </pre><br><h6>  169.254.0.0 is the <a href="http://ru.wikipedia.org/wiki/Zeroconf">zeroconf</a> route. </h6><br>  To organize a tunnel, tunneling must be enabled in the OpenSSH configuration file.  In <code>/etc/ssh/sshd_config</code> , add the line <code>PermitTunnel point-to-point</code> and restart the OpenSSH server <code>service ssh restart</code> <br><h6>  <i><b>Nuances:</b></i> <i><br></i>  <i>The fact is that in order to organize a tunnel, you need to log in to the server as root, which is not good!</i>  <i>Therefore, there are two solutions to the problem:</i> <i><br></i>  <i>1. We put on root a complex password like md5 hash.</i> <i><br></i>  <i>2. Set up authorization by keys.</i> <i><br></i>  <i>Which method to choose is up to you.</i>  <i>For the example I am describing, this is irrelevant.</i> <i><br></i>  <i>If you want to use password authentication, enable PermitRootLogin yes in the config so that you can log in as root.</i> </h6><br>  Connecting to the server and creating a tunnel is done using the command <code>sudo ssh root@74.125.87.104 -w 0:0</code> <br><h6>  Be sure to do it via sudo or root.  A tun device will be created, which requires privileges. </h6><br>  The -w switch will create tun0 devices on the server and client, combining them together. <br>  Here is the description from the man. <br> <code>-w local_tun[:remote_tun] <br> <b>Requests tunnel device</b> forwarding with the specified <b>tun</b> (4) devices <b>between the client</b> (local_tun) <b>and the server</b> (remote_tun) <br></code> <br>  Tun tun devices. <br>  On the <code>ifconfig tun0 10.0.0.1/30 pointopoint 10.0.0.2</code> <br>  On the <code>ifconfig tun0 10.0.0.2/30 pointopoint 10.0.0.1</code> <br><br>  You can test using ping (from the client's computer): <br><pre>     user @ host: ~ $ ping 10.0.0.1 -c 2
     PING 10.0.0.1 (10.0.0.1) 56 (84) bytes of data.
     64 bytes from 10.0.0.1: icmp_seq = 1 ttl = 64 time = 5.80 ms
     64 bytes from 10.0.0.1: icmp_seq = 2 ttl = 64 time = 8.61 ms

     --- 10.0.0.1 ping statistics ---
     2 packets transmitted, 2 received, 0% packet loss, time 1001ms
     rtt min / avg / max / mdev = 5.800 / 7.209 / 8.618 / 1.409 ms
</pre><br>  Now you need to start all traffic through tun0, for this you just need to specify tun0 as the default gateway, but you will lose connection with the server (Home Server) and DNS server.  Therefore, before deleting the current default gateway (172.16.0.254), you must add routes to the server and DNS server in the routing table.  What can be done as follows: <br> <code><br> route add -host 74.125.87.104 gw 172.16.0.254 <br> route add -host 8.8.8.8 gw 172.16.0.254 <br></code> <br>  After that, we delete the current default gateway (172.16.0.254) and specify the IP address that we assigned on the server tun0 interface (10.0.0.1) as the gateway <br> <code><br> route del default <br> route add default gw 10.0.0.1 <br></code> <br>  After completing the above steps, the client's routing table (Work) takes the following form: <br><pre>     74.125.87.104 172.16.0.254 255.255.255.255 UGH 0 0 0 eth0
     8.8.8.8 172.16.0.254 255.255.255.255 UGH 0 0 0 eth0
     10.0.0.0 0.0.0.0 255.255.255.252 U 0 0 0 tun0
     172.16.0.0 0.0.0.0 255.255.255.0 U 1 0 0 eth0
     169.254.0.0 0.0.0.0 255.255.0.0 U 1000 0 0 eth0
     0.0.0.0 10.0.0.1 0.0.0.0 UG 0 0 0 tun0
</pre><br>  Now all traffic that goes to unknown subnets, and all unknowns, except addresses 8.8.8.8 and 74.125.87.104, goes through 10.0.0.1, that is, through an <b>encrypted</b> SSH tunnel.  But the server does not do anything with it, traffic.  Because you need to configure NAT for the client.  To do this, add a rule to iptables <br> <code><br> iptables -t nat -A POSTROUTING -s 10.0.0.2 -j MASQUERADE <br></code> <br>  Enable ip forward-ing in the kernel <br> <code><br> sysctl -w net.ipv4.ip_forward=1 <br></code> <br>  Do not forget to make it so that it turns on when the system boots ... <br> <code><br> mcedit /etc/sysctl.conf <br></code> <br><h6>  PS&gt; mcedit is a text editor.  You can use any other. </h6><br>  We find the commented line <code>net.ipv4.ip_forward=1</code> and uncomment it. <br><br>  All, <b>mission complete</b> , now all traffic is sent through the ssh tunnel and NAT to the Internet.  The tunnel is encrypted, the traffic to the server is protected! </div><p>Source: <a href="https://habr.com/ru/post/87197/">https://habr.com/ru/post/87197/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../87184/index.html">The easiest thumb</a></li>
<li><a href="../87187/index.html">We are eager to make a social media conference!</a></li>
<li><a href="../87189/index.html">III Annual Conference "PR on the Internet"</a></li>
<li><a href="../87194/index.html">Deal on a million</a></li>
<li><a href="../87196/index.html">New technology transfer of emotions on a mobile phone</a></li>
<li><a href="../87198/index.html">Poison began to massively block accounts?</a></li>
<li><a href="../87199/index.html">Git on Windows in Technicolor</a></li>
<li><a href="../87201/index.html">Simple Time Manager for Android</a></li>
<li><a href="../87202/index.html">Development by testing with Zend Framework and PHPUnit</a></li>
<li><a href="../87205/index.html">OOP with examples (part 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>