<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploy OpenSource Puppet 4 with multiple puppet masters. Part II. Puppet Masters Setup</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚Üí Deploying OpenSource Puppet 4 with multiple Puppet masters. Part I. Preparatory 
 ‚Üí Deploying OpenSource Puppet 4 with multiple Puppet masters. Part...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deploy OpenSource Puppet 4 with multiple puppet masters. Part II. Puppet Masters Setup</h1><div class="post__text post__text-html js-mediator-article">  ‚Üí <a href="https://habrahabr.ru/post/316400/">Deploying OpenSource Puppet 4 with multiple Puppet masters.</a>  <a href="https://habrahabr.ru/post/316400/">Part I. Preparatory</a> <br>  ‚Üí <a href="https://habrahabr.ru/post/316486/">Deploying OpenSource Puppet 4 with multiple Puppet masters.</a>  <a href="https://habrahabr.ru/post/316486/">Part III.</a>  <a href="https://habrahabr.ru/post/316486/">Setting up puppet-db with Puppet</a> <br><br><h2>  Configure puppet servers </h2><br>  General server settings.  On puppet-master01, puppet-master02 servers and puppet-db, add puppetlabs repositories: <br><br><pre><code class="bash hljs">wget https://apt.puppetlabs.com/puppetlabs-release-pc1-xenial.deb sudo dpkg -i puppetlabs-release-pc1-xenial.deb sudo apt update</code> </pre> <br>  On the puppet-master01, puppet-master02 servers, install the puppet server: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs">sudo apt install puppetserver</code> </pre> <br>  Check the address, port and authorization requirement in the /etc/puppetlabs/puppetserver/conf.d/webserver.conf file, the default should be: <br><br><pre> <code class="bash hljs">client-auth: want ssl-host: 0.0.0.0 ssl-port: 8140</code> </pre> <br>  On the puppet-db server, a puppet agent is sufficient: <br><br><pre> <code class="bash hljs">sudo apt install puppet-agent</code> </pre> <br>  The rest of the puppet-db install using Puppet. <br><a name="habracut"></a><br><h2>  General settings puppet agents </h2><br>  In the /etc/puppetlabs/puppet/puppet.conf file add the settings of the certification server and the name of the puppet server to which they will apply (cluster name) <br><br><pre> <code class="bash hljs">[main] server = puppetmaster.example.com ca_server = puppet-master01.example.com</code> </pre> <br>  Also, these settings <a href="https://docs.puppet.com/guides/scaling_multiple_masters.html">will need to be made for all puppet-agents on all managed nodes</a> , incl.  on puppet-db. <br><br><h2>  Setting up the puppet-master01 node </h2><br>  The certificate server <a href="https://docs.puppet.com/guides/scaling_multiple_masters.html">must be running in a single instance</a> .  Make sure that the start of the certification service is enabled in the /etc/puppetlabs/puppetserver/services.d/ca.cfg file: <br><br><pre> <code class="bash hljs">puppetlabs.services.ca.certificate-authority-service/certificate-authority-service</code> </pre> <br>  The line should <b>NOT</b> be commented out. <br><br><h4>  <a href="https://docs.puppet.com/guides/scaling_multiple_masters.html">Configure a list of DNS server names</a> </h4><br>  In the /etc/puppetlabs/puppet/puppet.conf file, you need to register <a href="https://docs.puppet.com/puppet/latest/reference/configuration.html">alternative DNS names</a> for puppet-master01, for this we add to the [main] section: <br><br><pre> <code class="bash hljs">dns_alt_names = puppet-master01,puppet-master01.example.com,puppetmaster,puppetmaster.example.com</code> </pre> <br>  Further, these names will be stored in the server certificate. <br><br>  Generate a certificate for puppet-master01, taking into account alternative DNS names: <br><br><pre> <code class="bash hljs">aspetrenko@puppet-master01:~$ sudo -i puppet cert generate puppet-master01.example.com --dns_alt_names=puppet-master01,puppet-master01.example.com,puppetmaster,puppetmaster.example.com Notice: puppet-master01.example.com.pem has a waiting certificate request Notice: Signed certificate request <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> puppet-master01.example.com.pem Notice: Removing file Puppet::SSL::CertificateRequest puppet-master01.example.com.pem at <span class="hljs-string"><span class="hljs-string">'/etc/puppetlabs/puppet/ssl/ca/requests/puppet-master01.example.com.pem.pem'</span></span> Notice: Removing file Puppet::SSL::CertificateRequest puppet-master01.example.com.pem at <span class="hljs-string"><span class="hljs-string">'/etc/puppetlabs/puppet/ssl/certificate_requests/puppet-master01.example.com.pem.pem'</span></span></code> </pre> <br>  Run the puppet server on puppet-master01: <br><br><pre> <code class="bash hljs">sudo systemctl start puppetserver.service</code> </pre> <br><h2>  Setting up the puppet-master02 node </h2><br>  On the other puppet-master servers except the first one, you need to disable the launch of the certification service in the /etc/puppetlabs/puppetserver/services.d/ca.cfg file.  You need to comment out the certificate-service-service line, and uncomment the sertificate-authority-disabled-service: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># To enable the CA service, leave the following line uncommented #puppetlabs.services.ca.certificate-authority-service/certificate-authority-service # To disable the CA service, comment out the above line and uncomment the line below puppetlabs.services.ca.certificate-authority-disabled-service/certificate-authority-disabled-service</span></span></code> </pre> <br>  Configure the list of DNS server names in the /etc/puppetlabs/puppet/puppet.conf file. To do this, add the following to the [main] section: <br><br><pre> <code class="bash hljs">dns_alt_names = puppet-master02,puppet-master02.example.com,puppetmaster,puppetmaster.example.com</code> </pre> <br>  Request a certificate for puppet-master02 from puppet-master01: <br><br><pre> <code class="bash hljs">aspetrenko@puppet-master02:~$ sudo -i puppet agent --<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> --waitforcert 60 Info: Creating a new SSL key <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> puppet-master02.example.com Info: Caching certificate <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ca Info: csr_attributes file loading from /etc/puppetlabs/puppet/csr_attributes.yaml Info: Creating a new SSL certificate request <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> puppet-master02.example.com Info: Certificate Request fingerprint (SHA256): 16:67:D9:84:A3:50:B6:43:35:08:FE:BA:05:77:7C:C5:E7:3E:A5:D6:D1:00:BE:11:63:AB:6E:93:B7:37:0A:33 Info: Caching certificate <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ca Info: Caching certificate <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> puppet-master02.example.com Info: Caching certificate_revocation_list <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ca</code> </pre> <br>  Confirm the certificate request from the puppet-master02 agent on the puppet-master01 server: <br><br><pre> <code class="bash hljs">aspetrenko@puppet-master01:~$ sudo -i puppet cert sign puppet-master02.example.com --allow-dns-alt-names Signing Certificate Request <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: <span class="hljs-string"><span class="hljs-string">"puppet-master02.example.com"</span></span> (SHA256) 16:67:D9:84:A3:50:B6:43:35:08:FE:BA:05:77:7C:C5:E7:3E:A5:D6:D1:00:BE:11:63:AB:6E:93:B7:37:0A:33 (alt names: <span class="hljs-string"><span class="hljs-string">"DNS:puppet-master02"</span></span>, <span class="hljs-string"><span class="hljs-string">"DNS:puppet-master02.example.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"DNS:puppetmaster"</span></span>, <span class="hljs-string"><span class="hljs-string">"DNS:puppetmaster.example.com"</span></span>) ** Notice: Signed certificate request <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> puppet-master02.example.com Notice: Removing file Puppet::SSL::CertificateRequest puppet-master02.example.com at <span class="hljs-string"><span class="hljs-string">'/etc/puppetlabs/puppet/ssl/ca/requests/puppet-master02.example.com.pem'</span></span></code> </pre> <br>  Get the agent's response to puppet-master02: <br><br><pre> <code class="bash hljs">Info: Using configured environment <span class="hljs-string"><span class="hljs-string">'production'</span></span> Info: Retrieving pluginfacts Info: Retrieving plugin Info: Caching catalog <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> puppet-master02.example.com Info: Applying configuration version <span class="hljs-string"><span class="hljs-string">'1477917008'</span></span> Info: Creating state file /opt/puppetlabs/puppet/cache/state/state.yaml Notice: Applied catalog <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.02 seconds</code> </pre> <br>  On puppet-master01 in the list of certificates you should get something like this: <br><br><pre> <code class="bash hljs">aspetrenko@puppet-master01:~$ sudo -i puppet cert list -a + <span class="hljs-string"><span class="hljs-string">"puppet-master01.example.com"</span></span> (SHA256) 1A:15:76:96:33:6E:F9:DA:9F:C3:8D:9E:FC:98:BA:FB:10:CF:FA:27:54:2C:F2:55:8D:B9:AA:6C:52:FA:9F:C1 (alt names: <span class="hljs-string"><span class="hljs-string">"DNS:puppet-master01"</span></span>, <span class="hljs-string"><span class="hljs-string">"DNS:puppet-master01.example.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"DNS:puppetmaster"</span></span>, <span class="hljs-string"><span class="hljs-string">"DNS:puppetmaster.example.com"</span></span>) + <span class="hljs-string"><span class="hljs-string">"puppet-master02.example.com"</span></span> (SHA256) 80:1B:2C:49:E3:16:C6:37:B5:FC:E2:40:6B:49:B8:9A:95:91:C1:76:9C:79:3D:D5:0A:81:29:1D:E6:C3:B6:52 (alt names: <span class="hljs-string"><span class="hljs-string">"DNS:puppet-master02"</span></span>, <span class="hljs-string"><span class="hljs-string">"DNS:puppet-master02.example.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"DNS:puppetmaster"</span></span>, <span class="hljs-string"><span class="hljs-string">"DNS:puppetmaster.example.com"</span></span>)</code> </pre> <br>  <b>ATTENTION!</b>  Do not forget to copy the certificate of the certificate authority /etc/puppetlabs/puppet/ssl/ca/ca_crl.pem from puppet-master01 to puppet-master02 in the same location with the same owner and rights. <br><br>  Run the puppet server on puppet-master02: <br><br><pre> <code class="bash hljs">sudo systemctl start puppetserver.service</code> </pre> <br><br><h2>  Installing r10k on puppet-master01 and puppet-master02 servers </h2><br><div class="spoiler">  <b class="spoiler_title">R10k configuration documentation</b> <div class="spoiler_text">  <a href="https://docs.puppet.com/pe/latest/r10k.html">docs.puppet.com/pe/latest/r10k.html</a> <br>  <a href="https://puppet.com/blog/git-workflows-puppet-and-r10k">puppet.com/blog/git-workflows-puppet-and-r10k</a> <br></div></div><br>  On all puppet-master servers, install git and rubygems: <br><br><pre> <code class="bash hljs">sudo apt install git rubygems sudo gem install r10k</code> </pre> <br>  Put the user r10k into the puppet group: <br><br><pre> <code class="bash hljs">sudo usermod -a -G puppet r10k</code> </pre> <br>  Create a directory for the repository cache and give rights to the user r10k and the puppet group: <br><br><pre> <code class="bash hljs">sudo mkdir -p /var/cache/r10k sudo chown -R r10k:puppet /var/cache/r10k sudo chmod 2775 /var/cache/r10k</code> </pre> <br>  Create a directory with r10k settings: <br><br><pre> <code class="bash hljs">sudo mkdir -p /etc/puppetlabs/r10k sudo chown -R puppet:puppet /etc/puppetlabs sudo chmod -R g+w /etc/puppetlabs</code> </pre> <br>  Also on each puppet-master server you need to create a <a href="https://docs.puppet.com/pe/3.8/r10k_yaml.html">configuration file</a> /etc/puppetlabs/r10k/r10k.yaml.  Its content will depend on <a href="">which provider you will use</a> to work with the git repository. <br><br><h2>  Shellgit provider </h2><br>  This provider is available by default, and is suitable in those cases if you intend to use the git repository in a local directory without a git server;  or the simplest git-server with ssh access. <br><br>  The contents of the configuration file /etc/puppetlabs/r10k/r10k.yaml: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># location for cached repos :cachedir: '/var/cache/r10k' git: provider: 'shellgit' # git repositories containing environments :sources: :base: remote: 'gitolite3@sgl-git.example.com:puppet-environments' #      gitolite3 # remote: '/srv/puppet.git' #    shared     # remote: 'ssh://aspetrenko@puppet-master01/srv/puppet.git' #     ssh         basedir: '/etc/puppetlabs/code/environments/'</span></span></code> </pre> <br>  The Shellgit provider cannot take the username from the configuration file r10k.yaml, so to access the repository on gitolite with the necessary key, set the settings in /r10k/.ssh/config: <br><br><pre> <code class="bash hljs">host sgl-git.example.com HostName sgl-git.example.com IdentityFile /home/r10k/.ssh/r10k User gitolite3</code> </pre> <br><h2>  Rugged provider </h2><br>  But it is better to use a rugged provider, then for each source in r10k.yaml you can specify a separate key and username.  You can also work with repositories using the https protocol. <br><br>  In Ubuntu, to work with ssh and https protocols in rugged mode, <a href="">you need to compile the libssh2 library with openssl support instead of libgcrypt</a> : <br><blockquote>  it makes it easier to compile it, and it doesn‚Äôt have any legal support.  You will need to shellgit or recompile your own libssh2-1 package to use OpenSSL on these distributions. </blockquote><br>  The libssh2 library version 1.5.0-2.dsc of xenial <a href="https://github.com/cloudfoundry-incubator/bosh-workspace/issues/97">does not work</a> : <br><blockquote>  Libssh2 / src / libgcrypt.c.  Elsewhere, libssh2 v 1.6.0 works without complaint.  If updating, it‚Äôs not necessary to use private git repos. </blockquote><br>  Have to make a backport from yakkety.  Install the necessary packages on puppet-master01: <br><br><pre> <code class="bash hljs">sudo apt install make cmake pkg-config libssh2-1-dev ruby-dev rubygems libevent-pthreads-2.0-5 openssl libssl-dev libz-dev libhttp-parser-dev</code> </pre> <br><pre> <code class="bash hljs">sudo apt install debhelper dh-autoreconf chrpath devscripts</code> </pre> <br>  and on puppet-master02 (packages needed to build rugged, via gem): <br><br><pre> <code class="bash hljs">sudo apt install make cmake pkg-config ruby-dev rubygems libevent-pthreads-2.0-5 openssl libssl-dev libz-dev libhttp-parser-dev</code> </pre> <br>  Download the libssh2 sources and unpack them: <br><br><pre> <code class="bash hljs">dget http://archive.ubuntu.com/ubuntu/pool/universe/libs/libssh2/libssh2_1.7.0-1.dsc dpkg-source -x ./libssh2_1.7.0-1.dsc</code> </pre> <br>  Add to the package description additional information about our changes: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> libssh2-1.7.0/ dch -i</code> </pre> <br>  It is necessary to add the description to changelog like: <br><blockquote>  * Backport from yakkety <br>  * Recompile with openssl support </blockquote><br>  Increase changelog: <br><br><pre> <code class="bash hljs">dch -r</code> </pre> <br>  In the /libssh2-1.7.0/debian/control file, we will change all occurrences of libgcrypt20-dev to libssl-dev: <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/libgcrypt20-dev/libssl-dev/g'</span></span> debian/control</code> </pre> <br>  And build a new package with openssl support instead of libgcrypt: <br><br><pre> <code class="bash hljs">./configure --with-openssl --without-libgcrypt dpkg-buildpackage -rfakeroot</code> </pre> <br>  Do not forget to remove libssh2-1-dev from the old version of libssh2-1: <br><br><pre> <code class="bash hljs">sudo apt remove libssh2-1-dev</code> </pre> <br>  Install the reassembled packages on puppet-master01 and puppet-master02 (the dev-package is needed to install rugged via gem): <br><br><pre> <code class="bash hljs">sudo dpkg -i libssh2-1_1.7.0-1ubuntu1_amd64.deb libssh2-1-dbg_1.7.0-1ubuntu1_amd64.deb libssh2-1-dev_1.7.0-1ubuntu1_amd64.deb</code> </pre> <br>  Install r10k and rugged: <br><br><pre> <code class="bash hljs">sudo gem install r10k rugged</code> </pre> <br>  And create the configuration file /etc/puppetlabs/r10k/r10k.yaml on puppet-master01 and puppet-master02 with the following contents: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># location for cached repos :cachedir: '/var/cache/r10k' git: provider: 'rugged' private_key: '/home/r10k/.ssh/r10k' # git repositories containing environments :sources: :base: remote: 'ssh://gitolite3@sgl-git.example.com/puppet-environments' basedir: '/etc/puppetlabs/code/environments/'</span></span></code> </pre> <br><h2>  Configuring the puppet-environments.git repository </h2><br>  Initial repository setup.  Clone the puppet-environments repository on your work computer: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> gitolite3@sgl-git.example.com:puppet-environments Cloning into <span class="hljs-string"><span class="hljs-string">'puppet-environments'</span></span>... warning: You appear to have cloned an empty repository. Checking connectivity... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>.</code> </pre> <br>  Fill in the repository with the original content, which we take on puppet-master01: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git$ scp -r aspetrenko@puppet-master01:/etc/puppetlabs/code/environments/production/* /home/aspetrenko/sgl-git/puppet-environments/</code> </pre> <br>  Go to the repository and add a symbolic link for origin, which will be called production, according to the environment name in puppet: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> puppet-environments/ aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ git symbolic-ref HEAD refs/heads/production</code> </pre> <br>  And fix the changes: <br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ git add --all aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ git commit -a -m <span class="hljs-string"><span class="hljs-string">"Initial commit"</span></span> aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ git push --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-upstream origin production</code> </pre> <br><br><h2>  Creating a post-receive hook </h2><br>  Create a post-receive hook in the puppet-environments repository that will run r10k on puppet-master01 and puppet-master02, with the following contents: <br><br><pre> <code class="bash hljs">aspetrenko@sgl-git:~$ sudo cat /media/data/repositories/puppet-environments.git/hooks/post-receive <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash umask 0002 while read oldrev newrev ref do branch=$(echo $ref | cut -d/ -f3) echo echo "--&gt; Deploying ${branch}..." echo ssh -i /var/lib/gitolite3/.ssh/gitolite3 r10k@puppet-master01 "r10k deploy environment $branch -p" ssh -i /var/lib/gitolite3/.ssh/gitolite3 r10k@puppet-master02 "r10k deploy environment $branch -p" # sometimes r10k gets permissions wrong too find /etc/puppetlabs/code/environments/$branch/modules -type d -exec chmod 2775 {} \; 2&gt; /dev/null find /etc/puppetlabs/code/environments/$branch/modules -type f -exec chmod 664 {} \; 2&gt; /dev/null done</span></span></code> </pre> <br>  Do not forget to make it executable: <br><br><pre> <code class="bash hljs">aspetrenko@sgl-git:~$ sudo chmod 0775 /media/data/repositories/puppet-environments.git/hooks/post-receive</code> </pre> <br><br><h3>  Post-recive hook check </h3><br>  Create a manifets directory and a .keep file so that git does not ignore the empty directory: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ touch manifests/.keep aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ git add manifests/.keep aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ git commit manifests/.keep -m <span class="hljs-string"><span class="hljs-string">"Test commit"</span></span> [production 72bd288] Test commit 1 file changed, 0 insertions(+), 0 deletions(-) create mode 100644 manifests/.keep</code> </pre> <br>  Send changes to the repository: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ git push -u origin production</code> </pre> <br>  Further, git-hook using r10k will make the appropriate changes in / etc / puppetlabs / code / environments on each server.  Check for changes on puppet-master01 and puppet-master02. <br><br><h2>  Installing and configuring Librarian-puppet </h2><br>  <a href="http://librarian-puppet.com/">librarian-puppet.com</a> <br><blockquote>  Librarian-puppet takes control of the modules / directory, and will always reinstall (if not available) the modules described in Puppetfile, so you do not need to store and monitor the status of the modules / directory in Git. <br><br>  Librarian-puppet is the manager (aka Bundler for gem) for your puppet infrastructure.  You can use librarian-puppet to manage Puppet modules, regardless of where the modules are stored in Puppet Forge, in a Git repository, or in a local folder. <br><br>  Librarian-puppet can resolve dependencies described in Modulefile or metadata.json. <br>  Forge modules can be installed from Puppetlabs Forge or internal Forge storage such as Pulp. <br><br>  Git-modules can be installed from a branch, a tag or a specific commit.  Modules can be installed from GitHub using tarballs, without the need to install Git.  Modules can be installed from a directory in the local file system.  Module dependencies can be resolved transparently without the need to list all modules explicitly. </blockquote><br><h3>  Install librarian-puppet </h3><br>  On the computer where we work with the repository, use gem to install librarian-puppet: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ sudo gem install librarian-puppet</code> </pre> <br>  Delete the modules directory with all the attached files that were copied from the original Puppet repository: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ git rm -rf modules</code> </pre> <br>  We initialize librarian-puppet in the repository: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ librarian-puppet init</code> </pre> <br>  Comment out the metadata line in the Puppetfile.  We'll give Puppetfile to the following form: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ cat Puppetfile <span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env ruby #^syntax detection forge "https://forgeapi.puppetlabs.com" # use dependencies defined in metadata.json # metadata # use dependencies defined in Modulefile # modulefile # A module from the Puppet Forge mod 'puppetlabs-stdlib' mod 'puppetlabs-ntp' mod 'puppetlabs-puppetdb' mod 'puppetlabs-firewall' # For puppetlabs-puppetdb mod 'puppetlabs-inifile' # For puppetlabs-puppetdb mod 'puppetlabs-postgresql' # For puppetlabs-puppetdb mod 'puppetlabs-apt' # For puppetlabs-puppetdb mod 'puppetlabs-concat' # For puppetlabs-puppetdb</span></span></code> </pre> <br>  Create a .keep file in the modules directory so that git does not ignore the empty directory: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/puppet-environments$ touch modules/.keep</code> </pre> <br>  Add the files in git using the librarian-puppet init command, and send the changes to the puppet-master01 and puppet-master02 servers: <br><br><pre> <code class="bash hljs">git add --all git commit -a -m <span class="hljs-string"><span class="hljs-string">"librarian-puppet init"</span></span> git push -u origin production</code> </pre> <br>  If everything has been configured correctly, then the modules listed in the Puppetfile should appear on the servers in the / etc / puppetlabs / code / environments / production / modules / directory. <br><br>  <a href="https://habrahabr.ru/post/316486/">Deploy OpenSource Puppet 4 with multiple puppet masters.</a>  <a href="https://habrahabr.ru/post/316486/">Part III.</a>  <a href="https://habrahabr.ru/post/316486/">Setting up puppet-db with Puppet</a> </div><p>Source: <a href="https://habr.com/ru/post/316482/">https://habr.com/ru/post/316482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316468/index.html">We publish the site in the interplanetary file system IPFS</a></li>
<li><a href="../316472/index.html">9 nuances in the work of indie developer, which no one told me</a></li>
<li><a href="../316474/index.html">Idea for Habr: article difficulty levels</a></li>
<li><a href="../316476/index.html">Mobile application "Shared Track"</a></li>
<li><a href="../316480/index.html">SmartDigest # 1. What to read or the best of books in a week</a></li>
<li><a href="../316484/index.html">How to use PVS-Studio for free</a></li>
<li><a href="../316486/index.html">Deploy OpenSource Puppet 4 with multiple puppet masters. Part III. Setting up puppet-db with Puppet</a></li>
<li><a href="../316488/index.html">We invite to Azov Developers Meetup conference - December 10 in Taganrog</a></li>
<li><a href="../316490/index.html">Convert desktop app to appx using Desktop Bridge</a></li>
<li><a href="../316492/index.html">History of programming languages: Delphi is more than just a language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>