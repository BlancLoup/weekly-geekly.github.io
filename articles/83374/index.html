<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Serialization in Qt through the use of MetaObject</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 Actually for what this might be needed? After all, C ++ already provides quite flexible options for serializing to a stream. However, my ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Serialization in Qt through the use of MetaObject</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  Actually for what this might be needed?  After all, C ++ already provides quite flexible options for serializing to a stream.  However, my task was to maximally universalize the process of serialization / deserialization for repeated use in projects. <br><br>  So, it was necessary to organize the most flexible (de) serialization system in Qt so that <br><ol><li>  either inheriting from the base class and expanding it </li><li>  either having a separate serializer class </li></ol>  be able to send a stream of data from the object in one command. <br><br>  At the same time, in some way it should be possible to specify which data in the object should be serialized, and which can (and should) be ‚Äúskipped‚Äù.  Similarly, the ability to correctly set the data and the associated dependent values ‚Äã‚Äãinside the object should have been performed during deserialization. <br><a name="habracut"></a><br><h4>  Decision </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The solution was found as a property system.  Qt has add-ons over C ++ to provide a property system.  We have the right to use properties only in classes inherited from QObject, having a Q_OBJECT tag.  The assignment of properties occurs when using a macro of this type when describing a class in a header (example): <br> <code>Q_PROPERTY(int Test READ readTest WRITE setTest)</code> <br> <br>  As you can see from the example, you can assign a function to read (readTest) and write (setTest).  The latter ensures the correctness of the installation during deserialization. <br><br>  The parameters necessary for serialization are typed in the object as properties, thereby setting the list of properties necessary for ensuring the integrity of class data. <br><br>  To provide access to properties in general (given that the base class about the class that transferred itself for serialization to know nothing and cannot) is obtained through the MetaObject system (describing an object with its property system and generated for any object) MetaProperty, which provide a description and access to properties.  The result is the following code for (de) serialization: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">bool</font> SerializedBase::Serialize(QDataStream *dataStream) <br> { <br> <font color="#0000ff">if</font> (dataStream == NULL) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 1; i &lt; <font color="#0000ff">this</font> -&gt;metaObject()-&gt;propertyCount(); i++) <br> { <br> QMetaProperty prop = <font color="#0000ff">this</font> -&gt;metaObject()-&gt;property(i); <br> <font color="#0000ff">const</font> <font color="#0000ff">char</font> * propName = prop.name(); <br> *dataStream &lt;&lt; ( <font color="#0000ff">this</font> -&gt;property(propName)); <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> <br> <font color="#0000ff">bool</font> SerializedBase::DeSerialize(QDataStream *dataStream) <br> { <br> <font color="#0000ff">if</font> (dataStream == NULL) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 1; i &lt; <font color="#0000ff">this</font> -&gt;metaObject()-&gt;propertyCount(); i++) <br> { <br> QMetaProperty prop = <font color="#0000ff">this</font> -&gt;metaObject()-&gt;property(i); <br> <font color="#0000ff">const</font> <font color="#0000ff">char</font> * propName = prop.name(); <br> QVariant v; <br> *dataStream &gt;&gt; v; <br> <font color="#0000ff">this</font> -&gt;setProperty(propName, v); <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The result is a base class, inheriting from which we can serialize / deserialize an object into 1 command (if there is any data stream created). <br><br>  The code for a free-standing class should be almost identical, except that add.  checks in order to understand the object in front of us or the usual data structure). <br><br><h4>  Additional information and modifications </h4><br><br><h5>  Objects in the form of properties and their serialization </h5><br>  The Q_DISABLE_COPY directive in the QObject class code does not give the ability to assign directly object-values ‚Äã‚Äãto properties.  In order to provide the necessary flexibility, you need to perform 3 steps: <br><ol><li>  Create a copy constructor.  Suppose if an object is class AAA, then the constructor should look like this (in the header): <code>AAA(AAA* copy)</code> .  It actually defines the actions when copying an object. </li><li>  Register the metaclass in the class header.  It is done like this: <code>Q_DECRARE_METATYPE(AAA);</code> </li><li>  When using the property, in order not to ‚Äúrob‚Äù problems (usually they are defined at the compiler level, so do not miss it), you need to register for the class somewhere in the application via the <code>qRegisterMetaType("AAA")</code> command <br>  It is necessary to reassign for the used streaming classes, that is, to specify how to send them to the stream.  This is done via the <code>qRegisterMetaTypeStreamOperators ( const char * typeName )</code> .  Description of the functions to be implemented in the class: <br><br> <code>QDataStream &amp;operator&lt;&lt;(QDataStream &amp;out, const MyClass &amp;myObj); <br> QDataStream &amp;operator&gt;&gt;(QDataStream &amp;in, MyClass &amp;myObj);</code> </li> </ol><br><br>  After all these actions, we will be able to operate with properties-objects, not only the values ‚Äã‚Äãof standard types, and not use references to these types of types (see flaws). <br><br><h5>  Using dynamically created instances </h5><br>  The Qt property system supports this, though again, not ‚Äústraight‚Äù, it is necessary to perform gestures.  The class (base) must meet the requirements in the above list (well, unless item 4 is no longer required), plus more (thanks for the <a href="https://habrahabr.ru/users/fuctor/" class="user_link">fuCtor</a> hint): <br>  1. The constructor used must have the Q_INVOKABLE macro in its description <br>  2. You need to use the command <a href="http://doc.qt.nokia.com/4.6/qmetaobject.html">QMetaObject :: newInstance ()</a> , clinging to the name of the class that can be passed along with the object (or its identifier) ‚Äã‚ÄãQMetaObject.  If MetaObject is not ready, you will have to be content with the default constructor (which nevertheless must meet the same requirements, and use <a href="http://doc.trolltech.com/4.1/qmetatype.html">QMetaType :: construct</a> , having received the registered type via <code>int QMetaType::type ( const char * typeName )</code> that <code>int QMetaType::type ( const char * typeName )</code> , and by Id (not forgetting to check whether the type is registered in the system by comparing with 0) already MetaType itself. <br><br><h4>  Advantages and disadvantages </h4><br>  Briefly outline the advantages of this method: <br><ul><li>  Quick adaptation for new classes - write properties, functions for getting and installing them, follow up - and voila, serialization works </li><li>  The system supports both static and dynamic properties.  If the client-server system at the other end, during deserialization, the object does not support the specified properties.  name - it is created dynamically, and it can be traced anyway (though the setter / getter will not appear out of nowhere. We will not lose the data) </li><li>  It is working :) </li></ul><br><br>  But the shortcomings identified at the moment: <br><ul><li>  Impossibility of correct transfer of properties-links.  Addresses are transmitted, but the data for the links, no.  Physically, pointer properties do not forbid us to do anything, but serialization with them will not work correctly. </li><li>  Non-standard property types must be registered with Q_DECLARE_METATYPE in order to be able to be operated with them through QVariant </li><li>  If you try to use the objects themselves in the view properties, you need to write a lot of additional code in the class ‚Äî constructors, macros, and so on.  True, in the end it translates into greater versatility. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/83374/">https://habr.com/ru/post/83374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../83367/index.html">FlexGet or Backup Internet automatically</a></li>
<li><a href="../83370/index.html">Download scripts browsers: news from the field</a></li>
<li><a href="../83371/index.html">We are 1 year old, you - 10 000 rubles!</a></li>
<li><a href="../83372/index.html">An example of using fluent interface in java to describe domain objects</a></li>
<li><a href="../83373/index.html">L-systems. Tree modeling</a></li>
<li><a href="../83375/index.html">Our world, perhaps - one huge hologram</a></li>
<li><a href="../83376/index.html">Xsplash - making a theme for yourself</a></li>
<li><a href="../83377/index.html">How do we sell software?</a></li>
<li><a href="../83378/index.html">Filling the database with test data using Populator and Faker</a></li>
<li><a href="../83381/index.html">Button and resistance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>