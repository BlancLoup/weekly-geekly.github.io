<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Greetings to Yandex developers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Approximately once every six months, someone from Yandex employees writes us, is interested in licensing PVS-Studio, shakes the trial and disappears. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Greetings to Yandex developers</h1><div class="post__text post__text-html js-mediator-article"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1c9/68d/599/1c968d599829385d45645421b9b4493c.png" alt="ClickHouse and PVS-Studio"></div><br>  Approximately once every six months, someone from Yandex employees writes us, is interested in licensing PVS-Studio, shakes the trial and disappears.  This is normal, we are accustomed to the slow process of selling our analyzer to large companies.  However, once the occasion presented itself, it would not be superfluous to convey hello to the Yandex developers and remind you about the PVS-Studio tool. <br><a name="habracut"></a><br>  Honestly, the article was largely random.  We were already offered to check ClickHouse, but somehow this idea was forgotten.  The other day, walking across the expanses of the Internet, I again met the mention of ClickHouse and became interested in this project.  This time I decided not to delay and check out this project. <br><br><h2>  Clickhouse </h2><br>  ClickHouse is a column-based DBMS for OLAP (online analytic query processing).  ClickHouse was developed in Yandex to solve Yandex.Metrica problems.  ClickHouse allows you to perform analytical queries on updated data in real time.  The system is linearly scalable and capable of working with trillions of records and petabytes of data.  In June 2016, ClickHouse was released on open source under the Apache 2.0 license. <br><br><ul><li>  Website: <a href="https://clickhouse.yandex/">clickhouse.yandex</a> . </li><li>  Wikipedia page: <a href="https://ru.wikipedia.org/wiki/ClickHouse">ClickHouse</a> . </li><li>  An article on the Habrahabr website: <a href="https://habrahabr.ru/company/yandex/blog/303282/">Yandex opens ClickHouse</a> . </li><li>  GitHub.com repository: <a href="https://github.com/yandex/ClickHouse">yandex / ClickHouse</a> . </li></ul><br><h2>  Project analysis using PVS-Studio </h2><br>  I checked the ClickHouse source code, taken from the repository on August 14, 2017.  For verification, I used the beta version of the PVS-Studio v6.17 analyzer.  By the time of publication of the article, the release of this version has already taken place. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The following directories were excluded from the check: <ul><li>  ClickHouse / contrib </li><li>  ClickHouse / libs </li><li>  ClickHouse / build </li><li>  various tests were also excluded, for example, ClickHouse / dbms / src / Common / tests </li></ul><br>  The size of the remaining C ++ source code is 213 KLOC.  At the same time, 7.9% of the lines are comments.  It turns out that our own code, which was verified, is quite a bit: about 196 KLOC. <br><br>  As you can see, the ClickHouse project has a small size.  At the same time, the quality of the code is definitely high and I will not be able to write a shocking article.  In total, the analyzer issued 130 warnings (General analysis, High and Medium messages). <br><br>  About the number of false positives difficult to answer.  There are many warnings that can not be formally called false, but at the same time there is no practical benefit from them.  The easiest way is to explain this by giving an example. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> format_version; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (format_version &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> || format_version &gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Bad checksums format version: "</span></span> + ....); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (format_version == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (format_version == <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_v2(in); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (format_version == <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_v3(in); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (format_version == <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_v4(in); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  The analyzer draws attention to the fact that if an expression begins to be evaluated <i>(format_version == 4)</i> , then it will always be true.  As you can see, there is a check above that if the value of <i>format_version</i> goes beyond [1..4], then an exception is thrown.  And the <i>return false statement</i> is never executed at all. <br><br>  Formally, the analyzer is right and it is not clear how to substantiate that this is a false positive.  On the other hand, it is clear that this code is correct and simply written with a ‚Äúsafety margin‚Äù. <br><br>  In such cases, analyzer warnings can be suppressed in various ways or rewritten code.  For example, you can write this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(format_version) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_v2(in); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_v3(in); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_v4(in); <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Bad checksums format version: "</span></span> + ....); }</code> </pre> <br>  There are also warnings about which I simply cannot say: they indicate an error or not.  I am not familiar with the project and have no idea how some code fragments should work.  Consider this case. <br><br>  There is a certain scope with 3 functions: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> CurrentMemoryTracker { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alloc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Int64 size)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">realloc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Int64 old_size, Int64 new_size)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">free</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Int64 size)</span></span></span></span>; }</code> </pre> <br>  The names of the formal arguments of the functions suggest that the functions must take on some dimensions.  Suspicion of the analyzer is caused by cases when, for example, not the size of the structure, but the size of a pointer is passed to the <i>alloc</i> function. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Large = HyperLogLogCounter&lt;K, Hash, UInt32, DenominatorType&gt;; Large * large = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; .... CurrentMemoryTracker::alloc(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(large));</code> </pre> <br>  The analyzer does not know whether it is an error or not.  I don't know either, but in my opinion, this code is suspicious. <br><br>  In general, I will not speak about such cases.  If the ClickHouse developers have an interest, they will be able to independently check the project and study the list of warnings in more detail.  I in the article will consider only those code fragments that seemed to me the most interesting. <br><br><h2>  Interesting code snippets </h2><br>  <b>1. CWE-476: NULL Pointer Dereference (3 errors)</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeForNullThenElse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ColumnUInt8 * cond_col = typeid_cast&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ColumnUInt8 *&gt;(arg_cond.column.get()); .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cond_col) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cond_const_col) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Exception( <span class="hljs-string"><span class="hljs-string">"Illegal column "</span></span> + cond_col-&gt;getName() + <span class="hljs-comment"><span class="hljs-comment">// &lt;= " of first argument of function " + getName() + ". Must be ColumnUInt8 or ColumnConstUInt8.", ErrorCodes::ILLEGAL_COLUMN); .... }</span></span></code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V522/">warning</a> : <a href="http://www.viva64.com/ru/w/V522/">V522</a> Dereferencing of the null pointer 'cond_col' might take place.  FunctionsConditional.h 765 <br><br>  Here the situation when an error occurs is incorrectly handled.  Instead of generating an exception, the null pointer is dereferenced. <br><br>  To create an error message, the function is called: <i>cond_col-&gt; getName ()</i> .  This can not be done, since the pointer <i>cond_col</i> will be zero. <br><br>  A similar error is found here: V522 Dereferencing of the null pointer 'cond_col' might take place.  FunctionsConditional.h 1061 <br><br>  Consider another variation on the use of the null pointer: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processHigherOrderFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DataTypeExpression * lambda_type = typeid_cast&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DataTypeExpression *&gt;(types[i].get()); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DataTypes &amp; lambda_argument_types = lambda_type-&gt;getArgumentTypes(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lambda_type) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Logical error: ....."</span></span>, ErrorCodes::LOGICAL_ERROR); .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V595/">warning</a> : <a href="http://www.viva64.com/ru/w/V595/">V595</a> The 'lambda_type' pointer was used against nullptr.  Check lines: 359, 361. TypeAndConstantInference.cpp 359 <br><br>  At the beginning, the <i>lambda_type</i> pointer <i>is</i> dereferenced, and only then is it checked.  To fix the code, you need to move the pointer check just above: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lambda_type) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Logical error: ....."</span></span>, ErrorCodes::LOGICAL_ERROR); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DataTypes &amp; lambda_argument_types = lambda_type-&gt;getArgumentTypes();</code> </pre> <br>  <b>2. CWE-665: Improper Initialization (1 error)</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TryResult</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entry entry_)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::move(entry))</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">// &lt;= , is_usable(true) , is_up_to_date(true) { } .... Entry entry; .... }</span></span></span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/w/V546/">V546</a> Member of a class is initialized by itself: 'entry (entry)'.  PoolWithFailoverBase.h 74 <br><br>  Because of a typo, the <i>entry</i> member is initialized by itself and as a result actually remains uninitialized.  To fix the code, add an underscore: <br><br><pre> <code class="cpp hljs">: entry(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(entry_))</code> </pre> <br>  <b>3. CWE-672: Operation on a Resource after Expiration or Release (1 error)</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Strings = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mainEntryClickhousePerformanceTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ** argv)</span></span></span><span class="hljs-function"> </span></span>{ .... Strings input_files; .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String filename : input_files) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { FS::path file(filename); if (!FS::exists(file)) throw DB::Exception(....); if (FS::is_directory(file)) { input_files.erase( // &lt;= std::remove(input_files.begin(), // &lt;= input_files.end(), // &lt;= filename) , // &lt;= input_files.end() ); // &lt;= getFilesFromDir(file, input_files, recursive); } else { if (file.extension().string() != ".xml") throw DB::Exception(....); } } .... }</span></span></code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V789/">warning</a> : <a href="http://www.viva64.com/ru/w/V789/">V789</a> Iterators for the 'input_files' container, use it.  PerformanceTest.cpp 1471 <br><br>  The <i>input_files</i> container <i>is</i> used in range-based for loop.  At the same time, inside the loop, the container may change due to the removal of some elements.  If the reader does not understand why it is impossible to do this, I suggest reading the description of the diagnostic <a href="https://www.viva64.com/ru/w/V789/">V789</a> . <br><br>  <b>4. CWE-563: Assignment to Variable without Use ('Unused Variable') (1 error)</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StringRange</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * first; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * second; .... StringRange(TokenIterator token_begin, TokenIterator token_end) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (token_begin == token_end) { first = token_begin-&gt;begin; <span class="hljs-comment"><span class="hljs-comment">// &lt;= second = token_begin-&gt;begin; // &lt;= } TokenIterator token_last = token_end; --token_last; first = token_begin-&gt;begin; // &lt;= second = token_last-&gt;end; // &lt;= } };</span></span></code> </pre> <br>  The analyzer generates two warnings: <ul><li>  V519 The 'first' variable is assigned twice successively.  Perhaps this is a mistake.  Check lines: 26, 33. StringRange.h 33 </li><li>  V519 The 'second' variable is assigned twice successively.  Perhaps this is a mistake.  Check lines: 27, 34. StringRange.h 34 </li></ul><br>  Under certain conditions, the value of <i>token_begin-&gt; begin is</i> assigned first to the variable <i>first</i> and the variable <i>second</i> .  Further, the value of these variables in any case changes again.  Most likely this code contains some kind of logical error or something is missing in it.  For example, the <i>return statement is</i> probably forgotten: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (token_begin == token_end) { first = token_begin-&gt;begin; second = token_begin-&gt;begin; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br>  <b>5. CWE-570: Expression is Always False (2 errors)</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">DataTypePtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReturnTypeImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DataTypes &amp; arguments)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> override </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!((.....)) || ((left_is_string || left_is_fixed_string) &amp;&amp; (.....)) || (left_is_date &amp;&amp; right_is_date) || (left_is_date &amp;&amp; right_is_string) || (left_is_string &amp;&amp; right_is_date) || (left_is_date_time &amp;&amp; right_is_date_time) <span class="hljs-comment"><span class="hljs-comment">// 1 || (left_is_date_time &amp;&amp; right_is_string) // 1 || (left_is_string &amp;&amp; right_is_date_time) // 1 || (left_is_date_time &amp;&amp; right_is_date_time) // 2 || (left_is_date_time &amp;&amp; right_is_string) // 2 || (left_is_string &amp;&amp; right_is_date_time) // 2 || (left_is_uuid &amp;&amp; right_is_uuid) || (left_is_uuid &amp;&amp; right_is_string) || (left_is_string &amp;&amp; right_is_uuid) || (left_is_enum &amp;&amp; right_is_enum &amp;&amp; .....) || (left_is_enum &amp;&amp; right_is_string) || (left_is_string &amp;&amp; right_is_enum) || (left_tuple &amp;&amp; right_tuple &amp;&amp; .....) || (arguments[0]-&gt;equals(*arguments[1])))) throw Exception(....); .... }</span></span></code> </pre> <br>  In this condition, the three subexpressions are repeated twice.  PVS-Studio warnings: <ul><li>  V501 Instantiate FunctionComparison &lt;EqualsOp, NameEquals&gt;: There are identical sub-expressions' (left_is_date_time &amp;&amp; right_is_date_time) 'to the left'  operator.  FunctionsComparison.h 1057 </li><li>  V501 Instantiate FunctionComparison &lt;EqualsOp, NameEquals&gt;: There are identical sub-expressions '(left_is_date_time &amp;&amp; right_is_string)' to the left |  operator.  FunctionsComparison.h 1057 </li><li>  V501 Instantiate FunctionComparison &lt;EqualsOp, NameEquals&gt;: There are identical sub-expressions' (left_is_string &amp;&amp; right_is_date_time) 'to the left'  operator.  FunctionsComparison.h 1057 </li></ul><br>  There are two options.  The first is that there is no error, the condition is simply redundant and it can be simplified.  The second is that there is an error and some conditions are not checked.  In any case, authors should check out this code snippet. <br><br>  Consider another case where the condition is always false. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ipv6_scan</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * dst)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> val{}; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * colonp = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> ch = *src++) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> num = unhex(ch); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (num != <span class="hljs-number"><span class="hljs-number">-1</span></span>) { val &lt;&lt;= <span class="hljs-number"><span class="hljs-number">4</span></span>; val |= num; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val &gt; <span class="hljs-number"><span class="hljs-number">0xffff</span></span>u) <span class="hljs-comment"><span class="hljs-comment">// &lt;= return clear_dst(); saw_xdigit = 1; continue; } .... }</span></span></code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V547/">warning</a> : <a href="http://www.viva64.com/ru/w/V547/">V547</a> Expression 'val&gt; 0xffffu' is always false.  The value range of unsigned short type: [0, 65535].  FunctionsCoding.h 339 <br><br>  When parsing a string containing an <a href="https://ru.wikipedia.org/wiki/IPv6">IPv6</a> address, some incorrect IPv6 addresses will be perceived as valid.  It is expected that between separators numbers in hexadecimal format with a value of no more than FFFF can be written.  If the number is greater, the address should be considered incorrect.  To identify this situation in the code there is a check " <i>if (val&gt; 0xffffu)</i> ".  But it does not work.  The variable <i>val</i> is of type <i>uint16_t</i> , which means it cannot be greater than 0xFFFF.  As a result, the function will "swallow" incorrect addresses.  As the next part of the address will be the last 4 hex numbers to the separator. <br><br>  <b>6. CWE-571.</b>  <b>Expression is Always True (1 error)</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">formatIP</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UInt32 ip, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *&amp; out)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * begin = out; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; ++i) *(out++) = <span class="hljs-string"><span class="hljs-string">'x'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset = <span class="hljs-number"><span class="hljs-number">8</span></span>; offset &lt;= <span class="hljs-number"><span class="hljs-number">24</span></span>; offset += <span class="hljs-number"><span class="hljs-number">8</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (offset &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= *(out++) = '.'; /// Get the next byte. UInt32 value = (ip &gt;&gt; offset) &amp; static_cast&lt;UInt32&gt;(255); /// Faster than sprintf. if (value == 0) { *(out++) = '0'; } else { while (value &gt; 0) { *(out++) = '0' + value % 10; value /= 10; } } } /// And reverse. std::reverse(begin, out); *(out++) = '\0'; }</span></span></code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V547/">warning</a> : <a href="http://www.viva64.com/ru/w/V547/">V547</a> Expression 'offset&gt; 0' is always true.  FunctionsCoding.h 649 <br><br>  The condition " <i>offset&gt; 0</i> " is always fulfilled, therefore a point is always added.  It seems to me that there is no error and the check is just superfluous.  Although of course I'm not sure.  If this is not an error, then the check should be removed so that it does not confuse other programmers and static code analyzers. <br><br><h2>  Conclusion </h2><br>  Perhaps the project developers will be able to find some more errors by looking at the analyzer warnings, which are not reflected in the article.  I will finish the story, especially since in order to ‚Äúsay hello,‚Äù I had enough material :). <br><br>  In general, I want to note the high quality code of the ClickHouse project developers.  However, how high-class developers would not be, they are not immune from errors, and this article again demonstrates this.  The PVS-Studio static code analyzer will help prevent many errors.  The greatest effect of static analysis, developers get when writing new code.  It makes no sense to spend time debugging errors that can be detected by the analyzer immediately after checking the new code. <br><br>  I invite everyone to <a href="https://www.viva64.com/ru/pvs-studio-download/">download</a> and try PVS-Studio. <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0529/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="http://www.viva64.com/en/b/0529/">Give my Best Regards to Yandex Developers</a> <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. </div></div></div><p>Source: <a href="https://habr.com/ru/post/337182/">https://habr.com/ru/post/337182/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337172/index.html">IT events digest for September</a></li>
<li><a href="../337174/index.html">How to protect yourself from encryptors on the perimeter of the network</a></li>
<li><a href="../337176/index.html">According to Rambler.iOS # 9</a></li>
<li><a href="../337178/index.html">How to stop worrying and start talking</a></li>
<li><a href="../337180/index.html">Differences Postgres Pro Enterprise and PostgreSQL</a></li>
<li><a href="../337184/index.html">Current data on the telephone codes of Russian cities</a></li>
<li><a href="../337186/index.html">Epidemic of the Petya blackmailer virus: what you need to know</a></li>
<li><a href="../337188/index.html">7 rules of good tone when writing Unit tests</a></li>
<li><a href="../337190/index.html">CaptureManager SDK</a></li>
<li><a href="../337192/index.html">Experience of raising IP telephony in the hotel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>