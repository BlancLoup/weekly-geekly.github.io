<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>C ++ ActiveX Controls Guide with ATL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are many textbooks on the use of ATL on the Internet, and in particular, on creating COM components with its help, including ActiveX / OLE contr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>C ++ ActiveX Controls Guide with ATL</h1><div class="post__text post__text-html js-mediator-article">  There are many textbooks on the use of ATL on the Internet, and in particular, on creating COM components with its help, including ActiveX / OLE controls, but most of them for some reason describe the process of poking the mouse at various interesting places in Visual Studio, using graphic tools of the latter, and few of them affect the inside of the code generated by the development environment in a sufficiently deep volume.  In the Russian-speaking segment of the Internet, the situation is even worse - there is very little material on ATL, there is practically no (and not only for ATL, but also for creating COM components in general), so I decided to compensate for this disadvantage. <br><a name="habracut"></a><br>  Well, you should probably start with a brief description of what ActiveX components are and what ATL is. <br><br>  ActiveX is the rebranding of the abbreviations OLE, "Object Linking and Embedding", technology from Microsoft, based on COM, Component Object Model - a language independent component model, invented by MS.  OLE allows you to embed individual controls, documents, or just components into different programs written in different programming languages ‚Äã‚Äãrunning under Windows.  ActiveX controls, in particular, are known for being able to ‚Äúpaste‚Äù them into the Internet Explorer web browser, and one of the most well-known such components for IE is, for example, the Adobe Flash module. <br><br>  The interface of the ActiveX component comes with many well-known and popular programs for Windows, both from Microsoft itself (Windows Media Player, or, for example, programs from Microsoft Office, in particular Word, Excel, etc.) and from third-party companies. (already the aforementioned flash, Adobe Reader, plus many other programs of the same Adobe - for example, Photoshop, if I remember correctly). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is believed that the technology is outdated, or already outdated, but nevertheless, I personally think that it is simply being forced into the field of low-level programming and system services, and while the Windows kernel is written in C, and many components of the system use COM, and are based on COM interfaces, it certainly will not go anywhere. <br><br>  Now about what ATL is.  ATL, Active Template Library is a well-known library from Microsoft that simplifies working with Winapi in C ++.  ATL includes classes / templates not only for working with COM / OLE / ActiveX, but also classes for, for example, building and managing GUI, etc. <br><br>  ATL usually comes with full versions of Microsoft Visual Studio, but if you don‚Äôt have it, you can get this library from the <a href="http://msdn.microsoft.com/en-us/windows/hardware/hh852365">Windows DDK</a> . <br><br>  So, in this article I will describe the process of creating an unpretentious component, which we will have using DirectX 11 tools to draw a spinning sphere rasterized in wireframe, and which will have two methods - Run - start the rotation of the sphere, and Stop - stop the rotation. <br><img src="https://habrastorage.org/getpro/habr/post_images/58a/0e1/c0e/58a0e1c0e13d8b8fac5702c91d859d1b.png"><br><br>  To begin with, we need to come up with the interface of our module, come up with a GUID for the library, interfaces, and component class, and record all of this in the MIDL, Microsoft Interface Definition Language. <br><br><pre><code class="lisp hljs">[ uuid(<span class="hljs-number"><span class="hljs-number">1E4</span></span>E47F3-21AF-407C-9544-59C34C81F3FA), version(<span class="hljs-number"><span class="hljs-number">1.0</span></span>), helpstring(<span class="hljs-string"><span class="hljs-string">"MyActiveX 1.0 Type Library"</span></span>) ] library MyActiveXLib { importlib(<span class="hljs-string"><span class="hljs-string">"stdole32.tlb"</span></span>)<span class="hljs-comment"><span class="hljs-comment">; importlib("stdole2.tlb"); [ object, uuid(2B26D028-4DA6-4D69-9513-D0CA550949D1), dual, helpstring("IMyControl Interface"), pointer_default(unique) ] interface IMyControl : IDispatch { [id(1), helpstring("method Run")] HRESULT Run(); [id(2), helpstring("method Stop")] HRESULT Stop(); }; [ uuid(E7D13B5A-0A09-440A-81EA-C9E3B0105DB0), helpstring("_IMyControlEvents Interface") ] dispinterface _IMyControlEvents { properties: methods: }; [ uuid(5747094E-84FB-47B4-BC0C-F89FB583895F), helpstring("MyControl Class") ] coclass MyControl { [default] interface IMyControl; [default, source] dispinterface _IMyControlEvents; }; };</span></span></code> </pre> <br><br>  Save this file to a file, and call it MyActiveX.idl <br><br>  As you can see, we recorded the definition of two interfaces, as well as the description of the COM class that implements our interfaces.  The first, IMyControl, is the component's interface itself, and the second is needed to alert the outside world about events that happen to our control.  We have no events recorded, and we will not do them in our example, so this interface is empty. <br><br>  The interface implemented by our class belongs to the so-called dual-interfaces.  This means that it can be used not only from languages ‚Äã‚Äãcapable of communicating with native-code, and accordingly, capable of communicating with COM components via virtual method tables, but also from scripting languages ‚Äã‚Äãthrough the IDispatch interface. <br><br>  Next, we need to write down the definitions of IMyControl and _IMyControlEvents in the header file for C ++ - MyControl.hpp <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> __MY_CONTROL_HPP__ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __MY_CONTROL_HPP__ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;windows.h&gt; typedef interface IMyControl IMyControl; MIDL_INTERFACE("2B26D028-4DA6-4D69-9513-D0CA550949D1") IMyControl : IDispatch { public: virtual HRESULT STDMETHODCALLTYPE Run() = 0; virtual HRESULT STDMETHODCALLTYPE Stop() = 0; }; MIDL_INTERFACE("E7D13B5A-0A09-440A-81EA-C9E3B0105DB0") _IMyControlEvents : public IDispatch { }; DEFINE_GUID(IID_IMyControl,0x2B26D028,0x4DA6,0x4D69,0x95,0x13,0xD0,0xCA,0x55,0x09,0x49,0xD1); DEFINE_GUID(LIBID_MyActiveXLib,0x1E4E47F3,0x21AF,0x407C,0x95,0x44,0x59,0xC3,0x4C,0x81,0xF3,0xFA); DEFINE_GUID(DIID__IMyControlEvents,0xE7D13B5A,0x0A09,0x440A,0x81,0xEA,0xC9,0xE3,0xB0,0x10,0x5D,0xB0); DEFINE_GUID(CLSID_MyControl,0x5747094E,0x84FB,0x47B4,0xBC,0x0C,0xF8,0x9F,0xB5,0x83,0x89,0x5F); #endif __MY_CONTROL_HPP__</span></span></span></span></code> </pre><br><br>  The macro MIDL_INTERFACE is expanded into something like ‚Äústruct __ declspec (novtable) __ declspec (uuid (GUID string for interface))‚Äù.  Microsoft quite conveniently integrated COM into its C ++ compiler, and this allows us (and this will be seen especially well) to work with interfaces and COM components from MSVC ++, as with more or less ordinary classes and C ++ structures. <br><br>  The macro DEFINE_GUID, in turn, is expanded depending on the definition of the macro INITGUID - in the absence of the macro, it declares an extern variable of the GUID type with a specific name.  In the case of INITGUID, it also initializes it. <br><br>  Now we need to define the _Module variable, which belongs to the ATL CComModule class. <br><br>  Write the variable declaration in a separate header file, say MyActiveX.hpp <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> __MY_ACTIVE_X_HPP__ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __MY_ACTIVE_X_HPP__ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;windows.h&gt; #include &lt;atlbase.h&gt; extern CComModule _Module; #endif // __MY_ACTIVE_X_HPP__</span></span></span></span></code> </pre><br><br>  CComModule is a class that implements the functionality of a COM module, in particular, registration of component classes, initialization of a COM server, and other such things. <br><br>  To register COM servers in the registry (and COM works through the registry), we could write a reg-file, or manually create the corresponding entries in the registry, but we can also use the program regsvr32.exe, included in Windows, and allowing automatic registration, by means of the component itself.  For this, it is necessary that our library export some functions, and in particular DllRegisterServer and DllUnregisterServer. <br><br>  CComModule simplifies the whole process of automatic registration, and allows you to reduce it to calling the appropriate methods in the above-mentioned exported library functions, but it requires that the registration script be located in the dll resource section implementing the component.  Let's name the file that we add to the resources later, MyControl.rgs, and add the following text there: <br><br><pre> <code class="lisp hljs">HKCR { MyActiveX.MyControl.<span class="hljs-number"><span class="hljs-number">1</span></span> = s 'MyControl Class' { CLSID = s '{<span class="hljs-number"><span class="hljs-number">5747094E-84</span></span>FB-47B4-BC0C-F89FB583895F}' } MyActiveX.MyControl = s 'MyControl Class' { CLSID = s '{<span class="hljs-number"><span class="hljs-number">5747094E-84</span></span>FB-47B4-BC0C-F89FB583895F}' CurVer = s 'MyActiveX.MyControl.<span class="hljs-number"><span class="hljs-number">1</span></span>' } NoRemove CLSID { ForceRemove {<span class="hljs-number"><span class="hljs-number">5747094E-84</span></span>FB-47B4-BC0C-F89FB583895F} = s 'MyControl Class' { ProgID = s 'MyActiveX.MyControl.<span class="hljs-number"><span class="hljs-number">1</span></span>' VersionIndependentProgID = s 'MyActiveX.MyControl' ForceRemove 'Programmable' InprocServer32 = s '%MODULE%' { val ThreadingModel = s 'Apartment' } ForceRemove 'Control' ForceRemove 'Insertable' ForceRemove 'ToolboxBitmap32' = s '%MODULE%, <span class="hljs-number"><span class="hljs-number">101</span></span>' 'MiscStatus' = s '<span class="hljs-number"><span class="hljs-number">0</span></span>' { '<span class="hljs-number"><span class="hljs-number">1</span></span>' = s '<span class="hljs-number"><span class="hljs-number">139665</span></span>' } 'TypeLib' = s '{<span class="hljs-number"><span class="hljs-number">1E4</span></span>E47F3-21AF-407C-9544-59C34C81F3FA}' 'Version' = s '<span class="hljs-number"><span class="hljs-number">1.0</span></span>' } } }</code> </pre><br><br>  The most significant parts of the registration script are CLSID, that is, the GUID of the class of our component, ProgID, i.e.  CLSID is a human-readable representation, and ThreadingModel is a multithreading model of our component, which in this case is set to Apartment, which means that we can directly access our control only from the thread in which it was created, and all external calls, including those from outside the process (or even from another computer via DCOM) will be serialized and synchronized using COM runtime. <br><br>  By the way, about serialization, that is, or rather, about the marshaling.  In theory, in order to serialize the calls of our component methods and pointers to its interfaces, we have to put in parallel with it a separate library, the so-called proxy-dll, which will be loaded into both the client application (if it is on another computer) and the process where our COM component is loaded. <br><br>  Microsoft's MIDL compiler could generate code for the proxy library, or as it would be called proxy / stub in this case, but in our case, you can do it easier - because we have more or less standard data types, we can use marshaling runtime OLE.  For this case, we need from our IDL file, again using the MIDL compiler, midl.exe (included in both the Windows SDK and VS), compile the so-called type library (type library, tlb), and put it with our component her.  Moreover, we can further simplify the whole thing, and include the compiled type library in the DLL resource section, which we will do. <br><br>  The header file for our module resources: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> __RESOURCE_H__ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __RESOURCE_H__ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> IDB_MAIN_ICON 101 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> IDR_MYCONTROL 102 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> IDS_SHADER 103 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SHADER_RESOURCE 256 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// __RESOURCE_H__</span></span></span></span></code> </pre><br><br>  IDR_MYCONTROL - id of the registration script resource. <br>  IDB_MAIN_ICON - 16x16 icon for our component, in BMP format.  I personally took the DirectX icon from the MS DirectX SDK for this file. <br>  IDS_SHADER and SHADER_RESOURCE - the id of the resource and the type of the resource containing the shader code for drawing the sphere. <br><br>  The resource file itself, MyActiveX.rc, is: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;windows.h&gt; #include "Resource.h" LANGUAGE LANG_ENGLISH, SUBLANG_ENGLISH_US 1 TYPELIB "MyActiveX.tlb" IDR_MYCONTROL REGISTRY "MyControl.rgs" IDB_MAIN_ICON BITMAP "DirectX.bmp" IDS_SHADER SHADER_RESOURCE "MyActiveX.fx" VS_VERSION_INFO VERSIONINFO FILEVERSION 1,0,0,0 PRODUCTVERSION 1,0,0,0 FILEFLAGSMASK 0x3fL #ifdef _DEBUG FILEFLAGS 0x1L #else FILEFLAGS 0x0L #endif FILEOS 0x4L FILETYPE 0x2L FILESUBTYPE 0x0L BEGIN BLOCK "StringFileInfo" BEGIN BLOCK "040904B0" BEGIN VALUE "CompanyName", "\0" VALUE "FileDescription", "MyActiveX component module\0" VALUE "FileVersion", "1, 0, 0, 0\0" VALUE "InternalName", "MyActiveX\0" VALUE "LegalCopyright", "Copyright 2012 (C) Dmitry Ignatiev &lt;lovesan.ru at gmail.com&gt;\0" VALUE "OriginalFilename", "MyActiveX.dll\0" VALUE "ProductName", "MyActiveX component module\0" VALUE "ProductVersion", "1, 0, 0, 0\0" VALUE "OLESelfRegister", "\0" END END BLOCK "VarFileInfo" BEGIN VALUE "Translation", 0x409, 1200 END END</span></span></span></span></code> </pre><br><br>  We now turn directly to the implementation of our control. <br>  Name the class CMyControl, and create the header file CMyControl.hpp <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> __CMY_CONTROL_HPP__ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __CMY_CONTROL_HPP__ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;atlbase.h&gt; #include &lt;atlcom.h&gt; #include &lt;atlctl.h&gt; #include "Resource.h" #include "MyActiveX.hpp" #include "MyControl.hpp" class DECLSPEC_UUID("5747094E-84FB-47B4-BC0C-F89FB583895F") CMyControl : public CComObjectRootEx&lt;CComSingleThreadModel&gt;, public CStockPropImpl&lt;CMyControl, IMyControl, &amp;IID_IMyControl, &amp;LIBID_MyActiveXLib&gt;, public CComControl&lt;CMyControl&gt;, public IPersistStreamInitImpl&lt;CMyControl&gt;, public IPersistPropertyBagImpl&lt;CMyControl&gt;, public IObjectSafetyImpl&lt;CMyControl, INTERFACESAFE_FOR_UNTRUSTED_CALLER | INTERFACESAFE_FOR_UNTRUSTED_DATA&gt;, public IOleControlImpl&lt;CMyControl&gt;, public IOleObjectImpl&lt;CMyControl&gt;, public IOleInPlaceActiveObjectImpl&lt;CMyControl&gt;, public IViewObjectExImpl&lt;CMyControl&gt;, public IOleInPlaceObjectWindowlessImpl&lt;CMyControl&gt;, public IConnectionPointContainerImpl&lt;CMyControl&gt;, public IPersistStorageImpl&lt;CMyControl&gt;, public ISpecifyPropertyPagesImpl&lt;CMyControl&gt;, public IQuickActivateImpl&lt;CMyControl&gt;, public IDataObjectImpl&lt;CMyControl&gt;, public IProvideClassInfo2Impl&lt;&amp;CLSID_MyControl, &amp;DIID__IMyControlEvents, &amp;LIBID_MyActiveXLib&gt;, public IPropertyNotifySinkCP&lt;CMyControl&gt;, public CComCoClass&lt;CMyControl, &amp;CLSID_MyControl&gt; { public: DECLARE_REGISTRY_RESOURCEID(IDR_MYCONTROL) DECLARE_PROTECT_FINAL_CONSTRUCT() BEGIN_COM_MAP(CMyControl) COM_INTERFACE_ENTRY(IMyControl) COM_INTERFACE_ENTRY(IDispatch) COM_INTERFACE_ENTRY(IViewObjectEx) COM_INTERFACE_ENTRY(IViewObject2) COM_INTERFACE_ENTRY(IViewObject) COM_INTERFACE_ENTRY(IOleInPlaceObjectWindowless) COM_INTERFACE_ENTRY(IOleInPlaceObject) COM_INTERFACE_ENTRY2(IOleWindow, IOleInPlaceObjectWindowless) COM_INTERFACE_ENTRY(IOleInPlaceActiveObject) COM_INTERFACE_ENTRY(IOleControl) COM_INTERFACE_ENTRY(IOleObject) COM_INTERFACE_ENTRY(IPersistStreamInit) COM_INTERFACE_ENTRY(IPersistPropertyBag) COM_INTERFACE_ENTRY(IObjectSafety) COM_INTERFACE_ENTRY2(IPersist, IPersistStreamInit) COM_INTERFACE_ENTRY(IConnectionPointContainer) COM_INTERFACE_ENTRY(ISpecifyPropertyPages) COM_INTERFACE_ENTRY(IQuickActivate) COM_INTERFACE_ENTRY(IPersistStorage) COM_INTERFACE_ENTRY(IDataObject) COM_INTERFACE_ENTRY(IProvideClassInfo) COM_INTERFACE_ENTRY(IProvideClassInfo2) END_COM_MAP() BEGIN_PROP_MAP(CMyControl) END_PROP_MAP() BEGIN_CONNECTION_POINT_MAP(CMyControl) CONNECTION_POINT_ENTRY(IID_IPropertyNotifySink) END_CONNECTION_POINT_MAP() BEGIN_MSG_MAP(CMyControl) MESSAGE_HANDLER(WM_SETFOCUS, OnSetFocus) MESSAGE_HANDLER(WM_CREATE, OnCreate) MESSAGE_HANDLER(WM_DESTROY, OnDestroy) MESSAGE_HANDLER(WM_SIZE, OnSize) MESSAGE_HANDLER(WM_TIMER, OnTimer) CHAIN_MSG_MAP(CComControl&lt;CMyControl&gt;) END_MSG_MAP() DECLARE_VIEW_STATUS(VIEWSTATUS_SOLIDBKGND | VIEWSTATUS_OPAQUE) CMyControl(); ~CMyControl(); STDMETHOD(Run)(); STDMETHOD(Stop)(); HRESULT OnDraw(ATL_DRAWINFO&amp; di); private: LRESULT OnCreate(UINT /*uMsg*/, WPARAM /*wParam*/, LPARAM /*lParam*/, BOOL&amp; /*bHandled*/); LRESULT OnDestroy(UINT /*uMsg*/, WPARAM /*wParam*/, LPARAM /*lParam*/, BOOL&amp; /*bHandled*/); LRESULT OnSize(UINT /*uMsg*/, WPARAM /*wParam*/, LPARAM /*lParam*/, BOOL&amp; /*bHandled*/); LRESULT OnTimer(UINT /*uMsg*/, WPARAM /*wParam*/, LPARAM /*lParam*/, BOOL&amp; /*bHandled*/); CMyControl(const CMyControl&amp; copy); class CMyControlImpl; CMyControlImpl *_impl; }; #endif // __CMY_CONTROL_HPP__</span></span></span></span></code> </pre><br><br>  As you can see, the definition of the class turned out quite large. <br>  To implement ActiveX control, our class, in fact, has to implement a very rather large number of various COM interfaces, starting from IDispatch, but since we use ATL, the process is greatly simplified, thanks to inheritance from special classes whose names end with ‚ÄúImpl ¬ª, Which, strictly speaking, implement the functionality necessary for interfaces in a standard form. <br><br>  The three most important basic class of our CMyControl - CComObjectRootEx, managing, inter alia, reference counting objects of our class, CComCoClass, implements the class factory (IClassFactory), and CComControl, in turn inherits from CWindowImpl (class, wrapping the HWND, ie the window handle) , and implementing most of the functionality necessary for embedded ActiveX controls. <br><br>  The most significant macros in the class body: <br><br>  DECLARE_REGISTRY_RESOURCEID - indicates the id of the resource where the component registration script is located. <br><br>  BEGIN_COM_MAP + END_COM_MAP - implements the IUnknown interface's QueryInterface method (which is at the top of the COM interface hierarchy), which allows you to get references to different object interfaces (and each of the COM_INTERFACE_ENTRY indicates one of the options). <br><br>  BEGIN_CONNECTION_POINT_MAP and the corresponding END are necessary to implement the interfaces associated with control event notifications. <br><br>  BEGIN_MSG_MAP, MESSAGE_HANDLER and END_MSG_MAP - implement the display of Windows-window messages on the methods of C ++ classes. <br><br>  The OnDraw method will be called every time the control receives a message about the need for a redraw from the system.  In addition, the control redrawing will be called by timer. <br><br>  All the functionality of our component, and, in particular, working with Direct3D, is implemented by the private class CMyControlImpl, according to the pimpl pattern, in the CMyControl.cpp file.  I will not describe it in detail, I will only note that in the constructor of CMyControl itself, it is necessary to set the internal property m_bWindowOnly to TRUE - this will mean that our component supports embedding solely into a graphic application. <br><br>  Also, it is worth noting that in the implementation of the component for managing the counting of references to COM interfaces, the template class CCOMPtr smart pointer from ATL is actively used, very similar to the intrusive_ptr of boost. <br><br>  Now we will create the MyActiveX.cpp file, in which we will define the class GUIDs and interfaces, the _Module variable, the DLL entry point and the exported functions necessary for the ActiveX module: <br><pre> <code class="hljs kotlin">#include &lt;windows.h&gt; #include &lt;atlbase.h&gt; #include <span class="hljs-string"><span class="hljs-string">"MyActiveX.hpp"</span></span> #include <span class="hljs-string"><span class="hljs-string">"CMyControl.hpp"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IID IID_IMyControl = {<span class="hljs-number"><span class="hljs-number">0x2B26D028</span></span>,<span class="hljs-number"><span class="hljs-number">0x4DA6</span></span>,<span class="hljs-number"><span class="hljs-number">0x4D69</span></span>,{<span class="hljs-number"><span class="hljs-number">0x95</span></span>,<span class="hljs-number"><span class="hljs-number">0x13</span></span>,<span class="hljs-number"><span class="hljs-number">0xD0</span></span>,<span class="hljs-number"><span class="hljs-number">0xCA</span></span>,<span class="hljs-number"><span class="hljs-number">0x55</span></span>,<span class="hljs-number"><span class="hljs-number">0x09</span></span>,<span class="hljs-number"><span class="hljs-number">0x49</span></span>,<span class="hljs-number"><span class="hljs-number">0xD1</span></span>}}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IID LIBID_MyActiveXLib = {<span class="hljs-number"><span class="hljs-number">0x1E4E47F3</span></span>,<span class="hljs-number"><span class="hljs-number">0x21AF</span></span>,<span class="hljs-number"><span class="hljs-number">0x407C</span></span>,{<span class="hljs-number"><span class="hljs-number">0x95</span></span>,<span class="hljs-number"><span class="hljs-number">0x44</span></span>,<span class="hljs-number"><span class="hljs-number">0x59</span></span>,<span class="hljs-number"><span class="hljs-number">0xC3</span></span>,<span class="hljs-number"><span class="hljs-number">0x4C</span></span>,<span class="hljs-number"><span class="hljs-number">0x81</span></span>,<span class="hljs-number"><span class="hljs-number">0xF3</span></span>,<span class="hljs-number"><span class="hljs-number">0xFA</span></span>}}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IID DIID__IMyControlEvents= {<span class="hljs-number"><span class="hljs-number">0xE7D13B5A</span></span>,<span class="hljs-number"><span class="hljs-number">0x0A09</span></span>,<span class="hljs-number"><span class="hljs-number">0x440A</span></span>,{<span class="hljs-number"><span class="hljs-number">0x81</span></span>,<span class="hljs-number"><span class="hljs-number">0xEA</span></span>,<span class="hljs-number"><span class="hljs-number">0xC9</span></span>,<span class="hljs-number"><span class="hljs-number">0xE3</span></span>,<span class="hljs-number"><span class="hljs-number">0xB0</span></span>,<span class="hljs-number"><span class="hljs-number">0x10</span></span>,<span class="hljs-number"><span class="hljs-number">0x5D</span></span>,<span class="hljs-number"><span class="hljs-number">0xB0</span></span>}}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CLSID CLSID_MyControl= {<span class="hljs-number"><span class="hljs-number">0x5747094E</span></span>,<span class="hljs-number"><span class="hljs-number">0x84FB</span></span>,<span class="hljs-number"><span class="hljs-number">0x47B4</span></span>,{<span class="hljs-number"><span class="hljs-number">0xBC</span></span>,<span class="hljs-number"><span class="hljs-number">0x0C</span></span>,<span class="hljs-number"><span class="hljs-number">0xF8</span></span>,<span class="hljs-number"><span class="hljs-number">0x9F</span></span>,<span class="hljs-number"><span class="hljs-number">0xB5</span></span>,<span class="hljs-number"><span class="hljs-number">0x83</span></span>,<span class="hljs-number"><span class="hljs-number">0x89</span></span>,<span class="hljs-number"><span class="hljs-number">0x5F</span></span>}}; CComModule _Module; BEGIN_OBJECT_MAP(ObjectMap) OBJECT_ENTRY(CLSID_MyControl, CMyControl) END_OBJECT_MAP() extern <span class="hljs-string"><span class="hljs-string">"C"</span></span> BOOL WINAPI DllMain(HINSTANCE hInstance, DWORD dwReason, LPVOID lpReserved) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(DLL_PROCESS_ATTACH == dwReason) { _Module.Init(ObjectMap, hInstance, &amp;LIBID_MyActiveXLib); DisableThreadLibraryCalls(hInstance); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(DLL_PROCESS_DETACH == dwReason) _Module.Term(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TRUE; } STDAPI DllCanUnloadNow(void) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (_Module.GetLockCount()==<span class="hljs-number"><span class="hljs-number">0</span></span>) ? S_OK : S_FALSE; } STDAPI DllGetClassObject(REFCLSID rclsid, REFIID riid, LPVOID* ppv) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _Module.GetClassObject(rclsid, riid, ppv); } STDAPI DllRegisterServer(void) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _Module.RegisterServer(TRUE); } STDAPI DllUnregisterServer(void) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _Module.UnregisterServer(TRUE); }</code> </pre><br><br>  Before compiling the dll, let's determine which functions our module exports in the def file: <br><pre> <code class="hljs vbscript">LIBRARY <span class="hljs-string"><span class="hljs-string">"MyActiveX.dll"</span></span> EXPORTS DllCanUnloadNow <span class="hljs-keyword"><span class="hljs-keyword">PRIVATE</span></span> DllGetClassObject <span class="hljs-keyword"><span class="hljs-keyword">PRIVATE</span></span> DllRegisterServer <span class="hljs-keyword"><span class="hljs-keyword">PRIVATE</span></span> DllUnregisterServer <span class="hljs-keyword"><span class="hljs-keyword">PRIVATE</span></span></code> </pre><br><br>  The entire project source code, including the Makefile for building using the Windows SDK, is provided on github, at the link at the end of the article.  But first, a few examples of embedding the component: <br><br><h3>  Embedding in HTML page </h3><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Test page for MyControl ActiveX object<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> running = </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">false</span></span></span><span class="javascript">; </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">OnClick</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> ctl = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"MyControl"</span></span></span><span class="javascript">); </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> btn = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"btn"</span></span></span><span class="javascript">); </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript">(running) { ctl.Stop(); running = </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">false</span></span></span><span class="javascript">; btn.value = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"Run"</span></span></span><span class="javascript">; } </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">else</span></span></span><span class="javascript"> { ctl.Run(); running = </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">true</span></span></span><span class="javascript">; btn.value = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"Stop"</span></span></span><span class="javascript">; } } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">center</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Run"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display:block; padding: 3px 20px;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"OnClick();"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MyControl"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width:500px; height:500px;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CLSID:5747094E-84FB-47B4-BC0C-F89FB583895F"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">center</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/409/4ff/2ee/4094ff2eed0e868bc40d9ae940933a96.png"><br><br><h3>  Embedding in application on Windows. Forms </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Windows.Forms; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyControl</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyControl</span></span> : <span class="hljs-title"><span class="hljs-title">AxHost</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyControl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"5747094E-84FB-47B4-BC0C-F89FB583895F"</span></span></span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> ax = GetOcx(); ax.Run(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> ax = GetOcx(); ax.Stop(); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { [STAThread] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Application.EnableVisualStyles(); Form f = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Form(); f.Text = <span class="hljs-string"><span class="hljs-string">"My control"</span></span>; f.StartPosition = FormStartPosition.CenterScreen; f.Width = <span class="hljs-number"><span class="hljs-number">640</span></span>; f.Height = <span class="hljs-number"><span class="hljs-number">480</span></span>; MyControl c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyControl(); c.Dock = DockStyle.Fill; c.BeginInit(); Button b = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Button(); b.Dock = DockStyle.Top; b.Text = <span class="hljs-string"><span class="hljs-string">"Run/Stop"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> running = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; b.Click += (s, e) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (running) { c.Stop(); running = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { c.Run(); running = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }; f.Controls.Add(b); f.Controls.Add(c); f.ShowDialog(); } } }</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/1a9/5b2/3e4/1a95b23e469c358b52c0b30a4a59c23a.png"><br><br>  Source Code: <a href="http://github.com/Lovesan/MyActiveX">github.com/Lovesan/MyActiveX</a> </div><p>Source: <a href="https://habr.com/ru/post/149277/">https://habr.com/ru/post/149277/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149271/index.html">Canon has released firmware v2.0 for Canon 7D</a></li>
<li><a href="../149272/index.html">Apple lawyers continue to dig under Samsung</a></li>
<li><a href="../149273/index.html">Fast index modulo multiplication</a></li>
<li><a href="../149274/index.html">How to keep the address database in order</a></li>
<li><a href="../149276/index.html">Feel like a rover! Interactive panoramas of Mars</a></li>
<li><a href="../149278/index.html">Old maps and GoogleMaps</a></li>
<li><a href="../149279/index.html">Sony VAIO Z Ultrabook (SVZ-1311V) Ultra Video Review</a></li>
<li><a href="../149282/index.html">Scouting Robot on Ubuntu and Node.js</a></li>
<li><a href="../149287/index.html">Overload and inheritance</a></li>
<li><a href="../149289/index.html">Manage the kettle from the browser or as I did the Internet outlet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>