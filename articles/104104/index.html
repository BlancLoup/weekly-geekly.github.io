<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compilation. 10: compile in ELF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last time, we limited ourselves to compiling j-squeaks to a file in our own format, which required a special loader. In addition, we conceived a coupl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Compilation. 10: compile in ELF</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/blogs/programming/103402/">Last time,</a> we limited ourselves to compiling j-squeaks to a file in our own format, which required a special loader.  In addition, we conceived a couple of executable code optimizations that require analysis of neighboring commands. <br><br><h3>  Further in the post: </h3><ol><li>  Peephole Optimization </li><li>  Standard features </li><li>  Output to ELF </li><li>  How it works? </li><li>  What happened? </li></ol><a name="habracut"></a><h3>  Peephole Optimization </h3><br>  To realize the planned optimizations, firstly, we divide the common vector <code>code</code> into small vectors of the generated machine code for each command, and at the end we will glue them together. <br><br>  Secondly, two passes are not enough for us: on the first pass, we generate machine code for each team, on the second - we perform optimizations, on the third - ‚Äúpolish‚Äù, filling in offsets of jumps and lines.  Simultaneously with the calculation of jumps offsets, we will replace the near ( <i>near</i> ) jumps with short ( <i>short</i> ) <i>whenever</i> possible, so that on the third pass the code will be further reduced, and one more pass will be needed - the fourth;  on it we will again correct the displacement of jumps that have changed due to the reduction of the code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Each team will have to store the number of generated <code>POP</code> , because by machine code alone it is difficult to understand whether the last byte is a <code>POP</code> instruction, or simply matches the value.  The number of generated <code>PUSH</code> not necessary to store: the first byte of the machine code is decrypted unambiguously. <br><pre> <code class="cpp hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">commandn</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... int offset; //    int needfixat; //  JZ, ECHO int popcnt; // INPUT, ECHO std::vector&lt;unsigned char&gt; code;//   // ... void pop_back(int c = 1) { code.resize(code.size()-c); } void pop_front(int c = 1) { code.erase(code.begin(), code.begin()+c); } }; // ... // ""    JZ: // ,     case command::jz: if(!i-&gt;cmd.dest) // JMP off i-&gt;emit(0xe9); else { // OR dst, dst / JZ off i-&gt;emit(0x0b, 0xc0|(i-&gt;cmd.dest-1)&lt;&lt;3|(i-&gt;cmd.dest-1)); i-&gt;emit(0x0f, 0x84); } i-&gt;needfixat = i-&gt;code.size(); i-&gt;emit4(0); break; // ... //  ECHO  INPUT   popcnt; //   --   case command::input: foreach(rp, i-&gt;onenterp) if(*rp!=4) i-&gt;emit(0x50|(*rp-1)); i-&gt;emit(0xff, 0x55, 0); if(i-&gt;cmd.dest!=1) i-&gt;emit(0x90|(i-&gt;cmd.dest-1)); foreachr(rp, i-&gt;onenterp) if(*rp!=4) { i-&gt;emit(0x58|(*rp-1)); i-&gt;popcnt++; } break; // ... //  :   ,    int offset = 0; foreach2(i,pcode,next) { i-&gt;offset = offset; //  "POP-PUSH" while(i-&gt;popcnt &amp;&amp; ((next-&gt;code[0]&amp;0xfc) == 0x50) &amp;&amp; ((i-&gt;code.back()&amp;3) == (next-&gt;code[0]&amp;3)) &amp;&amp; //  :     !((next-&gt;cmd.opcode==command::echo) &amp;&amp; (next-&gt;cmd.dest==(next-&gt;code[0]&amp;3)+1))) { i-&gt;pop_back(); next-&gt;pop_front(); i-&gt;popcnt--; if(next-&gt;needfixat) next-&gt;needfixat--; } //  "-JZ" if((i-&gt;cmd.opcode&gt;=command::eq) &amp;&amp; (next-&gt;cmd.opcode==command::jz) &amp;&amp; (i-&gt;cmd.dest==next-&gt;cmd.dest) &amp;&amp; !next-&gt;onexitp.count((physreg)next-&gt;cmd.dest)) { char cc = i-&gt;code[i-&gt;code.size()-5]; // cond code i-&gt;pop_back(6); // SETcc / MOVZX next-&gt;code.clear(); //    next-&gt;emit(0x0f, cc^0x11); next-&gt;needfixat = next-&gt;code.size(); next-&gt;emit4(0); } offset += i-&gt;code.size(); } //  :    offset = 0; foreach(i, pcode) { i-&gt;offset = offset; if(i-&gt;cmd.opcode==command::jz) { int joffset = i-&gt;tgt-&gt;offset-(i-&gt;offset+i-&gt;code.size()); if((joffset&gt;=-128) &amp;&amp; (joffset&lt;128)) { //   if(!i-&gt;cmd.dest) { // JMP SHORT i-&gt;code.clear(); i-&gt;emit(0xeb, (char)joffset); } else if(i-&gt;code[0]==0x0b &amp;&amp; i-&gt;code[1]==0xc9) { // OR ECX, ECX i-&gt;code.clear(); i-&gt;emit(0xe3, (char)joffset); // JECXZ } else { char cc = i-&gt;code[i-&gt;code.size()-5]; // cond code i-&gt;pop_back(6); i-&gt;emit(cc^0xf0, (char)joffset);// Jcc SHORT } i-&gt;needfixat = i-&gt;code.size()-1; //     } } offset += i-&gt;code.size(); } //  :     foreach(i, pcode) if(i-&gt;needfixat) if(i-&gt;cmd.opcode==command::jz) { int joffset = i-&gt;tgt-&gt;offset-(i-&gt;offset+i-&gt;code.size()); switch(i-&gt;code[i-&gt;needfixat]-1) { case 0xeb: case 0xe3: case 0x74: case 0x75: case 0x7c: case 0x7d: case 0x7e: case 0x7f: i-&gt;code[i-&gt;needfixat] = (char)joffset; break; // short default: i-&gt;fix4(joffset); } } else if (i-&gt;cmd.opcode==command::echo) i-&gt;fix4(offsets[i-&gt;cmd.imm]);</span></span></code> </pre><br><br><h3>  Standard features </h3><br>  Last time, the implementation of the standard functions <code>input,echoi,echos</code> was in our bootloader.  This time there will be no bootloader;  where will the functions be? <br><br>  We can, in principle, insert their code into each generated binary;  but it is ugly.  Instead, we compile them into a separate <code>.o</code> file, which will then be linked to our file.  The advantage of this approach is to isolate the platform dependency: all the differences between x86 and x64, which, from the point of view of our compiler, lie in the way we call ssh functions, hide it in a platform-dependent library, and we will generate a platform-independent code. <br><br>  It is convenient for us that our standard functions take a parameter in <code>ESI</code> , and return the result to <code>EAX</code> .  So do.  Here is the implementation for x64: <br><pre> <code class="lisp hljs">.global input,echoi,echos .text fd: .asciz <span class="hljs-string"><span class="hljs-string">"%d"</span></span> fs: .asciz <span class="hljs-string"><span class="hljs-string">"%s"</span></span> input: push %rax lea fd, %edi xor %eax, %eax mov %rsp, %rsi call scanf pop %rax ret echoi: lea fd, %edi echo: xor %eax, %eax jmp printf echos: movslq %esi, %rsi add %rbp, %rsi lea fs, %edi jmp echo</code> </pre><br>  And here is for x86: <br><pre> <code class="lisp hljs">.global input,echoi,echos .text fd: .asciz <span class="hljs-string"><span class="hljs-string">"%d"</span></span> fs: .asciz <span class="hljs-string"><span class="hljs-string">"%s"</span></span> input: push %eax push %esp push $fd call scanf pop %eax pop2: pop %eax pop %eax ret echoi: push %esi push $fd echo: call printf jmp pop2 echos: add %ebp, %esi push %esi push $fs jmp echo</code> </pre><br><br><h3>  Output to ELF </h3><br>  Our executable code is almost ready;  it remains only to "pack" it so that the OS can link it and run it. <br><br>  In memory, the code will consist of the same parts as before: code, data, communication area for calling standard functions.  The difference between the <code>.o</code> file format and directly executable files ‚Äî that in <code>.o</code> co-location of program parts ( <i>sections</i> ) in memory is unknown;  therefore, the compiler cannot generate a link from one section to an address in another.  Instead, the compiler generates an indication to the linker - a <i>relocation</i> indicating what address to calculate when linking, and how to calculate it.  Therefore, the <code>.o</code> files in <a href="http://www.skyfree.org/linux/references/ELF_Format.pdf">the ELF format specification are</a> called <i>relocated</i> . <br><br>  It would be possible to divide the data into two sections: separately initialized and unchangeable (communication area and lines), uninitialized and changeable separately (cells for poured registers);  but then on x86 we would not have enough registers to constantly store the base addresses of both data sections, which means we would have to generate a relocation for each call.  Simplify your life, and get along with one section of data. <br>  For the same reason, to call standard functions, we use the communication area: to call directly we would need to create a relocation for each call.  Let's make the communication area 24-byte both on x86 and x64 - again, for simplicity and cross-platform.  On x64, it will simply be an array of three pointers (to <code>input,echoi,echos</code> );  on x86, each pointer will be followed by a 4-byte stub. <br><br>  It turns out that we will always have four relocations: three addresses of standard functions in the field of communication, and the loading of the base address of data into <code>RBP/EBP</code> first command of the program.  As a result, the generation of the ‚Äúrelocated‚Äù code will hardly differ from the generation of the ‚Äúsolid piece‚Äù last time.  In some respects, it will even be simplified: since the lines will now be stored separately from the code, we can memorize their offsets right at the syntactic parsing stage;  this way we will completely get rid of the ‚Äútemporary identifiers of strings‚Äù and the stage of their binding before outputting the compiled code.  In addition, the method of calling standard functions will no longer depend on the platform. <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; stringmap; stringmap strings; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> laststr = <span class="hljs-number"><span class="hljs-number">24</span></span>; <span class="hljs-comment"><span class="hljs-comment">//       std::vector&lt;stringmap::iterator&gt; strdata; //   // ... //    VAL: ID '(' ARGS ')' if (!$1.compare("echo")) { if(!$3.size()) yyerror("Input: too many arguments"); $$ = 0; foreach(i, $3) if(!i-&gt;dest) // string if(strings.count(i-&gt;str)) emit(command::echo, 0, strings[i-&gt;str]); else { strdata.push_back(strings.insert(stringmap::value_type(i-&gt;str,laststr)).first); emit(command::echo, 0, laststr); laststr += i-&gt;str.length()+1; } else emit(command::echo, i-&gt;dest, 0); } // ... // (    -) case command::hlt: i-&gt;emit(0x5b, 0x5e, 0x5f, 0x5d); // POP EBX / POP ESI / POP EDI / POP EBP i-&gt;emit(0xc3); // RET break; case command::echo: // PUSH live / MOV EDI, dst / CALL [EBP+?] / POP live foreach(rp, i-&gt;onexitp) if(*rp!=4) i-&gt;emit(0x50|(*rp-1)); if(!i-&gt;cmd.dest) { // imm / [EBP+16] i-&gt;emit14(0xbe, i-&gt;cmd.imm); i-&gt;emit(0xff, 0x55, 16); } else { if(i-&gt;known.count(i-&gt;cmd.dest)) // imm / [EBP+4] i-&gt;emit14(0xbe, i-&gt;known[i-&gt;cmd.dest]); else // dst / [EBP+8] i-&gt;emit(0x8b, 0xf0|(i-&gt;cmd.dest-1)); i-&gt;emit(0xff, 0x55, 8); } foreachr(rp, i-&gt;onexitp) if(*rp!=4) { i-&gt;emit(0x58|(*rp-1)); i-&gt;popcnt++; } break;</span></span></code> </pre><br>  Relocations in ELF come in two formats: <code>rel</code> or <code>rela</code> .  The <code>rel</code> format is smaller, but the linker is easier to work with <code>rela</code> ;  therefore, when switching to the x64 platform, <code>rel</code> type relocations were declared ‚Äú <i>deprecated</i> ‚Äù.  However, my version of <code>ld</code> supports <code>rel</code> in 64-bit code, so we‚Äôll generate <code>rel</code> . <br><br>  Generate eight standard sections: empty, <code>.shstrtab, .strtab, .symtab, .rel.text, .rel.data, .text, .data</code> .  The ELF header and first six sections have predefined content;  only <code>.text</code> and <code>.data</code> filled depending on the generated code. <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  ELF #include &lt;linux/elf.h&gt; #if ELF_CLASS == ELFCLASS32 #define Elf_Shdr Elf32_Shdr #define Elf_Sym Elf32_Sym #define Elf_Rel Elf32_Rel #define ELF_R_INFO(s,t) (((s)&lt;&lt;8)+(unsigned char)(t)) #define R_32 R_386_32 #else #define Elf_Shdr Elf64_Shdr #define Elf_Sym Elf64_Sym #define Elf_Rel Elf64_Rel #define ELF_R_INFO(s,t) (((unsigned long)(s)&lt;&lt;32)+(t)) #define R_32 R_X86_64_32 #endif #define ST_GLOBAL_NOTYPE STB_GLOBAL&lt;&lt;4 // ... //    : //       //     // : PUSH EBP / PUSH EDI / PUSH ESI / PUSH EBX / MOV RBP, ... const char prolog[] = {0x55,0x57,0x56,0x53,0x48,0xc7,0xc5,0,0,0,0}; offset += sizeof(prolog); int alignment = ((offset+3)&amp;~3) - offset; //   dword offset += alignment; const struct { elfhdr hdr; Elf_Shdr Shdr[8]; char shstrtab[64]; char strtab[24]; Elf_Sym symtab[6]; Elf_Rel reltext[1]; Elf_Rel reldata[3]; } elf = {{{ELFMAG0, ELFMAG1, ELFMAG2, ELFMAG3, ELF_CLASS, ELF_DATA, EV_CURRENT}, // identification ET_REL, ELF_ARCH, EV_CURRENT, 0, 0, sizeof(elfhdr), 0, sizeof(elfhdr), 0, 0, sizeof(Elf_Shdr),8, 1}, {{0, SHT_NULL}, {1, SHT_STRTAB, 0, 0, (char*)&amp;elf.shstrtab-(char*)&amp;elf, sizeof(elf.shstrtab), 0, 0, 1, 0}, {11, SHT_STRTAB, 0, 0, (char*)&amp;elf.strtab-(char*)&amp;elf, sizeof(elf.strtab), 0, 0, 1, 0}, {19, SHT_SYMTAB, 0, 0, (char*)&amp;elf.symtab-(char*)&amp;elf, sizeof(elf.symtab), 2, 2, 8,sizeof(Elf_Sym)}, {27, SHT_REL, 0, 0, (char*)&amp;elf.reltext-(char*)&amp;elf, sizeof(elf.reltext), 3, 6, 8, sizeof(Elf_Rel)}, {37, SHT_REL, 0, 0, (char*)&amp;elf.reldata-(char*)&amp;elf, sizeof(elf.reldata), 3, 7, 8, sizeof(Elf_Rel)}, {47, SHT_PROGBITS, SHF_ALLOC|SHF_EXECINSTR, 0, sizeof(elf), offset, 0, 0, 4, 0}, {53, SHT_PROGBITS, SHF_ALLOC|SHF_WRITE, 0, sizeof(elf)+offset, laststr+lastspill*4, 0, 0, 4, 0}}, "\0.shstrtab\0.strtab\0.symtab\0.rel.text\0.rel.data\0.text\0.data", // shstrtab "\0main\0input\0echoi\0echos", // strtab {{}, #if ELF_CLASS == ELFCLASS32 {0, 0, 0, STT_SECTION, 0, 7}, {1, 0, 0, ST_GLOBAL_NOTYPE, 0, 6}, // main {6, 0, 0, ST_GLOBAL_NOTYPE, 0, 0}, // input {12, 0, 0, ST_GLOBAL_NOTYPE, 0, 0}, // echoi {18, 0, 0, ST_GLOBAL_NOTYPE, 0, 0}}, // echos #else {0, STT_SECTION, 0, 7, 0, 0}, {1, ST_GLOBAL_NOTYPE, 0, 6, 0, 0}, // main {6, ST_GLOBAL_NOTYPE, 0, 0, 0, 0}, // input {12, ST_GLOBAL_NOTYPE, 0, 0, 0, 0}, // echoi {18, ST_GLOBAL_NOTYPE, 0, 0, 0, 0}}, // echos #endif {{7, ELF_R_INFO(1,R_32)}}, // reltext {{0, ELF_R_INFO(3,1)}, // input {8, ELF_R_INFO(4,1)}, // echoi {16, ELF_R_INFO(5,1)}} // echos }; write(1, &amp;elf, sizeof(elf)); //   write(1, prolog, sizeof(prolog)); foreach(i, pcode) write(1, &amp;*i-&gt;code.begin(), i-&gt;code.size()); //   dword const char zero[24] = {}; write(1, zero, alignment); //   write(1, zero, 24); //   foreach(i, strdata) write(1, (*i)-&gt;first.c_str(), (*i)-&gt;first.length()+1); //     ftruncate(1, sizeof(elf)+offset+laststr+lastspill*4);</span></span></code> </pre><br><br><h3>  How it works? </h3><br>  In the invariable header, which we append to the generated code, a bunch of incomprehensible digits.  What do they all mean? <br>  Let's go in order. <ul><li>  <code>ELFMAG0,ELFMAG1,ELFMAG2,ELFMAG3</code> : four ‚Äúmagic bytes‚Äù with which the ELF file must begin; </li><li>  <code>ELF_CLASS,ELF_DATA,EV_CURRENT</code> : identifiers of the ‚Äúbitness‚Äù (word width), byte order in the word, and ELF format versions.  Depending on these identifiers, the rest of the header is decrypted (in its 32-bit and 64-bit versions there are different sizes of fields); </li><li>  <code>ET_REL</code> : ELF file type (‚Äúrelocated‚Äù, ‚Äúexecutable‚Äù, ‚Äúdynamic library‚Äù); </li><li>  <code>ELF_ARCH,EV_CURRENT</code> : processor identifier and format version again; </li><li>  <code>0,0</code> : the address of the entry point and the offset of the segment table.  In relocated files there is neither one nor the other; </li><li>  <code>sizeof(elfhdr)</code> : the offset of the section table.  With us it will go right after the headline; </li><li>  <code>0</code> : flags, not defined on x86 / x64; </li><li>  <code>sizeof(elfhdr)</code> : header size; </li><li>  <code>0,0</code> : size and number of entries in the segment table.  We did not have this table either; </li><li>  <code>sizeof(Elf_Shdr),8</code> : size and number of entries in the section table; </li><li>  <code>1</code> : the number of the section containing the names of all sections; </li><li>  <code>"\0.shstrtab\0.strtab\0.symtab\0.rel.text\0.rel.data\0.text\0.data"</code> : the names of all sections, one after another.  The first character of the string must be <code>\0</code> , so that a zero offset indicates an empty name; </li><li>  <code>{0, SHT_NULL}</code> : section # 0 should be empty according to the standard; </li><li>  <code>1</code> : section name (offset inside <code>shstrtab</code> ); </li><li>  <code>SHT_STRTAB</code> : type of section (in this case, "string table"); </li><li>  <code>0</code> : flags (read, write, execute) that set the memory protection for the section.  For service sections, such as name tables, none of this is needed; </li><li>  <code>0</code> : section address in memory.  In relocated files it is not defined; </li><li>  <code>(char*)&amp;elf.shstrtab-(char*)&amp;elf,sizeof(elf.shstrtab)</code> : the offset of the section in the file, and its size; </li><li>  <code>0,0</code> : two additional fields, the interpretation of which depends on the type of section.  No rows for table; </li><li>  <code>1</code> : level block size;  for strings - 1 byte, i.e.  without alignment; </li><li>  <code>0</code> : the size of the record inside the section.  In the string table, entries of indefinite length; </li><li>  <code>{11,SHT_STRTAB,0,0,(char*)&amp;elf.strtab-(char*)&amp;elf,sizeof(elf.strtab),0,0,1,0}</code> : another table of rows.  It differs only in name (11 ‚Äî <code>.strtab</code> ); </li><li>  <code>{19,SHT_SYMTAB,0,0,(char*)&amp;elf.symtab-(char*)&amp;elf,sizeof(elf.symtab),2,2,8,sizeof(Elf_Sym)}</code> : section of the "symbol table" type.  The contents of the additional fields: the first two - the section number with the names of the characters (previous, ie <code>.strtab</code> ), the second two - the number of the first global character; </li><li>  <code>{27,SHT_REL,0,0,(char*)&amp;elf.reltext-(char*)&amp;elf,sizeof(elf.reltext),3,6,8,sizeof(Elf_Rel)}</code> : section of the "relocation table" type.  The contents of the additional fields: a link to the symbol table (previous section, also number 3) and to the relocated section ( <code>.text</code> , also number 6); </li><li>  <code>{37,SHT_REL,0,0,(char*)&amp;elf.reldata-(char*)&amp;elf,sizeof(elf.reldata),3,7,8,sizeof(Elf_Rel)}</code> : another relocation table.  Refers to the same symbol table (No. 3) and the <code>.data</code> section (No. 7); </li><li>  <code>{47,SHT_PROGBITS,SHF_ALLOC|SHF_EXECINSTR,0,sizeof(elf),offset,0,0,4,0}</code> : the data section ( <code>SHT_PROGBITS</code> ) with the ability to execute ( <code>SHF_EXECINSTR</code> ) size <code>offset</code> ; </li><li>  <code>{53,SHT_PROGBITS,SHF_ALLOC|SHF_WRITE,0,sizeof(elf)+offset,laststr+lastspill*4,0,0,4,0}</code> : <code>{53,SHT_PROGBITS,SHF_ALLOC|SHF_WRITE,0,sizeof(elf)+offset,laststr+lastspill*4,0,0,4,0}</code> data section ( <code>SHF_WRITE</code> ) with 4-byte strings cells for pouring out; </li><li>  <code>"\0main\0input\0echoi\0echos"</code> : the names of characters (imported and exported), in the same format as the names of the sections; </li><li>  <code>{}</code> : the character number 0 must remain empty; </li><li>  <code>{0, 0, 0, STT_SECTION, 0, 7}</code> : unnamed (0) local symbol pointing to section ( <code>STT_SECTION</code> ) No. 7, i.e.  <code>.data</code> ; </li><li>  <code>{1, 0, 0, ST_GLOBAL_NOTYPE, 0, 6}</code> : global (ST_GLOBAL_NOTYPE) symbol named <code>main</code> (offset of name 1) indicates offset 0 in section 6, i.e.  <code>.text</code> ; </li><li>  <code>{6, ST_GLOBAL_NOTYPE, 0, 0, 0, 0}</code> : global symbol named <code>input</code> (name offset 6), not related to any section, i.e.  imported; </li><li>  two other imported characters, <code>echoi</code> and <code>echos</code> , are defined similarly. </li></ul>  To confuse programmers, the <code>Elf32_Sym</code> and <code>Elf64_Sym</code> defined with the same fields, but in a different order.  We have no choice but to write two variants of the code, and with the help of <code>#ifdef</code> choose one of them. <br><br>  Rel type relocations consist of triples "offset of the field being relocated, symbol number, code of the binding type".  The first relocation ( <code>{7, ELF_R_INFO(1,R_32)}</code> ) is in the prologue, at offset 7 from the beginning of the code;  it specifies the base data address loaded into <code>EBP/RBP</code> .  This relocation refers to symbol # 1, i.e.  per section <code>.data</code> .  On any architecture, it has a size of 32 bits.  The binding type code is different here: <code>R_386_32=1</code> for x86, and <code>R_X86_64_32=10</code> for x64. <br>  Three other relocations are in the data, getting the addresses of three imported functions by the offset of 0.8.16.  These three relocations refer to the imported characters (Nos. 3, 4, 5), and use the binding code 1, always equal to the machine word ( <code>R_386_32,R_X86_64_64</code> ). <br><br>  Full compiler code: <a href="http://tyomitch.net.ru/jsk.y.elf.html">tyomitch.net.ru/jsk.y.elf.html</a> <br><br>  If you are interested in collecting binaries manually, I advise you to look at <a href="http://www.muppetlabs.com/~breadbox/software/tiny/teensy.html">ways to reduce the size of ELF files</a> , from practically useful tricks to crazy hacks;  and at the same time <a href="http://www.muppetlabs.com/~breadbox/software/tiny/">examples of utterly terrible programs</a> . <br><blockquote>  It turned out a file of 45 bytes in size: five times smaller than in assembler, and fifty times smaller than in C.  We threw out of the file everything we could;  and the fact that they could not throw out, we use simultaneously for two or three purposes. <br><br>  Approximately half of the values ‚Äã‚Äãin this file somehow violate the ELF standard;  a normal programmer would be ashamed to admit that such a program is the fruit of his hands.  Amazingly, Linux agrees to assign a PID to this nightmare. <br><br>  On the other hand, about every byte in this file I can explain why it is needed.  Often you can say the same about the files you compiled? <br></blockquote><br><h3>  What happened? </h3><br>  Now the final binary is made up of two independent components that we can compile separately. <br><pre> <code class="hljs perl"><code>[tyomitch@home ~]$ <b>as jskstd.s -o jskstd.o</b> <br> [tyomitch@home ~]$ <br> [tyomitch@home ~]$ <b>bison jsk.y</b> <br> [tyomitch@home ~]$ <b>c++ jsk.tab.c lex.yy.c -o jskc</b> <br> [tyomitch@home ~]$ <br> [tyomitch@home ~]$ <b>./jskc &lt; test.jsk &gt; code.o</b> <br> [tyomitch@home ~]$ <b>cc jskstd.o code.o</b> <br> [tyomitch@home ~]$ <b>./a.out</b> <br>    <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">1000</span></span>,     <br>  <span class="hljs-number"><span class="hljs-number">500</span></span>? (<span class="hljs-number"><span class="hljs-number">1</span></span>=, <span class="hljs-number"><span class="hljs-number">2</span></span>=, <span class="hljs-number"><span class="hljs-number">3</span></span>=) <b><span class="hljs-number"><span class="hljs-number">1</span></span></b> <br>  <span class="hljs-number"><span class="hljs-number">249</span></span>? (<span class="hljs-number"><span class="hljs-number">1</span></span>=, <span class="hljs-number"><span class="hljs-number">2</span></span>=, <span class="hljs-number"><span class="hljs-number">3</span></span>=) <b><span class="hljs-number"><span class="hljs-number">3</span></span></b> <br> !  ! <br> [tyomitch@home ~]$ <b>objdump -d code.o</b> <br> code.o: file <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> elf64-x86-<span class="hljs-number"><span class="hljs-number">64</span></span> Disassembly of section .text: <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> &lt;main&gt;: <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rbp <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">57</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rdi <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-number"><span class="hljs-number">56</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rsi <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rbx <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> c7 c5 <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0<span class="hljs-keyword"><span class="hljs-keyword">x</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>,%rbp b: <span class="hljs-number"><span class="hljs-number">33</span></span> c<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> %eax,%eax d: b9 e8 <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x3e8,%ecx <span class="hljs-number"><span class="hljs-number">12</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rax <span class="hljs-number"><span class="hljs-number">13</span></span>: <span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rcx <span class="hljs-number"><span class="hljs-number">14</span></span>: be <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x18,%esi <span class="hljs-number"><span class="hljs-number">19</span></span>: ff <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> callq *<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">1</span></span>c: <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rcx <span class="hljs-number"><span class="hljs-number">1</span></span>d: <span class="hljs-number"><span class="hljs-number">58</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rax <span class="hljs-number"><span class="hljs-number">1</span></span>e: <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rax <span class="hljs-number"><span class="hljs-number">1</span></span>f: <span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rcx <span class="hljs-number"><span class="hljs-number">20</span></span>: be <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0<span class="hljs-keyword"><span class="hljs-keyword">x</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>,%esi <span class="hljs-number"><span class="hljs-number">25</span></span>: ff <span class="hljs-number"><span class="hljs-number">55</span></span> 08 callq *<span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">28</span></span>: be <span class="hljs-number"><span class="hljs-number">38</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x38,%esi <span class="hljs-number"><span class="hljs-number">2</span></span>d: ff <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> callq *<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">30</span></span>: <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rcx <span class="hljs-number"><span class="hljs-number">31</span></span>: <span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rcx <span class="hljs-number"><span class="hljs-number">32</span></span>: be e8 <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x3e8,%esi <span class="hljs-number"><span class="hljs-number">37</span></span>: ff <span class="hljs-number"><span class="hljs-number">55</span></span> 08 callq *<span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">3</span></span>a: be <span class="hljs-number"><span class="hljs-number">3</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x3f,%esi <span class="hljs-number"><span class="hljs-number">3</span></span>f: ff <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> callq *<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">42</span></span>: <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rcx <span class="hljs-number"><span class="hljs-number">43</span></span>: <span class="hljs-number"><span class="hljs-number">58</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rax <span class="hljs-number"><span class="hljs-number">44</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>b c1 cmp %ecx,%eax <span class="hljs-number"><span class="hljs-number">46</span></span>: 0f <span class="hljs-number"><span class="hljs-number">8</span></span>f <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jg b8 &lt;main+<span class="hljs-number"><span class="hljs-number">0xb8</span></span>&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>c: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> lea (%rcx,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>),%edx <span class="hljs-number"><span class="hljs-number">4</span></span>f: d1 fa sar %edx <span class="hljs-number"><span class="hljs-number">51</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rax <span class="hljs-number"><span class="hljs-number">52</span></span>: <span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rcx <span class="hljs-number"><span class="hljs-number">53</span></span>: <span class="hljs-number"><span class="hljs-number">52</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rdx <span class="hljs-number"><span class="hljs-number">54</span></span>: be <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x64,%esi <span class="hljs-number"><span class="hljs-number">59</span></span>: ff <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> callq *<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">5</span></span>c: <span class="hljs-number"><span class="hljs-number">5</span></span>a <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rdx <span class="hljs-number"><span class="hljs-number">5</span></span>d: <span class="hljs-number"><span class="hljs-number">52</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rdx <span class="hljs-number"><span class="hljs-number">5</span></span>e: <span class="hljs-number"><span class="hljs-number">8</span></span>b f2 mov %edx,%esi <span class="hljs-number"><span class="hljs-number">60</span></span>: ff <span class="hljs-number"><span class="hljs-number">55</span></span> 08 callq *<span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">63</span></span>: be <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x6c,%esi <span class="hljs-number"><span class="hljs-number">68</span></span>: ff <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> callq *<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">6</span></span>b: ff <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> callq *<span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">6</span></span>e: <span class="hljs-number"><span class="hljs-number">93</span></span> xchg %eax,%ebx <span class="hljs-number"><span class="hljs-number">6</span></span>f: <span class="hljs-number"><span class="hljs-number">5</span></span>a <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rdx <span class="hljs-number"><span class="hljs-number">70</span></span>: <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rcx <span class="hljs-number"><span class="hljs-number">71</span></span>: <span class="hljs-number"><span class="hljs-number">58</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rax <span class="hljs-number"><span class="hljs-number">72</span></span>: <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov %eax,<span class="hljs-number"><span class="hljs-number">0x104</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">78</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> fb <span class="hljs-number"><span class="hljs-number">01</span></span> cmp $0x1,%ebx <span class="hljs-number"><span class="hljs-number">7</span></span>b: <span class="hljs-number"><span class="hljs-number">75</span></span> 0b jne <span class="hljs-number"><span class="hljs-number">88</span></span> &lt;main+<span class="hljs-number"><span class="hljs-number">0x88</span></span>&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>d: <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov <span class="hljs-number"><span class="hljs-number">0x104</span></span>(%rbp),%eax <span class="hljs-number"><span class="hljs-number">83</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">4</span></span>a ff lea <span class="hljs-number"><span class="hljs-number">0xffffffffffffffff</span></span>(%rdx),%ecx <span class="hljs-number"><span class="hljs-number">86</span></span>: eb bc jmp <span class="hljs-number"><span class="hljs-number">44</span></span> &lt;main+<span class="hljs-number"><span class="hljs-number">0x44</span></span>&gt; <span class="hljs-number"><span class="hljs-number">88</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> fb <span class="hljs-number"><span class="hljs-number">02</span></span> cmp $0x2,%ebx <span class="hljs-number"><span class="hljs-number">8</span></span>b: <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">05</span></span> jne <span class="hljs-number"><span class="hljs-number">92</span></span> &lt;main+<span class="hljs-number"><span class="hljs-number">0x92</span></span>&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>d: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> lea <span class="hljs-number"><span class="hljs-number">0x1</span></span>(%rdx),%eax <span class="hljs-number"><span class="hljs-number">90</span></span>: eb b2 jmp <span class="hljs-number"><span class="hljs-number">44</span></span> &lt;main+<span class="hljs-number"><span class="hljs-number">0x44</span></span>&gt; <span class="hljs-number"><span class="hljs-number">92</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov <span class="hljs-number"><span class="hljs-number">0x104</span></span>(%rbp),%eax <span class="hljs-number"><span class="hljs-number">98</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> fb <span class="hljs-number"><span class="hljs-number">03</span></span> cmp $0x3,%ebx <span class="hljs-number"><span class="hljs-number">9</span></span>b: <span class="hljs-number"><span class="hljs-number">75</span></span> 0d jne aa &lt;main+<span class="hljs-number"><span class="hljs-number">0xaa</span></span>&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>d: be <span class="hljs-number"><span class="hljs-number">9</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x9f,%esi a2: ff <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> callq *<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rbp) a5: <span class="hljs-number"><span class="hljs-number">5</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rbx a6: <span class="hljs-number"><span class="hljs-number">5</span></span>e <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rsi a7: <span class="hljs-number"><span class="hljs-number">5</span></span>f <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rdi a8: <span class="hljs-number"><span class="hljs-number">5</span></span>d <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rbp a9: c3 retq aa: <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rax ab: <span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> %rcx ac: be bb <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0xbb,%esi b1: ff <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> callq *<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rbp) b4: <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rcx b5: <span class="hljs-number"><span class="hljs-number">58</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rax b6: eb <span class="hljs-number"><span class="hljs-number">8</span></span>c jmp <span class="hljs-number"><span class="hljs-number">44</span></span> &lt;main+<span class="hljs-number"><span class="hljs-number">0x44</span></span>&gt; b8: be dd <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0xdd,%esi bd: ff <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> callq *<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rbp) c<span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rbx c1: <span class="hljs-number"><span class="hljs-number">5</span></span>e <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rsi c2: <span class="hljs-number"><span class="hljs-number">5</span></span>f <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rdi c3: <span class="hljs-number"><span class="hljs-number">5</span></span>d <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> %rbp c4: c3 retq <br>   , , ,        llvm.     ‚Äî  .</code></code> </pre> <code><code>[tyomitch@home ~]$ <b>as jskstd.s -o jskstd.o</b> <br> [tyomitch@home ~]$ <br> [tyomitch@home ~]$ <b>bison jsk.y</b> <br> [tyomitch@home ~]$ <b>c++ jsk.tab.c lex.yy.c -o jskc</b> <br> [tyomitch@home ~]$ <br> [tyomitch@home ~]$ <b>./jskc &lt; test.jsk &gt; code.o</b> <br> [tyomitch@home ~]$ <b>cc jskstd.o code.o</b> <br> [tyomitch@home ~]$ <b>./a.out</b> <br>    0  1000,     <br>  500? (1=, 2=, 3=) <b>1</b> <br>  249? (1=, 2=, 3=) <b>3</b> <br> !  ! <br> [tyomitch@home ~]$ <b>objdump -d code.o</b> <br> code.o: file format elf64-x86-64 Disassembly of section .text: 0000000000000000 &lt;main&gt;: 0: 55 push %rbp 1: 57 push %rdi 2: 56 push %rsi 3: 53 push %rbx 4: 48 c7 c5 00 00 00 00 mov $0x0,%rbp b: 33 c0 xor %eax,%eax d: b9 e8 03 00 00 mov $0x3e8,%ecx 12: 50 push %rax 13: 51 push %rcx 14: be 18 00 00 00 mov $0x18,%esi 19: ff 55 10 callq *0x10(%rbp) 1c: 59 pop %rcx 1d: 58 pop %rax 1e: 50 push %rax 1f: 51 push %rcx 20: be 00 00 00 00 mov $0x0,%esi 25: ff 55 08 callq *0x8(%rbp) 28: be 38 00 00 00 mov $0x38,%esi 2d: ff 55 10 callq *0x10(%rbp) 30: 59 pop %rcx 31: 51 push %rcx 32: be e8 03 00 00 mov $0x3e8,%esi 37: ff 55 08 callq *0x8(%rbp) 3a: be 3f 00 00 00 mov $0x3f,%esi 3f: ff 55 10 callq *0x10(%rbp) 42: 59 pop %rcx 43: 58 pop %rax 44: 3b c1 cmp %ecx,%eax 46: 0f 8f 6c 00 00 00 jg b8 &lt;main+0xb8&gt; 4c: 8d 14 01 lea (%rcx,%rax,1),%edx 4f: d1 fa sar %edx 51: 50 push %rax 52: 51 push %rcx 53: 52 push %rdx 54: be 64 00 00 00 mov $0x64,%esi 59: ff 55 10 callq *0x10(%rbp) 5c: 5a pop %rdx 5d: 52 push %rdx 5e: 8b f2 mov %edx,%esi 60: ff 55 08 callq *0x8(%rbp) 63: be 6c 00 00 00 mov $0x6c,%esi 68: ff 55 10 callq *0x10(%rbp) 6b: ff 55 00 callq *0x0(%rbp) 6e: 93 xchg %eax,%ebx 6f: 5a pop %rdx 70: 59 pop %rcx 71: 58 pop %rax 72: 89 85 04 01 00 00 mov %eax,0x104(%rbp) 78: 83 fb 01 cmp $0x1,%ebx 7b: 75 0b jne 88 &lt;main+0x88&gt; 7d: 8b 85 04 01 00 00 mov 0x104(%rbp),%eax 83: 8d 4a ff lea 0xffffffffffffffff(%rdx),%ecx 86: eb bc jmp 44 &lt;main+0x44&gt; 88: 83 fb 02 cmp $0x2,%ebx 8b: 75 05 jne 92 &lt;main+0x92&gt; 8d: 8d 42 01 lea 0x1(%rdx),%eax 90: eb b2 jmp 44 &lt;main+0x44&gt; 92: 8b 85 04 01 00 00 mov 0x104(%rbp),%eax 98: 83 fb 03 cmp $0x3,%ebx 9b: 75 0d jne aa &lt;main+0xaa&gt; 9d: be 9f 00 00 00 mov $0x9f,%esi a2: ff 55 10 callq *0x10(%rbp) a5: 5b pop %rbx a6: 5e pop %rsi a7: 5f pop %rdi a8: 5d pop %rbp a9: c3 retq aa: 50 push %rax ab: 51 push %rcx ac: be bb 00 00 00 mov $0xbb,%esi b1: ff 55 10 callq *0x10(%rbp) b4: 59 pop %rcx b5: 58 pop %rax b6: eb 8c jmp 44 &lt;main+0x44&gt; b8: be dd 00 00 00 mov $0xdd,%esi bd: ff 55 10 callq *0x10(%rbp) c0: 5b pop %rbx c1: 5e pop %rsi c2: 5f pop %rdi c3: 5d pop %rbp c4: c3 retq <br>   , , ,        llvm.     ‚Äî  .</code></code> </div><p>Source: <a href="https://habr.com/ru/post/104104/">https://habr.com/ru/post/104104/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../104099/index.html">Important changes in Oracle Database Patch Sets from 11.2.0.2</a></li>
<li><a href="../104100/index.html">Switch from Windows Mobile to Android. Application list</a></li>
<li><a href="../104101/index.html">Happy Programmer's Day</a></li>
<li><a href="../104102/index.html">Digital lock on the room</a></li>
<li><a href="../104103/index.html">Parallel tasks. The case of "perfect parallelism." Part 2</a></li>
<li><a href="../104106/index.html">Limb framework version 2010.1 RC2</a></li>
<li><a href="../104108/index.html">Boris Bobrovnikov: IT business today by itself</a></li>
<li><a href="../104109/index.html">The art of programming under Unix (and not only). Part six, the ‚Äúcode-saving rule‚Äù</a></li>
<li><a href="../104114/index.html">Photo review of HP Proliant DL980 G7</a></li>
<li><a href="../104115/index.html">Microsoft congratulates on the Day of the programmer!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>