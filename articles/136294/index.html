<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Prototype Lane Departure Warning or how to remind the driver that he did not have a very long time to live</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I read a little about the auto show in Detroit, about the fact that Lane Departure Warning is becoming more and more popular and decided that I should...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Prototype Lane Departure Warning or how to remind the driver that he did not have a very long time to live</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/746/2cb/c43/7462cbc4373c695123d28e3d4690748e.jpg"><br>  I read a little about the auto show in Detroit, about the fact that Lane Departure Warning is becoming more and more popular and decided that I should share my experience in making a prototype of this system from simple components in the form of a webcam, Python, OpenCV and a couple of days of hard work meditation :) <br><br>  The history of the prototype can be read and viewed under the cut ... (there are a lot of pictures, a lot ...) <br><a name="habracut"></a><br><br><h4>  Foreword </h4><br>  It all started with the fact that I had to choose the final projects for two courses: "Autoelectronics" and "Image Processing".  As a lazy person, I could not but cross both projects and thereby save time, and if we consider that for a couple of lectures before that, we were just told about Lane Departure Warning (to be honest, I still do not know adequate Russian, and most importantly short name of this system, so I will use the abbreviation LDW), then I wanted to try to do such a thing on my own. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Some general information </h4><br>  So, what kind of beast is this named ‚ÄúLane Departure Warning‚Äù.  Let's start with the fact that while driving the car is most often in its lane and should not leave it, but in reality the driver can be distracted from driving and the car can start moving to the next lane, which can lead to particularly sad consequences in case of move to the oncoming lane.  According to statistics from the National Highway Traffic Safety Administration (NHTSA), 40-60% of all accidents on highways in the USA are directly or indirectly related to the fact that a car leaves its lane.  To prevent this, people came up with tracking the position of the car in the lane and if it starts to leave it, give a signal to the driver or take more active actions: turn the steering wheel or apply brakes on the wheels of the opposite side to prevent the car from leaving its lane.  In fact, such systems are not something very new, the Japanese 10 years ago began to experiment with them on some models.  Moreover, various companies used to implement quite different approaches: ordinary cameras looking forward or backward, as well as infrared cameras looking down. <br><br><h4>  Implementation </h4><br>  So, the task is to determine the position of the car on the highway and give a signal to the driver in case of leaving the lane, and with the least amount of modifications to the car.  In my case, the basis of the system was a webcam bolted with an electrical tape to the mount from the GPS receiver and located on the windshield near the rearview mirror plus a laptop located on the lap. <br><img src="https://habrastorage.org/storage2/f87/8c1/c08/f878c1c08fa075d06ce3229ad1d46762.jpg"><br>  For processing the video stream, the OpenCV library was traditionally chosen, and for the implementation of the Python algorithm. <br><br><h6>  A little bit about Python </h6><br>  Here I will make a small lyric-advertising retreat about Python.  It so happened that I wrote a lot on the pluses, and a lot on what else, but I never came across a Python and I sincerely believed that it was quite slow.  Immediately it was required in real time to process the video and do some amount of any calculations.  But, looking ahead a bit, I can say that the impressions were only positive: it was very easy to write on it (actually I started writing this project on the second day of studying Python), he handled the video processing (not without the help of using NumPy , which allows you to quickly process data arrays and OpenCV), and if I look forward a little more, now I am rewriting part of my research project on it and when using OpenGL I get 300+ fps.  On this Python ad can be considered complete, use it for prototypes - you will not regret. <br><br><h6>  Attempt the first - color model </h6><br>  So, I began by trying to separate the strip from the background.  At first I tried the simplest approach: to have some kind of color model of a dividing strip, count the Euclidean distance from each pixel to the model and apply some predetermined threshold.  In general, this idea is not deprived of meaning and gives quite a good result: <br><img src="https://habrastorage.org/storage2/ee3/2a5/d31/ee32a5d3161a87534c644985178bd52e.jpg"><br>  But only until there is a shadow on the road, and it appears very, very often.  Then it turns out like this: <br><img src="https://habrastorage.org/storage2/eb3/177/15c/eb317715c6b787e5ffd6acbc8ec74cc8.jpg"><br>  which is generally good, but a much more serious bummer was waiting for me: the camera periodically adjusts the exposure (for some reason, I never managed to manage it manually) and very seriously changes the brightness of the frame.  It looks like this (in the picture there are two consecutive frames with a large difference in brightness): <br><img src="https://habrastorage.org/storage2/033/c52/6c8/033c526c8ba24e3d1604255bc5bc4d58.jpg"><br>  In order to get rid of this problem, the idea to work with the HSV color space came to me, saying that there the color does not really depend on the brightness, then the shadow and autoexposure should not affect.  On the one hand, the idea is quite reasonable, but with extreme brightness values, quite a lot of noise appears in the tone channel.  As a result, it looks like this: <br><img src="https://habrastorage.org/storage2/98c/12f/a10/98c12fa107e267126f156619b80e4dc8.jpg"><br>  In general, I was tormented with trying to separate the bands from the background for any situations and I realized that this idea was not very good.  And I tried to use a lot of different filters and video processing methods, and my monitor was littered with all kinds of windows with results like the following: <br><img src="https://habrastorage.org/storage2/91b/afb/666/91bafb666a260b7b01bbc6cf853f078f.jpg"><br>  and so two more monitors nearby :) <br><br><h6>  Attempt the second - virtual sensors </h6><br>  After the unsuccessful first attempt, I realized that this would not work, but I didn‚Äôt want to look at the finished algorithm somewhere, I wanted everything of my own.  The truth is, once I still counted a little and spied one picture on the first page of Google‚Äôs issue: <br><img src="https://habrastorage.org/getpro/habr/post_images/c04/f7e/ddf/c04f7eddffe72076bf577e2c526b9ad0.jpg" alt="image"><br>  From this picture was born the idea of ‚Äã‚Äãusing several ‚Äúvirtual sensors‚Äù, which are trying to track not the entire strip of pillars, but its section in some selected horizontal area. <br><img src="https://habrastorage.org/storage2/630/454/b9a/630454b9ac328af06a5247594aa5a485.jpg"><br>  Here on the image horizontal red stripes show the working areas of these sensors.  They all work independently, which allows them to filter relative to each other.  Those.  if everyone shows that the band is on the left and one is on the right, his results can be discarded, even if this sensor is 100% sure that the band is there. <br><br>  Each sensor is smart enough, it contains a model of a dividing strip and tries to find it in its working area.  Actually, the model uses two properties: the color already familiar to us, which works well, but not always the width of the strip (everything is not quite simple, due to the fact that the camera can be located in the car in different ways and because of perspective distortions , we cannot set the bandwidth, so at the very beginning of the program, the sensors are trained in it).  Thus, the following algorithm is used for each frame: <br><br>  0) First, we crop the image only to the area where the road is visible.  This allows you to improve performance and not embarrass the algorithm with reflections on the hood and sky. <br>  1) Then we apply Canny to the whole image.  This allows us to forget about auto exposure and sometimes shadows. <br>  2) Then for each sensor: <br>  2.1) we are looking for all closed regions (areas bounded on both sides by borders) <br>  2.2) look for those regions whose width is equal to the width of the strip <br>  2.3) if there are several such regions (due to shadows and similar problems), then we consider the average color of the region and its distance from our color model of the dividing strip and choose the most similar one. <br><br>  Here are the results for each sensor (black - dividing strip, white - road): <br><img src="https://habrastorage.org/storage2/ab0/e6f/709/ab0e6f70931e6cc2005e7e0c0f54d16e.jpg"><br><br><h6>  Dividing strip model </h6><br>  So, we have data from each sensor and the next step is to determine the position of the dividing strip, and in order to do this you need to have some kind of model.  I decided not to philosophize much and present a dividing strip near the car just as a straight line.  It could of course be said that it was not at all direct, but I experimented a little with the second-order curve, I realized that there wasn‚Äôt much difference and quit this disastrous matter.  As a result, my dividing lines sometimes intersect on the horizon, but that's not a big deal.  In order to take into account all the data from the sensors, I use the method of minimum squares, to which the input receives the midpoints of all the segments, which the virtual sensors consider as a dividing strip.  As a result, it looks like this: <br><img src="https://habrastorage.org/storage2/685/4b5/aa8/6854b5aa86454f03aeda5f00a1219cfb.jpg"><br><br><h6>  Vehicle position determination </h6><br>  After we learned where the dividing lanes are located, it is time to determine where the car is located on the lane.  Then a rather simple way came to my mind: take some horizontal line closer to the hood, mark several zones on it, find the intersection points of this straight and dividing lines and use these points to determine the position of the car within the band.  Depending on which zone the point of intersection is located in, we can tell how close the machine is to the dividing strip, and even with such a simple method it turns out quite accurately.  I use 3 zones: green - everything is good, the car in the center;  orange - we are already close to the edge;  red - we already ran into the strip.  The whole thing looks like this: <br><img src="https://habrastorage.org/storage2/084/276/628/084276628b1d61ac0b53778f58fb0b03.jpg"><br><br>  Moreover, the choice of the position of these zones is already in the process of movement, since everything strongly depends on the size of the machine and the position of the camera.  And in my case it looked like this: the car moves at the edge, drives the wheel to the strip and by the sound (moving through light reflectors) the border of the red zone is set, i.e.  This is the moment when the wheel of the car has already begun to move to the next lane.  A little later on the video you can hear it. <br><br>  Actually this is almost the end, it remains only to inform the driver about what is happening there.  To do this, I show the arrows, which are directed towards moving the machine: <br><img src="https://habrastorage.org/storage2/e04/b2c/fca/e04b2cfcae6ae4079128935a33db6a62.jpg"><br><br><h4>  Testing </h4><br>  So, the most interesting is tests.  To begin with, let's take a look at how the developed prototype handles the pre-recorded video: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/HjFMPImhIkY%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhjueTsAl7ST_HAMVUmRaalUjVr0uw" frameborder="0" allowfullscreen=""></iframe><br><br>  Everything is not so bad, except for a couple of frames where he could not correctly determine the position of the dividing line.  Moreover, it was possible to handle such a situation, in this case, the implementation of the least squares method from NumPy showed an exception and one could simply use the old position of the strip, but at that time it was too late and it was too lazy to mess around :) <br><br>  And now the main thing is tests on a real track: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/54z72swkruE%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhWH2XxNmxi1sqs8avOsJTWdzBiig" frameborder="0" allowfullscreen=""></iframe><br><br>  And here is the promised video on which you can hear the sound of hitting the reflectors, which are located on the dividing strip (by the way, a useful thing, and not only for tests): <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Nk2kTd4KvkQ%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhdQ4zksiIZ-Rqo9GS4HJoJrRnVyg" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  the end </h4><br>  That's all, I can only say that a simple prototype of such a system is not a tricky business, but how to make it work steadily in all weather and road conditions is another question, because quite often the lane is almost invisible and even my brain I hardly understand where I am going. <br><br>  Another interesting point: now my prototype feels very bad when moving from one lane to another.  At first, I thought about making the correct operation of changing lanes and all that, but everything is far from being so obvious: the task of this system is not to let go to another lane, and in order to understand what the driver really wants, you need to have more information, such as data on the inclusion of turn signals, data navigation systems, radar, etc. etc., but that's completely another story. <br><br>  And once again I will say that Python is a great thing for prototyping, I say this as a person who has been writing in C ++ for quite a few years (and even 2 days to develop such a thing from scratch without knowing the language confirm this, I wouldn‚Äôt managed). <br><br>  PS: I apologize for not continuing the previous theme with the <a href="http://habrahabr.ru/blogs/programming/126290/">3-D kettle</a> , as it turned out, the 3D monitor is good for 3D, but doesn‚Äôt work with 2D, so I had to change it, but I hope this theme is not worse :) <br><br>  PS2: I forgot about the source code, they live on <a href="https://github.com/Akson/LaneDepartureWarning">github</a> </div><p>Source: <a href="https://habr.com/ru/post/136294/">https://habr.com/ru/post/136294/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136288/index.html">Tarantool: how to handle 1.5 billion requests per day?</a></li>
<li><a href="../136289/index.html">Education in high school and beyond: a view from the department</a></li>
<li><a href="../136290/index.html">What is more important for a programmer?</a></li>
<li><a href="../136291/index.html">By lamers for lamers</a></li>
<li><a href="../136292/index.html">Compact gaming steering wheel Steelseries SRW-S1</a></li>
<li><a href="../136295/index.html">Nginx + uWSGI + virtualenv + Django on Debian Squeeze</a></li>
<li><a href="../136296/index.html">CES 2012 // Acer Aspire S5</a></li>
<li><a href="../136298/index.html">Official release of ADO.NET driver for CUBRID</a></li>
<li><a href="../136299/index.html">Where do you buy games online?</a></li>
<li><a href="../136300/index.html">Death in games. Monday video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>