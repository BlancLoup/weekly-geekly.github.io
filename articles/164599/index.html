<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a clone game Fruit Ninja (part 1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this wonderful tutorial from Allan Tan, we will create our own game similar to Fruit Ninja from Halfbrick Studios using Cocos2D and Box2D. 
 In mos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a clone game Fruit Ninja (part 1)</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/storage2/8a8/d75/5e9/8a8d755e998ec1c8779c7bb1dc55e896.png" alt="image">  In this wonderful tutorial from <a href="http://www.raywenderlich.com/about">Allan Tan,</a> we will create our own game similar to <a href="http://itunes.apple.com/us/app/fruit-ninja/id362949845%3Fmt%3D8">Fruit Ninja</a> from <a href="http://www.halfbrick.com/">Halfbrick Studios</a> using Cocos2D and Box2D. <br>  In most of these games, when a player cuts a sprite, it is divided into two previously prepared sprites;  regardless of exactly where we cut the object. <br>  However, in this tutorial we will do the thing more abruptly.  Our fruit can be cut into several pieces, and they will be cut depending on where the player‚Äôs finger passed! <br>  Obviously, this guide is not for beginners and requires advanced knowledge of Cocos2D and Box2D.  If you‚Äôve just started programming under iOS, then you'd better, at a minimum, go over your eyes on the <a href="http://www.raywenderlich.com/352/how-to-make-a-simple-iphone-game-with-cocos2d-tutorial">introduction to Cocos2D</a> and <a href="http://www.raywenderlich.com/457/intro-to-box2d-with-cocos2d-tutorial-bouncing-balls">Box2D</a> . <br><br>  And here is the video game we will create using some cool tricks! <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/BG4lqnFlXKk%3Ffeature%3Doembed&amp;xid=17259,15700023,15700043,15700186,15700191,15700253&amp;usg=ALkJrhhB0haJdA9--p4SdEoPjtMywAhg7w" frameborder="0" allowfullscreen=""></iframe>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All interested in asking under the cat!  Warning: a lot of translated text! <br><a name="habracut"></a><br>  Note: the cut on the fruit appears where the player holds a finger.  And as the fruit is cut into several pieces, we can crumble them into pieces! <br>  Today we will add a cool cutting effect, a system of particles, the logic of the game and, of course, the sound of dismembering fruit. <br><br>  This tutorial is divided into three parts: <br><br><ul><li>  In the first part, we will create a base for the game and learn how to use texture polygons. </li><li>  In the <a href="http://www.raywenderlich.com/14393/how-to-make-a-game-like-fruit-ninja-with-box2d-and-cocos2d-part-2">second part,</a> we learn how to chop and split textures. </li><li>  In the <a href="http://www.raywenderlich.com/14439/how-to-make-a-game-like-fruit-ninja-with-box2d-and-cocos2d-part-3">third part,</a> we will add the gameplay and fun effects to the game. </li></ul><br>  Enough words - let's get down to business! <br><br><h4>  Let's begin: we start the project </h4><br>  We will use Cocos2D 2.X, so <a href="http://www.cocos2d-iphone.org/download">download it</a> if you have not done so already.  You can use Cocos2D 1.X, instead of 2.X.  With version 1.X, you can skip the step of adapting PRKit and CCBlade for Cocos2D 2.X, but make sure that you fully understand the differences between the ported classes. <br>  After downloading, unzip and install the templates using the following commands in the terminal: <br><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Downloads/cocos2d-iphone-2.0-beta ./install-templates.sh -f -u</code> </pre> <br>  Launch Xcode and create a new iOS / cocos2d v2.x \ cocos2d iOS project with the Box2D template, name it CutCutCut. <br>  Now our project should look like this: <br><br><img src="https://habrastorage.org/storage2/7a7/e66/4ce/7a7e664ce4203fafb409f8e5a5e332e7.png"><br><br>  First we need to clear the template to create a good project base. <br>  Open <b>HelloWorldLayer.h</b> and delete the following line: <br><br><pre> <code class="objectivec hljs">CCTexture2D *spriteTexture_;<span class="hljs-comment"><span class="hljs-comment">// weak ref</span></span></code> </pre><br>  Go to <b>HelloWorldLayer.mm</b> and make the following changes: <br><br><div class="spoiler">  <b class="spoiler_title">Click me</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//       #import "PhysicsSprite.h" //   init   - (id)init { if( (self=[super init])) { // enable events self.isTouchEnabled = YES; self.isAccelerometerEnabled = YES; CGSize s = [CCDirector sharedDirector].winSize; //   [self initPhysics]; [self scheduleUpdate]; } return self; } //     - (void)createMenu { // } - (void)addNewSpriteAtPosition:(CGPoint)p methods { // } //     ccTouchesEnded [self addNewSpriteAtPosition: location];</span></span></code> </pre></div></div><br>  We have removed all references to PhysicsSprite from the HelloWorldLayer, but have not yet deleted the files from the project.  Later we will need to copy one method from PhysicsSprite.mm, so let's leave it as it is. <br>  Click Command + R to start the project, and you should see a black screen with a green frame around: <br><br><img src="https://habrastorage.org/storage2/866/3c3/00f/8663c300f2046b17ecbe1601cc68f3f2.png"><br><br>  The remaining code starts debug mode: draws a green frame around all Box2D objects on the screen.  See that green line around the screen?  These are walls created by the initPhysics template method. <br>  Carefully inspect the remaining code, make sure you fully understand it.  We initialize the world of Box2D, install walls (green lines), start debug mode, etc.  This ‚Äúalmost empty‚Äù project is convenient for working with Box2D. <br><br><h4>  Resource pack </h4><br>  Next, download <a href="">the resource pack</a> for this project and unzip the files. <br>  Do not add anything to the project yet;  Some files may not be useful to you at all.  However, keep your daddy close at hand - as you go through the tutorial, we will add files to the project. <br>  The starter kit includes the following: <br><br><ul><li>  Background Caritne;  fruits painted by <a href="http://www.vickiwenderlich.com/">wiki</a> ;  some other pictures in the Images folder </li><li>  Background music created with <a href="http://gomix.it/">gomix.it</a> in the Sounds folder </li><li>  Sound effects created with <a href="http://www.bfxr.net/">bfxr</a> or downloaded from <a href="http://www.freesound.org/home/">freesound</a> in the Sounds folder </li><li>  All particle systems created with <a href="http://particledesigner.71squared.com/">Particle Designer</a> are in the Particles folder. </li><li>  The PLIST file created with the help of <a href="http://sites.fastspring.com/codeandweb/product/all%3Fsource%3Draywenderlich">PhysicsEditor</a> , containing vertices for the fruit and bombs class, in the Misc folder </li><li>  Classes of fruits and bombs in the folder Classes </li><li>  Versions of <a href="https://github.com/asinesio/cocos2d-PRKit">PRKit</a> and <a href="https://github.com/hiepnd/CCBlade">CCBlade</a> in the Classes folder </li></ul><br><h4>  We draw texture polygons with PRKit </h4><br>  Our goal is to cut the sprites into several pieces.  A typical CCSprite contains a texture and a collision frame (bounding box) that does not depend on the actual image.  This does not suit us, since it is important for us to know the real size of the image in order to create sprites that can be sliced, shredded and divided. <br>  We need to create texture polygons that: <br><br><ul><li>  Create a relationship between a polygon / shape and a picture (Texture Mapping) </li><li>  Shows only those parts of the image that fall within the polygon frame (Texture Filling) </li></ul><br>  Neither Cocos2D nor Box2D has any built-in classes that perform the actions we need.  Usually, in such cases, it is better to write your own drawing code on OpenGL. <br>  Sounds hard? <br>  Fortunately, all the complex calculations and the necessary drawing code are already written by the good guys from <a href="http://precognitiveresearch.com/">Precognitive Research</a> .  They created an additional Cocos2D library that performs the actions we need, and called it PRKit. <br>  To start working with texture polygons, <a href="https://github.com/asinesio/cocos2d-PRKit">download PRKit</a> , unpack it and transfer the PRKit folder to your project.  Make sure that the ‚ÄúCopy items into destination groups folders‚Äù and ‚ÄúCreate groups for any added folders‚Äù checkboxes are ticked. <br>  Note that PRKit is developed by Precognitive Research, so it is updated frequently.  To avoid differences in versions, our set of resources contains the necessary version of PRKit for this tutorial. <br>  Our project should now include the following files: <br><br><img src="https://habrastorage.org/storage2/55d/709/8ce/55d7098ce463ef464225e397d9729440.png"><br><br>  Start the game, you will find the following errors: <br><br><img src="https://habrastorage.org/storage2/236/e66/442/236e66442b6a8c608faea753d266da84.png"><br><br>  Errors occur because PRKit was developed for Cocos2D 1.X, which uses OpenGL ES 1.1, while we use Cocos2D 2.X with OpenGL ES 2.0.  And they are significantly different from each other. <br>  To fix this, open PRFilledPolygon.m and make the following changes: <br><br><div class="spoiler">  <b class="spoiler_title">Click me</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//    initWithPoints: andTexture: usingTriangulator: self.shaderProgram = [[CCShaderCache sharedShaderCache] programForKey:kCCShader_PositionTexture]; //   calculateTextureCoordinates   - (void)calculateTextureCoordinates { for (int j = 0; j &lt; areaTrianglePointCount; j++) { textureCoordinates[j] = ccpMult(areaTrianglePoints[j],1.0f/texture.pixelsWide*CC_CONTENT_SCALE_FACTOR()); textureCoordinates[j].y = 1 - textureCoordinates[j].y; } } //   draw   - (void)draw { CC_NODE_DRAW_SETUP(); ccGLBindTexture2D( self.texture.name ); glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT); glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT); ccGLBlendFunc( blendFunc.src, blendFunc.dst); ccGLEnableVertexAttribs( kCCVertexAttribFlag_Position | kCCVertexAttribFlag_TexCoords ); glVertexAttribPointer(kCCVertexAttrib_Position, 2, GL_FLOAT, GL_FALSE, 0, areaTrianglePoints); glVertexAttribPointer(kCCVertexAttrib_TexCoords, 2, GL_FLOAT, GL_FALSE, 0, textureCoordinates); glDrawArrays(GL_TRIANGLES, 0, areaTrianglePointCount); }</span></span></code> </pre></div></div><br>  Let's go step by step through the changes. <br>  First, every CCNode in Cocos2D has an attached OpenGL ES 2.0 shader program.  To draw a PRFilledPolygon, we need to tie in the built-in ‚ÄúPosition / Texture‚Äù shader, which we implement in the init method. <br>  Next, we need to set the correct texture coordinates for each point in the polygon.  To do this, we need to make a couple of changes to the calculateTextureCoordinates method: <br><br><ul><li>  <b>Resize:</b> Since this class performs its own calculations of texture coordinates, it does not support Retina displays.  To fix this, we simply multiply texture.pixelsWide by CC_CONTENT_SCALE_FACTOR - the coefficient provided by the Cocos2D developers to convert the values ‚Äã‚Äãfor conventional and Retina displays. </li><li>  <b>Expand Y:</b> For some reason, PRFIlledPolygon renders textures upside down, so we just expand the value of y. </li></ul><br>  In the end, we updated the code for OpenGL ES 2.0.  We also changed the drawing in CCSprite for Cocos2D 2.X: <br><br><ul><li>  We start by resizing with CC_NODE_DRAW_SETUP () to prepare the sprite for rendering. </li><li>  The calls glDisableClientState () and glEnableClientState () are obsolete and ignored. </li><li>  Both glVertexPointer () and glTexCoordPointer () are replaced by glVertexAttribPointer (), which takes a vertex position or texture coordinate with the first argument. </li><li>  The launch of the function glTexEnvf (), which is responsible for repeating the image, if the polygon turned out to be more texture, is replaced by calls to glTexParameteri (). </li></ul><br>  If something is not clear to you, then you can watch tutorials on <a href="http://www.raywenderlich.com/3664/opengl-es-2-0-for-iphone-tutorial">OpenGL ES 2.0 for iPhone</a> and <a href="http://www.raywenderlich.com/10862/how-to-create-cool-effects-with-custom-shaders-in-opengl-es-2-0-and-cocos2d-2-x">custom shaders in Cocos2D 2.X.</a>  But you don‚Äôt need to worry too much about it, because now we‚Äôre just porting classes to Cocos2D 2.X:] <br>  Run the project and PRKit errors should disappear! <br>  It's time to start using PRKit.  We will create a subclass of PolygonSprite class PRFilledPolygon, which will draw our fruit. <br>  PolygonSprite is built on the basis of PRFilledPolygon by adding the Box2D body to the sprite, adding some other variables and methods to the implementation. <br>  Let's do that.  Click Command + N and create a new file using the template iOS \ cocos2d v2.x \ CCNode.  Subclass it to PRFilledPolygon and name it <b>PolygonSprite.m</b> . <br>  Switch to <b>PolygonSprite.h</b> and make the following changes: <br><br><div class="spoiler">  <b class="spoiler_title">Click me</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//     #import "Box2D.h" #import "PRFilledPolygon.h" #define PTM_RATIO 32 //   @interface b2Body *_body; BOOL _original; b2Vec2 _centroid; //   @interface @property(nonatomic,assign)b2Body *body; @property(nonatomic,readwrite)BOOL original; @property(nonatomic,readwrite)b2Vec2 centroid; //   @end - (id)initWithTexture:(CCTexture2D*)texture body:(b2Body*)body original:(BOOL)original; - (id)initWithFile:(NSString*)filename body:(b2Body*)body original:(BOOL)original; + (id)spriteWithFile:(NSString*)filename body:(b2Body*)body original:(BOOL)original; + (id)spriteWithTexture:(CCTexture2D*)texture body:(b2Body*)body original:(BOOL)original; - (id)initWithWorld:(b2World*)world; + (id)spriteWithWorld:(b2World*)world; - (b2Body*)createBodyForWorld:(b2World*)world position:(b2Vec2)position rotation:(float)rotation vertices:(b2Vec2*)vertices vertexCount:(int32)count density:(float)density friction:(float)friction restitution:(float)restitution; - (void)activateCollisions; - (void)deactivateCollisions;</span></span></code> </pre></div></div><br>  This code declares the base variables and methods that we need to create a PolygonSprite: <br><br><ul><li>  body: This is the Box2D body attached to our sprite.  It is necessary for the simulation of physics. </li><li>  original: Both the whole and cut pieces will be objects of the PolygonSprite class, so it is important for us to somehow distinguish them.  If the value is YES, then the piece is whole, otherwise it is just a piece of the whole. </li><li>  centroid: The center of the polygon is not always the center of the picture, so it is very convenient to use this variable. </li><li>  properties: We give access to our variables. </li><li>  init / spriteWith *: Our main initialization methods. </li><li>  other methods: These methods create Box2D bodies and operate with them and their variables. </li><li>  PTM_RATIO: Matching pixels and meters.  Box2D uses meters instead of pixels. </li></ul><br>  Switch to PolygonSprite.m and rename it to <b>PolygonSprite.mm</b> .  All classes that contain both Objective-C (Cocos2D) and C ++ (Box2D) must have the extension ‚Äú.mm‚Äù. <br>  Next, make the following changes to <b>PolygonSprite.mm</b> : <br><br><div class="spoiler">  <b class="spoiler_title">Click me</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//   @implementation @synthesize body = _body; @synthesize original = _original; @synthesize centroid = _centroid; + (id)spriteWithFile:(NSString *)filename body:(b2Body *)body original:(BOOL)original { return [[[self alloc]initWithFile:filename body:body original:original] autorelease]; } + (id)spriteWithTexture:(CCTexture2D *)texture body:(b2Body *)body original:(BOOL)original { return [[[self alloc]initWithTexture:texture body:body original:original] autorelease]; } + (id)spriteWithWorld:(b2World *)world { return [[[self alloc]initWithWorld:world] autorelease]; } - (id)initWithFile:(NSString*)filename body:(b2Body*)body original:(BOOL)original { NSAssert(filename != nil, @"Invalid filename for sprite"); CCTexture2D *texture = [[CCTextureCache sharedTextureCache] addImage: filename]; return [self initWithTexture:texture body:body original:original]; } - (id)initWithTexture:(CCTexture2D*)texture body:(b2Body*)body original:(BOOL)original { //      Box2D b2Fixture *originalFixture = body-&gt;GetFixtureList(); b2PolygonShape *shape = (b2PolygonShape*)originalFixture-&gt;GetShape(); int vertexCount = shape-&gt;GetVertexCount(); NSMutableArray *points = [NSMutableArray arrayWithCapacity:vertexCount]; for(int i = 0; i &lt; vertexCount; i++) { CGPoint p = ccp(shape-&gt;GetVertex(i).x * PTM_RATIO, shape-&gt;GetVertex(i).y * PTM_RATIO); [points addObject:[NSValue valueWithCGPoint:p]]; } if ((self = [super initWithPoints:points andTexture:texture])) { _body = body; _body-&gt;SetUserData(self); _original = original; //    _centroid = self.body-&gt;GetLocalCenter(); //   (anchor point)    self.anchorPoint = ccp(_centroid.x * PTM_RATIO / texture.contentSize.width, _centroid.y * PTM_RATIO / texture.contentSize.height); //    ,    PolygonSprite } return self; } - (id)initWithWorld:(b2World *)world { //     return nil; }</span></span></code> </pre></div></div><br>  Just like Cocos2D, all spriteWith * methods are just autorelease of the initWith * methods.  So far, there is no use of the initWithWorld method, but later we will actively use it. <br>  The initWithFile and initWithTexture methods contain several changes.  The process of creating a fruit follows the following algorithm: <br><br><img src="https://habrastorage.org/storage2/ad3/f82/acf/ad3f82acf81f7334e213d59dfea4c6cd.png"><br><br><ul><li>  <b>initWithWorld:</b> This method does not return anything yet.  We will work with him later. </li><li>  <b>initWithFile:</b> This method adds a texture from the file and passes it to the initWithTexture method. </li><li>  <b>initWithTexture:</b> Our main method.  PRFilledPolygon gets the texture and vertices of the polygon.  So, as the previous step has already processed the texture, in this method we will work with vertices: we will assemble them into one Box2D body.  After passing them to the PRFillePolygon, we initialize the necessary variables that we announced earlier. </li><li>  <b>initWithPoints:</b> Everything that does this method is associated with PRKit.  Most likely, you will no longer need to use PRKit. </li></ul><br>  Still <b>PolygonSprite.mm</b> add the following methods: <br><br><div class="spoiler">  <b class="spoiler_title">Click me</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)setPosition:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)position { [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> setPosition:position]; _body-&gt;SetTransform(b2Vec2(position.x/PTM_RATIO,position.y/PTM_RATIO), _body-&gt;GetAngle()); } - (b2Body*)createBodyForWorld:(b2World *)world position:(b2Vec2)position rotation:(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)rotation vertices:(b2Vec2*)vertices vertexCount:(int32)count density:(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)density friction:(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)friction restitution:(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)restitution { b2BodyDef bodyDef; bodyDef.type = b2_dynamicBody; bodyDef.position = position; bodyDef.angle = rotation; b2Body *body = world-&gt;CreateBody(&amp;bodyDef); b2FixtureDef fixtureDef; fixtureDef.density = density; fixtureDef.friction = friction; fixtureDef.restitution = restitution; fixtureDef.filter.categoryBits = <span class="hljs-number"><span class="hljs-number">0</span></span>; fixtureDef.filter.maskBits = <span class="hljs-number"><span class="hljs-number">0</span></span>; b2PolygonShape shape; shape.Set(vertices, count); fixtureDef.shape = &amp;shape; body-&gt;CreateFixture(&amp;fixtureDef); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> body; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)activateCollisions { b2Fixture *fixture = _body-&gt;GetFixtureList(); b2Filter filter = fixture-&gt;GetFilterData(); filter.categoryBits = <span class="hljs-number"><span class="hljs-number">0x0001</span></span>; filter.maskBits = <span class="hljs-number"><span class="hljs-number">0x0001</span></span>; fixture-&gt;SetFilterData(filter); } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)deactivateCollisions { b2Fixture *fixture = _body-&gt;GetFixtureList(); b2Filter filter = fixture-&gt;GetFilterData(); filter.categoryBits = <span class="hljs-number"><span class="hljs-number">0</span></span>; filter.maskBits = <span class="hljs-number"><span class="hljs-number">0</span></span>; fixture-&gt;SetFilterData(filter); }</code> </pre></div></div><br>  In this code, we first load the setPosition method into CCNode so that when we update the position of the sprite, the body of Box2D is also updated. <br>  Next, we create a method for creating and declaring the body of Box2D.  To create a body, we need to declare its object, shape, and texture.  So far we have not announced anything complicated, since this method will be used a little later. <br>  The only thing you need to pay attention to is categoryBits and maskBits.  We use them to filter collisions between objects so that if the category and mask match, then a collision will occur between the two objects.  We set these values ‚Äã‚Äãto 0, since we do not need collisions as soon as the objects are initialized. <br>  After that, we declare two methods that simply replace categoryBits and maskBits so that we can activate and deactivate the collisions of our PolygonSprite whenever we want. <br>  There is one more thing worth adding to <b>PolygonSprite.mm</b> : <br><br><div class="spoiler">  <b class="spoiler_title">Click me</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">-(<span class="hljs-built_in"><span class="hljs-built_in">CGAffineTransform</span></span>) nodeToParentTransform { b2Vec2 pos = _body-&gt;GetPosition(); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x = pos.x * PTM_RATIO; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y = pos.y * PTM_RATIO; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !isRelativeAnchorPoint_ ) { x += anchorPointInPoints_.x; y += anchorPointInPoints_.y; } <span class="hljs-comment"><span class="hljs-comment">//   float radians = _body-&gt;GetAngle(); float c = cosf(radians); float s = sinf(radians); if( ! CGPointEqualToPoint(anchorPointInPoints_, CGPointZero) ){ x += c*-anchorPointInPoints_.x+ -s*-anchorPointInPoints_.y; y += s*-anchorPointInPoints_.x+ c*-anchorPointInPoints_.y; } //   transform_ = CGAffineTransformMake( c, s, -s,c, x,y ); return transform_; }</span></span></code> </pre></div></div><br>  Remember how I mentioned something about PhysicsSprite?  Good, here it is.  All that is happening here is to check that the position of the Box2D form and the position of the sprite are the same. <br>  After copying the code above, you can remove PhysicsSprite.h and PhysicsSprite.mm from the project, since we have reduced their use to zero. <br>  Run the project, everything should go like clockwork.  We ended up with PolygonSprite for a bit. <br><br><h4>  Mark up the fruit </h4><br>  Before creating a class for our fruits, we need to fully define the rules that our pictures and their forms will follow.  Since we are going to trim our textures to polygon shapes, we also need to add some Box2D polygon restrictions.  You need to keep two things in mind: <br><br><ul><li>  The polygons should be <b>convex</b> , the inner corners should not be more than 180 degrees. </li><li>  There should be no more than <b>8 vertices</b> in polygons. </li></ul><br>  In general, we can work outside these limitations, for example, if our body consists of several forms.  Box2D can work with concave shapes if we use the triangular method and create concave shapes from several triangles, but this is outside the tutorial topic. <br>  To simplify the tutorial as much as possible, we will adhere to the rule: one body - one form. <br><br><blockquote>  <b>Note:</b> PhysicsEditor, a tool that we will look at later, already contains code that automatically converts concave shapes using the triangular method.  However, we are still trying to simplify the tutorial as much as possible, so we will only use convex shapes. </blockquote><br>  Take a look at these two fruits: <br><br><img src="https://habrastorage.org/storage2/38f/e7a/bbb/38fe7abbba1f0cb553295214348d7dbe.png"><br><br>  Using a banana is not a good idea, because it is initially concave.  Watermelon, on the contrary, is a great idea because it is convex and very closely follows the shape of the polygon. <br>  If we want to declare the shapes of the polygons that follow the Box2D rules for both fruits, we will eventually come to this: <br><br><img src="https://habrastorage.org/storage2/7b9/c70/b43/7b9c70b43aa24981f580d2e8a4bb9911.png"><br><br>  Watermelon polygons are perfect for a picture, while there is a huge gap in the shape of a banana. <br>  Box2D will recognize this gap as part of our object, and the collision of a banana with other objects, its cutting will not be natural enough. <br>  This does not mean that we cannot use a banana, it is not recommended just to do it yet. <br><br><h4>  Create the first fruit </h4><br>  It's time to create our first fruit: watermelon (at least its piece). <br>  When thinking about initializing our PolygonSprite class object, we recall that initWithTexture is waiting for the Box2D body, but a step before that, in initWithFile, there is no body yet. <br>  The reason for this is that we need to create and declare a body individually for each fruit, so this will be the very first step in initWithWorld that creates the body and sets the parameters for it. <br>  To create a Box2D body, we need to know the vertices of the polygon shape we want to create.  There are different ways to solve this problem, but in this tutorial we will use a tool called PhysicsEditor.  This tool is simply filled with different capabilities, but we will only use it to get the coordinates of the vertices of our polygon. <br>  If you don‚Äôt have one yet, <a href="http://sites.fastspring.com/codeandweb/product/all%3Fsource%3Draywenderlich">download PhysicsEditor</a> , install it and run it.  You will see an empty project with three panels. <br>  Working with PhysicsEditor is pretty obvious.  On the left we have all the pictures with which we work.  In the middle, we visually determine the polygon for our image.  On the right, we set the parameters for the body. <br><br><img src="https://habrastorage.org/storage2/1fc/21e/b05/1fc21eb05df32dd5f1b6fe03808a27a6.png"><br><br>  Drag watermelon.png from the resource folder to the left pane.  You should now see a watermelon in the center panel. <br>  Zoom to the level you want by dragging the slider at the bottom of the window.  Click the polygon at the top of this panel to create a polygon. <br>  Right-click the polygon and select ‚ÄúAdd Vertex‚Äù.  Repeat until you have 5-8 vertices.  Move the tops around the watermelon so that: <br><br><ul><li>  The landfill was convex. </li><li>  All the watermelon pixels were inside the polygon. </li></ul><br><blockquote>  <b>Note:</b> Another way to draw shapes is to select the ‚Äúmagic wand tool‚Äù in PhysicsEditor.  Just set the number of vertices to 5-8 and use this tool. </blockquote><br>  Add polygons to all fruits and bombs from the Images folder in the resources folder. <br>  You must make the following form of pictures: <br><br><ul><li>  banana.png </li><li>  bomb.png </li><li>  grapes.png </li><li>  pineapple.png </li><li>  strawberry.png </li><li>  watermelon.png </li></ul><br>  When you're done, change the value in the upper right corner to Exporter in ‚ÄúBox2D generic (PLIST)‚Äù, and you should get something like this: <br><br><img src="https://habrastorage.org/storage2/820/a56/280/820a56280c6a8ee9fdf533cd8edda6ab.png"><br><br>  Click ‚ÄúPublish‚Äù or ‚ÄúPublish As‚Äù to export a PLIST file with vertex information.  Save this file as fruits.plist. <br>  As an example, fruits.plist, which we use in this tutorial, is located inside the Misc folder of our resource pack. <br>  We need it only to understand the structure of the file, so do not add it to the project.  Instead, open it in Xcode and look at the contents. <br>  Click on the triangle near the ‚Äúbodies‚Äù to open the corresponding section and you will see a list of pictures with which we betrayed the form values.  Click on watermelon to access the tops of the watermelon: <br><br><img src="https://habrastorage.org/storage2/030/c07/d6c/030c07d6c357e93e9eb5e88c8cef7308.png"><br><br>  Expand watermelon / fixtures / Item 0 / polygons and you should see another Item 0 value, which is an array.  This array is our form.  If you did everything right, you should see only one array. <br>  If you see more than one array (for example: Item 0, Item 1), then you either created more than 8 vertices, or used a concave shape.  If this happens, go back to PhysicsEditor and correct the form. <br>  Next, expand Item 0 to see the final list of contents.  These are our vertices and their values ‚Äã‚Äãin the format {x, y}. <br> ,        ,      . <br>  Xcode      iOS\cocos2d v2.x\CCNode Class.    PolygonSprite    Watermelon.  <b>Watermelon.h</b>    : <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//     #import "PolygonSprite.h"</span></span></code> </pre><br>   <b>Watermelon.m</b> ,    <b>Watermelon.mm</b> ,     init: <br><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//   @implementation - (id)initWithWorld:(b2World *)world { int32 count = 7; NSString *file = @"watermelon.png"; b2Vec2 vertices[] = { b2Vec2(5.0/PTM_RATIO,15.0/PTM_RATIO), b2Vec2(18.0/PTM_RATIO,7.0/PTM_RATIO), b2Vec2(32.0/PTM_RATIO,5.0/PTM_RATIO), b2Vec2(48.0/PTM_RATIO,7.0/PTM_RATIO), b2Vec2(60.0/PTM_RATIO,14.0/PTM_RATIO), b2Vec2(34.0/PTM_RATIO,59.0/PTM_RATIO), b2Vec2(28.0/PTM_RATIO,59.0/PTM_RATIO) }; CGSize screen = [[CCDirector sharedDirector] winSize]; b2Body *body = [self createBodyForWorld:world position:b2Vec2(screen.width/2/PTM_RATIO,screen.height/2/PTM_RATIO) rotation:0 vertices:vertices vertexCount:count density:5.0 friction:0.2 restitution:0.2]; if ((self = [super initWithFile:file body:body original:YES])) { //   -     } return self; }</span></span></code> </pre></div></div><br>      ,     (   7). ,    ,   ,       PLIST .      ,   ,    PolygonSprite. <br>    ,           ,      ,     . <br> ,   ,         ,  Box2D   ‚Äî  . <br>     ,            . <br>    ,       ‚ÄúAdd Files to CutCutCut‚Äù.   Images     . ,   ‚ÄúCopy items into destination group's folder‚Äù  ‚ÄúCreate groups for any added folders‚Äù  . <br>    , ,   . <br>         .        ,       ,       ,     . <br>     ,   . <br><br><h4>     </h4><br>       ,  -        !  :] <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Switch to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HelloWorldLayer.h</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and make the following changes:</font></font><br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//     #import "PolygonSprite.h" //   @interface CCArray *_cache; //   @interface @property(nonatomic,retain)CCArray *cache;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Switch back to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HelloWorldLayer.mm</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and make the following changes:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Click me</font></font></b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//     #import "Watermelon.h" //   @implementation @synthesize cache = _cache; //    init,  [self initPhysics] [self initSprites]; //    dealloc,   [super dealloc] [_cache release]; _cache = nil; //  -  @implementation  @end - (void)initSprites { _cache = [[CCArray alloc] initWithCapacity:53]; //     .      . PolygonSprite *sprite = [[Watermelon alloc] initWithWorld:world]; [self addChild:sprite z:1]; [sprite activateCollisions]; [_cache addObject:sprite]; }</span></span></code> </pre></div></div><br>   -,         ,     . ,         .   activeteCollisions,       . <br>  ,   ,             . <br><br><img src="https://habrastorage.org/storage2/aa8/30a/b2f/aa830ab2fd8572d44520c4089d7cbebe.png"><br><br>   ,       .    ,        Box2D ,          .    ,     . <br><br><h4>  What's next? </h4><br>    <a href=""></a>      . <br>       .       ,   . <br>        ,       Box2D,   PRKit      ,      Box2D.     ! <br>     <a href="http://www.raywenderlich.com/14393/how-to-make-a-game-like-fruit-ninja-with-box2d-and-cocos2d-part-2"> </a> ,       ! <br><br><h5>  Translator's Note </h5><br>      <a href="http://www.raywenderlich.com/">raywenderlich.com</a> . <br>     iOS    ! <br>      , . <br>      , ,       . <br>        ! </div><p>Source: <a href="https://habr.com/ru/post/164599/">https://habr.com/ru/post/164599/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164585/index.html">Google, HelloFax, Expensify and others want you to abandon paper in 2013</a></li>
<li><a href="../164587/index.html">The modern Internet has turned 30 years old</a></li>
<li><a href="../164591/index.html">Playing Fruit Ninja with a real knife</a></li>
<li><a href="../164595/index.html">The easiest way to make rounded corners of any type in Internet Explorer 6,7,8 without JavaScript</a></li>
<li><a href="../164597/index.html">zsh: tips & tricks</a></li>
<li><a href="../164601/index.html">Work and life geek with attention problems</a></li>
<li><a href="../164605/index.html">Elite: Dangerous successfully raised ¬£ 1,250,000. The release of the game is scheduled for March 2014</a></li>
<li><a href="../164607/index.html">UITableView + sqlite3 for the smallest</a></li>
<li><a href="../164609/index.html">Simulation of the movement and drift of the machine in the game on JavaScript</a></li>
<li><a href="../164611/index.html">Unconventional use of Microsoft Reporting Services</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>