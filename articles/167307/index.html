<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SignalR to help, or how to animate the web</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In many web projects there are elements whose value must be changed frequently. These can be counters, indicators, notifications and si...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SignalR to help, or how to animate the web</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/5a1/468/4ca/5a14684ca49dd282e7627f7e12cfc231.gif"><br><h4>  Introduction </h4><br>  In many web projects there are elements whose value must be changed frequently.  These can be counters, indicators, notifications and similar elements.  Whether to show actual values ‚Äã‚Äãafter updating the page, or can you implement auto-update of all this data?  For us, the answer is obvious: if it is possible to dynamically change elements, then there is no space left for updating pages. <br><a name="habracut"></a><br>  For small projects that are not subject to critical loads, as long as they do not have several thousand users online at peak times, it would be an acceptable solution to use AJAX.  The logic for this solution is as follows: the client polls the server at specified intervals, looking for updates on the page, if the server reports that there is updated data, then javascript has updated the page elements or displays a notification.  The action that will be most appropriate. <br><br>  But for large projects a solution with AJAX, where each client will poll the server, this will create too much load.  Of course, we can optimize our capacities and create a chain of servers throughout the country that will be ready to handle all customer requests.  This is not our method.  We want the server to notify the client about the new data.  This practice is used in desktop applications ‚Äî a server to which clients connect using sockets.  This logic would be useful to us in the web.  There are already Websockets with which you can work, even .Net took the support of websockets under the wing.  But, objectively, it‚Äôs still too early to talk about everyday use of websockets.  Need something else.  It is possible to use longpolling, where we will open a connection on the client and we will not close it at all, waiting for events from the server.  No, we continue to look further. <br><br>  We paid attention to SignalR.  We describe how it works.  SignalR can use both websockets and longpolling as a transport.  Transportation can be set, but you can leave at the mercy of SignalR, who himself will choose the right one.  If you can use websocket, then it will work through websocket, if there is no such possibility, then it will go down further until it finds an acceptable transport. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider the work of SignalR in more detail when implementing a specific task.  What we have: a project, with registered users, each user has a personal account, in which there is a section of messages addressed to this user.  There is also a counter new messages.  We want that as soon as one user (user1) sends a message to another user (user2), on the open page of user2 the counter of new messages is immediately updated. <br><br>  To begin implementation, we need to connect SignalR to our project.  How to do this can be viewed on <a href="http://signalr.net/">the signalR page</a> , where you can also find the necessary documentation. <br>  If you use NuGet, then it will be enough to execute: <br><br><pre><code class="bash hljs">Install-Package Microsoft.AspNet.SignalR -pre</code> </pre> <br><h4>  We work </h4><br>  SignalR will use server and client parts.  On the server, the hub itself is the essence.  This is the Class that will allow us to describe the behavior of SignalR.  So it looks like in our example: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HubName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"msg"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Im</span></span> : <span class="hljs-title"><span class="hljs-title">Hub</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Send</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">dynamic</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Clients.All.SendMessage(message); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Register</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId</span></span></span><span class="hljs-function">)</span></span> { Groups.Add(Context.ConnectionId, userId.ToString(CultureInfo.InvariantCulture)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToGroup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">dynamic</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Clients.Group(id.ToString()).SendMessage(message); } } }</code> </pre><br>  We have created several methods. <br><ul><li>  Send - will send a message to all customers. </li><li>  Register - will help SignalR to find a particular user who needs to send a message.  Here you can see the use of Groups, tell about it later. </li><li>  ToGroup - will send a message to a particular user group.  Saying ‚Äúusers‚Äù we mean ‚Äúgroup uniting connections‚Äù. </li></ul><br>  Let's look at an example of client code, and begin to understand what's what: <br><br><pre> <code class="cs hljs">&lt;script src=<span class="hljs-string"><span class="hljs-string">"http://code.jquery.com/jquery-1.8.2.min.js"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-string"><span class="hljs-string">"Scripts/jquery.signalR-1.0.0-rc1.min.js"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-string"><span class="hljs-string">"/signalr/hubs"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt;&lt;/script&gt; &lt;script type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; $(function () { <span class="hljs-comment"><span class="hljs-comment">//  Id . var userId = &lt;%= UserId %&gt; //  var chat = $.connection.chat; //  callback,      chat.client.SendMessage = function (message) { //    UpdateMsgCounter(message); }; //   $.connection.hub.start().done(function() { //     chat.server.register(userId); }); }); &lt;/script&gt;</span></span></code> </pre><br>  Read more about client code.  SignalR will generate a hub for us.  You can watch it for curiosity <i>/ signalr / hubs</i> <br><br>  In the code, when starting the hub (the <i>start</i> method is used for this), we refer to the <i>register</i> method.  We already use it in server code.  How a <i>UserId</i> or other identifier will be obtained is not important now.  We use the simplest solution for ease of understanding.  If we did everything correctly, then when accessing the page with our client code, the hub starts, and the register method informs the server that the user userId has connected. <br><br>  Next, we have the task to tell SignalR about the user with the <i>UserId</i> identifier, this is necessary so that SignalR can send a message to this particular user when it is needed.  It should be noted that when starting the hub, SignalR operates with its connection identifier, and the <i>UserId is</i> not used.  Therefore, we will do so that SignalR can associate its connection identifier with the desired user.  Let's see what we can do in the SignalR server code. <br><br>  The following features are available to us: <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   Clients.All.send(message); // ,   Clients.Others.send(message); // ,     Clients.AllExcept(Context.ConnectionId).send(message); // ,   Clients.Caller.send(message); //     "foo" Clients.Group("foo").send(message); //     "foo",     Clients.OthersInGroup("foo").send(message); //     "foo",     Clients.Group("foo", Context.ConnectionId).send(message); //       Clients.Client(Context.ConnectionId).send(message);</span></span></code> </pre><br>  Important point: at each new access to the page (reloading the page), including opening it in a new tab, creates a connection with the new connection identifier SignalR.  This means that the <i>UserId</i> will not be enough to notify the user in each open browser tab.  We need to notify all the ConnectionId belonging to the <i>UserId</i> user.  For this, in our example of the hub class, in the Register method we added a group with the name <i>UserId,</i> each new ConnectionId.  Now we can operate <i>UserId</i> as a group name and notify all the ConnectionId of the user. <br><br><h4>  Private practice </h4><br>  Let's look at another situation.  <i>User2</i> wrote a message to <i>user1</i> and clicked the "Send" button.  What are our further actions?  You can write additional methods of the hub class and send messages using SignalR.  The hub will accept the message, process and notify the user.  In addition to sending the message itself with this action, as a rule, additional logic is connected: writing a message to the database, logging, sending a message for moderation, and much more.  There may be more complex examples.  Therefore, we will limit ourselves to using the hub only for its intended purpose: receiving and sending a message.  First we will use the good old AJAX and send a message from the user to HttpHandler.  Then we will do with it everything that is necessary (we will write it down in the database or send it for moderation) and eventually send it to the hub, which <i>notifies</i> user <i>user1</i> .  But there is a difficulty - HttpHandler is in the depths of one of the many libraries, in a completely different project.  We use the SignalR features to eliminate this complexity.  Create a proxy class for connecting to the hub: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HubConnection connection; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IHubProxy hub; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Url = <span class="hljs-string"><span class="hljs-string">"http://im.myProjectSite.com"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    connection = new HubConnection(Url); hub = connection.CreateHubProxy("msg"); connection.Start().Wait(); hub.Invoke("ToGroup", userId, message);</span></span></code> </pre><br><br>  Take a look at using the <i>Invoke</i> method.  We call our hub's <i>ToGroup</i> method, which will send the desired message to all connections ( <i>connectioId</i> ) associated with the desired <i>UserId</i> .  Here we also used <i>static</i> objects.  It is enough to initialize the proxy to the hub when the application starts, for example, in <i>global.asax</i> and, if necessary, call the method in which <i>Invoke</i> occurs. <br><br>  With the advent of SignalR in .Net, there is a need to add a few more lines of code: <br><br><pre> <code class="cs hljs">RouteTable.Routes.MapHubs(<span class="hljs-string"><span class="hljs-string">"~/signalr"</span></span>); RouteTable.Routes.MapHubs(); GlobalHost.HubPipeline.EnableAutoRejoiningGroups();</code> </pre><br>  Using SignalR routing is somewhat beyond the scope of our task.  We only say that <i>EnableAutoRejoiningGroups</i> will help us not to lose the connection in the group for the user when creating a new connection. <br><br><h4>  What are you sure to come across and how to solve it </h4><br>  After we have dealt with the examples described and collected a demo project (or embedded in an existing one), we are trying to test it for operability.  If everything is done correctly, the user will be notified of the new message, as we wanted.  We can even open several browser tabs to make sure that the alert comes in all tabs (all user <i>connectionId</i> ).  But as soon as we open a little more tabs, we will find that nothing works on the N tab.  For different browsers, N is different (4 or 6, too small).  This restriction does not allow creating more than N simultaneous connections to one hub.  In some projects, even large ones, you can see a solution in which the user is informed that he has already opened a similar dialogue somewhere and offers to either switch back to the old one or turn off the old one and switch to this one.  The restriction should not affect the user, he can open as many tabs as he wants and we will show notifications in each of them.  For this to work, we need to somehow make it clear to the browser that different hubs are being used, and not for one.  Earlier, when initializing the hub, we specified it as <i>Url: im.myProjectSite.com</i> .  Create ordinary mirrors: <br><br><pre> <code class="cs hljs">im1.myProjectSite.com im2.myProjectSite.com im3.myProjectSite.com</code> </pre><br><br>  And in the client code, we will substitute the address of the hub according to a certain algorithm.  The easiest way is every time you access the page (when you open it in a new tab), substitute <i>im (j + 1)</i> , and <i>j = 1</i> again after <i>im3</i> .  In this example, we increased the limit to 3N. <br><h4>  Conclusion </h4><br>  We have described only general principles using the simplest examples. <br>  When used in your projects, do not forget to pay special attention to safety.  If you look at the <i>Register</i> method of our hub, it will become obvious that anyone can call this method not under their <i>UserId</i> , which we do not want at all. <br><hr><br>  <i>The author of the article: Dmitry Lubensky, leading developer Dnevnik.ru.</i>  <i>Responsible for the work of the billing system and participates in the development of international direction.</i> </div><p>Source: <a href="https://habr.com/ru/post/167307/">https://habr.com/ru/post/167307/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../167291/index.html">Java for every day and not only. Recommendations for use</a></li>
<li><a href="../167293/index.html">Cyber ‚Äã‚ÄãMonday 2013 in Russia</a></li>
<li><a href="../167295/index.html">From the ‚Äústone jungle‚Äù to the ‚Äúsmart city‚Äù</a></li>
<li><a href="../167297/index.html">Step by step, or How we built your search</a></li>
<li><a href="../167303/index.html">Interview with Opera Mobile Store: Focus on Quality</a></li>
<li><a href="../167309/index.html">Another ‚Äúswitch for strings‚Äù - but not only for strings and not just ‚Äúswitch‚Äù</a></li>
<li><a href="../167311/index.html">Cypher desktop application written based on the node-webkit platform</a></li>
<li><a href="../167313/index.html">Business Modeling and IT Simulation with Witness 12</a></li>
<li><a href="../167315/index.html">Android: use Fragments to optimize the interface</a></li>
<li><a href="../167317/index.html">Breaking "matches" or "Breaking" matches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>