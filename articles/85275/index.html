<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Keyboard layout indicator next to the mouse text cursor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr. Today I want to present for your consideration a small utility-utility, which will show the keyboard layout indicator next to the mouse t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Keyboard layout indicator next to the mouse text cursor</h1><div class="post__text post__text-html js-mediator-article">  Hello, Habr.  Today I want to present for your consideration a small utility-utility, which will show the keyboard layout indicator next to the mouse text cursor. <br><br> <a title="ImageShack - Image And Video Hosting" href="http://img534.imageshack.us/i/clipboard01k.png/"><img src="https://habrastorage.org/getpro/habr/post_images/a0b/e64/471/a0be64471c14ed17061cb4155fccef2a.png"></a> <br><a name="habracut"></a><br><h4>  Intro </h4><br>  A long time ago (it seems, last Friday), about three years ago, there was a kind of free program (I‚Äôll not give the name, the author didn‚Äôt pay me for this year :)).  She is still there, only worth the money.  All its functionality consisted in showing the current keyboard layout next to the mouse <u>text</u> cursor.  The program was sitting in the tray, constantly displaying some pop-ups, (it seems) bursting into the Internet, getting underfoot, faithfully looking into the eyes, etc.  In general, a restless patient.  I saw her, admired the idea and tried to use it in my daily work.  It seemed to me very uncomfortable for the reasons described above, and then I decided to write my own, with blackjack and ... hmm, without popups.  Having looked a bit (a lot is impossible, in the EULA it is written so) the algorithm of its work, I found out that only a few API calls are used to achieve the desired effect. <br><br><h4>  Cursor </h4><br>  So, for a start, let's figure out how to change the text cursor icon.  MSDN tells us that this can be done by calling SetSystemCursor.  The first parameter is to pass the handle to the cursor, and the second to indicate which cursor we are changing - the main one, the busy cursor, the text cursor, etc.  In this particular case, the second parameter will be OCR_IBEAM, and we will now deal with the first one.  After carefully reading the article on SetSystemCursor (which I didn‚Äôt do for the first time), you can see that you cannot transfer a handle that you received using the LoadCursor function to the cursor, because  the system destroys the cursor passed to SetSystemCursor (commendable cleanliness, otherwise in other places).  It also says in MSDN that this problem is solved by copying the cursor before passing it to SetSystemCursor using the CopyCursor function.  So, if we add a resource with a cursor to exe-schnick, you can use it like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">HCURSOR hRuCur = LoadCursorA(GetModuleHandleA(0), MAKEINTRESOURCEA(IDC_RUS));&lt;br&gt;HCURSOR hRuCopy = CopyCursor(hRuCur);&lt;br&gt;SetSystemCursor(hRuCopy, OCR_IBEAM);</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  This code will replace the text mouse cursor (I-beam) with the cursor loaded from the IDC_RUS resource.  And it will replace in all applications. <br><br><h4>  Layout </h4><br>  How to change the cursor, we found out.  Now let's look at how to determine the keyboard layout for the window, over which the mouse cursor is now located.  Let's go from the end - define the window above the cursor.  This is done using the following sequence of API calls: call GetCursorPos to determine the current coordinates of the cursor, then call WindowFromPoint with the received coordinates.  Voila, we've got the handle.  Why do we need it?  :) To define the keyboard layout in the window under the cursor.  How to do it?  Call GetKeyboardLayout, of course!  Only here it needs some obscure thread id - the thread id in which the window was created.  A little digging in the adjacent sections of MSDN, you can find the function GetWindowThreadProcessId, which returns the id of the thread that created it using the known window handle.  Puzzle gathered: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">POINT p;&lt;br&gt;HWND wnd;&lt;br&gt;HKL lay;&lt;br&gt;DWORD dwThreadId;&lt;br&gt;GetCursorPos(&amp;p);&lt;br&gt;wnd = WindowFromPoint(p);&lt;br&gt;dwThreadId = GetWindowThreadProcessId(wnd, 0);&lt;br&gt;lay = GetKeyboardLayout(dwThreadId);</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The codes of keyboard layouts can be found in MSDN, if you search for a long time :) And you can put a breakpoint on the last line and look at the layouts for different layouts. <br><br><h4>  Together </h4><br>  Now we know all the parts of our future utility, we can put them together.  Because  My main motivation was to create a light and very small program, I put all the above code right in WinMain and made it spin there indefinitely without the possibility of exiting the loop.  And why, exactly?  Full listing looks like this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">int</font> __stdcall WinMain(__in HINSTANCE hInstance, __in_opt HINSTANCE hPrevInstance, __in_opt LPSTR lpCmdLine, __in <font color="#0000ff">int</font> nShowCmd )&lt;br&gt;{&lt;br&gt;  HCURSOR hRuCur = LoadCursorA(GetModuleHandleA(0), MAKEINTRESOURCEA(IDC_RUS));&lt;br&gt;  HCURSOR hEnCur = LoadCursorA(GetModuleHandleA(0), MAKEINTRESOURCEA(IDC_ENG));&lt;br&gt; <font color="#0000ff">if</font> (!hEnCur || !hRuCur)&lt;br&gt;  {&lt;br&gt;    MessageBoxA(0, <font color="#A31515">"Failed to load cursors. Terminating."</font> , <font color="#A31515">"Fatal error"</font> , MB_ICONERROR);&lt;br&gt; <font color="#0000ff">return</font> 0;&lt;br&gt;  }&lt;br&gt;&lt;br&gt; <font color="#0000ff">while</font> (1)&lt;br&gt;  {&lt;br&gt;    HCURSOR hRuCopy;&lt;br&gt;    HCURSOR hEnCopy;&lt;br&gt;    HKL lay = 0;&lt;br&gt;    POINT p;&lt;br&gt;    HWND wnd;&lt;br&gt;    DWORD dwThreadId = 0;&lt;br&gt;&lt;br&gt;    hRuCopy = CopyCursor(hRuCur);&lt;br&gt;    hEnCopy = CopyCursor(hEnCur);&lt;br&gt;&lt;br&gt;    GetCursorPos(&amp;p);&lt;br&gt;    wnd = WindowFromPoint(p);&lt;br&gt; <font color="#0000ff">if</font> (!IsWindow(wnd)) <font color="#0000ff">continue</font> ;&lt;br&gt;&lt;br&gt;    dwThreadId = GetWindowThreadProcessId(wnd, 0);&lt;br&gt;    lay = GetKeyboardLayout(dwThreadId);&lt;br&gt;&lt;br&gt; <font color="#0000ff">if</font> ((DWORD)lay == 0x4190419 <font color="#008000">/*RU*/</font> ) SetSystemCursor(hRuCopy, OCR_IBEAM);&lt;br&gt; <font color="#0000ff">if</font> ((DWORD)lay == 0x4090409 <font color="#008000">/*EN*/</font> ) SetSystemCursor(hEnCopy, OCR_IBEAM);&lt;br&gt;&lt;br&gt;    Sleep(250);&lt;br&gt;  }&lt;br&gt;&lt;br&gt; <font color="#0000ff">return</font> 0;&lt;br&gt;}</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><h4>  Project in VS </h4><br>  To create a project in visual studio, you need to select Win32 - Win32 Project - Empty project, add a cpp-file with the above-described winmain function and add two options for cursors - for systems with two layouts, naturally :) Cursors can be taken ready in the internet, or you can draw it yourself right in the studio.  But that is not all!  After all, it was about a ‚Äúsmall utility-utility‚Äù, right?  A monster in 70Kb does not fit this description :) Therefore, we climb under the hood and remove all that is possible.  First, the project properties - Linker - Advanced - Entry point - WinMain.  Secondly, the project properties - Linker - Command line - align: 16.  Thirdly, you can still poke the buttons to your taste.  After recompilation, I got 3Kb, of which 1.5Kb are cursors.  Maybe even less, I don't know. <br><br><h4>  Autro </h4><br>  The code can be called ‚Äúdirty‚Äù, ugly, etc.  However, it performs its function for one hundred percent - the mouse cursor has now become more informative, no one throws out a crowd of unnecessary popups in the system tray, and the priceless RAM is free to accommodate the Windows Help and Support service absolutely necessary for it. </div><p>Source: <a href="https://habr.com/ru/post/85275/">https://habr.com/ru/post/85275/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../85258/index.html">Cat pasture</a></li>
<li><a href="../85263/index.html">Little known blackout</a></li>
<li><a href="../85265/index.html">File sharing - a view from the inside</a></li>
<li><a href="../85271/index.html">History in maps</a></li>
<li><a href="../85273/index.html">Parallel notes number 3 - the basic structure of OpenMP</a></li>
<li><a href="../85277/index.html">Javascript Pseudo-3d Game. Stage 2</a></li>
<li><a href="../85278/index.html">Competition from BitDefender to Defender of the Fatherland Day</a></li>
<li><a href="../85282/index.html">Practicing savvy, or how to turn routine into pleasure</a></li>
<li><a href="../85283/index.html">Real Jedi Mouse</a></li>
<li><a href="../85284/index.html">Firefox thanks for choosing Opera</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>