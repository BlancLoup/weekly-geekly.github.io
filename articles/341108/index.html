<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Moxy Strategies (Part 2)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In part 1, we figured out why we need strategies in Moxy and when it is appropriate to apply each of them. In this article, we will look at the mechan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Moxy Strategies (Part 2)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/vm/l6/wb/vml6wbfns9o_ccut4y4lkbymouk.png"><br><p>  In <a href="https://habrahabr.ru/company/redmadrobot/blog/325816/">part 1,</a> we figured out why we need strategies in <a href="https://github.com/Arello-Mobile/Moxy">Moxy</a> and when it is appropriate to apply each of them.  In this article, we will look at the mechanism of how strategies work from the inside, understand when we may need custom strategies, and try to create our own. </p><a name="habracut"></a><br><h2 id="zachem-nuzhny-kastomnye-strategii">  Why do we need custom strategies </h2><br><p>  Why does <a href="https://github.com/Arello-Mobile/Moxy">Moxy</a> support the creation of <br>  custom strategies?  When designing the library, we (I) tried to take into account all possible cases, and the built-in strategies cover almost one hundred percent of them.  However, in some cases, you may need more power over the situation, and we did not want to limit you.  Consider one of these cases. </p><br><p>  Presenter is responsible for choosing a business lunch, which consists of a burger and a drink. <br>  Commands, depending on the function, are divided into the following types: </p><br><ul><li>  customize a burger (add / remove cheese, choose rye / wheat bread, etc.); </li><li>  customize the drink (choose the number of tablespoons of sugar, add / remove lemon, etc.); </li><li>  notify you that the order has been shipped. </li></ul><br><p>  So, we want to be able to separately manage the queues for burger and beverage teams.  There will not be enough default strategies for this, in addition we need burger and beverage!  Let's invent them, but first, let's look at how the mechanism for the use of commands works and what strategies influence. </p><br><h2 id="mehanika-raboty-komand-moxy">  Moxy command mechanics </h2><br><p>  Let's start from afar: the <strong>ViewState</strong> is created in the presenter constructor, all commands are proxied through it.  <em>ViewState</em> contains the command queue ‚Äî <a href="">ViewCommands</a> (the class that is responsible for the list of commands and strategies) and the <strong>View</strong> list.  The View list can contain as many View, if you are using a presenter like <strong>Global</strong> or <strong>Weak</strong> , or none (in the situation when your piece went into the back stack). </p><br><div class="spoiler">  <b class="spoiler_title">Global and Weak Presenters</b> <div class="spoiler_text"><p>  Between us, do not build on their basis of architecture, as they do not climb into their area of ‚Äã‚Äãresponsibility.  It is better to shuffle data between screens with the help of general entities like interactors in a pure architecture.  There is a nice <a href="https://habrahabr.ru/company/mobileup/blog/335382/">article</a> on clean architecture <a href="https://habrahabr.ru/company/mobileup/blog/335382/">.</a> </p></div></div><br><p>  First, let's look at what the strategy is: </p><br><div class="spoiler">  <b class="spoiler_title">Statestrategy</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateStrategy</span></span></span><span class="hljs-class"> </span></span>{ &lt;View extends MvpView&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeApply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( List&lt;ViewCommand&lt;View&gt;&gt; currentState, ViewCommand&lt;View&gt; incomingCommand)</span></span></span></span>; &lt;View extends MvpView&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">afterApply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( List&lt;ViewCommand&lt;View&gt;&gt; currentState, ViewCommand&lt;View&gt; incomingCommand)</span></span></span></span>; }</code> </pre> </div></div><br><p>  This is an interface with two methods: <strong>beforeApply</strong> and <strong>afterApply</strong> .  Each input method accepts a new command and a current list of commands, which will change (or remain unchanged) in the method body.  For each team, we can get a tag (this is a string that can be specified in the annotation <a href="">StateStrategyType</a> ) and the type of strategy (see listing below).  How exactly to change the list we decide, relying <strong>only</strong> on this information. <br></p><br><div class="spoiler">  <b class="spoiler_title">Viewcommand</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewCommand</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">View</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MvpView</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String mTag; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Class&lt;? extends StateStrategy&gt; mStateStrategyType; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ViewCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( String tag, Class&lt;? extends StateStrategy&gt; stateStrategyType)</span></span></span><span class="hljs-function"> </span></span>{ mTag = tag; mStateStrategyType = stateStrategyType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mTag; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends StateStrategy&gt; getStrategyType() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mStateStrategyType; } }</code> </pre> </div></div><br><p>  Let's understand when we will call these methods.  So, we have a <strong>SimpleBurgerView</strong> interface that can only add a little cheese (II). <br></p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleBurgerView</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BaseView { @StateStrategyType</span></span></span></span>(value = AddToEndSingleStrategy::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">tag = "Cheese") fun toggleCheese</span></span></span></span>(enable: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) }</code> </pre> <br><p>  Consider what happens when you call the <strong>toggleCheese</strong> method <strong>on</strong> the generated class <strong>LaunchView $$ State</strong> (see listing): <br></p><br><div class="spoiler">  <b class="spoiler_title">LaunchView $$ State</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toggleCheese</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p0_32355860)</span></span></span><span class="hljs-function"> </span></span>{ ToggleCheeseCommand toggleCheeseCommand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ToggleCheeseCommand(p0_32355860); mViewCommands.beforeApply(toggleCheeseCommand); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mViews == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || mViews.isEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(com.redmadrobot.app.presentation.launch.LaunchView view : mViews) { view.toggleCheese(p0_32355860); } mViewCommands.afterApply(toggleCheeseCommand); }</code> </pre> </div></div><br><p>  1) ToggleCheeseCommand is created (see listing below) </p><br><div class="spoiler">  <b class="spoiler_title">ToggleCheeseCommand</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ToggleCheeseCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewCommand</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">redmadrobot</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">presentation</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">launch</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeView</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> enable; ToggleCheeseCommand( <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> enable) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(<span class="hljs-string"><span class="hljs-string">"toggleCheese"</span></span>, com.arellomobile.mvp.viewstate.strategy.AddToEndStrategy.class); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.enable = enable; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(com.redmadrobot.app.presentation.launch.SomeView mvpView)</span></span></span><span class="hljs-function"> </span></span>{ mvpView.toggleCheese(enable); } }</code> </pre> </div></div><br><p>  2) the <strong>beforeApply</strong> method is <strong>called</strong> for the <strong>ViewCommands</strong> class for this command.  In it, we get the strategy and call its <strong>beforeApply</strong> method.  (see listing below) </p><br><div class="spoiler">  <b class="spoiler_title">ViewCommands.beforeApply</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeApply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ViewCommand&lt;View&gt; viewCommand)</span></span></span><span class="hljs-function"> </span></span>{ StateStrategy stateStrategy = getStateStrategy(viewCommand); stateStrategy.beforeApply(mState, viewCommand); }</code> </pre> </div></div><br><p>  Hooray!  Now we know when the strategy's <strong>beforeApply</strong> method is <strong>executed</strong> : <strong>immediately</strong> after the corresponding method call on the ViewState and <strong>only then</strong> .  We continue the dive! <br>  In case we have a View: </p><br><p>  3) They are alternately proxied to the toggleCheese method. </p><br><p>  4) the afterApply method for the ViewCommands class for the given command is called.  In it, we get the strategy and call its afterApply method. </p><br><p>  However, <strong>afterApply</strong> is called <strong>not only</strong> in this case.  It will also be called in case of an attachment of a new View.  Let's look at this case.  When the attachment View is called, the <strong>attachView</strong> method <strong>(View view)</strong> </p><br><p>  The <strong>attachView</strong> method <strong>(View view)</strong> is called from the <strong>onAttach ()</strong> method of the <strong>MvpDelegate</strong> class.  That in turn is called quite often: from the <strong>onStart ()</strong> and <strong>onResume ()</strong> methods.  However, the library guarantees that <strong>afterApply will be</strong> called once for an <strong>attachment</strong> view (see listing below). </p><br><br><div class="spoiler">  <b class="spoiler_title">MvpViewState.attachView</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attachView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (view == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Mvp view must be not null"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isViewAdded = mViews.add(view); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isViewAdded) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } mInRestoreState.add(view); Set&lt;ViewCommand&lt;View&gt;&gt; currentState = mViewStates.get(view); currentState = currentState == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? Collections.&lt;ViewCommand&lt;View&gt;&gt;emptySet() : currentState; restoreState(view, currentState); mViewStates.remove(view); mInRestoreState.remove(view); }</code> </pre> </div></div><br><p>  1) View is added to the list. <br>  2) If it is not in this list, I <strong>twist it to the StateRestoring</strong> state <strong>.</strong> </p><br><div class="spoiler">  <b class="spoiler_title">Why stateRestoring is needed</b> <div class="spoiler_text"><p>  . <br>  This makes it possible for activations / views / fragments to understand that the state is being restored.  The presenter has an <strong>isInRestoreState ()</strong> method.  This mechanism is necessary in order not to perform some actions twice (for example, starting an animation to translate a view into the desired state).  This is the only <strong>presenter</strong> method that returns non- <strong>void</strong> .  This method belongs to the <strong>presenter</strong> , since  <strong>view</strong> and <strong>mvpDelegate</strong> can have several presenters and putting them in these classes would lead to collisions. </p></div></div><br><p>  3) Next, the state is restored </p><br><p>  It is worth noting that the <strong>afterApply</strong> method can be called several times.  Pay attention to this when writing your custom strategies. </p><br><p>  We got acquainted with how strategies work, it‚Äôs time to consolidate skills in practice. </p><br><h2 id="sozdaem-kastomnuyu-strategiyu">  Create custom strategy </h2><br><p>  <strong>Scheme of work</strong> <br>  So, first, let's understand what kind of strategy we want to get.  We agree on the notation. </p><br><img src="https://habrastorage.org/webt/bl/nu/77/blnu77r8v8fpcmmfcub_nsj343w.png"><br><p>  This scheme is similar to the scheme from the first part, but there is an important difference in it ‚Äî a tag designation appeared.  The absence of a command tag means that we did not specify it and it assumed the default value - null </p><br><p>  We want to implement the following strategy: </p><br><img src="https://habrastorage.org/webt/pv/lh/vd/pvlhvdcjk6sq4x425zcdl0tbhye.png"><br><p>  When calling a team presenter (2) with the AddToEndSingleTagStrategy strategy: </p><br><ul><li>  The command (2) is added to the end of the ViewState queue. </li><li>  If any other team with the same tag is already in the queue, it is removed from the queue. </li><li>  Command (2) applies to View if it is in active state. </li></ul><br><p>  When recreating a View: </p><br><ul><li>  View commands are sequentially applied to the ViewState queue </li></ul><br><p>  <strong>Implementation</strong> <br>  1) Implement the StateStrategy interface.  To do this, override the beforeApply and afterApply methods. <br>  2) The implementation of the beforeApply method will be very similar to the implementation of a similar method in the <a href="">AddToEndSingleStrategy</a> class. <br>  We want to remove from the queue <strong>absolutely all</strong> teams with this tag, i.e.  even teams with a different strategy, but with a similar tag, will be deleted. <br>  Therefore, instead of <strong>entry.class == incomingCommand.class,</strong> we will use <strong>entry.tag == incomingCommand.tag</strong> </p><br><div class="spoiler">  <b class="spoiler_title">Comment for non Kotlin users</b> <div class="spoiler_text"><p>  In Kotlin == equivalent to .equals in Java </p></div></div><br><p>  We also need to remove the <strong>break</strong> string, since, unlike <a href="">AddToEndSingleStrategy</a> , we may have several commands in the queue for deletion. <br>  3) <strong>We</strong> will leave the implementation of the <strong>afterApply</strong> method empty, since we do not need to change the queue after applying the command. </p><br><p>  So, what we have: </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddToEndSingleTagStrategy</span></span></span></span>() : StateStrategy { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;View : MvpView&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeApply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( currentState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MutableList</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ViewCommand</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;&gt;, incomingCommand: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ViewCommand</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> iterator = currentState.iterator() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (iterator.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> entry = iterator.next() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entry.tag == incomingCommand.tag) { iterator.remove() } } currentState.add(incomingCommand) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;View : MvpView&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">afterApply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( currentState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MutableList</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ViewCommand</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;&gt;, incomingCommand: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ViewCommand</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//Just do nothing } }</span></span></code> </pre> <br><p>  That's all, it remains to illustrate how we will use the strategy (see listing below). <br></p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LaunchView</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MvpView { @StateStrategyType</span></span></span></span>(AddToEndSingleStrategy::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">tag = BURGER_TAG) fun setBreadType</span></span></span></span>(breadType: BreadType) <span class="hljs-meta"><span class="hljs-meta">@StateStrategyType(AddToEndSingleStrategy::class, tag = BURGER_TAG)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toggleCheese</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(enable: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-meta"><span class="hljs-meta">@StateStrategyType(AddToEndSingleTagStrategy::class, tag = BURGER_TAG)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearBurger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(breadType: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">BreadType</span></span></span></span><span class="hljs-function"><span class="hljs-params">, cheeseSelected: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">//  companion object { const val BURGER_TAG = "BURGER" } }</span></span></code> </pre> <br><p>  The full code sample can be viewed in the <a href="https://github.com/Arello-Mobile/Moxy/tree/master/sample-custom-strategy">Moxy</a> repository.  I remind you that this is a sample and the solutions in it are purely to illustrate the functionality of the framework </p><br><h2 id="prednaznachenie">  Purpose .. </h2><br><p>  What else can you use custom strategies for: <br>  1) glue the previous teams into one; <br>  2) change the order of command execution if the commands are not commutative (a ‚Ä¢ b! = B ‚Ä¢ a); <br>  3) throw out all the commands that <strong>do not</strong> contain the current tag; <br>  four) .. </p><br><p>  If you often use commands, and they are not in the list of defaults - write, we will discuss their addition. <br>  You can discuss Moxy in the <a href="https://t.me/moxy_ru">community chat.</a> </p><br><p>  We are waiting for comments and suggestions on the article and the library;) </p><br><hr><br><p>  (I) hereinafter "we" - the authors of Moxy: <a href="https://habrahabr.ru/users/xanderblinov/" class="user_link">Xanderblinov</a> , <a href="https://habrahabr.ru/users/senneco/" class="user_link">senneco</a> and all the guys from the community who helped with advice, comments and pullrequest.  Full list of contributors can be found <a href="https://github.com/Arello-Mobile/Moxy/graphs/contributors">here.</a> </p><br>  (Ii) Code in listings written in Kotlin </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/341108/">https://habr.com/ru/post/341108/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341094/index.html">Stryker, mutation testing in javascript</a></li>
<li><a href="../341096/index.html">Fake emails from almost any person in less than 5 minutes and ways to protect</a></li>
<li><a href="../341100/index.html">We help taxi service: redesign of the logo and the appearance of corporate identity</a></li>
<li><a href="../341102/index.html">Sharing with RAIDIX and Apple Xsan. Apple saved for video editors</a></li>
<li><a href="../341106/index.html">Android O and background services</a></li>
<li><a href="../341110/index.html">Another operating system architecture</a></li>
<li><a href="../341112/index.html">Another virtual machine architecture (part one)</a></li>
<li><a href="../341114/index.html">Another virtual machine architecture (part two)</a></li>
<li><a href="../341116/index.html">‚ÄúI will find out! I recognize my brother Kohl! "- The realities of modern information security in the field of wireless technologies</a></li>
<li><a href="../341118/index.html">Those. support. How much money can you make on this? (Part 2 - "Abroad")</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>