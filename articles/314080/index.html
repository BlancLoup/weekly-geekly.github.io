<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience using MassTransit 3.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MassTransit is an open source library developed in the C # language for the .NET platform that simplifies work with the data bus, which is used in bui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience using MassTransit 3.0</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/6cd/ded/a5e/6cddeda5ee8f4d3cb5c9dbb557aef6b0.png" align="right" width="325">  MassTransit is an open source library developed in the C # language for the .NET platform that simplifies work with the data bus, which is used in building distributed applications and implementing SOA (service oriented architecture). <br><br>  RabbitMq, Azure Service Bus or In-Memory Manager can act as a message broker (in the case of In-Memory, the scope is limited to the process in which the instance is initialized). <br><a name="habracut"></a><br>  <b>Content:</b> <br><br><ul><li>  <a href="https://habr.com/ru/post/314080/">Teams and Events</a> <br><ul><li>  <a href="https://habr.com/ru/post/314080/">Teams</a> </li><li>  <a href="https://habr.com/ru/post/314080/">Developments</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/314080/">Message Contracts</a> </li><li>  <a href="https://habr.com/ru/post/314080/">Routing</a> <br><ul><li>  <a href="https://habr.com/ru/post/314080/">Exchange</a> </li><li>  <a href="https://habr.com/ru/post/314080/">Message format</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/314080/">Consumer (Consumer)</a> </li><li>  <a href="https://habr.com/ru/post/314080/">DI Container Configuration</a> </li><li>  <a href="https://habr.com/ru/post/314080/">Observers</a> </li><li>  <a href="https://habr.com/ru/post/314080/">New to MassTransit 3.0</a> </li><li>  <a href="https://habr.com/ru/post/314080/">Conclusion</a> </li><li>  <a href="https://habr.com/ru/post/314080/">Survey: And which .NET library do you use?</a> </li></ul><br><a name="command-event"></a><h2>  Teams and Events </h2><br>  The library contains 2 main types of messages: commands and events. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="command"></a><h3>  Teams </h3><br>  Signal the need to perform some action.  For the most meaningful name of the command, it is advisable to use the structure of the verb + noun: <br>  EstimateConnection, SendSms, NotifyCustomerOrderProcessed. <br><br>  Working with commands is performed using the Send method ( <a href="">ISendEndpoint</a> interface) and specifying the endpoint receiver (queue): <br><br><div class="spoiler">  <b class="spoiler_title">Sending team</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendSmsCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IBus busControl</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> command = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SendSmsCommand { CommandId = Guid.NewGuid(), PhoneNumber = <span class="hljs-string"><span class="hljs-string">"89031112233"</span></span>, Message = <span class="hljs-string"><span class="hljs-string">"Thank you for your reply"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> endpoint = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> busControl.GetSendEndpoint(AppSettings.CommandEndpoint); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> endpoint.Send(command); }</code> </pre> <br></div></div><br><a name="event"></a><h3>  Developments </h3><br>  They signal an incident that may be of interest to a certain set of subscribers (Observer pattern) that react to these events, for example: ConnectionEstimated, CallTerminated, SmsSent, CustomerNotified. <br><br>  Work with events is carried out using the Publish method ( <a href="">IPublishEndpoint</a> interface). <br><br>  The terminology also contains the main difference between these types of messages - the team is delivered to a single performer (in order to avoid duplication of execution): <br><br><img src="https://habrastorage.org/files/938/955/2b8/9389552b8349466fb8b5c7a4be8f212e.png"><br>  Image from article <a href="https://www.maldworth.com/2015/10/27/masstransit-send-vs-publish/">MassTransit Send vs.</a>  <a href="https://www.maldworth.com/2015/10/27/masstransit-send-vs-publish/">Publish</a> <br><br>  While the event is focused on the notification of n-subscribers, each of which responds to the incident event in its own way. <br><br><img src="https://habrastorage.org/files/a66/17a/7e5/a6617a7e54464fa3a649982c2d8eb64e.png"><br>  Image from article <a href="https://www.maldworth.com/2015/10/27/masstransit-send-vs-publish/">MassTransit Send vs.</a>  <a href="https://www.maldworth.com/2015/10/27/masstransit-send-vs-publish/">Publish</a> <br><br>  In other words, when n-consumers are launched (from the English consumer, the consumer is the processor), processing the command, after its publication only one of them will receive a message about it, while everyone will receive a message about the event. <br><br><a name="contract"></a><h2>  Message Contracts </h2><br>  According to the MassTransit documentation, when declaring message contracts, it is <a href="http://docs.masstransit-project.com/en/latest/usage/messages.html">recommended</a> to use interfaces: <br><br><div class="spoiler">  <b class="spoiler_title">Contract: command to send SMS</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISendSms</span></span> { Guid CommandId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PhoneNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre><br></div></div><br>  As mentioned earlier, commands should be sent exclusively using the Send method (IBus interface) and specifying the addressee (endpoint). <br><br><div class="spoiler">  <b class="spoiler_title">Contract: event of successful sending an SMS message</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISmsSent</span></span> { Guid EventId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } DateTime SentAtUtc { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre><br></div></div><br>  Events are sent using the Publish method. <br><br><a name="routing"></a><h2>  Routing </h2><br>  Both the distribution of messages by exchange and the choice of consyumers (they will be discussed in this article a little later) for processing are based on runtime types of these messages - the name uses the namespace and type name, in the case of generic, the parent type name and the list of arguments. <br><br><a name="exchange"></a><h3>  Exchange </h3><br>  When <a href="">configuring receive endpoint</a> 'a (connecting previously registered consumers), when using RabbitMq as a delivery channel, based on the message types specified for processing by consumers <a href="">, the</a> names of the required exchange are formed, into which these same messages will then be placed. <br><br>  Similar actions at the <a href="">send endpoint</a> 'a <a href="">configuration</a> stage are also performed for commands, for sending which also their own exchange is required. <br><br>  On the image you can see created in the framework of my exchange script: <br><br><img src="https://habrastorage.org/files/04e/ceb/d75/04ecebd75f8f457283d98f45b14d4701.png"><br><br>  In that case, when configuring the receive endpoint, we specify the name of the queue: <br><br><pre> <code class="cs hljs">cfg.ReceiveEndpoint(host, <span class="hljs-string"><span class="hljs-string">"play_with_masstransit_queue"</span></span>, e =&gt; e.LoadFrom(container));</code> </pre><br>  then in the exchange message bindings you will see the following picture: <br><br><img src="https://habrastorage.org/files/1b9/cf7/572/1b9cf757267244b2a25cdb32c1b3908a.png"><br><br>  The final message path, the type of which is implemented by ISmsEvent, will have the following form: <br><br><img src="https://habrastorage.org/files/842/8f1/37f/8428f137f57f4193adc5648d0d11d371.png"><br><br>  If the configuration is carried out without specifying a queue: <br><br><pre> <code class="cs hljs">cfg.ReceiveEndpoint(host, e=&gt; e.LoadFrom(container));</code> </pre><br>  The names for the last exchange and the queue are formed automatically, and upon completion of the work, they will be deleted: <br><br><img src="https://habrastorage.org/files/680/1cb/3d5/6801cb3d50074c6caa68f8202c693a8b.png"><br><br><a name="message-body"></a><h3>  Message format </h3><br>  Speaking about the message format, I would like to elaborate on the name (or messageType).  For its formation (headers urn: message :), the function <a href="">GetUrnForType (Type type) is</a> responsible.  For example, I added inheritance from ICommand for the ISendSms command and the generic type: <br><br><div class="spoiler">  <b class="spoiler_title">Contract: command for sending SMS messages ICommand &lt;string&gt;</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ICommand</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISendSms</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ICommand</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { Guid CommandId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PhoneNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SendSmsCommand</span></span> : <span class="hljs-title"><span class="hljs-title">ISendSms</span></span>&lt;<span class="hljs-title"><span class="hljs-title">string</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Guid CommandId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PhoneNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br></div></div><br>  The generated message in this case will contain the following value in the messageType field (based on which, after receiving the message, then the costumer responsible for processing is selected): <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"messageType"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"urn:message:PlayWithMassTransit30.Extension:SendSmsCommand"</span></span>, <span class="hljs-string"><span class="hljs-string">"urn:message:PlayWithMassTransit30.Contract.Command:ISendSms[[System:String]]"</span></span>, <span class="hljs-string"><span class="hljs-string">"urn:message:PlayWithMassTransit30.Contract.Command:ICommand[[System:String]]"</span></span> ]</code> </pre><br>  In addition to the messageType, the message contains information about the host to which it was sent: <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"host"</span></span>: { <span class="hljs-string"><span class="hljs-string">"machineName"</span></span>: <span class="hljs-string"><span class="hljs-string">"DESKTOP-SI9OHUR"</span></span>, <span class="hljs-string"><span class="hljs-string">"processName"</span></span>: <span class="hljs-string"><span class="hljs-string">"PlayWithMassTransit30.vshost"</span></span>, <span class="hljs-string"><span class="hljs-string">"processId"</span></span>: <span class="hljs-number"><span class="hljs-number">1092</span></span>, <span class="hljs-string"><span class="hljs-string">"assembly"</span></span>: <span class="hljs-string"><span class="hljs-string">"PlayWithMassTransit30"</span></span>, <span class="hljs-string"><span class="hljs-string">"assemblyVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"frameworkVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"4.0.30319.42000"</span></span>, <span class="hljs-string"><span class="hljs-string">"massTransitVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.4.1.808"</span></span>, <span class="hljs-string"><span class="hljs-string">"operatingSystemVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"Microsoft Windows NT 6.2.9200.0"</span></span> }</code> </pre><br>  Significant part of payload: <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"message"</span></span>: { <span class="hljs-string"><span class="hljs-string">"commandId"</span></span>: <span class="hljs-string"><span class="hljs-string">"7388f663-82dc-403a-8bf9-8952f2ff262e"</span></span>, <span class="hljs-string"><span class="hljs-string">"phoneNumber"</span></span>: <span class="hljs-string"><span class="hljs-string">"89031112233"</span></span>, <span class="hljs-string"><span class="hljs-string">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"Thank you for your reply"</span></span> }</code> </pre><br>  and other service fields and headers. <br><br><a name="consumer"></a><h2>  Consumer (Consumer) </h2><br>  A concierge is a class that processes one or more types of messages specified when declaring an IConsumer interface in inheritance, where T is the type of message processed by this constituent. <br><br>  Example of a concierge processing an ISendSms command and publishing an ISmsSent event: <br><br><div class="spoiler">  <b class="spoiler_title">SendSmsConsumer: command to send a message</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SendSmsConsumer</span></span> : <span class="hljs-title"><span class="hljs-title">IConsumer</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ISendSms</span></span>&lt;<span class="hljs-title"><span class="hljs-title">string</span></span>&gt;&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendSmsConsumer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IBusControl busControl</span></span></span><span class="hljs-function">)</span></span> { _busControl = busControl; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Consume</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ConsumeContext&lt;ISendSms&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;&gt; context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = context.Message; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[IConsumer&lt;ISendSms&gt;] Send sms command consumed"</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[IConsumer&lt;ISendSms&gt;] CommandId: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{message.CommandId}</span></span></span><span class="hljs-string">"</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[IConsumer&lt;ISendSms&gt;] Phone number: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{message.PhoneNumber}</span></span></span><span class="hljs-string">"</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[IConsumer&lt;ISendSms&gt;] Message: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{message.Message}</span></span></span><span class="hljs-string">"</span></span>); Console.Write(Environment.NewLine); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">" :   "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _busControl.SmsSent(DateTime.UtcNow); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IBus _busControl; }</code> </pre><br></div></div><br>  After we receive a command to send SMS messages and perform the required actions, we form and send an event that the SMS has been delivered. <br><br>  I submitted the code for sending messages to a separate Extension class above IBusControl, and the implementation of the messages themselves is also there: <br><br><div class="spoiler">  <b class="spoiler_title">Extension methods over IBus to encapsulate interconnect logic</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BusExtensions</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="bus"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="host"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="phoneNumber"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="message"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public static async Task SendSms( this IBus bus, Uri host, string phoneNumber, string message ) { var command = new SendSmsCommand { CommandId = Guid.NewGuid(), PhoneNumber = phoneNumber, Message = message }; await bus.SendCommand(host, command); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">       </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="bus"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="sentAtUtc"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public static async Task SmsSent( this IBus bus, DateTime sentAtUtc ) { var @event = new SmsSentEvent { EventId = Guid.NewGuid(), SentAtUtc = sentAtUtc }; await bus.PublishEvent(@event); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="bus"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="address"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="command"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> private static async Task SendCommand</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(this IBus bus, Uri address, T command) where T : class { var endpoint = await bus.GetSendEndpoint(address); await endpoint.Send(command); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="bus"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="message"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> private static async Task PublishEvent</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(this IBus bus, T message) where T : class { await bus.Publish(message); } } class SendSmsCommand : ISendSms</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string&gt;</span></span></span><span class="hljs-comment"> { public Guid CommandId { get; set; } public string PhoneNumber { get; set; } public string Message { get; set; } } class SmsSentEvent : ISmsSent { public Guid EventId { get; set; } public DateTime SentAtUtc { get; set; } }</span></span></code> </pre><br></div></div><br>  In my opinion, this solution quite successfully allows you to separate the code of business logic from the details of the implementation of intersystem (component) interaction and encapsulate them in one place. <br><br><a name="di"></a><h2>  DI Container Configuration </h2><br>  At the moment, MassTransit provides the ability to use the following <a href="http://docs.masstransit-project.com/en/latest/usage/containers/index.html">popular containers</a> : <br><br><ol><li>  Autofac; </li><li>  Ninject; </li><li>  StructureMap; </li><li>  Unity; </li><li>  Castle Windsor. </li></ol><br>  In the case of UnityContainer, you will need to install the nuget package MassTransit.Unity, after which the LoadFrom extension method will become available: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UnityExtensions</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadFrom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IReceiveEndpointConfigurator configurator, IUnityContainer container</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  The usage example is as follows: <br><br><div class="spoiler">  <b class="spoiler_title">IBusControl configuration using UnityContainer</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IBusControl </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetConfiguredFactory</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IUnityContainer container</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (container == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(container)); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> control = Bus.Factory.CreateUsingRabbitMq(cfg =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host = cfg.Host(AppSettings.Host, h =&gt; { }); <span class="hljs-comment"><span class="hljs-comment">// cfg.ReceiveEndpoint(host, e =&gt; e.LoadFrom(container)); cfg.ReceiveEndpoint(host, "play_with_masstransit_queue", e =&gt; e.LoadFrom(container)); }); control.ConnectConsumeObserver(new ConsumeObserver()); control.ConnectReceiveObserver(new ReceiveObserver()); control.ConnectConsumeMessageObserver(new ConsumeObserverSendSmsCommand()); control.ConnectSendObserver(new SendObserver()); control.ConnectPublishObserver(new PublishObserver()); return control; }</span></span></code> </pre><br></div></div><br>  As a life of a consumer in a container, the <a href="http://docs.masstransit-project.com/en/latest/usage/containers/unity.html">documentation</a> suggests using ContainerControlledLifetimeManager (). <br><br><a name="observer"></a><h2>  Observers </h2><br>  To monitor the processing of messages available connection observers (Observer).  For this, MassTransit provides the following set of interfaces for handlers: <br><br><ol><li>  IReceiveObserver - triggered immediately after receiving a message and creating a RecieveContext; </li><li>  IConsumeObserver - triggered after ConsumeContext is created; </li><li>  IConsumeMessageObserver &lt;T&gt; - to monitor messages of type T, in the methods of which the strictly typed message content will be available; </li><li>  ISendObserver - to monitor the commands sent; </li><li>  IPublishObserver - to monitor the events sent. </li></ol><br>  For each of them, the IBusControl interface provides its own connection method, the execution of which should be implemented immediately before IBusControl.Start (). <br><br>  As an example, here is the implementation of ConsumeObserver: <br><br><div class="spoiler">  <b class="spoiler_title">IConsumeObsever implementation</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ConsumeObserver</span></span> : <span class="hljs-title"><span class="hljs-title">IConsumeObserver</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task PreConsume&lt;T&gt;(ConsumeContext&lt;T&gt; context) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[ConsumeObserver] PreConsume </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{context.MessageId}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.CompletedTask; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task PostConsume&lt;T&gt;(ConsumeContext&lt;T&gt; context) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[ConsumeObserver] PostConsume </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{context.MessageId}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.CompletedTask; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task ConsumeFault&lt;T&gt;(ConsumeContext&lt;T&gt; context, Exception exception) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[ConsumeObserver] ConsumeFault </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{context.MessageId}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.CompletedTask; } }</code> </pre><br></div></div><br>  I will not give the code of each consumer, as  on the principle of operation and structure, they are similar.  The implementation of each of them can be viewed in the <a href="http://docs.masstransit-project.com/en/latest/usage/observers.html">documentation</a> or in the source code on <a href="https://github.com/FSou1/PlayWithMassTransit30/tree/master/PlayWithMassTransit30/Consumer">Github</a> . <br><br>  The final pipeline for receiving a command to send an SMS message, processing it and publishing an event of its successful execution is as follows: <br><br><img src="https://habrastorage.org/files/7e5/4e5/d95/7e54e5d95f434c93bb38012ad8a7a149.png"><br><br><a name="new-30"></a><h2>  New to MassTransit 3.0 </h2><br>  With the changes that have touched the new version of the library, you can find in 2 review articles by the author of the library Chris Patterson in the pages of his blog: <a href="https://lostechies.com/chrispatterson/2015/02/24/masstransit-3-api-changes/">MassTransit 3 API Changes</a> and <a href="https://lostechies.com/chrispatterson/2015/06/16/masstransit-v3-update/">MassTransit v3 Update</a> . <br><br><a name="ps"></a><h2>  Conclusion </h2><br>  There should have been a comparison of the most popular message queue libraries, however, I decided to leave it for a separate article. <br><br>  Hopefully, I was able to make for you a superficial acquaintance with the MassTransit library, beyond which such interesting things as transactionality, persistence (integration with NHibernate, MondoDb, EntityFramework), message sending planner (integration with Quartz), state machine (Automatonymous and Saga), logging (Log4Net, NLog), multithreading and more. <br><br>  Sample source codes are available on <a href="https://github.com/FSou1/PlayWithMassTransit30">Github</a> . <br><br>  <b>Materials used:</b> <br><ol><li>  <a href="http://docs.masstransit-project.com/en/latest/overview/backstory.html">Documentation MassTransit</a> . </li></ol><a name="poll"></a></div><p>Source: <a href="https://habr.com/ru/post/314080/">https://habr.com/ru/post/314080/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314068/index.html">ASO optimization. Compiling a semantic core for app stores</a></li>
<li><a href="../314072/index.html">Simple and convenient notifications</a></li>
<li><a href="../314074/index.html">3CX Phone System V15 SP3 released and integrated with Insightly CRM</a></li>
<li><a href="../314076/index.html">Checking an open source partner</a></li>
<li><a href="../314078/index.html">How Windows NT Became the ‚ÄúKiller‚Äù of Novell NetWare OS</a></li>
<li><a href="../314082/index.html">Why once again fails the introduction of CRM</a></li>
<li><a href="../314084/index.html">Linux kernel development held by email</a></li>
<li><a href="../314086/index.html">Create interactive charts with R and Highcharts</a></li>
<li><a href="../314088/index.html">mgr-forms-react: Simple component for simple forms</a></li>
<li><a href="../314094/index.html">Paul Graham pushes the government: 95% of the world's excellent programmers are out of work, let them in</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>