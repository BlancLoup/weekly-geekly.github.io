<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Application Verifier for a Programmer: Testing Windows Applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Perhaps in your project and do not write try { /* code */ } catch (...) { } in order to avoid exceptions when working with memory, they know how to cl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Application Verifier for a Programmer: Testing Windows Applications</h1><div class="post__text post__text-html js-mediator-article"> Perhaps in your project and do not write <code><font color="black"><font color="#0000ff">try</font> { <font color="#008000">/* code */</font> } <font color="#0000ff">catch</font> (...) { }</font></code> in order to avoid exceptions when working with memory, they know how to close handles and know about the virtualization of Windows Vista, and programs never fall on incomprehensible and rarely repeated reasons. <br><br>  Then you are lucky, you can proceed to the next topic. <br><a name="habracut"></a><br>  But sometimes it seems that strange things happen.  The program "falls" out of the blue, the memory is leaking somewhere, and once again they called you with a complaint about the strange behavior of the program running on the 24/7 server, but you of course "wrapped" their problem, making sure that it was hardware dependent and alright  Still, the development of programs for Windows is often a tricky business, and no one is immune from errors due to carelessness or because of ignorance of architecture.  I will not learn how to prevent these errors - I do not know.  But here is one tool for effective debugging I can advise. <br><br>  It's about Microsoft Application Verifier.  But this is not a debugger.  On the contrary, without a debugger, by itself, the thing is relatively useless.  But in conjunction with it allows you to detect a number of important platform-dependent problems.  In addition, it will not be possible to obtain a ‚ÄúCompatible with windows 7‚Äù certificate without testing using AppVerifier (for Vista Certified itself, it is not the same, but apparently this is not accepted).  And this certificate is for the user some guarantee that the program that received it may not do better, but <i>at least it will not harm</i> .  Okay, the "water" is over, let's get down to business. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Mode of application </h4><br>  Download and install AppVerifier for Hubman, I'm sure not difficult.  Let's run (from under the real-administrator, under Vista + it won't work differently) its graphical shell: <br><br><img src="http://img138.imageshack.us/img138/2936/appverifiermain.png"><br><br>  On the left is a list of applications for testing;  on the right there is a list of sections to check for the selected application.  The MSDN claims that AppVerifier is designed for testing programs in C ++, but generally applicable to any native code. <br><br>  The graphical shell does not produce any tests, only allows you to select the desired items.  The checks themselves are implemented thanks to the so-called "layers", dynamically connected libraries <code>vfbasics, vfcompat, vfLuaPriv, vfprint</code> (you can admire them in the <code>system32</code> ).  When you run the application under test, they connect to it and intercept the call to system functions such as <code>HeapAlloc, GetTickCount, CloseHandle</code> and many others.  The interceptor performs a number of additional checks, then calls the original function, and therefore, <i>with the exception of a few cases considered further</i> , this will not affect the operation of the application under test.  Is that some loss of performance will be noticeable.  Subjectively, in the worst case, the program will ‚Äúslow down‚Äù five times, and whether you need any specific numbers or not - I will leave it to your discretion. <br><br>  There is an important <i>feature here</i> : in spite of the fact that when we add, we select the file of the application under test, the checks are tied only to its <i>name without a path</i> .  On the one hand, you do not have to worry in which configuration (and in which folder) to build the project (usually the folders for Debug and Release are different), but on the other, you can forget about the installed checks, and launching the program from the desktop, wonder if it is ‚Äú does not work". <br><br>  We will talk about the meaning of the test points a little later, but now we will add, for example, notepad.exe and install all the jackdaws.  Run the notebook, add a couple of lines, try to save.  Oh, bad luck: <br><br><img src="http://img27.imageshack.us/img27/173/notepadoutofmemory.png"><br><br>  Not the only outcome of the situation, perhaps you will receive another warning window, or even do without it.  What happened?  Turn again to the graphical add-in AppVerifier.  This time we will select the Logs item from the main menu, we will see a list of log files associated with the applications under test.  According to the launch log. <br><br><img src="http://img705.imageshack.us/img705/4386/appverifierlogs.png"><br><br>  Physically, these log files are located in the <code>AppVerifierLogs</code> folder in the root of the user profile.  It will be difficult to read them with bare hands (binary format), so poking the ‚ÄúView‚Äù button for the corresponding log.  It will dump it in xml and open the default viewer for xml: <br><br><img src="http://img716.imageshack.us/img716/795/appverifierxmllog.png"><br><br>  <font color="#aaaaaa"><i>For those who closely watched: the error shown in this screenshot does not correspond to the error message (which is the normal behavior of the program) from the previous screenshot, but happens a little later.</i></font> <br><br>  Here and a brief description of the problem, and trace.  And from me a hint how to look for errors, not warnings.  By the way, if errors are present, the program does not receive certification for compatibility with Vista / Win7.  <i>Wait, but this is a notebook ?!</i>  <i>Well, yes, just shhh.</i> <br><br><h4>  Patient treatment </h4><br>  Now run the debugger.  Let it be a debugger built into the studio, or free WinDbg from the Debugging Tools for Windows (it‚Äôs certainly more sophisticated, but now it doesn‚Äôt matter). <br><br>  And here is our patient: <br><blockquote> <code><font color="black"><font color="#0000ff">int</font> _tmain( <font color="#0000ff">int</font> argc, _TCHAR* argv[]) <br> { <br> <font color="#0000ff">int</font> *p = <font color="#0000ff">new</font> <font color="#0000ff">int</font> (); <br> <font color="#0000ff">delete</font> p; <br> *p = 0; <font color="#008000">// p = 0 will be OK, but *p = 0 is error!</font> <br> }</font></code> </blockquote> <br>  The potential danger of this fragment is easy to assess if the lines with <code>delete</code> and overwriting memory were stretched over time.  But neither in the debug, nor in the release assembly such a problem is not detected (Visual Studio, the default configuration). <br><br>  Now add a program to test the Basics group in the Application Verifier.  And run it from under the debugger (from the F5 studio, for example).  AppVerifier spoke to us in the voice of the studio: <br><br><img src="http://img708.imageshack.us/img708/3083/appverifierdetectederro.png"><br><br>  And in Debug Output the corresponding <a href="http://msdn.microsoft.com/en-us/library/ms680657(VS.85).aspx">structural exception is</a> shown: <br><blockquote> <code>======================================= <br> VERIFIER STOP 00000013: pid 0xB54: First chance access violation for current stack trace. <br> <br> 02B59FF8 : Invalid address causing the exception. <br> 0082142F : Code address executing the invalid access. <br> 0013F670 : Exception record. <br> 0013F68C : Context record. <br> <br> ======================================= <br></code> </blockquote><br>  It says that with the exception of (00000013), with which memory address (02B59FF8) and at what address of the code (0082142F) occurred.  To the lucky ones who downloaded the <a href="http://www.microsoft.com/whdc/DevTools/Debugging/symbolpkg.mspx">Windows Debug Symbols, they</a> will show the <i>place in the source code</i> where the problem occurred and Stack Trace, which led to the exception. <br><br>  Well, we found this problem, which means we fixed it.  For other classes of errors, the algorithm is preserved, but the correction procedure may not be so trivial. <br><br><h4>  Detectable problems </h4><br>  Let's now figure out what problems will allow us to reveal AppVerifier.  All testing options are divided into groups.  Excluding the group ‚ÄúLow Resource Simulation‚Äù and the tests ‚ÄúTimeRollOver‚Äù and ‚ÄúHighVersionLie‚Äù checks do not change the behavior of the application (if no errors are detected). <br><br><h5>  1. Distorting checks </h5><br><h6>  1.1.  Low Resource Simulation </h6><br>  Here it is the reason for the fall of the notebook.  Tests of this group allow you to simulate the behavior of the system when there is a shortage of resources.  An application can easily be refused (by a random number generator) in allocating memory, creating a file, Event, windows, or writing to the registry.  Usually there is some ‚Äúquiet‚Äù time around 2-5 seconds, when the application is allowed to use the resources at full strength;  This is done so that the application can start at all (it was invented not so long ago, it was sadder before).  The normal behavior of the program is stability;  showing warning dialogs, but not ‚Äúcrashes‚Äù.  So in the code you need to provide for these situations. <br><br><h6>  1.2.  TimeRollOver in the Misc group </h6><br>  Consider the following sample code that executes an <code>action</code> several times, but no more than one second: <br><blockquote> <code><font color="black">DWORD time_end = GetTickCount() + 1000; <font color="#008000">// 1s timelimit</font> <br> <font color="#0000ff">do</font> { action(); } <font color="#0000ff">while</font> (GetTickCount() &lt; time_end);</font></code> </blockquote> <br>  The trick is visible to the naked eye;  if <code>time_end</code> very close to <code>DWORD_MAX</code> , but less than <code>DWORD_MAX-1000</code> , and <code>action()</code> sometimes takes more than a second, then the cycle will work a little longer than we would like.  Namely, 50 days (DWORD_MAX / (1000 * 60 * 24)). <br><br>  And this is not the only case that you say about the next fragment? <br><blockquote> <code><font color="black"><font color="#0000ff">char</font> buf[8]; <br> sprintf(buf, <font color="#A31515">"%i"</font> , GetTickCount());</font></code> </blockquote> <br>  To diagnose such problems, checking TimeRollOver ‚Äúruns‚Äù the value of the GetTickCount () function faster.  A full cycle before resetting the value takes 5 minutes. <br><br><h6>  1.3.  HighVersionLie in the Compatibility group </h6><br>  If suddenly you use the <code>GetVersionEx</code> function, then this test will help you to find the code branches with incorrect verification of a valid OS version. <br><br><blockquote> <code><font color="black">OSVERSIONINFO osvi; <br> ZeroMemory(&amp;osvi, <font color="#0000ff">sizeof</font> (OSVERSIONINFO)); <br> osvi.dwOSVersionInfoSize = <font color="#0000ff">sizeof</font> (OSVERSIONINFO); <br> GetVersionEx(&amp;osvi); <br> <br> BOOL bIsWindowsXP_or_Later = (osvi.dwMajorVersion &gt;= 5) &amp;&amp; (osvi.dwMinorVersion &gt;= 1); <br> <font color="#0000ff">if</font> (!bIsWindowsXP_or_Later) <br> printf( <font color="#A31515">"Windows XP or later required.\n"</font> ); <br></font> <br></code> </blockquote><br>  In this fragment, a clear error is made;  in order to cut off Windows 2000 (5.0), an additional check is introduced on the minor version of XP (5.1), but the code also discards Windows Vista (6.0).  On Windows 7 (6.1) will work.  Is this really the reason for the poor compatibility with Windows Vista?  <i>Microsoft claims that 70% of incompatible programs with Vista do not work, including because of this problem</i> . <br><br>  But diagnosing such a situation on a developer's computer is difficult - he has one, fixed OS version.  You can use a virtual machine with a different OS version, or you can just poke the HighVersionLie checkbox.  Then the value of <code>GetVersionEx</code> will be modified (usually by the rule <code>dwMajorVersion += 3; dwMinorVersion = 0</code> ). <br><br><h5>  2. Non-modifying checks </h5><br><h6>  2.1.  Memory in the Basics group </h6><br>  Validation of calls to <code>HeapAlloc, GlobalAlloc</code> and other Windows Heap Manager APIs.  It does not monitor memory leaks, but it can be solved in <a href="http://habrahabr.ru/blogs/cpp/82514/">other ways</a> . <br><br><h6>  2.2.  TLS in the Basics group </h6><br>  Monitors the correctness of calls to the Local Storage API. <br><br><h6>  2.3.  Exceptions in the Basics group </h6><br>  Monitors the appropriateness of interception of exceptions, in particular, attempts to ‚Äúsilence‚Äù exceptions Access Violation, ‚Äúunmask‚Äù exceptions in plugs like <code><font color="black"><font color="#0000ff">try</font> { } <font color="#0000ff">catch</font> (...) { }</font></code> . <br><br><h6>  2.4.  Handles in the Basics group </h6><br>  Monitors the admissibility of operations on handles, the correctness of handles and their lifetime.  <a href="http://blogs.msdn.com/mattn/archive/2009/09/08/tracking-handle-misuse-using-application-verifier-and-windbg.aspx">A little more in English</a> . <br><br><h6>  2.5.  Locks in the Basics group </h6><br>  Checks the correctness of the use of critical sections, prevents the critical section from being dumped from another stream relative to the installation of the critical section. <br><br><h6>  2.6.  DirtyStacks in the Misc group </h6><br>  Periodically fills the unused part of the stack with the 0xCD pattern, which allows detecting uninitialized variables or function parameters. <br><br><h6>  2.7.  DangerousAPIs in the Misc group </h6><br>  Notifies of the use and undesirable potentially dangerous API functions like <code>TerminateThread</code> . <br><br><h6>  2.8.  Luapriv </h6><br>  Limited-user-account privileges test.  Checks if a program needs administrative privileges, does not perform a program of actions that are allowed only for a real administrator. <br><br>  It consists of two parts: predictive (lists all the actions of the program that only the administrator can perform) and diagnostic (refuses the program in administrative actions with the error <code>ACCESS_DENIED</code> ).  Thus, it is not necessary for the programmer to test the program by logging in separately to the guest.  It also checks a number of features related to virtualization under Windows Vista and later. <br><br><h4>  Conclusion </h4><br>  AppVerifier is an interesting tool that allows you to identify and solve a number of "floating" and "hidden" (and sometimes specially hidden) problems.  To use it as a whole is not difficult, with certain skills it is convenient.  And if you want to get a certificate "Windows compatible", then acquaintance with him can not be avoided.  I personally have already helped me on two projects, I hope it will be useful for you too. <br><br>  <font color="gray">* All source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="gray">Source Code Highlighter</font></a> .</font> </div><p>Source: <a href="https://habr.com/ru/post/82878/">https://habr.com/ru/post/82878/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../82866/index.html">Home not only media center on Zotac IONITX-AE</a></li>
<li><a href="../82868/index.html">Two news about GLONASS: one is good, the other is bad</a></li>
<li><a href="../82872/index.html">Dell Latitude 13 - thin business laptop with a 13-inch display</a></li>
<li><a href="../82875/index.html">GreaseMonkey native support in Chrome 4</a></li>
<li><a href="../82877/index.html">Clock on 30 LEDs</a></li>
<li><a href="../82880/index.html">Amateurish robbery-3 or the same eggs, only in profile</a></li>
<li><a href="../82882/index.html">Junimotion - do it yourself robot</a></li>
<li><a href="../82883/index.html">Where does the rust on the chokes of ASUS motherboards come from?</a></li>
<li><a href="../82884/index.html">Where does the creative come from?</a></li>
<li><a href="../82885/index.html">One firewall for IPv4 and IPv6 (iptables and ip6tables)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>