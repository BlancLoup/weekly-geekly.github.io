<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Application server on pl / pgsql</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Artem Makarov , head of IT department at Project 111 , at one of the past PG Day, told how a business can decide on a solution such as building its ow...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Application server on pl / pgsql</h1><div class="post__text post__text-html js-mediator-article"> <i><b>Artem Makarov</b> , head of IT department at <b>Project 111</b> , at one of the past <a href="http://pgday.ru/ru/2017%3Futm_source%3Dhabr%26utm_medium%3Dpost%26utm_campaign%3Dmakarov">PG Day,</a> told how a business can decide on a solution such as building <b>its own ERP system</b> on Postgres and an application server based on stored procedures.</i>  <i>Which of this followed the bad, good sides.</i>  <i>It should be noted that Artem was never a real programmer, although he wrote quite a lot of code.</i>  <i>Rather, he can be called the anti-manager and evangelist, and lobbyist for the business of IT solutions.</i>  <i>Therefore, in his report the view is not only from the technical specialist, but also from the manager.</i> <a name="habracut"></a><br><br>  <b>Who are we?</b> <br><br>  In order to explain our choice, it is worth explaining the specifics of our company.  If you open <a href="https://gifts.ru/">the Project 111 site</a> (our programmers are already looking at whether the slashdot effect will be there), we will be very similar to an e-commerce online store, but we are not talking about an online store, we are B2B.  That is, we have regular customers, there are a lot of them, marketing is going crazy, inventing new schemes, discounts, promotions and so on, so we have a rather complicated sales process that is long and takes almost a week.  Our clients, partners on the site are <b>full-fledged employees in the ERP system</b> , that is, they use very many functions of the sales department, only they cannot pay for themselves.  Therefore, our system is rather heavy, including at the front end. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We are a medium sized company.  The numbers are not very big: we have <b>2300</b> users logged into the site (our partners with their discounts and conditions), but these are ‚Äúheavy users‚Äù, that is, they create the same burden as an employee in a warehouse or in finance.  We have long made a bet on the Internet, <b>97-98% of orders are</b> placed <b>online</b> , 60% of orders are not in the hands of a sales employee, they automatically go to the warehouse. <br><br>  <b>How did you get the idea to build the systems yourself?</b> <br><br>  The beginning of the 2000s, when we were engaged in this, the word ‚Äúhighload‚Äù did not sound, the ajax did not seem to even exist.  In general, there was some, Internet Explorer 5.5.  The management of the company had a strict feeling that the future was over the Internet, that <b>taking orders over the phone was bad</b> , that either we would distribute our application among partners, or maybe we would have a website (and we had a website).  Our site (domain) is registered like in 1998, 5 years later than that of Dell.  And we looked around. <br><br>  In the early 2000s, a couple of new columns with fresh burial ground appeared at the ERP system cemetery each year.  And the choice around "what to buy," "what to build future systems for" was very difficult.  That is, we were afraid of vendor locking, and, on the other hand, we did not understand the roadmap of these ERP systems.  In addition, ERP-systems have fairly tight licensing restrictions, they still exist.  If you think: why not take 1C, screw Bitrix to it and trade with might and main?  <b>1C still has a clearly structured limitation, which does not allow to proxy its Web API.</b>  There is some kind of XML API, that is, you can pull the 1C method.  But every connection that can theoretically be used by this method must be licensed.  That is, if you expose a real-time service working with 1C to the site, then you should buy all the licenses.  You have 10 thousand users, then you have to buy 10 thousand licenses, if they still exist at all. <br><br>  <b>There is a different approach.</b>  This is a <b>stand-alone ERP system</b> and a stand-alone website, there is some kind of exchange between them.  But I said that we have a difficult business sales process: to calculate the cost of the order, we will probably ask a dozen and a half or two tables.  These are volume discounts, historical discounts and discount lists, a contract of a specific client, a clause of a contract, a currency, some European price list has been picked up.  To write this algorithm is in some way a pain.  And if you have to write this algorithm in your ERP system?  One person wrote.  Then go sometime to a PHP programmer and say, here are 25 tables for you, just replicated in XML, and you also repeat this algorithm.  Of course, he repeats, but it turns out that the first algorithm may have errors, and the second is not the case.  So you do the same job twice. <br><br>  Therefore, we decided to build a <b>site-centric ERP</b> , that is, one core that owns all the data, all the business logic, and all that is around is just interfaces.  They already have some intelligence, but the business units are practically free.  Two hours ago we discussed CMS systems and Bitrixes, as we observe our respected partners and market competitors, recently one of the companies switched to the next version of 1C.  They reported that ‚Äúthe largest partner of 1C is some kind of gold, our team of programmers worked for a year and implemented it,‚Äù we see that they have lost all their functions for half a year.  Why?  Because they threw out the old site and they have to make a new one.  Therefore, reserves are made by telephone.  Well, the last factor, in addition to site-centricity, the fear of ‚Äúboxes‚Äù is what the picture depicts.  We had the belief that we could do it. <br><br><img src="https://habrastorage.org/files/827/7c0/9aa/8277c09aa7dd428ea4ebcc49f6a3e44e.jpg"><br><br>  In general, it is considered that <b>doing business logic on stored procedures is, as it were, not good</b> .  I was even shy.  We have been doing this for many years, but Roman practically made me say, provoked that later at some stage it turned out that in fact there were a lot of people like us.  I'm not the only one. <br><br>  <b>What are the myths?</b> <br><br>  <b>Lost portability</b> between different databases.  Yes, there is.  Difficult to maintain.  Yes, the stored procedures in Eclipse are somehow not very, not there.  How to deploy?  Fair  It is difficult to develop in a team.  Indeed, you compiled your pl / sql-procedure, figak-figak, and someone else compiled it.  It seems reasonable.  And finally, if you start writing the stored procedure now, you have no sharding, how will you make distributed configurations using some kind of synthetic key?  It also seems reasonable. <br><br>  But from a technical point of view it is difficult to argue.  Let's answer some children's questions.  ‚ÄúPortability between databases, and who needs this at all?‚Äù Imagine such a dialogue.  Client: ‚ÄúTell me, can I transfer your application to another database?‚Äù But it‚Äôs not a question, though every day Microsoft - Oracle, Microsoft - Oracle.  <b>And who needs it?</b> <br><br><img src="https://habrastorage.org/files/703/275/24d/70327524d1b94ec49b74163cea2a8703.jpg"><br><br>  <b>Portability</b> between databases is a positive function for the seller, who sells the product.  But when you received this product and use it, it is not so important anymore. <br><br>  Next point: difficult to maintain.  Yes, it is difficult to maintain a boxed product, if you have 100 installations throughout the country, each one has a separate stored procedure.  Suddenly, the client there handles his playful something compiles and immediately nervously, how to deploy, how to roll?  Somehow difficult. <br><br>  Again, if you are a consumer of this product, you yourself wrote and use it yourself, you do not have 10,000 installations, this is not your problem.  Is it difficult to keep the box in a big team?  We are a small business, we are not ‚ÄúHighLod‚Äù, not Yandex, not Google, we are an ordinary taxpayer.  At a time when Avito‚Äôs open spaces are plowing highload, I don‚Äôt know, Yandex, Mail.RU, we are a regular taxpayer and stand knee-deep in 1C.  We have no money for big teams, we have no money for programmers with such a square head.  We have a small team.  If there is time left and it will be interesting, I will tell you how we actually designed, implemented. <br><br>  But by the time of launch, support for legacy code, the old system, the very 1C and others, and 2.5 people were engaged in writing, updating the system, migration: 2 real programmers and me.  That is, it‚Äôs not about big teams. <br><br>  <b>What do we have left?</b> <br><br>  Myths <b>left</b> : <b>sharding, distributed configurations</b> .  It's very easy to argue against sharding: guys, have you read about Skype?  They have everything on stored procedures, <b>pgbouncer</b> , <b>pl / proxy,</b> and more.  If your database does not allow the application to climb directly into itself, it can only pull stored procedures, then what is inside - you deceive any application.  That is, to do sharding on stored procedures and so on - this is not what is possible, but necessary, if your requests are necessary.  We have <b>pl / proxy</b> , <b>dblink</b> , <b>foreign data wrapper</b> , which is not.  Are you sure you need to do sharding right away?  This was already mentioned on the reports yesterday.  In general, we now know that for medium-sized businesses, if you are not Mail.ru, not Yandex, then maybe this is not so and important. <br><br>  <b>Why PostgreSQL?</b> <br><br>  First of all, <b>mature pl / pgsql</b> .  He appeared in the 98th or even the 97th year.  Strictness, functionality and academic approach.  If you look at the Postgres documentation, it‚Äôs written like a good tutorial.  That is, when we take a sysadmin to work who needs to be able to read the documentation, I test it using FreeBSD manuals and documentation, that is, there is good English, everything is clear and in one place.  <b>Open source and free license</b> - there is nothing to say, various risks are reduced.  If we implemented the 1C seven in 2005, then we would have experienced a lot of pain and would have changed several information systems.  Changing the database has nothing to do with it. <br><br>  And somewhere from the 98th year we had such a funny saytik, in the 98th year it was launched and worked on PostgreSQL.  I was not there yet, I joined after a year and a half.  In my opinion it was release 6.4.  In addition, an understandable development plan.  We still had only plans for a public website, not closed to partners, but for everyone, when anyone can come, register.  We already knew that a half or two years and will be T-Search.  After all, developers open to interaction, a good community, you can understand what will happen over time, and make realistic plans.  And they come true. <br><br><img src="https://habrastorage.org/files/c6c/0e3/5c1/c6c0e35c185d44298f6638459b84326b.jpg"><br><br>  <b>The bad</b> and <b>good sides of</b> stored procedures.  Imagine that you are not a giant IT company, you are a business that is not satisfied with a boxed system, you need your own application server.  If you go along the classical path, then something like that in Java can be written in C, but the programmer‚Äôs incentive must be very high.  And all these pains will rest on these programmers.  You need to think about the distribution of memory, about the leaks that will inevitably be, you need at least some kind of scripting language, because it is impossible for a working business that earns money, trades, or ‚Äúdeploy‚Äù three times a day.  Business must adapt on the go, you can not stop.  And scripting language allows you to change business rules on the go.  You also need some kind of profiling.  In general, not so easy.  So, posgres takes it all on himself. <br><br>  We do not think about memory leaks at all, we have never had any problems.  We have been online there for several months.  And if it hurts us a lot and we want to upgrade, we are updating, but we don‚Äôt stop the run-time at all.  <b>We have no memory leaks.</b>  These are things that are solved for us by very good programmers.  Us as an ordinary trading business is at hand.  Scripting language - pl / pgsql, take it and use it.  Verification of rights, etc., profiling - this will be later.  But also the problems are solved. <br><br>  That is, we get an application server for dummy, which <b>has no restrictions</b> , there is no ORM that binds your hands, that is, you can do anything and not experience some kind of architectural consequences.  In some limits.  Simple language, low threshold for entry.  Junior, who was not given a production, but showed how and what to write, if he has relational thinking, it is achieved, in my opinion, at the age a little earlier than object thinking, he is already able to produce normal code, which can already be put into production by looking.  I retire in 20 years in fact, and I still have the ability to understand the pl / pgsql code and write less myself, but I can optimize the code.  That is, this knowledge is stored for a long time. <br><br>  <b>Safety</b> is something we thought about at the beginning of the 2000s, it is very difficult to push SQL injection through the stored procedure, you really need to shoot yourself in the foot, you need to aim well.  Why was this important then?  Everyone wrote their CMS-systems, every second was full of holes.  It seems to me that in 2001-2002, with a bunch of CMS and 15-20% of sites, it was possible to dig some injection in 10 minutes. <br><br>  The next item in the slide is very controversial - it is <b>isolation from the interface</b> .  We have thrown out front-end applications several times, some internal development or a site that is inaccessible to the final customer, only for partners.  There was not much code there, it was quickly transferred to another technology and you didn‚Äôt lose business logic at all.  The isolation from the interface is somewhere good, somewhere is evil.  And when our business logic has nothing to do with representation, we can change the technology on the frontend. <br><br>  Let's go back to the beginning of the 2000s.  How many interface technologies have changed there?  You must program in Visual Basic, on the Internet Information server.  Someone sawed on pearl, PHP, Ruby, nowhere to go from all these words.  <b>Interface technologies change very quickly, and SQL is still alive.</b>  The very old function in our system was written in 1998, as a relic to it you approach.  True, we sawed it the other day, but this code can work.  That is, what we wrote 12 years ago will work on that same run-time, at least in this circle no one will look contemptuously: ‚Äúand he is in PHP‚Äù.  SQL is a normal language, although somewhere limited.  A long time life of business logic is useful. <br><br><img src="https://habrastorage.org/files/ed9/1a7/211/ed91a72114e64944a523da3cf6b9c2a6.jpg"><br><br>  <b>Bad sides</b> <br><br>  <b>Too good insulation</b> , yes.  In principle, if you have a good application server, it has business logic, acl's are closely related to interfaces.  We have two interfaces: an internal employee program and a website.  And both applications are very different.  Sharing this knowledge and skills was not as valuable as getting a long-lived application server. <br><br>  No well- <b>integrated development tools</b> - yes, that‚Äôs real.  If some connection with the version control system was integrated into <b>pgAdmin</b> , if the code there was slightly better highlighted, substituted ... Here we still have pain, I admit.  Some of us work in pgAdmin, some people like ems-sql for auto-substitution, but there is a lot of work to be done. <br><br>  Next moment.  I said that we do not solve problems with <b>caching</b> , we do not solve problems with <b>memory allocation</b> , but if you don‚Äôt have enough caching that the program gives you, you will have new <b>layers of abstraction</b> .  It's not very good.  If you have a programmer who wrote business logic cannot satisfy the front-end, then some middleware appears (which most likely a front-end programmer in some Java or C writes), which does this for himself.  In fact, this is a difficult problem.  Because <b>caching and cache invalidation is the hardest of two problems</b> , the most difficult in theory.  Everybody knows the second - give the correct names to the variables. <br><br>  Sometimes when writing stored procedures, it is difficult to stop in time.  In Java, our programmer caught me writing a stored procedure that created letters on pl / perl and mime and then sent them.  I won't do this anymore. <br><br><img src="https://habrastorage.org/files/607/b3d/1c6/607b3d1c6b7d4de1b4c06145e92798ee.jpg"><br><br>  <b>What's inside?</b> <br><br>  Now we have posgres 9.4.  Development started at 7.4.  Did anyone hold 7.4 in his hands?  Writing stored procedures?  Someone felt this pain.  For those who did not see, the body of the stored procedure was in single quotes.  And there is not exactly the syntax is not highlighted, everything was purulent brown.  But there were brave people who decided on this.  Our business logic is <b>3,000 stored procedures</b> , they are not very large, you can count them by code size.  Note that if at the beginning we wrote you a lot of code, now, over the last 5.5-6 years, not so much.  The code is quite plump, there are comments, function headers.  This is most likely not the code that Andrei talked about: which are hard for 80 lines per day for programmers.  <b>The bases are well normalized</b> , there are 700 tables, hundreds of them are analytics, which we will soon pull out.  We are probably growing a little faster, but the base is about that. <br><br>  <b>We love short transactions</b> .  Short transactions - this is a high speed, there is no ‚Äúoverhead‚Äù on swollen indices, waiting for locks.  If we can write a short business function, we make it short.  We love <b>‚Äúconstraints‚Äù</b> , <b>foreign keys,</b> and so on, because it eliminates a huge number of errors.  Last year, we ran into a ‚Äúviolation‚Äù violation in one function that worked for almost 6 years.  And there was a mistake in it that very rarely manifested itself.  It is difficult to give an example.  But if the storekeeper takes one box with his left hand, another box with the right hand, presses the barcode scanner with his nose and moves something else, only then this error occurred.  And she never arose!  We caught her because constraint worked.  In general, constraints are a blessing, it does not allow you to shoot yourself in the foot. <br><br>  We say that the tables are normalized, but we love <b>denormalization</b> .  <b>Denormalization</b> is mainly needed for the site.  We are stuffing a bunch of different data into a rather wide table, and on our site we have fast enough interfaces.  Easy to give, few ‚Äújoins‚Äù. <br><br>  <b>We hate ORM and ‚Äúcode generators"</b> . Our own ideology, ORM, contradicts, but I can show you, when we stepped on it, why it upset us. <br><br><img src="https://habrastorage.org/files/1b6/f63/55e/1b6f6355e83744a9affb9d02576f9611.jpg"><br><br>  <b>The frontend</b> is <b>tomcat</b> + <b>nginx</b> , it has several products running on it.  In addition to the site, there are also Intranet products (CMS and CRM are different), reporting (freestanding serv in Jasper).  There is an internal application that started on Borland C Builder, now it is Embercadero (almost does not develop, there are less and less of such interfaces).  All this works through <b>pgbouncer</b> , about which individual thankful words.  There is still a lot of all: analytics, seo, asterisk, which directs calls.  It is also integrated into our database and uses the same business logic. <br><br><img src="https://habrastorage.org/files/baa/f23/65c/baaf2365c3b9452585f5868f8fcbec53.jpg"><br><br>  Go ahead.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In fact, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">production is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> one </font><b><font style="vertical-align: inherit;">server</font></b><font style="vertical-align: inherit;"> , the second is a replica, which is for tests and some offload for analytics. </font><font style="vertical-align: inherit;">The servers are quite ordinary, but we did not save on hardware. </font><font style="vertical-align: inherit;">As you can see, they are not heavily loaded. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LA is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no higher than three, but it may be more serious now, in summer, in winter.</font></font> Why?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In a trading company, unlike the social network, there is a very small hot data set. Active products out of 100 thousand - twenty, out of 100 thousand customers - active pieces 10. In principle, despite the fact that the base is growing, the company's money grows, customers arrive, still this is not enough, it is well trampled down in memory. I can reveal the figures: the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gross margin</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (net profit of business before tax) 40 minutes per season allows you to buy such a server. And this, again, returning to the word about sharding. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Think, these figures say that if it is economical to write code, do not read the </font><b><font style="vertical-align: inherit;">‚ÄúSELECT *‚Äù</font></b><font style="vertical-align: inherit;"> server into the application</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from two tables and not joining them in Java cycles, then you can get by with a very modest iron. And this we still do not use a replica for offload. That is, reading requests from the site go to the combat cluster. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We do not use SSD</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . I have to admit, there was such a mistake: we have a network engineer who tests the servers very meticulously, and we know that the best way to test a raid is to assemble a RAID5. And we are now in ‚Äúproduction‚Äù in RAID5 by mistake, we accidentally noticed when our battery died.</font></font><br><br><img src="https://habrastorage.org/files/cc9/3a9/5b0/cc93a95b077649839ffd0978865615e5.jpg"><br><br>  Go ahead.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We ended up laughing, but here it will be somewhat more boring. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How does it work?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As we have said, no application directly enters the database with dirty hands, each application operates under its own role. All stored procedures are laid out in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">different</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ways. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What do we see here?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We have folder roles like </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web group</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">employer group</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which have almost no rights. And in these roles, folders are pushed into application roles. The application </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äúrole for the site‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (web) and any role </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äúemployer‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (for the ‚Äúemploorsky‚Äù application). Note the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">statement timeout of 10 thousand</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Why is this done? This means that if the site manages to pull such a request, which will not be fulfilled in 10 seconds, the request will be thrown out. In fact, the answer is simple. If you have something stuck somewhere, and users on the site begin to pull it, and the bases are not given away, then everything only gets worse. It is necessary to detach insolent. Note that the roll back transaction is still warmed up buffer cache. Even if she did not give anything to the user, she still put it in the buffer cache. When you have several people received an exception (10 thousand people, 2 of them received), they warmed the base of the cache, and the third request will come success. If you do not do this, then you will overflow with pool, </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Java will understand</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pgbouncer may not have enough sockets.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next we create the schemas and distribute the rights to the schema to each application. Here it is obvious that the customer can both include a web application (WebGroup) and an application from the internal group. If a person is able to do everything inside the office, then even if everything is on the site. And in the very last paragraph, we </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forbid applications to see the code of the procedures being entered</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the data schema. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In fact, this is already too much. If someone hacks your application, it will not see your secret tables. He will not be able to read the data anyway, and here he will not even see the name of the stored procedures. </font></font><br><br><img src="https://habrastorage.org/files/5ff/e33/c16/5ffe33c164f240408956dab8ffaf7912.jpg"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What are the functions?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The first and only function that does not have an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in_SessionID</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> input parameter </font><font style="vertical-align: inherit;">is authorization. Not individuals work with us, but partners, it is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">50</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a person is in the same company, so it‚Äôs more convenient for us as a domain registrar: a company login, one login and password. This function returns the session, and pay attention to the definition - it is a security definer, it has the right to pull 2 ‚Äã‚Äãgroups, an internal application and an external one. </font></font><br><br><img src="https://habrastorage.org/files/5c5/e16/d44/5c5e16d4430b428988f2d58a2c51c6a7.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All other functions have the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SessionID</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> input parameter </font><font style="vertical-align: inherit;">- this allows you to log in once, associate a session with a user, issue it in a browser cookie or into the application's memory, and pull all other functions. They always have the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Session</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> input parameter </font><font style="vertical-align: inherit;">and are manipulated inside to recover who causes them. That is, the function </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OrderCreate</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which is called from the site or from the internal application, it works from a single user. Inside it, we can determine who specifically of the subjects of the system is pulling it at the moment. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Functions that are on the site, additionally covered. It is clear that the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OrderCreate</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">should have the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Customer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> input parameter </font><font style="vertical-align: inherit;">, for which customer we set the order. Here we cover it. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CompanyID</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appears through the session, and one company cannot create an order for another. </font></font><br><br><img src="https://habrastorage.org/files/7b2/c29/425/7b2c294258bf48e3a5ef564096076124.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next you need to deal with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Here I will quickly slip through, because this is a deep area and will have to be cut a lot. Each domain table (customers, campaigns, orders, contracts, price items) has a projection on the table of objects. That is, the customers table entry has the object_id table entry and object_type = 84, as I recall.</font></font> <b>What does this give?</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On this unified representation of objects to the subject area, you can attach properties, life cycles, some restrictions, locks and, on top of this, construct a rights check. </font></font><br><br><img src="https://habrastorage.org/files/e58/8a0/e4c/e588a0e4c8894982a7124bbd4eb2c822.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, within each function of the domain that distributes orders, ships the machines, there is a function that checks rights. We pull this function by passing the object ID, the object type and the ‚Äúaction‚Äù type to it. She inside herself either says OK, or throws an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exception</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If we throw an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exception</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it is very easy to catch it in the application. Any connector (JDBC, any custom) these </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exception</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">good catches and transfers to the client. The user receives an error and can analyze it. If we do not need to diagnose an error on the client, but simply filter something, then we pass such a parameter. It seems quite cumbersome, but in fact the verification of rights in this way is more an imperceptible part of the programmer‚Äôs work, does not interfere with creating business logic, only creates unification. </font></font><br><br><img src="https://habrastorage.org/files/16d/6bb/e98/16d6bbe98b024cf8bab9c92ad6610ed6.jpg"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was everything without problems?</font></font></b> <br><br>  Not.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a sad picture that describes the moment when we started. Look at the bottom of the picture - autumn 2009. What we got. We had a website, it was about 200 people, 300, they grew. In the pool, 5-6 connections were issued simultaneously in one step, and another 60-70 connections were occupied by the internal application. We decided that since within the company 60 users work, then why are there any pools, they worked directly. Suddenly we felt pain. A server with 16 cores, that is, 4 sockets with 4 cores for 2009 was pretty cool, and when we saw </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LA 60</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , on 16 cores ... </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What caused the reason?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This problem no longer exists, but I have to say it to you, this is such as auto-training. And secondly, to caution how to: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">always listen to the elders</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We thought we didn't need pgbouncer. In principle, it is not needed if we did everything normally. But in each session that we opened on the next page, we have initialized stored procedures of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ON COMMIT DELETE ROWS type</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In the pre-9.1 or 9.2 version there was a feature that we later learned about. It turns out that at the beginning of each transaction, on each temporary label with type ON COMMIT DELETE ROWS, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRUNCATE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was fed into each connection </font><font style="vertical-align: inherit;">and then, at the end of the transaction, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRUNCATE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was also applied </font><font style="vertical-align: inherit;">. That is, if you have 100 connections, each with 30 temporary tables of type ON COMMIT DELETE ROWS, then you have 3000 temporary tables. And even if none of these tables were involved in a transaction, this </font><b><font style="vertical-align: inherit;">TRUNCATE</font></b><font style="vertical-align: inherit;"> is still</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">served twice. You understand what was happening. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How did it help us that Postgres is open source?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We have a "sishny" programmer, who climbed over after some time of pain and saw where transactions open and close approximately. Put the "notes", and saw that this </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">truncate</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> occurs. I climbed onto the website of the website and wrote to the newsletter in broken English that with each transaction you do this and that. I was shocked when, in response, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tom Lane</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> said, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúYes, I guess. It is hard to be surprised that we clean the tables temporary, but the fact that we, including those that do not work, is not very good. ‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And then </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bruce Momzhan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pulled </font><b><font style="vertical-align: inherit;">himself up</font></b><font style="vertical-align: inherit;"> , whom I did not expect at all, if he is here, then thank him very much. And he wrote:</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Guys, do not worry, I will include it in my personal todo-list and try to have it pierced in the official todo-list."</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And so it happened. We immediately found a solution. First, I compiled pgbouncer, it took 7 minutes there. 7 minutes after the illumination, we saw this. Ed .: See the right part of the graph on the slide]. That is, the load fell, it just became super-comfortable, the connections stopped hanging. There were some problems during the start of transactions, there was a slight delay of 15 ms, but you could live with that. In my opinion, until the end of the year we lived with this scheme, having increased the number of clients for this season three times. Thanks to Bruce and thanks to the community. </font></font><br><br><img src="https://habrastorage.org/files/b32/21f/f3a/b3221ff3af314eb68f3c41156ac56e38.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are problems. There is such a line, in which there is an error and even a hint in which it is. There is a lack of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pl / pgsql</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a code of business logic, although the base is strict and there are a lot of opportunities to protect yourself, the code is not verified very well. Whoever did not notice, there is a </font><font style="vertical-align: inherit;">comma </font><font style="vertical-align: inherit;">between the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">val2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">val3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Guess what result will </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">produce a notice</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , if we in all vals (i1, i2, i3, i4) transfer edinichki. In the ‚Äúnotice‚Äù will be 4 numbers. What kind? The first and second - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">edinichki</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the third and fourth? This will be </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . And how to live with it? Seeing the space, the poster simply ignores everything else. I also wrote about this in the newsletter, I do not remember who answered, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gregg Smith</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it seems: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"this is legacy, because pl / pgsql is a legacy of SQL code."</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The syntax that we can afford in SQL is translated here. This is yes, this is a problem, but this is one of the very few problems we have encountered. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next issue is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This is a story about the most serious accident that we had. If you put </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DROP CASCADE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on a table, then you will lose all the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exception</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">notice</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , all objects that will be deleted in cascade will be shown. If you have 5-6 tables linked by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foreign key</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you say </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">truncate</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">according to the table, then you will be answered that the second table will be cleared. He will not say that 4 of them will be cleared. And we ran into it. I was really told in the documentation that this was necessary, but such things happen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last problem is not a problem, it is rather a surprise. We decided to experiment with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pl / proxy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read-only off-load requests to the replica.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It turned out that </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pl / proxy </font></font></b> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not support ref-cursors</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and we very much love ref-cursors. Because any connector to the database supports cursors, they are easy to modify, they, unlike the record, can be transferred between functions. Everything is just built on cursors. If there was </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSON</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , we would build on </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSON</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We are now considering whether to transfer the front-end of the site to JSON. Then we will be able to unload through pl / proxy and achieve a refutation of the very same myth that supposedly cannot be, having built everything on stored procedures, to ‚Äú </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù. You can, if you do not use the cursor. </font></font><br><br><img src="https://habrastorage.org/files/b5f/3b9/d28/b5f3b9d28fb54943945995dfcf0e6bcd.jpg"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How is our life going?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I will talk about programming a little, the programmer is bad, but I know about </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">optimization</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . When all business logic is in stored procedures, then you always know who is at fault. Because whoever gets into the database, he will climb through the stored procedure, and thanks to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_user_functions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , we know all about it. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What are we doing?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In this pg_stat_user_functions </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">view</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there is a scheme, name of the tablet, the total number of calls, the total execution time and the own execution time of the function with sub-millisecond resolution, which is enough for all cases. </font></font><br><br><img src="https://habrastorage.org/files/1ad/b92/810/1adb92810b1a4c68b166a76bc46ec777.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Twice a day, at 8 in the morning and at 8 in the evening, since we mostly have Moscow and St. Petersburg clients, we insert our own nameplate of the result of this view. We keep the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">snapshot</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the morning and in the evening. </font></font><br><br><img src="https://habrastorage.org/files/549/09c/af5/54909caf55f54842a55261dffedb1a19.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After that we update it. We calculate the delta between the number of calls, the delta between total time and the delta between self time. What does this give us?</font></font><br><br><img src="https://habrastorage.org/files/78c/10e/14f/78c10e14fa6443eeb669c6af06eb3a44.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As soon as something slows down, we just check. Over the past week, if we compare this week with the past, what function has become more frequent or more expensive? And we immediately find it. Moreover, there is a constant request that I have in the console, which shows the functions that have deteriorated. Where do these deteriorations come from? There are several reasons. First, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">planner</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> could </font><b><font style="vertical-align: inherit;">skew</font></b><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">somewhere forgot the index</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updated new versions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and some algorithm used to work this way, and some sort of commercial. This is very quickly detected. That is, we do not need to chase with lanterns for an unknown request, which is not known from which frontend came, who called it. We immediately see the problem. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_function</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> does not solve all problems.</font></font> Why?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, the cursors. If there is a function that returns a cursor, it can fetch a minute, and the function worked for one millisecond. That is, you will not see slow cursors in the top, but we have many cursors. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The function has branching. For example, there is a function that launches an order. It can be started by human hands, there are a lot of rights checks. Either money came, they sent an event and we let the order go to work. That is, the branching of functions is when the same function in different conditions can be called in a very different time. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">point loads</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . There are such business functions that are very important. For example, a person works there 15 minutes a day, but a lot depends on it. And slowly from a person the load grows, but he does not notice. This also comes to light. We go deeper.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_statements</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Also store data for the work shift at the beginning and end, and analyze all the same. But it gives a lot more. </font></font><br><br><img src="https://habrastorage.org/files/4f8/174/9e1/4f81749e18824517a7c68ce0546fcf4c.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is what our query to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_statements</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> looks like </font><font style="vertical-align: inherit;">. What is great is that the atomic request of the stored procedure is pg_stat_statements. There is an expression there: we retrieved the data there, a semicolon, a line break, a comment, updated the data. Here are two of these fragments will fall into pg_stat_statements, including comments, and " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">custom formatting</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", which is very useful.</font></font><br><br><img src="https://habrastorage.org/files/e90/94c/787/e9094c78791b43f3a4f81dea4b63fe36.jpg"><br><br>  Here's what it looks like.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the top there is a general list, and below is a fragment of interest. The function that is called and returns a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ref-cursor</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , inside which there is one atomic expression, falls into this ‚Äúview‚Äù three times. The function itself that works instantly and is somewhere in the basement, 2 ms, falls. Atomic query of SELECT categories is hit and the cursor fetch is hit. They are easy to identify. That is, if you have a problem in the cursors, you do not know what function it is connected with, you can automatically analyze the atomic queries and cursors that coincide roughly in time, coinciding exactly in the number of calls, and you will compare them. Useful reception.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the second line we fetch the named cursor. If your frontend is able to call the cursor by the name of this procedure when you call a stored procedure, then you will see it directly in the logs, anywhere. Also a useful trick. </font></font><br><br><img src="https://habrastorage.org/files/319/810/1fd/3198101fd5da4aa9b8338f54127f6842.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thanks to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_statements</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it‚Äôs easy to find potentially bad places. What kind? Firstly, an update is always expensive, and secondly, as I said, even your comments get into pg_stat_statements. Therefore, if someone over the request wrote ‚Äú </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TODO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù or ‚Äúthere is something out of order here‚Äù, then you go to pg_stat_statements and first of all you are looking for whether there are any queries with some of your dubious comments. And you quickly find them. It's very fast. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">little about the pain</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Who managed to look at the second or third slide, our front-end site is based on </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liferay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . We cut out almost everything from there, but something remained. And something is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hibernate</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> which needs to be emulated that it writes to the table. Yes, this Liferay is writing a users tablet. In fact, he caches, that is, he caches a large part, but the little that we got, it got here. If we cut out Liferay with hibernate completely, then, actually, 20 times more will go somewhere into non-existence. I wanted to show the request Hibernate, but I realized that it does not fit. It's hard to deal with. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But once we had a problem with a supplier of popular business software. We have a system built on it, which we do not serve, the contractor has implemented. She issued an exception that</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS SQL server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cannot execute a query larger than 64 kilobytes. We are told: you need to buy the enterprise version of 64-bit. In general, he says, the limitation of MS SQL Server, it is impossible to execute 65536 bytes request, this is not supported by any version. Due to the fact that there is a sales-manager, helpdesk-manager, junior, who wrote business logic, and somewhere else 10 meters away there is a person who wrote the 1C code generator, let's call them directly, do not reach it, believe that this is normal. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why is this important to us?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We are a small company, we have a small IT staff, we cannot afford such heavy technologies, because a lot of people have to share responsibility for these layers. Before this is hard to reach. </font></font><br><br><img src="https://habrastorage.org/files/928/d63/e93/928d63e93fd145ddb23d57a888a952dc.jpg"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimization</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is quite short here, everyone probably knows about it. We have </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">statistics on updates</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inserts</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delites </font></font></b> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in tables, dead tuples</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , statistics on references to indices. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How can this be used?</font></font></b>  Very simple.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you consider that for one business transaction of an order from 10 positions each position must be updated once, then you start a transaction, remove counters, complete a transaction, remove counters and see that it has been processed 10 times. Sometimes it turns out that each position is updated n-factorial times, and n is the number of positions in the order. And you understand that theory is at variance with practice. You are looking for algorithms and you find them. These are cycles. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cycles</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are always a source of pain. These are forgotten </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> clauses </font><font style="vertical-align: inherit;">, that is, we update the data with the correct values, but we update them more than 1 time, when we no longer need it, say ‚Äústop‚Äù, and it still updates. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sometimes this is a subquery where </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DISTINCT was</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> forgotten </font><font style="vertical-align: inherit;">to do, that is, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WHERE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> query </font><font style="vertical-align: inherit;">...</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID IN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and it returns many non-unique values, which causes problems. And, of course, forgotten indexes. </font></font><br><br><img src="https://habrastorage.org/files/42c/63b/ec1/42c63bec1cbb4090a474c1c37acdc003.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And finally, I said that sometimes there are </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rare business functions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , when a person approaches them once a day and does it reluctantly, and the function runs slower and slower. The record was: for a person, from a 15-minute job turned into a 2-hour. And no one knew about it, not even its head. When we accidentally found it, there was just joy and a splash of champagne. That is, we must </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">constantly study the log of stored procedures</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , top functions in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_statements</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , catch anomalies in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_functions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and just clean up the code. It's like painting the Brooklyn Bridge: we optimize the top-5, then there are more and more new, we walk in a circle. But this is a guarantee of user comfort. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the end, we got rid of the temporary tables, the ones that caused the pain in 2009, because they had to be truncated on each transaction. We successfully get rid of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">legacy </font></font></b> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">window functions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recursive queries</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This is some kind of miracle. For the most part, all the code we wrote on this functionality is installed faster and is well read. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, how do we debug a function if there is a difficult place: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clock timestamp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, note before, note after and you can see the time you can profile. </font></font><br><br><img src="https://habrastorage.org/files/d7f/33d/e7c/d7f33de7cd484238be129d208dbfd7ec.jpg"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How do we care for the code?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As I said, we now have 3,000 functions there. Last year we made a very big update, we improved most of the business logic, updated it for the site, everyone was happy. We had a huge amount of code thrown out: idle interface, idle functions. How to get rid of it? Somewhere in your Eclipse or IDE IDEA, you can connect classes, methods, set it all up, but you don‚Äôt know if it‚Äôs really used in the application or not. If your business logic is entirely written in functions, then with the help of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_user_function</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you will find out if the function is called or not.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you have worked for three months, look at the statistics and you will find functions that are not called at all. And in this way we have accumulated almost a thousand dead functions over the past 7 years. With the help of the query, we almost without thinking for a minute (maybe two hours thought), wrote a stored procedure that received the cycle names of these functions and the schema, and transferred them to the ‚Äú </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to-delete</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù </font><font style="vertical-align: inherit;">schema </font><font style="vertical-align: inherit;">. To our surprise, in two weeks there were only two exceptions with missing functions. One function switched some limits, it was called a ‚Äúdivorce‚Äù, and the other was my personal one, I hadn‚Äôt been calling it out of some need for a long time.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, this is a good opportunity, which is probably unavailable in other cases. Not only can you profile and develop code in one integrated environment, you can do powerful code redesign in the same environment. Once we redid the SessionID data type, before we had no uid, we used int8. When we decided to hang out on the Internet, for compatibility with Liferay we had to switch to a UID. Using some scripts, analyzing pg_proc, we wrote a large SQL script that did </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DROP FUNCTION</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE FUNCTION</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and changed data types, and all this was done in one transaction in 8 minutes at night. 2500 stored procedures have changed. </font></font><br><br><img src="https://habrastorage.org/files/5e6/09f/2b1/5e609f2b1fa846efa74e89b8b604eca9.jpg"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hopes and expectations</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> High expectations for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSON</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSONB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: as I said, this is a problem with cursors, from which we will get rid of and get </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Proxy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> just on a platter. Secondly, we have the expectation that we will transfer part of the interfaces to Android, and there JSON is very convenient. It is possible to denormalize well, having sorted all sorts of filters and ACLs for a site in JSON, should work very quickly, considering what wonderful things there are with indexes. We are very pleased </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BRIN indexes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">because we have analytics, but it will be rendered to another database. </font><font style="vertical-align: inherit;">Both BDR and logical replication - we still do not know why we need it, but we really want to try. </font><font style="vertical-align: inherit;">Firstly, it solves issues with analytics, that is, you can selectively drive out some data there to another database, and secondly, you may also want to make a distributed system (like Avito), although we don‚Äôt have to, as you know. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, we continue to prepare for you only the most interesting </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">success stories</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the leaders of both small but successful companies and major international holdings, such as Avito, Yandex, Zalando, Pivotal and others. </font><font style="vertical-align: inherit;">Applications for reports can now be found on </font></font><a href="http://pgday.ru/ru/2017/papers%3Futm_source%3Dhabr%26utm_medium%3Dpost%26utm_campaign%3Dmakarov"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conference </font><a href="http://pgday.ru/ru/2017/papers%3Futm_source%3Dhabr%26utm_medium%3Dpost%26utm_campaign%3Dmakarov"><font style="vertical-align: inherit;">website</font></a><font style="vertical-align: inherit;"> and vote for the most relevant topics for you!</font></font></i> </div><p>Source: <a href="https://habr.com/ru/post/326758/">https://habr.com/ru/post/326758/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326748/index.html">YouTrack 2017.2 release: updated user profile, experimental functionality and more</a></li>
<li><a href="../326750/index.html">Jonker-Volgenta + t-SNE algorithm = superpower</a></li>
<li><a href="../326752/index.html">How we did ML Boot Camp III</a></li>
<li><a href="../326754/index.html">Media Analysis</a></li>
<li><a href="../326756/index.html">The film "Hidden figures": tasks from the film and a modern approach to the calculations of the orbit and return to Earth</a></li>
<li><a href="../326760/index.html">DentalTap service overview - Treatment section</a></li>
<li><a href="../326762/index.html">‚ÄúBig Data is clear and simple‚Äù - an interview with the project manager for big data in QIWI Sergey Chekansky</a></li>
<li><a href="../326764/index.html">GoTo MeetUp: Security by Default</a></li>
<li><a href="../326766/index.html">Bitcoinophobia of St. Petersburg ships with blocking without victims</a></li>
<li><a href="../326768/index.html">Instantly determine your IQ and temperament</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>