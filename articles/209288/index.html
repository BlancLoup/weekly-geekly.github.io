<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What you need to know about ARC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Automatic reference counting (Automatic Reference Counting, ARC) for Objective-C was introduced by Apple back in 2011 for iOS 4.0 and higher, Mac OS X...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What you need to know about ARC</h1><div class="post__text post__text-html js-mediator-article">  Automatic reference counting (Automatic Reference Counting, ARC) for Objective-C was introduced by Apple back in 2011 for iOS 4.0 and higher, Mac OS X 10.6 and higher, using xCode 4.2 and higher.  And, although more and more libraries, frameworks and projects are being used by ARC today, there is still a rejection of this technology among programmers, or its incomplete understanding.  Experienced programmers who are accustomed to retain / release sometimes find that they are better and more efficient in coping with reference counting than the compiler does for them, and newbies who immediately use ARC, they think they don‚Äôt need to think about memory management at all, and everything will be magically done by itself. <br><a name="habracut"></a><br><h2>  ARC is not a garbage collector </h2><br>  Unlike the garbage collector, ARC does not automatically release memory from used objects and does not start any background processes.  All he does is analyze and put <i>retain / release</i> into compiled code for the programmer when building the application. <br>  You cannot directly call <i>retain, release, retainCount, autorelease.</i> <br>  You can override dealloc, but you do not need to call <i>[super dealloc]</i> , ARC will do this for you, and it will also release all property and instance variables that need it.  It is sometimes necessary to override <i>dealloc</i> in order to, for example, unsubscribe from notifications, remove an object from other services and managers to which it is subscribed, disable timers, and also release non-Objective-C objects. <br><h6>  Code without ARC: </h6><br><pre><code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)dealloc { [_someIvar release]; [_anotherIvar release]; [[<span class="hljs-built_in"><span class="hljs-built_in">NSNotificationCenter</span></span> defaultCenter] removeObserver:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> dealloc]; }</code> </pre> <br><h6>  Code from ARC: </h6><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)dealloc { [[<span class="hljs-built_in"><span class="hljs-built_in">NSNotificationCenter</span></span> defaultCenter] removeObserver:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; }</code> </pre><br><h2>  Strong and weak links </h2><br>  Instead of <i>retain</i> and <i>assign</i> attributes for <i>properties</i> , ARC uses <i>strong</i> and <i>weak</i> attributes ( <i>__strong</i> and <i>__weak</i> for local variables and <i>ivars</i> ).  These are not exactly their analogs, but more on that later.  The <i>strong</i> attribute is used by default, so it is not necessary to specify it explicitly. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> AnyClass *strongReference; <span class="hljs-comment"><span class="hljs-comment">//(atomic, strong)   @property (nonatomic, weak) id delegate;</span></span></code> </pre><br>  <i>Properties</i> whose variables refer to objects ‚Äúup‚Äù in the hierarchy and delegates should be weak to avoid circular references. <br><br>  Since local variables are strong by default ( <i>__strong</i> ), such constructions are possible in the code: <br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSDate</span></span> *originalDate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.lastModificationDate; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.lastModificationDate = [<span class="hljs-built_in"><span class="hljs-built_in">NSDate</span></span> date]; <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"Last modification date changed from %@ to %@"</span></span>, originalDate, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.lastModificationDate);</code> </pre><br>  The object stored in the variable <i>originalDate</i> will remain alive until ARC finds the last line where this variable is used, and then immediately releases it (substitutes <i>release</i> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To create a weak link, use the <i>__weak</i> attribute: <br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSDate</span></span> * __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> originalDate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.lastModificationDate; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.lastModificationDate = [<span class="hljs-built_in"><span class="hljs-built_in">NSDate</span></span> date];</code> </pre><br>  In this example, the originalDate may no longer exist on the second line, if this object is no longer strong links. <br><br>  <b>An important and useful feature of ARC: immediately after the deployment, weak links are zeroed, that is, become equal to nil.</b> <br><br>  And since in Objective-C, <i>nil</i> can receive any messages, problems with <i>EXC_BAD_ACCESS</i> are a thing of the past.  This is in contrast to the attributes of <i>retain / assign</i> .  The same thing happens when objects are declared: they are implicitly initialized by <i>nil '</i> ohm.  A useful technique is to cache weak <i>properties</i> in strong local variables, to be sure that the object will live for the necessary time: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)someMethod { <span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *cachedObject = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.weakProperty; [cachedObject doSomething]; [cachedObject doSomethingElse]; }</code> </pre><br>  For the same reason, when checking weak <i>properties</i> for <i>nil</i> , for example, delegates, you need to cache them: <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">id</span></span> cachedObject = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delegate; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cachedObject) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delegate doSomeTask]; } cachedObject = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>;</code> </pre><br>  Assigning to a cached object <i>nil</i> removes a strong link, and if there are no other strong links to it anymore, the object will be distributed. <br><br>  In rare cases, it is necessary that references to an object after its destruction are not reset.  For this, there is an <i>unsafe_unretained</i> attribute: <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">unsafe_unretained</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *someProperty; <span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *__<span class="hljs-keyword"><span class="hljs-keyword">unsafe_unretained</span></span> someReference;</code> </pre><br><br><h2>  Autorelease </h2><br>  Objects created using static methods (for example: <i>[NSData data ...], [NSArray array ...]</i> , etc.) and literals ( <i>@ "string", @ 42, @ [], @ {}</i> ) no longer authorialize.  The lifetime of such objects is given only by strong references to them. <br>  There is an attribute <i>__autoreleasing</i> , which, according to the documentation, it is recommended to use for double pointers (* id) in case you need to pass the result to the parameter. <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *__autoreleasing error; <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> ok = [database save:&amp;error]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ok) { <span class="hljs-comment"><span class="hljs-comment">//  }</span></span></code> </pre><br>  Then the save method must have the following signature: <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)save:(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> * __autoreleasing *) error;</code> </pre><br>  This ensures the safety of the object created inside the method.  If you declare a variable without this attribute, the compiler will create a temporary authorization variable that will be passed to the method: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> * error; <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *__autoreleasing tmp; <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> ok = [database save:&amp;tmp]; error = tmp;</code> </pre><br><br>  <i>NSAutoreleasePool</i> is no longer available for direct use.  Instead, it is proposed to use the <i>@autoreleasepool {}</i> directive.  When entering such a block, the state of the pool is saved, when exiting it is restored, freeing all objects created inside.  It is recommended to use <i>@autoreleasepool</i> in cycles if a large number of temporary objects are created. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> object <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hugeArray) { <span class="hljs-keyword"><span class="hljs-keyword">@autoreleasepool</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   } }</span></span></code> </pre><br><br><h2>  Blocks </h2><br>  Blocks still need to be copied. <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//property @property (nonatomic, copy) SomeBlockType someBlock; //  someBlockType someBlock = ^{NSLog(@"hi");}; [someArray addObject:[someBlock copy]];</span></span></code> </pre><br>  The compiler warns about circular references: <br><br>  <b>warning: capturing 'self' strongly in this block</b> <b><br></b>  <b>[-Warc-retain-cycles, 4]</b> <br><pre> <code class="objectivec hljs">SomeBlockType someBlock = ^{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> someMethod]; };</code> </pre><br>  When a block is copied, it will also capture <i>self</i> if it uses <i>instance varisbles</i> . <br><br>  To avoid such cases, you need to create a weak link to <i>self</i> : <br><pre> <code class="objectivec hljs">__<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> SomeObjectClass *weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; SomeBlockType someBlock = ^{ SomeObjectClass *strongSelf = weakSelf; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strongSelf) { [strongSelf someMethod]; } };</code> </pre><br>  You must take care of any objects in blocks declared from the outside, using the <i>__weak</i> attribute. <br><br><h2>  Build bridges </h2><br>  What about <i>CoreFondation</i> objects?  For them, the manual reference counting has not been canceled.  Direct caste now does not work, for this there are several special keywords. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">id</span></span> my_id; <span class="hljs-built_in"><span class="hljs-built_in">CFStringRef</span></span> my_cfref; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *a = (__bridge <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)my_cfref; <span class="hljs-built_in"><span class="hljs-built_in">CFStringRef</span></span> b = (__bridge <span class="hljs-built_in"><span class="hljs-built_in">CFStringRef</span></span>)my_id; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *c = (__bridge_transfer <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)my_cfref; <span class="hljs-comment"><span class="hljs-comment">// -1    CFRef CFStringRef d = (__bridge_retained CFStringRef)my_id; //  CFRef +1</span></span></code> </pre><br><br><ul><li>  <i>__bridge Leaves the</i> number of links to old objects unchanged.  The CF object must be manually released. </li><li>  <i>__bridge_transfer is</i> needed to change the object type from CF to Objective-C.  ARC decrements the reference count CF, so make sure it is greater than zero. </li><li>  <i>__bridge_retained is</i> needed to change the type of an object from Objective-C to CF.  It will return a CF object with a reference count of +1.  Do not forget to free the object by calling <i>CFRelease ()</i> . </li></ul><br><br><h2>  Conclusion </h2><br>  Use ARC.  It is easier, safer and will save you time and nerves. <br><br><h5>  Links </h5><br>  <a href="http://clang.llvm.org/docs/AutomaticReferenceCounting.html">Clang ARC Documentation Section</a> <br>  <a href="http://www.learn-cocos2d.com/2013/03/confirmed-arc-slow/">ARC performance article</a> </div><p>Source: <a href="https://habr.com/ru/post/209288/">https://habr.com/ru/post/209288/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209276/index.html">Motorized slider for shooting timelapse</a></li>
<li><a href="../209278/index.html">Most natural logarithm</a></li>
<li><a href="../209282/index.html">Pricing of contextual advertising services</a></li>
<li><a href="../209284/index.html">How to teach humanities to program</a></li>
<li><a href="../209286/index.html">Project Analysis Source SDK</a></li>
<li><a href="../209290/index.html">Traffic light on PLC - all languages ‚Äã‚ÄãIEC 61131-3</a></li>
<li><a href="../209292/index.html">The conference started on the Play Framework 2 - Ping (Play! Edition)</a></li>
<li><a href="../209294/index.html">Vertical Job Finder</a></li>
<li><a href="../209304/index.html">Robots-cars from BMW showed their capabilities at CES-2014</a></li>
<li><a href="../209308/index.html">Livetv.ru "shocked" in the Khoroshevsky court for references to pirated content for 88 million rubles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>