<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Time setting on the switches via SNMP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As we all read in the news. summer / winter time is expected to be a mess. 
 Having a base of switches in the amount of several thousand, handles are ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Time setting on the switches via SNMP</h1><div class="post__text post__text-html js-mediator-article">  As we all read in the news.  summer / winter time is expected to be a mess. <br>  Having a base of switches in the amount of several thousand, handles are not very common, and you will change their configs. <br>  Therefore, I came up with this bike. <br>  By the way, this bike is not only suitable for setting the time, but also for anything that is configured via SNMP <br><br>  So. <br>  We have: <br>  1. several thousand switches (I have dlink) about one series.  Namely: <br>  DES-1228 / ME <br>  DES-3200 <br>  DES-3526 <br>  DES-3010G <br><br>  These switches have the same oid for setting the time, so we will program them in packs of 253 pieces at a time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Subnets: <br>  Never mind.  Let it be: 172.16.0.0/24 <br>  The subnet size / 24 was processed within 5 minutes, and since our script will have to .php, we need to reconfigure the server so that it does not drop the script after 30 seconds or reduce the size of the subnet being processed at once. <br><br>  So, our config (config.php): <br><a name="habracut"></a><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> $startip = <span class="hljs-string"><span class="hljs-string">"172.16.0.2"</span></span>; $endip = <span class="hljs-string"><span class="hljs-string">"172.16.0.254"</span></span>; $ntp1 = <span class="hljs-string"><span class="hljs-string">"172.16.0.1"</span></span>; $ntp2 = <span class="hljs-string"><span class="hljs-string">"172.16.0.1"</span></span>; $gmt = <span class="hljs-string"><span class="hljs-string">"540"</span></span>; $interval = <span class="hljs-string"><span class="hljs-string">"86400"</span></span>; $community = <span class="hljs-string"><span class="hljs-string">"private"</span></span>; $dissummertime = <span class="hljs-string"><span class="hljs-string">".1.3.6.1.4.1.171.12.10.12.1.0"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//i $enantp = ".1.3.6.1.4.1.171.12.10.11.1.0"; //i $ntpupdateoid = ".1.3.6.1.4.1.171.12.10.11.5.0"; //i $ntp1oid = ".1.3.6.1.4.1.171.12.10.11.3.0"; //a&gt; $ntp2oid = ".1.3.6.1.4.1.171.12.10.11.4.0"; //a $gmtoid = ".1.3.6.1.4.1.171.12.10.10.4.0"; //i $saveconfig = ""; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br>  We will sort through the points: <br>  $ startip - the beginning of our IP range of switches; <br>  $ endip - The last switch in the range; <br>  $ ntp1 ‚Äî A time synchronization server on your network that is accessible to switches; <br>  $ ntp2 - The second time synchronization server on your network available to the switches; <br>  $ gmt - time zone shift, I have it +9, which means I entered 9 * 60 = 540; <br>  $ interval - The period over which switches will update their time.  The default value is 720, I set it once a day: 60 * 60 * 24 = 86400; <br>  $ community - password with write access. <br><br>  Now the script itself (ntp.php): <br><habracut><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>. <span class="hljs-comment"><span class="hljs-comment">//   include_once('config.php'); //  IP     ,     $ip = ip2long($startip); $ip2 = ip2long($endip); //    IP  for($ip;$ip &lt;= $ip2; $ip++) { //   IP     xxx.xxx.xxx.xxx  ,     snmp         $ipdec = long2ip($ip); //       80  $fp = @fsockopen ($ipdec, "80", $errno, $errstr, 2); //    ,      : IP - Error -   ( ) if (!$fp) { echo $ipdec." - Error - $errstr ($errno)&lt;br /&gt;"; //     snmp  } else { //    snmpset($ipdec, $community, $dissummertime, "i", "0"); //     ntp snmpset($ipdec, $community, $enantp, "i", "3"); //     snmpset($ipdec, $community, $ntpupdateoid, "i", $interval); //    ntp  snmpset($ipdec, $community, $ntp1oid, "a", $ntp1); //    ntp  snmpset($ipdec, $community, $ntp2oid, "a", $ntp2); //     snmpset($ipdec, $community, $gmtoid, "i", $gmt); //      : IP - OKe echo $ipdec." - OKe&lt;br /&gt;"; } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  After sending these values ‚Äã‚Äãto the first address pool, you can change the pool to the next one in the config and run the script again. <br><br>  Script cons: <br>  1. It is necessary to open the script body to change the address pool. <br>  In principle, you can make the input field. <br>  2. I have IP switches located in the ERP database, so the script will take them from there so that you can exclude empty addresses. <br>  3. The script does not send the command to save the switch config, i.e.  after reboot (power failure) these settings will not be saved.  Fix this error is your homework.  Those.  you need to find the save oid of the configs and add the snmtset line to the script body. <br>  Well, how to write to decent people: The method does not claim to originality and you can use it as you wish and at your own peril and risk. <br><br>  PS to save the config you need to send the line: .1.3.6.1.4.1.171.12.1.2.6.0 i 2 </habracut></div><p>Source: <a href="https://habr.com/ru/post/152931/">https://habr.com/ru/post/152931/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../152915/index.html">Based on the article ‚ÄúWho owns the Bynet‚Äù</a></li>
<li><a href="../152917/index.html">We write and publish a plug-in to the Safari web browser</a></li>
<li><a href="../152921/index.html">Right decision tool: Six thinking hats</a></li>
<li><a href="../152927/index.html">Another jQuery plugin for pixel-to-pixel layout</a></li>
<li><a href="../152929/index.html">Why sometimes you have to beat your hands?</a></li>
<li><a href="../152933/index.html">Qt widget for adding and deleting rows in a QTableView table</a></li>
<li><a href="../152935/index.html">USSD and IVR - development and subtleties</a></li>
<li><a href="../152937/index.html">Wordpress blog with semantic markup</a></li>
<li><a href="../152941/index.html">Registering a site as a media is a panacea for blocking?</a></li>
<li><a href="../152943/index.html">In memory of David Barron</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>