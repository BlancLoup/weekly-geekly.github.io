<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We control the machine via Bluetooth from a tablet or phone for Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 Today I will talk about how a programmer can reach with a mid-life crisis in attempts to at least somehow compensate for the lack of fash...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We control the machine via Bluetooth from a tablet or phone for Android</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  Today I will talk about how a programmer can reach with a mid-life crisis in attempts to at least somehow compensate for the lack of fashionable toys in a distant and half-forgotten childhood. <br><br>  I have already played with radio-controlled helicopters with my sons, well, but in a standard Moscow apartment it is a bit cramped, and it is cold, dirty and windy outside.  We'll have to play with cars, good, there is such a device at hand: <br><img src="https://habrastorage.org/getpro/habr/post_images/590/8a2/1e6/5908a21e627f50c983ce9f013feebb19.jpg"><br>  The children have already graced them with graffiti and have a little wiped, but it still travels, if we find the console ... But the console is lost somewhere.  Well, but there is a tablet with Bluetooth!  It remains as they make friends together.  A lot of such projects are searched through Google, so let's complicate the task - <a name="habracut"></a>  We make proportional steering and smooth speed adjustment! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will need: <br><ul><li>  Arduino Nano for $ 3, <a href="http://www.ebay.com/itm/200957063666">www.ebay.com/itm/200957063666</a> </li><li>  Servo MG90S, <a href="http://www.ebay.com/itm/310700893735">www.ebay.com/itm/310700893735</a> </li><li>  Motor Shield L293D, <a href="http://www.ebay.com/itm/200982006661">www.ebay.com/itm/200982006661</a> </li><li>  Bluetooth module HC-06, <a href="http://www.ebay.com/itm/400618536050">www.ebay.com/itm/400618536050</a> </li><li>  Optionally - Step Up DC Converter, so that the motor spins more fun, in the absence of something simpler, I used this: <a href="http://www.ebay.com/itm/400353452902">www.ebay.com/itm/400353452902</a> </li></ul><br>  Ruthlessly throwing out the DC motor, which pulled the tie rod, instead of it with a needle file, an assembly gun and other popular methods, we insert the servo drive.  We compile a simplest scheme with arduina and other components on a breadboard.  I will not give you the connection scheme, I just hooked everything onto the first legs of the Arduin, which even worked with some iteration.  After several attempts to arrange everything so that it fit on the native chassis, it turned out like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/579/0b4/cf9/5790b4cf9634e5504b00118475551f43.jpg"><br><br>  The Bluetooth module is hidden from the bottom of the layout, the dc converter is then stuck on top of the back of the chassis: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f4/1dd/104/1f41dd104ed22e389a965e302d131aea.jpg"><br><br>  It remains to fill in the sketch, since we have the Bluetooth adapter hanging on the same serial port as the USB TTL adapter, before pouring the sketch, do not forget to pull off the RX / TX with the Bluetooth module.  By the way, the idea was to use SoftwareSerial for it, but I had to drop it, because SoftwareSerial gives strange spontaneous twitches on a servo drive. <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Servo.h&gt; Servo servoSteering; const int servoSignalPin = 7; // servo yellow(signal) pin const int servoMiddle = 88; // servo middle position const int servoMaxAngle = 35; // servo max angle (degrees) const int servoLeftBound = servoMiddle - servoMaxAngle; const int servoRightBound = servoMiddle + servoMaxAngle; int servoPos = servoMiddle; int servoTrim = 0; const int dcMotorA1Pin = 11; // dc motor A+ pin const int dcMotorA2Pin = 12; // dc motor A- pin const int dcMotorPWMPin = 3; // dc motor PWM pin const int ledPin = 13; // data received pin const int dcMotorPWMLowerBound = 128; // dc motor min PWM (min speed) const int dcMotorPWMHighBound = 255; // dc motor max PWM (max speed) int dcMotorDir = 1; // 1 - forward, -1 - backward int dcMotorSpd = 0; // 0 - stand still, value between dcMotorPWMLowerBound and dcMotorPWMHighBound to move const int cmdTimeout = 2000; // max time between commands from rc control, will stop if no new commands arrive typedef enum { NONE = 0, SERVO_L, SERVO_R, TRIM, DCMOTOR_F, DCMOTOR_B, STOP } mode_t; mode_t opMode = NONE; #define IS_DIGIT(x) ('9' &gt;= (x) &amp;&amp; '0' &lt;= (x)) unsigned long lastCmd = 0; void setup() { Serial.begin(9600); servoSteering.attach(servoSignalPin); pinMode(dcMotorA1Pin, OUTPUT); pinMode(dcMotorA2Pin, OUTPUT); pinMode(dcMotorPWMPin, OUTPUT); pinMode(ledPin, OUTPUT); digitalWrite(dcMotorA1Pin, 0); digitalWrite(dcMotorA2Pin, 0); analogWrite(dcMotorPWMPin, 0); } void loop() { while (Serial.available()) { digitalWrite(ledPin, HIGH); int ch = Serial.read(); lastCmd = millis(); // save command receive time for later if (opMode == NONE) { switch (ch) { case 'T': case 't': // trim mode opMode = TRIM; break; case 'L': case 'l': // servo left mode opMode = SERVO_L; break; case 'R': case 'r': // servo right mode opMode = SERVO_R; break; case 'F': case 'f': // dc motor move front mode opMode = DCMOTOR_F; break; case 'B': case 'b': // dc motor move back mode opMode = DCMOTOR_B; break; case 'S': case 's': // full stop mode servoPos = servoMiddle + servoTrim; // center front wheels dcMotorDir = 1; // 1st gear dcMotorSpd = 0; // neutral on default: opMode = NONE; break; } } else if (IS_DIGIT(ch)) { switch (opMode) { case TRIM: servoTrim = '5' - ch; break; case SERVO_L: servoPos = servoMiddle + servoTrim - (ch - '0') * servoMaxAngle / 10; if (servoPos &lt; servoLeftBound) servoPos = servoLeftBound; break; case SERVO_R: servoPos = servoMiddle + servoTrim + (ch - '0') * servoMaxAngle / 10; if (servoPos &gt; servoRightBound) servoPos = servoRightBound; break; case DCMOTOR_F: dcMotorDir = 1; dcMotorSpd = ch == '0' ? 0 : dcMotorPWMLowerBound + (dcMotorPWMHighBound - dcMotorPWMLowerBound) * (ch - '0') / 10; break; case DCMOTOR_B: dcMotorDir = -1; dcMotorSpd = ch == '0' ? 0 : dcMotorPWMLowerBound + (dcMotorPWMHighBound - dcMotorPWMLowerBound) * (ch - '0') / 10; break; default: break; } opMode = NONE; } if (dcMotorDir == 1) Serial.print("F "); else Serial.print("R "); Serial.print(dcMotorSpd); Serial.print(" S "); Serial.print(servoPos); Serial.print(" T "); Serial.println(servoTrim); digitalWrite(dcMotorA1Pin, dcMotorDir == 1 ? 1 : 0); digitalWrite(dcMotorA2Pin, dcMotorDir == 1 ? 0 : 1); analogWrite(dcMotorPWMPin, dcMotorSpd); servoSteering.write(servoPos); } if (dcMotorSpd &gt; 0 &amp;&amp; (lastCmd + cmdTimeout) &lt; millis()) { // rc control doesn't send anything, out of range or hang up, do full stop dcMotorDir = 1; // 1st gear dcMotorSpd = 0; // neutral on digitalWrite(dcMotorA1Pin, 1); digitalWrite(dcMotorA2Pin, 0); analogWrite(dcMotorPWMPin, 0); servoSteering.write(servoPos); } digitalWrite(ledPin, LOW); }</span></span></span></span></code> </pre> <br><br>  Tested via PuTTY from a laptop by sending commands to a Bluetooth-connected device that seems to work.  It remains to build an application for Android.  Nadergal in the network of images, code samples, tried to glue it, it seems to work: <br><br><img src="//habrastorage.org/files/df4/04b/329/df404b3292ff484c8402e5f2ec2bb538.JPG"><br><br>  Along the way, got a glitch with the implementation of Bluetooth on some ICS devices: <br>  <a href="http://code.google.com/p/android/issues/detail%3Fid%3D34161">code.google.com/p/android/issues/detail?id=34161</a> <br><br>  It manifested itself on the Lenovo A800, manifested in the fact that an open Bluetooth socket closes immediately.  To treat, apparently, only by changing the firmware of the device, all tested workarounds did not work ... <br><br>  Well, for a snack, the code of the Android application: <br>  <a href="https://github.com/robotsrulz/BluetoothRC">github.com/robotsrulz/BluetoothRC</a> <br><br>  And a short video where the son first tries to drive, but it turns out only in a straight line, and then I try to steer with one hand and continue shooting with the other: <br>  <a href="https://plus.google.com/u/0/photos%3Fpid%3D5988360256454694594%26pids%26oid%3D106468370342958692108">plus.google.com/u/0/photos?pid=5988360256454694594&amp;pids&amp;oid=106468370342958692108</a> </div><p>Source: <a href="https://habr.com/ru/post/216851/">https://habr.com/ru/post/216851/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216837/index.html">Devise: login and registration in modal windows</a></li>
<li><a href="../216839/index.html">The colors and the difference between them in LESS / Sass</a></li>
<li><a href="../216843/index.html">We start to study Cortex-M on the example of STM32</a></li>
<li><a href="../216845/index.html">Search for solutions for games with words. Boron application</a></li>
<li><a href="../216849/index.html">Setting up the development environment for OpenStack</a></li>
<li><a href="../216853/index.html">Gateway between IRC and Google Hangouts</a></li>
<li><a href="../216857/index.html">Synchronization in Android applications. Part two</a></li>
<li><a href="../216865/index.html">Use a hash search, not an array search</a></li>
<li><a href="../216869/index.html">Alternative GDC Arcade: Home-Made Freak Controllers Gallery</a></li>
<li><a href="../216871/index.html">Operation windigo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>