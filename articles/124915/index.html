<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Runkit + PHPUnit = 100% test coverage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dear colleagues. 

 One of the indirect indicators of code quality is considered code coverage - the degree of coverage of its tests (as a rule, we me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Runkit + PHPUnit = 100% test coverage</h1><div class="post__text post__text-html js-mediator-article">  Dear colleagues. <br><br>  One of the indirect indicators of code quality is considered code coverage - the degree of coverage of its tests (as a rule, we mean unit tests).  In most cases, coverage is taken as the ratio of the number of lines of code that gets control during the test run to the total number of significant (non-commentary, empty line, or, for example, one curly brace, indicating the beginning or end of the block) lines of module code. <br><br>  Another condition for good tests is the absence of side effects, such as creating / deleting files, setting up network connections, writing to ports, etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, when it comes to the module that interacts with the outside world, these two requirements conflict.  And well, if we are talking about file operations, when <a href="http://code.google.com/p/bovigo/wiki/vfsStream">vfsStream</a> <a href="http://www.phpunit.de/manual/3.6/en/test-doubles.html">comes to the</a> <a href="http://code.google.com/p/bovigo/wiki/vfsStream">rescue</a> .  But what to do when you need to test, say, direct work with sockets or code that uses curl_ * functions? <br><br>  Under the cut, you will find my solution and, as a bonus, <a href="http://habrahabr.ru/blogs/php/124875/">another</a> OPP wrapper to the Kurlu, fully covered with tests. <br><a name="habracut"></a><br><br>  You can use <a href="http://habrahabr.ru/blogs/php/105610/">Runkit</a> to write unit tests for such code.  I wrote the PHPUnit extension TestCase, which with the help of the rankit allows you to replace the built-in functions using the full power of asserts and mocks from Sebastian Bergman.  The heir is so simple that I will allow myself to bring his code here in its entirety. <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } }</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; /** <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> * Test case which enables overriding of functions with runkit. <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> * <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> * 1. To override a number of system function do <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> * <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> *              $mock = $this-&gt;runkitMockFunctions(array(...)); <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> * <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> * 2. To define expected behaivour use $mock as an ordinary phpunit mock object. <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> * <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> * 3. To revert overridden functions back call $this-&gt;runkitRevertAll(); <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> * <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> * Example: <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> * <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> *      class MyCurlTest <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> *          extends \Base\UnitTest\RunkitTestCase <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> *      { <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> *          protected $mock; <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> * <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> *          protected function setUp() <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> *          { <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> *              $this-&gt;mock = $this-&gt;runkitMockFunctions(array( <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> *                  'curl_init', <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> *                  'curl_close', <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> *              )); <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> *          } <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> * <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> *          protected function tearDown() <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> *          { <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> *              $this-&gt;runkitRevertAll(); <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> *          } <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> * <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> *          public function testInitClose() <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> *          { <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> *              $this-&gt;mock <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> *                  -&gt;expects($this-&gt;at(0)) <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> *                  -&gt;method('curl_init') <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> *                  -&gt;with() <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> *                  -&gt;will($this-&gt;returnValue('my_handle')); <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> * <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> *              $this-&gt;mock <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> *                  -&gt;expects($this-&gt;at(1)) <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> *                  -&gt;method('curl_close') <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> *                  -&gt;with('my_handle'); <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> * <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> *              $handle = curl_init(); <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> *              $this-&gt;assertEquals('my_handle', $handle); <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> *              curl_close($handle); <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> *          } <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> *      } <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> * <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> * @package Base\UnitTest <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> * @version $id$ <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> * @author Alexey Karapetov &lt;karapetov@gmail.com&gt; <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> */ <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; /** <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> * Method to call from overridden functions. <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> * Calls given mock's method with given arguments. <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> * <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> * @param string    $method Mock's method to call <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> * @param array     $args  Arguments to pass to @link $method <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> * @return void <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> */ <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } /** <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> * Mark test skipped if runkit is not enabled <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> * <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> * @return void <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> */ <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } /** <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> * Override given functions with mock <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> * <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> * @param array $funcList Functions to override <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> * @return stdClass Mock object <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> */ <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } /** <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> * Override function <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> * <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> * @param string    $func <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> * @param string    $args <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> * @param string    $body <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> * @param mixed     $mock Mock object for the function <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> * @return void <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> */ <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li></li><li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } /** <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> * Revert previously overridden function <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> * <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> * @param string $func <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> * @return void <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> */ <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } /** <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> * Revert all previously overridden functions <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> * <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> * @return void <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> */ <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> &lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <font color="#0000ff">namespace</font> Base\UnitTest; <font color="#008000">/**</font> <font color="#008000">* Test case which enables overriding of functions with runkit.</font> <font color="#008000">*</font> <font color="#008000">* 1. To override a number of system function do</font> <font color="#008000">*</font> <font color="#008000">*              $mock = $this-&gt;runkitMockFunctions(array(...));</font> <font color="#008000">*</font> <font color="#008000">* 2. To define expected behaivour use $mock as an ordinary phpunit mock object.</font> <font color="#008000">*</font> <font color="#008000">* 3. To revert overridden functions back call $this-&gt;runkitRevertAll();</font> <font color="#008000">*</font> <font color="#008000">* Example:</font> <font color="#008000">*</font> <font color="#008000">*      class MyCurlTest</font> <font color="#008000">*          extends \Base\UnitTest\RunkitTestCase</font> <font color="#008000">*      {</font> <font color="#008000">*          protected $mock;</font> <font color="#008000">*</font> <font color="#008000">*          protected function setUp()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock = $this-&gt;runkitMockFunctions(array(</font> <font color="#008000">*                  'curl_init',</font> <font color="#008000">*                  'curl_close',</font> <font color="#008000">*              ));</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          protected function tearDown()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;runkitRevertAll();</font> <font color="#008000">*          }</font> <font color="#008000">*</font> <font color="#008000">*          public function testInitClose()</font> <font color="#008000">*          {</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(0))</font> <font color="#008000">*                  -&gt;method('curl_init')</font> <font color="#008000">*                  -&gt;with()</font> <font color="#008000">*                  -&gt;will($this-&gt;returnValue('my_handle'));</font> <font color="#008000">*</font> <font color="#008000">*              $this-&gt;mock</font> <font color="#008000">*                  -&gt;expects($this-&gt;at(1))</font> <font color="#008000">*                  -&gt;method('curl_close')</font> <font color="#008000">*                  -&gt;with('my_handle');</font> <font color="#008000">*</font> <font color="#008000">*              $handle = curl_init();</font> <font color="#008000">*              $this-&gt;assertEquals('my_handle', $handle);</font> <font color="#008000">*              curl_close($handle);</font> <font color="#008000">*          }</font> <font color="#008000">*      }</font> <font color="#008000">*</font> <font color="#008000">* @package Base\UnitTest</font> <font color="#008000">* @version $id$</font> <font color="#008000">* @author Alexey Karapetov &lt;karapetov@gmail.com&gt;</font> <font color="#008000">*/</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> RunkitTestCase extends \PHPUnit_Framework_TestCase { <font color="#0000ff">private</font> <font color="#0000ff">static</font> $mockedFunctions = array(); <font color="#0000ff">const</font> BACKUP_SUFFIX = <font color="#A31515">'_runkit_mocker_backup'</font> ; <font color="#008000">/**</font> <font color="#008000">* Method to call from overridden functions.</font> <font color="#008000">* Calls given mock's method with given arguments.</font> <font color="#008000">*</font> <font color="#008000">* @param string    $method Mock's method to call</font> <font color="#008000">* @param array     $args  Arguments to pass to @link $method</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function call($func, array $args) { <font color="#0000ff">return</font> call_user_func_array(array(self::$mockedFunctions[$func], $func), $args); } <font color="#008000">/**</font> <font color="#008000">* Mark test skipped if runkit is not enabled</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function skipTestIfNoRunkit() { <font color="#0000ff">if</font> (!extension_loaded( <font color="#A31515">'runkit'</font> )) { $ <font color="#0000ff">this</font> -&gt;markTestSkipped( <font color="#A31515">'Runkit extension is not loaded'</font> ); } } <font color="#008000">/**</font> <font color="#008000">* Override given functions with mock</font> <font color="#008000">*</font> <font color="#008000">* @param array $funcList Functions to override</font> <font color="#008000">* @return stdClass Mock object</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitMockFunctions(array $funcList) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); $mock = $ <font color="#0000ff">this</font> -&gt;getMock( <font color="#A31515">'stdClass'</font> , $funcList); <font color="#0000ff">foreach</font> ($funcList <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitOverride($func, <font color="#A31515">''</font> , <font color="#A31515">'return '</font> . __CLASS__ . <font color="#A31515">"::call('{$func}', func_get_args());"</font> , $mock); } <font color="#0000ff">return</font> $mock; } <font color="#008000">/**</font> <font color="#008000">* Override function</font> <font color="#008000">*</font> <font color="#008000">* @param string    $func</font> <font color="#008000">* @param string    $args</font> <font color="#008000">* @param string    $body</font> <font color="#008000">* @param mixed     $mock Mock object for the function</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitOverride($func, $args, $body, $mock = <font color="#0000ff">null</font> ) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is marked as mocked already"</font> ); } self::$mockedFunctions[$func] = $mock; \runkit_function_copy($func, $func . self::BACKUP_SUFFIX); \runkit_function_redefine($func, $args, $body); } <font color="#008000">/**</font> <font color="#008000">* Revert previously overridden function</font> <font color="#008000">*</font> <font color="#008000">* @param string $func</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevert($func) { $ <font color="#0000ff">this</font> -&gt;skipTestIfNoRunkit(); <font color="#0000ff">if</font> (!array_key_exists($func, self::$mockedFunctions)) { <font color="#0000ff">throw</font> <font color="#0000ff">new</font> \RuntimeException( <font color="#A31515">"Function '{$func}' is not marked as mocked"</font> ); } unset(self::$mockedFunctions[$func]); \runkit_function_remove($func); \runkit_function_copy($func . self::BACKUP_SUFFIX, $func); \runkit_function_remove($func . self::BACKUP_SUFFIX); } <font color="#008000">/**</font> <font color="#008000">* Revert all previously overridden functions</font> <font color="#008000">*</font> <font color="#008000">* @return void</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> function runkitRevertAll() { <font color="#0000ff">foreach</font> (array_keys(self::$mockedFunctions) <font color="#0000ff">as</font> $func) { $ <font color="#0000ff">this</font> -&gt;runkitRevert($func); } } }</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The simplest example of using attentive readers have already noticed in the class dock, I will gladly give explanations if they are needed, in the comments to the topic.  A slightly more complicated use case, testing the transfer of parameters by reference, you will find in the tests of the <a href="http://code.google.com/p/php-curl-oop/source/browse/">OOP wrapper</a> I promised me <a href="http://code.google.com/p/php-curl-oop/source/browse/">to the Kurlu</a> . <br><br>  Thank you, I will be grateful for the criticism. </div><p>Source: <a href="https://habr.com/ru/post/124915/">https://habr.com/ru/post/124915/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124909/index.html">Comparison of memory consumption for different data storage structures</a></li>
<li><a href="../124910/index.html">Introduction to cycle optimization techniques</a></li>
<li><a href="../124911/index.html">Imperavi: a convenient and really beautiful JS WYSIWYG editor</a></li>
<li><a href="../124912/index.html">Chosen drop-down list widget: implement dynamic position adding</a></li>
<li><a href="../124913/index.html">MLAA morphological smoothing algorithm for CPU</a></li>
<li><a href="../124916/index.html">GarageBand - What an almost amateur can ‚Äúwrite‚Äù in 8 minutes</a></li>
<li><a href="../124921/index.html">Psychological mistakes startups</a></li>
<li><a href="../124924/index.html">There are personal messages on Google+, but not everyone knows about it.</a></li>
<li><a href="../124925/index.html">Introduction to OpenCL</a></li>
<li><a href="../124926/index.html">Mozilla announced its intention to create its own mobile web OS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>