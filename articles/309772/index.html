<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sorry, we are updating the protocol</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Back in 2011, we were asked why enter a phone number for billing on the side of a partner connected to QIWI? We have long wanted to facilitate the int...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sorry, we are updating the protocol</h1><div class="post__text post__text-html js-mediator-article">  Back in 2011, we were asked why enter a phone number for billing on the side of a partner connected to QIWI?  We have long wanted to facilitate the integration of the API, but earlier it was quite difficult to do this.  What has changed in 2016?  Now we will tell, and also we will experiment with Habrovsky R &amp; D voting. <br><br> <a href="https://habrahabr.ru/company/qiwi/blog/309772/"><img src="https://habrastorage.org/files/1d2/346/26d/1d234626ddb74cc4b6bb760424637bdd.PNG"></a> <br><a name="habracut"></a><br><h1>  Alignment, pain and tears of large companies </h1><br>  If to simplify, in work on any project in the company three groups participate: <br><br><ul><li>  Customers  Responsible for the business idea of ‚Äã‚Äãthe project, financial evaluation, sales; </li><li>  Project managers.  They are responsible for the technical implementation, determine which groups it will affect, control the general terms and the launch of the project; </li><li>  The developers.  Implement and run the project. </li></ul><br>  Each division had its own subgroups with queues and priorities.  The task for a serious revision of the site involved a legion of colleagues: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Payment processing: <br><br><ul><li>  Java developers responsible for payments, large partner APIs and standard external APIs </li><li>  Oracle developers responsible for database design and stored procedures; <br><br></li></ul></li><li>  Web development: <br><br><ul><li>  Java back-end + web developers API, </li><li>  JavaScript developers, especially for the SPA, </li><li>  Maker-ups; <br><br></li></ul></li><li>  Q &amp; A giving the go-ahead to the final product release. </li></ul><br><img width="400" src="https://habrastorage.org/files/eb1/bd5/fd7/eb1bd5fd77db402d8299b7cdc4a7d5ce.JPG"><br><br>  With this approach, projects were quickly launched that were prioritized for the tops: they were allocated a separate project team that ran even super-complex projects out of priorities and queues in the shortest possible time.  However, all other product tasks could be stuck in the implementation queue.  The development of already launched products suffered the most. <br><br>  Now in QIWI teams are formed for specific products.  At the same time, for example, a Java developer from the product team, if required, may make changes to payment processing, which will be verified and accepted.  Previously, this should have been done only by the processing developers, since  Web developers switched to other projects in their task queue.  The new approach makes the team more flexible, and the time to implement the new functionality is significantly reduced.  Let's see how we decide to change. <br><br><h1>  Eight years later we decided </h1><br>  Alteration of the main protocol is a crucial step, but the obligatory entry of a phone number on the partner‚Äôs side complicated integration and payment.  We explored two options for development: <br><br>  1. Now our server REST protocol requires you to specify the phone number for billing.  Considered the option of refinement for billing an arbitrary identifier or email. <br><br>  Pros: <br><br><ul><li>  A flexible approach, convenient for potential updates from existing partners, </li><li>  Maximum protection, because  The protocol assumes only inter-server communication. </li></ul><br>  Minuses: <br><br><ul><li>  Complicated integration for new partners, because  you need to invoice before forwarding to the payment page, </li><li>  It is very difficult to make mass services with notification of bills, </li><li>  It requires a significant rework of the architecture of accounts in payment processing. </li></ul><br>  2. The company had an http protocol with number input on the QIWI side.  But it was not verified in any way that the bill is billed by the partner.  This protocol was ideal for collecting donations, but for large partners it could not be used in this form.  The solution was to add a signature or hash and their subsequent verification when redirecting to the bill payment page. <br><br>  Pros: <br><br><ul><li>  Simple implementation for new partners, </li><li>  Low development costs by the team. </li></ul><br>  Minuses: <br><br><ul><li>  There may appear "gifted" partners who will store the secret key and calculate the signature on the client. </li></ul><br>  After a brief discussion, the second option was chosen.  Initially, the security service and IT-division preferred the formation of a signature based on the public and private keys.  However, recalling the experience of integration even with large partners and the number of emerging issues and problems when replacing certificates, we decided that we would stop at checking the sha512 hash. <br><br><div class="oembed"><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-0" style="position: static; visibility: visible; display: block; transform: rotate(0deg); width: 500px; margin: 10px auto; max-width: 100%; min-width: 220px;" data-tweet-id="27408742588882944"></twitter-widget><script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div><br><br>  There was a question, what parameters to hash?  The easiest option is to sort everything alphabetically, add a secret key and take a hash.  After the analysis, it became clear that there could be problems with comments and encodings, so they reduced the list to the minimum necessary number of parameters. <br><br>  The question remained how to determine the secret key.  For basic authorization, the REST protocol uses a pair of API ID and API Password, which allows you to flexibly configure checks for a partner.  For one site, you can create multiple authorization pairs and use them on different servers and versions of the site. <br><br><h3>  Algorithm and Example </h3><br>  In the end, came to this algorithm: <br><br><ul><li>  We form an array of parameters: <br><br><ul><li>  api_id - id to determine the secret key, </li><li>  currency - currency </li><li>  from - provider id </li><li>  summ - the amount </li><li>  to (if available) - phone number, </li><li>  txn_id - unique transaction ID on the provider side; </li></ul></li><li>  Add to the array the secret key associated with api_id; </li><li>  We combine all parameter values ‚Äã‚Äãinto a string using the delimiter |  between parameters; </li><li>  Calculate the sha512 hash; </li><li>  Add the string parameter signature in the request in the hexadecimal form in lower case. </li></ul><br>  An example implementation in PHP. <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// ID , API_ID, API      url: https://ishop.qiwi.com/options/rest.action $shopId = '260***'; $apiKey = '4683****'; $apiPassword = '1T1ea7****'; $CCY = 'RUB'; $amount = 1.12; //    71231234567.   $phone = null; // ID  $txnId = 'habr'.rand(1,90000); $params = [$apiKey, $CCY, $shopId, $amount, $txnId]; if (null !== $phone) { $params = [$apiKey, $CCY, $shopId, $amount, $phone, $txnId]; } //      $params[] = md5($apiKey); //       "|" $paramsStr = implode('|', $params); //   $signature = hash('sha512', $paramsStr); //  query  $query = http_build_query([ 'from' =&gt; $shopId, 'to' =&gt; $phone, 'txn_id' =&gt; $txnId, 'summ' =&gt; $amount, 'api_id' =&gt; $apiKey, 'ccy' =&gt; $CCY, 'signature' =&gt; $signature ]); //   url   $url = 'https://bill.qiwi.com/order/external/create.action?'.$query;</span></span></code> </pre> <br><h1>  Collective r &amp; d </h1><br>  I propose, as an experiment, to decide together how to develop the protocol.  We have not solved several technical issues and suggest you to think with us how to develop the protocol.  For this, a vote has been added at the end of the article. <br><br>  The main problem remains the lifetime parameter, which is responsible for the lifetime of the account.  In the existing protocol, it was transmitted in minutes, and the bill was issued immediately after the redirection.  In the new - the invoice can be issued much later, especially if the link was sent by email.  Therefore, most likely, you need to add a new parameter with an absolute date.  For example, in ISO 8601 format (2016-09-12T00: 00: 00), which is used in REST.  But do they need seconds there?  And ask whether to encode ':' in '% 3A', or replace it with '-', since  many still pass the success_url without url coding and knock on support with questions.  Most likely, the new parameter should also be included in the calculated signature. <br><br>  The updated protocol is difficult, but allows you to make mass mailings.  The main problem is the unique transaction id that will need to be generated when creating the link.  For mass mailings with the purchase of a particular item, this may be difficult.  The solution would be a set of purchase id and user account in the store, but then the user can buy something only once.  The problem could be solved by making new parameters and removing the restriction on uniqueness.  True, there are doubts that this is required by the market.  Let's vote? <br><br><h1>  For dessert </h1><br>  The new protocol is already ready for connecting partners, but so far it is activated only through the support service.  If you want to take part in testing, write to <a href="">cms@qiwi.ru</a> or contact support. <br><br>  You can estimate the current status of the payment page <a href="https://bill.qiwi.com/order/external/create.action%3Fcomm%3DHello%2Bhabr!%26from%3D2042%26summ%3D1.23%26currency%3DRUB">here</a> .  Happy programmer! <br><br>  <strong>PS I</strong> <a href="https://moikrug.ru/vacancies/1000028469">invite a</a> Java developer with good experience in implementing the REST API to join our team in launching the new ishop.qiwi.com and qualitatively turn the world around for thousands of our partners this year. </div><p>Source: <a href="https://habr.com/ru/post/309772/">https://habr.com/ru/post/309772/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309758/index.html">Shared Folders in OpenVZ 7.0</a></li>
<li><a href="../309760/index.html">How does the Center for the operational management of the MTS mobile network. Answers to your questions</a></li>
<li><a href="../309762/index.html">Home word splitting algorithm (with pictures)</a></li>
<li><a href="../309764/index.html">Susan Wojitsky: From CS50 Student to CEO Youtube</a></li>
<li><a href="../309768/index.html">Terabytes and tebibytes, traffic rating, the consequences of not understanding the difference and how to save on a video online project</a></li>
<li><a href="../309774/index.html">Happy programmer, or 10 facts about C ++++</a></li>
<li><a href="../309776/index.html">Your Data is so big: An introduction to Spark in Java</a></li>
<li><a href="../309778/index.html">Do I need a license to provide hosting services? (Telematic communication services) Or a conspiracy of consulting companies</a></li>
<li><a href="../309780/index.html">Using blocks in iOS. Part 1</a></li>
<li><a href="../309782/index.html">Happy programmer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>