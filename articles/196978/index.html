<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integrating Money Online into ActiveMerchant</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the application that I am developing on Ruby on Rails, I needed to connect the payment system. The customer entered into an agreement with Money On...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integrating Money Online into ActiveMerchant</h1><div class="post__text post__text-html js-mediator-article">  In the application that I am developing on Ruby on Rails, I needed to connect the payment system.  The customer entered into an agreement with <a href="http://dengionline.com/">Money Online</a> , and the first thing I did, of course, was to check the list of supported systems in Shopify's <a href="https://github.com/Shopify/active_merchant">ActiveMerchant</a> ‚Äî there was no such service there, I also looked for ready-made solutions that could simplify the integration, but nothing useful for RoR was found.  As a result, it was decided to fork ActiveMerchant and develop integration for this service for it, and later use the developments in the project. <br><br>  In this article I want to talk about the process of connecting the payment system, in the hope that it will come in handy for someone, because I lacked such information.  And it is also possible that information is useful to someone specifically on this payment system. <br><a name="habracut"></a><br>  Before that, I already had an acquaintance with ActiveMerchant: I integrated Robokassa in one of the projects, then <a href="http://habrahabr.ru/post/147435/">this</a> article helped a lot, and I did not encounter any problems, but I had to look at the module implementation code only a few times to check or understand the work of some specific methods - that‚Äôs all.  And when integrating my module, I had to study a large enough part of ActiveMerchant. <br><br><h5>  ActiveMerchant structure </h5><br>  To assist in the integration of such services, there are 3 base classes in the project: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <a href="http://rubydoc.info/github/Shopify/active_merchant/master/ActiveMerchant/Billing/Integrations/Helper">Helper</a> - on the basis of it, the form is built using the method <b>payment_service_for</b> , this method itself generates the form, with all the necessary parameters, the developer can only create the Helper correctly for a specific payment system </li><li>  <a href="http://rubydoc.info/github/Shopify/active_merchant/master/ActiveMerchant/Billing/Integrations/Notification">Notification</a> - this class contains methods for checking the validity of information received from the payment system server, for example, when confirming the completion of an operation </li><li>  <a href="http://rubydoc.info/github/Shopify/active_merchant/master/ActiveMerchant/Billing/Integrations/Return">Return</a> is used to handle callbacks, but it is often more convenient to work with helper tools built into the rails, for example, to process incoming parameters than with this class.  And in the implementations of this class in various systems there are usually no specific functions. </li></ul><br>  Each implementation of the payment system contains several classes inherited from the base ones, in some modules there are additional classes that implement additional protocol features.  Also for each payment system in ActiveMerchant there is a module in which classes are loaded from files, and which contain methods for creating a specific class included in this module. <br><br><h5>  Integrating Money Online into ActiveMerchant </h5><br>  The solution to this problem began with the study of <a href="http://dengionline.com/dev/protocol/main_protocol">the</a> Money Online <a href="http://dengionline.com/dev/protocol/main_protocol">protocol</a> , and everything turned out to be not as transparent as in the case of Robokassa: background information validation, confirmation and callbacks, in fact, everything is simple, but I was mostly confused by the parameters passed during the requests and a lot of different reservations. <br><br><img src="https://habrastorage.org/storage3/01a/558/00e/01a55800e543f2400ad148cbcbb27539.png" alt="image"><br>  <i>General query scheme</i> <br><br>  Briefly: in the general case, in a positive scenario, everything happens like this: the site sends the system a form with all the necessary parameters, and the user goes to the payment system site, then the payment system in the background asks for confirmation of the correctness of the data from our site.  If the data is correct, the user will be redirected to the place where he will see the necessary instructions for keeping the payment.  After clicking the "Pay" button, the payment system before accepting the payment, checks the data again, then the payment will be accepted and the system will send a request for payment confirmation to the site, and in the event of a positive answer, the user will be redirected to the callback. <br><br>  The main features of the protocol that confused me: <br><br><ul><li>  When billing, one parameter is sent, while checking these parameters are returned under other names </li><li>  Initially, the protocol assumes that verification is carried out only by the identifier of the user who placed the order, and it is often much more convenient to verify the data by the internal payment identifier </li><li>  Although it is possible to transfer an internal payment identifier to the system, it will not be returned during verification and in some cases it will be confirmed when confirming it. </li><li>  No parameters are passed to the callbacks. </li><li>  When invoicing, there are many additional features to provide convenience to users, but all of these features are implemented in a protocol in different ways. </li></ul><br>  Because of these features, I had to write several times in support of them (although at first I contacted them via the voice module on the site, but the girl, after listening to my problem, redirected me to an answering machine), and during the same day I received adequate answers. <br><br>  From the pros, I noticed that if you make a request exactly according to the described protocol, you will get the expected result in return, although in some cases data verification is not performed, but apparently due to the peculiarities of the gateways. <br><br>  I also liked the ability to invoice in the background in some cases.  And I decided to make the most complete support for the billing protocol, but I did not have the opportunity to protest absolutely everything, so there might be some problems. <br><br>  We also managed to identify one undocumented feature: in response to a background request for creating an invoice for payment via QIWI, it comes along with the described parameters, the iframeSRC parameter with incomprehensible content, without thinking twice, decoded the data from this parameter using base64 and received a link that leads to the form payment through QIWI, and apparently it is assumed that the link should be used to create an iframe. <br><br>  If you look at the various implementations <a href="https://github.com/Shopify/active_merchant/tree/master/lib/active_merchant/billing/integrations">of</a> payment system <a href="https://github.com/Shopify/active_merchant/tree/master/lib/active_merchant/billing/integrations">integration</a> in ActiveMerchant, you can see how the same code can flow into many modules, in some files the code can be a combination of code from several modules and so on, but nowhere are there any complex scripts.  I had to write a lot of my own, in particular for the implementation of background requests, so I‚Äôm afraid that the request request will not be approved, although in fact I saved all the possibilities and ideas that the base classes carry in my implementation, just added some new ones. <br><br>  What happened in the end you can see <a href="https://github.com/ovcharik/active_merchant/compare/dengionline">here</a> .  The only thing that leaves my general helper concept framework is data validation, but in general it is completely unnecessary, it should be used only with background queries to avoid possible errors even before the query (in spite of this in my case) when implementing the payment system on the site, I had to get around this dirty-hacking), and some query parameters are also automatically set in <a href="http://dengionline.com/dev/protocol/invoice">special</a> cases so that the developer would not have to deal with the protocol for a long time.  Even my helper has the ability to send a background request, if this is done for a valid mode_type, then the answer will automatically match and this answer will be convenient to work with. <br><br>  I can‚Äôt say that the code turned out to be good, because I‚Äôve been familiar with Ruby for about three months, so I will be happy with any help or advice, I‚Äôm also willing to help those who want to integrate any payment system into ActiveMerchant. <br><br><h5>  An example of creating a payment system on the site </h5><br>  The first step is to enable ActiveMerchant in the project, for this we add it to the Gemfile <br><pre><code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">'activemerchant'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:git</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"https://github.com/ovcharik/active_merchant.git"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:branch</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"dengionline"</span></span></code> </pre> <br>  For now, you can add it this way, but I sent the <a href="https://github.com/Shopify/active_merchant/pull/874">pool request</a> to the official repository, and it may be approved soon. <br><br>  Next, create the necessary routers <br><pre> <code class="ruby hljs">scope <span class="hljs-string"><span class="hljs-string">'top_up'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post <span class="hljs-string"><span class="hljs-string">'create'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'top_up#create'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:as</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'top_up_create'</span></span> post <span class="hljs-string"><span class="hljs-string">'notify'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'top_up#notify'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:as</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'top_up_notify'</span></span> post <span class="hljs-string"><span class="hljs-string">'check'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'top_up#check'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:as</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'top_up_check'</span></span> match <span class="hljs-string"><span class="hljs-string">'success'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'top_up#success'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:as</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'top_up_success'</span></span> match <span class="hljs-string"><span class="hljs-string">'fail'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'top_up#fail'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:as</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'top_up_fail'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><ul><li>  create is used to create a payment object and to issue an invoice, in principle it is not mandatory or its logic can be placed elsewhere, but it was more convenient for me to do this. </li><li>  success and fail are callbacks to which the user will be redirected after the completion of the transaction, by the way, no parameters are returned to these callbacks from the system. </li><li>  notify and check are needed to confirm the payment and check the correctness of the data by the payment system on the site, respectively, at these addresses the payment system will make push requests with certain parameters. </li></ul><br>  The last 4 addresses are indicated by the payment system when registering with it: in the process it will be necessary to fill in a questionnaire with points to these addresses.  The site itself does not provide the possibility of changing addresses, and this is done only through additional requests for support, so I had to test a lot right in production (despite the fact that the project was launched at the development stage and for users it had no effect). <br><br>  In the project that I am doing, this scenario occurs when paying for services: the user clicking the Pay button sends an ajax request to / top_up / create, the data is checked there, then the background request is sent to the payment system, the successful response is displayed to the user, errors are processed separately .  In my case, as a successful response, a form comes with hidden fields and immediately after it is a script that will send this form, that is, if you display this answer somewhere on the page, the user will be implicitly redirected to the gateway page, where he can complete payment. <br><br>  During a background request, the following happens: I make a background request, the system checks all data and if it is correct, it calls the / top_up / check method, where it should receive a positive response, after checking the system returns the necessary data. <br><br>  The user sees the form on the gateway site, where he needs to specify the details, and after clicking the ‚ÄúPay‚Äù button, the gateway checks the data in the Money Online system, which in turn checks the data in the project (again at / top_up / check), receives an answer and sends it to the payment gateway.  It confirms the payment and notifies the payment system about it, and it already sends a notification to the site (/ top_up / notify), and at the same time, the user is returned to the callback. <br><br><div class="spoiler">  <b class="spoiler_title">Perhaps it's easier to understand this process just by seeing the logs</b> <div class="spoiler_text"><pre> <code class="hljs vbscript">Started POST <span class="hljs-string"><span class="hljs-string">"/ru/top_up/create"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user_ip at <span class="hljs-number"><span class="hljs-number">2013</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> +<span class="hljs-number"><span class="hljs-number">0400</span></span> Processing by TopUpController#create as */* Parameters: {<span class="hljs-string"><span class="hljs-string">"amount"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"authenticity_token"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"token"</span></span>, <span class="hljs-string"><span class="hljs-string">"currency"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"RUB"</span></span>, <span class="hljs-string"><span class="hljs-string">"order"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"78"</span></span>, <span class="hljs-string"><span class="hljs-string">"lang"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"ru"</span></span>} Started POST <span class="hljs-string"><span class="hljs-string">"/top_up/check"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> deingionline_ip at <span class="hljs-number"><span class="hljs-number">2013</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> +<span class="hljs-number"><span class="hljs-number">0400</span></span> Processing by TopUpController#check as */* Parameters: {<span class="hljs-string"><span class="hljs-string">"amount"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"userid"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"example@mail.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"userid_extra"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"58"</span></span>, <span class="hljs-string"><span class="hljs-string">"paymentid"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"key"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"key1"</span></span>} Rendered text template (<span class="hljs-number"><span class="hljs-number">0.0</span></span>ms) Completed <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>ms (Views: <span class="hljs-number"><span class="hljs-number">1.1</span></span>ms | ActiveRecord: <span class="hljs-number"><span class="hljs-number">2.5</span></span>ms) Completed <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">557</span></span>ms (Views: <span class="hljs-number"><span class="hljs-number">0.5</span></span>ms | ActiveRecord: <span class="hljs-number"><span class="hljs-number">11.1</span></span>ms) Started POST <span class="hljs-string"><span class="hljs-string">"/top_up/check"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> deingionline_ip at <span class="hljs-number"><span class="hljs-number">2013</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> +<span class="hljs-number"><span class="hljs-number">0400</span></span> Processing by TopUpController#check as */* Parameters: {<span class="hljs-string"><span class="hljs-string">"amount"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"userid"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"example@mail.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"userid_extra"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"58"</span></span>, <span class="hljs-string"><span class="hljs-string">"paymentid"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"key"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"key1"</span></span>} Rendered text template (<span class="hljs-number"><span class="hljs-number">0.0</span></span>ms) Completed <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>ms (Views: <span class="hljs-number"><span class="hljs-number">1.0</span></span>ms | ActiveRecord: <span class="hljs-number"><span class="hljs-number">1.9</span></span>ms) Started POST <span class="hljs-string"><span class="hljs-string">"/top_up/notify"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> deingionline_ip at <span class="hljs-number"><span class="hljs-number">2013</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> +<span class="hljs-number"><span class="hljs-number">0400</span></span> Processing by TopUpController#notify as */* Parameters: {<span class="hljs-string"><span class="hljs-string">"amount"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"1.00"</span></span>, <span class="hljs-string"><span class="hljs-string">"userid"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"example@mail.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"userid_extra"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"58"</span></span>, <span class="hljs-string"><span class="hljs-string">"paymentid"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"123456789"</span></span>, <span class="hljs-string"><span class="hljs-string">"paymode"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"mode_type"</span></span>, <span class="hljs-string"><span class="hljs-string">"orderid"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"58"</span></span>, <span class="hljs-string"><span class="hljs-string">"key"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"key2"</span></span>} Rendered text template (<span class="hljs-number"><span class="hljs-number">0.0</span></span>ms) Completed <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">127</span></span>ms (Views: <span class="hljs-number"><span class="hljs-number">0.9</span></span>ms | ActiveRecord: <span class="hljs-number"><span class="hljs-number">15.2</span></span>ms) Started <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> <span class="hljs-string"><span class="hljs-string">"/top_up/success"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user_ip at <span class="hljs-number"><span class="hljs-number">2013</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span> +<span class="hljs-number"><span class="hljs-number">0400</span></span> Processing by TopUpController#success as HTML Rendered ... Completed <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>ms (Views: <span class="hljs-number"><span class="hljs-number">16.6</span></span>ms | ActiveRecord: <span class="hljs-number"><span class="hljs-number">0.7</span></span>ms)</code> </pre><br></div></div><br>  In the logs you can see which parameters are transmitted in all cases, and that when accessing / top_up / check the payment system does not transmit the orderid (internal payment identifier in the project, paymentid is the identifier in the payment system), therefore, it was decided to use the userid_extra parameter to identify the payment, but here, too, you need to be careful, as in <a href="http://dengionline.com/dev/protocol/notification">some</a> cases it is not returned, you can specify the internal payment number in the userid, but in your personal account in the payment system, you can view all transactions, as well as select  this parameter, and if you use a unique identifier as this parameter, then the utility of the sample will be zero. <br><br><div class="spoiler">  <b class="spoiler_title">Controller</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TopUpController</span></span></span><span class="hljs-class"> &lt; ApplicationController </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActiveMerchant::Billing::Integrations</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#    create skip_before_filter :verify_authenticity_token, :except =&gt; [:create] #     ActiveMerchant before_filter :create_notification, :only =&gt; [:check, :notify] #    before_filter :find_payment, :only =&gt; [:check, :notify] #   def create authorize! :create, Payment r = { :success =&gt; false, :errors =&gt; {:base =&gt; []} } errors = false #    ,      #   activemerchant     </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Payment.new({ :user =&gt; current_user, :amount =&gt; params[:amount] }) #   unless errors or </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.save r[:errors].merge! </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.errors.messages errors = true end unless errors #    ActiveMerchant helper=Dengionline.helper </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.id, CONFIG["dengionline"]["project"], { :amount =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.amount, :nickname =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.user.email, #     :nick_extra =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.id, #         :transaction_type =&gt; CONFIG["dengionline"]["mode_type"], #           :source =&gt; CONFIG["dengionline"]["source"], #  ,       :secret =&gt; CONFIG["dengionline"]["secret"], #    ,      , :method =&gt; :credit_card, :mode =&gt; :background } begin #    ,    mode_type   #  ,    ,   - #      ,    xml, #     # ,       mode_type #       if (helper.valid? or helper.errors.size &gt; 1 or helper.errors[0] != "mode_type") r[:errors][:base] &lt;&lt; I18n.t("views.top_up.create.technical_error") break end #   ,     #       response = helper.background_request! #      ,   xml #    if response.errors.empty? and response.fail? r[:errors][:base] &lt;&lt; response.comment break end #    parse_error -  ,     #      200 if (response.success? or response.errors.empty? or response.errors.size &gt; 1 or response.errors[0] != "parse_error") r[:errors][:base] &lt;&lt; I18n.t("views.top_up.create.gateway_error") break end #   parse_error,      #      ,     #    ,    r[:success] = true r[:body] = response.body end until true end render :json =&gt; r end #   def check if (</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.acknowledged? and </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> and </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.wait? and </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.valid?) render :text =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.generate_response("YES") else render :text =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.generate_response("NO") end end #   def notify if (</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.acknowledged? and </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> and </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.amount == </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.amount and </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.amount &gt; 0) #       #      #              #      saved = true if </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.wait? </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.do_payment_id = </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.payment_id </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.paid! saved = </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.save Notifier.payment_paid(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">).deliver if saved end if </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.paid? and saved render :text =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.generate_response("YES") else render :text =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.generate_response("NO") end else render :text =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.generate_response("NO") end end #      def success end def fail end private def create_notification </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Dengionline.notification(request.raw_post, { :secret =&gt; CONFIG["dengionline"]["secret"] }) end def find_payment #  ,     nil,   </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Payment.where(:id =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.nick_extra).first end end</span></span></span></span></code> </pre><br></div></div><br>  I have all the data sent in the background for the specifics of the answers, but you can use the method described <a href="http://habrahabr.ru/post/147435/">here</a> . <br><br>  I‚Äôll also give an example of using a class to get remote information about a payment, I think no one will have any problems using it. <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="hljs rust">$ rails c irb(main):<span class="hljs-number"><span class="hljs-number">001</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>&gt; Dengionline = ActiveMerchant::Billing::Integrations::Dengionline =&gt; ActiveMerchant::Billing::Integrations::Dengionline irb(main):<span class="hljs-number"><span class="hljs-number">002</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>&gt; status = Dengionline.status <span class="hljs-number"><span class="hljs-number">69</span></span>, <span class="hljs-number"><span class="hljs-number">1234</span></span>, :secret =&gt; <span class="hljs-string"><span class="hljs-string">"secret"</span></span> =&gt; #&lt;ActiveMerchant::Billing::Integrations::Dengionline::Status:<span class="hljs-number"><span class="hljs-number">0xb805bb4</span></span>&gt; irb(main):<span class="hljs-number"><span class="hljs-number">003</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>&gt; status.to_hash =&gt; { <span class="hljs-string"><span class="hljs-string">"id"</span></span>=&gt;<span class="hljs-number"><span class="hljs-number">123456789</span></span>, <span class="hljs-string"><span class="hljs-string">"amount_rub"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"1.00"</span></span>, <span class="hljs-string"><span class="hljs-string">"status"</span></span>=&gt;<span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-string"><span class="hljs-string">"status_description"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"Success"</span></span>, <span class="hljs-string"><span class="hljs-string">"order"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"69"</span></span>, <span class="hljs-string"><span class="hljs-string">"nick"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"example@mail.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"date_payment"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"2013-10-05T13:00:00+04:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"paymode"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"mode_type"</span></span>, <span class="hljs-string"><span class="hljs-string">"currency_project"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"RUB"</span></span>, <span class="hljs-string"><span class="hljs-string">"amount_project"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"1.00"</span></span>, <span class="hljs-string"><span class="hljs-string">"currency_paymode"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"RUB"</span></span> }</code> </pre><br></div></div><br>  In this example, the internal payment identifier is passed as the main parameter; if you did not use it when issuing an invoice, you can send the payment system identifier of the payment system, for this purpose specify: payment =&gt; payment_id. <br><br><ul><li>  <a href="https://github.com/Shopify/active_merchant">ActiveMerchant</a> </li><li>  <a href="https://github.com/ovcharik/active_merchant/tree/dengionline">Fork</a> </li><li>  <a href="http://dengionline.com/">Money Online</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/196978/">https://habr.com/ru/post/196978/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196966/index.html">Non-standard solution of one problem with ProjectEuler</a></li>
<li><a href="../196968/index.html">Mozilla has released Firefox OS 1.1</a></li>
<li><a href="../196970/index.html">Want to know how to get to FRIA?</a></li>
<li><a href="../196974/index.html">I can not believe that you throw away the book!</a></li>
<li><a href="../196976/index.html">Samsung announced the world's first smartphone with a curved screen - GALAXY Round</a></li>
<li><a href="../196980/index.html">Introduction to data analysis with Pandas</a></li>
<li><a href="../196982/index.html">Tizen - a view from the inside</a></li>
<li><a href="../196984/index.html">Pictures from external resources - good or evil?</a></li>
<li><a href="../196986/index.html">About domain and FSKN</a></li>
<li><a href="../196988/index.html">Mobile Technology Section at Russian Internet Week 2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>