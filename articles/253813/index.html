<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arrow hours on CMake</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I got a new job, I had to at an accelerated pace learn new technologies for me that are used in this company. One of these technologies was the c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arrow hours on CMake</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/0f9/b59/429/0f9b59429cb041cca2fe1f101321981c.png"><br><br>  When I got a new job, I had to at an accelerated pace learn new technologies for me that are used in this company.  One of these technologies was the <a href="http://www.cmake.org/">cmake</a> build system, which I had never encountered before. <br><br>  This system has its own built-in language for writing assembly scripts.  This very language interested me.  Soon I found out that it has the ability to calculate mathematical expressions, write and read from files, run external processes and other interesting features, which made me think of using this language as the main PL and write something tangible on it.  It will be a question of how I wrote an analog clock in cmake 2.8. <br><a name="habracut"></a><br>  To be honest, at first I had the idea to check cmake for the possibility of I / O from standard streams.  I wanted to learn how to read keystrokes, or, at worst, mouse events, which would make it possible to create some kind of interactive program, to write, for example, Tetris.  The conclusion turned out to be quite simple: <pre>  file (WRITE / dev / stdout "blabla") </pre>  But I completely refused to read the standard stream, I could not read directly from events (/ dev / input / event4 or / dev / input / mice).  So the idea to make Tetris was discarded and I decided to play around with the output, yet the ability to output directly to stdout attracted me more than the standard message () command. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I decided, since I can write directly to stdout, then I have to try writing <a href="https://en.wikipedia.org/wiki/ANSI_escape_code">escape sequences there</a> .  It would give rich possibilities: color output, cursor movement, screen cleaning and others.  Fortunately, cmake was able to output non-printable characters ‚Äî this is an ASCII operation of the string function, so I wrote the screen cleaning function: <br><pre> string (ASCII 27 ESCAPE)
 function (clrscr)
     file (WRITE / dev / stdout "$ {ESCAPE} [2J")
 endfunction (clrscr)
</pre><br>  Since the escape codes were working, I decided to learn how to display text in arbitrary coordinates as the next step: <br><pre> function (textXY XY MSG)
     file (WRITE / dev / stdout "$ {ESCAPE} [$ {Y}; $ {X} H $ {MSG}")
 endfunction (textXY)
</pre><br>  Well, the next logical continuation of this idea was born to write a line drawing function.  Here, we had to face the first difficulties: <br><ol><li>  cmake evaluates the expression written to a string and its integer result; </li><li>  functions in cmake do not return a value; </li><li>  I want to have a universal line drawing algorithm, independent of the location of the ends relative to each other; </li></ol><br>  I began to solve these difficulties from the end.  First, the line drawing algorithm was invented: <br><ol><li>  Find the difference of the coordinates of the ends Dx = x2-x1 and Dy = y2-y1 taking into account the minus (it will be needed for the direction); </li><li>  Find the maximum modulo delta Dmax = max (abs (Dx), abs (Dy)); </li><li>  Run through the cycle i = 0..Dmax, at each step, calculating the current coordinates using the formulas: <pre>	 x = x1 + i * Dx / Dmax
	 y = y1 + i * Dy / Dmax </pre></li></ol><br>  Secondly, the functions of searching for the maximum and absolute value were needed.  Since the functions in cmake do not return values, I had to use macros.  In macros, you can substitute both variables and values.  It seemed to me that to substitute variables more beautifully everywhere, but the macro turns out to be too "hairy", so in the future I began to use variable substitution only for the result. <br><br><div class="spoiler">  <b class="spoiler_title">Macro code</b> <div class="spoiler_text"><pre> macro (max abm)
	 if ($ {a} LESS $ {$ {b}})
		 set ($ {m} $ {$ {b}})
	 else ($ {a} LESS $ {$ {b}})
		 set ($ {m} $ {$ {a}})
	 endif ($ {a} LESS $ {$ {b}})
 endmacro (max)

 macro (abs a res)
	 if ($ {a} LESS 0)
		 string (LENGTH $ {a} len)
		 math (EXPR l1 "$ {len} - 1")
		 string (SUBSTRING $ {a} 1 $ {l1} $ {res})
	 else ($ {a} LESS 0)
		 set ($ {res} $ {a})
	 endif ($ {a} LESS 0)
 endmacro (abs)
</pre><br></div></div><br>  To search for an absolute value, we use the fact that cmake operates with strings and simply ‚Äúbites off‚Äù a minus, if there is one. <br><br>  When the macros were ready, when trying to calculate expressions for coordinates using the command <pre>  math (EXPR &lt;result&gt; &lt;expression&gt;) </pre>  I recognized the interesting nuances associated with the fact that cmake operates on strings, so, for example, the expression "$ {a} + $ {b}", in the case when b is negative, will not be calculated (as it may happen that something like 5 + -6, and such an expression is not valid).  We managed to get around this nuance by a tricky rule ‚Äî wherever a negative value of a variable can occur in a formula, add a leading 0 to it and put all this in brackets: "$ {a} + (0 $ {b})".  The final line drawing function is: <br><br><div class="spoiler">  <b class="spoiler_title">Function code line (x1 y1 x2 y2 chr)</b> <div class="spoiler_text"><pre> function (line x1 y1 x2 y2 chr)
	 math (EXPR Dx "$ {x2} - $ {x1}")
	 abs ($ {Dx} aDx)
	 math (EXPR Dy "$ {y2} - $ {y1}")
	 abs ($ {Dy} aDy)
	 max (aDx aDy Dmax)
	 set (i 0)
	 while (i LESS $ {Dmax})
		 math (EXPR cx "$ {x1} + $ {i} * (0 $ {Dx}) / $ {Dmax}")
		 math (EXPR cy "$ {y1} + $ {i} * (0 $ {Dy}) / $ {Dmax}")
		 textXY ($ {cx} $ {cy} $ {chr})
		 math (EXPR i "$ {i} + 1")
	 endwhile (i LESS $ {Dmax})
 endfunction (line)
</pre><br></div></div><br>  After testing the line drawing function, an idea appeared to apply it somewhere (for example, ‚Äúgash‚Äù the analogue clock).  Before that, I did not know at all that something interesting could be done with all this.  It turned out that almost everything is ready, it remains to draw the dial, get time from the system, calculate the necessary angles, draw 3 lines at the right angles (hour, minute and second hands) and the clock will be ready.  Two more functions were missing: sine and cosine, for drawing a circle and drawing a line at a given angle. <br><br>  The matter was complicated by the fact that sine and cosine have values ‚Äã‚Äãin the interval [0; 1], and cmake operates only with integer values, so it was decided to use a factor of 1000: find the sine and cosine times 1000, and in the expression where they are used to divide all by this factor. <br><br>  To implement trigonometric functions, their <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D1%258F%25D0%25B4_%25D0%25A2%25D0%25B5%25D0%25B9%25D0%25BB%25D0%25BE%25D1%2580%25D0%25B0">Maclaurin series</a> decomposition is used.  And again the difficulties: <br><ol><li>  I do not want to use too high degrees and factorials in a number of Maclaurin; </li><li>  When using the first 2-3 terms of the series, good approximations are obtained only in the interval [-pi / 2;  pi / 2]. </li></ol><br>  I also wanted to have a TLD at least in the interval [-pi;  2 * pi], for this it was decided to convert the angle in radians to the right half-plane, making an amendment to the sign of the function.  Technically, the <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D1%2580%25D0%25B8%25D0%25B3%25D0%25BE%25D0%25BD%25D0%25BE%25D0%25BC%25D0%25B5%25D1%2582%25D1%2580%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B5_%25D1%2584%25D1%2583%25D0%25BD%25D0%25BA%25D1%2586%25D0%25B8%25D0%25B8">geometrical meaning and formulas of the cast are here</a> , so I don‚Äôt chew much.  The final code of trigonometric functions turned out to be rather ‚Äúugly‚Äù: <br><br><div class="spoiler">  <b class="spoiler_title">Sine and Cosine Code</b> <div class="spoiler_text"><pre> set (PI1000 3142)
 set (PI500 1571)
 set (_PI500 -1571)
 set (_2PI1000 6283)

 macro (m_rad1000_4sin x res)
	 math (EXPR rad1000 "(0 $ {x}) * $ {PI1000} / 180")
	 if (rad1000 GREATER $ {PI1000})
		 math (EXPR rad1000_ "$ {PI1000} - $ {rad1000}")
	 else (rad1000 GREATER $ {PI1000})
		 set (rad1000_ $ {rad1000})
	 endif (rad1000 GREATER $ {PI1000})
	
	 if (rad1000_ GREATER $ {PI500})
		 math (EXPR rad1000__ "$ {PI1000} - $ {rad1000_}")
	 else (rad1000_ GREATER $ {PI500})
		 if (rad1000_ LESS $ {_ PI500})
			 abs ($ {rad1000_} abs_rad1000_)
			 math (EXPR rad1000__ "$ {abs_rad1000_} - $ {PI1000}")
		 else (rad1000_ LESS $ {_ PI500})
			 set (rad1000__ $ {rad1000_})
		 endif (rad1000_ LESS $ {_ PI500})
	 endif (rad1000_ GREATER $ {PI500})
	
	 set ($ {res} $ {rad1000__})
 endmacro (m_rad1000_4sin)

 macro (m_rad1000_4cos x res)
	 math (EXPR rad1000 "(0 $ {x}) * $ {PI1000} / 180")
	 if (rad1000 GREATER $ {PI1000})
		 math (EXPR rad1000_ "$ {rad1000} - $ {_ 2PI1000}")
	 else (rad1000 GREATER $ {PI1000})
		 set (rad1000_ $ {rad1000})
	 endif (rad1000 GREATER $ {PI1000})
	
	 set ($ {res} $ {rad1000_})
 endmacro (m_rad1000_4cos)

 macro (sin1000 x res)
	 m_rad1000_4sin ($ {x} r1000)
	 math (EXPR $ {res} "0 $ {r1000} - (0 $ {r1000}) * (0 $ {r1000}) / 1000 * (0 $ {r1000}) / 1000/6 + (0 $ {r1000} ) * (0 $ {r1000}) / 1000 * (0 $ {r1000}) / 1000 * (0 $ {r1000}) / 1000 * (0 $ {r1000}) / 1000/120 ")
 endmacro (sin1000)

 macro (cos1000 x res)
	 m_rad1000_4cos ($ {x} r1000)
	 unset (sign)
	 if (r1000 GREATER $ {PI500})
		 math (EXPR r1000_ "$ {PI1000} - $ {r1000}")
		 set (r1000 $ {r1000_})
		 set (sign "0-")
	 endif (r1000 GREATER $ {PI500})
	
	 if (r1000 LESS $ {_ PI500})
		 math (EXPR r1000_ "$ {PI1000} + (0 $ {r1000})")
		 set (r1000 $ {r1000_})
		 set (sign "0-")
	 endif (r1000 LESS $ {_ PI500})
	
	 math (EXPR $ {res} "$ {sign} (1000 - (0 $ {r1000}) * (0 $ {r1000}) / 1000/2 + (0 $ {r1000}) * (0 $ {r1000}) / 1000 * (0 $ {r1000}) / 1000 * (0 $ {r1000}) / 1000/24 ‚Äã‚Äã- (0 $ {r1000}) * (0 $ {r1000}) / 1000 * (0 $ {r1000}) / 1000 * (0 $ {r1000}) / 1000 * (0 $ {r1000}) / 1000 * (0 $ {r1000}) / 1000/720) ")
 endmacro (cos1000)
</pre><br></div></div><br>  After that, the rest was already a matter of technique - to draw 12 numbers in a circle, spin in a loop and ask the system for time;  when it has changed, erase the old arrows and draw new ones at the right angles.  Time is obtained by running an external process: <pre>  execute_process (COMMAND "date" "+% H% M% S" OUTPUT_VARIABLE time) </pre>  select substrings from time and calculate the angles - in the framework of school mathematics. <br><br>  The full code can be viewed on the <a href="https://github.com/Arjunarus/CMakeExp">githaba</a> . <br>  It was tested on cmake version 2.8.12.2, Ubuntu 12.04, 14.04. </div><p>Source: <a href="https://habr.com/ru/post/253813/">https://habr.com/ru/post/253813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253799/index.html">zabbix_sender over HTTP - how to send data to Zabbix via HTTP | S</a></li>
<li><a href="../253801/index.html">Python Meetup 02.27.15: Hy and Toga</a></li>
<li><a href="../253805/index.html">Dynamic webpage update</a></li>
<li><a href="../253809/index.html">Puffer and the gifts of "Life"</a></li>
<li><a href="../253811/index.html">Poorly Documented Linux Features</a></li>
<li><a href="../253815/index.html">33 million court decisions of various courts of the Russian Federation have become public data</a></li>
<li><a href="../253817/index.html">Weekly build Vivaldi 1.0.135.2</a></li>
<li><a href="../253819/index.html">Using C # and Wix # to create msi packages</a></li>
<li><a href="../253821/index.html">Tool Preview and SDK for Windows 10 Application Development</a></li>
<li><a href="../253823/index.html">Mystical data center</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>