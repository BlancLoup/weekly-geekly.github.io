<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration testing to check for memory leaks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We write a lot of unit tests, developing a SoundCloud application for iOS. Unit tests look great. They are short, (hopefully) readable, and they give ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration testing to check for memory leaks</h1><div class="post__text post__text-html js-mediator-article">  We write a lot of unit tests, developing a <b>SoundCloud</b> application for iOS.  Unit tests look great.  They are short, (hopefully) readable, and they give us confidence that the code we write works as expected.  But unit tests, as their name implies, cover only one block of code, most often a function or class.  So, how to catch the errors that exist in the interactions between classes - errors, such as <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D1%2582%25D0%25B5%25D1%2587%25D0%25BA%25D0%25B0_%25D0%25BF%25D0%25B0%25D0%25BC%25D1%258F%25D1%2582%25D0%25B8">memory leaks</a> ? <br><a name="habracut"></a><br><br><h3>  Memory Leaks / Memory Leaks </h3><br>  Sometimes detecting a memory leak error is quite difficult.  There is a possibility of having a strong reference to the delegate, but there are also such errors that are much more difficult to detect.  For example, is it obvious that the following code may contain a memory leak? <br><br><pre><code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UseCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> delegate: <span class="hljs-type"><span class="hljs-type">UseCaseDelegate?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> service: <span class="hljs-type"><span class="hljs-type">Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(service: <span class="hljs-type"><span class="hljs-type">Service</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.service = service } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { service.makeRequest(handleResponse) } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(response: ServiceResponse)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// some business logic and then... delegate.operationDidComplete() } }</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since the <i>Service is</i> already being implemented, there are no guarantees regarding its behavior.  By <i>passing the handleResponse</i> to the private function that captures <b>self</b> , we provide the <i>Service with a</i> strong reference to <i>UseCase</i> .  If the <i>Service</i> decides to keep this link - and we have no guarantees that this will not happen - in this case there is a memory leak.  But with a cursory study of the code, it is not obvious that this can really happen. <br><br>  There is also a great <a href="https://www.swiftbysundell.com/posts/using-unit-tests-to-identify-avoid-memory-leaks-in-swift">post by John Sandell</a> about using unit tests to detect memory leaks for classes.  But with the example given above, where it is very easy to skip a memory leak, it is not always clear how it is necessary to write such a unit test.  (We, of course, speak here not from the point of view of experience.) <br><br>  As Guilherme wrote in his <a href="https://developers.soundcloud.com/blog/how-we-develop-new-features-using-offsites-and-clean-architecture">recent post</a> , the new features in the SoundCloud app for iOS are written in accordance with "pure architectural patterns" - most often this is a <b>VIPER</b> type.  Most of these <b>VIPER</b> modules are built using what we call a <b>ModuleFactory</b> .  This <b>ModuleFactory</b> takes some input, dependencies, and configuration ‚Äî and creates a <b>UIViewController</b> , which is already connected to the rest of the module and can be placed on the navigation stack. <br><br>  In this <b>VIPER</b> module there can be several delegates, observers, and escaping closures, each of which can cause the controller to remain in memory after its removal from the navigation stack.  When this happens, the memory will grow and the operating system may well decide to terminate the application. <br><br>  So is it possible to cover as many potential leaks by writing as few unit tests as possible?  If not, then it was all a waste of time. <br><br><h3>  Integration tests </h3><br>  The answer, as one might guess from the title of this post, is yes.  And we do this with integration testing.  The goal of the integration test is to check how objects interact with each other.  Of course, <b>VIPER</b> modules are groups of objects; memory leaks are a form of interaction that we definitely want to avoid. <br><br>  Our plan is simple: We are going to use our <i>ModuleFactory</i> to create an instance of the <b>VIPER</b> module.  Then we will delete the link to the <i>UIViewController</i> and make sure that all the important parts of the module are destroyed with it. <br><br>  The first problem we encountered is that, by nature, we cannot easily access any part of the <b>VIPER</b> module, except for the <i>UIViewController</i> .  The only <i>public</i> function in our <b>ModuleFactory</b> is <i>func make () -&gt; UIViewController</i> .  But what if we add another entry point just for our tests?  This new method will be declared via <b>internal</b> , so we can access it only through the <i>@testable importing</i> - <i>ModuleFactory</i> framework.  It will return links to all the most important parts of the module, which we could then retain for weak links to enter in our test.  This ultimately looks like this: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModuleFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     ,   ... public func make() -&gt; UIViewController { makeAndExpose().view } typealias ModuleComponents = ( view: UIViewController, presenter: Presenter, Interactor: Interactor ) func makeAndExpose() -&gt; ModuleComponents { // Set up code, and then... return ( view: viewController, presenter: presenter, interactor: interactor ) } }</span></span></code> </pre><br><br>  This solves the problem of the lack of direct access to the object data.  Obviously, this is not ideal, but it meets our needs, so let's move on to writing a test.  It will look like this: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModuleMemoryLeakTests</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XCTestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      .     //    . private var view: UIViewController? //        //   ,    // UIKit,   UIViewController  . private weak var presenter: Presenter? private weak var interactor: Interactor? //   setUp    ModuleFactory  //   makeAndExpose.     ,   //     ModuleComponents // ,          . //     . func setUp() { super.setUp() let moduleFactory = ModuleFactory(/* mocked dependencies &amp; config */) let components = moduleFactory.makeAndExpose() view = components.view presenter = components.presenter interactor = components.interactor } //   ,   tearDown   , //        ,     ,   //     . func tearDown() { view = nil presenter = nil interactor = nil super.tearDown() } func test_module_doesNotLeakMemory() { //   ,      . //      ,  //          setUp. XCTAssertNotNil(presenter) XCTAssertNotNil(interactor) //        . //    ,   //     ,    //      . view = nil // ,  ,    //  Presenter  Interactor   . //  ,       //  ,    . XCTAssertNil(presenter) XCTAssertNil(interactor) } }</span></span></code> </pre><br><br>  So, we have an easy way to detect memory leaks in the <b>VIPER</b> module.  It is by no means ideal and requires some user work for each new module that we want to test, but this is certainly a lot less work than writing separate unit tests for each possible memory leak.  It also helps to identify memory leaks, which we do not even suspect.  In fact, after writing several of these tests, we found that we have a test that does not pass, and after some research we found a memory leak in the module.  After correction, the test should be repeated. <br><br>  It also gives us a starting point for writing a more general set of integration tests for modules.  In the end, if we just keep a strong link to the <b>Presenter</b> and replace the <b>UIViewController</b> with a <b>mock</b> , then we can fake user input, then call the methods of the presenter, and check the dummy data on the <b>View</b> . </div><p>Source: <a href="https://habr.com/ru/post/459220/">https://habr.com/ru/post/459220/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459208/index.html">Running with prostheses: nekstgen simulation of human movement with the help of muscles, bones and neural networks</a></li>
<li><a href="../45921/index.html">Home server - AMD, Debian x64, Bind9, Apache 2, PHP5, MySQL5, Trac, Subversion and a lot of fun</a></li>
<li><a href="../459212/index.html">Implementing properties in C ++</a></li>
<li><a href="../459214/index.html">Fault tolerance in storage Qsan</a></li>
<li><a href="../459216/index.html">B-tree data structure</a></li>
<li><a href="../459224/index.html">From a realtor to a game developer 2. "Operation: Android"</a></li>
<li><a href="../459226/index.html">‚ÄúFast-PoE and Perpetual-PoE are new standards or not?‚Äù</a></li>
<li><a href="../459230/index.html">A trip to the call center and Product Backlog through the eyes of the developer</a></li>
<li><a href="../459232/index.html">Surround, bite, cut: new Mini AI Cup competition # 4</a></li>
<li><a href="../459234/index.html">Smem - Reports on memory allocation between processes and users on Linux.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>