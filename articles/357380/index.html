<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Not so simple with Petya</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On June 27, 2017, a new cyber attack struck a multitude of computer systems in Ukraine and other countries. The attack was caused by a malware that ES...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Not so simple with Petya</h1><div class="post__text post__text-html js-mediator-article">  On June 27, 2017, a new cyber attack struck a multitude of computer systems in Ukraine and other countries.  The attack was caused by a malware that ESET identified as Diskcoder.C (aka ExPetr, PetrWrap, Petya, or NotPetya). <br><br>  This attack was disguised as an epidemic of the usual cryptographer - who encrypted the data on the disk and demanded $ 300 in bitcoins for data recovery.  But in fact, the plan was to inflict damage, so the author did everything they could to complicate the interpretation of the data. <br><br>  In our <a href="https://www.welivesecurity.com/2017/06/30/telebots-back-supply-chain-attacks-against-ukraine/">blog</a> , we have already attributed this attack to the TeleBots group and revealed the details of another similar chain of attacks against Ukraine.  This article reveals details about the primary distribution vector that was used for the DiskCoder.C epidemic. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, the story of the fake update. <br><a name="habracut"></a><br>  On his Facebook page, the Department of Cyber ‚Äã‚ÄãPolice in Ukraine, he <a href="https://www.facebook.com/cyberpoliceua/posts/536947343096100">said</a> that during the initial distribution phase of the malware DiskCoder.C, the popular accounting software MEDoc was used - almost a monopolist in this field in Ukraine.  But so far there are no details of exactly how this was done. <br><br>  During our research, we discovered a very cunningly hidden backdoor, which was implemented in one of the official MEDoc modules.  The execution itself looks like it would be very difficult to do without access to the source codes of MEDoc. <br><br>  The file of the infected module ZvitPublishedObjects.dll, written in the .NET Framework, is 5 megabytes in size, and contains a large amount of legal code that may be caused by other software components, including the main ezvit.exe file <br><br>  We examined all MEDoc updates that were released in 2017 and found at least three updates containing an infected module: <br><br>  <b>01.175-10.01.176</b> , dated April 14, 2017 <br>  <b>01.180-10.01.181</b> , dated May 15, 2017 <br>  <b>01.188-10.01.189</b> , dated June 22, 2017 <br><br>  The distribution of Win32 / Filecoder.AESNI.C began three days after the update <b>10.01.180-10.01.181</b> , and the distribution of DiskCoder.C began 5 days after the update <b>10.01.188-10.01.189</b> . <br><br>  What is interesting is that four updates from April 24, 2017 to May 10, 2017, and seven updates from May 17 to June 21, did NOT contain a Trojan module. <br><br>  In the updates from May 15 to May 17, there is a Trojan module, but after May 17 there are none, and this is probably one of the reasons why the spread of the first malware, namely Win32 / Filecoder.AESNI.C, was not so large. <br><br>  Perhaps the update of May 17th was unexpected for attackers.  But they again downloaded the vulnerability in the update of May 18, however, the majority of MEDoc users have already been updated with the "yesterday" patch, and the first attack was not very noticeable. <br><br>  File metadata indicates that the library was most likely compiled right on the day of the update, or perhaps a day earlier, depending on the time zone. <br><br><img src="https://habrastorage.org/web/afb/90f/892/afb90f89298540f1b5e3defe21f15b8c.png"><br><br>  <b>Timestamp</b> shows that the Trojan module was created on May 15th. <br><br><img src="https://habrastorage.org/web/295/c9d/b66/295c9db66fdf4fbb9fa465b3d4e543eb.png"><br><br>  Here we see the difference in classes between the infected and the normal module. The ILSpy .NET decompiler is used.  Classes of infected module on the left. <br><br>  The main backdoor class is <b>MeCom</b> , which is located in the ZvitPublishedObjects.Server namespace, as shown in Figure 3. <br><br><img src="https://habrastorage.org/web/408/bc4/b6d/408bc4b6da414e6383d595d86ceaea53.png"><br>  <i>MeCom class with Trojan code in ILSpy .NET Decompiler.</i> <br><br>  The methods of the MeCom class are called from the <b>IsNewUpdate</b> method in the UpdaterUtils and ZvitPublishedObjects.Server namespaces.  The <b>IsNewUpdate</b> method <b>itself</b> is called periodically to check whether new updates are available.  The infected module of May 15th works a little differently and contains fewer functions than the module of June 22nd. <br><br>  Each registered organization in Ukraine has a unique code <b><a href="https://uk.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25B4_%25D0%2584%25D0%2594%25D0%25A0%25D0%259F%25D0%259E%25D0%25A3">EDRPOU</a></b> .  And it is very important, because using EDRPOU, you can conduct a targeted attack against a particular company or organization.  Working from the inside, from the computer where the Trojan module is installed, you can use different tactics, depending on the intentions of the attackers. <br><br>  Since <b>MEDoc has</b> become very popular, it can be found on almost every accountant‚Äôs computer.  One MEDoc can serve several organizations at once, and once installed, a trojan will know about all EDRPOU on this machine to send them to attackers. <br><br><img src="https://habrastorage.org/web/b72/ac2/b37/b72ac2b371404847b38e7a088f4adc3a.png"><br>  <i>The code that EDRPOU collects.</i> <br><br>  In addition to EDRPOU, the Trojan also collects proxy and mail settings, including <b>usernames and passwords of the</b> infected MEDoc application. <br><br>  <b>Attention!</b>  <b>It is recommended to change passwords for all proxies and mail users who used MEDoc !!</b> <br><br>  Also, the malicious code writes the collected information in the Windows registry at <b>HKEY_CURRENT_USER \ SOFTWARE \ WC</b> using the names of the keys Cred and Prx.  If you find similar registry information on your computer, it means that at least Trojan code was executed on your computer. <br><br>  And finally the most tricky part.  The Trojan module did not use any external servers as control centers.  He used standard application updates from MEDoc from the official server <b>upd.me-doc.com [.] Ua</b> .  The only difference from legal requests is that the Trojan code sent the collected information back to the server through cookies. <br><br><img src="https://habrastorage.org/web/31f/daf/b92/31fdafb9243e4d499ed3c09c61f3bba7.png"><br>  <i>An HTTP request from a triple-module that contains an EDREPOU in a cookie.</i> <br><br>  We did not conduct a forensic analysis of the MEDoc server.  We already wrote on our blog that there are signs that the update server was compromised.  Therefore, we can only suspect that the attackers were able to patch the update server in order to distinguish requests from infected and non-infected machines and use this. <br><br><img src="https://habrastorage.org/web/e55/2af/275/e552af2758a648d79dcabaab293637a3.png"><br>  <i>Backdoor code that adds a cookie to the request.</i> <br><br>  And of course, the attacker should have added a way to control the infected machine.  This code received binary data from the official MEDoc update server, decrypted it with the Triple Des algorithm, unpacked it from GZip, and the result was an XML file with a set of instructions.  Thus, this Trojan turned into a full-scale platform for cyber espionage and cyber sabotage. <br><br><img src="https://habrastorage.org/web/52d/67a/07d/52d67a07dd0a44e7b3786d2ee6d990d0.png"><br>  <i>Trojan code that decrypts the list of instructions to be executed on the infected machine.</i> <br><br>  <b>Table of possible commands:</b> <br><br>  Command assignment <br><br>  <b>0 - RunCmd</b> Run shell command <br>  <b>1 - DumpData</b> decode Base64 data and save it to a file <br>  <b>2 - MinInfo</b> Collect information about the computer - OS version, bit depth, current privileges, UAC settings, proxy and mail settings (including logins and passwords) <br>  <b>3 - GetFile</b> Get file from infected computer <br>  <b>4 - Payload</b> Decode Base64 data, save it to an executable file and run it <br>  <b>5 - AutoPayload is the</b> same as the previous one, but the file should be saved as a library and supposed to be executed via rundll32.exe.  In addition, he should try to overwrite a specific DLL. <br><br>  It can be noted that the team number 5, named by the author of the malware as ‚ÄúAutoPayload‚Äù, fully fits the way DiskCoder.C originally distributed to zero-patients (the first infected machines). <br><br><img src="https://habrastorage.org/web/159/2af/7a0/1592af7a02264e91a3626539bee4c237.png"><br>  <i>The AutoPayload method that was used to run the DiskCoder.C cryptographer.</i> <br><br>  <b>findings</b> <br><br>  As our analysis shows, it was a very carefully planned and well-performed operation.  We assume that attackers had access to the source codes of MEDoc.  That they had enough time to study its code and implement a hidden vulnerability.  The total size of the installation package MEDoc is about 1.5 gigabytes, and there is no way to quickly check it for other bookmarks and vulnerabilities. <br><br>  There are still questions.  How long has this trojan been used?  What other commands besides sending malware DiskCoder.C and Win32 / Filecoder.AESNI.C were launched through this channel?  What other attacks could go long before the current situation, but went unnoticed? <br><br>  Special thanks to my colleagues <b>Fr√©d√©ric Vachon</b> and <b>Thomas Dupuy</b> for their assistance in the investigation. <br><br>  Indicators of Compromise (IoC) <br>  ESET detection names: <br>  MSIL / TeleDoor.A <br>  Legitimate servers abused by malware authors: <br>  upd.me-doc.com [.] ua <br>  SHA-1 hashes: <br><br>  7B051E7E7A82F07873FA360958ACC6492E4385DD <br>  7F3B1C56C180369AE7891483675BEC61F3182F27 <br>  3567434E2E49358E8210674641A20B147E0BD23C <br><br>  PS <br>  From the translator: <br><br>  This situation shows how poorly the state is aware of the danger of cybercrime, how bad it is that the methods of dealing with cybercriminals are not discussed with experts, and as a result, completely useless, ineffective and even harmful decisions are made in the form of locks and prohibitions. <br><br>  There are hundreds of large and dozens of major IT companies in the country that write excellent world-class software.  And these companies have repeatedly offered the state services for the creation of state IT services, with all the attributes - an adequate tender and the involvement of specialists with expertise. <br><br>  Quite even a tender can be organized in such a way that several companies are chosen for execution - someone as an author, someone as an independent auditor. <br><br>  It is obvious that such a dialogue is needed, and software that is used so widely must be certified as software of national importance. <br><br>  Update: <br>  <a href="http://www.securitylab.ru/news/487160.php">www.securitylab.ru/news/487160.php</a> - files really can be decrypted.  The author of NoPetya is demanding money, and they decrypted the file they sent as evidence. <br><br>  <a href="http://www.securitylab.ru/news/487159.php">www.securitylab.ru/news/487159.php</a> - Money was withdrawn from the bitcoin wallet of the malware authors. <br><br>  Update2: <br>  <a href="http://blog.talosintelligence.com/2017/07/the-medoc-connection.html">blog.talosintelligence.com/2017/07/the-medoc-connection.html</a> <br>  A very useful article in English, where they conducted a study with the confirmation that the Medka update server was really broken, and most likely the infection was spread not from his office, but from a fake update server.  Proofs in the form of log screenshots are attached. </div><p>Source: <a href="https://habr.com/ru/post/357380/">https://habr.com/ru/post/357380/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../357370/index.html">Another attack of a cryptographer paralyzes large companies.</a></li>
<li><a href="../357372/index.html">On board the new British aircraft carrier running Windows XP</a></li>
<li><a href="../357374/index.html">Send bitcoins useless: the author Petya blocked the mailbox</a></li>
<li><a href="../357376/index.html">Roskomnadzor, as a means of repelling DDoS</a></li>
<li><a href="../357378/index.html">FTS acquired the right to block anonymizers and VPN without trial</a></li>
<li><a href="../357382/index.html">How Slovakia stole the national top-level domain .SK</a></li>
<li><a href="../357384/index.html">How does a pension fund merge personal data</a></li>
<li><a href="../357386/index.html">China will block VPN for individuals</a></li>
<li><a href="../357388/index.html">Mozilla Firefox Add-ons Manager uses Google Analytics</a></li>
<li><a href="../357390/index.html">Partial recovery after Petya (ExPetr)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>