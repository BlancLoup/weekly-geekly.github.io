<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asynchronous operations and recreations of Activity in Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In one article on Habra ( 274635 ), a curious solution was demonstrated for transferring an object from onSaveInstanceState to onRestoreInstanceState ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asynchronous operations and recreations of Activity in Android</h1><div class="post__text post__text-html js-mediator-article"> In one article on <a href="https://habrahabr.ru/post/274635/">Habra</a> ( <a href="https://habrahabr.ru/post/274635/">274635</a> ), a curious solution was demonstrated for transferring an object from <code>onSaveInstanceState</code> to <code>onRestoreInstanceState</code> without serialization.  It uses the <code>writeStrongBinder(IBInder)</code> method of the <code>android.os.Parcel</code> class. <br><br>  This solution functions correctly until Android downloads your application.  And he has the right to do it. <br><blockquote>  ... system processes <br>  ( <a href="http://developer.android.com/intl/ru/reference/android/app/Activity.html">http://developer.android.com/intl/ru/reference/android/app/Activity.html</a> ) <br></blockquote><br><a name="habracut"></a><br>  However, this is not the main thing.  (If the application does not need to restore its state after such a restart, then this solution will also be appropriate). <br><br>  But the purpose for which such ‚Äúnon-serializable‚Äù objects are used there seemed strange to me.  There, calls from asynchronous operations are transferred through them to the <code>Activity</code> to update the displayed state of the application. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I have always thought that since the time of Smalltalk, any developer recognizes this typical design problem.  But it seems I was wrong. <br><br><h2>  Task </h2><br><ul><li>  On a command from the user ( <code>onClick()</code> ) to start an asynchronous operation </li><li>  Upon completion of the operation, display the result in the <code>Activity</code> </li></ul><br>  Special features <br><ul><li>  <code>Activity</code> activity displayed at the time of completion of the operation may be <br><ul><li>  the same from which the command came </li><li>  another instance of the same class (screen rotation) </li><li>  an instance of another class (the user went to another screen in the application) </li></ul><br></li><li>  At the time of completion of the operation, it may be that no <code>Activty</code> from the application is displayed. </li></ul><br>  In the latter case, the results should be displayed when you next open the <code>Activity</code> . <br><br><h1>  Decision </h1><br>  MVC (with active model) and Layers. <br><br><h1>  Detailed solution </h1><br>  The rest of the article is an explanation of what MVC and Layers are. <br><br>  Let me explain with a specific example.  Let us need to build an application ‚ÄúElectronic ticket to electronic queue‚Äù. <br><ol><li>  The user enters the branch of the bank, clicks the button ‚ÄúTake a ticket‚Äù in the application.  The application sends a request to the server and receives a ticket. </li><li>  When the queue comes up in the application displays the number of the window in which you want to apply. </li></ol><br>  I will get the ticket from the server using an asynchronous operation.  Also asynchronous operations will be reading the ticket from the file (after restarting) and deleting the file. <br><br>  You can build such an application from simple components.  For example: <br><ol><li>  Component where the ticket will be located ( <code>TicketSubsystem</code> ) </li><li>  <code>TicketActivity</code> where the ticket will be displayed and the button "Take a ticket" </li><li>  Class for Ticket (ticket number, position in the queue, window number) </li><li>  Class for Asynchronous Ticket Retrieval </li></ol><br>  The most interesting thing is how these components interact. <br><br>  <em>The application does not have to contain the <code>TicketSubsystem</code> component at <code>TicketSubsystem</code> .</em>  <em>Ticket could be</em> <em><br></em>  <em>in the static field <code>Ticket.currentTicket</code> , or in the field in the heir class <code>android.app.Application</code> .</em> <em><br></em>  <em>However, it is very important that the status is / no ticket originated from an object capable of performing the role</em> <em><br></em>  <em><code></code> from <code>MVC</code> ‚Äî that is, generate notifications when a ticket appears (or is replaced).</em> <br><br>  If you make <code>TicketSubsystem</code> model in <code>MVC</code> terms, then the <code>Activity</code> will be able to subscribe to events and update the ticket display when it is loaded.  In this case, the <code>Activity</code> will perform the role of <code>View</code> ( <code></code> ) in terms of <code>MVC</code> . <br><br>  Then the asynchronous operation ‚ÄúGetting a new ticket‚Äù can simply record the received ticket in <code>TicketSubsystem</code> and not take care of anything else. <br><br><h2>  Model </h2><br>  Obviously, the model must be a ticket.  However, in the application ticket can not "hang" in the air.  In addition, the ticket does not initially exist, it appears only after the completion of the asynchronous operation.  From this it follows that in the application there must be something else where the ticket will be.  Let it be <code>TicketSubsystem</code> .  The ticket itself must also be presented somehow, let it be the <code>Ticket</code> class.  Both of these classes must be able to fulfill the role of an active model. <br><br><h3>  Ways to build an active model </h3><br>  Active model - the model notifies the idea that changes have occurred in it.  <a href="https://ru.wikipedia.org/wiki/Model-View-Controller">wikipedia</a> <br><br>  In java there are several auxiliary classes for creating an active model.  For example: <br><ol><li>  <code>PropertyChangeSupport</code> and <code>PropertyChangeListener</code> from the <code>java.beans</code> package </li><li>  <code>Observable</code> and <code>Observer</code> from <code>java.util</code> </li><li>  <code>BaseObservable</code> and <code>Observable.OnPropertyChangedCallback</code> from <code>android.databinding</code> </li></ol><br>  I personally like the third way.  It supports strict naming of observable fields, thanks to the <code>android.databinding.Bindable</code> annotation.  But there are other ways, and they all fit. <br><br>  And in Groovy there is a great annotation <a href="http://docs.groovy-lang.org/2.3.2/html/api/index.html%3Fgroovy/beans/Bindable.html">groovy.beans.Bindable</a> .  Together with the possibility of a brief declaration of object properties, a very concise code is obtained (which is based on <code>PropertyChangeSupport</code> from <code>java.beans</code> ). <br><br><pre> <code class="hljs css">@<span class="hljs-keyword"><span class="hljs-keyword">groovy</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">beans</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Bindable</span></span> class TicketSubsystem { <span class="hljs-selector-tag"><span class="hljs-selector-tag">Ticket</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ticket</span></span> } @<span class="hljs-keyword"><span class="hljs-keyword">groovy</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">beans</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Bindable</span></span> class Ticket { <span class="hljs-selector-tag"><span class="hljs-selector-tag">String</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">number</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">int</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">positionInQueue</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">String</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tellerNumber</span></span> }</code> </pre><br><h2>  Representation </h2><br>  <code>TicketActivity</code> (as almost all objects related to the presentation) appears and disappears at the will of the user.  The application only needs to correctly display the data at the time the <code>Activity</code> appears and when the data changes, while the <code>Activity</code> is displayed. <br><br>  So in <code>TicketActivity</code> you need: <br><ol><li>  Update UI widgets when changing data in the <code>ticket</code> </li><li>  Connect the listener to the ticket when it appears </li><li>  Connect the listener to <code>TicketSubsytem</code> (to refresh the view when the <code>ticket</code> appears) </li></ol><br><h3>  1. Update UI widgets. </h3><br>  <em>In the examples in the article I will use <code>PropertyChangeListener</code> from <code>java.beans</code> for the sake of demonstration</em> <em><br></em>  <em>details.</em>  <em>And in the source code, the link at the bottom of the article will use the <code>android.databinding</code> library,</em> <em><br></em>  <em>as providing the most concise code.</em> <br><br><pre> <code class="java hljs">PropertyChangeListener ticketListener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyChangeListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">propertyChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PropertyChangeEvent event)</span></span></span><span class="hljs-function"> </span></span>{ updateTicketView(); } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateTicketView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ TextView queuePositionView = (TextView) findViewById(R.id.textQueuePosition); queuePositionView.setText(ticket != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-string"><span class="hljs-string">""</span></span> + ticket.getQueuePosition() : <span class="hljs-string"><span class="hljs-string">""</span></span>); ... }</code> </pre><br><h3>  2. Connecting the listener to the ticket </h3><br><br><pre> <code class="java hljs">PropertyChangeListener ticketSubsystemListener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyChangeListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">propertyChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PropertyChangeEvent event)</span></span></span><span class="hljs-function"> </span></span>{ setTicket(ticketSubsystem.getTicket()); } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTicket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ticket newTicket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ticket != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { ticket.removePropertyChangeListener(ticketListener); } ticket = newTicket; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ticket != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { ticket.addPropertyChangeListener(ticketListener); } updateTicketView(); }</code> </pre><br>  The <code>setTicket</code> method when replacing a ticket removes a subscription to events from an old ticket and subscribes to events from a new ticket.  If you call <code>setTicket(null)</code> , then <code>TicketActivity</code> unsubscribe from <code>ticket</code> events. <br><br><h3>  3. Connecting the listener to the TicketSubsystem </h3><br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTicketSubsystem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TicketSubsystem newTicketSubsystem)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ticketSubsystem != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { ticketSubsystem.removePropertyChangeListener(ticketSubsystemListener); setTicket(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } ticketSubsystem = newTicketSubsystem; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ticketSubsystem != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { ticketSubsystem.addPropertyChangeListener(ticketSubsystemListener); setTicket(ticketSubsystem.getTicket()); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPostCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onPostCreate(savedInstanceState); setTicketSubsystem(globalTicketSubsystem); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onStop(); setTicketSubsystem(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); }</code> </pre><br>  The code is pretty straightforward.  But without using special tools, you have to write quite a few operations of the same type.  For each element in the model hierarchy, you have to start a field and create a separate listener. <br><br><h2>  Asynchronous operation "Get a ticket" </h2><br>  The asynchronous operation code is also pretty simple.  The basic idea is to write the results to the <code></code> upon completion of the asynchronous operation.  A <code></code> will be updated on the notification from the <code></code> . <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetNewTicket</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> queuePosition; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String ticketNumber; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Void </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Void... params)</span></span></span><span class="hljs-function"> </span></span>{ SystemClock.sleep(TimeUnit.SECONDS.toMillis(<span class="hljs-number"><span class="hljs-number">2</span></span>)); Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); queuePosition = random.nextInt(<span class="hljs-number"><span class="hljs-number">100</span></span>); ticketNumber = <span class="hljs-string"><span class="hljs-string">"A"</span></span> + queuePosition; <span class="hljs-comment"><span class="hljs-comment">// TODO     ,    //     . return null; } @Override protected void onPostExecute(Void aVoid) { Ticket ticket = new Ticket(); ticket.setNumber(ticketNumber); ticket.setQueuePosition(queuePosition); globalTicketSubsystem.setTicket(ticket); } }</span></span></code> </pre><br>  Here the <code>globalTicketSubsystem</code> link (also referred to in <code>TicketActivity</code> ) depends on the way subsystems are built in your application. <br><br><h2>  Restoring state upon restart </h2><br>  Suppose a user clicked the button ‚ÄúTake a ticket‚Äù, the application sent a request to the server, and at that time there was an incoming call.  While the user answered the call, the answer came from the server, but the user does not know about it.  Moreover, the user pressed "Home" and launched some application that ate all the memory and the system had to unload our application. <br><br>  And our application should display the ticket received before the restart. <br><br>  To provide this functionality, I will write the ticket to a file and read it after the application starts. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReadTicketFromFileextends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">File</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">&gt; </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Void </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(File... files)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     number, positionInQueue, tellerNumber } @Override protected void onPostExecute(Void aVoid) { Ticket ticket = new Ticket(); ticket.setNumber(number); ticket.setPositionInQueue(positionInQueue); ticket.setTellerNumber(tellerNumber); globalTicketSubsystem.setTicket(ticket); } }</span></span></code> </pre><br><h2>  Layers </h2><br>  This template defines the rules by which one class is allowed to depend on other classes, so that excessive code entanglement does not occur.  In general, this is a family of templates, and I am guided by the variant of Craig Larman from the book ‚ÄúUML Application and Design Patterns‚Äù.  <a href="http://csis.pace.edu/~marchese/CS616/Lec11/se_l11.htm">Here is a chart</a> . <br><br>  The basic idea is that classes from lower levels cannot depend on classes from upper levels.  If we place our classes in the <code>Layers</code> levels, we‚Äôll get something like this: <br><img src="https://habrastorage.org/files/977/28c/715/97728c7159b54d77806475c76ab0a503.png"><br>  Please note that all the arrows that cross the level boundaries are pointing straight down!  <code>TicketActivity</code> creates a <code>GetNewTicket</code> - down arrow.  <code>GetNewTicket</code> creates a <code>Ticket</code> - down arrow.  Anonymous <code>ticketListener</code> implements the <code>PropertyChangeListener</code> interface - the down arrow.  <code>Ticket</code> notifies listeners <code>PropertyChangeListener</code> - down arrow.  Etc. <br><br>  That is, any dependencies (inheritance, use as a member type of a class, use as a type of a parameter or type of a return value, use as a type of a local variable) are allowed only to classes at the same level or lower levels. <br><br>  Another drop of theory, and move on to the code. <br><br><h3>  Level assignment </h3><br>  Objects at the <code>Domains</code> level reflect business entities with which the application works.  They should be independent of how our application is organized.  For example, the presence of the <code>positionInQueue</code> field of a <code>Ticket</code> is due to business requirements (and not the way we wrote our application). <br><br>  The <code>Application</code> level is the boundary of where the application logic can be located (except for the appearance formation).  If you need to do some useful work, the code should be here (or below). <br><br>  If you need to do something with appearance, then this is the class for the <code>Presentation</code> level.  So this class can contain only the mapping code, and no logic.  For logic, he will have to access classes from the <code>Application</code> level. <br><br>  Belonging of a class to a certain level of <code>Layers</code> is conditional.  The class is at a given level as long as it fulfills its requirements.  That is, as a result of the editing, the class may move to another level, or become unsuitable for one level. <br><br>  How to determine at what level should be given class?  I will share a modest heuristic, and generally recommend to study the available theory.  Start at least <a href="https://en.wikipedia.org/wiki/Multilayered_architecture">here</a> . <br><br>  Heuristic <br><ol><li>  If an application removes the View Level, it should be able to perform all of its functions (except for demonstrating the results).  Our application without View Level will still contain both the code for requesting a ticket, the ticket itself, and access to it. </li><li>  If an object of some class displays something, or reacts to the actions of the user, then its place is at the View Level. </li><li>  In case of inconsistencies, divide the class into several. </li></ol><br><h1>  Code </h1><br>  The repository <a href="https://github.com/SamSoldatenko/habr3">https://github.com/SamSoldatenko/habr3</a> contains the application described here, built using <code>android.databinding</code> and <code>roboguice</code> .  Look at the code, and here I briefly explain what choice I made and for what reasons. <br><div class="spoiler">  <b class="spoiler_title">Brief explanations</b> <div class="spoiler_text"><ol><li>  The <code>com.android.support:appcompat-v7</code> dependency is added because commercial development relies on this library to support older android versions. <br></li><li>  The <code>com.android.support:support-annotations</code> dependency is added to use the <code>@UiThread</code> annotation (there are many other useful annotations). <br></li><li>  Dependency <code>org.roboguice:roboguice</code> is a library for dependency injection.  Used to compose an application from parts using <a href="https://habrahabr.ru/users/inject/" class="user_link">Inject</a> annotations.  Also, this library allows you to embed resources, links to widgets and contains a mechanism for sending messages similar to CDI Events from JSR-299. <br><ul><li>  <code>TicketActivity</code> using annotation <code>@Inject</code> receives a link to <code>TicketSubsystem</code> . </li><li>  The asynchronous <code>ReadTicketFromFile</code> task using the <code>@InjectResource</code> annotation <code>@InjectResource</code> file name from the resources from which the ticket is to be loaded. </li><li>  <code>TicketSubsystem</code> using <code>@Inject</code> gets a <code>Provider</code> that it uses to create a <code>ReadTicketFromFile</code> . </li><li>  and etc. </li></ul><br></li><li>  The <code>org.roboguice:roboblender</code> creates a database of all annotations for <code>org.roboguice:roboguice</code> at compile time, which is then used at run time. <br></li><li>  Added <code>app/lint.xml</code> with settings for suppressing warnings from the <code>roboguice</code> library. <br></li><li>  The <code>dataBinding</code> option in <code>app/build.gradle</code> enables special syntax in layout files similar to <code>Expression Language</code> ( <code>EL</code> ) and includes the <code>android.databinding</code> package, which is used to make <code>Ticket</code> and <code>TicketSubsystem</code> an active model.  As a result, the presentation code is greatly simplified and replaced with declarations in the layout file.  For example: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@{ts.ticket.number}"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br></li><li>  The <code>.idea</code> folder is in <code>.gitignore</code> to use any version of <code>Android Studio</code> or <code>IDEA</code> .  The project is perfectly imported and synchronized via the <code>build.gradle</code> files. <br></li><li>  The configuration of the gradle wrapper is left unchanged (the files <code>gradlew</code> , <code>gradlew.bat</code> and the folder <code>gradle</code> ).  This is a very effective and convenient mechanism. <br></li><li>  Setting <code>unitTests.returnDefaultValues = true</code> in <code>app/build.gradle</code> .  This is a trade-off between protection against random errors in unit tests and the brevity of unit tests.  Here I prefer the shortness of the unit tests. <br></li><li>  The <code>org.mockito:mockito-core</code> library is used to create stubs in unit tests.  In addition, this library allows you to describe ‚ÄúSystem Under Test‚Äù using the annotations <code>@Mock</code> and <code>@InjectMocks</code> .  <em>When using Dependency Injection, components ‚Äúexpect‚Äù that they will be injected dependencies before using them.</em>  <em>Before the tests also need to implement all the dependencies.</em>  <em><code>Mockito</code> can create and implement stubs in the class under test.</em>  <em>This greatly simplifies the test code, especially if the fields being injected have limited visibility.</em>  <em>See GetNewTicketTest.</em> <br></li><li>  Why <code>Mockito</code> , and not <code>Robolectric</code> ? <br><ol><li>  Android developers recommend writing local unit tests in this way. </li><li>  This is the way to get the fastest pass of the ‚Äúedit‚Äù cycle - ‚Äútest run‚Äù - ‚Äúresult‚Äù (important for TDD). </li><li>  Robolectric is more suitable for integration testing than modular. </li></ol><br></li><li>  <code>org.powermock:powermock-module-junit</code> library <code>org.powermock:powermock-module-junit</code> and <code>org.powermock:powermock-api-mockito</code> .  Some things cannot be replaced with plugs.  For example, replace the static method or suppress the call to the base class method.  For these purposes, <code>PowerMock</code> replaces the class loader and corrects the byte code.  In <code>TicketActivityTest</code> , using <code>PowerMock</code> suppresses the call to <code>RoboActionBarActivity.onCreate(Bundle)</code> and sets the return value from the call to the static method <code>DataBindingUtil.setContentView</code> <br></li><li>  Why do many class fields have package local scope? <br><ol><li>  This is application code, not a library.  That is, we control all the code that uses our classes.  Consequently, there is no need to hide the fields. </li><li>  The visibility of test fields simplifies the writing of unit tests. </li></ol><br></li><li>  Why then all fields are not public? <br>  A public member of a class is a commitment made by the class to all other classes that exist and those that will appear in the future.  And package local is a commitment only to those who are in the same package at the same time.  Thus, you can change the package local field (rename, delete, add a new one) if you update all the classes in the package. <br></li><li>  Why is the <code>LogInterface log</code> variable not static? <br><ol><li>  There is no need to write the initialization code yourself.  DI does the job better. </li><li>  To make it easier to replace the logger plug.  The output to the log in certain cases is ‚Äúspecified‚Äù and checked in tests. </li></ol><br></li><li>  Why do we need <code>LogInterface</code> and <code>LogImpl</code> which are just descendants of similar classes from RoboGuice? <br>  To set the Roboguice configuration with the @ImplementedBy annotation <code>@ImplementedBy(LogImpl.class)</code> . <br></li><li>  Why is the <code>@UiThread</code> annotation for the <code>Ticket</code> and <code>TicketSubsystem</code> ? <br>  These classes are sources of <code>onPropertyChanged</code> events that are used in UI components to update the display.  It is necessary to ensure that calls will be made in the UI stream. <br></li><li>  What happens in the <code>TicketSubsystem</code> constructor? <br>  After starting the application, you need to download data from the file.  In the Android application, this is the Application.onCreate event.  But in this example, such a class has not been added.  Therefore, the moment when you need to read the file is determined by when the <code>TicketSubsystem</code> is created (only one copy is created, <code>TicketSubsystem</code> it is marked with the <code>@Singleton</code> annotation).  However, in the <code>TicketSubsystem</code> constructor, <code>TicketSubsystem</code> cannot create a <code>ReadTicketFromFile</code> , since it needs a link to a not yet created <code>TicketSubsystem</code> .  Therefore, the creation of <code>ReadTicketFromFile</code> postponed to the next UI flow cycle. <br></li><li>  To check how the application works after restarting: <br><ol><li>  Click "Take a Ticket" </li><li>  Without waiting for it to appear, click "Home" </li><li>  In the console, run <code>adb shell am kill ru.soldatenko.habr3</code> </li><li>  Launch the application </li></ol><br></li></ol><br></div></div><br>  thank </div><p>Source: <a href="https://habr.com/ru/post/281290/">https://habr.com/ru/post/281290/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281276/index.html">Testing audio conferencing with Pandora online radio</a></li>
<li><a href="../281278/index.html">Again about Electron or drawing music VK</a></li>
<li><a href="../281282/index.html">Artificial Intelligence: What Scientists Think About It</a></li>
<li><a href="../281284/index.html">Modern Trojan Horse: the story of a single investigation</a></li>
<li><a href="../281286/index.html">The digest of interesting materials for the mobile developer # 148 (April 4-10)</a></li>
<li><a href="../281292/index.html">RxSwift cheat sheet on operators (+ PDF)</a></li>
<li><a href="../281294/index.html">Clean code under the flag of AOP and hateful #WarningReal estateChange</a></li>
<li><a href="../281296/index.html">How to create your bot for Skype. What is not written in the documentation</a></li>
<li><a href="../281298/index.html">Writing Your Lisp in JavaScript</a></li>
<li><a href="../281300/index.html">Analysis of approaches for creating Landings and Longrides in Drupal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>