<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Java client for FlexMonkey, or Java-style LocalConnection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think in many teams, one way or another connected with the development of Flex-applications, sooner or later the question arises about automated pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Java client for FlexMonkey, or Java-style LocalConnection</h1><div class="post__text post__text-html js-mediator-article"><img src="http://img651.imageshack.us/img651/4523/javafm.png"><br><br>  I think in many teams, one way or another connected with the development of Flex-applications, sooner or later the question arises about automated product testing.  And the way our team develops an AIR client for online poker is completely natural, and we have the same question. <br><a name="habracut"></a><br>  At first it was worked out exclusively by the QA-team, they considered some tools, including FlexMonkey.  In particular, this <a href="http://habrahabr.ru/post/129829/">article</a> on Habr√© was not ignored. <br><br>  The testing cycle includes adding a table through the admin area, the registration process on the site, followed by downloading, installing and running the client.  For this, the Selenium Test cases were written in Java.  What to do next was not clear, since the standard FlexMonkey plugin for Selenium - FlexMonkium - can work only with Flex-applications running in the browser in the Flash-plugin, because it is written in JS and interacts with the Flash via ExternalInterface, which is absent in AIR Runtime.  In turn, the standard FlexMonkey console interacts with any Flex application, including AIR, through the pure LocalConnection Flash technology, the Java implementation of which has not existed before.  Now it exists. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It was decided to write a client to FlexMonkey in Java, the estimate was made, and I set to work.  Immediately, I would like to say that on July 19 of this year, after the completion of the main work on our library, a new generation of FlexMonkey framework (now called MonkeyTalk) was released and, after a quick acquaintance, the problems with ‚Äúcross-technology‚Äù seemed to be eliminated, by organization of client-agent connection through sockets, but I am pleased with the experience gained and I think that we will further develop this product based on the old architecture from GorillaLogic. <br><br><h5>  Prologue </h5><br>  So, first of all, it was necessary to figure out what LocalConnection is and how to work with it.  There is only one source in the entire Network, which describes, if not fully, the insides of LocalConnection, and the information there is a bit outdated.  Here is the <a href="http://osflash.org/localconnection">article</a> . <br><br>  What can we understand from this article?  That LocalConnection is a Memory File Mapping object that is 65535 bytes in size and has the name MacromediaFMOmega in the system, exclusive access to which is provided by capturing a mutex named MacromediaMutexOmega.  Here is an example map of this memory area: <br><br><img src="http://img140.imageshack.us/img140/7137/memorymap.png"><br><br>  As can be seen from the card, this protocol uses AMF coding for both versions.  AMF (Action Message Format) is a binary data presentation protocol developed by Adobe.  The AMF0 specification is available <a href="http://download.macromedia.com/pub/labs/amf/amf0_spec_121207.pdf">here</a> on AMF3 <a href="http://download.macromedia.com/pub/labs/amf/amf3_spec_121207.pdf">here</a> . <br><br>  In general, the process for receiving a message looks like this: <br><ul><li>  1. Register the listener by adding its name to the chain </li><li>  2. Capturing mutex </li><li>  3. Get the file mapping and check the recipient </li><li>  4. If we are the recipient, we read the message and reset the timestamp and the length, so we mark the message as read </li><li>  5. Repeat endlessly starting from step 2 </li></ul><br>  The message writing process looks like this: <br><ul><li>  1. Capture mutex </li><li>  2. We receive file mapping and check if the recipient exists, to which we must send a message </li><li>  3. Write the message </li><li>  4. Release the file mapping and mutex. </li></ul><br><h5>  Java part </h5><br>  Since the standard Java library lacks the normal tools for working with Memory File Mapping, it was decided to write a native <abbr title="Java Native Interface">JNI</abbr> library to work with this technology.  The library was written in C ++ in Visual Studio Express 2010 and compiled under a 32-bit architecture.  It contains methods for creating / capturing / releasing a mutex, creating / receiving / releasing a file mapping object and writing / reading to / from it, and a wrapper over the WinAPI function GetTickCount (), which is needed to get the timestamp. <br><br>  Next, the Java class LocalConnection was written, which completely rotates the interface of its Flash partner, with the exception of events.  It has a setClient () method that accepts an instance of a class that implements the LocalConnectionSink interface, which defines an onInvoke method (String method, Object ... args), which actually accepts incoming calls by the name of the target method with its parameters.  The send () method repeats the one from Flash, accepts the name of the connection, the name of the method to be called, its parameters, and puts it all into the send queue. <br><br>  In the class itself, there is a separate stream that in the loop adds a listener / reads the message, checks the recipient / writes the message.  When a new message arrives, the client's onInvoke () method is pulled.  The corresponding library from <a href="http://ru.wikipedia.org/wiki/BlazeDS">BlazeDS is</a> used as a serializer / deserializer to / from AMF.  Everything is quite simple. <br><br>  Next, we needed to adjust the message with the FlexMonkey automation-agent in our application.  It connects to the project by adding a SWC library and the input point in it is the MonkeyLink class, the protocol itself is also called. On the agent side, it registers an endpoint with the name "_agent", the client, in turn, must register under the name "_flexMonkey" .  This class contains several public methods.  The "ping" method serves for symmetric pinging of a client / agent once every half second.  During his call, the isConnected flag is set, which indicates that the opposite side is still alive and accepts messages.  By timer, every 5 seconds, this flag is cleared. <br><br>  This class also contains a number of methods that accept instances of MonkeyRunnable class heirs.  These are commands, which are actions that we see on the toolbar of the classic FlexMonkey console. <br><br>  Based on this, a Java equivalent of this class was developed, and Java analogs of FlexMonkey commands from ActionScript.  These are commands such as SetProperty, CallFunction, VerifyProperty, UIEvent, etc.  This class contains the playCommand () method, which takes an instance of a command with the necessary parameters, serializes it and sends it to the agent via LocalConnection. <br><br>  Also this class contains 2 additional streams - the first time in half a second sends a ping to the agent, and the second time in 5 seconds resets the isConnected flag. <br><br>  A wrapper is made above it in the form of the FlexMonkeyAutomator class, which provides the QA-engineer with a simple API for synchronously calling actions on the agent.  You can also specify the number of attempts to call the action and the delay between them.  In general, a session with a test application looks like this: <br><br><pre><code class="java hljs">MonkeyLink monkeyLink = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MonkeyLink(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (monkeyLink.startLink(<span class="hljs-number"><span class="hljs-number">2000</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//   ,  2  FlexMonkeyAutomator flexMonkeyAutomator = new FlexMonkeyAutomator(monkeyLink); flexMonkeyAutomator.setProperty(... flexMonkeyAutomator.storeValue(... flexMonkeyAutomator.uiEvent(... flexMonkeyAutomator.verifyProperty(... flexMonkeyAutomator.callFunction(... monkeyLink.disconnect(); }</span></span></code> </pre> <br><br>  All FlexMonkeyAutomator methods contain overloaded versions that take a timeout with the last parameter.  This is useful, in particular in this case: in the last action, we press the exit button from the application, the application closes and does not have time to send the result of the action, in this case the normal version of the action call method will never return and our test script will not hang. here the timeout version will complete safely. <br><br>  All sources of this library are available on <a href="https://bitbucket.org/Skyggedans/jmonkeylink">BitBucket</a> .  I ask you not to take seriously the JMonkeyLinkTest project, which contains a test Swing application with an abundance of govnokod - it is intended solely for situational testing of individual library features, and our QA and basic combat scripts do the main testing. <br><br>  PS: I completely forgot.  Despite the fact that when seralizing commands on the Java side, I assign them a FQDN corresponding to their FQDN in ActionScript, for some reason they are still deserialized into a regular Object, so in the application under test they need to be registered via registerClassAlias ‚Äã‚Äã(), like this: <br><pre> <code class="actionscript hljs">registerClassAlias(<span class="hljs-string"><span class="hljs-string">"com.gorillalogic.flexmonkey.monkeyCommands.CallFunctionMonkeyCommand"</span></span>, CallFunctionMonkeyCommand);</code> </pre><br>  Well, and I hope this product will benefit someone, and will also be useful to those who want to build interaction between Java and Flash / Flex code in their project through LocalConnection.  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/148706/">https://habr.com/ru/post/148706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148698/index.html">Winter holidays with benefits</a></li>
<li><a href="../148700/index.html">2GIS Online and API updates: search tips and more</a></li>
<li><a href="../148701/index.html">Protection against SQL injection in PHP and MySQL</a></li>
<li><a href="../148703/index.html">Follow the Summer Olympics with Android</a></li>
<li><a href="../148704/index.html">Corona SDK - for beginners. Working with multiple scenes using the Storyboard API</a></li>
<li><a href="../148708/index.html">New IP DECT from Grandstream DP715 / DP710</a></li>
<li><a href="../148711/index.html">Tool-assisted speedrunning</a></li>
<li><a href="../148712/index.html">The finalists of the Evernote Devcup 2012 Developer Championship are determined.</a></li>
<li><a href="../148715/index.html">Why computer vision is used very little in practice</a></li>
<li><a href="../148717/index.html">Heuristics in scheduling classes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>