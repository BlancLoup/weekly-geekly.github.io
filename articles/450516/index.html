<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Qualified macOS e-signature</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="According to RBC and Tenzor , in 2019, 4.6 million certificates of qualified electronic signatures (CEP) will be issued in Russia that meet the requir...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Qualified macOS e-signature</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ex/qt/fa/exqtfaem0qdki9aiaggndkwcpsc.png" align="left"><br><p>  According to <a href="https://www.rbc.ru/technology_and_media/21/07/2017/59721af29a794728e0a2d817">RBC</a> and <a href="https://tensor.ru/uc">Tenzor</a> , in 2019, 4.6 million certificates of qualified electronic signatures (CEP) will be issued in Russia that meet the requirements of 63-FZ.  It turns out that out of 8 million registered IP and LLC, every second entrepreneur uses an electronic signature.  In addition to CEP for USAIS and cloud CEP for the delivery of reports issued by banks and accounting services, universal CEP on protected tokens are of particular interest.  Such certificates allow you to log in to state portals and sign any documents, making them legally significant. </p><br><p>  Thanks to the CEP certificate on the USB-token, you can remotely conclude an agreement with a contractor or a remote employee, send documents to the court;  register an online cash register, settle tax arrears and submit a declaration in your personal account on nalog.ru;  find out about debts and upcoming checks on state services. </p><br><p>  The manual presented below will help <strong>to work with CEP under macOS</strong> - without studying the CryptoPro forums and installing a Windows virtual machine. </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Content</b> <div class="spoiler_text"><p>  <strong>What you need to work with CEP under macOS:</strong> </p><br><p>  <strong>Install and configure CEP for macOS</strong> </p><br><ol><li>  Installing CryptoPro CSP </li><li>  Installing Rutoken Drivers </li><li>  Installing certificates <br>  3.1.  Remove all old GOST certificates <br>  3.2.  Installing root certificates <br>  3.3.  Download certification center certificates <br>  3.4.  Installing a certificate with Rutoken </li><li>  Install a special browser Chromium-GOST </li><li>  Install browser extensions <br>  5.1 CryptoPro EDS Browser plug-in <br>  5.2.  Plugin for state services <br>  5.3.  Customize plugin for Gosuslug <br>  5.4.  Activate extensions <br>  5.5.  Configuring the CryptoPro extension. DS Browser plug-in </li><li>  We check that everything works <br>  6.1.  Go to the test page CryptoPro <br>  6.2.  Go to your account on nalog.ru <br>  6.3.  Go to the state services </li><li>  What to do if it stopped working </li></ol><br><p>  <strong>Change PIN container</strong> </p><br><ol><li>  Finding the name of the CEP container </li><li>  Change PIN command from terminal </li></ol><br><p>  <strong>Sign files in macOS</strong> </p><br><ol><li>  Figure out the CEP certificate hash </li><li>  Sign the file with the command from terminal </li><li>  Installing Apple Automator Script </li></ol><br><p>  <strong>Check the signature on the document</strong> </p></div></div><br><p>  All the information below is obtained from authoritative sources (CryptoPro <a href="https://support.cryptopro.ru/index.php%3F/Knowledgebase/Article/View/232"># 1</a> , <a href="https://www.cryptopro.ru/sites/default/files/public/faq/macoscspplugin.pdf"># 2</a> and <a href="https://support.cryptopro.ru/index.php%3F/Knowledgebase/Article/View/272"># 3</a> , <a href="https://www.rutoken.ru/manual/Rutoken_CryptoPro_MacOS.pdf">Rutoken</a> , <a href="https://www.esphere.ru/assets/download/uc/macos_ep.pdf">Korus-Consulting</a> , <a href="https://e-trust.gosuslugi.ru/">Ural Federal District Ministry of Communications</a> and <a href="https://e-trust.gosuslugi.ru/">Mass Communications</a> ), and it is suggested to download software from trusted sites.  The author is an independent consultant and is not affiliated with any of the companies mentioned.  Following this instruction, all responsibility for any actions and consequences you assume. </p><br><h2 id="chto-nuzhno-dlya-raboty-s-kep-pod-macos">  What you need to work with CEP under macOS: </h2><br><ol><li>  CEP <strong>on USB-token Rutoken Lite</strong> or <strong>Rutoken EDS</strong> </li><li>  cryptocontainer <strong>in CryptoPro format</strong> </li><li>  with built-in <strong>license for CryptoPro CSP</strong> </li><li>  the open certificate must be stored in the container of the private key </li></ol><br><p>  The eToken and JaCarta carriers in conjunction with CryptoPro under macOS are not supported.  Rukoken Lite media is an optimal choice, it costs 500..1000 = rubles. It works smartly and allows you to store up to 15 keys. </p><br><p>  VipNet, Signal-COM and LISSI crypto providers are not supported on macOS.  There is no way to convert containers.  CryptoPro is the optimal choice, the certificate cost should be about 1300 = rub.  for PI and 1600 = rub.  for YuL. </p><br><p>  Usually the annual license for CryptoPro CSP is already registered in the certificate and many CAs are provided free of charge.  If this is not the case, then it is necessary to purchase and activate a perpetual license for CryptoPro CSP strictly version 4 worth 2700 =.  CryptoPro CSP version 5 under macOS is currently not working. </p><br><p>  Usually, the public certificate is stored in the container of the private key, but this needs to be clarified when the CEP is issued and asked to be done as needed.  If it fails, then you can import the public key into a closed container yourself using CryptoPro CSP tools under Windows. </p><br><h2 id="ustanavlivaem-i-nastraivaem-kep-pod-macos">  Install and configure CEP for macOS </h2><br><div class="spoiler">  <b class="spoiler_title">Obvious things</b> <div class="spoiler_text"><ul><li>  All downloaded files are downloaded to the default directory: ~ / Downloads /; </li><li>  we do not change anything in all installers, we leave everything by default; </li><li>  if macOS displays a warning that the software being run is from an uninstalled developer - you need to confirm the launch in the system settings: <em>System Preferences -&gt; Security &amp; Privacy -&gt; Open Anyway</em> ; </li><li>  If macOS asks for a user password and permission to control a computer, you need to enter a password and agree with everything. </li></ul></div></div><br><h3 id="1-ustanavlivaem-kriptopro-csp">  1. Install CryptoPro CSP </h3><br><p>  <a href="https://www.cryptopro.ru/user/register">We are registering</a> on the CryptoPro website and downloading and installing the version of <em>CryptoPro CSP <strong>4.0 R4</strong></em> for <em>macOS</em> from the <a href="https://www.cryptopro.ru/products/csp/downloads">download page</a> . </p><br><h3 id="2-ustanavlivaem-drayvery-rutoken">  2. Install Rutoken drivers </h3><br><p>  The site says that it is optional, but better to put.  From the <a href="https://www.rutoken.ru/support/download/drivers-for-mac/">download page</a> on the Rutoken website we download and install the <em>Keychain Support Module (KeyChain)</em> - <strong><a href="https://www.rutoken.ru/support/download/get/rtPKCS11-mac-installer.html">download</a></strong> . </p><br><p>  Next, connect the usb-token, start the terminal and execute the command: </p><br><pre><code class="bash hljs">/opt/cprocsp/bin/csptest -card -enum -v</code> </pre> <br><p>  The answer should be: </p><br><blockquote>  Aktiv Rutoken ... <br>  Card present ... <br>  [ErrorCode: 0x00000000] </blockquote><br><h3 id="3-ustanavlivaem-sertifikaty">  3. Install certificates </h3><br><h4 id="31-udalyaem-vse-starye-gostovskie-sertifikaty">  3.1.  Remove all old GOST certificates </h4><br><p>  If there were previously attempts to run CEP under macOS, then all previously installed certificates should be cleaned.  These commands in the terminal will delete only CryptoPro certificates and will not affect the usual certificates from Keychain in macOS. </p><br><pre> <code class="bash hljs">sudo /opt/cprocsp/bin/certmgr -delete -all -store mroot</code> </pre> <br><pre> <code class="bash hljs">sudo /opt/cprocsp/bin/certmgr -delete -all -store uroot</code> </pre> <br><pre> <code class="bash hljs">/opt/cprocsp/bin/certmgr -delete -all</code> </pre> <br><p>  The response of each team should be: </p><br><blockquote>  No certificate matching the criteria </blockquote><p>  or </p><br><blockquote>  Deleting complete </blockquote><br><h4 id="32-ustanavlivaem-kornevye-sertifikaty">  3.2.  Installing root certificates </h4><br><p>  Root certificates are common to all CEPs issued by any certification authority.  Download from the UFD Ministry of Communications and Mass Media Communications <a href="https://e-trust.gosuslugi.ru/MainCA">download page</a> : </p><br><ul><li>  <a href="https://e-trust.gosuslugi.ru/Shared/DownloadCert%3Fthumbprint%3D4BC6DC14D97010C41A26E058AD851F81C842415A">https://e-trust.gosuslugi.ru/Shared/DownloadCert?thumbprint=4BC6DC14D97010C41A26E058AD851F81C842415A</a> </li><li>  <a href="https://e-trust.gosuslugi.ru/Shared/DownloadCert%3Fthumbprint%3D8CAE88BBFD404A7A53630864F9033606E1DC45E2">https://e-trust.gosuslugi.ru/Shared/DownloadCert?thumbprint=8CAE88BBFD404A7A53630864F9033606E1DC45E2</a> </li><li>  <a href="https://e-trust.gosuslugi.ru/Shared/DownloadCert%3Fthumbprint%3D0408435EB90E5C8796A160E69E4BFAC453435D1D">https://e-trust.gosuslugi.ru/Shared/DownloadCert?thumbprint=0408435EB90E5C8796A160E69E4BFAC453435D1D</a> </li></ul><br><p>  Install the commands in the terminal: </p><br><pre> <code class="bash hljs">sudo /opt/cprocsp/bin/certmgr -inst -store mroot -f ~/Downloads/4BC6DC14D97010C41A26E058AD851F81C842415A.cer</code> </pre> <br><pre> <code class="bash hljs">sudo /opt/cprocsp/bin/certmgr -inst -store mroot -f ~/Downloads/8CAE88BBFD404A7A53630864F9033606E1DC45E2.cer</code> </pre> <br><pre> <code class="bash hljs">sudo /opt/cprocsp/bin/certmgr -inst -store mroot -f ~/Downloads/0408435EB90E5C8796A160E69E4BFAC453435D1D.cer</code> </pre> <br><p>  Each team should return: </p><br><blockquote>  Installing: <br>  ... <br>  [ErrorCode: 0x00000000] </blockquote><br><h4 id="33-skachivaem-sertifikaty-udostoveryayuschego-centra">  3.3.  Download certification center certificates </h4><br><p>  Next, you need to install certificates of the certification center in which you issued the CEP.  Typically, the root certificates of each CA are located on its website in the download section. </p><br><p>  Alternatively, certificates of any CA can be downloaded from <a href="https://e-trust.gosuslugi.ru/CA">the UFD website of the Ministry of Communications and Mass Media</a> .  To do this, in the search form, you need to find the CA by name, go to the page with certificates and download all <strong>valid</strong> certificates - that is, those that have not yet reached the second date in the <em>'Effective'</em> field.  Download the link from the field <em>'Fingerprint'</em> . </p><br><div class="spoiler">  <b class="spoiler_title">Screenshots</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/k6/xx/q4/k6xxq4czjusuqkbsqols_hbliei.png"></p><br><p><img src="https://habrastorage.org/webt/dt/oc/tw/dtoctw3qxq3qr6sbusinltnei2y.png"></p></div></div><br><p>  Using the example of Corus-Consulting TC: you need to download 4 certificates from the <a href="https://e-trust.gosuslugi.ru/CA/View%3Fogrn%3D1057812752502">download page</a> : </p><br><ul><li>  <a href="https://e-trust.gosuslugi.ru/Shared/DownloadCert%3Fthumbprint%3D15EB064ABCB96C5AFCE22B9FEA52A1964637D101">https://e-trust.gosuslugi.ru/Shared/DownloadCert?thumbprint=15EB064ABCB96C5AFCE22B9FEA52A1964637D101</a> </li><li>  <a href="https://e-trust.gosuslugi.ru/Shared/DownloadCert%3Fthumbprint%3DB9F1D3F78971D48C34AA73786CDCD138477FEE3F">https://e-trust.gosuslugi.ru/Shared/DownloadCert?thumbprint=B9F1D3F78971D48C34AA73786CDCD138477FEE3F</a> </li><li>  <a href="https://e-trust.gosuslugi.ru/Shared/DownloadCert%3Fthumbprint%3D55EC48193B6716D38E80BD9D1D2D827BC8A07DE3">https://e-trust.gosuslugi.ru/Shared/DownloadCert?thumbprint=55EC48193B6716D38E80BD9D1D2D827BC8A07DE3</a> </li><li>  <a href="https://e-trust.gosuslugi.ru/Shared/DownloadCert%3Fthumbprint%3DA0D19D700E2A5F1CAFCE82D3EFE49A0D882559DF">https://e-trust.gosuslugi.ru/Shared/DownloadCert?thumbprint=A0D19D700E2A5F1CAFCE82D3EFE49A0D882559DF</a> </li></ul><br><p>  The downloaded CA certificates are installed with commands from terminal: </p><br><pre> <code class="bash hljs">sudo /opt/cprocsp/bin/certmgr -inst -store mroot -f ~/Downloads/B9F1D3F78971D48C34AA73786CDCD138477FEE3F.cer</code> </pre> <br><pre> <code class="bash hljs">sudo /opt/cprocsp/bin/certmgr -inst -store mroot -f ~/Downloads/A0D19D700E2A5F1CAFCE82D3EFE49A0D882559DF.cer</code> </pre> <br><pre> <code class="bash hljs">sudo /opt/cprocsp/bin/certmgr -inst -store mroot -f ~/Downloads/55EC48193B6716D38E80BD9D1D2D827BC8A07DE3.cer</code> </pre> <br><pre> <code class="bash hljs">sudo /opt/cprocsp/bin/certmgr -inst -store mroot -f ~/Downloads/15EB064ABCB96C5AFCE22B9FEA52A1964637D101.cer</code> </pre> <br><p>  where after <em>~ / Downloads / the</em> names of the downloaded files go, for each CA they will be their own. </p><br><p>  Each team should return: </p><br><blockquote>  Installing: <br>  ... <br>  [ErrorCode: 0x00000000] </blockquote><br><h4 id="34-ustanavlivaem-sertifikat-s-rutoken">  3.4.  Installing a certificate with Rutoken </h4><br><p>  Command in terminal: </p><br><pre> <code class="bash hljs">/opt/cprocsp/bin/csptestf -absorb -certs</code> </pre> <br><p>  The team must return: </p><br><blockquote>  OK. <br>  [ErrorCode: 0x00000000] </blockquote><br><h3 id="4-ustanavlivaem-specialnyy-brauzer-chromium-gost">  4. Install the special browser Chromium-GOST </h3><br><p>  To work with state portals, you will need a special chromium browser assembly - <strong>Chromium-GOST</strong> .  The source code of the project is open, the link to the <a href="https://github.com/deemru/chromium-gost/">repository on GitHub is</a> provided on <a href="https://support.cryptopro.ru/index.php%3F/Knowledgebase/Article/View/232/0/rbot-s-kriptopro-csp-v-macos">the CryptoPro website</a> .  By experience, other <em>CryptoFox</em> and <em>Yandex</em> Browser browsers are not suitable for working with public portals under macOS.  It should be noted that in some assemblies of the Chromium-GOST the personal account on nalog.ru may hang or the scroll stops working altogether, therefore the old proven <strong>build 71.0.3578.98</strong> is <strong>suggested</strong> - <strong><a href="">download</a></strong> . </p><br><p>  Download and unpack the archive, install the browser by copying or drag &amp; drop into the Applications directory.  After installation, we forcibly close Chromium-Gost with a command from terminal and are not opening yet (working from Safari): </p><br><pre> <code class="bash hljs">killall Chromium-Gost</code> </pre> <br><h3 id="5-ustanavlivaem-rasshireniya-dlya-brauzera">  5. Install browser extensions </h3><br><h4 id="51-kriptopro-ecp-browser-plug-in">  5.1 CryptoPro EDS Browser plug-in </h4><br><p>  From the <a href="https://cryptopro.ru/products/cades/plugin%25E2%2580%25A8">downloads page</a> on the CryptoPro website, we download and install the <em>CryptoPro EDS Browser plug-in version 2.0 for users</em> - <strong><a href="https://cryptopro.ru/products/cades/plugin/get_2_0">download</a></strong> . </p><br><h4 id="52-plagin-dlya-gosuslug">  5.2.  Plugin for state services </h4><br><p>  From the <a href="">downloads page</a> on the Gosuslug portal we download and install the <em>Plugin to work with the state services portal (version for macOS)</em> - <strong><a href="">download</a></strong> . </p><br><h4 id="53-nastraivaem-plagin-dlya-gosuslug">  5.3.  Customize plugin for Gosuslug </h4><br><p>  Download the correct configuration file for the expansion of public services to support macOS and new EDS in the standard GOST2012 - <strong><a href="">download</a></strong> . </p><br><p>  Execute the commands in the terminal: </p><br><pre> <code class="bash hljs">sudo rm /Library/Internet\ Plug-Ins/IFCPlugin.plugin/Contents/ifc.cfg</code> </pre> <br><pre> <code class="bash hljs">sudo cp ~/Downloads/ifc.cfg /Library/Internet\ Plug-Ins/IFCPlugin.plugin/Contents</code> </pre> <br><pre> <code class="bash hljs">sudo cp /Library/Google/Chrome/NativeMessagingHosts/ru.rtlabs.ifcplugin.json /Library/Application\ Support/Chromium/NativeMessagingHosts</code> </pre> <br><h4 id="54-aktiviruem-rasshireniya">  5.4.  Activate extensions </h4><br><p>  Launch the Chromium-Gost browser and in the address bar type: </p><br><pre> <code class="plaintext hljs">chrome://extensions/</code> </pre> <br><p>  We include both installed extensions: </p><br><ul><li>  CryptoPro Extension for CAdES Browser Plug-in </li><li>  Expansion for state services plugin </li></ul><br><div class="spoiler">  <b class="spoiler_title">Screenshot</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/7b/qz/0-/7bqz0-z9zmnua0q7xs9qdcr63ak.png"></p></div></div><br><h4 id="55-nastraivaem-rasshirenie-kriptopro-ecp-browser-plug-in">  5.5.  Configuring the CryptoPro extension. DS Browser plug-in </h4><br><p>  In the Chromium-Gost address bar, type: </p><br><pre> <code class="plaintext hljs">/etc/opt/cprocsp/trusted_sites.html</code> </pre> <br><p>  On the page that appears, in the queue of trusted nodes we add the following sites: </p><br><pre> <code class="plaintext hljs">https://*.cryptopro.ru https://*.nalog.ru https://*.gosuslugi.ru</code> </pre> <br><p>  Click ‚ÄúSave‚Äù.  A green dot should appear: </p><br><blockquote>  The list of trusted sites was saved successfully. </blockquote><br><div class="spoiler">  <b class="spoiler_title">Screenshot</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/wy/xx/5h/wyxx5hsubwkvcxtw-luvoregeng.png"></p></div></div><br><h3 id="6-proveryaem-chto-vse-rabotaet">  6. Check that everything works </h3><br><h4 id="61-zahodim-na-testovuyu-stranicu-kriptopro">  6.1.  Go to the test page CryptoPro </h4><br><p>  In the Chromium-Gost address bar, type: </p><br><pre> <code class="plaintext hljs">https://www.cryptopro.ru/sites/default/files/products/cades/demopage/cades_bes_sample.html</code> </pre> <br><p>  The ‚ÄúPlugin loaded‚Äù should be displayed, and your certificate will appear in the list below. <br>  Choose a certificate from the list and click ‚ÄúSign‚Äù.  The certificate PIN will be requested.  The result should display </p><br><blockquote>  Signature successfully generated </blockquote><br><div class="spoiler">  <b class="spoiler_title">Screenshot</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/v9/id/m_/v9idm_5w3mnwdcucyt5edpyhceo.png"></p></div></div><br><h4 id="62-zahodim-v-lichnyy-kabinet-na-nalogru">  6.2.  Go to your account on nalog.ru </h4><br><p>  You may not be able to log in via links from nalog.ru, because  Will not pass checks.  You need to go through direct links: </p><br><ul><li>  Private office <strong>IP</strong> : <a href="https://lkipgost.nalog.ru/lk">https://lkipgost.nalog.ru/lk</a> </li><li>  Personal account <strong>LE</strong> : <a href="https://lkul.nalog.ru/">https://lkul.nalog.ru</a> </li></ul><br><div class="spoiler">  <b class="spoiler_title">Screenshot</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/fn/2f/gf/fn2fgfejidrtpokh3xdlap4j0ny.png"></p></div></div><br><h4 id="63-zahodim-na-gosuslugi">  6.3.  Go to the state services </h4><br><p>  When authorizing, select "Sign in with an electronic signature."  In the list that appears, select the certificate of the electronic signature verification key, all certificates, including root and CA, will be displayed, you need to choose your one with a usb token and enter the PIN. </p><br><div class="spoiler">  <b class="spoiler_title">Screenshot</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/k1/il/ie/k1iliepylyukk20xl-e_ooj4ab0.png"></p><br><p><img src="https://habrastorage.org/webt/gi/ex/hf/giexhftwmegvxgj_k4bahsn7sz4.png"></p></div></div><br><h3 id="7-chto-delat-esli-perestalo-rabotat">  7. What to do if it stopped working </h3><br><ol><li><p>  Reconnect the usb token and check that it is visible using the command in terminal: </p><br><pre> <code class="bash hljs">sudo /opt/cprocsp/bin/csptest -card -enum -v</code> </pre> <br></li><li><p>  We clear the browser's cache for all the time, for which we type in the Chromium-Gost address bar: </p><br><pre> <code class="plaintext hljs"> chrome://settings/clearBrowserData</code> </pre> <br></li><li><p>  Reinstall the CEP certificate using the command in terminal: </p><br><pre> <code class="bash hljs">/opt/cprocsp/bin/csptestf -absorb -certs</code> </pre> <br></li></ol><br><h2 id="smena-pin-koda-konteynera">  Change PIN container </h2><br><p>  User PIN-code on Rutoken by default <em>12345678</em> , and leave it in this form can not be.  Requirements for PIN-code Rutoken: 16 characters max., May contain letters and numbers. </p><br><h3 id="1-vyyasnyaem-nazvanie-konteynera-kep">  1. Find out the name of the CEP container </h3><br><p>  On the usb-token and in other storages several certificates can be stored, and you need to choose the right one.  When a usb-token is inserted, we get a list of all containers in the system with a command in terminal: </p><br><pre> <code class="bash hljs">/opt/cprocsp/bin/csptest -keyset -enum_cont -fqcn -verifycontext</code> </pre> <br><p>  The team must withdraw at least 1 container and return </p><br><blockquote>  [ErrorCode: 0x00000000] </blockquote><p>  The container we need is </p><br><blockquote>  \. \ Aktiv Rutoken lite \ XXXXXXXX </blockquote><p>  If there are several such containers, it means that several certificates are written on the token, and you are aware of which one you need.  The value <em>XXXXXXXX</em> after the slash must be copied and substituted into the command below. </p><br><h3 id="2-smena-pin-komandoy-iz-terminal">  2. Change PIN command from terminal </h3><br><pre> <code class="bash hljs">/opt/cprocsp/bin/csptest -passwd -qchange -container <span class="hljs-string"><span class="hljs-string">"XXXXXXXX"</span></span></code> </pre> <br><p>  where <em>XXXXXXXX</em> is the container name obtained in step 1 (required in quotes). </p><br><p>  A CryptoPro dialog will appear, asking for the old PIN to access the certificate, then another dialog to enter the new PIN.  Is done. </p><br><div class="spoiler">  <b class="spoiler_title">Screenshot</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/xh/fr/9i/xhfr9imuu1gh-uxgvekeqleptyw.png"></p></div></div><br><h2 id="podpis-faylov-v-macos">  Sign files in macOS </h2><br><p>  In macOS files, you can sign in <a href="https://cryptoarm.ru/shop/cryptoarm-gost">CryptoArm</a> software (license price 2500 = rub.), Or by a simple command via terminal - for free. </p><br><h3 id="1-vyyasnyaem-hesh-sertifikata-kep">  1. Find out the CEP certificate hash </h3><br><p>  There may be several certificates on a token and in other repositories.  It is necessary to uniquely identify the one with which we will continue to sign documents.  It is done once. <br>  The token must be inserted.  Get the list of certificates in the repositories with the command from terminal: </p><br><pre> <code class="bash hljs">/opt/cprocsp/bin/certmgr -list</code> </pre> <br><p>  The team must display at least 1 type certificate: </p><br><blockquote>  Certmgr 1.1 ¬© "Crypto-Pro", 2007-2018. <br>  program for managing certificates, CRLs and stores <br>  = = = = = = = = = = = = = = = = = = = = = <br>  one------- <br>  Issuer: E = help @ esphere.ru, ... CN = LLC KORUS Consulting CIS ... <br>  Subject: E = sergzah @ gmail.com, ... CN = Zakharov Sergey Anatolyevich ... <br>  Serial: 0x00000000000000000000000000000000 <br>  SHA1 Hash: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX <br>  ... <br>  Container: SCARD \ rutoken_lt_00000000 \ 0000 \ 0000 <br>  ... <br>  = = = = = = = = = = = = = = = = = = = = = <br>  [ErrorCode: 0x00000000] </blockquote><p>  The certificate we need in the Container parameter must have a value of the type <em>SCARD \ rutoken ....</em>  If there are several certificates with such values, then several certificates are written on the token, and you know exactly which one you need.  The value of the <em>SHA1 Hash</em> parameter (40 characters) must be copied and substituted into the command below. </p><br><h3 id="2-podpis-fayla-komandoy-iz-terminal">  2. Sign the file with the command from terminal </h3><br><p>  In terminal, go to the directory with the file for signing and execute the command: </p><br><pre> <code class="bash hljs">/opt/cprocsp/bin/cryptcp -signf -detach -cert -der -strict -thumbprint  FILE</code> </pre> <br><p>  where <em>XXXX ...</em> is the certificate hash obtained in step 1, and <em>FILE</em> is the name of the file to be signed (with all extensions but no path). </p><br><p>  The team must return: </p><br><blockquote>  Signed message is created. <br>  [ErrorCode: 0x00000000] </blockquote><p>  An electronic signature file with the * .sgn extension will be created - this is the detached signature in the CMS format with the DER encoding. </p><br><h3 id="3-ustanovka-apple-automator-script">  3. Installing Apple Automator Script </h3><br><p>  In order not to work with the terminal each time, you can install Automator Script once, with which you can sign documents from the Finder context menu.  To do this, download the archive - <strong><a href="https://www.dropbox.com/sh/wtgabq62fkhgn78/AAB4WIzfm2q1H9DWnROiWhpua%3Fdl%3D0">download</a></strong> . </p><br><ol><li>  Unpacking the archive <em>'Sign with CryptoPro.zip'</em> </li><li>  Launch <em>Automator</em> </li><li>  Find and open the unzipped <em>'Sign with CryptoPro.workflow'</em> file </li><li>  In the <em>Run Shell Script</em> block, we change the text <em>XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</em> by the value of the <em>SHA1 Hash</em> parameter of the CEP certificate obtained above. </li><li>  Save the script: ‚åòCommand + S </li><li>  Run the <em>'Sign with CryptoPro.workflow'</em> file and confirm the installation. </li><li>  Go to System <em>Preferences -&gt; Extensions -&gt; Finder</em> and check that <em>Sign with CryptoPro</em> quick action is checked. </li><li>  In the Finder, we call the context menu of any file, and in the section <em>Quick Actions</em> and / or <em>Services</em> select the item <strong>Sign with CryptoPro</strong> </li><li>  In the CryptoPro dialog that appears, enter the user PIN from CEP </li><li>  A file with the * .sgn extension will appear in the current directory - disconnected signature in the CMS format with the DER encoding. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Screenshots</b> <div class="spoiler_text"><p>  Apple Automator window: <br><img src="https://habrastorage.org/webt/ci/md/am/cimdamgbcmuwupqnikoxm4zlr0u.png"></p><br><p>  System Preferences: <br><img src="https://habrastorage.org/webt/ds/aj/4y/dsaj4ybkjxfuc72-ujruj0jor1c.png"></p><br><p>  Finder context menu: </p><br><p><img src="https://habrastorage.org/webt/n5/sz/8y/n5sz8ylptnlud2tdd3o4pvkvqk4.png"></p></div></div><br><h2 id="proverit-podpis-na-dokumente">  Check the signature on the document </h2><br><p>  If the content of the document does not contain secrets and secrets, then the easiest way is to use the web service on the portal of state services - <a href="https://www.gosuslugi.ru/pgu/eds">https://www.gosuslugi.ru/pgu/eds</a> .  So you can take a screenshot from a reputable resource and be sure that everything is OK with the signature. </p><br><div class="spoiler">  <b class="spoiler_title">Screenshots</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/8u/8m/rk/8u8mrkglxf7z5nzdxmo4f7nj66k.png"></p><br><p><img src="https://habrastorage.org/webt/63/7p/od/637pod0rngetfm1nudyyse-3h2q.png"></p></div></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/450516/">https://habr.com/ru/post/450516/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450504/index.html">How to make an application out of the site and put it on Google Play in a few hours. Part 1/2: Progressive Web App</a></li>
<li><a href="../450506/index.html">How to make an application out of the site and put it on Google Play in a few hours. Part 2/2: Trusted Web Activity</a></li>
<li><a href="../450508/index.html">Joe Armstrong on Elixir, Erlang, OP and OOP</a></li>
<li><a href="../450510/index.html">Five problems in the operation and maintenance of Highload IT systems</a></li>
<li><a href="../450512/index.html">Swift vs. Rust - benchmarking on Linux with a (un) understandable ending</a></li>
<li><a href="../450518/index.html">Arduino and Processing. How to control the microcontroller on the COM port. Bilateral communication</a></li>
<li><a href="../450520/index.html">Creating a reliable and verifiable AI: Compliance with specifications, reliable training and formal verification</a></li>
<li><a href="../450522/index.html">Internet history: decay, part 1</a></li>
<li><a href="../450524/index.html">Computer control via Telegram</a></li>
<li><a href="../450526/index.html">10. Check Point Getting Started R80.20. Identity Awareness</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>