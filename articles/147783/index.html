<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Answers to questions with PyObject. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 
 This is a continuation of the answers to questions and tasks for Python from the site pyobject.ru . 


 Disclaimer : 
 The proposed answers s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Answers to questions with PyObject. Part 2</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br>  This is a continuation of the answers to questions and tasks for Python from the site <a href="http://pyobject.ru/blog/2010/02/04/python-quiz/">pyobject.ru</a> . <br><a name="habracut"></a><br><br>  <b>Disclaimer</b> : <br><blockquote>  The proposed answers should not be considered as the most correct.  Moreover, I hope that more experienced people will point out mistakes, inaccuracies and bad places.  For which they thank in advance. </blockquote><br><br><h4>  Classes </h4><br>  1. Write the base class Observable, which would allow successors: <br>  a.  when sending ** kwargs, enter the corresponding values ‚Äã‚Äãas attributes <br>  b.  make it so that when print all public attributes are displayed 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When accessing an attribute, the following happens (it could lie here): <br>  1. The object itself is checked for the presence of an attribute in it.  Custom attributes are stored in the __dict__ attribute of an object. <br>  2. The attribute __dict__ of the object type is checked through the __class __.__ dict__ object <br>  3. parents are checked <br>  4. __getattribute__ method is executed for new classes <br>  5. __getattr__ method is executed <br><br>  In order for the values ‚Äã‚Äãto be available as attributes, it is enough to update the attribute of the __dict__ object, which happens in the __init__ method. <br>  The __str__ method is used to display an ‚Äúinformative view‚Äù of an object.  In this case, we display all the public attributes of the object and their values. <br><br><pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Observable</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Base class for attributes from dict. &gt;&gt;&gt; class X(Observable): ... pass &gt;&gt;&gt; x = X(foo=1, bar="Test", _barr='hidden', baz=(5, 6)) &gt;&gt;&gt; print x X(bar=Test, foo=1, baz=(5, 6)) &gt;&gt;&gt; print x.foo 1 &gt;&gt;&gt; print x.bar Test &gt;&gt;&gt; print x._barr hidden &gt;&gt;&gt; print x.baz (5, 6) """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, **kwargs)</span></span></span><span class="hljs-function">:</span></span> self.__dict__.update(kwargs) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__str__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'%s(%s)'</span></span> % (self.__class__.__name__,\ (<span class="hljs-string"><span class="hljs-string">', '</span></span>.join(<span class="hljs-string"><span class="hljs-string">'%s=%s'</span></span> % (key, val) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (key, val)\ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.__dict__.iteritems() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> key.startswith(<span class="hljs-string"><span class="hljs-string">'_'</span></span>))))</code> </pre> <br><br>  2. Write a class that would be a dictionary by all external signs, but allowed to refer to keys as attributes. <br>  In order for the class to be a dictionary by all its external features, we will inherit it from this dictionary.  And so that the keys can be accessed as attributes, we define the __getattr__ method in the class, which is called when the attribute is not found in the object dictionary, its type, and its parents. <br><br><pre> <code class="python hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DictAttr</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(dict)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Base class for JS-style dict. &gt;&gt;&gt; x = DictAttr([('one', 1), ('two', 2), ('three', 3)]) &gt;&gt;&gt; print x {'three': 3, 'two': 2, 'one': 1} &gt;&gt;&gt; print x['three'] 3 &gt;&gt;&gt; print x.get('two') 2 &gt;&gt;&gt; print x.one 1 &gt;&gt;&gt; print x.test Traceback (most recent call last): ... AttributeError """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__getattr__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self[name] <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyError: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> AttributeError</code> </pre><br>  3. Point 2 with complication: write the parent class XDictAttr so that the heir dynamically determines the key by the presence of the get_KEY method. <br>  I spent a lot of time on this task, because I could not make it fashionable, stylish, youth and not a crutch.  What happened - you decide. <br><br>  In short, how it works: <br>  1. __getitem__ method allows intercepting calls through [] <br>  When we get to the method, at the beginning, we try to get a value using a simple reference to the dictionary through a call to the parent __getitem__.  If the item in the dictionary was not found, then we try to get the value using the __getattr__ method for whose argument we use get_KEY <br>  2. The get () method overrides the standard get () behavior of type dict.  We first try to get the attribute using __getattr__ and the get_KEY argument.  And only in case of failure, we call the parent get method, which will access the unregistered __getitem__ and check for the presence of an argument in the dictionary. <br>  3. The __getattr__ method allows you to handle all other situations.  To begin, we try to get the value through a call to the parent __getitem__.  And here, in case of failure, a dirty hack comes into play.  I could not figure out how to eliminate the possibility of recursion, because it is necessary to check for the presence of the get_KEY attribute, which occurs through a call to the __getattr__ object.  Well, you understand.  In the end, I had a string of the form get_get_get_get_get_foo. <br><br>  The disadvantage of this implementation is that attributes beginning with get_ will cause an AttributeError.  This is displayed in the doctest. <br><br><pre> <code class="python hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XDictAttr</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(dict)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" &gt;&gt;&gt; class X(XDictAttr): ... def get_foo(self): ... return 5 ... def get_bar(self): ... return 12 ... def get_get_z(self): ... return 42 &gt;&gt;&gt; x = X({'one': 1, 'two': 2, 'three': 3}) &gt;&gt;&gt; x {'one': 1, 'three': 3, 'two': 2} &gt;&gt;&gt; x['one'] 1 &gt;&gt;&gt; x.three 3 &gt;&gt;&gt; x.bar 12 &gt;&gt;&gt; x['foo'] 5 &gt;&gt;&gt; x.get('foo', 'missing') 5 &gt;&gt;&gt; x.get('bzz', 'missing') 'missing' &gt;&gt;&gt; x.get_bar() 12 &gt;&gt;&gt; x.get_foz() Traceback (most recent call last): ... AttributeError &gt;&gt;&gt; x.get_get_z() 42 &gt;&gt;&gt; x.get('get_z') 42 &gt;&gt;&gt; x.get_z Traceback (most recent call last): ... AttributeError """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__getattr__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super(XDictAttr, self).__getitem__(name) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyError: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> name.startswith(<span class="hljs-string"><span class="hljs-string">'get_'</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getattr(self, <span class="hljs-string"><span class="hljs-string">'get_%s'</span></span> % name)() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> AttributeError <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__getitem__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super(XDictAttr, self).__getitem__(key) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyError: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getattr(self, <span class="hljs-string"><span class="hljs-string">'get_%s'</span></span> % key)() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key, default=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getattr(self, <span class="hljs-string"><span class="hljs-string">'get_%s'</span></span> % key)() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> AttributeError: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super(XDictAttr, self).get(key, default)</code> </pre><br>  4. Write a class that registers its instances and provides an iterator interface for them <br>  I understand that I do not know much in Python, but as for me this task should have been attributed to metaclasses for the following reason: <br><pre> <code class="python hljs"> &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Reg: ... <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> i &lt;Reg instance at <span class="hljs-number"><span class="hljs-number">0x98b6ecc</span></span>&gt; &lt;Reg instance at <span class="hljs-number"><span class="hljs-number">0x98b6fec</span></span>&gt; &lt;Reg instance at <span class="hljs-number"><span class="hljs-number">0x98ba02c</span></span>&gt;</code> </pre><br>  This example implies that we take the iterator from the type, not the class object.  And the python interpreter swore a similar error when I tried to wrap __iter__ in a classmethod or staticmethod. <br>  Therefore, my implementation is as follows: <br><pre> <code class="python hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegBase</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__iter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> iter(cls._instances) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reg</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" &gt;&gt;&gt; x = Reg() &gt;&gt;&gt; x # doctest: +ELLIPSIS &lt;__main__.Reg object at 0x...&gt; &gt;&gt;&gt; y = Reg() &gt;&gt;&gt; y # doctest: +ELLIPSIS &lt;__main__.Reg object at 0x...&gt; &gt;&gt;&gt; z = Reg() &gt;&gt;&gt; z # doctest: +ELLIPSIS &lt;__main__.Reg object at 0x...&gt; &gt;&gt;&gt; for i in Reg: # doctest: +ELLIPSIS ... print i &lt;__main__.Reg object at 0x...&gt; &lt;__main__.Reg object at 0x...&gt; &lt;__main__.Reg object at 0x...&gt; """</span></span> __metaclass__ = RegBase _instances = [] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._instances.append(self)</code> </pre><br>  PS Yes, and in the example of Reg instance, I have the same Reg object.  Maybe here my cant? <br><br><h4>  Metaclasses and descriptors </h4><br>  Probably the most controversial section, because I almost did not deal with metaclasses because: ‚ÄúIf you don‚Äôt know if you need a metaclass, then you don‚Äôt need it‚Äù.  But still try. <br><br>  Questions: <br>  I will not quote the documentation (Data model).  In addition, I will write: there are good articles on Habr√© about object structure in general and metaclasses in particular.  <a href="http://habrahabr.ru/post/114576/">Here</a> and <a href="http://habrahabr.ru/post/65625/">here</a> .  Thanks to their authors. <br><br>  Tasks: <br>  1. Implement descriptors that would fix the attribute type. <br>  Two words - the descriptor is an attribute of the class of a new type with a specific behavior. <br>  An article about the descriptors <a href="http://habrahabr.ru/post/122082/">here.</a> <br><pre> <code class="python hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Property</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" &gt;&gt;&gt; class Image(object): ... height = Property(0) ... width = Property(0) ... path = Property('/tmp/') ... size = Property(0) &gt;&gt;&gt; img = Image() &gt;&gt;&gt; img.height = 340 &gt;&gt;&gt; img.height 340 &gt;&gt;&gt; img.path = '/tmp/x00.jpeg' &gt;&gt;&gt; img.path '/tmp/x00.jpeg' &gt;&gt;&gt; img.path = 320 Traceback (most recent call last): ... TypeError """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> self.__value = value self.__value_type = type(value) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__get__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, obj, objtype=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.__value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__set__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, obj, value)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> type(value) == self.__value_type: self.__value = value <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> TypeError</code> </pre><br>  2. Implement the base class (using the metaclass), which would fix the attribute type. <br>  Here I had a problem - I did not quite understand the task.  According to the author‚Äôs example, the height, path attributes are class attributes.  Whether it was meant that the metaclass should fix and transfer them to an object or just fix is ‚Äã‚Äãnot clear.  I implemented the second. <br><br>  Class Property take the same as in the answer to the task 1. <br>  All we need to do is wrap the public attributes of the class being created in Property.  Since the metaclass gets a dictionary with class attributes, this is not a problem. <br>  Additionally made a check on whether the attribute is public or method. <br><pre> <code class="python hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageMeta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, dct)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key, val <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dct.iteritems(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> key.startswith(<span class="hljs-string"><span class="hljs-string">'_'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> hasattr(val, <span class="hljs-string"><span class="hljs-string">'__call__'</span></span>): dct[key] = Property(val) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> type.__new__(mcs, name, bases, dct) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageBase</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" &gt;&gt;&gt; class Image(ImageBase): ... height = 0 ... path = 'tmp' ... ... def foo(self): ... return 'bar' &gt;&gt;&gt; img = Image() &gt;&gt;&gt; img.height = 340 &gt;&gt;&gt; img.height 340 &gt;&gt;&gt; img.path = '/tmp/x00.jpeg' &gt;&gt;&gt; img.path '/tmp/x00.jpeg' &gt;&gt;&gt; img.path = 320 Traceback (most recent call last): ... TypeError &gt;&gt;&gt; hasattr(img.foo '__call__') True """</span></span> __metaclass__ = ImageMeta</code> </pre><br>  3. Implement the base class (using the metaclass) and descriptors that would create a SQL schema (ANSI SQL) for the model based on the class. <br>  Please comment on this method, because it seems to me that it was possible to make more beautiful. <br>  To implement were made: <br>  1. A basic Property Descriptor with a class counter that allows you to sort the attributes in the order in which they were created. <br>  2. Integer and Str descriptors with their own __str__, which are used when creating the SQL representation of the model. <br>  3. Metaclass TableMeta, which gets a list of model fields and creates a SQL representation of the model. <br>  4. The base class Table, which provides a class method that returns a SQL representation of the model. <br><br><pre> <code class="python hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Property</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" &gt;&gt;&gt; class Image(object): ... size = Property(int) ... name = Property(basestring) &gt;&gt;&gt; img = Image() &gt;&gt;&gt; img.size = 0 &gt;&gt;&gt; img.size 0 &gt;&gt;&gt; img.name = '/tmp/img' &gt;&gt;&gt; img.name '/tmp/img' &gt;&gt;&gt; img.size = '~' Traceback (most recent call last): ... TypeError &gt;&gt;&gt; img.name = ['/tmp/', 'img'] Traceback (most recent call last): ... TypeError &gt;&gt;&gt; img.__class__.__dict__['size'].counter 0 &gt;&gt;&gt; img.__class__.__dict__['name'].counter 1 """</span></span> counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value_type)</span></span></span><span class="hljs-function">:</span></span> self.__value = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> self.__value_type = value_type self.counter = Property.counter Property.counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__get__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, obj, objtype=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.__value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__set__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, obj, value)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(value, self.__value_type): self.__value = value <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> TypeError <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Property)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> super(Integer, self).__init__(int) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__str__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.__class__.__name__.upper() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Str</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Property)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, size)</span></span></span><span class="hljs-function">:</span></span> super(Str, self).__init__(basestring) self.__size = size <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__str__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'{0}({1})'</span></span>.format(<span class="hljs-string"><span class="hljs-string">'varchar'</span></span>, self.__size).upper() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TableMeta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, dct)</span></span></span><span class="hljs-function">:</span></span> fields = [(attr_name, val) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (attr_name, val) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dct.items()\ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(val, Property)] fields.sort(key=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x[<span class="hljs-number"><span class="hljs-number">1</span></span>].counter) sql = <span class="hljs-string"><span class="hljs-string">',\n'</span></span>.join(<span class="hljs-string"><span class="hljs-string">'\t{0} {1}'</span></span>.format(attr_name, val)\ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (attr_name, val) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fields) dct[<span class="hljs-string"><span class="hljs-string">'__sql'</span></span>] = <span class="hljs-string"><span class="hljs-string">u'CREATE TABLE {0} (\n{1}\n)'</span></span>.format(name, sql) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> type.__new__(mcs, name, bases, dct) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Table</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" &gt;&gt;&gt; class Image(Table): ... height = Integer() ... width = Integer() ... path = Str(128) &gt;&gt;&gt; print Image.sql() # doctest: +NORMALIZE_WHITESPACE CREATE TABLE Image ( height INTEGER, width INTEGER, path VARCHAR(128) ) """</span></span> __metaclass__ = TableMeta @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sql</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cls.__dict__[<span class="hljs-string"><span class="hljs-string">'__sql'</span></span>]</code> </pre><br><br>  That's all.  For comments and criticism - thanks. </div><p>Source: <a href="https://habr.com/ru/post/147783/">https://habr.com/ru/post/147783/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147774/index.html">Unix Birth and Development</a></li>
<li><a href="../147775/index.html">Win the Galaxy S III and other smartphones in the game quest!</a></li>
<li><a href="../147776/index.html">How OneTwoTrip fools SkyScanner and its customers</a></li>
<li><a href="../147780/index.html">The digest of interesting news and materials from the world of ayti for the last week ‚Ññ14 (July 7 - 13, 2012)</a></li>
<li><a href="../147781/index.html">Canvas hardware acceleration in Android</a></li>
<li><a href="../147784/index.html">Paradise for the gamer - a game room for 30 thousand</a></li>
<li><a href="../147786/index.html">New Internet Bank Tinkoff Credit Systems</a></li>
<li><a href="../147787/index.html">Be creative! Or MCC from Raspberry Pi</a></li>
<li><a href="../147788/index.html">Google has started shipping tablets Nexus 7</a></li>
<li><a href="../147789/index.html">The challenge of the competition ICFPC-2012: the robot and Œª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>