<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Porting FreeRTOS to the processor from Multiklet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√©, there have already been many articles that described the use of FreeRTOS or porting to widespread processor architectures. In this article I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Porting FreeRTOS to the processor from Multiklet</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/8e9/a17/91a/8e9a1791ae98addf4198b8d364b20662.jpg" alt="Multiclet &amp; FreeRTOS" align="left">  On Habr√©, there have already been many articles that described the use of FreeRTOS or porting to widespread processor architectures.  In this article I want to share the experience of porting FreeRTOS to the Russian architecture of "Multiklet" and show how the Multiclet P1 processor handles several parallel tasks.  As an example, a GPS tracker will be created with the ability to record coordinates on SD, a shell via UART, a small text editor and the ability to work with the FAT32 file system. <br><a name="habracut"></a><br><h5>  Step 1. Porting. </h5><br>  As an example, the FreeRTOS port for ATMega323 was used, since I was familiar with the architecture of this processor for a long time.  After studying the files, it became clear that this task could not be solved in the forehead, since for FreeRTOS it is recommended to use the GCC compiler set (for a specific architecture) with its __attribute__ and asm inserts, and this possibility is not available in the current LCC compiler from Multiclet.  It did not become a big problem, the only attribute that was used in the port for ATMega323 is __attribute__ ((naked)), which tells the compiler not to create a prologue and an epilog of a function.  This attribute is assigned to a function that is responsible for changing the context of the task and leaving for the execution of a new one; therefore, it is important that when it is called, a prologue and an epilog are not created (otherwise the stack / memory will end quickly).  This function and all the functions with asm inserts had to be written in the assembly Multiclet. <br><br>  The next problem I encountered while porting the OS is the stack.  The fact is that there are no push and pop commands in Multiclet processors due to the nature of the architecture.  The architecture of the port turned out, perhaps a bit tricky, but at the moment I do not see more <br>  elegant solution.  The idea is as follows: each task in the OS has its own memory area, in which the values ‚Äã‚Äãof its registers and call stack are located, and there is a common OS stack, in which function calls are placed during interrupt processing.  The substitution of the values ‚Äã‚Äãof the #SP and #BP registers (pointers to the base and frame of the function) is performed in the primary interrupt handler (file crt0.s). <br><br><h6>  An example of a task change at the time of interruption. </h6><br>  There are 2 tasks with the same priority.  After the tasks have been created and added by the kernel to the queue, the xPortStartScheduler (void) function will be called, which will start the system timer and call the primary context change function PRS ().  In the PRS () function, the pxCurrentTCB pointer (pxCurrentTCB is the OS pointer to the task context) sets the value of all registers, including #SP and #BP (the global values ‚Äã‚Äãof #SP and #BP are stored in the gSP and gBP variables, respectively) responsible for the stack the current task and the transition to its implementation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs">PRS: jmp PRS_fin PXCTCB:= rdl pxCurrentTCB pxTopOfStack:= rdl @PXCTCB setl #DI, @pxTopOfStack complete PRS_fin: reg7 := rdl #DI, pStack reg6 := rdl #DI, pStack + <span class="hljs-number"><span class="hljs-number">4</span></span> reg5 := rdl #DI, pStack + <span class="hljs-number"><span class="hljs-number">8</span></span> reg4 := rdl #DI, pStack + <span class="hljs-number"><span class="hljs-number">12</span></span> reg3 := rdl #DI, pStack + <span class="hljs-number"><span class="hljs-number">16</span></span> reg2 := rdl #DI, pStack + <span class="hljs-number"><span class="hljs-number">20</span></span> reg1 := rdl #DI, pStack + <span class="hljs-number"><span class="hljs-number">24</span></span> reg0:= rdl #DI, pStack + <span class="hljs-number"><span class="hljs-number">28</span></span> pvp := rdl #DI, pStack + <span class="hljs-number"><span class="hljs-number">32</span></span> pxCode := rdl #DI, pStack + <span class="hljs-number"><span class="hljs-number">36</span></span> taskSP := rdl #DI, pStack + <span class="hljs-number"><span class="hljs-number">40</span></span> taskBP := rdl #DI, pStack + <span class="hljs-number"><span class="hljs-number">44</span></span> saveSP := getl #SP saveBP := getl #BP setl #R7,@reg7 setl #R6,@reg6 setl #R5,@reg5 setl #R4,@reg4 setl #R3,@reg3 setl #R2,@reg2 setl #R1,@reg1 setl #R0,@reg0 wrl @saveSP, gSP wrl @saveBP, gBP setl #SP, @taskSP setl #BP, @taskBP jmp @pxCode complete</code> </pre> <br>  At the time of the occurrence of an interrupt from the system timer, control is transferred to the primary interrupt handler. <br><br><pre> <code class="cpp hljs">master.isr: jmp mi.hendler saveSP := getl #SP saveBP := getl #BP loadSP := rdl gSP loadBP := rdl gBP reta := getl #IRETADDR wrl @saveSP, iSP &lt;/code&gt; wrl @saveBP, iBP setl #SP, @loadSP setl #BP, @loadBP wrl @reta, master.isr.retaddr complete</code> </pre><br>  In the primary interrupt handler (master.isr), pointers to the stack are replaced and the return address from the interrupt is stored, then the RTOS context change function is called. <br><br><pre> <code class="cpp hljs">mi.hendler: getl #SP getl mi.stop getl #INTNUMR getl irq.desc.tbl mull @<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>.I&lt;/code&gt; DT.item addl @<span class="hljs-number"><span class="hljs-number">1</span></span>, @<span class="hljs-number"><span class="hljs-number">2</span></span> rdl @<span class="hljs-number"><span class="hljs-number">1</span></span> jmp @<span class="hljs-number"><span class="hljs-number">1</span></span> subl @<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>.ptr wrl @<span class="hljs-number"><span class="hljs-number">8</span></span>, @<span class="hljs-number"><span class="hljs-number">1</span></span> setl #SP, @<span class="hljs-number"><span class="hljs-number">2</span></span> complete</code> </pre><br>  During the context change, the current task context saving function is called, then the OC scheduler sets the pxCurrentTCB pointer to the task that needs to be restored, and the context recovery function is called with transfer of control to the epilog of the primary interrupt handler. <br><br><pre> <code class="cpp hljs">mi.stop: jmp mi.PF getl #SP addl @<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>.ptr setl #SP, @<span class="hljs-number"><span class="hljs-number">1</span></span> complete mi.PF: rdl master.isr.retaddr jmp @<span class="hljs-number"><span class="hljs-number">1</span></span> getq #PSW <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> @<span class="hljs-number"><span class="hljs-number">1</span></span>, PSW.ONIRQS setq #PSW, @<span class="hljs-number"><span class="hljs-number">1</span></span> saveSP := getl #SP saveBP := getl #BP loadSP := rdl iSP loadBP := rdl iBP wrl @saveSP, gSP wrl @saveBP, gBP setl #SP, @loadSP setl #BP, @loadBP complete</code> </pre><br>  This is how the task and stack changes of FreeRTOS Multiclet P1 work. <br><br><h5>  Step 2. Example of use. </h5><br>  As an example of real OS usage, a small GPS tracker layout was assembled on the demo board. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/23b/1cc/b5e/23b1ccb5ee46a571567264f4e0a4d499.jpg" alt="Demo board"><br><br>  The board on top is Pinboard II.  It was used only as a connector for an SD card. <br>  The main task with the highest priority was the terminal emulator, implemented through the COM port. <br><img src="https://habrastorage.org/getpro/habr/post_images/3d1/044/f23/3d1044f23fb8c46a29a94d338a9b46d2.jpg" alt="Terminal"><br>  Parallel tasks: writing to an SD card, reading an SD card, receiving data from a GPS receiver, writing and reading a coordinate track to / from file (a). <br><img src="https://habrastorage.org/getpro/habr/post_images/547/f02/a01/547f02a0143cd74c9d26561a33cd91ce.jpg" alt="Track recording"><br><img src="https://habrastorage.org/getpro/habr/post_images/06c/f97/3b4/06cf973b4c24bf38e58bb7afc8ad00cd.jpg" alt="Reading track from file"><br>  The obtained data is not reliable (since the GPS receiver was lying on the table) and demonstrate only the work with the file system.  By placing the demo board on the window we get almost correct results. <br><img src="https://habrastorage.org/getpro/habr/post_images/d82/313/a67/d82313a678dabfd889a2ba0ee8511690.jpg" alt="Real coordinates"><br>  The OS is working with a memory card using the FatFS library by Comrade Chan [ <a href="http://elm-chan.org/fsw/ff/00index_e.html">elm-chan.org/fsw/ff/00index_e.html</a> ]. <br><br><h5>  Conclusion </h5><br>  In this article, I wanted to show that Multiclet processors are capable of executing programs widely used on other architectures, and taking into account low power consumption and hardware parallelization, it is also much more efficient. </div><p>Source: <a href="https://habr.com/ru/post/209732/">https://habr.com/ru/post/209732/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209722/index.html">Payler: PCI DSS audit passed!</a></li>
<li><a href="../209724/index.html">Scientists suggest NASA explore a giant metal asteroid</a></li>
<li><a href="../209726/index.html">NeoQUEST-2014: registration is announced open</a></li>
<li><a href="../209728/index.html">What is the difference between the security of the behavior of the average user and the conscious?</a></li>
<li><a href="../209730/index.html">Forth and shaders</a></li>
<li><a href="../209734/index.html">Incoding rapid development framework</a></li>
<li><a href="../209736/index.html">Why NSURLSession is Better than NSURLConnection</a></li>
<li><a href="../209738/index.html">The basics of color theory. CIE XYZ system</a></li>
<li><a href="../209742/index.html">Team work on interfaces</a></li>
<li><a href="../209744/index.html">Successful or unsuccessful, that is the question: other crowdfunding statistics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>