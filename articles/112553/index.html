<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple web scraping on f #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite a legitimate question why such a hackneyed topic like web scraping and why f #. 1. on f # web scraping is much more interesting than on c # 2. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple web scraping on f #</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/ec/db/ecdb8ff2a4029844ca82a922ae32cb23.jpg" align="right" alt="image">  Quite a legitimate question why such a hackneyed topic like web scraping and why f #.  1. on f # web scraping is much more interesting than on c # 2. I wanted to try as far as f # is applicable for developing not demo examples but something that really makes programs 3. F # has an interactive console, which when tinkering in the depths of HTML becomes just a salvation.  Today, with the help of f # we will buy VW Touareg. <br><a name="habracut"></a><br><h2>  Touareg </h2><br>  In my opinion the most optimal car for the harsh winter and no less severe roads.  Suppose we have a million four hundred thousand, a great desire and nothing more.  There is also an auto.ru site, but my recent involvement in the purchase of a used car revealed several shortcomings: a.  you need to constantly go to the correct section b.  you need to constantly fill out a search form, which is especially annoying when you need to do it on the road from mobile devices, on the way to inspect the next candidate, we used the iPad and it was ‚Äúnot ice‚Äù, and from some kind of smartphone I would definitely shoot myself to perform all these operations.  Total requirements: the program bypasses the offer page with the corresponding request, searches for new offers and if it finds it, sends an email with the parameters of the new offer (s) and at the same time a list of all the offers that satisfy the request so that you can compare visually. <br><br><h2>  General methods </h2><br>  Auto.ru is quite loyal to collecting its content, so there will be no perversions like emulation of pressing a button and slipping cookies, and all that interests us can be obtained via a direct url via GET.  We will also send letters via gmail, which will require the client‚Äôs SMTP settings specified in the comments <br><br><blockquote><code><font color="black"><font color="#00008B">module</font> WebUtil =&lt;br/&gt; <br> <font color="#00008B">let</font> LoadPage (x:WebRequest) =&lt;br/&gt; <br> <font color="#00008B">use</font> resp = x.GetResponse()&lt;br/&gt; <br> <font color="#00008B">let</font> rs = resp.GetResponseStream()&lt;br/&gt; <br> <font color="#00008B">let</font> rr = <font color="#00008B">new</font> StreamReader(rs,System.Text.Encoding.GetEncoding(1251))&lt;br/&gt; <br> rr.ReadToEnd()&lt;br/&gt; <br> <font color="#00008B">let</font> LoadPageByUrl (x:string) =&lt;br/&gt; <br> <font color="#00008B">let</font> request = WebRequest.Create(x)&lt;br/&gt; <br> LoadPage request&lt;br/&gt; <br> <font color="#00008B">let</font> SentByMail (recepinet: string) (subj:string) (content: string) =&lt;br/&gt; <br> <font color="#00008B">let</font> client = <font color="#00008B">new</font> SmtpClient()&lt;br/&gt; <br> client.DeliveryMethod &lt;- SmtpDeliveryMethod.Network&lt;br/&gt; <br> <font color="#00008B">use</font> message = <font color="#00008B">new</font> MailMessage()&lt;br/&gt; <br> message.To.Add(recepinet)&lt;br/&gt; <br> message.Body &lt;- content&lt;br/&gt; <br> message.Subject &lt;- subj&lt;br/&gt; <br> message.IsBodyHtml &lt;- <font color="#00008B">true</font> &lt;br/&gt; <br> client.Send(message)&lt;br/&gt; <br> <font color="#006400"><em>(*</em></font> <br> <font color="#006400"><em>&lt;system.net&gt;</em></font> <br> <font color="#006400"><em>&nbsp;&nbsp;&nbsp;&nbsp;</em> <br> <font color="#006400"><em>&lt;smtp from="YourMail@gmail.com"&gt;</em></font> <br> <font color="#006400"><em>&lt;network host="smtp.gmail.com" port="587" enableSsl="true"</em></font> <br> <font color="#006400"><em>password="$ecretPa$$w0rd" defaultCredentials="false"</em></font> <br> <font color="#006400"><em>userName="YourMail@gmail.com" /&gt;</em></font> <br> <font color="#006400"><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</em></font></font> <br> <font color="#006400"><em>&nbsp;&nbsp;&nbsp;&nbsp;</em></font></font> <br> <font color="#006400"><em>&lt;/system.net&gt;</em></font> <br> <font color="#006400"><em>*)</em></font> &lt;br/&gt; <br></code> </blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What is here from f #?  Functionally, nothing, the standard methods of the platform, but strikingly briefly, if it were not for the footcloth of the MailMessage properties setters.  The readability of the code is very personal, but in my opinion there is little that can be compared with f # in readability. <br><br><h2>  Data structures </h2><br>  Because  you need to distinguish which sentences were added since the last check, the result of the previous query will be stored in a file.  It would be true to keep only the date of the last check, but then it would not be at all interesting and the topic of the serialization of complex objects would be missed.  So records (records): <br><br><blockquote> <code><font color="black"><font color="#00008B">module</font> CarParser =&lt;br/&gt; <br> [&lt;DataContract&gt;]&lt;br/&gt; <br> <font color="#00008B">type</font> Car = &lt;br/&gt; <br> {&lt;br/&gt; <br> [&lt;field: DataMember(Name= <font color="#A52A2A">"Year"</font> ) &gt;]&lt;br/&gt; <br> Year: int;&lt;br/&gt; <br> [&lt;field: DataMember(Name= <font color="#A52A2A">"Price"</font> ) &gt;]&lt;br/&gt; <br> Price: int;&lt;br/&gt; <br> [&lt;field: DataMember(Name= <font color="#A52A2A">"Model"</font> ) &gt;]&lt;br/&gt; <br> Model: string;&lt;br/&gt; <br> [&lt;field: DataMember(Name= <font color="#A52A2A">"Engine"</font> ) &gt;]&lt;br/&gt; <br> Engine: string;&lt;br/&gt; <br> [&lt;field: DataMember(Name= <font color="#A52A2A">"Url"</font> ) &gt;]&lt;br/&gt; <br> Url: string;&lt;br/&gt; <br> }&lt;br/&gt; <br> [&lt;DataContract&gt;]&lt;br/&gt; <br> <font color="#00008B">type</font> CarRequest =&lt;br/&gt; <br> {&lt;br/&gt; <br> [&lt;field: DataMember(Name= <font color="#A52A2A">"Email"</font> ) &gt;]&lt;br/&gt; <br> Email:string;&lt;br/&gt; <br> [&lt;field: DataMember(Name= <font color="#A52A2A">"RequestUrl"</font> )&gt;]&lt;br/&gt; <br> RequestUrl: string;&lt;br/&gt; <br> [&lt;field: DataMember(Name= <font color="#A52A2A">"Cars"</font> ) &gt;]&lt;br/&gt; <br> Cars: Car list;&lt;br/&gt; <br> }&lt;br/&gt; <br></font> <br></code> <br></blockquote><br>  Why additional attributes?  The fact is that standard serialization in XML via the XmlSerializer does not work, because f # records has no constructor without parameters, which is mandatory.  In this case, it will save the DataContractSerializer, the methods for serializing and deserializing to the file look like this: <br><br><blockquote> <code><font color="black"><font color="#00008B">open</font> System;&lt;br/&gt; <br> <font color="#00008B">open</font> System.IO;&lt;br/&gt; <br> <font color="#00008B">open</font> System.Xml;&lt;br/&gt; <br> <font color="#00008B">open</font> System.Runtime.Serialization;&lt;br/&gt; <br> <font color="#00008B">open</font> System.Text.RegularExpressions;&lt;br/&gt; <br> <font color="#00008B">module</font> SerializationUtils = &lt;br/&gt; <br> <font color="#00008B">let</font> SerializeToFile (req: <font color="#A52A2A">'T) (fileName: string) =&lt;br/&gt; <br> let xmlSerializer = DataContractSerializer(typeof&lt;'</font> T&gt;); &lt;br/&gt; <br> <font color="#00008B">use</font> fs = File.OpenWrite(fileName)&lt;br/&gt; <br> xmlSerializer.WriteObject(fs, req)&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#006400"><em>//T' will be calculated automatically</em></font> <br> <font color="#00008B">let</font> Deserialize&lt; <font color="#A52A2A">'T&gt; (fileName:string) =&lt;br/&gt; <br> let xmlSerializer = DataContractSerializer(typeof&lt;'</font> T&gt;); &lt;br/&gt; <br> <font color="#00008B">use</font> fs = File.OpenRead(fileName)&lt;br/&gt; <br> xmlSerializer.ReadObject(fs) :?&gt; 'T&lt;br/&gt; <br></font></code> <br></blockquote><br><h2>  Content parsing </h2><br>  If we talk about the parameters of a particular car, then the priority is as follows: price, engine - how much tax I will pay and gasoline or diesel, a year - very indirectly indicating the state.  If everything suits me, then you can look at the photo by clicking on the link, this moment, too, by the way, it would be interesting to remake and indicate the link to your site, which will show me the photos and the description of the car without any advertisements there.  But back to the more urgent task. <br><br><img title="Content parsing" src="https://habrastorage.org/getpro/habr/post_images/d6f/c5e/bd4/d6fc5ebd428ea4951605d172ff87d447.png" alt=" " width="640" height="411"><br>  Using the HTMLAgilityPack (in my opinion this is really cool - any .net libraries are available from f #) we get a table with sentences and further analysis is just a matter of technology.  Again on f # parsing looks very short and clear, I know for sure that at least part of the next real project on collecting and analyzing content I will do on f # because it is much easier to read. <br><br><blockquote> <code><font color="black"><font color="#00008B">let</font> <font color="#00008B">private</font> ParseCar (cnt: HtmlNode) =&lt;br/&gt; <br> <font color="#00008B">let</font> columns = cnt.SelectNodes( <font color="#A52A2A">"td"</font> ) |&gt; Seq.toList&lt;br/&gt; <br> <font color="#00008B">let</font> model = columns.[0].InnerText&lt;br/&gt; <br> <font color="#00008B">let</font> txt = columns.[1].InnerText&lt;br/&gt; <br> <font color="#00008B">let</font> price = txt |&gt; ( <font color="#00008B">fun</font> x -&gt; Regex.Replace(x, <font color="#A52A2A">"\\W"</font> ,System.String.Empty)) |&gt; Int32.Parse&lt;br/&gt; <br> <font color="#00008B">let</font> url = columns.[0].ChildNodes &lt;br/&gt; <br> |&gt; Seq.find ( <font color="#00008B">fun</font> x -&gt; x.Name.ToLower() = <font color="#A52A2A">"a"</font> )&lt;br/&gt; <br> |&gt; ( <font color="#00008B">fun</font> x-&gt; x.Attributes) &lt;br/&gt; <br> |&gt; Seq.find ( <font color="#00008B">fun</font> x -&gt; x.Name = <font color="#A52A2A">"href"</font> )&lt;br/&gt; <br> |&gt; ( <font color="#00008B">fun</font> x -&gt; x.Value)&lt;br/&gt; <br> <font color="#00008B">let</font> year = columns.[2].InnerText |&gt; Int32.Parse&lt;br/&gt; <br> <font color="#00008B">let</font> engine = columns.[3].InnerText&lt;br/&gt; <br> <font color="#00008B">let</font> c: Car = { Year = year; Price = price; Model = model; Url = url; Engine = engine; }&lt;br/&gt; <br> c&lt;br/&gt; <br> <font color="#00008B">let</font> <font color="#00008B">private</font> ParsePage (node: HtmlNode) (parseCar: HtmlNode -&gt; Car) =&lt;br/&gt; <br> node.SelectNodes( <font color="#A52A2A">"//div[@id='cars_sale']/table[@class='list']/descendant::tr[not(@class='header first')]"</font> )&lt;br/&gt; <br> |&gt; Seq.map parseCar&lt;br/&gt; <br></font></code> <br></blockquote><br>  And several methods for summarizing the data obtained into interesting requests are probably only currying and initializing the record by copying from the old record.  f # overrides the CompareTo, Equals and GetHashCode functions, so the comparison of records in this case works correctly and you can write x = y. <br><br><blockquote> <code><font color="black"><font color="#00008B">let</font> <font color="#00008B">private</font> ParseCarNode x = ParsePage x ParseCar&lt;br/&gt; <br> <font color="#00008B">let</font> <font color="#00008B">private</font> GetCars (cntnt:string) (pars: HtmlNode -&gt; seq) =&lt;br/&gt; <br> <font color="#00008B">let</font> doc = <font color="#00008B">new</font> HtmlDocument()&lt;br/&gt; <br> doc.LoadHtml(cntnt)&lt;br/&gt; <br> pars doc.DocumentNode&lt;br/&gt; <br> <font color="#00008B">let</font> CreateCarRequest mail url =&lt;br/&gt; <br> <font color="#00008B">let</font> cars = GetCars (LoadPageByUrl url) ParseCarNode&lt;br/&gt; <br> { Email = mail; RequestUrl = url; Cars = cars |&gt; List.ofSeq }&lt;br/&gt; <br> <font color="#00008B">let</font> UpdateCarList (oldRequest: CarRequest) =&lt;br/&gt; <br> <font color="#00008B">let</font> newCars = GetCars (LoadPageByUrl oldRequest.RequestUrl) ParseCarNode&lt;br/&gt; <br> <font color="#00008B">let</font> isContains y = Seq.tryFind ( <font color="#00008B">fun</font> x -&gt; x = y)&lt;br/&gt; <br> <font color="#00008B">let</font> diff = newCars |&gt; Seq.filter ( <font color="#00008B">fun</font> x -&gt; (oldRequest.Cars |&gt; isContains x) = None)&lt;br/&gt; <br> <font color="#00008B">let</font> res = { oldRequest <font color="#00008B">with</font> Cars = newCars |&gt; List.ofSeq }&lt;br/&gt; <br> <font color="#006400"><em>//      ,   </em></font> <br> (res,diff)&lt;br/&gt; <br></font> <br></code> <br></blockquote><br><h2>  Results </h2><br>  Overboard were the functions of formatting e-mail messages and the function that brings it all together and runs on a timer, but their implementation is obvious.  Testing can be done on c #, in particular, testing the correctness of finding new machines was implemented with the help of Moles and it was there that the rakes described in <a href="httpwebresponse/">this</a> post surfaced. <br>  Main advantages: 200 lines of code.  Together.  All 5 files.  There are 30 percent less than the average c # file in programs that carry at least some kind of functional load, and not just call the framework methods with a different order of arguments.  Readability code.  The speed of development in programs collecting kontent very big advantage is the ability to execute code without compiling.  In my opinion, f # is a more understandable and natural way of developing programs, familiar and routine tasks become interesting again. The main drawbacks: the main drawback is of course hand curves, because the program has no logging or clear error handling, which of course is unacceptable (but the truth is, we just buy a car and not sell software). <br>  In any case, it is possible and necessary to write real world programs on f # and this task is simply not complex enough algorithmically and logically to show all the capabilities and advantages of the language, but even such tasks are not bad, and most importantly, interesting and fast enough, except for the time to learn the language . <br>  PS: It remains to write the web interface and ask donation for subscribing to pay for sms gateway and start sending messages if Avto.ru does not ban me earlier :) </div><p>Source: <a href="https://habr.com/ru/post/112553/">https://habr.com/ru/post/112553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112548/index.html">SED outside offices</a></li>
<li><a href="../112549/index.html">Participation in the tender for the development of the site (part 1)</a></li>
<li><a href="../112550/index.html">Participation in the tender for the development of the site (part 2)</a></li>
<li><a href="../112551/index.html">Dynamic favicon or display karma without refreshing the page</a></li>
<li><a href="../112552/index.html">Commentary of the day: Storage of information</a></li>
<li><a href="../112554/index.html">Joint life of Agile and UCD on the example of a real project</a></li>
<li><a href="../112555/index.html">How anonymous is the survey?</a></li>
<li><a href="../112558/index.html">Microsoft unveiled plans to counter iPad in 2011</a></li>
<li><a href="../112559/index.html">Firefox developers are making efforts to support stereovideo (‚Äú3D cinema‚Äù) in WebM format (for the HTML5 video tag), first on nVidia video cards</a></li>
<li><a href="../112561/index.html">Real programmers, where are you?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>