<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What is wrong with 3D PDF and eDrawings. How do we replace the 3D viewer in our application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a story about how we built a new C3D Viewer into the LOTSMAN: PLM product lifecycle management system, why we did it, and what we did. 



 .1...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What is wrong with 3D PDF and eDrawings. How do we replace the 3D viewer in our application</h1><div class="post__text post__text-html js-mediator-article">  This is a story about how we built a new C3D Viewer into the LOTSMAN: PLM product lifecycle management system, why we did it, and what we did. <br><br><img src="https://habrastorage.org/webt/vi/kd/4q/vikd4qvq5x6jjjvpwbaghb298wu.png" alt="image"><br><a name="habracut"></a><br><h2>  <font color="#00B2FF">.1 What is a ‚Äúsecondary view‚Äù</font> </h2><br>  Any notable PLM solution includes PDM (Product Data Management) mechanisms / subsystem. <br><br>  The PDM-system database stores documents and files created in various CAD systems: 3D models, drawings, specifications and calculations. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order for the content of these documents to be available to those users who do not have the appropriate CAD applications installed at the workplace (and they are very expensive), the PDM system creates a ‚Äúsecondary presentation of the document‚Äù - a copy of the document in some "Neutral" publicly available format. <br><br>  After the ‚Äúsecondary view‚Äù is loaded into the system, based on it, you can build a preview of the document content directly in the PDM-system client interface;  use as a carrier when exchanging information with external users, in the coordination processes and in the exchange of comments using notes and annotations. <br><br><h2>  <font color="#00B2FF">.2 Secondary presentation at LOTSMAN: PLM</font> </h2><br>  At various times, VRML, eDrawings, and 3D PDF alternated in their role as a ‚Äúsecondary view‚Äù of 3D models at LOTSMAN: PLM. <br><br>  About VRML, I will not speak - the mistakes of youth ... who does not happen. <br><br>  eDrawings was not bad, but you had to pay very immodest money to develop an adapter to it and support services.  In addition, starting in 2014, eDrawings became available only in the x64 version.  We couldn‚Äôt embed it in our 32bit client LOTSMAN: PLM as ActiveX anyway. <br><br>  3D PDF initially seemed to be a gift - free, already installed on every first computer, the de facto standard in our galaxy arm, plus the ready-made ActiveX library suitable for embedding, but over time, its dark side began to open to us: <br><br><ol><li>  We have the right to distribute Acrobat Reader in its distribution.  It turned out that Acrobat Reader is not installed on every first computer.  Sometimes there is an incompatible version of Acrobat Reader installed, and sometimes another PDF viewer that is incompatible with Acrobat Reader and, at the same time, very expensive for the user's heart. </li><li>  Acrobat Reader development vector is unpredictable.  Each release is full of surprises and adds an arsenal of tools that we use to automatically close windows of unnecessary messages, minimize annoying panels, and install vaguely documented options. </li><li>  The release of the Acrobat Reader update is sudden and inevitable.  About him, we learn from the messages of users that we have stopped working "secondary view". </li><li>  Feedback from the developer is probably possible, but, as regular study of the sad forums shows, is hopeless. </li><li>  Sometimes using ActiveX Acrobat Reader crashes your application.  We finally arrived at using SafeMode in Acrobat Reader.  In this mode, only the hidden child process Acrobat Reader crashes periodically, and our application continues to work. </li><li>  ActiveX Acrobat Reader is available only in 32bit version without options. </li></ol><br>  And most importantly - poor performance when working with large models (assemblies): <br><br><ul><li>  Slow export from KOMPAS-3D to 3D PDF. <br>  Perhaps part of the responsibility lies with KOMPAS-3D, but what is - that is. </li><li>  The large size of the 3D PDF file, which increases the load on the file system and the network and requires more RAM. <br>  The search for optimal, in terms of the ratios of the accuracy of the output models to the file size, settings did not give acceptable results. </li><li>  Slow loading speed for large 3D PDF models. </li><li>  Poor speed / quality of rendering large files. </li></ul><br><h2>  <font color="#00B2FF">.3 Meet the C3D Viewer</font> </h2><br>  We have always followed with interest the successes and novelties of C3D Labs (still a subsidiary of ASCON, colleagues).  The appearance of the new C3D Viewer has not gone unnoticed.  Having gained access to early beta versions of the product, we conducted a comparative study of functionality and performance. <br><blockquote>  The results of the research inspired us to launch the project, the outcome of which was to be the embedding of the C3D Viewer component as a means of viewing and annotating the secondary presentation of 3D models in LOTSMAN: PLM. <br><br><ul><li>  Acceleration of saving to C3D format compared to PDF - from 6 to 18 times! <br>  No correlation was found with the size of the models and the number of components. </li><li>  C3D files are smaller than PDF files - from 2 to 39 times! </li><li>  Download speed of C3D files is faster than PDF download speed - from 6 to 264 times. <br>  No correlation was found with the size of the models and the number of components. </li><li>  The quality and smoothness of the display while rotating with C3D Viewer is much higher than the quality of Adobe Reader. <br>  For unknown reasons, measuring FPS in Adobe Reader did not always work.  In cases where metering attempts were successful, the FPS did not exceed the value "5".  C3D Viewer "twists" with a speed of 30-100 ++ FPS on different models. </li></ul></blockquote>  The interest in the project was mutual, which in the best way affected the quality of interaction with the developers and the speed of solving various problems. <br>  According to our requests, the C3D Labs team has developed a functional for annotating 3D models and provided localization in Russian. <br><br>  A number of improvements to the C3D Viewer API were due to the specific use of the component in our application.  As a result, new methods and events appeared in the API, which allowed us to implement our own mechanism for indicating the progress of model loading and emergency interruption / cancellation of loading. <br><br>  And since I mentioned the high cost of eDrawings, it is fair to say that the C3D Viewer is also not free for us, but the conditions for its use are much more democratic. <br><br><h2>  <font color="#00B2FF">.4 Embedding</font> </h2><br>  At the beginning, you should give a brief technical description of the system into which we were to embed C3D Viewer, the LOTSMAN: PLM client application. <br><br>  This is a desktop Win32 application with an MDI interface, written in Delphi 2006. <br>  The layout of the child MDI windows is dynamic, built on the basis of the description of a set of interrelated "panels", each of which represents a certain aspect of information about the specified object. <br>  The C3D Viewer software component is the ActiveX COM Library (C ++, Qt). <br><br>  The API is simple and compact, the key operations are asynchronous, they are executed in a separate thread, so the interaction with the component is based on calling methods and handling events. <br><br>  The prototype of the secondary view module was assembled and integrated into LOTSMAN: PLM took only a couple of hours, but other ‚Äútrifles‚Äù required much more time. <br><br>  We have implemented our own toolbars, a context menu, a panel displaying the structure of the model, and a panel with a list of annotations in the required volume and form, in accordance with the general visual style of the application interface. <br><br>  We use the component in several modes of working with the secondary view: built-in view, full-screen view and annotation mode. <br><br><img src="https://habrastorage.org/webt/de/rl/s0/derls0l1m_xixnvwalgwuh-f3hg.png"><br><br><img src="https://habrastorage.org/webt/vg/un/o_/vguno_zvzrhc6ul7wkrgis6tv-q.png"><br><br><h3>  What were the difficulties: </h3><br><h3>  Import Type Library Description </h3><br>  One of the first problems was that Delphi 2006 incorrectly imports the type library description from the ActiveX C3D Viewer, which is written in C ++ c Qt. <br><br>  They got out by applying the import utility of the Delphi 2010 type library, which, however, also did not give 100% the correct result - we had to fix a dozen lines manually. <br><br><h3>  Difficulties of "adoption" </h3><br>  In our application, the user has a WYSIWYG layout editor, which allows you to add and move ‚Äúpanels‚Äù with information.  On one of these panels is located and ActiveX C3D Viewer. <br><br>  It turned out that when you move the panel from the ActiveX C3D Viewer to another ‚Äúcontainer‚Äù, its partial ‚Äúdestruction‚Äù occurs. <br><br>  <i>Found out that the reason - in a specific implementation of the mechanism for changing the parent window VCL Delphi.</i>  <i>In short, winapi eventually calls DestroyWindow ActiveX C3D Viewer, after which it starts to consider itself "killed", and Delphi, meanwhile, continues to consider it "alive."</i> <br><br>  We bypassed this problem by placing ActiveX in a special container that knows how to determine that the parent window is being changed, and at this moment it correctly releases ActiveX and creates it again. <br><br><h3>  Memory problems </h3><br>  We have a 32-bit application, and ‚ÄúOut of memory‚Äù has not been canceled.  The possibility of the appearance of huge assemblies in conditions of a limited 2 GB of RAM size inevitably led to the fact that the problem became more acute. <br><br>  Particularly acute was the fact that if the memory was running out during the loading of the model in the C3D Viewer, this led to an unexpected abnormal termination of the entire application. <br>  The reason could not be determined immediately.  I had to develop my own PostMortem Debugger based on the sampling profiler, which restored the stack using the JDBG debug information. <br><br>  Understanding the reason, we started by increasing the available RAM limit to 3.5 GB by adding the IMAGE_FILE_LARGE_ADDRESS_AWARE flag to the EXE header, somewhat reducing the memory consumption in your application, but did not enjoy the result. <br><br>  The fact is that if you have a 32-bit MDI application (with a multi-window interface), then the user, in principle, can open an unlimited common sense number of windows.  And he will do it.  Has the right to. <br><br>  To reduce the likelihood of problems associated with a lack of memory, we have embedded in the application mechanism to control and optimize memory usage.  When a certain limit is reached, the currently inactive MDI windows are plunged into ‚Äúsleep mode‚Äù, thereby freeing up resources. <br><br><h3>  Problems with virtual machines </h3><br>  C3D Viewer requires at least 2.1 to display OGL version.  We tried different virtual machines, here is some information about it: <br><br>  Hyper-V - C3D Viewer does not work. <br>  Virtual Box 4.1.44 + Window 7 - C3D Viewer works. <br>  VMWare Player v14 (Accelerate 3D Graphics + OGL v3 in settings) - C3D Viewer works. <br><br>  As a result, the active phase of development and debugging of a new viewer took about two months.  Another two or three weeks we spent on the elimination of errors. <br><br><h2>  <font color="#00B2FF">.5 What's ahead</font> </h2><br>  In the next versions of the C3D Viewer, we hope to see the dynamic section functions, model measurements, new features for working with PMI, model configurations in conjunction with KOMPAS-3D and LOTSMAN: PLM. <br><br><h2>  <font color="#00B2FF">PS</font> </h2><br>  There is a free version for exploring the C3D Viewer (download <a href="http://c3dlabs.com/ru/products/viewer/">here</a> ).  It does not include the API and some other features.  The version for embedding can be requested for testing from the C3D Labs developers. <br><br> <a href=""><img src="https://habrastorage.org/webt/gr/qb/xs/grqbxs22huelwxkagcxl2jdczm8.png"></a>  Sergey Ershov, Head of Applied Workstation, ASCON. </div><p>Source: <a href="https://habr.com/ru/post/354230/">https://habr.com/ru/post/354230/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354216/index.html">Forbes: Alibaba and Uber have become the most profitable companies for investors</a></li>
<li><a href="../354220/index.html">Applying recurrent layers to solve multiple paths</a></li>
<li><a href="../354224/index.html">slowpoke is not the fastest database</a></li>
<li><a href="../354226/index.html">Another option for generating thumbnails for images using AWS Lambda & golang + nodejs + nginx</a></li>
<li><a href="../354228/index.html">Hyper-v cluster of two nodes, without external storage or hyperconvergence on the knee</a></li>
<li><a href="../354232/index.html">How not to go crazy with Scrum? Experience a growing project</a></li>
<li><a href="../354234/index.html">Release Node.js 10 and NPM 6</a></li>
<li><a href="../354236/index.html">Why the creation of a simple preview on the links in Wikipedia took four years</a></li>
<li><a href="../354238/index.html">Victor Gamov on Apache Kafka on jug.msk.ru</a></li>
<li><a href="../354240/index.html">Ode to young professionals</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>