<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How We Implemented DevOps: Publishing an Image to Docker Hub Using Visual Studio Team Services</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue the series of articles ‚Äú How we implemented DevOps ‚Äù from the Vorlon.JS team. Under the cat, you will learn how they used the Visual Studi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How We Implemented DevOps: Publishing an Image to Docker Hub Using Visual Studio Team Services</h1><div class="post__text post__text-html js-mediator-article">  We continue the series of articles ‚Äú <a href="https://habrahabr.ru/search/%3Fq%3D%255Bjourney2devops%255D%26target_type%3Dposts">How we implemented DevOps</a> ‚Äù from the Vorlon.JS team.  Under the cat, you will learn how they used the Visual Studio Team Services (VSTS) build system to automate the creation and publication of an image in the repository using a Linux agent. <br><br><img src="https://habrastorage.org/files/341/444/b32/341444b3292b42fd9a52beb3b9fd8564.jpg"><br><a name="habracut"></a><br><h2>  Introduction </h2><br>  <a href="https://aka.ms/habr_320238_1">Docker Hub</a> allows you to make the images of the containers you create available to all Docker users. <br><br><img src="https://habrastorage.org/files/1d5/933/cdd/1d5933cdd3b44490a18c5416c997b99e.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Note</b>  This article will be relevant for Docker Trusted Registry users. <br><br><h2>  Configuring the Linux build agent </h2><br>  The new <a href="https://aka.ms/habr_320238_2">build system Visual Studio Team Services</a> works with build agents.  You can use the free Windows agent in the cloud (Hosted agent), as well as download agents under Windows, Linux or Mac OS (Default agent), and install them yourself.  This will allow you to run processes that are not supported by the Windows agent in the cloud, or use already configured scripts and tools that may already be deployed on your Linux machines. <br><br>  In this case, we need a <a href="https://aka.ms/habr_320238_3">Docker</a> to build the image, so we settled on an agent for Linux. <br><br>  First you need a Linux virtual machine.  You can create it in <a href="https://aka.ms/habr_320238_4">Microsoft Azure</a> .  In this case, we deployed a simple machine with <a href="https://aka.ms/habr_320238_5">Ubuntu 14.04 LTS from the Azure Marketplace</a> . <br><br><img src="https://habrastorage.org/files/099/bb4/d85/099bb4d859cc439ba3afd5b8602f6c5c.png"><br><br>  After starting the machine, start the SSH session and install everything you need for the build process.  In our case, the <a href="https://aka.ms/habr_320238_6">docker-engine</a> and Node.js tools are installed on the machine.  In this case, we don‚Äôt need anything else to build the Vorlon.JS Dashboard Docker image. <br><br>  Next, you need to configure the VSTS agent.  To access your account, the agent will need a Personal Access Token.  To create one, click your name on the VSTS portal (top right) and select <i>My profile</i> .  On the <i>Security</i> tab, click the <i>Add</i> button on the right pane.  Click <i>Create Token</i> and save the generated token, you will need it to start the agent. <br><br>  You must now authorize your account to use the agent pool.  Click the settings icon in the upper right corner of the VSTS dashboard.  Click the <i>Agent Pools</i> tab and click <i>Default pool</i> .  Add your account in two groups: <i>Agent Pool Administrator</i> and <i>Agent Pool Service Accounts</i> . <br><br>  Go back to the Linux virtual machine and create the <i>vsts-agent</i> directory.  Go to this directory and enter the following command: <br><br><pre><code class="javascript hljs">curl -skSL https:<span class="hljs-comment"><span class="hljs-comment">//aka.ms/xplatagent | bash</span></span></code> </pre> <br>  The system downloads everything you need to run the VSTS agent. <br><br>  To configure and start the agent, enter: <br><br><pre> <code class="javascript hljs">./run.sh</code> </pre> <br>  The system will ask you to enter the following information. <br><br><ul><li>  <b>username</b> - this field is ignored if a personal access token is used, so you can enter absolutely any username; </li><li>  <b>password</b> - enter your Personal Access Token saved earlier; </li><li>  <b>agent name</b> - the name of the agent (will be used to display the agent in the VSTS agent queues); </li><li>  <b>pool name</b> - you can leave the default; </li><li>  <b>server url</b> - URL of your account (https://youraccount.visualstudio.com). </li></ul><br>  For all other parameters, leave the default values.  Wait for the agent to start. <br><br>  After launch, you can return to the <i>Agent pool</i> settings on the VSTS portal, where you will see the agent you just configured. <br><br><img src="https://habrastorage.org/files/ce3/754/9e4/ce37549e4e3743c2a8b31bcccfec60a1.png"><br><br>  <b>Note</b>  All the necessary information about the VSTS Agent for Linux and Mac OS can be found on <a href="https://aka.ms/habr_320238_7">this</a> page. <br><br><h2>  Preparing a build definition to create a Docker image </h2><br>  Creating a docker image is actually very simple.  For Vorlon.JS we have two suitable elements in our project repository: <br><br>  1. <a href="https://aka.ms/habr_320238_8">Dockerfile</a> to build an image. <br><br><pre> <code class="javascript hljs"># use the node argon (<span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>) image <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> base FROM node:argon # <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> the Vorlon.JS Docker Image maintainer MAINTAINER Julien Corioland (Microsoft, DX) # Expose port <span class="hljs-number"><span class="hljs-number">1337</span></span> EXPOSE <span class="hljs-number"><span class="hljs-number">1337</span></span> # <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> the entry point ENTRYPOINT [‚Äúnpm‚Äù, ‚Äústart‚Äù] # Create the application directory RUN mkdir -p /usr/src/vorlonjs # Copy the application content COPY . /usr/src/vorlonjs/ # <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> app root <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> working directory WORKDIR /usr/src/vorlonjs # Run npm install RUN npm install</code> </pre> <br>  2. <a href="https://aka.ms/habr_320238_9">Bash script</a> that uses docker build, docker login and docker push commands to build the image, log in to the Docker Hub and send the created image. <br><br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">#!/bin/bash # get version from package.json appVersion=$(cat package.json | jq -r '.version') echo ‚ÄúBuilding Docker Vorlon.JS image version $appVersion‚Äù docker build -t vorlonjs/dashboard:$appVersion . docker login ‚Äìusername=‚Äù$1‚Ä≥ ‚Äìpassword=‚Äù$2‚Ä≥ echo ‚ÄúPushing image‚Ä¶‚Äù docker push vorlonjs/dashboard:$appVersion docker logout exit 0</span></span></code> </pre> <br>  As you can see, in the Bash script we get the version directly from the <i>package.json</i> file, we also declare the variables <i>$ 1</i> and <i>$ 2</i> , which VSTS will use when starting a new build. <br><br>  Let's create a definition for your build! <br><br>  Go to the <i>BUILD</i> section of your VSTS project and add a new build definition.  Start with an empty template.  In this case, we just need to run the shell script. <br><br><img src="https://habrastorage.org/files/0f3/b9a/7f6/0f3b9a7f6117451d8abf7bf4c8737c9f.png"><br><br>  This step is simple enough to configure, just specify the path to the desired Bash-script and the arguments that should be passed to this script.  As you can see from the screenshot above, the username and password are not directly used, instead we set two variables: <i>$ (docker.username)</i> and <i>$ (docker.password)</i> . <br><br>  These variables can be configured on the Variables tab of the assembly definition. <br><br><img src="https://habrastorage.org/files/d0a/dea/be3/d0adeabe380a4f9ebf7b5576bed430af.png"><br><br>  These are the credentials of your Docker Hub profile, which are passed as arguments to the <a href="https://aka.ms/habr_320238_10">docker login command</a> . <br><br>  Go to the <i>General</i> tab and make sure that the default definition of the assembly uses the queues of agents that you added the Linux VSTS agent to. <br><br>  That's all!  Now just click <i>Save</i> to save the assembly definition and put the new assembly in the queue. <br><br><img src="https://habrastorage.org/files/a8c/60b/7f7/a8c60b7f7e1246a4a2c615bcd15ec7dd.png"><br><br>  Immediately after creating the assembly, the image will be published in the Docker Hub repository. <br><br><img src="https://habrastorage.org/files/08c/f2a/c9f/08cf2ac9f67943ce9d4aba67645b7dce.png"><br><br>  Thus, we have made the <a href="https://aka.ms/habr_320238_11">VorlonJS</a> image available for all <a href="https://aka.ms/habr_320238_12">Docker Hub</a> users.  Want to try it out?  Just enter the following command on any Docker host: <br><br><pre> <code class="javascript hljs">docker run -d -p <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">1337</span></span> vorlonjs/dashboard:<span class="hljs-number"><span class="hljs-number">0.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span></code> </pre> <br>  Use Visual Studio Team Services to build your own images.  You will love it! </div><p>Source: <a href="https://habr.com/ru/post/320238/">https://habr.com/ru/post/320238/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320228/index.html">Automation of load testing: a bunch of Jmeter + TeamCity + Grafana</a></li>
<li><a href="../320230/index.html">We test the Fujitsu PRIMERGY RX2530 M2 server</a></li>
<li><a href="../320232/index.html">R Development: Cycle Mysteries</a></li>
<li><a href="../320234/index.html">Learning lessons from 7 games born on gamejams</a></li>
<li><a href="../320236/index.html">‚ÄúA‚Äù means ‚ÄúAstral‚Äù. Interview with Ivan Polyakov (Apus Software)</a></li>
<li><a href="../320240/index.html">Basic planning tools and ways to implement them</a></li>
<li><a href="../320242/index.html">Clean Recycler Adapter. Part 1</a></li>
<li><a href="../320244/index.html">CodingFuture + Puppet. Part VI: Topical Blacklists and Secure Knock</a></li>
<li><a href="../320246/index.html">Designer folder designer. Create backups</a></li>
<li><a href="../320248/index.html">Focusing on security: building a cloud-managed network using Cisco Meraki MX equipment</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>