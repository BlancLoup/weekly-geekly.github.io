<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making your personal Skype, step by step instructions for creating WebRTC applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="WebRTC allows real-time audio / video communication through a browser (  and  ). 

 In this topic, I will explain how to implement the simplest WebRTC...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making your personal Skype, step by step instructions for creating WebRTC applications</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/727/ba4/ce7/727ba4ce74e9b4a610a9ace27e03c14c.png" alt="Webrtc"><br><br>  WebRTC allows real-time audio / video communication through a browser ( <img src="https://habrastorage.org/getpro/habr/post_images/f7d/a2c/eb0/f7da2ceb020805bb54081c8cbf346b3e.png" alt="firefox">  and <img src="https://habrastorage.org/getpro/habr/post_images/3bb/c82/7bd/3bbc827bd8ddd527661949013075dab0.png" alt="chrome">  ). <br><br>  In this topic, I will explain how to implement the simplest WebRTC application. <br><a name="habracut"></a><br><h4>  1. getUserMedia - access to media devices (microphone / webcam) </h4><br>  Nothing complicated, with the help of 10 lines of javascript code you can see and hear yourself in the browser ( <a href="http://jsfiddle.net/HRJP8/">demo</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Create index.html: <br><br><pre><code class="javascript hljs">&lt;video autoplay&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">video</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;script&gt; navigator.getUserMedia = navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia; navigator.getUserMedia({ <span class="hljs-attr"><span class="hljs-attr">audio</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">video</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, gotStream, streamError); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gotStream</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stream</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'video'</span></span>).src = URL.createObjectURL(stream); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">streamError</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(error); } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/script&gt;</span></span></code> </pre> <br>  You can apply <a href="http://html5-demos.appspot.com/static/css/filters/index.html">css3 filters</a> to the video element. <br><br>  What is distressing here is that at this stage of WebRTC development I cannot tell the browser ‚ÄúI trust this site, always give it access to my camera and microphone‚Äù and I need to click Allow after each page open / refresh. <br><br>  Well, it would not be superfluous to remind you that if you gave access to the camera in one browser, another will try to get PERMISSION_DENIED when trying to access it. <br><br><h4>  2. Signaling server (signaling server) </h4><br>  Here I am violating the sequence of most of the ‚Äúwebrtc getting started‚Äù instructions because as a second step they demonstrate the possibilities of webRTC on one client, which personally only added confusion to the explanation. <br><br>  A signaling server is a WebRTC coordinating center that provides communication between clients, initialization and closing of a connection, and error reporting. <br><br>  In our case, the signal server is Node.js + socket.io + node-static, it will listen on port 1234. <br>  Plus, node-static can render index.html, which will make our application as simple as possible. <br><br>  In the application folder, install the necessary: <br><br><pre> <code class="bash hljs">npm install socket.io npm install node-static</code> </pre><br>  Download <a href="http://pastebin.com/raw.php%3Fi%3DVvsWandK">server.js</a> to the application folder.  I will not analyze the server part, it is quite simple to understand, and besides, it is not a direct part of WebRTC, so just start the server: <br><br><pre> <code class="bash hljs">node server.js</code> </pre><br><br><h4>  3. WebRTC </h4><br>  Now we are ready to work directly with WebRTC.  Download the working <a href="http://pastebin.com/raw.php%3Fi%3De3RArdtq">index.html</a> completely, then I will disassemble it piece by piece. <br><br><h5>  3.0  Standards have not yet been adopted, so for now we have to use prefixes for different browsers: </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> PeerConnection = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.mozRTCPeerConnection || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.webkitRTCPeerConnection; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> IceCandidate = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.mozRTCIceCandidate || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.RTCIceCandidate; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> SessionDescription = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.mozRTCSessionDescription || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.RTCSessionDescription; navigator.getUserMedia = navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia;</code> </pre><br><br><h5>  3.1.  getUserMedia </h5><br><pre> <code class="javascript hljs">navigator.getUserMedia( { <span class="hljs-attr"><span class="hljs-attr">audio</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">video</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, gotStream, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(error) } ); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gotStream</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stream</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"callButton"</span></span>).style.display = <span class="hljs-string"><span class="hljs-string">'inline-block'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"localVideo"</span></span>).src = URL.createObjectURL(stream); pc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PeerConnection(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); pc.addStream(stream); pc.onicecandidate = gotIceCandidate; pc.onaddstream = gotRemoteStream; }</code> </pre><br>  We already analyzed this part at the very beginning of the post, except that in the gotStream function we create PeerConnection and add two event handlers: <br><ul><li>  <code>onicecandidate</code> gives us the generated ICE Candidate, which we will transmit to the signal server, which in turn will transmit them to the other person </li><li>  <code>onaddstream</code> will be called when we receive the interlocutor's media stream </li></ul><br><br><h5>  3.2.  Call offer </h5><br>  Call Offer is the initialization of a WebRTC session.  Call Offer and Call Answer (the next step) have the <a href="http://en.wikipedia.org/wiki/Session_Description_Protocol">SDP</a> (Session Description Protocol) format and are used to describe the parameters (resolution, codec, etc.) of the initialization of client media streams. <br><br>  IMPORTANT: Customers must give access to media devices BEFORE sending a Call Offer. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createOffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ pc.createOffer( gotLocalDescription, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(error) }, { <span class="hljs-string"><span class="hljs-string">'mandatory'</span></span>: { <span class="hljs-string"><span class="hljs-string">'OfferToReceiveAudio'</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">'OfferToReceiveVideo'</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } } ); }</code> </pre><br><br><h5>  3.3.  Call answer </h5><br>  Call Answer sends the caller immediately after receiving the Call Offer.  I note that the callback function of <code>createOffer()</code> and <code>createAnswer()</code> is the same - gotLocalDescription, i.e.  localDescription for one client created by the function <code>createOffer()</code> , for another - by the function <code>createAnswer()</code> . <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createAnswer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ pc.createAnswer( gotLocalDescription, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(error) }, { <span class="hljs-string"><span class="hljs-string">'mandatory'</span></span>: { <span class="hljs-string"><span class="hljs-string">'OfferToReceiveAudio'</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">'OfferToReceiveVideo'</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } } ); }</code> </pre><br><br><h5>  3.4.  Ice candidate </h5><br>  <a href="http://en.wikipedia.org/wiki/Interactive_Connectivity_Establishment">ICE</a> (Interactive Connectivity Establishment) Candidate performs the function of connecting clients by setting the path between clients over which media streams will be transmitted.  We also generate the ICE Candidate to the signal server, a description of the processing of messages from the signal server in the next step. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gotIceCandidate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.candidate) { sendMessage({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'candidate'</span></span>, <span class="hljs-attr"><span class="hljs-attr">label</span></span>: event.candidate.sdpMLineIndex, <span class="hljs-attr"><span class="hljs-attr">id</span></span>: event.candidate.sdpMid, <span class="hljs-attr"><span class="hljs-attr">candidate</span></span>: event.candidate.candidate }); } }</code> </pre><br><br><h5>  3.5.  Processing messages from the signaling server </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> socket = io.connect(<span class="hljs-string"><span class="hljs-string">''</span></span>, {<span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-number"><span class="hljs-number">1234</span></span>}); socket.on(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.type === <span class="hljs-string"><span class="hljs-string">'offer'</span></span>) { pc.setRemoteDescription(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SessionDescription(message)); createAnswer(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.type === <span class="hljs-string"><span class="hljs-string">'answer'</span></span>) { pc.setRemoteDescription(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SessionDescription(message)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.type === <span class="hljs-string"><span class="hljs-string">'candidate'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> candidate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IceCandidate({<span class="hljs-attr"><span class="hljs-attr">sdpMLineIndex</span></span>: message.label, <span class="hljs-attr"><span class="hljs-attr">candidate</span></span>: message.candidate}); pc.addIceCandidate(candidate); } });</code> </pre><br>  The code is simple, but I will explain: <br><ul><li>  as soon as we received a call offer, we call createAnswer </li><li>  when receiving both Call Offer and Call Answer, we call the <code>setRemoteDescription</code> with the received SDP </li><li>  when receiving ICE Candidate we call addIceCandidate </li></ul><br><br><h5>  3.6.  gotRemoteStream </h5><br>  If everything went well, the <code>onaddstream</code> handler from step 3.1 will be called, which will contain the media stream from the interlocutor. <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gotRemoteStream</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"remoteVideo"</span></span>).src = URL.createObjectURL(event.stream); }</code> </pre><br><br>  Let me remind you that the entire source code of the application can be found <a href="http://pastebin.com/raw.php%3Fi%3De3RArdtq">here</a> . <br><br><h4>  Literature: </h4><br><ul><li>  <a href="http://www.webrtc-experiment.com/docs/webrtc-for-beginners.html">www.webrtc-experiment.com/docs/webrtc-for-beginners.html</a> </li><li>  <a href="http://bitbucket.org/webrtc/codelab">bitbucket.org/webrtc/codelab</a> </li><li>  <a href="http://html5videoguide.net/presentations/LCA_2013_webrtc/">html5videoguide.net/presentations/LCA_2013_webrtc</a> </li><li>  <a href="http://hacks.mozilla.org/category/webrtc/as/complete/">hacks.mozilla.org/category/webrtc/as/complete</a> </li><li>  <a href="http://www.html5rocks.com/en/tutorials/webrtc/basics/">www.html5rocks.com/en/tutorials/webrtc/basics</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/198632/">https://habr.com/ru/post/198632/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198616/index.html">iPad Air (5), iPad Mini Retina, OS X, iLife, iWorks</a></li>
<li><a href="../198618/index.html">Harbor - new face xBase family</a></li>
<li><a href="../198620/index.html">HTML Academy, Habr and Crowd Funding</a></li>
<li><a href="../198622/index.html">Maria Bondarenko - Managing customer experience (talk from SPM Conference)</a></li>
<li><a href="../198626/index.html">Confederate Express - a game about survival in the harsh retro tones, ‚Äúwritten‚Äù by the masters of modern pixel art (Kickstarter Campaign)</a></li>
<li><a href="../198634/index.html">Mobile Studio Positioning</a></li>
<li><a href="../198636/index.html">The guy from the Czech Republic repeated the design of iOS7 in the Word</a></li>
<li><a href="../198638/index.html">Vavki, phantomashki and data - Yandex knows which cities they are in</a></li>
<li><a href="../198640/index.html">Yate5 released</a></li>
<li><a href="../198642/index.html">Principles of successful technical support</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>