<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Connect the HP tape library via Fiber Channel to an ESXi 5.5 host</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In today's Mythbreakers series, we will cover the topic of connecting the HP StoreEver tape library via the Fiber Channel protocol to an ESXi 5.5 host...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Connect the HP tape library via Fiber Channel to an ESXi 5.5 host</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/8f0/17b/a29/8f017ba29a4445749609114159ce4d96.jpg"><br><br>  In today's Mythbreakers series, we will cover the topic of connecting the HP StoreEver tape library via the Fiber Channel protocol to an ESXi 5.5 host without additional maps and Direct path IO Passthrough. <br><blockquote>  Note: VMware does not support Tape Drives directly to ESXi 5.x. <br><br>  VMware, <a href="https://kb.vmware.com/selfservice/microsites/search.do%3Fcmd%3DdisplayKC%26docType%3Dkc%26externalId%3D1016407">KB1016407</a> </blockquote><br>  Does not support - does not mean does not work. <br><blockquote>  Yes, all the same, nothing will work for you!  Once VMware said - not supported, do not even try.  I'd rather connect it directly to my favorite HP DL 580. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Incredulous administrator </blockquote><br>  This is not entirely true.  Yes, we will create an unaccompanied configuration that works on an honest word, but passes tests in the utilities of the HPE Library and Tape Tools, is recognized and <abbr title="Good load testing is required. The changer is visible, the cassette loads, reads. It's funny, but I can't check the record, because the wrong generation of tapes was loaded. But while the memory is alive - I present travel notes to the esteemed public.">works in Veeam Backup and Replication</abbr> .  It is good to be healthy and rich when there is a physical server with FC HBA for backup.  If, however, you need to make ‚Äúto work‚Äù out of emptiness, if you want <b>to understand a little how the</b> ESXi <b>storage subsystem is arranged</b> - welcome under cat. <br><a name="habracut"></a><br>  Let's start with a small introduction. <br><br><h4>  How the ESXi Storage Subsystem Works </h4><br>  Before you begin to understand why nothing works, you should refresh something in memory.  How the hypervisor storage subsystem is arranged, what utilities are used when configuring and where to look for errors - this is what we will devote a few lines. <br><br><img src="https://habrastorage.org/files/147/b37/745/147b37745d8f4ae596e6e7e1fb693d85.png"><br>  The VMware Pluggable Storage Architecture Framework loads the Multipath Plugin, which is generally responsible for I / O operations of certain classes of devices. <br>  Included with the hypervisor are two plugins - the Native Multipath Plugin (NMP) and the ‚ÄúMASK_PATH‚Äù plug-in <abbr title="If you have ever disconnected a dozen RDM disks in ESXi 4.x, then you will not forget MASK_PATH.">hiding unnecessary devices</abbr> .  Some vendors develop their own MP plugins, such as EMC PowerPath / VE or Symantec / Veritas DMP. <br><br>  <abbr title="Native Multipath Plugin">NMP</abbr> turn implements its functionality through plugins Path Selection Plugin (PSP) and Storage Array Type Plugin (SATP). <br><br>  <abbr title="Path Selection Plugin">The PSP</abbr> deals directly with I / O and implements a policy of balancing traffic between multiple active paths.  Branded PSP ( <a href="https://kb.vmware.com/selfservice/microsites/search.do%3Flanguage%3Den_US%26cmd%3DdisplayKC%26externalId%3D1011340">hence the policy</a> ) only three = <abbr title="Most Recently Used">MRU</abbr> , <abbr title="Round robin">RR</abbr> , Fixed.  There are vendorskie PSP.  If an error occurs during an I / O operation, the PSP sends it to the SATP and the SATP <a href="https://kb.vmware.com/selfservice/microsites/search.do%3Flanguage%3Den_US%26cmd%3DdisplayKC%26externalId%3D1003433">responds to it</a> . <br><br>  <abbr title="Storage Array Type Plugin">SATP</abbr> is responsible for selecting active (optimal) paths when working with a specific array, monitoring the state of the paths;  it responds to the <a href="https://en.wikipedia.org/wiki/Key_Code_Qualifier">SCSI Sense codes</a> returned by the array (some of the codes are the same, and some may vary from vendor to vendor).  It is the SATP that polls the ALUA arrays with the <abbr title="Report Target Port Group">RTPG</abbr> command to select the optimized paths.  The behavior of the plugin is "tuned" with additional options. <br><br>  For devices, rules have been created that determine how exactly MP and SATP handle this or that device. <br>  It sounds intricate, but in reality everything is much simpler. <br><br>  To work, you need to enable SSH on an ESXi host. <br><br>  Get the list: <br>  MP Plugins: <br><img src="https://habrastorage.org/files/ad9/e6a/010/ad9e6a0106a74ca2b1d73cbd895186f8.png"><br><br>  <abbr title="Storage Array Type Plugin">SATP</abbr> plugins: <br><img src="https://habrastorage.org/files/ae5/601/7cc/ae56017ccc82429b930aa98a3fac52b6.png"><br><br>  <abbr title="Path Selection Plugin">PSP</abbr> plugins: <br><img src="https://habrastorage.org/files/0d4/122/054/0d4122054bd0425f90bd25b2c2d8fece.png"><br><br>  And here is the complete puzzle: <br><img src="https://habrastorage.org/files/011/e4d/0e5/011e4d0e5411409a8596122870c501f4.png"><br><br>  Each detected storage device is ‚Äúrun‚Äù through a set of rules to select the MP and SATP plugins. <br><br>  MPP selection rules: <br><img src="https://habrastorage.org/files/ab6/88e/8c5/ab688e8c5a004cdf8e5b0de675afae37.png"><br><br>  SATP selection rules: <br><pre><code class="bash hljs">esxcli storage nmp satp rule list</code> </pre> <br>  The list of rules is very long, I will give a useful excerpt from the list: <br><img src="https://habrastorage.org/files/b02/44c/eb9/b0244ceb9cf2449c8aafaed2e999e746.PNG"><br><br><div class="spoiler">  <b class="spoiler_title">Little military trick</b> <div class="spoiler_text">  Please note that you can gain additional benefits from the rules.  HCL for ESXi 5.5 says that the <a href="https://www.vmware.com/resources/compatibility/detail.php%3FdeviceCategory%3Dsan%26productid%3D3301">HP EVA array with the HV200 controller is not supported</a> .  In fact, the plugin and rules are in place, and the array works great. <br></div></div><br>  There are no PSP selection rules, for most SATPs, the PSP is specified by default and can be changed manually from the interface. <br>  The prologue is finished, let's proceed to the first part - connecting the library. <br><br><h4>  Why not so easy to take and connect the library </h4><br>  The HP SCSI library is represented by a set of LUNs of one SCSI Target, for example: <br>  LUN 0 - HP Fiber Channel Tape <br>  LUN 1 - HP Fiber Channel Medium Changer <br><br>  Check with the training manual: <br><blockquote>  Note: ESXi / ESX supports SCSI tape drives and tape drives only.  If you are using a stand-alone tape drive, it‚Äôs a multi-LUN.  If you want to use your device <br><br>  VMware, <a href="https://kb.vmware.com/selfservice/microsites/search.do%3Fcmd%3DdisplayKC%26docType%3Dkc%26externalId%3D1016407">KB1016407</a> </blockquote><br>  Again, not by the rules.  HP StoreEver is a multi-LUN library, not a multi-target.  But this will not stop us. <br><br><h4>  We connect the drive </h4><br>  We connect the library to the SAN switch, configure the zoning so that the library can only be seen by one host and only by one card.  If you fail to do this - do not worry, disguise the plugin. <br><br>  Check that ESXi saw the streamer: <br><img src="https://habrastorage.org/files/61f/66f/0c8/61f66f0c82d1478c9ba346ee33d10548.png"><br>  Immediately record its identifier of the form <b>naa. {Your identifier}</b> . <br><br>  Go to Manage Paths to understand which plugin for working with arrays is selected for our device: <br><img src="https://habrastorage.org/files/703/9d6/339/7039d633915f446aab5a26b858614cd2.png"><br><br>  In our case, this is VMW_SATP_ALUA.  At the same time, the plugin works so well with the streamer that all paths to it at the same time are marked as dead.  It is logical to assume that the streamer is somewhat alien to both ALUA and multipassing.  Therefore, we will turn it into a simple local device. <br><blockquote>  Note: Since the VMW_SATP_LOCAL plugin is being used. <br><br>  VMware, <a href="https://kb.vmware.com/selfservice/microsites/search.do%3Fcmd%3DdisplayKC%26docType%3Dkc%26externalId%3D1026157%26sliceId%3D1%26docTypeID%3DDT_KB_1_1%26dialogID%3D148462933%26stateId%3D0%25200%2520149835456">KB1026157</a> </blockquote><br>  That is necessary. <br><br>  Let's look at the NMP settings for tape drive: <br><img src="https://habrastorage.org/files/d12/4f9/7d2/d124f97d23a3450a8da53d845095885e.png"><br>  That's right, using VMW_SATP_ALUA.  Recall that the esxcli storage nmp satp rule list rules are responsible for choosing the SATP plug-in. <br><br>  If the device does not fall under a specific rule, then it will be processed by one of the ‚Äúdefault‚Äù rules: <br><img src="https://habrastorage.org/files/89e/398/e58/89e398e585b54bc7b085db4a8297d84f.PNG"><br><br>  Logically, the device should have come under the rule of ‚ÄúFiber Channel Devices‚Äù, since the transport is ‚Äúfc‚Äù, but in fact the plug-in is assigned by the rule ‚ÄúAny array with ALUA support‚Äù.  Somewhere here there is a catch, but it is not crucial.  Our task is to write such a rule for tape drive so that it is processed by the VMW_SATP_LOCAL plugin (usually processing local devices like usb, ide, block). <br><br>  Let's look carefully at our device with the help of the command: <br><pre> <code class="dos hljs">esxcli storage core device list</code> </pre><br><img src="https://habrastorage.org/files/a56/e5e/29c/a56e5e29ccc7401fb42198d2e486f9f8.png"><br>  To create a rule, take the following unique properties of a tape drive: <br>  <b>Vendor</b> : HP <br>  <b>Model</b> : Ultrium 5-SCSI <br><br>  We write the rule: <br><pre> <code class="bash hljs">esxcli storage nmp satp rule add --satp=VMW_SATP_LOCAL --vendor=<span class="hljs-string"><span class="hljs-string">"HP"</span></span> --model=<span class="hljs-string"><span class="hljs-string">"Ultrium 5-SCSI"</span></span></code> </pre><br>  Now you need to reinitialize all available paths to the streamer: <br><pre> <code class="bash hljs">esxcli storage core claiming reclaim -d naa.{ }</code> </pre><br>  As a result, the host will use only one path to the device and only on one HBA: <br><img src="https://habrastorage.org/files/9f4/537/a72/9f4537a72b0b414d8f66c22c09863f25.png"><br><br><div class="spoiler">  <b class="spoiler_title">If the host has several HBAs</b> <div class="spoiler_text">  It would be nice to disguise the streamer on other maps. <br></div></div><br>  In the virtual machine, add a new device: <br><img src="https://habrastorage.org/files/1b9/94e/d76/1b994ed762ac428086ef3910f66876b4.png"><br><br>  Device type "Tape HP": <br><img src="https://habrastorage.org/files/d04/831/2e1/d048312e18e34fadb4ef693c2319bfd6.png"><br><br>  Now you need to carefully select the Virtual Device Node.  <a href="https://kb.vmware.com/selfservice/microsites/search.do%3Fcmd%3DdisplayKC%26docType%3Dkc%26externalId%3D1016407%26sliceId%3D1%26docTypeID%3DDT_KB_1_1%26dialogID%3D148462432%26stateId%3D0%25200%2520149829114">The rules are as follows</a> : <br>  - Target number must match the real number.  In our case, this is Target 2. <br><img src="https://habrastorage.org/files/73f/076/af7/73f076af71834df2957dc3fe8bf3dbed.png"><br>  - on the adapter port should not be disk devices.  Hard disks of the virtual machine are usually associated with port 0, so the first suitable port is 1: 2 (1 is the SCSI controller port number, 2 is the tape drive target number).  VMware Virtual SCSI Controllers - Dual Port.  If you specify port 3 or 4, a new controller will be automatically added. <br><br>  Download driver package <a href="http://h20564.www2.hpe.com/hpsc/swd/public/detail%3FswItemId%3DMTX_0ca2340f21c1478d8b1ff60949">HP StoreEver Tape Drivers for Windows</a> .  In a virtual machine, the package just does not install: <br><img src="https://habrastorage.org/files/1d8/d70/dae/1d8d70dae4ad4d758263a35bbb41e5e7.png"><br><br>  Unpack it with 7zip and run setup.exe: <br><img src="https://habrastorage.org/files/c32/2eb/cba/c322ebcbae624394a388b72fa0725bc9.png"><br>  In the device manager, the streamer is ready! <br><img src="https://habrastorage.org/files/6bc/e84/414/6bce84414e77472c9a480097b403db06.png"><br><br><h4>  We connect library </h4><br><br>  It is not enough to connect a streamer, for normal operation you will need to see in the operating system and the library itself, also known as a ‚Äúchanger‚Äù or ‚Äúrobot‚Äù. <br><br>  As we see from the list, the path to the library is missing: <br><img src="https://habrastorage.org/files/61f/66f/0c8/61f66f0c82d1478c9ba346ee33d10548.png"><br><br>  Referring to the magazine ESXi: <br><pre> <code class="bash hljs">tail -n 100 vmkwarning.log</code> </pre><br><pre> <code class="bash hljs">NMP: nmp_SatpClaimPath:2093: SATP <span class="hljs-string"><span class="hljs-string">"VMW_SATP_ALUA"</span></span> could not add path <span class="hljs-string"><span class="hljs-string">"vmhba1:C0:T2:L1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> device <span class="hljs-string"><span class="hljs-string">"Unregistered Device"</span></span>. Error Not found</code> </pre><br>  The SCSI Target ID of this unknown device matches the streamer, but the LUN number is 1. Obviously, our library cannot be recognized.  NMP tried to connect the library with the VMW_SATP_ALUA plugin, but it didn't work out. <br><blockquote>  This is a SATP rule that has been taken for a SATP rule. <br>  VMware, <a href="https://kb.vmware.com/selfservice/microsites/search.do%3Fcmd%3DdisplayKC%26docType%3Dkc%26externalId%3D1026157%26sliceId%3D1%26docTypeID%3DDT_KB_1_1%26dialogID%3D148462933%26stateId%3D0%25200%2520149835456">KB1026157</a> </blockquote><br>  Identify the device model: <br><pre> <code class="bash hljs">esxcfg-rescan vmhba1 grep ScsiScan /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/vmkernel.log</code> </pre><br><pre> <code class="bash hljs">016-07-20T06:30:37.502Z cpu6:33063)ScsiScan: 976: Path <span class="hljs-string"><span class="hljs-string">'vmhba2:C0:T1:L1'</span></span>: Vendor: <span class="hljs-string"><span class="hljs-string">'HP '</span></span> Model: <span class="hljs-string"><span class="hljs-string">'MSL G3 Series '</span></span> Rev: <span class="hljs-string"><span class="hljs-string">'6.20'</span></span></code> </pre><br>  The parameters we need are: <br>  Vendor: HP <br>  Model: MSL G3 Series <br><br>  Add a new rule for SATP: <br><pre> <code class="bash hljs">esxcli storage nmp satp rule add --satp=VMW_SATP_LOCAL --vendor=<span class="hljs-string"><span class="hljs-string">"HP"</span></span> --model=<span class="hljs-string"><span class="hljs-string">"MSL G3 Series"</span></span></code> </pre><br>  Make unclaim for the path <br><pre> <code class="bash hljs">esxcli storage core claiming unclaim -t location -A vmhba2 -C 0 -T 1 -L 1</code> </pre><br>  Rescan devices: <br><pre> <code class="bash hljs">esxcfg-rescan vmhba</code> </pre><br>  The path to the Medium Changer has been successfully added: <br><img src="https://habrastorage.org/files/141/251/18e/14125118e9044845b2dad8a0668a10cb.png"><br><br>  We add it to the virtual machine as ‚ÄúMedia HP‚Äù on the same SCSI Target ID as the drive, but on a different controller port (2: 2). <br><img src="https://habrastorage.org/files/822/375/853/822375853c844aabbd23800db28ebc27.png"><br>  Changer appeared in the virtual machine: <br><img src="https://habrastorage.org/files/50d/1c0/6b3/50d1c06b3dbd4ae3bb9e9bfd5ab4b8f7.png"><br><br>  <b>This is victory.</b> <br><br>  If you need to mask the drive (the changer is not necessary, it will not be detected, as we have already seen) on other ESXi hosts, then we act as in <a href="https://kb.vmware.com/selfservice/microsites/search.do%3Flanguage%3Den_US%26cmd%3DdisplayKC%26externalId%3D1029786">KB1029786</a> .  In short, we add rules so that our device is processed instead of NMP with the MASK_PATH plugin. <br><pre> <code class="bash hljs">esxcli storage core claimrule add -r 192 -t location -A vmhba{N} -C {C} -T {T} -L {0} -P MASK_PATH esxcli storage core claimrule load esxcli storage core claiming reclaim -d naa.{ }</code> </pre><br><br>  Thanks for attention. <br>  <a href="http://blogs.vmware.com/vsphere/2012/04/prioritizing-io-paths-in-the-event-of-a-failover.html">Do you know what you can now prioritize?</a> <br>  <a href="http://cormachogan.com/2013/02/12/pluggable-storage-architecture-psa-deep-dive-part-4/">Pluggable Storage Architecture (PSA) Deep-Dive</a> <br>  If timeouts occur in Veeam Backup: <a href="https://www.veeam.com/kb1887">https://www.veeam.com/kb1887</a> </div><p>Source: <a href="https://habr.com/ru/post/306026/">https://habr.com/ru/post/306026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306016/index.html">Features of installation and update 3CX v15</a></li>
<li><a href="../306018/index.html">Modern Code. Program Modern</a></li>
<li><a href="../306020/index.html">HR work in the eyes of the developer</a></li>
<li><a href="../306022/index.html">Log in to VK for people</a></li>
<li><a href="../306024/index.html">Self-employment is not freedom. The myth of the happy life of an entrepreneur</a></li>
<li><a href="../306028/index.html">CLion 2016.2 release: remote debugging, Doxygen format support, new code generation features and much more</a></li>
<li><a href="../306030/index.html">Software update and initial setup instructions for Nokia 7210 SAS-M</a></li>
<li><a href="../306032/index.html">Introduction to Veeam Agent for Linux</a></li>
<li><a href="../306034/index.html">Removing a key from a token with a non-recoverable key</a></li>
<li><a href="../306036/index.html">How to make the next bot in Telegram</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>