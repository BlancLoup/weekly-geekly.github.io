<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of two Dynamics CRM Online tenants using the Azure Service Bus and the Azure Cloud Service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I would like to share the experience of using Microsoft Azure for the integration of two cloud CRM systems. As part of the task, you ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of two Dynamics CRM Online tenants using the Azure Service Bus and the Azure Cloud Service</h1><div class="post__text post__text-html js-mediator-article">  In this article, I would like to share the experience of using Microsoft Azure for the integration of two cloud CRM systems.  As part of the task, you need to build a simple cloud-based application that exchanges messages between two Dynamics CRM Online implementations that are in different Office 365 subscriptions. We will look at the specifics of using the Azure Service Bus in the context of Dynamics CRM Online, not a lot of talk about supported interaction mechanisms role for the process of analyzing and processing messages. <br><a name="habracut"></a><br>  When implementing integration, which provides two branches of the company with important and relevant data, we need to ensure the delivery of messages, even if one of the systems does not respond to requests.  Naturally, in this case, we resort to the services of messaging systems, which can provide storage and deferred delivery in case of a lack of connection or any other problems. <br><br>  Speaking of the Microsoft cloud, I would like to note that the corporation today pays enough attention to integrating various products into one homogeneous system, which allows us to simplify and speed up the process of building and deploying solutions, as well as to avoid some annoying mistakes. <br><br>  If we talk about Dynamics CRM, then this product out of the box supports work with the Azure Service Bus, which allows you to send your data to a queue or section without a single line of code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  1. Configure Azure Service Bus to work with Dynamics CRM Online. </h4><br>  There is a specificity here.  In order to configure the integration between these two systems, the Service Bus must know something about CRM, and CRM must be authenticated correctly using the appropriate cloud bus services.  Today, Dynamics CRM supports authentication via ACS (Azure Active Directory Access Control).  You can read more about what ACS is in the following article: <a href="https://azure.microsoft.com/ru-ru/documentation/articles/active-directory-dotnet-how-to-use-access-control/">What is ACS</a> ? <br>  So, the first thing we need to do is actually create a Service Bus, which we will use to work with our message queue, but unfortunately it will not work out to create it in a simple way through the portal, since in this case the Service Bus will not support authentication via ACS.  In order to create a Service Bus with ACS support, use the Azure Power Shell.  Learn more about what an Azure Power Shell is and how to use it in the next article: <a href="https://azure.microsoft.com/ru-ru/documentation/articles/powershell-install-configure/">What is Azure PowerShell</a> ? <br><br><pre><code class="php hljs">[CmdletBinding(PositionalBinding=$True)] Param( <span class="hljs-comment"><span class="hljs-comment"># [Parameter(Mandatory = $true)] # [ValidatePattern("^[a-z0-9]*$")] [String]$Path = "q4depa2depb", # required needs to be alphanumeric [Bool]$EnableDeadLetteringOnMessageExpiration = $True , # optional default to false [Int]$LockDuration = 30, # optional default to 30 [Int]$MaxDeliveryCount = 10, # optional default to 10 [Int]$MaxSizeInMegabytes = 1024, # optional default to 1024 [Bool]$SupportOrdering = $True, # optional default to true # [Parameter(Mandatory = $true)] # [ValidatePattern("^[a-z0-9]*$")] [String]$Namespace = "sb4crm2crm", # required needs to be alphanumeric [Bool]$CreateACSNamespace = $True, # optional default to $false [String]$Location = "West Europe" # optional default to "West Europe" ) # Create Azure Service Bus namespace $CurrentNamespace = Get-AzureSBNamespace -Name $Namespace if ($CurrentNamespace) { Write-Output "The namespace [$Namespace] already exists in the [$($CurrentNamespace.Region)] region." } else { Write-Host "The [$Namespace] namespace does not exist." Write-Output "Creating the [$Namespace] namespace in the [$Location] region..." New-AzureSBNamespace -Name $Namespace -Location $Location -CreateACSNamespace $CreateACSNamespace -NamespaceType Messaging $CurrentNamespace = Get-AzureSBNamespace -Name $Namespace Write-Host "The [$Namespace] namespace in the [$Location] region has been successfully created." } $NamespaceManager = [Microsoft.ServiceBus.NamespaceManager]::CreateFromConnectionString($CurrentNamespace.ConnectionString); if ($NamespaceManager.QueueExists($Path)) { Write-Output "The [$Path] queue already exists in the [$Namespace] namespace." } else { Write-Output "Creating the [$Path] queue in the [$Namespace] namespace..." $QueueDescription = New-Object -TypeName Microsoft.ServiceBus.Messaging.QueueDescription -ArgumentList $Path $QueueDescription.EnableDeadLetteringOnMessageExpiration = $EnableDeadLetteringOnMessageExpiration if ($LockDuration -gt 0) { $QueueDescription.LockDuration = [System.TimeSpan]::FromSeconds($LockDuration) } $QueueDescription.MaxDeliveryCount = $MaxDeliveryCount $QueueDescription.MaxSizeInMegabytes = $MaxSizeInMegabytes $QueueDescription.SupportOrdering = $SupportOrdering $NamespaceManager.CreateQueue($QueueDescription); Write-Host "The [$Path] queue in the [$Namespace] namespace has been successfully created." }</span></span></code> </pre> <br>  The full version of the script I used is available <a href="https://blogs.msdn.microsoft.com/paolos/2014/12/02/how-to-create-service-bus-queues-topics-and-subscriptions-using-a-powershell-script/">here</a> . <br>  The script is quite simple, the parameters that can be used to create a queue are described in detail in the following article: <a href="http://gauravmantri.com/2015/06/22/azure-service-bus-as-i-understand-it-part-ii-queues-messages/">Azure Service Bus - As I Understand It: Part II (Queues &amp; Messages)</a> .  I‚Äôll add that in order for our integration to work correctly, it is necessary to have a clear sequence of messages, since we will process the messages both for creating and changing records, and I don‚Äôt want to process the message about changing the record before it is created.  In consequence, we do not forget to put the SupportOrdering field in the appropriate value, in this case the queue will work according to the FIFO principle (First In First Out). <br>  After the script has successfully worked on your screen, you should get something like this. <br><br><img src="https://habrastorage.org/files/1d9/5eb/105/1d95eb1059e34815ab8d5fc8a88443c2.png"><br><br>  Now, after everything is ready, we can make sure that the queue and the tire have been correctly created and are available on the portal. <br><br><img src="https://habrastorage.org/files/c11/e2c/678/c11e2c67882b480dbdadbcf73bebe540.png"><br><br><h4>  2. Connect Dynamics CRM Online to the Azure Service Bus. </h4><br>  So, in order to connect Dynamics CRM to the Azure Service Bus, you need to open the Plugin Registration Tool and establish a connection to the CRM system.  After the list of Plugins opens, select the Register and Register New Service Endpoint options. <br><br><img src="https://habrastorage.org/files/d68/009/0db/d680090db2dc442abfa8db70ed7ce9f8.png"><br><br>  Next, in the window that opens, fill in the connection settings. <br><br><img src="https://habrastorage.org/files/184/f29/984/184f29984ec64f948c02ee2af8ddf31f.png"><br><br>  <b>Name</b> is the name of our event.  As an example: ContactIntegration. <br>  <b>Description</b> - a description of the call. <br>  <b>Solution Namespace</b> is the name of our service bus.  In my case: sb4crm2crm <br>  <b>Path</b> - the name of the queue that will receive messages.  In my case: q4depa2depb <br>  <b>Contract</b> - a message transfer contract.  There are several options: Queue, Topic, One - way, two - way, REST.  We will consider Queue and Topic.  You can read more about each of these contracts in the following article: Write a listener for a Microsoft Azure solution.  For our integration, select Persistent Queue. <br>  <b>Claim</b> - as additional information in the context of the message, you can send a user ID. <br>  <b>ID</b> - a unique identifier of the created configuration. <br><br>  After all fields are filled, you can proceed to configuring ACS.  To do this, click on the Save &amp; Configure ACS button. <br><br><img src="https://habrastorage.org/files/f01/1e8/821/f011e88219dc484f96212119d7fca64d.png"><br>  <b>Management Key</b> - this key can be obtained from the Azure portal.  To do this, go to the section of service tires. <br><img src="https://habrastorage.org/files/838/696/25d/83869625d79f44d8aefebba2237e08ca.png"><br>  Select the bus we created and click the Connection Information button. <br><img src="https://habrastorage.org/files/c8f/82b/add/c8f82badd85d4537a9a39dc216683d8c.png"><br>  A window will open in which you can find all the necessary information. <br><img src="https://habrastorage.org/files/ede/1f1/66e/ede1f166e5564321b7894608ddfaafa2.png"><br>  We need the Default Key from the ACS section. <br>  <b>Certificate File</b> - a public certificate that was used when configuring Dynamics CRM for integration with Azure. <br>  <b>Issuer Name</b> - Name of the issuer.  The name must be the same as that used when configuring Dynamics CRM for integration with Azure. <br>  The Certificate File and Issuer Name can be found in Dynamics CRM under Settings -&gt; Customizations -&gt; Developer Resources.  As follows. <br><br><img src="https://habrastorage.org/files/b38/94e/352/b3894e352a724ac8b089697ea3eb4e52.png"><br><br>  Download the certificate, fill in all the required fields and click on the Configure ACS button.  If everything is correct, then after a short time, you will see the following messages: <br><br><img src="https://habrastorage.org/files/8b6/68a/aa6/8b668aaa6bd14812aea94088dbfb6a6d.png"><br><br>  After that, the window can be closed by clicking on the Close button. <br>  Next, click on the Save &amp; Verify Authentication button.  We receive the following message: <br><br>  <b>Verifying Authentication: Success</b> <br><br>  Close the window, click the Save button and it's done. <br>  Now it only remains to register which events we specifically want to process and send to our service bus. <br>  To do this, you need to register Plugin Step, as you usually do for your plugins.  I register the Create and Update messages for the Contact entity.  To do this, just call the context menu on the newly created Service Endpoint and select Register New Step.  Filling is intuitive. <br><br><img src="https://habrastorage.org/files/952/a41/615/952a416156774aeabdb0a535cbfbb986.png"><br>  Now our created contacts will be sent to the Service Bus. <br><br>  In order to track the success or failure of sending messages from Dynamics CRM, just open the system and go to the Settings -&gt; System Jobs section.  Select the entity of interest and download the presentation. <br><br>  Below is a screenshot of a potential error: <br><img src="https://habrastorage.org/files/856/d3d/dd1/856d3ddd18384d6da293479f28922203.png"><br><br><h4>  3. Develop a Worker Role to process messages. </h4><br>  It remains for the small, to develop a code that will process our messages, upload them to another system and correctly respond to potential errors. <br>  Any workflow must be running somewhere and in our case this is the Azure Cloud Service. <br>  Let's create a new Azure Cloud Service in Visual Studio. <br><img src="https://habrastorage.org/files/b59/9ac/6a8/b599ac6a88af4bbc91935d403c3ef6fd.png"><br><br>  Further we specify that in the context of our Azure Cloud Service, we want to create Worker Role. <br><br><img src="https://habrastorage.org/files/cb6/c06/c9c/cb6c06c9c3c94c3698356d6183a6048c.png"><br><br>  Now that we have the Azure Cloud Service and the Azure Worker Role, we can implement code that can receive messages from our queue.  The easiest way to receive messages is shown below. <br>  Any Worker Role contains three required methods - OnStart, Run and OnStop.  Let's consider their implementation in the most general form.  In the OnStart method, we define the parameters for connecting to our bus, here you can also initiate a connection to the system to which you want to fill data. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Trace.WriteLine(<span class="hljs-string"><span class="hljs-string">"Creating Queue"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> connectionString = <span class="hljs-string"><span class="hljs-string">"*** provide your connection string here***"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> namespaceManager = NamespaceManager.CreateFromConnectionString(connectionString); <span class="hljs-comment"><span class="hljs-comment">//      Client = QueueClient.CreateFromConnectionString(connectionString, QueueName); return base.OnStart(); }</span></span></code> </pre><br><br>  The Run method is the most interesting, because here we subscribe to receive messages from our queue and configure the method for receiving data. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { OnMessageOptions options = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnMessageOptions(); options.AutoComplete = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">//               receivedMessage options.MaxConcurrentCalls = 1; //         options.ExceptionReceived += LogErrors; //   // Start receiveing messages Client.OnMessage((receivedMessage) =&gt; //         { try { //    Trace.WriteLine("Processing Service Bus message: " + receivedMessage.SequenceNumber.ToString()); } catch { //        } }, options); CompletedEvent.WaitOne(); }</span></span></code> </pre><br><br>  The code is provided with sufficiently detailed comments, so in addition I will not comment on anything here. <br>  Well, and lastly, let's see how the OnStop method looks. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Client.Close(); CompletedEvent.Set(); <span class="hljs-comment"><span class="hljs-comment">//  Run  base.OnStop(); }</span></span></code> </pre><br>  Here we close all possible connections and finish the execution of the Run function.  Learn more about the Azure Cloud Service, you can read in the following article: A <a href="https://habrahabr.ru/company/microsoft/blog/242543/">detailed description of the development capabilities with Microsoft Azure Cloud Services</a> <br>  It is also worth noting that the publication of the working role can be performed in two variations: Staging and Production.  If you publish your role with the Debug build type, you will end up with a Staging deployment, if you use the Release build type, then Production.  Even if the role is published and is in the cloud, you can still debug it.  In order to learn more about the possibilities of publishing and debugging a worker role in the cloud, I propose to refer to the following article: <a href="https://azure.microsoft.com/en-us/documentation/articles/vs-azure-tools-debug-cloud-services-virtual-machines/">Debugging an Azure cloud service</a> <br><br><h4>  4. Architecture of integration of two CRM systems. </h4><br>  In brief, I will describe how the processing of messages in the queue is arranged, which we developed and applied in integrating the two systems.  Work begins with the CRMQueueProcessor class, its responsibilities include initializing connections, creating and configuring the ‚ÄúCrmMessageProcessor‚Äù message processor class, and also subscribing to receive messages from the bus.  As soon as the entire initialization process is completed and a message is received from the bus that needs to be processed, the CrmMessageProcessor enters the work. <br>  CrmMessageProcessor is an implementation of the ‚ÄúObserver‚Äù pattern.  Its task is to monitor the changes occurring in the system and notify its subscribers about these changes.  There may be as many subscribers as possible, each subscriber decides whether or not to process the message for himself.  All subscribers are inherited from the base class CrmBaseIntegrationHandler.  CrmBaseIntegrationHandler, being an abstract class, offers several methods for its implementation: <br><br>  <b>getProcessingEntityName ()</b> - must be overridden, returns the name of the entity, for example, contact. <br><br>  <b>getProcessingAction ()</b> - should be redefined, returns an action or a set of actions to which the handler should respond.  For example: this is the creation of a record. <br><br>  <b>HandleCrmMessage (string entityLogicalNameValue, string requestNameValue, Entity entity)</b> - accepts the message itself, as well as the nature and type of action, calls the overridden event handler if the event takes place <br><br>  <b>Entity OnProcessCreateEntity (Entity sourceEntity)</b> - The entry creation handler, it accepts the entity that came from the queue and forms the entity that will be created. <br><br>  <b>Entity OnProcessUpdateEntity (Entity sourceEntity)</b> - A change entry handler, it accepts an entity that comes from the queue and forms an entity that will be changed. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ContactIntegrationHandler</span></span> : <span class="hljs-title"><span class="hljs-title">CrmBaseIntegrationHandler</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProcessingEntityName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"contact"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> CrmMessageType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProcessingAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CrmMessageType.Create | CrmMessageType.Update; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Entity </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnProcessCreateEntity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Entity sourceEntity</span></span></span><span class="hljs-function">)</span></span> { Entity output = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Entity(<span class="hljs-string"><span class="hljs-string">"contact"</span></span>); output[<span class="hljs-string"><span class="hljs-string">"new_integrationid"</span></span>] = sourceEntity.Id.ToString(); output[<span class="hljs-string"><span class="hljs-string">"firstname"</span></span>] = sourceEntity.GetAttributeValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"firstname"</span></span>); output[<span class="hljs-string"><span class="hljs-string">"lastname"</span></span>] = sourceEntity.GetAttributeValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"lastname"</span></span>); output[<span class="hljs-string"><span class="hljs-string">"jobtitle"</span></span>] = sourceEntity.GetAttributeValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"jobtitle"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> output; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Entity </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnProcessUpdateEntity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Entity sourceEntity</span></span></span><span class="hljs-function">)</span></span> { Entity output = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Entity(<span class="hljs-string"><span class="hljs-string">"contact"</span></span>); output.Id = sourceEntity.Id; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sourceEntity.Contains(<span class="hljs-string"><span class="hljs-string">"firstname"</span></span>)) { output[<span class="hljs-string"><span class="hljs-string">"firstname"</span></span>] = sourceEntity.GetAttributeValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"firstname"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sourceEntity.Contains(<span class="hljs-string"><span class="hljs-string">"lastname"</span></span>)) { output[<span class="hljs-string"><span class="hljs-string">"lastname"</span></span>] = sourceEntity.GetAttributeValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"lastname"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sourceEntity.Contains(<span class="hljs-string"><span class="hljs-string">"jobtitle"</span></span>)) { output[<span class="hljs-string"><span class="hljs-string">"jobtitle"</span></span>] = sourceEntity.GetAttributeValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"jobtitle"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> output; } }</code> </pre><br>  The CrmMessageProcessor class looks like this: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CrmMessageProcessor</span></span> { List&lt;CrmBaseIntegrationHandler&gt; integrationSubscribers; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CrmMessageProcessor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List&lt;CrmBaseIntegrationHandler&gt; subscribers</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.integrationSubscribers = subscribers; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscribe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CrmBaseIntegrationHandler observer</span></span></span><span class="hljs-function">)</span></span> { integrationSubscribers.Add(observer); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Unsubscribe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CrmBaseIntegrationHandler observer</span></span></span><span class="hljs-function">)</span></span> { integrationSubscribers.Remove(observer); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BrokeredMessage receivedMessage</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> entityLogicalNameValue, requestNameValue; ExtractCrmProperties(receivedMessage, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> entityLogicalNameValue, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> requestNameValue); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entityLogicalNameValue == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || requestNameValue == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = receivedMessage.GetBody&lt;RemoteExecutionContext&gt;(); Entity entity = (Entity)context.InputParameters[<span class="hljs-string"><span class="hljs-string">"Target"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handler <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> integrationSubscribers) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status = handler.HandleCrmMessage((<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)entityLogicalNameValue, (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)requestNameValue, entity); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status.ProcessMessgae) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (status.MessageType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CrmMessageType.Create: { CrmConnector.Instance.CreateEntity(status.EntityToProcess); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CrmMessageType.Update: { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> guid = CrmConnector.Instance.checkEntityForExistance(status.EntityToProcess); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (guid != Guid.Empty) { status.EntityToProcess.Id = guid; CrmConnector.Instance.UpdateEntity(status.EntityToProcess); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    CRM   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="receivedMessage"&gt;</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="entityLogicalNameValue"&gt;</span></span></span><span class="hljs-comment">out:  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="requestNameValue"&gt;</span></span></span><span class="hljs-comment">out:  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> private void ExtractCrmProperties(BrokeredMessage receivedMessage, out object entityLogicalNameValue, out object requestNameValue) { string keyRoot = "http://schemas.microsoft.com/xrm/2011/Claims/"; string entityLogicalNameKey = "EntityLogicalName"; string requestNameKey = "RequestName"; receivedMessage.Properties.TryGetValue(keyRoot + entityLogicalNameKey, out entityLogicalNameValue); receivedMessage.Properties.TryGetValue(keyRoot + requestNameKey, out requestNameValue); } }</span></span></code> </pre><br>  If none of the processors processed the message, then it is placed in the queue of the unprocessed messages with the corresponding mark.  If an error occurred during the processing of the message, we will unblock the message in the queue and try to process it again, and so until the limit of attempts is reached, after which the message goes to the raw message queue.  Next is an excerpt from the CrmQueueProcessor class. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnMessageRecieved</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BrokeredMessage receivedMessage</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (processor.ProcessMessage(receivedMessage)) receivedMessage.Complete(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> receivedMessage.DeadLetter(<span class="hljs-string"><span class="hljs-string">"Canceled"</span></span>, <span class="hljs-string"><span class="hljs-string">"No event handler found"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { receivedMessage.Abandon(); logger.LogCrmMessageException(receivedMessage, ex); } }</code> </pre><br>  To get the path to messages from the queue of unprocessed messages, call the FormatDeadLetterPath method on an existing instance of the QueueClient object and pass the name of the working queue as an argument: <br>  QueueClient.FormatDeadLetterPath (queueName) <br>  This line will form the appropriate path, then you can safely subscribe to receive messages and process them. <br><br><h4>  5. Conclusion </h4><br>  In the example that we have analyzed, a queue is used and all messages are processed by a single workflow.  As an alternative to using a queue, you can also use sections (topics), you can configure them so that messages from different entities are processed by different threads within the same working role or in different ones.  Each subscriber will have its own queue, and a correctly configured filter will receive only those messages that should be processed by this instance.  If you need to synchronize the work of several working roles, then for this you can use Blob leasing, for more information about the synchronization of working roles in Azure, you can read in the following article: <a href="https://alexandrebrisebois.wordpress.com/2013/09/10/preventing-jobs-from-running-simultaneously-on-multiple-role-instances/">Preventing Jobs From Simultaneous to Multiple Role Instances.</a> <br><br>  The list of articles for which did footnotes: <br>  <a href="https://azure.microsoft.com/ru-ru/documentation/articles/active-directory-dotnet-how-to-use-access-control/">What is ACS</a> ? <br>  <a href="https://azure.microsoft.com/ru-ru/documentation/articles/powershell-install-configure/">What is Azure PowerShell</a> ? <br>  <a href="https://blogs.msdn.microsoft.com/paolos/2014/12/02/how-to-create-service-bus-queues-topics-and-subscriptions-using-a-powershell-script/">How to create a service bus queues, using a powershell script</a> . <br>  <a href="http://gauravmantri.com/2015/06/22/azure-service-bus-as-i-understand-it-part-ii-queues-messages/">Azure Service Bus - As I Understand It: Part II (Queues &amp; Messages)</a> <br>  <a href="https://habrahabr.ru/company/microsoft/blog/242543/">Detailed description of development capabilities with Microsoft Azure Cloud Services</a> <br>  <a href="https://azure.microsoft.com/en-us/documentation/articles/vs-azure-tools-debug-cloud-services-virtual-machines/">Azure Cloud Debugging Service or Virtual Machine in Visual Studio</a> <br>  <a href="https://alexandrebrisebois.wordpress.com/2013/09/10/preventing-jobs-from-running-simultaneously-on-multiple-role-instances/">Preventing Jobs From Running Simultaneously On Multiple Role Instances.</a> <br><br></div><p>Source: <a href="https://habr.com/ru/post/281797/">https://habr.com/ru/post/281797/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281785/index.html">Freedom to the tests</a></li>
<li><a href="../281787/index.html">The source code of the bot Gozi leaked to the network</a></li>
<li><a href="../281789/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ207 (11 - 17 April 2016)</a></li>
<li><a href="../281791/index.html">Spring meeting of Pattern Recognition and Computer Vision Colloquium 2016 in Prague: how it was</a></li>
<li><a href="../281793/index.html">How a secure printing system is implemented on a follow-me printing device</a></li>
<li><a href="../281799/index.html">Hadoop performance comparison on DAS and Isilon</a></li>
<li><a href="../281803/index.html">IaaS-digest: 30 materials on the topic of information security</a></li>
<li><a href="../281805/index.html">IaaS-cases: How the "cloud" helps the business</a></li>
<li><a href="../281807/index.html">Guide: How to calculate the benefits of migration to the "cloud"</a></li>
<li><a href="../281809/index.html">Experience of using IaaS by large (and not so) companies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>