<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backup is a delicate matter</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Almost everyone agrees that the bakapi should be done. But, nevertheless, this problem comes up again and again. A recent survey showed two interestin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backup is a delicate matter</h1><div class="post__text post__text-html js-mediator-article">  Almost everyone agrees that the bakapi should be done.  But, nevertheless, this problem comes up again and again.  A recent <a href="http://zt50.habrahabr.ru/blog/38695/">survey</a> showed two interesting points: firstly, half of us do not do bakapah at all, and secondly, the author did not even think to include the item ‚Äúonce a day‚Äù in the survey.  What is wrong with the seemingly simple task - to pack your files and put the archive in a warm and dry place? <br><br>  The main problem is that <b>bakap does not apply to those things that can be done without thinking</b> !  If you try to stupidly pack the entire contents of the screw, then firstly you will have nowhere to store these archives (daily! :)), and secondly your machine will be busy archiving around itself around 24 hours a day, instead of fulfilling your tasks.  And when you start <i>to think</i> (which is already difficult), it turns out that the data on the screw is <i>very different</i> , and it is also desirable to back them up differently (which ultimately complicates the situation).  As a result, either the decision is made not to make backups at all (disguised as ‚Äúpostpone for later‚Äù), or the first available utility is put in and somehow quickly tuned in the hope that this will be enough. <br><a name="habracut"></a><br>  Therefore, there is not, and cannot be, such a solution for bucks that would suit everyone.  Someone needs to backup their texts under Windows on a network drive, someone needs to backup the entire server to tape, someone uses <a href="http://en.wikipedia.org/wiki/Venti">Venti</a> instead of traditional backups, and someone just needs to make regular backups of their web project and send to GMail .  And this, in turn, greatly complicates the choice of software suitable for you. <br><br>  Therefore, IMHO the best way to help someone with bakapami is to tell what, how and why you bakapi.  I came across two different scenarios, and I want to talk about my decisions.  It should be noted that in both cases, the most critical factor for me was <b>reliability</b> - why do I need a backup from which it is impossible to correctly restore my data? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Backup of a large web project </h4><br>  A large project is not very easy to reliably secure - so that after recovery from the backup it will continue to work guaranteed and there will be no problems (except for the lack of new data that was added after the last backup, of course).  The fact is that both the files on the disk and the database are far from always in a ‚Äúconsistent‚Äù (consistent) state.  Some transactions are executed in the database (which are not always explicitly decorated as SQL transactions, by the way), temporary files are created, logs are written ... And in a large project there are often many other ‚Äúentry points‚Äù besides HTTP: processing incoming letters, RPC requests , cron-tasks, different TCP / UDP services work.  To keep all this colossus in a holistic state, and even to keep in it all the time that the bakap is being performed - the task for the external software is simply impossible! <br><br>  In this regard, our solution is that the project itself must support the possibility of creating complete backups.  The approach is about the same as with testing - in order for a project to be possible (and convenient) to test its code, it was originally written taking into account testing requirements. <br>  This is implemented trivially "in the forehead" - all applications of the project support a single system of locks, and for the time of the back-up the project is blocked. <br><br>  But this led to a new problem - after all, the case is not fast, especially the large database ... and if the project is blocked once a day for a long time, our users will not say thanks for it.  We solved this problem by reorganizing the database in such a way that all the tables were divided into two types: static and dynamic.  With ‚Äústatic‚Äù tables, only SELECT and INSERT SQL queries are executed, and ‚Äúdynamic‚Äù can change as you like.  Of course, all volume data was moved to static tables.  This made it possible <b>to reduce the project blocking time for the backup to several seconds</b> : for archiving (tar th, uncompressed) project files, creating a dynamic table dump, and storing the id of the last entry in static tables. <br><br>  After that, the lock was removed, and, without haste, static tables were dumped (before the memorized id), tar was compressed and sent to the storage.  Of course, static tables and project files can (and should) be incremented incrementally. <br><br>  Despite the universality of the approach (we use it in all our projects), our script for backups will be of little use to others, since  sharpened to use with our framework.  If you are curious to see it: <a href="http://powerman.name/soft/asdf/">asdfBackup</a> . <br><br><h4>  Backup ordinary dedicated server </h4><br>  Having considered my software requirements for server backup, I came to the following list: <br><ul><li>  Buckup software should be simple and reliable.  Everybody knows the dependence of the number of bugs on the size of the software, and I only had enough bugs in the bucks for complete happiness! </li><li>  When a server is fully backed up, it is impossible to take into account all the nuances of the projects installed on it and ensure their guaranteed integrity after recovery from the backup.  Therefore, the approach described below is used not instead of, but together with the specific projects described above.  But, nevertheless, there are things that need to be ensured when a server is backed up - for example, database integrity (it may not be complete from the point of view of a particular project, but it must be complete from the point of view of the MySQL server). </li><li>  Bacup should be performed quickly so as not to interfere with the server to perform its main function.  (On the server of a friend of the admin, I somehow discovered that his cron-task archiving a screw once a day in .tar.bz2 runs for <i>two hours</i> , and it‚Äôs almost impossible to do anything else on the server at this time!) In particular, taking into account the previous point, this means that you do not need to lock the database for the entire time of the server‚Äôs backup, but only for the time the files of the database itself are backed up. </li><li>  File format  I really didn‚Äôt want to put such a critical thing as backups depending on non-standard file formats.  Standard utilities are more than enough for archiving and encryption of backups (for example, tar + gzip + gpg). </li><li>  The system should allow sufficiently flexible processing of backups - encrypt, upload to other servers, etc. </li><li>  The interface should be sufficiently informative for debugging and setting up backups, but it should not spam me once a day with letters from each server ‚Äúeverything is in order, the backup is made‚Äù, I want to receive the letter only if an error has occurred. </li></ul><h5>  powerbackup </h5><br>  Maybe I was not looking there, but I could not find software that meets these requirements.  Therefore, I wrote it myself: <a href="http://powerman.name/soft/powerbackup.html">powerbackup</a> .  :) It turned out to be a small and simple sh-script (70 lines, 2 KB) that fully met the requirements described above and solved for me the server backup problem. <br><br>  The necessary flexibility while maintaining simplicity was achieved with the help of two architectural solutions: <br><ol><li>  The common task ‚Äúserver backup‚Äù is divided into several subtasks, for example: server settings bank, server database bases, user home directories. </li><li>  Creating a bakap is divided into two stages: preparing a file (incrementally via tar) and archiving it (gzip).  And for each task you can specify individual hooks for these stages.  For example, the database backup task intercepts the first stage to block MySQL while archiving files in / var / lib / mysql /.  And the task of the user directory backup can intercept the second stage in order to replace gzip compression with encryption via gpg and uploading the file via scp. </li></ol>  More detailed configuration examples are on the site. <br><br>  The license, as usual, is the public domain. </div><p>Source: <a href="https://habr.com/ru/post/41492/">https://habr.com/ru/post/41492/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../41482/index.html">One model of the process of building and maintaining a project</a></li>
<li><a href="../41484/index.html">Apple can close iTunes?</a></li>
<li><a href="../41486/index.html">The interception system is implemented on Skype Chinese servers</a></li>
<li><a href="../41487/index.html">iPhone from Megaphone</a></li>
<li><a href="../41491/index.html">Stylavin became the first official iPhone purchaser</a></li>
<li><a href="../41493/index.html">Elvis and the airport</a></li>
<li><a href="../41498/index.html">Advise where better to advertise the site abroad</a></li>
<li><a href="../41500/index.html">Cloud computing is a trap</a></li>
<li><a href="../41501/index.html">Blog start</a></li>
<li><a href="../41502/index.html">Nginx UploadProgress Module</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>