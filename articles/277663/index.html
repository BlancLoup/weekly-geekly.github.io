<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What we should build LVM (principle of operation, performance, Thin Provision)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Despite the presence of several articles on Habr√©, about LVM2 and the performance of Thin Provisioning, I decided to conduct my research, since the av...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What we should build LVM (principle of operation, performance, Thin Provision)</h1><div class="post__text post__text-html js-mediator-article">  Despite the presence of several articles on Habr√©, about LVM2 and the performance of Thin Provisioning, I decided to conduct my research, since the available ones seemed to me superficial. <br><br>  Who cares, welcome under cat. <br><a name="habracut"></a><br><br><h4>  Little about LVM2 </h4><br>  Actually, LVM is a disk space management system.  Allows you to logically combine several disk spaces (physical volumes) into one, and already from this space (Disk Group or volume group), you can select the partitions (Logical Volumes) that are available for work.  The OS accesses them through DevMapper. <br>  Logical volumes can be freely placed in a disk group, occupying continuous or discontinuous address ranges, or located partially on different disk groups.  Logical volumes can be easily resized (but not everyone can do FS) or move between group disks, as well as create snapshots of the state of a logical volume (snapshot).  Snapshots are the main interest in the article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  How LVM works </h4><br>  The idea here is simple, everything revolves around the tables of logical and physical addresses. <br>  The general scheme is as follows: Physical volumes are reflected on the Disk group.  The disk group is reflected on logical volumes. <br>  Snapshots are a little different: the own table associates the blocks of the original volume and the snapshot blocks (a copy of the blocks of the original, before they are modified).  It works on the principle of copying when recording (CoW, a copy of the block of the original volume is made, then this block is recorded in the original volume).  It is impossible to create snapshot from snapshot. <br><br>  Thin volumes work a little differently.  A special volume is created in the volume group (a pool of thin volumes, actually consists of two, for data and metadata), from this pool there is a selection of virtual space for thin volumes.  The space is virtual, because until the actual recording, the blocks are not allocated from the pool.  And in general, you can set the virtual size of the volume, more than the pool.  When the volume swells to the limit, the system will freeze the entry to it, until the pool size increases.  Snapshots here are similar to their ‚Äúfat‚Äù brothers, but they no longer operate with blocks, but with links to blocks.  That is, after creating the snapshot, writing to the original happens the same way as before creating the snapshot (rewritable blocks are allocated from the pool).  It is possible to create snapshots from snapshots, and you can also specify the external volume of the original (placed outside the thin pool in the same volume group, write-protected). <br><br><h4>  Performance </h4><br>  The performance of thick volumes without snapshots is equal to regular disk partitions (the difference is very small), but what about snapshots? <br>  Tests showed hell and horror.  Due to CoW, write operations to the original volume are slowed down dramatically!  And the more snapshots, the worse. <br>  The situation can be somewhat corrected by setting a larger fragment (by default, this is 4 kilobytes, which gives a large amount of small iops).  The situation is incomparably better if you write not in the original volume, but in the snapshot. <br><br>  Thin volumes show a more balanced picture.  The speed of work depends little on the number of snapshots, and the speed is much lower than for a simple thick volume without snapshots and close to the speed of writing to a thick snapshot.  The main contribution to the brakes makes the allocation of space (fragment size of 4 kilobytes). <br><br>  Results: <br><ol><li>  Simple section ahead in speed, but not efficient in space </li><li>  A thick volume is fast, as long as there are no snapshots, it has an average efficiency over space. </li><li>  Thin volume is the slowest, but its speed is weakly dependent on snapshots, the greatest efficiency in space </li></ol><br>  Fastest FS (in write mode): ext4, then xfs, at the end ext3 <br><br><div class="spoiler">  <b class="spoiler_title">Charts and calculation</b> <div class="spoiler_text">  <a href="https://drive.google.com/file/d/0B7xAqexV8GqlOHZWOUpubWluSk0/view%3Fusp%3Dsharing">Table with data for calculation</a> <br><img src="https://habrastorage.org/files/abb/79f/7aa/abb79f7aac4a471388d01276756d4aae.png"><br><img src="https://habrastorage.org/files/413/5d2/2d7/4135d22d71cd416a90790a557c53eaaf.png"><br><img src="https://habrastorage.org/files/88b/084/885/88b084885e094998894db5092d8a5bbf.png"><br><img src="https://habrastorage.org/files/29c/5bf/86f/29c5bf86f8d84889a43db951c864bf6d.png"><br><img src="https://habrastorage.org/files/337/8b9/d32/3378b9d3205c434b86a8699a78654412.png"><br><img src="https://habrastorage.org/files/501/cd1/c8d/501cd1c8d62a4e70b17b17feff205bf8.png"><br><img src="https://habrastorage.org/files/b0a/0fd/fe3/b0a0fdfe32424c11b8f6b0bebf852503.png"><br><img src="https://habrastorage.org/files/e3f/4e0/70d/e3f4e070dce34eea9f192e16b7054255.png"><br></div></div><br><br><h4>  Testing method </h4><br>  A partition or a logical volume (thick and thin) with a size of 50Gb was created.  The resulting space was formatted in ext3, ext4 and xfs.  After all the buffers were cleared and the tgz archive was unpacked (placed in tmpfs in memory) with Centos 7.3 Core image (Asterisk and FreePBX deployed) 2Gb in unpacked form.  At the end I cleaned the buffers again.  Time is measured from the beginning of unpacking to the final cleaning of the buffer. <br>  For LVM, a snapshot was created, and then a directory was created in the original volume where the archive was unpacked.  The procedure was repeated five times (without deleting snapshots or copies of files from the original volume). <br>  Then, once unpacked the archive in each snapshot. <br>  Participated in testing: <br><ul><li>  Gigabyte Z77X-D3H </li><li>  WDC WD7500AAKS-00RBA0 </li><li>  Intel¬Æ Core (TM) i5-3570 </li><li>  RAM 16Gb </li></ul><br><br><h4>  Reliability </h4><br>  I will evaluate reliability simply by the level of complexity of the mechanism for accessing information.  The harder it is, the lower its reliability (this has a rather distant relation to real reliability). <br>  The most reliable, of course, looks like a regular section.  Space is linear, no intermediate abstractions.  There‚Äôs nothing to break.  From cool buns there is nothing. <br>  The second place will be taken by Fat Tom.  Appearing abstractions certainly do not make it more reliable, but add a lot of flexibility.  Recovering data from scattered LVM is not so easy, but most likely, most volumes will be placed linearly, with little fragmentation (and these fragments will probably be large, it is unlikely that you will expand the partitions with small blocks). <br>  The most unreliable look Thin Tom.  A complex mechanism for allocating space, initially fragmented space (but not the data itself, they are just placed compactly and even linearly).  Damage to the address translation table will make the data extremely difficult to read.  By the way, the reliability of btrfs, zfs or ntfs at a worse level.  For thin volumes, only the distribution of space is in danger, and for the FS, there are also plenty of abstractions. <br><br><h4>  Production application </h4><br>  Thin Provisioning support appeared in RedHat Enterprise Linux 6.x, and in the 7th branch it became the default mode for LVM, even at the installation stage, which may indirectly indicate the reliability of the solution, and simple LVM2 has been working for a very long time, and there are no serious problems causes. <br>  Having on hand a performance assessment, you can decide on the use of a particular technology for different scenarios. <br>  For example, thick volumes will work well for virtualizing mass masses of the same type, without the need for backup on the fly (one master image, and a bunch of snapshots for target virtual machines, you can't take snapshots from snapshots).  Space consumption will be acceptable, and performance and flexibility will be on top.  In such a scenario, it is rarely necessary to write to the image of the original. <br>  And thin volumes will adequately show themselves in the script above (they will simply be much slower), and in others, and will make it possible to create snapshots from snapshots, etc.  In addition, thin volumes may be close to thick, after allocating space for recording or increasing the size of a fragment. </div><p>Source: <a href="https://habr.com/ru/post/277663/">https://habr.com/ru/post/277663/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277645/index.html">Amelisa. Offline and realtime engine for React and Mongo</a></li>
<li><a href="../277649/index.html">50 shades of paranoia or how to store passwords without saving</a></li>
<li><a href="../277653/index.html">Installing a Django project on a VPS (centOS 7) [For Beginners]</a></li>
<li><a href="../277655/index.html">Access MySQL data from a UWP application without using services</a></li>
<li><a href="../277657/index.html">Your cloud hosting in 5 minutes. Part 0: Virtualization</a></li>
<li><a href="../277665/index.html">Alternative to native support module in JIRA</a></li>
<li><a href="../277669/index.html">Java.util.concurrent. * Synchronizer reference</a></li>
<li><a href="../277671/index.html">Math on the fingers: linear-quadratic controller</a></li>
<li><a href="../277673/index.html">Free Photoshop Script: Export Vector Layers from PSD to SVG</a></li>
<li><a href="../277675/index.html">Linux Mint distributions have been compromised</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>