<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making a Raspberry Keyboard with a PS / 2 Interface</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear habrazhiteli! 

 In this post, I‚Äôll talk about PS / 2 keyboard emulation using the Raspberry Pi. 

 Recently, in one of the hot evenings, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making a Raspberry Keyboard with a PS / 2 Interface</h1><div class="post__text post__text-html js-mediator-article">  Hello, dear habrazhiteli! <br><br>  In this post, I‚Äôll talk about PS / 2 keyboard emulation using the Raspberry Pi. <br><br>  Recently, in one of the hot evenings, my old friend called me and asked me to write a program for him.  It was necessary to automate data entry (bar codes).  The outlet where he worked was owned by a chain of Italian stores.  It is clear that all the work with the goods was carried out in the Italian program.  But due to the fact that in our country the majority of them are trained to work on 1C, it was decided to sell it, and by the end of the working day, upload the sales results to the Italian system.  This is where the inconvenience. <br><a name="habracut"></a><br>  During the day, the quantity of goods sold could exceed one and a half thousand items.  Entering the barcode of each of them into the Italian system has become problematic.  The input algorithm was as follows: a barcode was entered, the "Enter" key was pressed - and a new one.  We agreed to meet in the morning and consider in detail the options. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Without thinking for a long time, I wrote a program that consistently takes data from an Excel sheet and sends it to the active window.  Making sure that everything works, I went to bed. <br><br>  The next day I was in for a surprise, which I, for some reason, did not immediately think.  By car with the Italian program were hard group policies that prohibit the launch of third-party programs on the hash list.  Admins (also Italians, by the way) did not want to take responsibility and allow the launch of third-party programs.  I did not get approval for circumventing the protection system from local management.  It was then that the idea of ‚Äã‚Äãsolving this problem from the hardware side came (after all, no one forbids connecting a third-party keyboard).  I remembered about the Raspberry Pi, which was gathering dust at my home. <br><br>  Began the search for documentation describing the PS / 2 interface.  Fortunately, on the first available resource (), I found all the necessary information. <br><br><h4>  PS / 2 keyboard cable pinout </h4><br>  As it turned out, 4 were necessary for the entire work of the wire. <br>  Black is the earth; <br>  Red - 5V; <br>  Yellow - pin time synchronization (CLOCK); <br>  White - data pin (DATA). <br><br>  Colors may vary slightly.  Even from these 4 wires I needed only two - yellow and white (in the ground and 5v my device, unlike the keyboard, did not need). <br><br><h4>  PS / 2 protocol job description (keyboard -&gt; host controller) </h4><br>  We will define the terminology: if there is voltage on the pin, we will consider this state as 1, otherwise 0. <br><br>  By default, when the computer is able to receive data, the state is set to 1 on both pins (CLOCK and DATA). It is installed by the host controller on the computer's motherboard.  We take control of ourselves, applying our voltage to both pins (the controller of the MC will release its voltage).  To initialize the data transfer, we need to send the 0th bit to the computer (not to be confused with the state 0).  To do this, in the DATA pin, set the state to 0 and immediately after this, the state of the CLOCK pin is also set to 0 (in that order).  We let the host controller know that we want to transmit the first bit.  Now, if you return the state of the CLOCK pin to state 1, the host controller counts the first bit.  Thus, we will transmit all other bits. <br><br>  The first bit is always 0, this is the start-bit (let us know that we are transmitting data). <br>  Next, we transmit 8 bits of the scan code of the key we want to press. <br>  The tenth bit is the parity bit (if the number of units is even, then 1, otherwise 0). <br>  The last 11 bits is a stop bit, always 1. <br><br>  Thus, one data packet is formed from 11 bits. <br><br>  For example, if we want to press the "0" key (scan code 45h = 1000101 in binary form) the following array of bits is sent to the host controller: 01010001001. <br><br>  By accepting this data, the computer will process the command for pressing this key, but it still needs to be pressed.  To do this, you must first send the F0h command, and then - re-scan the key code that must be pressed.  Also, it is necessary to hold a pause between state changes.  Experimentally, I found the most appropriate: 0.00020 seconds if working on Python and 1 nanosek, if you code in Java. <br><br><h4>  Connection diagram to the host controller </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/5bd/8de/655/5bd8de655a9f9d8f88feeaba14b37e3d.jpg" alt="image"><br><br>  A few words about why I connected the device in parallel with the keyboard.  When you turn on the computer, the BIOS checks the status of the PS / 2 connectors.  Computer and keyboard exchange readiness to work.  The keyboard should conduct internal diagnostics and report to the computer about its readiness.  Only after that the BIOS allows working with the PS / 2 interface.  Implement reading commands from the computer, I was too lazy. <br><br>  Now when you turn on the computer, the keyboard will report to it about its readiness.  After that, I turn on the Raspberry Pi and as soon as it takes control over the interface, work from the keyboard will be impossible.  I have not identified any conflicts during the work.  Everything worked as it should, except that occasionally the computer incorrectly processed the data sent to it, and since my Raspberry is not configured to receive data (in this case, the command to resend the key code), the error was simply ignored.  This problem was solved by reducing the frequency of data transmission. <br><br><h4>  Software part </h4><br>  At first I wrote the server part in Java using the pi4j library, but as the logic analyzer showed, the Java machine worked poorly with delays (they were too large and the computer very often did not correctly receive the data).  Python showed itself much better, the code was executed quickly, and the system was loaded several times less. <br><br>  Here is the Phyton code itself: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket, select <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> RPi.GPIO <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> GPIO <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-comment"><span class="hljs-comment">#       def sendBit(pinState): if pinState==0: GPIO.output(pinData, 0) else: GPIO.output(pinData, 1) GPIO.output(pinClock, 0) time.sleep(sleepInterval) GPIO.output(pinClock,1) time.sleep(sleepInterval) #      def sendArray(args): GPIO.setmode(GPIO.BCM) # ,   (  1) GPIO.setup(pinData,GPIO.OUT, initial=GPIO.HIGH) GPIO.setup(pinClock,GPIO.OUT, initial=GPIO.HIGH) # 0  GPIO.output(pinData, 0) GPIO.output(pinClock, 0) time.sleep(sleepInterval) GPIO.output(pinClock,1) time.sleep(sleepInterval) #    for v in args: sendBit(v) # - GPIO.output(pinData, 1) GPIO.output(pinClock, 0) time.sleep(sleepInterval*2) GPIO.output(pinClock,1) time.sleep(sleepInterval*200) GPIO.cleanup() pinClock=4 pinData=15 sleepInterval=0.00020 CONNECTION_LIST = [] RECV_BUFFER = 4096 PORT = 8928 server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM) # this has no effect, why ? server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) server_socket.bind(("0.0.0.0", PORT)) server_socket.listen(10) CONNECTION_LIST.append(server_socket) print "     " + str(PORT) while 1: read_sockets,write_sockets,error_sockets = select.select(CONNECTION_LIST,[],[]) for sock in read_sockets: if sock == server_socket: sockfd, addr = server_socket.accept() CONNECTION_LIST.append(sockfd) else: try: data = sock.recv(RECV_BUFFER) i=0 scanCode=[] print " :"+data for bukva in data: if bukva=="1": scanCode.append(int(1)) else: scanCode.append(int(0)) i=i+1 sendArray(scanCode) sendArray([0,0,0,0,1,1,1,1,1]) sendArray(scanCode) sock.close() CONNECTION_LIST.remove(sock) except: sock.close() CONNECTION_LIST.remove(sock) continue server_socket.close()</span></span></code> </pre> <br><br>  Java server part: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.pi4j.io.gpio.GpioController; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.pi4j.io.gpio.GpioFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.pi4j.io.gpio.GpioPinDigitalOutput; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.pi4j.io.gpio.PinState; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.pi4j.io.gpio.RaspiPin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.pi4j.io.gpio.event.GpioPinDigitalStateChangeEvent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.pi4j.io.gpio.event.GpioPinListenerDigital; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.pi4j.io.gpio.GpioPinDigitalInput; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.pi4j.io.gpio.PinPullResistance; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.ServerSocket; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.Socket; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.BufferedReader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.InputStreamReader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.PrintWriter; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] sc1 = {<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>}; <span class="hljs-comment"><span class="hljs-comment">//F0h private static int port = 8928; public static GpioController gpio=GpioFactory.getInstance(); public static GpioPinDigitalOutput pinClock = gpio.provisionDigitalOutputPin(RaspiPin.GPIO_07,"Com1", PinState.HIGH); public static GpioPinDigitalOutput pinData = gpio.provisionDigitalOutputPin(RaspiPin.GPIO_16,"Com2", PinState.HIGH); public static void main(String[] args) throws IOException { //     ServerSocket server=null; try { server = new ServerSocket(port); } catch (IOException e) { System.err.println("Could not listen on port:"+port); System.exit(1); } Socket client = null; System.out.println("  !"); while (true) { try { client = server.accept(); BufferedReader in = new BufferedReader (new InputStreamReader (client.getInputStream())); String line; while ((line = in.readLine())!=null) { if (line.indexOf("exit")&gt;-1) { return; } else { //     int[] buf=new int[9]; for (int i=0; i&lt;9;i++) { buf[i]=Integer.parseInt(line.substring(i,i+1)); } System.out.println(" : "+line);//   signal(buf); //    F0h signal(sc1); //   signal(buf); PrintWriter out = new PrintWriter (client.getOutputStream(), true); out.print("finished\r\n"); out.flush(); } } } } catch (IOException e) { client.close(); System.out.println("Shutdown gpio controller"); } } } //      static private void setPin(GpioPinDigitalOutput pinObj,int signalByte) { if (signalByte==0) { pinObj.low(); } else { pinObj.high(); } } //     static private void signal(int[] bits) { int sleepInterval=1; // - setPin(pinData,0); setPin(pinClock,0); sleeper(sleepInterval); setPin(pinClock,1); sleeper(sleepInterval); //    for (int i=0; i&lt;9; i++) { setPin(pinData,bits[i]); setPin(pinClock,0); sleeper(sleepInterval); setPin(pinClock,1); sleeper(sleepInterval); } // - setPin(pinData,1); setPin(pinClock,0); sleeper(sleepInterval*2); setPin(pinClock,1); sleeperM(1); } //     static private void sleeper(int i) { try { Thread.sleep(0,i); } catch(InterruptedException e) { System.out.println("Sleepin errore"); } } //     . static private void sleeperM(int i) { try { Thread.sleep(i); } catch(InterruptedException e) { System.out.println("Sleepin errore"); } } }</span></span></code> </pre><br><br>  Java client part: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.ServerSocket; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.Socket; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.BufferedReader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.InputStreamReader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.PrintWriter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Scanner; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcpClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> port = <span class="hljs-number"><span class="hljs-number">8928</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ String host=<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>; Socket server; PrintWriter out=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; Scanner sc= <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scanner (System.in); System.out.println(<span class="hljs-string"><span class="hljs-string">"Input host adress:"</span></span>); host=sc.nextLine(); System.out.println(<span class="hljs-string"><span class="hljs-string">"Connecting to host "</span></span>+host+<span class="hljs-string"><span class="hljs-string">"..."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Socket(host,port); out = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrintWriter (server.getOutputStream(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { System.err.println(e); System.exit(<span class="hljs-number"><span class="hljs-number">1</span></span>); } System.out.println(<span class="hljs-string"><span class="hljs-string">"Connected!"</span></span>); BufferedReader stdIn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedReader (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputStreamReader(System.in)); String msg; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((msg = stdIn.readLine()) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { out.println(msg); } } }</code> </pre><br><br><h4>  An example of a digitized signal sent from my device to a computer.  Lower channel CLOCK, upper DATA.  I send signals from Python </h4><br><img src="http://ic.pics.livejournal.com/gebekovas/33258210/1861/1861_900.png" alt="image"><br><br><h4>  Conclusion </h4><br>  Of course, use Raspberry for such a shallow task of pure water waste.  You could use an Arduino or build a circuit on a cheap arm processor.  But it was just an improvisation that first came to mind, and I didn‚Äôt really want to wait until all the necessary parts from China arrived. <br><br>  In general, I hope someone will benefit from this experience.  Personally, I got a lot of pleasure from the whole process. </div><p>Source: <a href="https://habr.com/ru/post/234939/">https://habr.com/ru/post/234939/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234923/index.html">New Microsoft update KB2993651 can also cause BSOD</a></li>
<li><a href="../234927/index.html">Online universities, or our answer Coursera</a></li>
<li><a href="../234929/index.html">Experience in applying online courses at Computer Science Center</a></li>
<li><a href="../234931/index.html">Chrome: let personal remain personal</a></li>
<li><a href="../234933/index.html">The evolution of ATM skimmers</a></li>
<li><a href="../234941/index.html">Module for adding domains from Directadmin to DNSmanager</a></li>
<li><a href="../234945/index.html">We return the child class from the parent. Optional</a></li>
<li><a href="../234947/index.html">UI in the Enterprise application, or how we made a convenient system for creating maps</a></li>
<li><a href="../234949/index.html">Google tests delivery of goods using drones</a></li>
<li><a href="../234951/index.html">Digest of materials on System Center and hybrid cloud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>