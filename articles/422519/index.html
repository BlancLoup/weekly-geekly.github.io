<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Distributing freebies: non-braking threads in Java. Project loom</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Do you want threads in the javka that do not eat the memory but do not slow down? Good laudable desire, and this issue answers this question. 


 We e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Distributing freebies: non-braking threads in Java. Project loom</h1><div class="post__text post__text-html js-mediator-article"><p>  Do you want threads in the javka that do not eat the memory but do not slow down?  Good laudable desire, and this issue answers this question. </p><br><p>  We explain the work of Project Loom on pizza boxes!  Fly! </p><br><p>  Delivery scope: </p><br><ul><li>  Videocast (main part).  For those who like to consume video. </li><li>  Full text transcript of the article.  There are links! </li></ul><br><p>  All this is removed and written <b>specifically for Habr</b> . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/p2_nvBslnIU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p><img src="https://habrastorage.org/webt/p4/2u/93/p42u93else2nzjftzy6x7mse5qk.png"><br></p><br><p><img width="200" align="left" src="https://habrastorage.org/webt/qc/po/fq/qcpofqkkj8xkolkk6iloep7wbt0.png">  We live in a cruel new world where likes are worth more than money.  A blogger can do almost anything for likes.  The final stage of international capitalism and technological promiscuity. </p><br><p>  I know that your laychik gave you hard work.  It is not known what abominations you generally do to make money.  Perhaps you are responding to comments that you don‚Äôt really like, to people you hate, and so earn yourself the coveted plus signs.  I do not want to know about it at all.  Huskies do not smell.  Just give me a little bit of likes, and I pretend I don‚Äôt know where they are from.  That's all that matters to a sales blogger like me. </p><br><p>  All little kids will go to create new content.  Thank. <br><br clear="all"></p><a name="habracut"></a><br><h1 id="pozyvnye">  Call Signs </h1><br><p>  Hi, javana, Oleg is in touch. </p><br><p>  Do you often see such a picture on your web service: at first everything was fine, then a million Chinese came to you, the service did a million threads and choked to hell with the dogs? </p><br><p><img src="https://habrastorage.org/webt/ym/_-/3r/ym_-3rq8a8g56hsmrvjhprnih8y.png"><br><br></p><br><p>  Do you want just such a nice picture? </p><br><p><img src="https://habrastorage.org/webt/38/s-/04/38s-04z5nak6trs_p2lei9chjku.png"><br><br></p><br><p>  In other words, do you want threads in javka that do not guzzle memory but do not slow down?  Good laudable desire, and this issue answers this question. </p><br><p>  We will deal, in fact, with the <em>unpacking of the new framework</em> .  Remember how Wylsacom unpacked iPhones?  Some people no longer remember old reviewers, but why?  Because Habr is a mainstream stronghold, and the paid vidos are, excuse me, the <a href="https://www.artlebedev.ru/kovodstvo/business-lynch/2007/06/25/commented/">rays of diarrhea</a> .  In this post we will deal exclusively with technical hardcore. </p><br><p>  First two minutes for a string, a disclaimer and other stuff that needs to be said.  You can skip it if you are too lazy. </p><br><p>  First of all, everything said in the video is my personal thoughts, and they have nothing to do with the employer or the glorious Oracle Corporation, the world government of lizards and the line in a mortar.  I even write it at three o'clock in the morning, so that it was clearly clear that this is my personal initiative, my personal garbage.  <em>All matches are purely random.</em> </p><br><p>  But there is another bonus goal.  We constantly talk about korutinakh in Kotlin.  Recently there were interviews with <a href="https://habr.com/company/jugru/blog/421607/">Roma Elizarov</a> , the god Korutin, and with <a href="https://habr.com/company/jugru/blog/421749/">Pasha Finkelstein</a> , who is going to write backends for them.  Soon there will be an interview with Andrei Breslav - who is the father of Kotlin.  And everywhere the project Loom is somehow mentioned, because it is an analogue of corutin.  And if you don‚Äôt know what a Loom is, you may become dumb when reading these interviews.  There are some cool dudes, they discuss cool things.  And you are, and you are not with them, you are a schmuck.  This is very stupid. </p><br><p>  Do not do so, read what Loom is, in this article, or continue to watch this video, I'll explain everything. </p><br><p>  So, what's the plot.  There is such a dude, Ron Pressler. </p>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p><img src="https://habrastorage.org/webt/w-/tq/ut/w-tqutfyx33olnhdavtq_asdv9u.png"><br><br></p><br><p>  Last year, he <a href="http://mail.openjdk.java.net/pipermail/loom-dev/2018-July/000061.html">went to the newsletter</a> , stated that the threads in java sucked, and suggested that I run the runtime and fix it.  And everyone would laugh at him and throw stones at him, by shit, if not for the fact that he had previously written <a href="http://docs.paralleluniverse.co/quasar/">Quasar</a> , and this is actually very cool.  You can swear at Quasar for a long time, but it seems to be there and it works, and in the big picture of all this is rather an achievement. </p><br><p>  There are a damn number of govnoderov who do nothing, just say.  Well, understand correctly, I'm the same.  Or there are people who seem to be cool engineers, but in general, unconsciously, they say: ‚ÄúIn Java it is necessary to improve the threads.‚Äù  What to improve?  What are threads? </p><br><p>  People in general are too lazy to think. </p><br><p>  How is the joke: <br>  Flying in the plane Petka and Vasily Ivanovich. <br>  Vasily Ivanovich asks: - Petka, devices? <br>  Petka answers: - 200! <br>  Vasily Ivanovich: - And what about 200? <br>  Petka: - And what about the devices? </p><br><p>  I'll tell the story.  I was in Ukraine this spring, we flew from Belarus (you understand why it is impossible directly from St. Petersburg).  And at the customs, we sat for about two hours, no less.  The customs officers are very nice, seriously asking if Java is an outdated technology.  Nearby were people who fly on the same konfu.  And I'm the same type of speaker, I have to pantanutsya, I stand and, as expected, shamelessly talk about things that I do not use at all.  Along the way, I talked about the JDK distribution called Liberica, which is such a JDK for the Raspberry Pi. </p><br><p>  And what do you think.  Not half a year goes by, as people are knocking on my cart and saying that, look, we wrote a solution in Prod on Liberik, and I already have a report about this on the Belarusian jfuture.by.  This is the approach.  This is not some lousy evangelist, but man, man, man, man, man. </p><br><blockquote>  By the way, we will soon have <a href="https://jokerconf.com/">the Joker 2018 conference</a> , which will include <a href="https://jokerconf.com/2018/talks/1nsze4i3teuioaeqquq8wg/">Andrei Breslav</a> (obviously, fumbling in the korutinakh), and <a href="https://jokerconf.com/2018/talks/4ugca8wuwow0sqiocyc86w/">Pasha Finkelstein</a> , and you can ask <a href="https://jokerconf.com/2018/talks/4ncjd3nrk0mkmaq4umqoce/">Josh Long</a> about supporting Loom in Spring.  Well and still a lot of cool prominent experts, fly! </blockquote><p>  And now, going back to threads.  People are trying to hold a thought through their degraded two neurons, they wind snot on their fists, and mumble: "The threads are not right in Java, the threads are not right in Java."  Devices!  What appliances?  This is generally hell. </p><br><p> And here comes Presler, a normal dude, not degraded, and first makes a sane description.  A year later, sawing a working demo.  All this I said, so that you understand that a normal description of problems, normal documentation is such a special kind of heroism.  A demo - it's all space.  This is the first person who ever did something in this direction.  He needs the most. </p><br><p>  Together with the demo, Pressler spoke at the conference and released the following video: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/J31o0ZMQEnI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  In fact, this entire article is a review of what was said there.  I do not pretend to the uniqueness of this material, everything that is in this article came up with Ron. </p><br><p>  The discussion is about three painful topics: </p><br><ul><li>  Continations </li><li>  Fibers </li><li>  Tail calls </li></ul><br><p>  Probably, he was so zadolbalo sawed Quasar and fight with his glitches, that now there is no strength - you have to push it into runtime. </p><br><p>  It was a year ago, and since then they sawed a prototype.  Some have already lost hope that we will see the demo sometime, but a month ago they gave birth to her and showed what is visible <a href="https://twitter.com/pressron/status/1022927184057573376">on this tweet</a> . </p><br><br><p><img src="https://habrastorage.org/webt/ck/hp/mc/ckhpmcchdv2k6_4vfbw733evg6c.png"><br><br></p><br><p>  All three painful topics in this demo are either directly in the code, or at least are present morally.  Well, yes, they haven‚Äôt mastered tail calls yet, but they want to. </p><br><h1 id="problematika">  Problematics </h1><br><p>  Unhappy users, application developers, when they make an API, are forced to choose between two chairs.  Peaks are embedded in one chair, and flowers grow on the other.  And neither one nor the other does not suit us. </p><br><br><p><img src="https://habrastorage.org/webt/tn/nx/k-/tnnxk-iwzuj7sybfwllour9qozq.png"><br><br></p><br><p>  For example, if you write a service that works synchronously, it works fine with legacy code, it is easy to debug and monitor the performance.  Problems will arise with bandwidth and scalability.  Just because the number of threads that can now be run on a simple piece of hardware, on the commodity hardware - well, let's say, two thousand.  This is much less than the number of connections that can be opened to this server.  Which in terms of netcode can be almost infinite. </p><br><p>  (Well, yes, this is somehow related to the fact that the sockets in Java are designed as a retard, but this is a topic for another conversation) </p><br><p>  Imagine you are writing some MMO. </p><br><br><p><img src="https://habrastorage.org/webt/ye/mg/pm/yemgpm6on0pidozkhmco3epwapa.png"><br><br></p><br><p>  For example, during the Northern War in EVE Online, two thousand four hundred pilots gathered at one point in space, each of which - conditionally, if it were written in Java - there would be more than one thread.  And the pilot, of course, is a complex business logic, and not the issuance of any HTML, which can be struck in the magnifying glass. </p><br><p>  The response time in that battle was so long that the player had to wait a few minutes to wait for a shot.  As far as I know, CCP specifically threw the enormous hardware resources of its cluster for that battle. </p><br><p>  Although, I, probably, use EVE as an example in vain, because, as far as I understand, everything is written in Python, and in Python with multithreading it is still worse than ours - and it can be considered a bad concurrence of language features.  But the example is clear and with pictures. </p><br><p>  If you are interested in the subject of MMOs in general and the history of the "Northern War" in particular, recently a very good video on this subject appeared on the BULDJAT channel (whatever the name means), look from my time mark. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/AkAtiTNvjz8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Back to the topic. </p><br><p>  On the other hand, you can use any asynchronous framework.  It scales.  But we will immediately get to a very complex debugging, complex profiling of the performance, we will not be able to integrate it seamlessly with Legacy, we will have to rewrite a lot of things, wrap in nasty wrappers, and generally feel like we were just raped.  Several times in a row.  All day long, in fact, all the time while we are writing this, we will have to feel this way. </p><br><p>  I asked an expert, a well-known academician Escobar, what he thinks about this: </p><br><br><p><img width="300" src="https://habrastorage.org/webt/7g/hf/mg/7ghfmg3x8aqhdl0jcyrbpairqsc.png"><br><br></p><br><p>  What to do?  So-called faybery are in a hurry to help. </p><br><p>  In general, faibers are such light threads that also scoop address space (because there are no miracles, you understand).  But unlike conventional threads, they are not using preemptive multitasking, but cooperative multitasking.  More worth reading <a href="https://en.wikipedia.org/wiki/Fiber_(computer_science)">on Wikipedia</a> . </p><br><p>  Faybers can realize the advantages of both synchronous and asynchronous programming.  As a result, hardware utilization is improved, and we use fewer servers in the cluster for the same task.  Well, in the pocket for this we get lavender.  Babosy.  Lave  Money.  Well, you understand.  For saved servers. </p><br><h1 id="na-raspute">  At the crossroads </h1><br><p>  The first thing I want to discuss.  People do not understand the difference between continuations and faibers. <br>  Now will be Cultural enlightenment! </p><br><p>  Let's announce the fact: Continuation and Fiber are different things. </p><br><h1 id="continuations">  Continuations </h1><br><p>  Fiber is built on top of a mechanics called Continuations. </p><br><p>  Continuations (more precisely, delimited continuations) is a kind of calculation, execution, a piece of a program that can fall asleep, then wake up and continue execution from the place where you fell asleep.  Sometimes he can even be cloned or serialized, even while he is sleeping. </p><br><p>  I will use the word ‚Äúcontinuation‚Äù, not ‚Äúcontinuation‚Äù (as it is written on Wikipedia), because we all communicate in <em>Ruglish</em> .  Using normal Russian terminology, one can easily come to a situation when the difference between a Russian and an English term becomes too large and no one else understands the meaning of what has been said. </p><br><p>  I will also sometimes use the word ‚Äúcrowding out‚Äù instead of the English version of ‚Äúyield‚Äù.  Just the word "yield" - it is some kind of really very gruesome.  Therefore, there will be "crowding out." </p><br><p>  So here.  It is very important that there should be no concarrency within the continuum.  It is in itself - the minimum primitive of this process. </p><br><p>      <code>Runnable</code>,       <code>pause()</code>.    ,      .       ,   ,    ,    ,  .  .     .</p><br>
<p>      ‚Äî     .    ,   .</p><br>
<p>       java.base,     . (<code>src/java.base/share/classes/java/lang/Continuation.java</code>).     , ,       -   .</p><br>
<pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Continuation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContinuationScope scope, Runnable body)</span></span></span></span>;
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yield</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContinuationScope scope)</span></span></span></span>;
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isDone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPinned</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Reason reason)</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"Pinned: "</span></span> + reason);
    }
}</code></pre><br>
<p>,        . ,          <code>Runnable</code>.       .</p><br>
<p>  . <code>body</code> ‚Äî  ,    ,  <code>scope</code> ‚Äî   ,     .</p><br>
<p>,         <code>run</code>,     -      <code>yield</code> (    -      ,      ).      <code>isDone</code>,     . </p><br>
<p>  ,      (  ,    ),      <code>yield</code>. ,                ,   .   ,   ,       ,   .  ,    ,  ‚Ä¶  ,   ,      - .     .</p><br>
<p>     :</p><br>
<pre><code class="java hljs">Continuation cont = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Continuation(SCOPE, () -&gt; {
        <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) {
            System.out.println(<span class="hljs-string"><span class="hljs-string">"before"</span></span>);
            Continuation.yield(SCOPE);
            System.out.println(<span class="hljs-string"><span class="hljs-string">"after"</span></span>);
        }
    });

<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!cont.isDone()) {
    cont.run();
}</code></pre><br>
<p>    . ,   ¬´¬ª ,  - . </p><br>
<p>   ,    ,            ‚Äî          .</p><br>
<p> ,  ,        API.      .    Spring Framework     ,    .  .    . ,  ,      .     .    ,    .     ,  -        .     ‚Äî  Spring,  ,   .</p><br>
<p>      .</p><br>
<h1 id="fibers">Fibers</h1><br>
<p>,      .<br>
<br>
  ,   :</p><br>
<ul>
<li> ,    JVM,     ;</li>
<li>     ,  ,  ;</li>
<li>    .</li>
</ul><br>
<p>        . ,  Kotlin  ,      . <em> </em>.   ‚Äî       . </p><br>
<p> , JVM      ,  ,    ‚Äî     .    API,       ¬´¬ª:    ,  <a href="https://projectreactor.io/">Reactor</a>, Spring Project Reactor,   -- ,        .</p><br>
<p>, .</p><br>
<p>    . : </p><br>
<ul>
<li>Continuation ()</li>
<li>Scheduler ()</li>
</ul><br>
<p> :</p><br>
<ul>
<li></li>
<li></li>
</ul><br>
<br>
<p><img src="https://habrastorage.org/webt/ga/wc/yk/gawcykupqgqwqjwfxcpccyltenu.jpeg"><br>
<br>
</p><br>
<p>  ,   .  ,    .</p><br>
<ul>
<li>  ,    ,  </li>
<li>      carrier threads</li>
</ul><br>
<p><em>   -.</em></p><br>
<br>
<br>
<p><img src="https://habrastorage.org/webt/j4/hc/gw/j4hcgwglzzsi6qe-cxczwcewohy.jpeg"><br>
<br>
</p><br>
<p>    <code>java.util.concurrent.Executor</code>,    ‚Äî <code>ForkJoinPool</code>.    .      - ,    .</p><br>
<p>   :</p><br>
<ul>
<li> (yield),    (,  IO);</li>
<li>,    (, IO-     ).</li>
</ul><br>
<p>  :</p><br>
<ul>
<li>   , ;</li>
<li>API  ,   ¬´ ¬ª.   ;</li>
<li>      <code>java.lang.Fiber</code>.</li>
</ul><br>
<p>   .</p><br>
<p>    :</p><br>
<ul>
<li>    ;</li>
<li>-  -;</li>
<li>  .</li>
</ul><br>
<h1 id="principialnaya-shema"> </h1><br>
<pre><code class="java hljs">mount();
<span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {
    cont.run();
} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> () {
    unmount();
}</code></pre><br>
<ul>
<li>     -;</li>
<li>  ;</li>
<li> ,        ;</li>
<li>  ,     .</li>
</ul><br>
<p>     <code>ForkJoinPool</code>   -  (       ).</p><br>
<h1 id="ispolzovanie-v-realnosti">  </h1><br>
<pre><code class="java hljs">Fiber f = Fiber.execute( () -&gt; {
    System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Morning!"</span></span>);
    readLock.lock();
    <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {
        System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Afternoon"</span></span>);
    } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> {
        readLock.unlock();
    }
    System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Night"</span></span>);
});</code></pre><br>
<p>,   ,  :</p><br>
<ul>
<li> ;</li>
<li>   ; </li>
<li>    ;</li>
<li>    ;</li>
<li> .</li>
</ul><br>
<p>  .</p><br>
<p>    .  Project Loom ,    <code>readLock.lock();</code>       .    ,    .</p><br>
<h1 id="steki-povsyudu-steki">,  !</h1><br>
<p>      ,  .</p><br>
<p> -    ,    .</p><br>
<p><img src="https://habrastorage.org/webt/8y/gw/mr/8ygwmr7dc_owazfdj-wa4trrs4g.png"><br>
<br>
</p><br>
<p>  , .</p><br>
<p>    ,     </p><br>
<p><img src="https://habrastorage.org/webt/pd/ya/mn/pdyamn0chhcnelgtphtxeg6eniq.png"><br>
<br>
</p><br>
<p>  , ,  ,      .</p><br>
<p><img src="https://habrastorage.org/webt/33/nw/fb/33nwfb3dz0klj1oiog21iegsbuy.png"><br>
<br>
</p><br>
<p>   ,      .</p><br>
<p>        ,    .</p><br>
<p>  -,  -         ,     .</p><br>
<p><img src="https://habrastorage.org/webt/vv/lk/ah/vvlkahftvyuefpupb4fyidb5gdq.png"><br>
<br>
</p><br>
<p>,     ,     .  .</p><br>
<p><img src="https://habrastorage.org/webt/hz/oq/6n/hzoq6nmzmezadhp8-ntn6_qerxk.png"><br>
<br>
</p><br>
<p> ,    ,  ,     <code>Continuation.run</code>.   ‚Äî   .</p><br>
<p>  , -   .</p><br>
<p><img src="https://habrastorage.org/webt/l4/nt/k9/l4ntk9qfl8dpcamol4ufahy8sa0.png"><br>
<br>
</p><br>
<p> , - ,   .</p><br>
<p>    ,  ,   ,  .<br>
   ,  ,    , .     .</p><br>
<ul>
<li>ReentrantLock.unlock</li>
<li>LockSupport.unpark</li>
<li>Fiber.unpark</li>
<li>ForkJoinPool.execute</li>
</ul><br>
<p>     ,   .</p><br>
<p><img src="https://habrastorage.org/webt/hz/oq/6n/hzoq6nmzmezadhp8-ntn6_qerxk.png"><br>
<br>
</p><br>
<p> -    .    !</p><br>
<p>  .</p><br>
<p><img src="https://habrastorage.org/webt/ll/c-/mx/llc-mxgfttlpleiqtprwm6igcju.png"><br>
<br>
</p><br>
<p>   !!!  ,       <code>Continuation.yield</code>.</p><br>
<p><img src="https://habrastorage.org/webt/la/4t/pp/la4tppjy2spiy4_auvwdikgm8nu.png"><br>
<br>
</p><br>
<p>              :</p><br>
<p><img src="https://habrastorage.org/webt/yt/ce/ht/ytcehtff1fomwn5cehnzkegzpts.png"><br>
<br>
</p><br>
<p>  ,           continuation.run</p><br>
<p><img src="https://habrastorage.org/webt/sz/m8/cc/szm8ccxgwntcgjzwqcl_gcernqg.png"><br>
<br>
</p><br>
<p>     ,       .</p><br>
<p><img src="https://habrastorage.org/webt/l4/nt/k9/l4ntk9qfl8dpcamol4ufahy8sa0.png"><br>
<br>
</p><br>
<p>         .</p><br>
<p><img src="https://habrastorage.org/webt/c7/z9/wm/c7z9wmktfbsithnlvyuea4mtqki.jpeg"><br>
<br>
</p><br>
<h1 id="zhivye-primery"> </h1><br>
<p>   ,    ?    ,   ?</p><br>
<p>        -     ,   .    .   ,     ,   .</p><br>
<p>      ,         ,         .</p><br>
<h1 id="problemy"></h1><br>
<p>   - ? , !     ‚Äî       .</p><br>
<h2 id="filosofskie-problemy"> </h2><br>
<ul>
<li>    ?</li>
<li>  <em></em>      ?</li>
</ul><br>
<p>    . , ,   ,    . -, OpenJDK ‚Äî  ,   .</p><br>
<p>    ?    ‚Äî 2 .</p><br>
<h2 id="problema-raz--nelzya-vytesnit-nativnye-freymy">  ‚Äî    </h2><br>
<pre><code class="java hljs">PrivilegedAction&lt;Void&gt; pa = () -&gt; {
    readLock.lock(); <span class="hljs-comment"><span class="hljs-comment">// may park/yield</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {
        <span class="hljs-comment"><span class="hljs-comment">//</span></span>
    } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> {
        readLock.unlock();
    }
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;
}
AccessController.doPrivileged(pa); <span class="hljs-comment"><span class="hljs-comment">//native method</span></span></code></pre><br>
<p> <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/security/doprivileged.html">doPrivileged</a>   .</p><br>
<p>    <code>doPrivileged</code>,   VM,       ,        <code>readLock.lock()</code>.     -     ,    .    .      -,  ,     . </p><br>
<p>    ,       .</p><br>
<h2 id="problema-dva---synchronized-bloki">  ‚Äî synchronized-</h2><br>
<p>      </p><br>
<pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//may park</span></span>
    object.wait(); <span class="hljs-comment"><span class="hljs-comment">//may park</span></span>
}</code></pre><br>
<pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//may park</span></span>
    socket.getInputStream().read(); <span class="hljs-comment"><span class="hljs-comment">//may park</span></span>
}</code></pre><br>
<p>     , -  .</p><br>
<p>,           ,  wait+notify   condition objects,     ?  .</p><br>
<h1 id="thread-api-threadcurrentthread-thread-locals">Thread API? Thread.currentThread()? Thread Locals?</h1><br>
<p>    <code>Thread</code>  <code>Fiber</code>       <code>Strand</code>.</p><br>
<p>   API    .<br>
   ‚Äî     , .</p><br>
<p>    Thread API?</p><br>
<ul>
<li>  <code>Thread.currentThread()</code>      , Shadow Thread;</li>
<li>   ,  "" ,      VM ;</li>
<li>ST   ,  ;</li>
<li>  ,    API  ;</li>
<li> , Shadow Thread  Thread API  ,  <code>stop</code>, <code>suspend</code>, <code>resume</code>    .</li>
</ul><br>
<p>   Thread Locals?</p><br>
<ul>
<li> thread locals    fiber locals;</li>
<li>     ,   ;</li>
<li>    ; </li>
<li>    ,   (,   ,    - ,    - );</li>
<li>      :<br>
<ul>
<li>:      ;</li>
<li>:    .</li>
</ul></li>
</ul><br>
<h1 id="skolko-vse-eto-zhret">   </h1><br>
<p><img src="https://habrastorage.org/webt/pl/7-/pi/pl7-pidz-d2o3l98qx2srbmezxi.png"><br>
<br>
</p><br>
<p>Thread:</p><br>
<ul>
<li>: 1MB  16KB    ;</li>
<li>  : 2300 ,  VM .</li>
</ul><br>
<p>Fiber:</p><br>
<ul>
<li> :     ;</li>
<li>  : 200-240 .</li>
</ul><br>
<p> !<br>
   ,     .</p><br>
<h1 id="chto-mozhet-parkovatsya">  </h1><br>
<p>,     ‚Äî      - .   ?</p><br>
<ul>
<li>Thread.sleep, join;</li>
<li>java.util.concurrent  LockSupport.lock;</li>
<li>IO:    (socket read, write, connect, accept), , ;</li>
<li>  ,     .</li>
</ul><br>
<h1 id="kommunikaciya-mezhdu-fayberami">  </h1><br>
<p>  ,   :      .</p><br>
<ul>
<li>     <code>Runnable</code>,    <code>CompletableFuture</code>,  - ;</li>
<li>java.util.concurrent ¬´ ¬ª.     ;</li>
<li>,   API  ,    ;</li>
<li>    ¬´    ?¬ª;  ,    .</li>
</ul><br>
<h1 id="kak-realizovany-kontinuacii-v-prototipe">    ?</h1><br>
<p>    :       ,        .      .    ‚Äî -         -.    !     .</p><br>
<p>    , ,           .   ,   ,     .    ,   .</p><br>
<p>    ‚Ä¶  ,  .     .  ‚Äî  ,       .  ‚Äî  (, ),     .</p><br>
<p><img src="https://habrastorage.org/webt/33/tf/cj/33tfcj897awloqfisxfwwl-4ypy.png"><br>
<br>
</p><br>
<p>    ,        .</p><br>
<p><code>run</code>      <code>enter</code>:</p><br>
<p><img src="https://habrastorage.org/webt/j6/d5/ki/j6d5kioz8ygupanxditl3iaslbi.png"><br>
<br>
</p><br>
<p>    ,    .</p><br>
<p><img src="https://habrastorage.org/webt/ab/on/6c/abon6cdsoepe-ts69pkmm9sk35i.png"><br>
<br>
</p><br>
<p>     VM,   <code>freeze</code>.        ‚Äî   .</p><br>
<p><img src="https://habrastorage.org/webt/iu/or/jv/iuorjvmb6xrjnycvx3nxbdcqxxc.png"><br>
<br>
</p><br>
<p>          .</p><br>
<p><img src="https://habrastorage.org/webt/ln/nu/sm/lnnusmrix2hsqpwxmzkeemd_or0.png"><br>
<br>
</p><br>
<p>  ,        ,   - ,         .</p><br>
<p><img src="https://habrastorage.org/webt/vl/5c/k0/vl5ck0i3jtouapded9snnl9brvy.png"><br>
<br>
</p><br>
<p>   ,      :</p><br>
<p><img src="https://habrastorage.org/webt/ka/z_/gl/kaz_glkmthfyd1x8rzdprn3v8ym.png"><br>
<br>
</p><br>
<p>         :</p><br>
<p><img src="https://habrastorage.org/webt/xc/2q/nb/xc2qnbafy_2eybwzif-3s3vmaym.png"><br>
<br>
</p><br>
<p>,   ,     !</p><br>
<p>          .</p><br>
<p><img src="https://habrastorage.org/webt/6e/sp/-0/6esp-07i4dyasxj5esb9qu6fh5i.png"><br>
<br>
</p><br>
<p>!       .      ,  ,   - .   .</p><br>
<p><img src="https://habrastorage.org/webt/bq/sz/ju/bqszjuffw-s4f14audafvzbmqzc.png"><br>
<br>
</p><br>
<p>         .       ,       .   .</p><br>
<p><img src="https://habrastorage.org/webt/8i/bg/x9/8ibgx9r_26wedxrahar1vfqdifi.png"><br>
<br>
</p><br>
<p>  ,   ,  ‚Äî , . ,   VM,         VM-  <code>thaw</code>.   ¬´thaw¬ª   ¬´¬ª, ¬´¬ª,    .           .</p><br>
<p> ,      .      .     .</p><br>
<p><img src="https://habrastorage.org/webt/ra/sv/5v/rasv5v_5w8_dpegomn_omgtdiza.png"><br>
<br>
</p><br>
<p>   .</p><br>
<p>   :</p><br>
<p><img src="https://habrastorage.org/webt/wc/he/vg/wchevg-fsflrnicy0itprkp0q2e.png"><br>
<br>
</p><br>
<p>  :</p><br>
<p><img src="https://habrastorage.org/webt/o_/o2/6s/o_o26sakm0n5hyq9wisbo7vouge.png"><br>
<br>
</p><br>
<p>   ,    :</p><br>
<p><img src="https://habrastorage.org/webt/sm/h7/0n/smh70naepp3kshxaa78zxv1g2du.png"><br>
<br>
</p><br>
<p>    :</p><br>
<p><img src="https://habrastorage.org/webt/cg/dv/61/cgdv617uqeriqmuqcyc2jkjpnbe.png"><br>
<br>
</p><br>
<p>    <code>yield</code>  ,      .</p><br>
<p><img src="https://habrastorage.org/webt/gn/dd/xw/gnddxwqqsrwuidc9ev2nxwmiwqc.png"><br>
<br>
</p><br>
<p>  ,     ‚Äî    ,     .   .    ,   ,   .   ‚Äî       ! , .    . </p><br>
<p>       ‚Äî  .</p><br>
<p>    ,       .</p><br>
<p><img src="https://habrastorage.org/webt/5b/hw/tg/5bhwtgg8cfg-agcwu_kdtrqlify.png"><br>
<br>
</p><br>
<p>    ,   :</p><br>
<p><img src="https://habrastorage.org/webt/rj/ac/f9/rjacf9tmfekskko8jwojuocxixm.png"><br>
<br>
</p><br>
<p>  ,   ,     :</p><br>
<p><img src="https://habrastorage.org/webt/nm/ol/ow/nmolowac-dkmdefuobd-kaijyeq.png"><br>
<br>
</p><br>
<p>    ,      :</p><br>
<p><img src="https://habrastorage.org/webt/3a/ca/1x/3aca1xglgfbq8yzwxkjypelxpqy.png"><br>
<br>
</p><br>
<p> .      <code>C</code>,      return barrier:</p><br>
<p><img src="https://habrastorage.org/webt/zs/si/3z/zssi3zgaadvvsrg883agxsmq3pc.png"><br>
<br>
</p><br>
<p>     <code>yield</code>:</p><br>
<p><img src="https://habrastorage.org/webt/e1/f_/2s/e1f_2snf4bh-ggjcv5lrgabqkwk.png"><br>
<br>
</p><br>
<p>           <code>C</code>:</p><br>
<p><img src="https://habrastorage.org/webt/y2/nl/rm/y2nlrmn9lczwhcaa3f41ii69nq0.png"><br>
<br>
</p><br>
<p> ,  <code>C</code>    ,   .    ‚Äî  <code>B</code>,     ! ,    ,     ,     ‚Äî return barrier. ,   ,       <code>thaw</code>:</p><br>
<p><img src="https://habrastorage.org/webt/hb/6g/8d/hb6g8dfw35ujqntvi-y7lzyskis.png"><br>
<br>
</p><br>
<p> <code>thaw</code>       ,   <code>B</code>:</p><br>
<p><img src="https://habrastorage.org/webt/cp/mp/ao/cpmpao3_arvnvgykenc9r4fgwsk.png"><br>
<br>
</p><br>
<p> ,    ,  .</p><br>
<p>   <code>B</code>        (  ,      - ).     .</p><br>
<p><img src="https://habrastorage.org/webt/gv/yo/0u/gvyo0u4iwzunuqovy1yv_-jbutq.png"><br>
<br>
</p><br>
<p> ,  <code>B</code>      ,    -   <code>D</code>.       .</p><br>
<p><img src="https://habrastorage.org/webt/f9/1i/t9/f91it9xn705zsxuzvvbqh5gdoqi.png"><br>
<br>
</p><br>
<p>  ,     <code>freeze</code>,           :</p><br>
<p><img src="https://habrastorage.org/webt/pt/8b/ul/pt8buljt77lsp-wj-rswobc4v_y.png"><br>
<br>
</p><br>
<p> ,         .        ,      .</p><br>
<h1 id="chto-ostalos"> ?</h1><br>
<p>     ,      .</p><br>
<ul>
<li>  .     ,   ,  ..</li>
<li>JVM TI  ,      .      ,        yield,     ,      .</li>
<li>     .</li>
</ul><br>
<p> :</p><br>
<ul>
<li>  API;</li>
<li>   ;</li>
<li> .</li>
</ul><br>
<h1 id="gde-vzyat"> </h1><br>
<p>       OpenJDK. <a href="http://hg.openjdk.java.net/loom/loom">C   </a>,    <code>fibers</code>.</p><br>
<p>  :</p><br>
<pre><code class="bash hljs">$ hg <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> http://hg.openjdk.java.net/loom/loom  
$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> loom  
$ hg update -r fibers 
$ sh configure   
$ make images</code></pre><br>
<p>  ,       OpenJDK. , -,       - ,    . </p><br>
<p><img src="https://habrastorage.org/webt/gk/qz/3-/gkqz3-f8gmkcwkynnnrp4opp1rg.png"><br>
<br>
</p><br>
<p>-,       C++   GNU .  ,        Windows. ,    VirtualBox    Ubuntu       ,          Cygwin  msys64.   ,  msys   ,  Cygwin.</p><br>
<p> , ,  ,      <a href="https://habr.com/post/319078/">  </a>.</p><br>
<p>  -   ,   mercurial extension   fsmonitor. ,   ,   <code>hg help -e fsmonitor</code>.<br>
     ~/.hgrc  :</p><br>
<pre><code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">fsmonitor</span></span>]
mode = <span class="hljs-keyword"><span class="hljs-keyword">on</span></span></code></pre><br>
<p> -           .             -, <code>cp -R ./loom ./loom-backup</code>. </p><br>
<p> ,          . ,   Java-    ,       .</p><br>
<p><code>sh configure</code>    - . ,     Ubuntu,     Autoconf (<code>sudo apt-get install autoconf</code>).  ‚Äî     OpenJDK   Ubuntu,     ,  .  Windows      ,   .</p><br>
<p>,     ,   <code>hg diff --stat -r default:fibers</code>.</p><br>
<p> ,          ,   ,     .</p><br>
<h1 id="zaklyuchenie"></h1><br>
<p>     ¬´, ¬ª.   ¬´¬ª, . ¬´Loom¬ª ‚Äî  ¬´ ¬ª.  Project Loom         . </p><br>
<p>         ,        . ,      ¬´¬ª  ,  ,      ‚Äî  , ,  , ‚Äî  .</p><br>
<p>,   ,          XIX    ,        . </p><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/456/ec3/47d/456ec347d59a49c6c019df8abc22c3e7.jpg"><br>
<p>     . -,  .</p><br>
<p>,                 .        IDE   .</p><br>
<p>         ,       ,   ,    ¬´ ¬ª, ¬´¬ª, ¬´ ¬ª   . </p><br>
<p>      ?   .   .</p><br>
<p>.</p></div><p>Source: <a href="https://habr.com/ru/post/422519/">https://habr.com/ru/post/422519/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../422509/index.html">Summary of the book "Never Eat Alone"</a></li>
<li><a href="../422511/index.html">Data loading in Splunk: Universal Forwarder vs Heavy Forwarder. What is the difference?</a></li>
<li><a href="../422513/index.html">7 tips on how not to infuriate a colleague-tester on his holiday</a></li>
<li><a href="../422515/index.html">Two Apache Ignite Meetings and In-Memory Computing Webinar in September</a></li>
<li><a href="../422517/index.html">TelegramBot in the Wolfram Cloud</a></li>
<li><a href="../422521/index.html">Premonition of the inevitable</a></li>
<li><a href="../422525/index.html">"The matrix of friendship." The oldest social graph for the smallest</a></li>
<li><a href="../422527/index.html">Digest news from the world of PostgreSQL. Issue number 10</a></li>
<li><a href="../422529/index.html">Special Course Group-IB: ‚ÄúMobile Application Security‚Äù</a></li>
<li><a href="../422531/index.html">Optimizing graphics for the web: the most important</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>