<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Understanding the V8 bytecode</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="V8 is an open source Google JavaScript engine. It is used by Chrome, Node.js and many other applications. This material, prepared by Google employee F...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Understanding the V8 bytecode</h1><div class="post__text post__text-html js-mediator-article">  V8 is an open source Google JavaScript engine.  It is used by Chrome, Node.js and many other applications.  This material, prepared by Google employee Francis Hinkelmann, is devoted to describing the V8 bytecode format.  Bytecode is pretty easy to read, if you understand some basic things. <br><br> <a href="https://habrahabr.ru/company/ruvds/blog/336294/"><img src="https://habrastorage.org/getpro/habr/post_images/04a/c08/c9e/04ac08c9e48756beb3c9742485f0e6ea.jpg" alt="image"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">V8 compilation conveyor</font> </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ab9/9b1/9f2/ab99b19f201ed29eaaa59d70e05433a8.png"></div><br>  <i><font color="#999999">Ignition!</font></i>  <i><font color="#999999">Start!</font></i>  <i><font color="#999999">The Ignition interpreter, whose name can be translated as ‚Äúignition‚Äù, has been part of the V8 compilation pipeline since 2016</font></i> <br><br>  When V8 compiles JavaScript code, the parser generates an abstract syntax tree.  The syntax tree is a tree-like representation of the syntax of the JS code.  The Ignition interpreter generates a bytecode from this data structure.  The TurboFan optimizing compiler ultimately generates optimized machine code from the bytecode. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bad/d01/655/badd016554118801569cdb0f7ea7dd92.png"></div><br>  <i><font color="#999999">V8 compilation conveyor</font></i> <br><br>  If you want to know why the V8 has two performance modes, take a look at my <a href="https://www.youtube.com/watch%3Fv%3Dp-iiEDtpy6I">performance</a> with JSConfEU. <br><br><h2>  <font color="#3AC1EF">Basics of V8 bytecode</font> </h2><br>  <b>Bytecode is an abstraction of machine code</b> .  Compiling bytecode to machine code is easier if the bytecode is designed using the same computational model used in the physical processor.  That is why interpreters are often register or stack machines. <br><br>  <b>The Ignition interpreter is a register machine with a cumulative register</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7fc/7c8/86a/7fc7c886a422255291ff7fa368dda5be.png"></div><br>  <i><font color="#999999">The code on the left is convenient for people.</font></i>  <i><font color="#999999">The code on the right is for cars</font></i> <br><br>  V8 bytecodes can be thought of as <b>small building blocks</b> that, when put together, can implement any JavaScript functionality.  V8 has several hundred bytecodes.  There are codes for operators, like <code>Add</code> or <code>TypeOf</code> , or for loading properties - like <code>LdaNamedProperty</code> .  V8 also has some rather specific bytecodes, such as <code>CreateObjectLiteral</code> or <code>SuspendGenerator</code> .  In the <a href="">bytecodes.h</a> header file you can find a complete list of V8 bytecodes. <br><br>  Each bytecode defines its input and output data as register operands.  Ignition uses the registers <code>r0, r1, r2, ...</code> and the cumulative register.  Almost all bytecodes use the cumulative register.  It is similar to a regular register, except that it is clearly not indicated in bytecodes.  For example, the <code>Add r1</code> command adds the value from the <code>r1</code> register to what is stored in the cumulative register.  This makes bytecodes shorter and saves memory. <br><br>  The names of many bytecodes begin with <code>Lda</code> or <code>Sta</code> .  The letter <code>a</code> in <code>Lda</code> and <code>Sta</code> is an abbreviation of the word <b>a</b> ccumulator (cumulative register). <br><br>  For example, the <code>LdaSmi [42]</code> command loads a small integer (Small Integer, Smi) <code>42</code> into the cumulative register.  The <code>Star r0</code> command writes the value that is in the cumulative register to the <code>r0</code> register. <br><br><h2>  <font color="#3AC1EF">Function Byte Code Analysis</font> </h2><br>  Now, after we have dismantled the basic concepts, we will look at the byte code of the real function. <br><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incrementX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> + obj.x; } incrementX({x: <span class="hljs-number"><span class="hljs-number">42</span></span>});  <span class="hljs-comment"><span class="hljs-comment">//  V8 , ,     ,     </span></span></code> </pre> <br>  If you want to see the bytecode for JavaScript code, you can output it by calling <a href="https://github.com/v8/v8/wiki/Using-D8">the D8 debugger</a> or Node.js (starting from version 8.3) with the <code>--print-bytecode</code> flag.  In the case of Chrome, run it from the command line with the key - <code>--js-flags="--print-bytecode"</code> .  Here's the Chromium call with the keys. <br><br><pre> <code class="hljs matlab">$ node --print-bytecode incrementX.js ... [generating bytecode <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incrementX</span></span></span><span class="hljs-function">] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Parameter</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count</span></span></span><span class="hljs-function"> 2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Frame</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-function"> 8 12 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">E</span></span></span><span class="hljs-function">&gt; 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ddf8802cf6e</span></span></span><span class="hljs-function"> @    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StackCheck</span></span></span><span class="hljs-function"> 19 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">S</span></span></span><span class="hljs-function">&gt; 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ddf8802cf6f</span></span></span><span class="hljs-function"> @    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LdaSmi</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1]</span></span></span><span class="hljs-function">       0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ddf8802cf71</span></span></span><span class="hljs-function"> @    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Star</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function"> 34 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">E</span></span></span><span class="hljs-function">&gt; 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ddf8802cf73</span></span></span><span class="hljs-function"> @    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LdaNamedProperty</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a0</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[4]</span></span></span><span class="hljs-function"> 28 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">E</span></span></span><span class="hljs-function">&gt; 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ddf8802cf77</span></span></span><span class="hljs-function"> @    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[6]</span></span></span><span class="hljs-function"> 36 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">S</span></span></span><span class="hljs-function">&gt; 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ddf8802cf7a</span></span></span><span class="hljs-function"> @    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Constant</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pool</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(size = 1)</span></span></span><span class="hljs-function"> 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ddf8802cf21</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FixedArray]</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OldSpace</span></span></span><span class="hljs-function"> - </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-function"> = 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ddfb2d02309</span></span></span><span class="hljs-function"> &lt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HOLEY_ELEMENTS)</span></span></span><span class="hljs-function">&gt; - </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-function">: 1          0: 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ddf8db91611</span></span></span><span class="hljs-function"> &lt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">String</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1]</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Handler</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Table</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(size = 16)</span></span></span></span></code> </pre> <br>  We can ignore a considerable part of this data by focusing on bytecodes.  Here is a description of what we see here. <br><br>  <b>LdaSmi [1]</b> <br><br>  The <code>LdaSmi [1]</code> command loads constant <code>1</code> into the cumulative register. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/748/7a7/0f2/7487a70f2dd58c6b028cb9cb45f82908.png"></div><br><br>  <b>Star r0</b> <br><br>  The <code>Star r0</code> command writes the value in the cumulative register, that is, <code>1</code> , to the <code>r0</code> register. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5e5/643/6f2/5e56436f2bc5be730b3c13fc181355f1.png"></div><br><br>  <b>LdaNamedProperty a0, [0], [4]</b> <br><br>  The <code>LdaNamedProperty</code> command loads the named property <code>a0</code> into the cumulative register.  The <code>ai</code> construct refers to the ith argument of the <code>incrementX()</code> function.  In this example, we are accessing the named property at address <code>a0</code> , that is, the first argument of <code>incrementX()</code> .  The name is determined by the constant <code>0</code> .  <code>LdaNamedProperty</code> uses <code>0</code> to look up the name in a separate table: <br><br><pre> <code class="hljs matlab">- <span class="hljs-built_in"><span class="hljs-built_in">length</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>          <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-number"><span class="hljs-number">0x2ddf8db91611</span></span> &lt;String[<span class="hljs-number"><span class="hljs-number">1</span></span>]: x&gt;</code> </pre> <br>  Here <code>0</code> displayed on <code>x</code> .  As a result, it turns out that this byte code loads <code>obj.x</code> <br><br>  What is the operand with the number <code>4</code> ?  This is the index of the so-called feedback vector (feedback vector) of the <code>increment(x)</code> function.  The feedback vector contains runtime information that is used to optimize performance. <br><br>  Now the contents of the registers is as follows. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/45c/e42/a67/45ce42a670f1f30a3aa6ad1d0d77b81c.png"></div><br>  <b>Add r0, [6]</b> <br><br>  The last instruction adds the contents of <code>r0</code> to the cumulative register, which results in a total of <code>43</code> .  The number <code>6 ‚Äî</code> another index of the feedback vector. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5db/7a0/9e1/5db7a09e1da3b25f052f753659c00848.png"></div><br><br>  <b>Return</b> <br><br>  The <code>Return</code> command returns the contents of the cumulative register.  This is the completion of the <code>incrementX()</code> function.  What caused the <code>incrementX()</code> , starts with the number <code>43</code> in the cumulative register and can continue to perform certain actions with this value. <br><br>  Please note that the bytecode to which this material is dedicated is used in V8 version 6.2, in Chrome 62 and in the not yet released Node 9. We, at Google, are constantly working on V8 in ways to improve performance and reduce memory consumption.  In other versions of V8, there may be some differences in the byte code from what was described here. <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>  At first glance, the V8 bytecode may seem rather mysterious, especially when it is displayed with a lot of additional information.  However, as soon as you learn that Ignition is a register machine with a cumulative register, you will be able to understand the purpose of most bytecodes. <br><br>  Dear readers!  Do you plan to analyze the byte code of your JS programs? </div><p>Source: <a href="https://habr.com/ru/post/336294/">https://habr.com/ru/post/336294/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336284/index.html">Blockchain: The Future of IT Professionals</a></li>
<li><a href="../336286/index.html">Reed-Solomon codes. Part 1 - the theory of simple language</a></li>
<li><a href="../336288/index.html">What is known about the possible IPO Dropbox: rumors, difficulties and numbers</a></li>
<li><a href="../336290/index.html">How to scratch a panda</a></li>
<li><a href="../336292/index.html">Not all CT pancake week, or CT does not walk by itself</a></li>
<li><a href="../336296/index.html">A simple exploit gives attackers the opportunity to change the contents of the letter after sending</a></li>
<li><a href="../336298/index.html">Check Point SMB Solutions. New models for small companies and branches</a></li>
<li><a href="../336300/index.html">KOMPAS-3D viewer for Android: the experience of porting a large Windows application</a></li>
<li><a href="../336302/index.html">Analysis of MS SQL Server, for those who see it for the first time</a></li>
<li><a href="../336304/index.html">How to overcome common graphics artifacts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>