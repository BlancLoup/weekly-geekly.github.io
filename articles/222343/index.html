<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cross compilation of libraries under iOS, doing it right</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="During the development of a large project, there comes a time when you need to build into the application a library from the open source world with a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cross compilation of libraries under iOS, doing it right</h1><div class="post__text post__text-html js-mediator-article">  During the development of a large project, there comes a time when you need to build into the application a library from the open source world with a suitable license.  For example, you wanted to speed up the decoding of images, or you needed sqlite3 with fts4, or you need some kind of libicu buns that are not in the system libicucore. <br><br>  For this, the library you need will need to be built for 5 architectures: armv7, armv7s, arm64, i386, x86_64.  There are many pitfalls with cross-compilation that I wouldn‚Äôt want to stumble upon when there are already proven solutions.  In this short post I will talk about automating the building of libraries using the example of protobuf and sqlite3. <br><a name="habracut"></a><br>  Before we do something, we need to decide what we need at the exit. <br><ul><li>  Automate the build process of multiple libraries </li><li>  Convenience of adding new libraries </li><li>  Solution distribution within repository </li><li>  Saving header files for all architectures </li></ul> <br>  Based on these requirements, the following solution was obtained.  A makefile that manages downloading, unpacking, patching, and building libraries.  Its code is not big, so you can bring it here and discuss it.  (Or <a href="https://github.com/molind/crosscompile/">download c github and run, and then read on.</a> ) <br><br>  We define the path to the newest SDK in the system and in <code>build_arches:</code> run the same Makefile up to <code>arch:</code> with the filled ARCH and IOS_PLATFORM variables.  After <code>build_arches:</code> runs, a script will be launched that will collect a <s>fat</s> fat version for each of the libraries. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cmake hljs">XCODE_TOOLCHAIN = $(shell xcode-select --print-path)/Toolchains/XcodeDefault.xctoolchain IOS_PLATFORM ?= iphoneos <span class="hljs-comment"><span class="hljs-comment"># Pick latest SDK in the directory #IOS_PLATFORM_DEVELOPER = $(shell xcrun -sdk ${IOS_PLATFORM} -show-sdk-platform-path) IOS_SDK = $(shell xcrun -sdk ${IOS_PLATFORM} -show-sdk-path) all: build_arches mkdir -p lib # Make fat libraries for all architectures for file in build/armv7/lib/*.a; \ do name=`basename $$file .a`; \ ${XCODE_TOOLCHAIN}/usr/bin/lipo -create \ -arch armv7 build/armv7/lib/$$name.a \ -arch armv7s build/armv7s/lib/$$name.a \ -arch arm64 build/arm64/lib/$$name.a \ -arch i386 build/i386/lib/$$name.a \ -arch x86_64 build/x86_64/lib/$$name.a \ -output lib/$$name.a \ ; \ done; echo "Making fat libs" # Build separate architectures build_arches: ${MAKE} arch ARCH=armv7 IOS_PLATFORM=iphoneos ${MAKE} arch ARCH=armv7s IOS_PLATFORM=iphoneos ${MAKE} arch ARCH=arm64 IOS_PLATFORM=iphoneos ${MAKE} arch ARCH=i386 IOS_PLATFORM=iphonesimulator ${MAKE} arch ARCH=x86_64 IOS_PLATFORM=iphonesimulator</span></span></code> </pre><br>  When make will work on the dependencies specified in the <code>arch:</code> target, the environment variables will be initialized for the current architecture.  Please note that we have filled out PREFIX and the make install libraries will install the build result in the ./build/armv7, ./build/armv7s folders, etc. <br><br>  Target <code>arch:</code> Indicates the targets on which it depends.  In our case, these are the libraries we collect.  When adding new libraries, their goals will need to be added to <code>arch:</code> dependencies, otherwise they will not be collected. <br><br><pre> <code class="cmake hljs">PREFIX = <span class="hljs-variable"><span class="hljs-variable">${CURDIR}</span></span>/build/<span class="hljs-variable"><span class="hljs-variable">${ARCH}</span></span> LIBDIR = <span class="hljs-variable"><span class="hljs-variable">${PREFIX}</span></span>/lib INCLUDEDIR = <span class="hljs-variable"><span class="hljs-variable">${PREFIX}</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> CXX = <span class="hljs-variable"><span class="hljs-variable">${XCODE_TOOLCHAIN}</span></span>/usr/bin/clang++ CC = <span class="hljs-variable"><span class="hljs-variable">${XCODE_TOOLCHAIN}</span></span>/usr/bin/clang CFLAGS = -isysroot <span class="hljs-variable"><span class="hljs-variable">${IOS_SDK}</span></span> -I<span class="hljs-variable"><span class="hljs-variable">${IOS_SDK}</span></span>/usr/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> -arch <span class="hljs-variable"><span class="hljs-variable">${ARCH}</span></span> -miphoneos-version-min=<span class="hljs-number"><span class="hljs-number">5.0</span></span> CXXFLAGS = -stdlib=libc++ -isysroot <span class="hljs-variable"><span class="hljs-variable">${IOS_SDK}</span></span> -I<span class="hljs-variable"><span class="hljs-variable">${IOS_SDK}</span></span>/usr/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> -arch <span class="hljs-variable"><span class="hljs-variable">${ARCH}</span></span> -miphoneos-version-min=<span class="hljs-number"><span class="hljs-number">5.0</span></span> LDFLAGS = -stdlib=libc++ -isysroot <span class="hljs-variable"><span class="hljs-variable">${IOS_SDK}</span></span> -L<span class="hljs-variable"><span class="hljs-variable">${LIBDIR}</span></span> -L<span class="hljs-variable"><span class="hljs-variable">${IOS_SDK}</span></span>/usr/lib -arch <span class="hljs-variable"><span class="hljs-variable">${ARCH}</span></span> -miphoneos-version-min=<span class="hljs-number"><span class="hljs-number">5.0</span></span> LIBTOOLFLAGS = -arch_only <span class="hljs-variable"><span class="hljs-variable">${ARCH}</span></span> arch: <span class="hljs-variable"><span class="hljs-variable">${LIBDIR}</span></span>/libsqlite3.a <span class="hljs-variable"><span class="hljs-variable">${LIBDIR}</span></span>/libprotobuf.a</code> </pre><br>  The last part is the simplest.  The purpose of building libraries, which depend on the purpose of downloading the source.  This is where you can specify custom keys for ./configure or add arm64 support to protobuf. <br><br><pre> <code class="cmake hljs"><span class="hljs-variable"><span class="hljs-variable">${LIBDIR}</span></span>/libsqlite3.a: <span class="hljs-variable"><span class="hljs-variable">${CURDIR}</span></span>/sqlite3 cd sqlite3 &amp;&amp; env CXX=<span class="hljs-variable"><span class="hljs-variable">${CXX}</span></span> CC=<span class="hljs-variable"><span class="hljs-variable">${CC}</span></span> CFLAGS=<span class="hljs-string"><span class="hljs-string">"${CFLAGS}"</span></span> \ CXXFLAGS=<span class="hljs-string"><span class="hljs-string">"${CXXFLAGS} -DSQLITE_ENABLE_RTREE -DSQLITE_ENABLE_FTS4 -DSQLITE_ENABLE_FTS4_UNICODE61"</span></span> \ LDFLAGS=<span class="hljs-string"><span class="hljs-string">"${LDFLAGS}"</span></span> ./configure --host=arm-apple-darwin --disable-shared --prefix=<span class="hljs-variable"><span class="hljs-variable">${PREFIX}</span></span> &amp;&amp; <span class="hljs-variable"><span class="hljs-variable">${MAKE}</span></span> clean <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> <span class="hljs-variable"><span class="hljs-variable">${LIBDIR}</span></span>/libprotobuf.a: <span class="hljs-variable"><span class="hljs-variable">${CURDIR}</span></span>/protobuf cd protobuf &amp;&amp; env CXX=<span class="hljs-variable"><span class="hljs-variable">${CXX}</span></span> CC=<span class="hljs-variable"><span class="hljs-variable">${CC}</span></span> CFLAGS=<span class="hljs-string"><span class="hljs-string">"${CFLAGS}"</span></span> CXXFLAGS=<span class="hljs-string"><span class="hljs-string">"${CXXFLAGS}"</span></span> LDFLAGS=<span class="hljs-string"><span class="hljs-string">"${LDFLAGS}"</span></span> \ ./configure --host=arm-apple-darwin --disable-shared --with-protoc=/usr/local/bin/protoc --prefix=<span class="hljs-variable"><span class="hljs-variable">${PREFIX}</span></span> &amp;&amp; <span class="hljs-variable"><span class="hljs-variable">${MAKE}</span></span> clean <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> <span class="hljs-variable"><span class="hljs-variable">${CURDIR}</span></span>/sqlite3: curl https://www.sqlite.org/<span class="hljs-number"><span class="hljs-number">2014</span></span>/sqlite-autoconf-<span class="hljs-number"><span class="hljs-number">3080403</span></span>.tar.gz &gt; sqlite3.tar.gz tar xzvf sqlite3.tar.gz rm sqlite3.tar.gz mv sqlite-autoconf-<span class="hljs-number"><span class="hljs-number">3080403</span></span> sqlite3 touch sqlite3 <span class="hljs-variable"><span class="hljs-variable">${CURDIR}</span></span>/protobuf: curl https://protobuf.googlecode.com/files/protobuf-<span class="hljs-number"><span class="hljs-number">2.5</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.tar.gz &gt; protobuf.tar.gz tar xzvf protobuf.tar.gz rm protobuf.tar.gz mv protobuf-<span class="hljs-number"><span class="hljs-number">2.5</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> protobuf <span class="hljs-comment"><span class="hljs-comment"># add arm64 support https://code.google.com/p/protobuf/issues/detail?id=575 patch -p0 &lt;protobuf_arm64.patch touch protobuf clean: rm -rf build lib sqlite3 protobuf</span></span></code> </pre><br>  At the output: in the folder / lib are the fat versions of the libraries, and in the build / {$ ARCH} / include header files that may be useful in the work. <br><br>  Header files for each architecture are not always needed separately, but there are libraries that, at the ./configure stage, explicitly store the sizes of the system types in the header file, for example, in config.h.  When we use such a file for arm64 and armv7 at the same time, there is a risk that something will go wrong at some stage of the work.  And in order not to guess whether something breaks down in the logic of the library or not and not to include in the project additional library testing on all architectures in search of compatibility problems, I use separate versions of header files for all fat libraries.  This is easy to do, in the <b>Header Search Path</b> you need to add <code>"$(SRCROOT)/../../libs/build/$(arch)/include"</code> .  Where <code>/../../libs/build/</code> the build folder relative to the xcodeproj file. <br><br>  I found this build method in the <a href="https://github.com/PaulWagener/mapnik-ios-framework/">github repository of the mapnik raster render build</a> , and there you can also see a more complex Makefile option, when one library depends on several others. <br><br>  Files of this post can be <a href="https://github.com/molind/crosscompile">downloaded from github</a> and admire the running lines of cross-compilation.  It is enough to type <code>make</code> . </div><p>Source: <a href="https://habr.com/ru/post/222343/">https://habr.com/ru/post/222343/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222321/index.html">What is meant by apt?</a></li>
<li><a href="../222323/index.html">Mobile application analytics. Webinar recording</a></li>
<li><a href="../222325/index.html">AniJS is a library for declarative description of CSS animations.</a></li>
<li><a href="../222327/index.html">Oracle wins appeal against google</a></li>
<li><a href="../222337/index.html">Bleeding Heart Status: Upgrade to Broken</a></li>
<li><a href="../222345/index.html">Two projects of mass online collaboration</a></li>
<li><a href="../222347/index.html">Headset AfterShokz Bluez. Sound directly to the brain</a></li>
<li><a href="../222353/index.html">Comprehensive analytics of an online project using Google Analytics and Google Docs</a></li>
<li><a href="../222355/index.html">Strategy (Translated from the English chapter of "Strategy" from the book "Pro Objective-C Design Patterns for iOS" by Carlo Chung)</a></li>
<li><a href="../222357/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ108 (May 4 - 10, 2014)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>