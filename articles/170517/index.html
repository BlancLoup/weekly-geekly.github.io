<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Acceleration of crypto operations or porting experience for Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Android platform includes the Bouncycastle framework, which is designed to perform crypto operations, such as encryption or digital signature veri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Acceleration of crypto operations or porting experience for Android</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage2/642/54d/836/64254d8366f5f902cab7070a2f6e0e80.jpg">  The Android platform includes the Bouncycastle framework, which is designed to perform crypto operations, such as encryption or digital signature verification.  A distinctive feature of this framework is that it is entirely written in Java, without the use of native code.  This increases its portability, but significantly reduces the speed.  In the first approximation, the implementation of crypto functions using native code can give a significant performance boost.  This can significantly increase the speed of an application using cryptography.  Let's see if this assumption is confirmed. <br>  With this post, I want to start a series of articles on the creation of a module that performs crypto operations using the example of encryption / decryption using a symmetric AES algorithm.  To begin with, it is necessary to understand how much performance gain the use of native code can give compared to the implementation built into the OS. <br><a name="habracut"></a><br>  In order not to reinvent the bicycle and not re-implement the AES algorithm, the Crypto ++ Open Source library containing high-performance implementations of many cryptoalgorithms, including cryptoalgorithms on elliptic curves (!), Will be applied.  Many hardware features of modern processors, from vector instructions such as SSE to aligned memory allocators, are used.  The library supports many operating systems and compilers.  Let's try to adapt it for Android and call it from managed Java code. <br><br><h5>  Build a library for Android </h5><br>  First you need to download the source from <a href="http://www.cryptopp.com/">the library site</a> . <br>  After that, create an Eclipse project.  Next steps: <br><ol><li>  Write the method declaration in the java-class using the native modifier. </li><li>  Add a static block containing the code that loads the native library.  The development environment will compile a * .class file with bytecode. </li><li>  Using the javah utility, generate the * .h file with C-function declarations from the * .class file. </li><li>  Write implementations of functions using the Crypto ++ library. </li><li>  Compare the performance of the system crypto-provider and the native code. </li></ol><br>  First, write stub functions that will call native code from managed code. <br><div class="spoiler">  <b class="spoiler_title">Managed Stub Functions</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AES</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> KEY_SIZE = <span class="hljs-number"><span class="hljs-number">16</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IV_SIZE = <span class="hljs-number"><span class="hljs-number">16</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CBC</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] __key; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] __iv; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CBC</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] iv)</span></span></span><span class="hljs-function"> </span></span>{ __key = key; __iv = iv; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CBC</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ __key = GenerateKey(); __iv = GenerateIV(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">native</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] Encrypt(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">native</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] Decrypt(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] GetKey() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> __key; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] GetIV() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> __iv; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">native</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] GenerateIV(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">native</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] GenerateKey(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { System.loadLibrary(<span class="hljs-string"><span class="hljs-string">"nativecryptowrapper"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); } } }</code> </pre> </div></div><br>  Stub methods for invoking native code are normal method declarations using the <code>native</code> keyword. <br>  A static block running when the class is loaded with a classloader contains nothing but a call to <code>System.loadLibrary</code> surrounded by a <code>try-catch</code> .  It should be noted that the argument of the call to the <code>loadLibrary</code> method is the name of the library WITHOUT the lib prefix and the extension! <br>  Encryption / decryption functions are in the inner-class.  This is done in order to clearly show what is used CBC-encryption mode.  After the class has been written and the environment has successfully compiled it, you can perform step 3 (creating headers for native code). <br>  Also, the AES class contains 2 fields in which the key for encryption and the initialization vector will be stored, with which the pseudo-random number generator is initialized. <br>  To save the file, Eclipse will compile the source file into a class file, which will be needed later when generating * .h header files. <br><br><h5>  Development of the native part </h5><br>  The native part is divided into the following components: <br><ol><li>  The Crypto ++ library is a cryptopp static library.  The source code is copied from the downloaded archive to the% PRJ% / jni / cryptopp folder. </li><li>  The nativecryptowrapper dynamic library, which exports jni functions called from managed Java code.  The library is linked with the previous library in which cryptography is implemented.  Sources are in the% PRJ% / jni / nativecryptowrapper folder. </li></ol><br>  All files of the native part are located in the jni subfolder of the Eclipse project.  Each project files are located in the <code>%PRJ%/bin/%NativePrjName%</code> <br>  Now you can start implementing jni-methods that will be called from managed code.  First you need to generate the appropriate headers (* .h files). <br>  You need to go to the <code>%PRJ%/jni/nativecryptowrapper</code> folder in the console and from there start the <code>javah ‚Äìclasspath ../../bin/classes com.cryptodroid.AES</code> .  The <code>-classpath</code> parameter specifies where to look for compiled class files.  Inside the <code>%PRJ%/bin/classes</code> class files are arranged according to the packages in which they are located, so it‚Äôs not necessary to specify a specific path to the class file.  The second parameter is the full name of the class for which the header file * .h will be created. <br>  It now remains to implement the functions declared in the headers.  The implementation of the encryption function will be in the file nativecryptowrapper / aes_base.cpp and is shown below: <br><div class="spoiler">  <b class="spoiler_title">Implementation of jni-functions of cryptography</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">JNIEXPORT jbyteArray JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_cryptodroid_crypto_AES_00024CBC_Encrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv* env, jobject obj, jbyteArray source)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;jbyte&gt; key = to_vector(env, get_field_value&lt;jbyteArray&gt;(env, obj, <span class="hljs-string"><span class="hljs-string">"__key"</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;jbyte&gt; iv = to_vector(env, get_field_value&lt;jbyteArray&gt;(env, obj, <span class="hljs-string"><span class="hljs-string">"__iv"</span></span> )); CryptoPP::CBC_Mode&lt; CryptoPP::AES &gt;::Encryption e; e.SetKeyWithIV( <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;key.front()), KEY_SIZE, <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;iv.front()) ); CryptoPP::<span class="hljs-function"><span class="hljs-function">StreamTransformationFilter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filter</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">jbytearray_holder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">data_holder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source, env)</span></span></span></span>; filter.Put(<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;*data_holder.begin()), data_holder.size()); filter.MessageEnd(); jbyteArray result = env-&gt;NewByteArray(filter.MaxRetrievable()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!result) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::runtime_error(<span class="hljs-string"><span class="hljs-string">"No memory!"</span></span>); <span class="hljs-function"><span class="hljs-function">jbytearray_holder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">result_holder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result, env)</span></span></span></span>; filter.Get(<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;*result_holder.begin()), result_holder.size()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception&amp; e) { throw_jni_exception(env, e); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-function"><span class="hljs-function">JNIEXPORT jbyteArray JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_cryptodroid_crypto_AES_00024CBC_Decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv* env, jobject obj, jbyteArray source)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;jbyte&gt; key = to_vector(env, get_field_value&lt;jbyteArray&gt;(env, obj, <span class="hljs-string"><span class="hljs-string">"__key"</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;jbyte&gt; iv = to_vector(env, get_field_value&lt;jbyteArray&gt;(env, obj, <span class="hljs-string"><span class="hljs-string">"__iv"</span></span> )); CryptoPP::CBC_Mode&lt; CryptoPP::AES &gt;::Decryption d; d.SetKeyWithIV( <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;key.front()), KEY_SIZE, <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;iv.front()) ); CryptoPP::<span class="hljs-function"><span class="hljs-function">StreamTransformationFilter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filter</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(d)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">jbytearray_holder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">data_holder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source, env)</span></span></span></span>; filter.Put(<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;*data_holder.begin()), data_holder.size()); filter.MessageEnd(); jbyteArray result = env-&gt;NewByteArray(filter.MaxRetrievable()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!result) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::runtime_error(<span class="hljs-string"><span class="hljs-string">"No memory!"</span></span>); <span class="hljs-function"><span class="hljs-function">jbytearray_holder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">result_holder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result, env)</span></span></span></span>; filter.Get(<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;*result_holder.begin()), result_holder.size()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception&amp; e) { throw_jni_exception(env, e); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre><br></div></div><br>  Here you should pay attention to the additional functions used: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  <code>to_vector</code> is a function that allows you to convert <code>jbyteArray</code> (jni-array) to a regular <code>std::vector&lt;jbyte&gt;</code> </li><li>  <code>jbytearray_holder</code> - a class that encapsulates, in accordance with the RAII paradigm, memory management of a managed array </li><li>  <code>throw_jni_exception</code> - throws an exception for managed code </li><li>  <code>get_field_value</code> is a template function.  While there is only a specialization for getting fields of the <code>byte[]</code> tapa, later, if necessary, other specializations will be added. </li></ol><br><br>  Their source code is shown below: <br><div class="spoiler">  <b class="spoiler_title">Secondary functions</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> KEY_SIZE = <span class="hljs-number"><span class="hljs-number">16</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> IV_SIZE = <span class="hljs-number"><span class="hljs-number">16</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;jbyte&gt; to_vector(JNIEnv* env, jbyteArray data) { <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> data_len = env-&gt;GetArrayLength(data); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;jbyte&gt; result(data_len); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data_len) { env-&gt;GetByteArrayRegion(data, <span class="hljs-number"><span class="hljs-number">0</span></span>, data_len, &amp;*result.begin()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">jbytearray_holder</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> jbyte* iterator; jbytearray_holder(jbyteArray&amp; ar, JNIEnv* env): m_env(env), m_ar(ar) { jboolean is_copy; m_data = m_env-&gt;GetByteArrayElements(m_ar, &amp;is_copy); } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_as</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;T&gt;(m_data); } <span class="hljs-function"><span class="hljs-function">iterator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">begin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;iterator&gt;(m_data); } <span class="hljs-function"><span class="hljs-function">iterator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> begin() + size(); } <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_env-&gt;GetArrayLength(m_ar); } ~jbytearray_holder() { m_env-&gt;ReleaseByteArrayElements(m_ar, m_data, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: JNIEnv* m_env; jbyte* m_data; jbyteArray&amp; m_ar; jbytearray_holder(jbytearray_holder&amp;); jbytearray_holder&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>= (jbytearray_holder&amp;); }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throw_jni_exception</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv* env, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::exception&amp; e)</span></span></span><span class="hljs-function"> </span></span>{ jclass excClass = env-&gt;FindClass(<span class="hljs-string"><span class="hljs-string">"java/lang/IllegalArgumentException"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (excClass) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> message = <span class="hljs-string"><span class="hljs-string">"Exception from native code: "</span></span>; message += e.what(); env-&gt;ThrowNew(excClass, message.c_str()); } } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_field_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv* env, jobject obj, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; field_name)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;&gt; jbyteArray get_field_value&lt;jbyteArray&gt;(JNIEnv* env, jobject obj, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; field_name) { jclass clazz = env-&gt;GetObjectClass(obj); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!clazz) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::runtime_error(<span class="hljs-string"><span class="hljs-string">"No class!"</span></span>); jfieldID fld = env-&gt;GetFieldID(clazz, field_name.c_str(), <span class="hljs-string"><span class="hljs-string">"[B"</span></span>); jbyteArray result = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;jbyteArray&gt;(env-&gt;GetObjectField(obj, fld)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-function">JNIEXPORT jbyteArray JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_cryptodroid_crypto_AES_00024CBC_Encrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv* env, jobject obj, jbyteArray source)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;jbyte&gt; key = to_vector(env, get_field_value&lt;jbyteArray&gt;(env, obj, <span class="hljs-string"><span class="hljs-string">"__key"</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;jbyte&gt; iv = to_vector(env, get_field_value&lt;jbyteArray&gt;(env, obj, <span class="hljs-string"><span class="hljs-string">"__iv"</span></span> )); CryptoPP::CBC_Mode&lt; CryptoPP::AES &gt;::Encryption e; e.SetKeyWithIV( <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;key.front()), KEY_SIZE, <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;iv.front()) ); CryptoPP::<span class="hljs-function"><span class="hljs-function">StreamTransformationFilter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filter</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">jbytearray_holder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">data_holder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source, env)</span></span></span></span>; filter.Put(<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;*data_holder.begin()), data_holder.size()); filter.MessageEnd(); jbyteArray result = env-&gt;NewByteArray(filter.MaxRetrievable()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!result) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::runtime_error(<span class="hljs-string"><span class="hljs-string">"No memory!"</span></span>); <span class="hljs-function"><span class="hljs-function">jbytearray_holder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">result_holder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result, env)</span></span></span></span>; filter.Get(<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;byte*&gt;(&amp;*result_holder.begin()), result_holder.size()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception&amp; e) { throw_jni_exception(env, e); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre><br></div></div><br>  The call to the system crypto-provider was made as follows: <br><pre> <code class="java hljs">Cipher _e = Cipher.getInstance(<span class="hljs-string"><span class="hljs-string">"AES/CBC/PKCS5Padding"</span></span>); SecretKeySpec skeySpec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecretKeySpec(key, <span class="hljs-string"><span class="hljs-string">"AES"</span></span>); IvParameterSpec ivspec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IvParameterSpec(iv); _e.init(Cipher.ENCRYPT_MODE, skeySpec, ivspec); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] encrypted = _e.doFinal(data); Cipher _d = Cipher.getInstance(<span class="hljs-string"><span class="hljs-string">"AES/CBC/PKCS5Padding"</span></span>); _d.init(Cipher.DECRYPT_MODE, skeySpec, ivspec); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decrypted = _d.doFinal(encrypted);</code> </pre><br>  The call to the native implementation of the crypto-provider was made as follows: <br><pre> <code class="java hljs">AES.CBC e = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AES.CBC(iv, key); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] encrypted = e.Encrypt(data); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decrypted = e.Decrypt(encrypted);</code> </pre><br><br><h5>  Build project </h5><br>  The native part build process, implemented using the ndk-build utility included in the NDK, configures the Android.mk file and Application.mk.  To build a project, you need to write the values ‚Äã‚Äãin the variables describing the project: <br><ol><li>  <code>LOCAL_SRC_FILES</code> - list of source files </li><li>  <code>LOCAL_MODULE</code> - module name </li><li>  <code>LOCAL_STATIC_LIBRARIES</code> - a list of static libraries to be used when building (optional) </li><li>  <code>LOCAL_CFLAGS</code> - additional compiler flags (if needed) </li></ol><br>  Description of the project in the file Android.mk consists of: <br><ol><li>  <code>CLEAR_VARS</code> macro </li><li>  Changes to required variables (see above) </li><li>  <code>BUILD_xxx</code> one of the <code>BUILD_xxx</code> macros, for example <code>BUILD_STATIC_LIBRARY</code> or <code>BUILD_SHARED_LIBRARY</code> </li></ol><br>  The Application.mk file contains more global settings.  The following options were used: <br><ol><li>  <code>APP_STL</code> - STL Usage Flag </li><li>  <code>APP_ABI</code> - list of target architectures </li><li>  <code>APP_OPTIM</code> - build type (debug / release) </li><li>  <code>APP_PLATFORM</code> - target platform indication </li></ol><br>  The resulting Android.mk file (for more flags on more details below), describing all three projects: <br><div class="spoiler">  <b class="spoiler_title">Andriod.mk</b> <div class="spoiler_text"><pre> <code class="bash hljs">LOCAL_PATH := $(call my-dir) include $(CLEAR_VARS) LOCAL_MODULE := nativecryptowrapper LOCAL_CFLAGS := -fexceptions -frtti LOCAL_SRC_FILES := nativecryptowrapper/aes_base.cpp LOCAL_STATIC_LIBRARIES := cryptopp include $(BUILD_SHARED_LIBRARY) include $(CLEAR_VARS) LOCAL_MODULE := cryptopp LOCAL_CFLAGS := -fexceptions -frtti LOCAL_SRC_FILES := \ cryptopp/3way.cpp \ .... cryptopp/zdeflate.cpp \ cryptopp/zinflate.cpp \ cryptopp/zlib.cpp include $(BUILD_STATIC_LIBRARY)</code> </pre><br></div></div><br><br>  Contents of the Application.mk file: <br><pre> <code class="bash hljs">APP_STL := gnustl_static APP_ABI := armeabi armeabi-v7a x86 APP_OPTIM := release APP_PLATFORM=android-9</code> </pre><br><br>  To make the static library containing Crypto ++ start to build correctly, the following changes were made: <br><ul><li>  Added compilation flags <code>-fexceptions</code> and <code>-frtti</code> to the <code>-frtti</code> variable of the <code>LOCAL_CFLAGS</code> file (since the Crypto ++ library uses exceptions and castings dynamic_cast) </li><li>  Added dependency on STL (STL implementation - gnustl_static) to the file Application.mk </li><li>  Added support for hardware architectures (x86, arm) </li></ul><br>  It can be summarized that porting a normally written code for Android does not constitute a special problem. <br>  The sources of the resulting project are on <a href="https://github.com/RainM/CryptoDroid">github</a> .  NDK r8d was used for the assembly. <br><br><h5>  Launch </h5><br>  It's time to measure performance.  For this, the <code>System. nanoTime()</code> method was used <code>System. nanoTime()</code>  <code>System. nanoTime()</code> from the standard Java class library on Android.  Measurements were taken on: Megafon Mint, Pocketbook A10.  The results are as follows: <br><table><tbody><tr><th></th><th>  Megafon Mint, ms </th><th>  Pocketbook A10, ms </th></tr><tr><td>  System Crypt Provider </td><td>  998 </td><td>  1835 </td></tr><tr><td>  Crypto ++ library </td><td>  231 </td><td>  970 </td></tr><tr><td>  Acceleration </td><td>  4.3x </td><td>  1.9x </td></tr></tbody></table><br>  As can be seen from the table, the use of an optimized native library will significantly increase the encryption speed.  It is worth saying that the library Crypto ++ actively uses intrinsiki from SIMD extensions SSEx when compiling under x86. <br>  In the following articles I will talk about the architecture of the java cryptography architecture and show you how to write your own crypto-provider for it.  As a result, a crypto-provider will be created that implements the AES cryptographic algorithm using the native code. <br><br><h5>  Useful links: </h5><br>  1. Encryption modes: <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25B6%25D0%25B8%25D0%25BC_%25D1%2588%25D0%25B8%25D1%2584%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F">http://ru.wikipedia.org</a> <br>  2. Crypto ++ library: <a href="http://www.cryptopp.com/">http://www.cryptopp.com</a> <br>  3. Adnroid NDK: <a href="http://developer.android.com/tools/sdk/ndk/index.html">http://developer.android.com</a> </div><p>Source: <a href="https://habr.com/ru/post/170517/">https://habr.com/ru/post/170517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170505/index.html">The digest of news from the world of mobile development in the last week # 3 (February 17 - 23, 2013)</a></li>
<li><a href="../170509/index.html">Optimization / compression of SVG images</a></li>
<li><a href="../170511/index.html">Pizza, duck eggs, some Linux and Android or something new in Ivideon</a></li>
<li><a href="../170513/index.html">The release of Ruby 2.0.0</a></li>
<li><a href="../170515/index.html">How to become a leading developer. Part 2</a></li>
<li><a href="../170523/index.html">Principles are eternal, practices are illusory</a></li>
<li><a href="../170525/index.html">Record weekend - world overclocking record in 3DMark03 from Russia</a></li>
<li><a href="../170527/index.html">Our answer is Raspberry Pi</a></li>
<li><a href="../170531/index.html">Homemade switch layouts for Windows</a></li>
<li><a href="../170535/index.html">Browser TTD: closed network game testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>