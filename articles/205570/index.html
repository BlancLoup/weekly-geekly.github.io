<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Object oriented C</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You were given the task to write a program in C, and you have already forgotten how a program can work, in the text of which there is not a single wor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Object oriented C</h1><div class="post__text post__text-html js-mediator-article">  You were given the task to write a program in C, and you have already forgotten how a program can work, in the text of which there is not a single word class or virtual?  Or maybe you are in love with the simplicity and severity of ANSI C, but sometimes you lack the object-oriented properties of higher-level languages?  Or is it just interesting to look at the good old C from a slightly different side?  In any case, in this article I will show a few simple techniques, with the help of which you can think and write object-oriented in C. <br><a name="habracut"></a><br>  Suppose we need to write a function to compress data.  Data can be compressed by different algorithms.  When changing algorithms, the code of the calling function should not change.  It is also desirable that the algorithms can be changed on the fly. <br>  In C ++, it would look something like this: <br><br><pre><code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">compressor</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data)</span></span></span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uncompress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data)</span></span></span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">status</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rar_compressor</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> compressor {...}; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip_compressor</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> compressor {...}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_compress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(compressor* c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* in_data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* out_data)</span></span></span><span class="hljs-function"> </span></span>{ c-&gt;compress(in_data); c-&gt;uncompress(out_data); c-&gt;status(); }</code> </pre> <br><br>  Or so: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Cmp&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_compress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Cmp&amp; c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* in_data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* out_data)</span></span></span><span class="hljs-function"> </span></span>{ c.compress(in_data); c.uncompress(out_data); c.status(); }</code> </pre><br>  Let's try to implement this scheme in C. <br><br><pre> <code class="hljs cpp">#compressor_interface.h <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">compressor_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">// `public` interface void (*compress)(struct compressor_t*, void* data); void (*uncompress)(struct compressor_t*, void* data); void (*status)(struct compressor_t*); // `private` part void* impl_; } compressor_t;</span></span></code> </pre><br><br>  As you can see, only the open interface is available to the user, all implementation details <br>  hidden behind `impl_`. <br>  We implement specific "classes". <br><pre> <code class="hljs swift">#rar.h void rar_init(compressor_t* <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>, int cr); void rar_free(compressor_t* <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>);</code> </pre><br><br><pre> <code class="hljs erlang-repl">#rar.c typedef struct { int compressed_ratio; int error; int time_to_finish; } rar_impl_t; //////////////////////////////////////////////////////////////////////////////// //      #define PREPARE_IMPL(c) \ assert(c); \ assert(c-&gt;impl_); \ rar_impl_t* impl = (rar_impl_t*)c-&gt;impl_; //////////////////////////////////////////////////////////////////////////////// static void compress(compressor_t* c, void* data) { PREPARE_IMPL(c) printf(<span class="hljs-string"><span class="hljs-string">"RAR: compressor working. Compressed ratio: %d\n"</span></span>, impl-&gt;compressed_ratio); } //////////////////////////////////////////////////////////////////////////////// static void uncompress(compressor_t* c, void* data) { PREPARE_IMPL(c) printf(<span class="hljs-string"><span class="hljs-string">"RAR: uncompressor working. Will be finished in %d.\n"</span></span>, impl-&gt;time_to_finish); } //////////////////////////////////////////////////////////////////////////////// static void status(compressor_t* c) { PREPARE_IMPL(c) printf(<span class="hljs-string"><span class="hljs-string">"Compressed ratio: %d, error: %d\n"</span></span>, impl-&gt;compressed_ratio, impl-&gt;error); } //////////////////////////////////////////////////////////////////////////////// //  void rar_init(compressor_t* c, int cr) { assert(c); c-&gt;impl_ = malloc(sizeof(rar_impl_t)); rar_impl_t* impl = (rar_impl_t*)c-&gt;impl_; //  `private`  impl-&gt;time_to_finish = <span class="hljs-number"><span class="hljs-number">5</span></span>; impl-&gt;compressed_ratio = cr; impl-&gt;error = <span class="hljs-number"><span class="hljs-number">0</span></span>; //  `public`  c-&gt;compress = &amp;compress; c-&gt;uncompress = &amp;uncompress; c-&gt;status = &amp;status; } //////////////////////////////////////////////////////////////////////////////// // void rar_free(compressor_t* c) { PREPARE_IMPL(c) free(impl); }</code> </pre><br><br>  The "class" of zip is arranged in the same way, therefore I will not give its code here.  The only thing that I would like to emphasize is the "constructors" of these classes, in contrast to member functions, do not have to have the same signature, moreover, there may be several of them for each "class". <br><br>  And now use code: <br><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">work</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">compressor_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data_to_compress, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data_to_decompress)</span></span></span><span class="hljs-function"> </span></span>{ c-&gt;compress(c, data_to_compress); c-&gt;uncompress(c, data_to_decompress); c-&gt;status(c); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* uncompressed_data[DATA_SIZE]; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* compressed_data[DATA_SIZE]; <span class="hljs-keyword"><span class="hljs-keyword">compressor_t</span></span> rar; rar_init(&amp;rar, COMP_RATIO); work(&amp;rar, uncompressed_data, compressed_data); rar_free(&amp;rar); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">compressor_t</span></span> zip; zip_init(&amp;zip, VOLUMES); work(&amp;zip, uncompressed_data, compressed_data); zip_free(&amp;zip); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><br>  An astute reader probably already noticed that, in principle, it was possible not to create a second object <i>compressor_t zip</i> , but to use the existing <i>rar</i> , and moreover, if you wish, we can replace one of the functions of the existing object on the fly.  This makes the scheme more flexible than the classical classes, for example, in C ++.  Also, you probably noticed that this approach is almost a classic <br>  implementation of the Strategy pattern. <br><br>  So well, with two of the three components of the PLO (do you remember them by heart, of course?) We figured it out.  The last one is inheritance.  In principle, inheritance can be implemented in many different ways, I will describe here the one that seems to me the most elegant. <br><br>  The implementation relies on feature C, which allows you to use anonymous member structures as members of other structures (in gcc, you may need to put the flag "-std = c11" or "-fms-extensions").  Let's write "class", "inheriting" from zip compressor'a <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">logging_compressor_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">compressor_t</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">compressor_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">base</span></span></span><span class="hljs-class">;</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>)(struct <span class="hljs-keyword"><span class="hljs-keyword">logging_compressor_t</span></span>* lc); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *impl_; <span class="hljs-comment"><span class="hljs-comment">//   } logging_compressor_t;</span></span></code> </pre><br><br>  Now we can access the ‚Äúbase‚Äù ‚Äúclass‚Äù as directly <br><pre> <code class="hljs perl">logging_compressor_t <span class="hljs-keyword"><span class="hljs-keyword">lc</span></span>; lc.compress(...)</code> </pre><br>  so and through the data member <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">lc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.base</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.compress</span></span>(...)</code> </pre><br><br>  It is possible to use this ‚Äúclass‚Äù polymorphically in the existing code as follows. <br><br><pre> <code class="hljs lisp">work(<span class="hljs-name"><span class="hljs-name">&amp;lc</span></span>.base, uncompressed_data, compressed_data)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br><br>  Of course, the meticulous reader will object to me, in such a scheme a lot rests on the accuracy of the programmer.  For example, you can spoil everything by calling ‚Äúdestructor‚Äù zip for rar and vice versa, and do a lot of other nonsense.  But I want to remind you that, firstly, the C-programmer must be careful, and secondly the purpose of the article was not to show that C is ‚Äúcooler‚Äù than other languages, but only that, if desired, you can successfully use Concepts from higher level languages ‚Äã‚Äãto support a variety of programming styles. </div><p>Source: <a href="https://habr.com/ru/post/205570/">https://habr.com/ru/post/205570/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205556/index.html">Samsung's new mSATA-SSD on 1TB weighing 8.5 grams will be on sale this month.</a></li>
<li><a href="../205560/index.html">API First architecture or reasoning on the topic: thick server vs. thin</a></li>
<li><a href="../205562/index.html">Viber now has the ability to call any phones.</a></li>
<li><a href="../205564/index.html">December 10th is an alternative programmer day</a></li>
<li><a href="../205566/index.html">By car in the "cloud"</a></li>
<li><a href="../205572/index.html">Installing ADB driver for phones of lesser-known manufacturers</a></li>
<li><a href="../205574/index.html">Pair programming as a service</a></li>
<li><a href="../205578/index.html">StartAD.mobi: Greetings</a></li>
<li><a href="../205580/index.html">FreeSWITCH PSTN Gateway for Lync Server</a></li>
<li><a href="../205584/index.html">Payoneer US Payment Service: Important Updates</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>