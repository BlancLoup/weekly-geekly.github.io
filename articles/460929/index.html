<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Atlassian Confluence: extensible in python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Alfastrakhovanie we actively use the "Wiki", the engine of which is Atlassian Confluence. The first time I seriously came across it (in an attempt ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Atlassian Confluence: extensible in python</h1><div class="post__text post__text-html js-mediator-article"><p>  In Alfastrakhovanie we actively use the "Wiki", the engine of which is Atlassian Confluence.  The first time I seriously came across it (in an attempt to create content in it), I lacked "dynamism" in it - I wanted to be able to programmatically form parts of pages, interact with other systems, etc. </p><br><p>  For some time he banged his head against different walls, but then he saw that "there was not one wall in the house."  I want to share my experience - how can I add speakers to Confluence.  I hope this will be useful to those who use it.  And, as usual, to everyone inquisitive. </p><a name="habracut"></a><br><h2 id="dinamichnyy-viki">  Dynamic wiki </h2><br><p>  Initially, Confluence suggests one universal way to expand its functionality - plugins.  Probably, he is good, there is only one drawback - a high entry threshold (you need to learn a lot). </p><br><p>  After a brief (by space standards) reflection, there were two more fairly simple ways to expand its functionality: standard macro "HTML" and "HTML Include", in this article I will focus on the latter in more detail. </p><br><p>  There is one principle of operation for these methods - HTML code is embedded in the Confluence page, it can be static (which can also be interesting, for example, for non-standard page formatting), it can be dynamic (including server components). </p><br><h2 id="primer-zapros-na-soglasovanie">  Example: reconciliation request </h2><br><p>  Let's look at the proposed way to expand the capabilities of Confluence using a simple example - a document approval list. </p><br><p>  What we want to do: add a list of approval to the page so that everyone can see who should coordinate the document, whether it was agreed, and if so, when. </p><br><p>  For convenience, we will make the list item a button and write in it the name of the coordinator.  The button will be active if the page is viewed by a coordinator, and not active in all other cases. </p><br><p>  After approval, the button "will cease to be a button" - instead of a button after approval, we will draw on the page the fact of approval in the form of a text (the name of the approver and the date of approval).  In the most draft version (without design) it may look something like this: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3cf/285/175/3cf2851757c85ff0c8994dde698ec5d7.png" alt="image"></p><br><h3 id="shema-vzaimodeystviya">  Interaction scheme </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/600/48b/a4c/60048ba4cdef1ccdd55a355cb8bf3c19.png" alt="image"></p><br><p>  Comments - how it works: </p><br><ul><li>  the page in Confluence contains several macro "html include" - actually HTTP GET requests with parameters (we will consider in more detail below) </li><li>  when rendering a page, these requests (python scripts) are executed on the application server, the result (generated HTML) is drawn on the page </li><li>  in the process of its work, the script, for example, contacts the database with the history of page signing, if the page has not been "signed" by the signer yet - HTML will contain a button (everything as described above) </li><li>  when you click on the button, submit occurs - another python script is called (a script for processing the fact of coordination) </li><li>  this script saves information about the fact of signing into the database and redirects the user back to the original page (when rendering which the fact of signing will be taken into account - clicking on the "sign" button) </li></ul><br><p>  A little complicated in words, let's try to clarify the code. </p><br><p>  So we need to create two scripts </p><br><ul><li>  script for the formation of the "sign" button (I will call it the script "button") </li><li>  a script for working out the fact of signing (reaction to a button click - I will call it a script "handler") </li></ul><br><p>  Let's create them, start with the button. </p><br><h4 id="skript-knopka">  Script Button </h4><br><p>  Schematically, how the button script works: </p><br><pre><code class="python hljs">date = getSignDate() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> date: <span class="hljs-comment"><span class="hljs-comment">#       . else: if user==signee: #    else: #  inactive </span></span></code> </pre> <br><p>  The script should be a valid HTML document, the body of which in the most minimal form is a form </p><br><ul><li>  action of the form contains the URL of the script "handler" </li><li>  the active button is submit </li><li>  hidden form fields contain additional parameters for the handler (in our case, the page name and signatory login) </li></ul><br><p>  An approximate view of the script (for brevity, I threw away everything unnecessary - see the full working code on <a href="https://github.com/korolmi/wikitools">github</a> ) </p><br><pre> <code class="python hljs">form = cgi.FieldStorage() signee = form[<span class="hljs-string"><span class="hljs-string">"signee"</span></span>].value <span class="hljs-comment"><span class="hljs-comment">#   (  ) actual = form["actual"].value #    id = form["id"].value #  ,    resHtml = """ &lt;!DOCTYPE HTML&gt; &lt;html&gt; &lt;head&gt;&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;&lt;/head&gt; &lt;body&gt; &lt;form name="input" action="http://172.16.108.216/misc/sign_proc.py" method="get"&gt; """ server, token = wikiLogin() #   Confluence userName = getUserName(token, signee) #        res = getSignDate(id, signee) #     if res: #    resHtml += "&lt;p&gt; ({0}, {1})&lt;/p&gt;".format(userName, res) #   else: #    if signee.lower() == actual.lower(): #      -   resHtml += '&lt;input type="hidden" name="id" value="{0}"&gt;'.format(id) resHtml += '&lt;input type="hidden" name="signee" value="{0}"&gt;'.format(signee) resHtml += "   &lt;input type=\"submit\" value=\"{0}\"&gt;".format(userName) else: #      -    resHtml += "   &lt;input disabled type=\"submit\" value=\"{0}\"&gt;".format(userName) resHtml += "&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;" #   HTML sys.stdout.buffer.write(b'Content-Type: text/html;charset=utf-8\n\n') sys.stdout.buffer.write(resHtml.encode("utf-8"))</span></span></code> </pre> <br><h4 id="skript-obrabotchik">  Script "handler" </h4><br><p>  The task of the handler is very simple - to fix the fact of pressing the "agree" button.  Then redirect back to the page where the request came from - when rendering the page, the fact of coordination will already be taken into account (see the description above). </p><br><p>  An example (abbreviated) script "handler" (the full version - see github) </p><br><pre> <code class="python hljs">form = cgi.FieldStorage() signee = form[<span class="hljs-string"><span class="hljs-string">"signee"</span></span>].value <span class="hljs-comment"><span class="hljs-comment">#   id = form["id"].value #  ,    addSignDate(id, signee) #    resHtml = """ &lt;html&gt; &lt;head&gt; &lt;meta http-equiv="refresh" content="5;url=http://wiki.alfastrah.ru/display/DIT/{0}"&gt; &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt; &lt;title&gt; &lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt;    &lt;b&gt;{0}&lt;/b&gt;  &lt;b&gt;{1}&lt;/b&gt; . &lt;br&gt;      ...&lt;/p&gt; &lt;/body&gt; &lt;/html&gt; """.format(id, signee) sys.stdout.buffer.write(b'Content-Type: text/html;charset=utf-8\n\n') sys.stdout.buffer.write(resHtml.encode("utf-8"))</span></span></code> </pre> <br><h4 id="stranica-v-confluence">  Page in Confluence </h4><br><p>  The page in Confluence contains three macro HTML include with different parameters (see the code below) and in the simplest version looks like this: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7ba/788/498/7ba788498511262c7e13618503eae77e.png" alt="image"></p><br><p>  Page code in wiki markup format - here you can see the parameters </p><br><pre> <code class="plaintext hljs">&lt;h1&gt; &lt;/h1&gt; &lt;p&gt; ,  &lt;/p&gt; &lt;h1&gt; &lt;/h1&gt; &lt;ul&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=boss&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=korolevmv&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=maxvar&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;/ul&gt;</code> </pre> <br><h3 id="nemnogo-o-nastroyke">  A little bit about setting up </h3><br><p>  In order for the described scheme to work, it is necessary to take into account the following </p><br><h4 id="nalichie-makrosa-html-include">  Availability of HTML Include macro </h4><br><p>  Sometimes administrators ‚Äúhide‚Äù it - there are a lot of additional troubles for it (the other side of the possibilities). </p><br><p>  This macro is free and is part of Confluence - if you don‚Äôt have one, contact the administrators, let them look ... </p><br><h4 id="belye-spiski-confluence">  Confluence White Lists </h4><br><p>  Confluence will not execute scripts hosted on unknown sources, the host on which the script is hosted should be in the so-called "white lists" (contact the admins).  This applies only to the "button" script - the script of the handler is called by the button, the Confluence restrictions do not apply to it. </p><br><h4 id="vypolnimost-skriptov">  Script execution </h4><br><p>  Scripts (buttons and a handler) must be executable - copy the URL to the browser, it should work out and generate HTML, if this did not happen, debug it. </p><br><h4 id="oshibki-v-skriptah">  Script errors </h4><br><p>  If any of the scripts crashes with an error - you will not see anything good, debug properly before publishing to Confluence. </p><br><h2 id="parametry-skriptov">  Script options </h2><br><p>  An inquiring mind could pay attention to script parameters - on the one hand, they are redundant (for example, the name of the page on which the approval button is placed - is it known, why fill it in?).  On the other hand, they are unsafe (the ‚Äúintruder‚Äù in our example can change the name of the approver to his own or delete the reconciliation button at all). </p><br><p>  Redundancy can be "overcome" by user macros (I have been wondering for a long time - how can they be practically useful? I will write briefly in a separate article).  Security in Confluence is ensured by the history of the page - all ‚Äúmoves‚Äù are recorded, you can change anything, in Confluence there remains a wonderful ‚Äúaudit trail‚Äù that allows you to understand in detail who changed what and when. </p><br><h2 id="vzaimodeystvie-so-stranicey">  Page Interaction </h2><br><p>  In our practice, there have been cases when for collecting data we had to parse the page code (for example, this is how we managed portfolio management).  It is possible and not even too difficult.  Evolutionarily, we have come to the conclusion that if some information on a page is needed only for code that interprets this information, then this information is easier to immediately formulate in the code itself (in the form of JSON, for example): editing it in the page editing mode is quite simple , it is drawn by the program, but the savings on parsing and increased reliability are significant. </p><br><h2 id="esche-primery">  More examples </h2><br><p>  Why else did we use these macros (as ideas - suddenly something proves useful), very briefly </p><br><p>  <strong>Page</strong> design: if you want to design the page in a non-standard way - markup using CSS, which is contained in the HTML block </p><br><p>  <strong>Vacation calendar</strong> : we use some simple JS calendar, fill it with data from JSON, which we edit directly in the page code, we get a beautiful plate with vacations broken down (year, month, week). </p><br><p>  <strong>Printing task cards for a scrum board</strong> : we set the parameters (task numbers in Jira and additional attributes) in the form right on the wiki page (in the HTML block), the server side generates cards in a form suitable for sending to a printer. </p><br><p>  <strong>Project portfolio management</strong> : we had such an idea.  Maps were scored directly to the wiki (a scor map is a specially marked page), a large-block plan was compiled from these scor maps, which was beautifully drawn in the form of a gantt chart. </p><br><p>  <strong>Glossary</strong> : the ability to visualize terms - explanations for individual words of a page - from a common dictionary and issue dictionary entries in the form of "pop-ups".  The dictionary itself is automatically collected at the bottom of the page. </p><br><p>  <strong>Charts</strong> : if you need to draw some kind of simple chart, then it‚Äôs very simple to do this by embedding the HTML block with any of the standard packages (Google Charts, HighCharts, etc) </p><br><p>  <strong>Tables</strong> : on top of any table in Confluence you can "hang" Datatable - we get a filtered table with "pagination", very nice and convenient. </p><br><p>  The list can be continued long enough; during operation, one significant inconvenience was noticed: errors in the server code are poorly caught - 500 errors are poorly visualized and practically do not contain information.  Otherwise, experiment - it's safe enough. </p><br><h2 id="chut-podytozhim">  To summarize </h2><br><p>  The simple way described above to increase the dynamism of Confluence can solve many different problems.  To use it does not require special tools and skills.  Use is safe enough.  Recommend. </p><br><p>  In the next article I will talk about the experience of using custom macros in Confluence - which, in my opinion, can really be improved with their help. </p><br><p>  Everything is possible in programming - a matter of time and motivation only. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/460929/">https://habr.com/ru/post/460929/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../46091/index.html">Icons for your software products. Selected.</a></li>
<li><a href="../460911/index.html">Doing Good, Doing Bad: Writing Evil Code with Go, Part 2</a></li>
<li><a href="../460913/index.html">Photo tour of the museum of the Physics and Energy Institute in Obninsk</a></li>
<li><a href="../460915/index.html">Convenient database management system</a></li>
<li><a href="../460923/index.html">Yandex test task</a></li>
<li><a href="../460931/index.html">About decorators in Python</a></li>
<li><a href="../460933/index.html">Security Week 30: privacy, technology and society</a></li>
<li><a href="../460939/index.html">Longrid on the history of Russian mining and the relationship of regulators to it</a></li>
<li><a href="../460941/index.html">Business Email Compromise: No Defense Against Attack</a></li>
<li><a href="../460943/index.html">How to choose promising keys for SEO based on scenario forecasting in Google Data Studio (+ template)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>