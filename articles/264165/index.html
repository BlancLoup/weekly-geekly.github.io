<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Operation Potao: an analysis of malware for cyber espionage, part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In terms of its capabilities, the Win32 / Potao malware has many common characteristics with the BlackEnergy Trojan. Before starting to look at the te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Operation Potao: an analysis of malware for cyber espionage, part 2</h1><div class="post__text post__text-html js-mediator-article">  In terms of its capabilities, the Win32 / Potao malware has many common characteristics with the BlackEnergy Trojan.  Before starting to look at the technical capabilities of Potao, consider the origin of the name of this malware family. <br><br><img src="https://habrastorage.org/files/116/079/36a/11607936ad224a5aa83d4ecfbd35da78.jpeg"><br><br>  The first samples of Potao contained in their body an encrypted <b>GlobalPotao</b> string.  Other Potao samples that are also detected by ESET antivirus products include the names <b>Sapotao</b> and <b>node69</b> .  These words were used in the names of the Potao DLL files, as well as in the PDB paths inside the executable files.  The following are examples of lines with paths to a PDB file with Potao debugging symbols. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><img src="https://habrastorage.org/files/2c7/941/cf8/2c7941cf8068439c9aa40cb4ab16bae1.png"><br>  Fig.  21. Path to the PDB file in the body of the malware file. <br><br><img src="https://habrastorage.org/files/f0f/242/111/f0f242111ffe409b81d5230e1ef72eba.png"><br>  Fig.  22. Path to the PDB file in the body of the malware file. <br><br><img src="https://habrastorage.org/files/c84/031/1fd/c840311fd72c4040a516e9b6fd84cf44.png"><br>  Fig.  23. Path to the PDB file in the body of the malware file. <br><br><img src="https://habrastorage.org/files/e34/cf2/3c7/e34cf23c75ca4658b8cd91a9ddc8d068.png"><br>  Fig.  24. Path to the PDB file in the body of the malware file. <br><br>  The Potao malware family is a typical example of a tool that is used by cybercriminals for cyber espionage operations and for extracting (exfiltration) various confidential information from an infected computer and then sending them to a remote attacker server. <br><br>  Like many other malicious programs, Potao is installed into the system through a special malicious file called a dropper.  Below are the possible distribution vectors for Potao droppers. <br><br><ul><li>  Phishing emails and SMS messages that contain links to the dropper files.  The dropper executable file is masked using the icon of documents such as Word, Excel, PDF. </li><li>  Infection using previously compromised removable USB media. </li><li>  Distribution with the use of malicious software modifications to encrypt TrueCrypt (Win32 / FakeTC). </li></ul><br>  Dropper Potao performed in two stages.  At the first stage, it extracts the executable PE file from itself and dumps it into the directory with temporary files% temp%.  It also resets the decoy-document file to the current directory and opens it in order to mask the actions in the OS to install malware into the system.  The executable file extracted by the dropper extracts the DLL library from itself using the <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff552191%2528v%3Dvs.85%2529.aspx">RtlDecompressBuffer</a> API function.  The library is reset to the following location: <br><br>  <i>% APPDATA% \ Microsoft \% LUID% .dll</i> <br><br>  Then the library will be implemented in the explorer.exe process.  Before directly resetting the DLL to disk, the executable file of the malicious program performs special actions.  It corrects one of the names of the exported function in the associated export table entry with the special value of the LUID.  The screenshot below shows the code of the malware function that performs this operation and renames the specified function name to ‚Äú_85fc‚Äù.  As a result, each DLL loaded onto a disk will have a different hash. <br><br><img src="https://habrastorage.org/files/cfe/7e6/0c8/cfe7e60c88e34e9e989238d7886b52b2.png"><br>  Figure 25. Potao dropper function, which specializes in modifying the name of the export DLL in memory. <br><br><img src="https://habrastorage.org/files/658/620/986/6586209864c1414882326f7f9d29d8f3.png"><br>  Figure 26. The result of the modification of the name of the exported library function. <br><br>  To execute its DLL, Potao uses a standard Windows application called rundll32.exe, and to ensure its survival in the system, the following registry key with the% LUID% parameter. <br><br>  <i>HKCU \ Software \ Microsoft \ Windows \ CurrentVersion \ Run</i> <br><br>  As we have already indicated, Potao uses a modular architecture and its capabilities can be expanded using additional plug-ins. <br><br><img src="https://habrastorage.org/files/dc9/034/da7/dc9034da7d694336a6d27bee27e1e581.png"><br>  Fig.  27. The overall architecture of Win32 / Potao. <br><br>  During the installation of the malware into the system, the dropper will inject the above DLL library into the explorer.exe process.  After checking the presence of a special mutex in the system, the malicious code will also be embedded in the address space of such working processes as web browsers, Skype, uTorrent.  The part of the malicious code that is embedded in the explorer.exe context will be responsible for downloading and executing Potao plug-ins, and the code embedded in programs with a network connection will be responsible for interaction with the C &amp; C server.  The interaction between these parts is carried out through the named pipe. <br><br>  <b>Plugin Overview</b> <br><br>  The main DLL library mentioned above performs only the most basic functions of a malicious program.  Responsibility for the implementation of espionage functions rests on downloadable plugins (modules).  Malicious code loads plugins every time it is launched on the system, which indicates that they are not stored on the hard disk.  There are two types of plug-ins, the first Full, and the second Light.  Executable files of plugins of the first type export a function named <i>Plug</i> , and plug-in files of the second type export the <i>Scan</i> function.  The difference between the two types is in how each of them collects the necessary information and returns it to the client.  Full plug-ins work continuously until the system is rebooted, Light plug-ins finish their work immediately after returning the buffer with the required information. <br><br>  In the process of tracking the activity of the Potao botnet, we found plugins signed with a digital signature (Fig. 28). <br><br><img src="https://habrastorage.org/files/2e3/757/e86/2e3757e868704d21a1338ac995fc4b24.png"><br>  Fig.  28. Information about the digital certificate that signed some of the Potao plugins. <br><br>  The name of the organization ‚ÄúGrand Torg‚Äù, which issued the certificate, can be interpreted as ‚ÄúBig Market‚Äù.  However, we could not find an organization with that name.  The serial number of the certificate (Serial Number) is equal to the value 0453B96EB039AFD6C9988C8CB698E7C9, and its revocation (Revocation Time) was carried out in the following time: Aug 19 00:00:00 2014 GMT  Since the revocation date actually coincides with the date of issue, all digital signatures that were made by this certificate were invalid.  This fact leads us to the conclusion that the certificate was used from the beginning by attackers for malicious purposes and was not stolen from any vendor. <br><br>  The table below lists the known Potao plugins. <br><br><img src="https://habrastorage.org/files/991/c47/b3d/991c47b3dadb4e3989b3f25bee09c233.png"><br><br><img src="https://habrastorage.org/files/b7a/f15/fac/b7af15facb4d4c79b09bea379c96faa1.png"><br><br>  <b>Interaction with the C &amp; C Server Manager</b> <br><br>  The Win32 / Potao samples that we analyzed contained several different IP addresses of the C &amp; C control servers.  Addresses were encrypted in the body of the malware.  Below is a list of these addresses. <br><br>  87.106.44.200:8080 <br>  62.76.42.14:443 <br>  62.76.42.14:8080 <br>  94.242.199.78:443 <br>  178.239.60.96:8080 <br>  84.234.71.215:8080 <br>  67.103.159.141:8080 <br>  62.76.184.245:80 <br>  62.76.184.245:443 <br>  62.76.184.245:8080 <br><br>  The malware selects one of these addresses and attempts to establish a connection.  As you can see from the list of used ports, the interaction can be performed both via HTTP and HTTPS.  The interaction with the server is accompanied by the use of strong cryptographic algorithms in two stages.  At the first stage, key exchange takes place, and at the second stage, direct data exchange takes place.  In fig.  29 this process is presented more clearly. <br><br><img src="https://habrastorage.org/files/8a2/832/647/8a283264797244b4ae90645fbbb958cf.png"><br>  Fig.  29. Key exchange processes between a bot and a C &amp; C server, as well as network interaction between them. <br><br>  When a bot first interacts with a C &amp; C server (1), it sends a request in the POST format of the HTTP protocol.  The data sent by the bot is encapsulated using the XML-RPC protocol.  It is interesting to note that the <i>methodName</i> parameter, equal to 10a7d030-1a61-11e3-beea-001c42e2a08b, was always present in the traffic we analyzed. <br><br><img src="https://habrastorage.org/files/b4a/cca/f43/b4accaf430d54e839f2cb69d41b0f035.png"><br>  Fig.  30. The initial POST request of the HTTP protocol that the bot sends to the server. <br><br>  After receiving the above request, the C &amp; C server generates the public key RSA-2048 (2) and signs it with another, private static key RSA-2048 (3). <br><br><img src="https://habrastorage.org/files/65e/979/681/65e9796818794a89ae0551faef54bdb2.png"><br>  Figure 31. C &amp; C server response to the first bot request, which is the public key RSA-2048, signed with a private key, encoded using base64. <br><br>  When a bot receives the RSA-2048 public key signed by the server, it performs verification of its signature (s) using the corresponding static public key, which is located in the malicious program file (5).  If the verification is successful (the key signature is valid), the received key (6) will be used to encrypt the data in the next step.  The public RSA-2048 key that is hard-wired into the body of the malware has the appearance. <br><br><img src="https://habrastorage.org/files/777/0bc/17a/7770bc17a5a84da3b1f7846f299e10dc.png"><br><br>  At the second stage, the bot generates an AES-256 symmetric key (7).  This so-called.  The session key is encrypted using the received public RSA-2048 key (8) and sent to the C &amp; C server (9). <br><br>  The data transmitted from the server to the bot is encrypted using the AES-256 key (12) (13) and decrypted by it on the server side (14). <br><br>  Leaving aside the technical details of the implementation of the above-mentioned cryptographic algorithms in the malware code, consider the format of the interaction protocol between the bot and the server.  The bot sends the request to the server in encrypted form, the format of the request is shown below. <br><br>  <i>id = 4699807581825067201mapt &amp; code = 0 &amp; sdata = ver: 5.1.2600 lv: 2.8.0002 comp: COMPUTER adm: 1 x: 0 p: firefox.exe &amp; md5 = &amp; dlen = 0</i> <br><br>  It can be seen that the request contains the identifier (ID) of the computer, the campaign ID, the OS version, the malware version, the computer name, current privileges of the user account, OS width (32 or 64 bits), and the name of the current process. <br>  The server responds with the following format. <br><br>  <i>code =% cmd% &amp; data =% PAYLOAD_BASE64_ENCODED% &amp; dlen =% PAYLOAD_LENGTH% &amp; md5 =% MD5%</i> <br><br>  The value of the <i>code</i> parameter represents the type of command that the bot should execute.  The list of commands that a bot can execute is listed in the table below. <br><br><img src="https://habrastorage.org/files/13e/485/f87/13e485f87e2f43f6922e7aaa3fbfdffc.png"><br><br>  <b>Spread via removable USB media</b> <br><br>  In several malicious campaigns, the attackers used another Potao propagation vector, using the infection of removable USB drives.  Potao uses a different way to infect removable media from other worms (autorun worm).  Instead of creating an autorun.inf file in the root of the drive's file system, it uses a simple and efficient way of storing its executable file on the media with its subsequent launch.  Malware code, which is responsible for infecting removable media, copies the dropper to the root directory of all drives connected to the system.  In this case, the label of the removable media is selected as the name of the dropper file, and the system icon of this media is selected as the icon.  The remaining directories and files in the root directory on this media are assigned the attributes Hidden (hidden) and System (system).  For the user, it seems that he needs to click the icon again to open the disk.  As a result of this action, he launches a dropper for execution. <br><br><img src="https://habrastorage.org/files/a5f/eb2/b70/a5feb2b7006b4c3f8a9caf3bcc230547.png"><br>  Fig.  32. The dropper icon and its file name in the root directory of the removable media are the same as the removable media. <br><br>  Obviously, with the default settings in Windows, which I allow to hide the extension for registered file types, the user will not see the extension of the dropper executable file.  He also will not see other files in the root of the disk, as their attributes have been modified.  This malware trick can be attributed to the ‚Äúsocial engineering‚Äù method. <br><br>  The malware contains special methods in its arsenal that make it difficult for it to analyze the executable file.  One of these methods is to use hashes of API function names to call them. <br><br><img src="https://habrastorage.org/files/734/53a/32a/73453a32aab34d408ff5e7022406af9d.png"><br>  Fig.  33. Getting the addresses of WinAPI functions using the hash values ‚Äã‚Äãof their names. <br><br>  This practice of obtaining addresses of Windows API functions is used in many malicious programs; it allows malware authors not to leave the names of functions in the body of a malicious program, which significantly complicates the analysis process for analysts of antivirus companies.  To calculate the hash values ‚Äã‚Äãof the names of API functions, the malware uses the <i>MurmurHash2</i> algorithm. <br><br>  The authors also used an encryption mechanism for strings that should have been present in the body of Potao.  In fig.  34 shows the string decryption function. <br><br><img src="https://habrastorage.org/files/c0b/838/ec7/c0b838ec760e4f2ebf30ec0c7c4d33ff.png"><br>  Fig.  34. The function of decoding lines. <br><br>  The strings are encrypted using the XOR operation and a 4-byte key.  The key may vary from one malicious file to another. <br><br>  <b>Win32 / FakeTC - Malware TrueCrypt Analysis</b> <br><br>  We have already mentioned that attackers used malicious modification of legitimate TrueCrypt software for their cyber campaigns.  This modification is detected by our anti-virus products as Win32 / FakeTC and is used by attackers to extract files from the victim's encrypted disks.  FakeTC is associated with Potao only by the fact that the former may, in some cases, download the dropper of the latter onto an infected computer. <br><br><img src="https://habrastorage.org/files/ef9/89a/035/ef989a03576c4186a62d0bfce154e484.png"><br>  Fig.  35. Win32 / FakeTC detection statistics in various countries. <br><br>  In fig.  36 shows the interface of the malicious version of TrueCrypt. <br><br><img src="https://habrastorage.org/files/e24/b45/260/e24b452601be420c954d99ef92f30908.png"><br>  Fig.  36. The interface of the malicious version of TrueCrypt. <br><br>  Malware code is executed in a separate thread from other legitimate functions of TrueCrypt.  The stream is created at the end of the <i>Mount</i> function and specializes in getting a list of files on an encrypted disk that was mounted to the system.  If certain conditions are met, he connects to the manager of the C &amp; C server and expects commands from him for execution.  The malicious code was added by the attackers only to the user-mode TrueCrypt executable files containing the digital signature kernel-mode drivers remained intact. <br><br>  The following conditions must be met to connect the bot to the C &amp; C server. <br><br><ul><li>  The number of files on the encrypted disk must be more than 10. </li><li>  The encrypted disk must be mounted more than 4 times. </li></ul><br>  The list of supported FakeTC commands is given in the table below. <br><br><img src="https://habrastorage.org/files/d65/9ca/f2d/d659caf2d8e84c0093ef65c020917c70.png"><br><br>  As can be seen from the list of commands supported by FakeTC, it is used by attackers as spyware malware and can be expanded by using additional plug-ins.  The attackers used special FakeTC hiding mechanisms from prying eyes, carrying it out on the website only to selected users.  This allowed the attackers to go unnoticed for a long time. <br><br>  <b>Conclusion</b> <br><br>  Above, we described the analysis of malware that is detected by ESET antivirus products like Win32 / Potao and Win32 / FakeTC, and we also looked at various cyber campaigns of intruders.  We have shown that Win32 / Potao malware is an example of a tool for cyber espionage, and cyber attacks with its use can be attributed to the APT type, although, at the same time, Potao itself cannot be attributed to sophisticated advanced malware. <br><br>  The group of cybercriminals behind Potao‚Äôs use of cyber attacks demonstrated the effectiveness of using carefully thought-out social engineering techniques instead of using exploits.  Such well-considered techniques include the use of special SMS messages that contain a link to the malware file, as well as a special trick to infect removable media.  One of the most interesting features of this cyber campaign was the use of a malicious version of the legitimate encryption software TrueCrypt by attackers.  The program itself with malicious features was posted on the website truecryptrussia.ru and not all users could receive it.  In addition, the site itself acted as the manager of the C &amp; C server for the malware. <br><br>  The above facts characterize the Potao cyber campaign as ‚Äúpurely directed.‚Äù  The question of interest remains open, that is, who would benefit from carrying out such a cyber espionage operation on the staff of the Ukrainian military and government departments, the news agency, as well as participants in the MMM financial pyramid.  The latter is popular both in Ukraine and in Russia.  Since we would not like to speculate on the search for an answer to this question, without having any weighty evidence in hand, this question remains open. <br><br>  Below are the comparative characteristics of Potao and BlackEnergy. <br><br><img src="https://habrastorage.org/files/763/b22/0f3/763b220f392343fe9d23c30249a4ebaa.png"></div><p>Source: <a href="https://habr.com/ru/post/264165/">https://habr.com/ru/post/264165/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264155/index.html">Exchange 2013 transport queue is no longer a single mailing point</a></li>
<li><a href="../264157/index.html">Ignore extra function arguments in C ++.</a></li>
<li><a href="../264159/index.html">Yii 2.0.6</a></li>
<li><a href="../264161/index.html">Large apartment of 20 sq.m. - with augmented reality glasses it is possible</a></li>
<li><a href="../264163/index.html">10 rules of good tone when describing bugs</a></li>
<li><a href="../264167/index.html">Using the Media Capture API in a browser</a></li>
<li><a href="../264169/index.html">‚ÄúDepth-depth, I'm not yours. Let me go, depth. ‚Äù Virtual Reality for Developers</a></li>
<li><a href="../264171/index.html">Creating an Excel file from a select with parameters using pure PL / SQL</a></li>
<li><a href="../264173/index.html">Globals are Cossack swords for data storage. Trees Part 2</a></li>
<li><a href="../264175/index.html">Real-time stateful React components update for Browserify</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>