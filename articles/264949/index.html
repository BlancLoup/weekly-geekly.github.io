<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SMS from Bash or teach Zabbix new tricks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is devoted to the organization of SMS alerts in a very budget. 
 This method is suitable for home use or use in SOHO. For something more,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SMS from Bash or teach Zabbix new tricks</h1><div class="post__text post__text-html js-mediator-article">  This article is devoted to the organization of SMS alerts in a very budget. <br>  This method is suitable for home use or use in SOHO.  For something more, this scheme is not capable, keep this in mind. <br>  Earlier on Habr√© there were already articles on the topic of SMS informing, but it all came down to <a href="http://habrahabr.ru/post/155321/">local USB modems</a> or <a href="http://habrahabr.ru/post/81630/">email2sms</a> services. <br>  This article will consider a different interaction scheme.  Namely: the Mikrotik equipment will act as a GSM gateway, and Zabbix will send SMS via the terminal. <br><br>  What you need: <br>  1) Mikrotik 951 series (active USB hub is highly recommended) <br>  2) USB modem with a SIM card <br>  3) and a deployed Zabbix server. <br><a name="habracut"></a><br>  And this all works according to <a href="https://tools.ietf.org/html/rfc2217">RFC2217</a> . <br><br>  The whole configuration is divided into 3 stages: <br>  A) Mikrotik setup <br>  B) Work with the send script <br>  C) Configuring Zabbix 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Mikrotik setup </h3><br>  A USB modem is connected to Mikrotik, basic configuration and modem testing are performed. <br>  Immediately find out the channels to send SMS.  In my case, this was done experimentally, channels 1 and 2 are responsible for this function. <br><br>  In the documentation for ROS, the <a href="http://wiki.mikrotik.com/wiki/Manual:Port">function of forwarding a COM port over TCP</a> (RFC2217) was found.  It allows you to access the equipment behind the router through a normal terminal. <br><div class="spoiler">  <b class="spoiler_title">Setup in Winbox</b> <div class="spoiler_text">  System -&gt; Ports -&gt; Remote Access <br><img src="https://habrastorage.org/files/02e/611/595/02e6115955be459f9b5179eb3fb6e468.png"><br></div></div><br>  All parameters are intuitive.  Data channels SMS Settings and Remote Port should not match! <br>  From the network equipment side, the setup is over. <br><br><h3>  SMS sending script </h3><br>  In my case, Ubuntu 14.04.2 serves as the guest VM system.  So historically, you have to live with it. <br>  You can use both ‚Äúiron‚Äù Zabbix and virtual. <br><br>  By reading a ton of instructions, an SMS sending script was written to Bash, first in text format, and then in PDU format.  PDU format allows you to send SMS in Unicode, i.e.  Latin and Cyrillic characters (in this case, only they interest us). <br>  The final script attached here allows you to send ‚Äúmultipage‚Äù SMS of any content, i.e.  more than 70 characters. <br>  For those who want to penetrate, I will leave a few links: <a href="http://embeddedpro.ucoz.ru/app_notes/sending_long_SMS.html">tyk</a> and <a href="http://mobiletidings.com/2009/02/18/combining-sms-messages/">tyk</a> <br><div class="spoiler">  <b class="spoiler_title">Script on Bash</b> <div class="spoiler_text">  <i><b>The script requires the Recode utility.</b></i> <i><b><br></b></i>  <i><b>In case you want to test the script from the terminal, remove "-e" from "echo".</b></i> <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # tel=$1 header=$2 mes=$3 ip=XXX.XXX.XXX.XXX #IP  port=Y #  #  !!!   !!! TP_MR0=0 #  TP-MR IED31=1 #  IED3   UDH #... ########################################################################################################################################### #    #       UDH UDH=`echo $mes | recode ..U2/x2` #    UCS2 UDH=`echo $UDH | sed 's/0x\|,\| //g' | sed 's/000A$//g'` TP_UD=$UDH #TP-UD -   UDH=`echo -n $UDH | wc -c | gawk '{print $1}'` UDH=$(($UDH/4)) #    -      #     tel="$tel"F"" i=`echo -n $tel | wc -c | gawk '{print $1}'` i=$(($i/2)) while [ "$i" != "0" ] do R=`echo $tel | cut --complement -b '3-12' | rev` TPTEL="$TPTEL$R" tel=`echo $tel | cut --complement -b '1-2'` i=$(($i-1)) done ########################################################################################################################################### #  70  ! if [ "$UDH" -le "70" ]; then #      UCS2 TP_UDL=`echo -n $TP_UD | wc -c | gawk '{print $1}'` #       XX TP_UDL=$((($TP_UDL+1)/2)) TP_UDL=`printf '%02x' $TP_UDL | sed 's/[[:lower:]]/\u&amp;/g'` #        #   &gt; TPDU=""0011000B91"$TPTEL"0008AA"$TP_UDL$TP_UD" #    &gt; #   AT+CMGS= Byte=`echo -n $TPDU | cut --complement -b '1-2'` #  2 ,      Byte=`echo -n $Byte | wc -c | gawk '{print $1}'` Byte=$((($Byte)/2)) #    .     RFC2217,  RAW ( sleep 2 echo "AT+CMGF=0" #1 -  , 0 - PDU    !!! sleep 1 echo "AT+CSCS=\"UCS2\"" # sleep 1 echo "AT+CMGS=$Byte" #     sleep 1 echo -e "$TPDU\\032" #   + Ctrl+Z sleep 3 # ,    echo -e "\\033" #ESC   ,        sleep 3 ) | telnet $ip $port #Telnet  ,     exit 0 ################################################################################################################################## #   70! else #  ,    UDH=$((($UDH/67)+1)) # UDH    ( 1 ,     67 ) IED2=$UDH #    -   UDH IED2=`printf '%02x' $IED2 | sed 's/[[:lower:]]/\u&amp;/g'` #    .     RFC2217,  RAW ( sleep 2 echo "AT+CMGF=0" #1 -  , 0 - PDU    !!! sleep 1 echo "AT+CSCS=\"UCS2\"" # sleep 1 #   AT+CMGS= while [ $UDH -ne 0 ]; do #      UCS2 TPUD=`echo -n $TP_UD | cut --complement -b '269-100000000'` #  67      TP_UD=`echo -n $TP_UD | cut --complement -b '1-268'` #   67 ,      TP_MR=`printf '%02x' $TP_MR0 | sed 's/[[:lower:]]/\u&amp;/g'` # TP-MR (00, 01  ..) IED3=`printf '%02x' $IED31 | sed 's/[[:lower:]]/\u&amp;/g'` #   -   UDH UDH_TP_UD=""050003FF"$IED2$IED3$TPUD" #     TP-UDL TP_UDL=`echo -n $UDH_TP_UD | wc -c | gawk '{print $1}'` #      XX TP_UDL=$(($TP_UDL/2)) TP_UDL=`printf '%02x' $TP_UDL | sed 's/[[:lower:]]/\u&amp;/g'` #        TPDU=""0041"$TP_MR"0B91"$TPTEL"0008"$TP_UDL$UDH_TP_UD" #    &gt; TP_MR0=$(($TP_MR0+1)) # $TP-MR0  1    IED31=$(($IED31+1)) #     UDH UDH=$(($UDH-1)) #       #   AT+CMGS= Byte=`echo -n $TPDU | cut --complement -b '1-2'` #  2 ,      Byte=`echo -n $Byte | wc -c | gawk '{print $1}'` Byte=$((($Byte)/2)) #      echo "AT+CMGS=$Byte" #     sleep 1 echo -e "$TPDU\\032" #   + Ctrl+Z sleep 3 # ,    echo -e "\\033" #ESC   ,        sleep 3 done ) | telnet $ip $port #Telnet  ,     fi exit 0 # ,        ,  "-e"  "echo"</span></span></code> </pre> <br></div></div><br>  In the script you need to change two variables to yours - IP and Port. <br>  Three variables are transferred to the script in order: phone number, title (not used, just Zabbix sends data to the script in such a sequence) and the message itself.  Additionally, variables need not be escaped, Zabbix does it itself. <br>  By default, the script should be in: <br>  for version 2.2 - / usr / local / share / zabbix / alertscripts <br>  for version 2.4 - / usr / lib / zabbix / alertscripts. <br>  Do not forget to give the appropriate rights to the script file! <br><br><h3>  Zabbix configuration </h3><br>  On the Zabbix side, the setup procedure is trivial, but I will describe it again for posting. <br>  1) Specify the notification method <br>  2) Specify the desired phone in the user profile <br>  The phone is entered in 11-digit format, i.e.  7 ********** <br>  3) Configure actions on a triggered trigger. <br><div class="spoiler">  <b class="spoiler_title">Pictures for posting</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/2f5/83a/9fb/2f583a9fbe91427a9af04e63da4a8061.png"><br><br><img src="https://habrastorage.org/files/16c/30d/ee2/16c30dee2d084b38874c3396e9448222.png"><br><br><img src="https://habrastorage.org/files/05c/931/bbc/05c931bbcfe44054bc8fdaf74d0915e7.png"><br></div></div><br>  Do not forget that the ‚ÄúDefault Subject‚Äù action field is not taken into account in the script, therefore, you should put everything you need into the ‚ÄúDefault Message‚Äù.  I use the following construct for this: <i>{TRIGGER.NAME} {TRIGGER.DESCRIPTION} {ITEM.NAME} - {ITEM.LASTVALUE}</i> .  It is more than informative. <br><br><h3>  Afterword </h3><br>  As I warned at the beginning of the article, everything is very primitive and is not suitable for "production".  But the method allows for quite modest money to receive a little more operational information from your monitoring system.  For this, allow me to bow out. </div><p>Source: <a href="https://habr.com/ru/post/264949/">https://habr.com/ru/post/264949/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264935/index.html">Last 2 days of sales of Early Bird MBLTdev conference tickets</a></li>
<li><a href="../264937/index.html">Improving communication between the client and the UX: how to avoid a damaged phone</a></li>
<li><a href="../264941/index.html">Objectives of the entrance exam at ShAD 2014</a></li>
<li><a href="../264943/index.html">Introducing Hub 1.0 - a connector for command products JetBrains</a></li>
<li><a href="../264947/index.html">Breaking down resource compression in Might and Magic III</a></li>
<li><a href="../264953/index.html">New WiFi equipment from Ruckus Wireless. New: access points, controllers and functionality</a></li>
<li><a href="../264955/index.html">Joker 2015: News 1-18 August 2015 - new speakers and reports</a></li>
<li><a href="../264961/index.html">Part 2. Creating classes, mappings and filling database</a></li>
<li><a href="../264963/index.html">Object language restrictions (and a little about the meta model)</a></li>
<li><a href="../264965/index.html">The right bonus for your new server - Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>