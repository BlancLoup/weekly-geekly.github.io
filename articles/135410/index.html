<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using SCM to manage drivers in C # implemented using a C ++ dll / cli</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Service Control Manager (SCM) 
 SCM is a server implemented in Windows for remote control of services (procedure calls). 

 In order to run a driver i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using SCM to manage drivers in C # implemented using a C ++ dll / cli</h1><div class="post__text post__text-html js-mediator-article"><h4>  Service Control Manager (SCM) </h4><br>  SCM is a server implemented in Windows for remote control of services (procedure calls). <br><br>  In order to run a driver in Windows, it is assigned a service that provides control of this driver.  Not to be confused with the device that creates the driver in the system through which messages are exchanged with the driver.  This device is created after the driver has started, but the SCM ensures that the driver itself is added to the system.  With SCM, you can: add, remove, start, or stop services. <br><br><h4>  Formulation of the problem </h4><br>  Write a buffer class that allows you to simplify the work of SCM in C #. <br>  The very appearance of this class can be made very simple: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ref <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceControlManager</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IDisposable { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ServiceControlManager(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddDriver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String^ ServiceName, String^ BinaryPathName)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteDriver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String^ ServiceName)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartDriver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String^ ServiceName)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StopDriver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String^ ServiceName)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: ~ServiceControlManager(); !ServiceControlManager(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: SC_HANDLE SCMHandle; };</code> </pre> <br>  Constructor, destructor, finalizer, main methods, from attributes only HANDLE of object SCM.  From this it follows that an instance of an object of this class will contain the created SCM object, and the methods simplify the work with it.  The class is a buffer class, and since it is implemented in C ++ / cli it will automatically scale to work in the .NET environment, respectively, in C #. <br><a name="habracut"></a><br><h4>  Solving the problem with errors </h4><br>  The main problem of working with such a class is the return of error codes that occurred during the SCM process, which should be replaced at the very first stage of work with exceptions that are more familiar to the .NET environment.  To do this, you can create a similar class: <br><br><pre> <code class="cpp hljs">[Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ref <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">KernelErrorException</span></span></span><span class="hljs-class"> :</span></span> Exception { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: KernelErrorException(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> String^ ToString() override; property <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> String^ Message { String^ get() override; }; property <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> DWORD Errorsource { <span class="hljs-function"><span class="hljs-function">DWORD </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: DWORD errorsource; internal: KernelErrorException(DWORD Errorsource); };</code> </pre><br>  As we see, an instance of this class will contain, as an attribute, only the code number that will be obtained from GetLastError ().  And if you try to cast an instance to the System :: String type, it will display the full text of the message description using Windows tools. <br><br>  The class has two constructors, the first - by default: saves the error code during execution.  The second one gets the error code as an argument.  The second one should be used in cases when it is necessary to raise an exception, but before doing so, perform any actions, after which the GetLastError () command will return incorrect values.  To do this, the error code is saved, actions are performed, then an exception is thrown.  An example of such actions can be found below: clearing the PTR used for marshaling (PTR must be cleared before an exception is thrown, since it is impossible to return to this piece of code in the future). <br><br><div class="spoiler">  <b class="spoiler_title">Implementation</b> <div class="spoiler_text"><pre> <code class="cpp hljs">KernelErrorException::KernelErrorException(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;errorsource = GetLastError(); } KernelErrorException::KernelErrorException(DWORD Errorsource) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;errorsource = Errorsource; }</code> </pre><br>  In this case, the implementation of the methods will be the most elementary: <br><br><pre> <code class="cpp hljs">String^ KernelErrorException::Message::get() { LPTSTR message = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;errorsource, MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), (LPTSTR)&amp;message, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); String^ messageString = gcnew String(message); LocalFree(message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> messageString; } DWORD KernelErrorException::Errorsource::get() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;errorsource; } String^ KernelErrorException::ToString() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;Message::get(); }</code> </pre><br></div></div><br><h4>  SCM allocated memory must be cleared. </h4><br>  The second problem of working with SCM in .NET: handle SCM cannot live long, otherwise it will cause the system to hang.  Therefore, when using it, it is necessary to ensure that the removal is not the garbage collection, but the programmer himself.  It is necessary to strictly describe the constructor and finalizer, in the destructor, according to the logic of the Dispose-pattern, the finalizer is called [thanks to <a href="https://habrahabr.ru/users/grad_kh/" class="user_link">GraD_Kh</a> ].  The finalizer describes the release of unmanage objects: <br><br><pre> <code class="cpp hljs">ServiceControlManager::ServiceControlManager(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;SCMHandle = OpenSCManager(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, SC_MANAGER_ALL_ACCESS); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;SCMHandle) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(); } ServiceControlManager::~ServiceControlManager() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;!ServiceControlManager(); GC::SuppressFinalize(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } ServiceControlManager::!ServiceControlManager() { CloseServiceHandle(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;SCMHandle)); }</code> </pre><br><h4>  Main functionality </h4><br>  The implementation of all methods is very simple, the basis of which is the challenge of a specific relevant procedure, but correct execution necessarily requires all checks for exceptional situations. <br><br><div class="spoiler">  <b class="spoiler_title">Implementation</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ServiceControlManager::AddDriver(String^ ServiceName, String^ BinaryPathName) { IntPtr serviceNamePtr = Marshal::StringToHGlobalUni(ServiceName); IntPtr binaryPathNamePtr = Marshal::StringToHGlobalUni(BinaryPathName); SC_HANDLE SCMHandleService = CreateService(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;SCMHandle, (LPCTSTR)serviceNamePtr.ToPointer(), (LPCTSTR)serviceNamePtr.ToPointer(), SERVICE_ALL_ACCESS, SERVICE_KERNEL_DRIVER, SERVICE_DEMAND_START, SERVICE_ERROR_NORMAL, (LPCTSTR)binaryPathNamePtr.ToPointer(), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); DWORD errorsource = GetLastError(); Marshal::FreeHGlobal(serviceNamePtr); Marshal::FreeHGlobal(binaryPathNamePtr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SCMHandleService) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(errorsource); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CloseServiceHandle(SCMHandleService)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ServiceControlManager::DeleteDriver(String^ ServiceName) { IntPtr serviceNamePtr = Marshal::StringToHGlobalUni(ServiceName); SC_HANDLE SCMHandleService = OpenService(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;SCMHandle, (LPCTSTR)serviceNamePtr.ToPointer(), SERVICE_ALL_ACCESS); DWORD errorsource = GetLastError(); Marshal::FreeHGlobal(serviceNamePtr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SCMHandleService ) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(errorsource); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!DeleteService(SCMHandleService)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CloseServiceHandle(SCMHandleService)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ServiceControlManager::StartDriver(String^ ServiceName) { IntPtr serviceNamePtr = Marshal::StringToHGlobalUni(ServiceName); SC_HANDLE SCMHandleService = OpenService(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;SCMHandle, (LPCTSTR)serviceNamePtr.ToPointer(), SERVICE_ALL_ACCESS); DWORD errorsource = GetLastError(); Marshal::FreeHGlobal(serviceNamePtr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SCMHandleService) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(errorsource); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!StartService(SCMHandleService, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CloseServiceHandle(SCMHandleService)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ServiceControlManager::StopDriver(String^ ServiceName) { IntPtr serviceNamePtr = Marshal::StringToHGlobalUni(ServiceName); SC_HANDLE SCMHandleService = OpenService(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;SCMHandle, (LPCTSTR)serviceNamePtr.ToPointer(), SERVICE_ALL_ACCESS); DWORD errorsource = GetLastError(); Marshal::FreeHGlobal(serviceNamePtr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SCMHandleService) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(errorsource); SERVICE_STATUS serviceStatus; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ControlService(SCMHandleService, SERVICE_CONTROL_STOP, &amp;serviceStatus)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CloseServiceHandle(SCMHandleService)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> gcnew KernelErrorException(); }</code> </pre><br></div></div><br>  The first method associates the sys file with the service by adding this service to the system.  The second - removes the driver from the system, the other two - start and stop the service, respectively. <br><br><h4>  Examples of use in C #: </h4><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ServiceControlManager scm = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceControlManager()) { scm.AddDriver(serviceName, filePath); scm.StartDriver(serviceName); scm.StopDriver(serviceName); scm.DeleteDriver(serviceName); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { }</code> </pre><br><br><h4>  Compile Settings </h4><br>  The most important thing to remember to constantly use marshaling between a managed and unmanaged heap.  Let me remind you that for marshalling you must be in the namespace: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> System::Runtime::InteropServices;</code> </pre><br><br>  Do not forget to write lib: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> comment(lib, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Advapi32.lib"</span></span></span><span class="hljs-meta">)</span></span></code> </pre><br><br>  Property settings when compiling the library: <br><img src="https://habrastorage.org/getpro/habr/post_images/f67/960/6c8/f679606c85282c6d80bede686a08ffcb.png" alt="Project Properties"><br><br><h4>  Afterword </h4><br>  Many may argue that such an approach does not make any sense, and that it is much easier in C # to use the marshalling arguments from standard libraries.  But, in my opinion, my solution is more flexible.  And it allows you to get rid of non-essential variables, adjusting the class for yourself.  / Those who tried to configure DLLImport of these functions in x64 will understand me ... / <br><br>  <a href="https://github.com/zeegin/ServiceControlManager">GitHub library sources with user interface program</a> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3ee/53a/f6d/3ee53af6d3b15eb094fda0847cc7e942.png" alt="Application window"></div><p>Source: <a href="https://habr.com/ru/post/135410/">https://habr.com/ru/post/135410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135403/index.html">Sketch - 100 seconds about podcasting</a></li>
<li><a href="../135405/index.html">Professional translation of the documentary film "The First Macintosh" 1984. (Russian translation - GTV Channel)</a></li>
<li><a href="../135406/index.html">Nokia 3 inch display</a></li>
<li><a href="../135407/index.html">Steam Sales</a></li>
<li><a href="../135408/index.html">Python using the example of the new git commit notification daemon</a></li>
<li><a href="../135412/index.html">New Year's banner on the site with CSS3</a></li>
<li><a href="../135413/index.html">Several finds</a></li>
<li><a href="../135419/index.html">Authentication on CISCO network devices by means of Active Directory</a></li>
<li><a href="../135420/index.html">Intelligent conversational systems with a natural language interface</a></li>
<li><a href="../135421/index.html">Beautiful image output</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>