<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Embedded Hyper-V Virtualization - First Step</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Article author - Mikhail Komarov, MVP - Cloud and Datacenter Management 
 Good day! The goal of today's article is to talk about the implementation of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Embedded Hyper-V Virtualization - First Step</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <i>Article author - Mikhail Komarov, MVP - Cloud and Datacenter Management</i> </blockquote><br>  Good day!  The goal of today's article is to talk about the implementation of embedded virtualization on the Hyper-V platform.  It's no secret that Hyper-V did not support nested virtualization, unlike other manufacturers.  With the release of Windows Server 2016 Technical Preview 4 (TP4), which is designed for those who want to try the new functionality, the situation has changed.  You can see demonstrations of embedded virtualization in the ‚Äú <a href="https://channel9.msdn.com/Events/Microsoft-TechDay/Microsoft-Tech-Day-2015/One-report-one-laptop-one-data-center">One Report, One Laptop, One</a> <a href="https://channel9.msdn.com/Events/Microsoft-TechDay/Microsoft-Tech-Day-2015">Data Center</a> ‚Äù <a href="https://channel9.msdn.com/Events/Microsoft-TechDay/Microsoft-Tech-Day-2015/One-report-one-laptop-one-data-center">report</a> at the <a href="https://channel9.msdn.com/Events/Microsoft-TechDay/Microsoft-Tech-Day-2015">Microsoft TechDay 2015</a> event. <br><br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://channel9.msdn.com/Events/Microsoft-TechDay/Microsoft-Tech-Day-2015/One-report-one-laptop-one-data-center/player&amp;xid=17259,1500004,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhM2z4Yj0GWwFI1QnWfdEUmNtR4Dw" width="960" height="540"></iframe><br><a name="habracut"></a><br>  All demonstrations were held on HP Blade Gen 8, with a basic Intel Xeon E5 2670 processor and 32 GB of RAM. <br><br>  The choice of this system was due to the desire to show how low the threshold of entry into virtualization technology can be.  In general, the usual system by today's standards, when most homes have Intel Core i3 and above, and the amount of RAM starts at 8GB.  This means that you can use nested virtualization if necessary. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Architecture </h1><br>  Recall the classic version of virtualization.  If we have a physical host with support for virtualization at the chipset and processor level and the necessary options included in the BIOS, we get the following picture: <br><br><img src="https://habrastorage.org/files/b1a/48e/178/b1a48e178ab641d08c3e84141301e67f.png"><br><br>  At the zero level there is a physical host, and at the first level there is a thin layer of software called the hypervisor.  Also on the first level is the partition with the root operating system and partitions for virtual machines.  Let's illustrate with the use of the CoreInfo utility from Mark Russinovich the behavior of the processor parameters associated with virtualization.  The table shows the first few lines of the CoreInfo utility. <br><br><img src="https://habrastorage.org/files/b37/a34/074/b37a340741e0412a9e04185bdbd317fd.png"><br><br>  Prior to enabling the Hyper-V role, the processor parameter associated with virtualization was transferred to the operating system.  This can be seen in two lines on the left side of the table.  The first parameter is the absence of a hypervisor, the second is the flag responsible for virtualization.  After turning on the role of the hypervisor, we look again at the properties of the processor in the root partition and see the following: the hypervisor is turned on, and the flag associated with virtualization is not translated into the root section of the operating system.  Also pay attention to the value of Microprocessor signature, which in our case is 0000710 and is associated with a physical processor. <br><br>  Let's move to nested virtualization. <br><br><img src="https://habrastorage.org/files/140/d32/8d9/140d328d9b3849d29899b67f26190c97.png"><br><br>  The figure shows that it is necessary to forward the flag associated with virtualization to the guest OS.  That is, in general, we need to tell the hypervisor at the first level that it is necessary to enable virtualization support in a shared processor for the virtual machine.  To do this, you need to run a script that changes some properties of the virtual machine.  One of the main properties that the script modifies is the behavior of the virtual machine processor.  // Set-VMProcessor -VMName $ vmName -ExposeVirtualizationExtensions $ true //.  We will talk about the remaining parameters a bit later.  We illustrate the behavior of processor parameters associated with virtualization on a virtual machine.  The table displays the first few lines of the CoreInfo utility. <br><br><img src="https://habrastorage.org/files/df2/c70/4e0/df2c704e0b464b768fc418a134e8bb0f.png"><br><br>  From the table it is clear that the virtual machine "understands" what is working from under the hypervisor.  But before running the script, the flag associated with virtualization is not passed.  Then the script that changed the properties of our virtual machine and its processor and the flag associated with virtualization appeared.  Next, we turned on the Hyper-V role, after that a thin layer of virtualization appeared and our operating system moved to its root partition, the virtualization flag disappeared.  Also pay attention to the value of Microprocessor signature, which in our case was FFFFFFFF, which indicates processor virtualization.  Next, we created a virtual machine inside the virtual machine and for the purity of the experiment, we launched the utility CoreInfo. <br><br><img src="https://habrastorage.org/files/eab/53e/dab/eab53edabe9a422285fe604a18765f18.png"><br><br>  In general, the expected result is the presence of the hypervisor and the absence of the virtualization flag in the first stage and the presence of the virtualization flag in the second.  As a result, we have this solution. <br><br><img src="https://habrastorage.org/files/63f/5a1/f70/63f5a1f7060748c586380b7325fce0fe.png"><br><br><h1>  Settings and restrictions </h1><br>  Now let's talk about some of the limitations of this technology in TP4 for enabled embedded virtualization at the first level of the virtual machine: <br><ul><li>  Support has been implemented so far only for Intel processors with EPT support (SLAT). </li><li>  Dynamic memory must be disabled. </li><li>  Changing the size of the memory leads to errors. </li><li>  Snapshots on a running virtual machine are not allowed. </li><li>  Live migration leads to errors. </li><li>  Saving, restoring may lead to errors. </li><li>  You need to enable MAC spoofing in the properties of the network adapter. </li></ul><br>  Step by step instruction looks like this: <br><ol><li>  Install the assembly on a physical host with virtualization options enabled. </li><li>  Create a virtual machine in which we will enable virtualization.  It is advisable to allocate this machine at least 4GB of RAM, otherwise you need to tweak the script.  <b>The virtual machine must be turned off!</b> </li><li>  Run the script on the physical host, specifying the name of the previously created virtual machine.  The link to the script is at the end of the article. </li><li>  We include the Hyper-V role in the virtual machine. </li><li>  Create a new virtual machine using the Hyper-V manager in the previously created virtual machine. </li></ol><br>  As a result, we have a solution that will allow you to do many things on one physical host.  For example, a cluster assembled from Hyper-V hosts, which will reduce the amount of equipment used, both at home and in classrooms. <br><br><h1>  Resources </h1><br>  <a href="https://technet.microsoft.com/ru-ru/evalcenter/dn781243.aspx">Windows Server Technical Preview</a> <br>  <a href="http://blogs.technet.com/b/virtualization/archive/2015/10/13/windows-insider-preview-nested-virtualization.aspx">Announcement of support for nested virtualization from the product group (eng.)</a> <br>  <a href="https://technet.microsoft.com/en-us/sysinternals/cc835722.aspx">Link to CoreInfo utility</a> <br>  <a href="">Link to the script on GitHub</a> <br><br>  Thanks for attention, <br>  Mikhail Komarov <br>  MVP - Cloud and Datacenter Management </div><p>Source: <a href="https://habr.com/ru/post/273791/">https://habr.com/ru/post/273791/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273775/index.html">The design decision is made by the designer.</a></li>
<li><a href="../273777/index.html">How to run your own torrent search engine based on RuTracker?</a></li>
<li><a href="../273779/index.html">CLI for MarionetteJS</a></li>
<li><a href="../273783/index.html">Non-standard city for non-standard people: a guide to the architecture of Innopolis</a></li>
<li><a href="../273785/index.html">RHCSA certification: preparation and delivery experience</a></li>
<li><a href="../273793/index.html">SID change during cloning and mass deployment</a></li>
<li><a href="../273795/index.html">Creating a website. Course young fighter</a></li>
<li><a href="../273797/index.html">How we made Rich Text Editor with support for co-editing under Android</a></li>
<li><a href="../273799/index.html">New Year Promotion for HPE ProLiant Gen9 Servers</a></li>
<li><a href="../273801/index.html">A new version of LinqTestable has been released - libraries for testing requests to the database via ORM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>