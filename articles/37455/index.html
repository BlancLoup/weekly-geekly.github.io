<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DMA for beginners or what you need to know</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone, today we will talk about DMA: about the technology that helps your computer play music for you, display an image on the screen, record...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DMA for beginners or what you need to know</h1><div class="post__text post__text-html js-mediator-article">  Hello everyone, today we will talk about DMA: about the technology that helps your computer play music for you, display an image on the screen, record information on a hard disk, and at the same time provide a meager load to the central processor. <a name="habracut"></a><br><br><h2>  DMA, what is it?  What are you talking about? </h2>  DMA, or Direct Memory Access is a direct memory access technology, bypassing the central processor.  In the era of the 486th and the first Pentium, the ISA bus reigned throughout, as well as the PIO (Programmed Input / Output) data exchange method between devices. <br><br>  PIO is inherently simple: to get data from a device, the operating system driver (or the firmware of another device) had to read this data from the device registers.  Let's look at an example: <ul><li>  1500 data bytes came to the network card. </li><li>  The network card initiates an interrupt in order to inform the processor that the data must be collected from the device, otherwise a so-called buffer overrun will occur. </li><li>  The operating system catches the interrupt from the interrupt controller and gives it to the driver for processing. </li><li>  The driver in a cycle reads the data from the network card registers byte-by-byte. </li></ul><br>  As a result, if reading one byte takes about 1 ms of processor time, then reading 1,500 bytes is 1,500 ms, respectively.  But this is just one Ethernet packet, imagine how many packets a network card receives when you read your favorite habrahabr.  Of course, in reality, reading in PIO mode can be organized by 2, 4 bytes, but performance losses will still be catastrophic. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When the volumes of data with which the processor operates began to increase, it became clear that it was necessary to minimize the participation of the processor in the data exchange chain, otherwise it would be difficult.  And here then the technology of direct access to memory found active application. <br><br>  By the way, DMA is used not only for data exchange between the device and RAM, but also between devices in the system, DMA transfer is possible between two sections of RAM (although this maneuver is not applicable to x86 architecture).  Also in its Cell processor, IBM uses DMA as the primary mechanism for exchanging data between synergistic processor elements (SPE) and central processing element (PPE).  Also, each SPE and PPE can exchange data via DMA with RAM.  This technique is in fact a great advantage of Cell, because it eliminates the problems of cache coherence in multiprocessing data processing. <br><br><h2>  And again the theory </h2>  Before we move on to practice, I would like to highlight several important aspects of programming PCI, PCI-E devices. <br><br>  I casually mentioned the device registers, but how does the CPU have access to them?  As many of you know, there is such an entity in computer technology as IO ports (Input / Output ports).  They are designed to exchange information between the central processor and peripheral devices, and access to them is possible with the help of special assembly instructions - in / out.  The BIOS (or OpenFirmware on PPC based systems) in the early stages of PCI device initialization, as well as some others (Super IO controller, PS / 2 controller, ACPI timer, etc.) assigns its own IO port range to a specific controller, where and the device registers are displayed. <br><br>  Also, device registers can be displayed in RAM (Memory Mapped Registers), i.e.  to the physical address space.  This method has several advantages, namely: <ul><li>  The access speed to physical memory is higher than to IO ports. </li><li>  IO ports can display no more than 65535 bytes of registers, while the size of the RAM of modern computers is many times larger. </li><li>  Reading device registers from RAM is easier than using IO ports :) </li></ul><br>  Data on which range of IO ports or RAM is assigned to the device is stored in the PCI configuration space, namely, in the registers BAR0, BAR1, BAR2, BAR4, BAR5 [1]. <br><br>  So, there are two DMA disposal methods: contiguous DMA and scatter / gather DMA. <br><br><h2>  Contiguous dma </h2>  This method is very simple and is now almost outlived, however, it is still used to program sound controllers (for example, Envy24HT).  Its principle is as follows: <ul><li>  One buffer is allocated large enough in RAM. </li><li>  The physical address (more precisely, the address on the memory bus, because the physical address and bus address are equal in the x86 architecture, but not equal in the PPC) of this buffer is written to the device register. </li><li>  As data arrives at the device, the device controller initiates a DMA transfer. </li><li>  After the buffer is full, the device controller initiates an interrupt to inform the CPU that the buffer should be transferred to the operating system. </li><li>  The operating system driver processes the interrupt and transfers the received data from the buffer, then through the stack of the operating system devices. </li></ul><br>  As you can see, everything is quite simple, and as soon as the ISA bus acquired DMA support, this method was widely used.  For example, network card drivers had two such DMA buffers: one to receive data (rx), the other to send (tx). <br><br><h2>  Scatter / gather DMA </h2>  With the increasing speed of Ethernet adapters, contiguous DMA has shown its inconsistency.  Mainly due to the fact that the required memory areas are large enough, which sometimes could not be identified, as in modern systems, the fragmentation of physical memory is quite high.  The mechanism of virtual memory is to blame for everything, without which nowadays is nowhere :) <br><br>  The decision suggests itself: to use several instead of one large chunk of memory, but in different regions of this very memory.  The question arises, but how to inform the device controller, how to initiate a DMA transfer and at what address to write data?  And then we found a solution to use descriptors to describe each such section in RAM. <br><br>  A typical DMA buffer descriptor contains the following fields: <ol><li>  The address of the section of RAM (bus address), which is intended for DMA transfer. </li><li>  The size of the described area of ‚Äã‚ÄãRAM. </li><li>  Optional flags and other specific arguments. </li><li>  The address of the next handle in memory. </li></ol><br>  The structure of the descriptors is determined by the specific manufacturer of the device controller, and may contain any other fields.  The descriptor, like the DMA buffer, is located in RAM. <br><br>  The scatter / gather DMA algorithm is as follows: <ul><li>  The operating system driver allocates and initializes DMA buffer descriptors. </li><li>  The driver allocates DMA buffers (portions of RAM for DMA transfer) and writes the necessary information about them into descriptors. </li><li>  The device, as the need arises, fills the DMA buffers, and after filling one or more buffers, initiates an interrupt. </li><li>  The OS driver scans all DMA buffer descriptors, determines which ones have been filled by the device controller, forwards the data from the buffer further down the device stack and marks the buffer as ready for DMA transfer. </li></ul><br>  The order in which the device controller fills the DMA buffers is determined by the manufacturer.  The controller can write to the first free DMA buffer, or simply write in a row (DMA buffer descriptors in this case form a simply connected ring list) to all buffers, etc. <br><br><h2>  Stop... </h2>  For today, perhaps all, otherwise the information will be too much.  In the next article, I will show you how IOKit works with this street magic.  Waiting for feedback and additions;) <br><br><h2>  Links </h2>  <a href="http://www.ece.mtu.edu/faculty/btdavis/courses/mtu_ee3173_f04/papers/PCI_22.pdf">[1]</a> PCI Local Bus Specification </div><p>Source: <a href="https://habr.com/ru/post/37455/">https://habr.com/ru/post/37455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../37454/index.html">Investor Answers</a></li>
<li><a href="../374541/index.html">Russian citizen requires the court to charge Google 50,000 rubles for reading his emails</a></li>
<li><a href="../374545/index.html">Paradoxes, the solution of which can change our view of the Universe</a></li>
<li><a href="../374547/index.html">YouTube has enabled HTML5 by default.</a></li>
<li><a href="../374549/index.html">Cubans created island intranets, despite government bans</a></li>
<li><a href="../374551/index.html">Youtube blocked by the Ministry of Justice of the Russian Federation</a></li>
<li><a href="../374555/index.html">Bike thieves search for victims with the help of social networks</a></li>
<li><a href="../374557/index.html">Librem 15, fully open laptop with adequate features</a></li>
<li><a href="../374559/index.html">Mozilla launches 12 Tor intermediate nodes using its servers</a></li>
<li><a href="../37456/index.html">SATA Rev 3 - faster than SATA 1 and SATA 2 combined</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>