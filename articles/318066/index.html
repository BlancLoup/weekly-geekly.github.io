<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multi-Tale of Lost Time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the publication The Tale of Lost Time, user crea7or told how he refuted the Euler Hypothesis on a modern CPU. 

 I was also interested to know how ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multi-Tale of Lost Time</h1><div class="post__text post__text-html js-mediator-article">  In the publication <a href="https://habrahabr.ru/post/317588/">The Tale of Lost Time,</a> user <a href="https://habrahabr.ru/users/crea7or/" class="user_link">crea7or</a> told how he refuted the <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%25B8%25D0%25BF%25D0%25BE%25D1%2582%25D0%25B5%25D0%25B7%25D0%25B0_%25D0%25AD%25D0%25B9%25D0%25BB%25D0%25B5%25D1%2580%25D0%25B0">Euler Hypothesis</a> on a modern CPU. <br><br>  I was also interested to know how the GPU will show itself, and I compared the single-threaded code with the multi-threaded for the CPU and the completely multi-threaded for the GPU, using the <a href="http://www.nvidia.ru/object/cuda-parallel-computing-ru.html">CUDA</a> parallel computing architecture. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Iron and compilers</b> <div class="spoiler_text">  CPU <a href="http://ark.intel.com/products/75038/Intel-Core-i5-4440-Processor-6M-Cache-up-to-3_30-GHz">Core i5 4440</a> <br>  GPU <a href="http://www.nvidia.ru/object/geforce-gtx-770-ru">GeForce GTX 770</a> <br>  <a href="https://www.microsoft.com/ru-ru/download/details.aspx%3Fid%3D48146">MSVS 2015 update 3</a> <br>  <a href="http://www.nvidia.ru/object/cuda-parallel-computing-ru.html">tookit CUDA 8</a> . <br>  Of course, the build was <b>release</b> and 64 bit, with optimization / 02 and / LTCG. <br><div class="spoiler">  <b class="spoiler_title">Disable video adapter reset</b> <div class="spoiler_text">  Since the calculations last more than two seconds, the video driver completes the CUDA program.  To prevent this from happening, you need to specify a sufficient time before resetting through the registry key. <br>  HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Control \ GraphicsDrivers \ TdrDelay and restart the computer. <br></div></div><br></div></div><br><h3>  CPU </h3><br>  For a start, I parallelized the <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">algorithm</a> for the CPU.  For this, the function is passed a range for iterating over the values ‚Äã‚Äãof the outer loop <b>a</b> .  Then the whole range of 1..N is broken into pieces and fed to the processor cores. <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Algorithm_1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> N, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">vector</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;&amp; powers, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> from, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> to)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> a = from; a &lt; to; ++a) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> b = <span class="hljs-number"><span class="hljs-number">1</span></span>; b &lt; a; ++b) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> c = <span class="hljs-number"><span class="hljs-number">1</span></span>; c &lt; b; ++c) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> d = <span class="hljs-number"><span class="hljs-number">1</span></span>; d &lt; c; ++d) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> sum = powers[a] + powers[b] + powers[c] + powers[d]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::binary_search(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::begin(powers), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::end(powers), sum)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> it = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::lower_bound(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::begin(powers), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::end(powers), sum); <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> e = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>&gt;(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::distance(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::begin(powers), it)); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; a &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; b &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; c &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; d &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; e &lt;&lt; <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } } } } } }</code> </pre> <br>  In my case, there were 4 cores, and I performed the calculations through a slightly modified thread pool, which I used as the basis <a href="">here</a> .  Since there are no dependencies between the data, the speed increases almost in proportion to the number of cores. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  GPU </h3><br>  For a GPU it is a little more difficult.  The outer two cycles of searching ( <b>a</b> and <b>b</b> ) will be expanded, and in the function there will be only a search of two internal cycles ( <b>c</b> and <b>d</b> ).  One can imagine that the program will be executed in parallel for all values <b>a</b> = 1..N and <b>b</b> = 1..N.  In fact, of course, this is not the case; they will not be able to execute everything in parallel at the same time, but this is CUDA‚Äôs concern to parallelize the implementation as much as possible, this can be helped if the configuration of blocks and streams is properly configured. <br><br><div class="spoiler">  <b class="spoiler_title">Blocks and threads</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> blocks_x = N; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> threads = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::min(<span class="hljs-number"><span class="hljs-number">1024</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(N)); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> blocks_y = (N + threads - <span class="hljs-number"><span class="hljs-number">1</span></span>) / threads; <span class="hljs-function"><span class="hljs-function">dim3 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">grid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(blocks_x, blocks_y)</span></span></span></span>; NaiveGPUKernel&lt;&lt;&lt;grid, threads&gt;&gt;&gt;(N);</code> </pre><br>  <b>blocks_x</b> is the enumeration range of the first cycle <b>a</b> . <br>  But going through the second cycle <b>b</b> had to be made more difficult due to the video card restriction on the number of threads (1024), and put the counter simultaneously in <b>threads</b> and <b>blocks_y</b> : <br>  <b>a</b> and <b>b is</b> calculated as: <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = blockIdx.x + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = threadIdx.x + blockIdx.y * blockDim.x + <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  This is definitely not the optimal configuration, as it turns out a lot of idle cycles.  But I did not begin to adjust the values ‚Äã‚Äãfurther. <br></div></div><br>  The code for the GPU is quite straightforward and very similar to the CPU, only the binary search has to be done by hand. <br><br><pre> <code class="cpp hljs">__constant__ <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> gpu_powers[<span class="hljs-number"><span class="hljs-number">8192</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> __<span class="hljs-function"><span class="hljs-function">device__ </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpu_binary_search</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> N, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> search)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> l = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> r = elements_count - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> m; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (l &lt;= r) { m = (l + r) / <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (search &lt; gpu_powers[m]) r = m - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (search &gt; gpu_powers[m]) l = m + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> l; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } __<span class="hljs-function"><span class="hljs-function">global__ </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NaiveGPUKernel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> N)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = blockIdx.x + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = threadIdx.x + blockIdx.y * blockDim.x + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (b &gt;= a) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> c = <span class="hljs-number"><span class="hljs-number">1</span></span>; c &lt; b; ++c) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> d = <span class="hljs-number"><span class="hljs-number">1</span></span>; d &lt; c; ++d) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> sum = gpu_powers[a] + gpu_powers[b] + gpu_powers[c] + gpu_powers[d]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> s = gpu_binary_search(N, sum); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%d %d %d %d %d\n"</span></span>, a, b, c, d, s); } } } }</code> </pre><br>  I also implemented the optimizations suggested <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">here</a> . <br><br><h3>  Speed ‚Äã‚Äãmeasurement </h3><br>  The measurements for the CPU were done two times, since they turned out to be much more stable than the GPU, which I have already done seven and selected the best time.  The variation for the GPU could be twofold, I explain this by the fact that the only video adapter in the system was used for CUDA calculations. <br><table><tbody><tr><th></th><th>  N </th><th>  CPU time, ms </th><th>  CPU (4 threads) time, ms </th><th>  GPU time, ms </th></tr><tr><td>  <a href="https://habrahabr.ru/post/317588/">@antonkrechetov</a> </td><td>  100 </td><td align="right">  58.6 </td><td align="right">  16.7 </td><td align="right">  14.8 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Base</a> </td><td>  100 </td><td align="right">  45.3 </td><td align="right">  13.0 </td><td align="right">  10.7 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic optimization # 1</a> </td><td>  100 </td><td align="right">  6.3 </td><td align="right">  2.1 </td><td align="right">  12.7 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  100 </td><td align="right">  1.4 </td><td align="right">  0.7 </td><td align="right">  0.8 </td></tr><tr><td>  <a href="https://habrahabr.ru/post/317588/">@antonkrechetov</a> </td><td>  250 </td><td align="right">  2999.7 </td><td align="right">  782.9 </td><td align="right">  119.0 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Base</a> </td><td>  250 </td><td align="right">  2055.6 </td><td align="right">  550.1 </td><td align="right">  90.9 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic optimization # 1</a> </td><td>  250 </td><td align="right">  227.2 </td><td align="right">  60.3 </td><td align="right">  109.2 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  250 </td><td align="right">  42.9 </td><td align="right">  11.9 </td><td align="right">  6.0 </td></tr><tr><td>  <a href="https://habrahabr.ru/post/317588/">@antonkrechetov</a> </td><td>  500 </td><td align="right">  72034.2 </td><td align="right">  19344.1 </td><td align="right">  1725.83 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Base</a> </td><td>  500 </td><td align="right">  38219.7 </td><td align="right">  10200.8 </td><td align="right">  976.7 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic optimization # 1</a> </td><td>  500 </td><td align="right">  3725.1 </td><td align="right">  926.5 </td><td align="right">  1140.36 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  500 </td><td align="right">  630.7 </td><td align="right">  170.2 </td><td align="right">  48.7 </td></tr><tr><td>  <a href="https://habrahabr.ru/post/317588/">@antonkrechetov</a> </td><td>  750 </td><td align="right">  396566.0 </td><td align="right">  105003.0 </td><td align="right">  11521.2 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Base</a> </td><td>  750 </td><td align="right">  218615.0 </td><td align="right">  57639.2 </td><td align="right">  5742.5 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic optimization # 1</a> </td><td>  750 </td><td align="right">  19082.7 </td><td align="right">  4736.8 </td><td align="right">  6402.1 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  750 </td><td align="right">  3272.0 </td><td align="right">  846.9 </td><td align="right">  222.9 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  1000 </td><td align="right">  10204.4 </td><td align="right">  2730.3 </td><td align="right">  1041.9 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  1250 </td><td align="right">  25133.1 </td><td align="right">  6515.3 </td><td align="right">  2445.5 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  1500 </td><td align="right">  51940.1 </td><td align="right">  14005.0 </td><td align="right">  4895.2 </td></tr></tbody></table><br><h3>  And now give a little adrenaline to the CPU! </h3><br>  And this adrenaline is <a href="https://ru.wikipedia.org/wiki/Profile-guided_optimization">Profile-guided optimization</a> . <br><br>  For PGO, I cite only CPU time, because the GPU has changed little, and this is expected. <br><table><tbody><tr><th></th><th>  N </th><th>  CPU <br>  time, ms </th><th>  CPU (4 threads) <br>  time, ms </th><th>  CPU + PGO <br>  time, ms </th><th>  CPU + PGO <br>  (4 threads) <br>  time, ms </th></tr><tr><td>  <a href="https://habrahabr.ru/post/317588/">@antonkrechetov</a> </td><td>  100 </td><td align="right">  58.6 </td><td align="right">  16.7 </td><td align="right">  55.3 </td><td align="right">  15.0 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Base</a> </td><td>  100 </td><td align="right">  45.3 </td><td align="right">  13.0 </td><td align="right">  42.2 </td><td align="right">  12.1 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic optimization # 1</a> </td><td>  100 </td><td align="right">  6.3 </td><td align="right">  2.1 </td><td align="right">  5.2 </td><td align="right">  1.9 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  100 </td><td align="right">  1.4 </td><td align="right">  0.7 </td><td align="right">  1.3 </td><td align="right">  0.8 </td></tr><tr><td>  <a href="https://habrahabr.ru/post/317588/">@antonkrechetov</a> </td><td>  250 </td><td align="right">  2999.7 </td><td align="right">  782.9 </td><td align="right">  2966.1 </td><td align="right">  774.1 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Base</a> </td><td>  250 </td><td align="right">  2055.6 </td><td align="right">  550.1 </td><td align="right">  2050.2 </td><td align="right">  544.6 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic optimization # 1</a> </td><td>  250 </td><td align="right">  227.2 </td><td align="right">  60.3 </td><td align="right">  200.0 </td><td align="right">  53.2 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  250 </td><td align="right">  42.9 </td><td align="right">  11.9 </td><td align="right">  40.4 </td><td align="right">  11.4 </td></tr><tr><td>  <a href="https://habrahabr.ru/post/317588/">@antonkrechetov</a> </td><td>  500 </td><td align="right">  72034.2 </td><td align="right">  19344.1 </td><td align="right">  68662.8 </td><td align="right">  17959.0 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Base</a> </td><td>  500 </td><td align="right">  38219.7 </td><td align="right">  10200.8 </td><td align="right">  38077.7 </td><td align="right">  10034.0 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic optimization # 1</a> </td><td>  500 </td><td align="right">  3725.1 </td><td align="right">  926.5 </td><td align="right">  3132.9 </td><td align="right">  822.2 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  500 </td><td align="right">  630.7 </td><td align="right">  170.2 </td><td align="right">  618.1 </td><td align="right">  160.6 </td></tr><tr><td>  <a href="https://habrahabr.ru/post/317588/">@antonkrechetov</a> </td><td>  750 </td><td align="right">  396566.0 </td><td align="right">  105003.0 </td><td align="right">  404692.0 </td><td align="right">  103602.0 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Base</a> </td><td>  750 </td><td align="right">  218615.0 </td><td align="right">  57639.2 </td><td align="right">  207975.0 </td><td align="right">  54868.2 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic optimization # 1</a> </td><td>  750 </td><td align="right">  19082.7 </td><td align="right">  4736.8 </td><td align="right">  15496.4 </td><td align="right">  4082.3 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  750 </td><td align="right">  3272.0 </td><td align="right">  846.9 </td><td align="right">  3093.8 </td><td align="right">  812.7 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  1000 </td><td align="right">  10204.4 </td><td align="right">  2730.3 </td><td align="right">  9781.6 </td><td align="right">  2565.9 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  1250 </td><td align="right">  25133.1 </td><td align="right">  6515.3 </td><td align="right">  23704.3 </td><td align="right">  6244.1 </td></tr><tr><td>  <a href="http://rosettacode.org/wiki/Euler%2527s_sum_of_powers_conjecture">Basic Optimization # 2</a> </td><td>  1500 </td><td align="right">  51940.1 </td><td align="right">  14005.0 </td><td align="right">  48717.5 </td><td align="right">  12793.5 </td></tr></tbody></table><br>  It can be seen that PGO was able to accelerate optimization # 1 by as much as 18%, for the rest the increase was more modest. <br><br><h3>  Dragons are found here </h3><br>  Forgot to mention a funny feature.  At first I searched for the first solution, and set return immediately after printf.  So it reduced productivity by an order of magnitude.  When I began to look for all the solutions, the performance jumped sharply upwards. <br><pre> <code class="cpp hljs">__<span class="hljs-function"><span class="hljs-function">global__ </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NaiveGPUKernel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> N)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = blockIdx.x + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = threadIdx.x + blockIdx.y * blockDim.x + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (b &gt;= a) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> c = <span class="hljs-number"><span class="hljs-number">1</span></span>; c &lt; b; ++c) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> d = <span class="hljs-number"><span class="hljs-number">1</span></span>; d &lt; c; ++d) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> sum = gpu_powers[a] + gpu_powers[b] + gpu_powers[c] + gpu_powers[d]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> s = gpu_binary_search(N, sum); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%d %d %d %d %d\n"</span></span>, a, b, c, d, s); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; &lt;-      } } } }</code> </pre><br><br><h3>  What else can you do </h3><br>  For the CPU, try to expand the cycles, count two numbers at a time, use vector processor commands. <br><br>  For the GPU to play with the order of calculations, try to save on registers, it is better to choose the parameters of the blocks and threads. <br><br><h3>  findings </h3><br>  1. Writing on CUDA is easy. <br>  2. Without tricks, the straight-line code on CUDA turned out to be 10 times faster than the CPU implementation. <br>  3. In the number of crushed tasks, the GPU is much faster than the CPU for the same money. <br>  4. The GPU takes a lot of time to "swing" and for very short tasks acceleration may not be. <br>  5. A more complex algorithm may be faster for the CPU, but slower for the GPU. <br>  6. Profile optimization speeds up code well and reduces file size simultaneously. <br><br><h3>  Sources </h3><br>  Traditionally you can touch the code on <a href="https://github.com/drbasic/EulerSum">github</a> </div><p>Source: <a href="https://habr.com/ru/post/318066/">https://habr.com/ru/post/318066/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318052/index.html">"Corporate" backup for nothing (on the network of home media players)</a></li>
<li><a href="../318054/index.html">RFC prototype HTTP status codes for developer errors (range 7XX)</a></li>
<li><a href="../318056/index.html">We calculate content that will become viral in the future.</a></li>
<li><a href="../318058/index.html">Convert data presentation form using Excel + PowerQuery</a></li>
<li><a href="../318060/index.html">Google has introduced a test suite Wycheproof</a></li>
<li><a href="../318068/index.html">10 things that must be done after registration Ltd.</a></li>
<li><a href="../318070/index.html">The enemy is inside: we invite hackers and speakers on PHDays VII</a></li>
<li><a href="../318072/index.html">Publishing Desktop Applications in Windows Store using Desktop Application Converter</a></li>
<li><a href="../318074/index.html">The results of GeekWeek 2016 and the return of the terrible BAG: Winter with GeekBrains</a></li>
<li><a href="../318078/index.html">The best free applications for customization and design of Windows 10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>