<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic installation and configuration of PostgreSQL using Wix #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! 

 Due to the complexity of the project I'm working on, there is a need to deploy and configure PostgreSQL on each client machine. Our compan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic installation and configuration of PostgreSQL using Wix #</h1><div class="post__text post__text-html js-mediator-article">  Hi Habr! <br><br>  Due to the complexity of the project I'm working on, there is a need to deploy and configure PostgreSQL on each client machine.  Our company has a lot of customers, so it was decided to automate the process of setting up PostgreSQL and create an MSI installer. <br><br>  Recently, at Habr√©, I read the translated article about Wix #, and it will be discussed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  As already mentioned in the <a href="http://habrahabr.ru/post/253819/">article</a> , Wix # is part of the open source engine that allows you to execute C # scripts. <br>  After <a href="https://wixsharp.codeplex.com/">downloading</a> Wix #, you can find many examples in the archive, starting with simple file copying and creating shortcuts on your desktop and ending with your own installer dialogs on WPF. <br><br>  <b>The task is as follows</b> : <br><br>  We will not dwell on the first two paragraphs; everything is in the examples.  To configure the DBMS, you need to replace the pg_hba.conf file, import the database from the saved copy.  All this needs to be done without the participation of the user running the installer. <br><br>  First of all we create a simple installer to deploy the project.  Then I will tell you how to make such an installer using the example of Visual Studio, although this is not necessary at all - you can use any text editor. <br><br>  We create a simple console application in C #, <br>  and install for the WixSharp solution through the NuGet project manager. <br><br>  Before installation, the user is usually offered several components to choose from, in Wix # there is a <b>Feature</b> object for this. <br><br>  Create components to install, <br><br><pre><code class="cs hljs">Feature fSoftware = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Feature(<span class="hljs-string"><span class="hljs-string">"&lt; &gt;"</span></span>); Feature fPostgreSQL = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Feature(<span class="hljs-string"><span class="hljs-string">" PostgreSQL"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//       , // ,      ,   fSoftware.Description = "  "; fPostgreSQL.Description = "   PostgreSQL";</span></span></code> </pre> <br><br>  In Wix # there are different objects for building projects, for example, Project or ManagedProject.  The latter is different in that you can add your own C # code to it, which will be executed during the installation process. <br><br>  Define the directory where the files included in the installer package will be located. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filesPath =Path.Combine( Path.GetFullPath( Path.Combine(System.Reflection.Assembly .GetExecutingAssembly().Location, <span class="hljs-string"><span class="hljs-string">@"..\..\..\"</span></span>)), <span class="hljs-string"><span class="hljs-string">"Files"</span></span>);</code> </pre><br><br>  Create a project object and describe the necessary files for installation. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> project = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ManagedProject(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-comment"><span class="hljs-comment">// Id  ,    //   Custom Actions   new Dir(new Id("INSTALL_DIR"), @"%ProgramFiles%\&lt; &gt;", //         new Files(fSoftware, Path.Combine( filesPath, @"&lt;    &gt;\*.*"))), // PostgreSQL     :\PostgreSQL // (   ) //          new Dir("C:\PostgreSQL", //   new WixSharp.File(fServer, Path.Combine(filesPath, @"postgresqlwin.exe")), //   new WixSharp.File(fServer, Path.Combine(filesPath, @"database.backup")), //   new WixSharp.File(fServer, Path.Combine(filesPath, @"pg_hba.conf")), // BAT- ( ) new WixSharp.File(fServer, Path.Combine(filesPath, @"installDB.bat"))) );</span></span></code> </pre><br><br>  In order to perform various actions after or during installation in Wix # there are rich possibilities - for example, if you need to install a ReportViewer, then you should add to the project body: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InstalledFileAction(<span class="hljs-string"><span class="hljs-string">"ReportViewer.exe"</span></span>, <span class="hljs-string"><span class="hljs-string">"/q"</span></span>, Return.asyncNoWait, When.After, Step.InstallFinalize, Condition.NOT_Installed)</code> </pre><br><br>  To install and configure PostgreSQL, you can also use InstalledFileAction and others, but because of the many commands that need to be executed, it is decided to make the <b>InstallDB.bat</b> BAT file: <br><br><pre> <code class="dos hljs">#       PostgreSQL <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> PGPASSWORD=<span class="hljs-number"><span class="hljs-number">123456</span></span> #    C:\PostgreSQL\bin\createdb.exe --host localhost --port <span class="hljs-number"><span class="hljs-number">5432</span></span> --username "postgres" --no-password &lt;  &gt; #   C:\PostgreSQL\bin\pg_restore.exe --host localhost --port <span class="hljs-number"><span class="hljs-number">5432</span></span> --username "postgres" --dbname "  " --role "postgres" --no-password --verbose "C:\PostgreSQL\database.backup"</code> </pre><br><br>  Next, the project must be configured: <br><br><pre> <code class="cs hljs"> project.ControlPanelInfo.Manufacturer = <span class="hljs-string"><span class="hljs-string">"&lt;  &gt;"</span></span>; project.GUID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Guid(<span class="hljs-string"><span class="hljs-string">"{F1CC4E21-0326-4107-BB5C-A834EAEF6DAE}"</span></span>); project.LicenceFile = Path.Combine(filesPath, <span class="hljs-string"><span class="hljs-string">@"License.rtf"</span></span>); project.UI = WUI.WixUI_Mondo; project.Language = <span class="hljs-string"><span class="hljs-string">"ru-RU"</span></span>; project.OutFileName = <span class="hljs-string"><span class="hljs-string">"SetUp"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   .Net Framework 4.0 project.SetNetFxPrerequisite("NETFRAMEWORK40FULL &gt;= '#1'", ",  .NET Framework 4.0."); project.PreserveTempFiles = true; project.DefaultFeature = fSoftware; project.Version = new Version("1.0.0.1"); project.AfterInstall += AfterInstall; Compiler.BuildMsi(project);</span></span></code> </pre><br><br>  Now for the AfterInstall event, you can write a Custom Action to start the installation and configuration of PostgreSQL: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AfterInstall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SetupEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((e.Mode == SetupEventArgs.SetupMode.Installing) || (e.Mode == SetupEventArgs.SetupMode.Modifying)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (System.IO.File.Exists(<span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\postgresqlwin.exe"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> process = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Process(); process.StartInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProcessStartInfo(<span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\postgresqlwin.exe"</span></span>, <span class="hljs-string"><span class="hljs-string">@"--prefix C:\PostgreSQL --mode unattended --datadir C:\PostgreSQL\data --superpassword 123456 --install_runtimes 0"</span></span>); process.Start(); process.WaitForExit(); System.IO.File.Delete(<span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\postgresqlwin.exe"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (System.IO.File.Exists(<span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\pg_hba.conf"</span></span>)) { System.IO.File.Copy(<span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\pg_hba.conf"</span></span>, <span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\data\pg_hba.conf"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); System.IO.File.Delete(<span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\pg_hba.conf"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (System.IO.File.Exists(<span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\database.backup"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (System.IO.File.Exists(<span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\installDB.bat"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pgProcess = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Process(); pgProcess.StartInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProcessStartInfo(<span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\installDB.bat"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) { CreateNoWindow = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, UseShellExecute = <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; pgProcess.Start(); pgProcess.WaitForExit(); System.IO.File.Delete(<span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\installDB.bat"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; System.IO.File.Delete(<span class="hljs-string"><span class="hljs-string">@"C:\PostgreSQL\database.backup"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { System.Windows.MessageBox.Show(<span class="hljs-string"><span class="hljs-string">"  : "</span></span> + ex.ToString()); } }</code> </pre><br><br>  Alternatively, one could copy the PostgreSQL installer to a temporary folder and start the installation from it. <br><br>  With these simple steps, PostgreSQL will automatically be configured for your software. <br><br>  However, there are moments that in Wix # I didn‚Äôt like: <br>  1) Support only .NET Framework 3.5 <br>  2) Generally in Wix - it is impossible to start the MSI installer from your installer, for this you need to use WIX extensions, which complicates the task.  That is why ReportViewer had to be installed after the installation was completed. <br>  3) Why is there a problem with this code: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dir(<span class="hljs-string"><span class="hljs-string">@"C:\Test1"</span></span>, ..), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dir(<span class="hljs-string"><span class="hljs-string">@"C:\Test2"</span></span>, ..)</code> </pre><br>  Not going, an error about an invalid path is displayed.  If you leave only one folder, then everything works. <br><br>  The following code works, but partially: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dir(<span class="hljs-string"><span class="hljs-string">@"C:\Test"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dir(<span class="hljs-string"><span class="hljs-string">@"Test1"</span></span>,   feature1), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dir(<span class="hljs-string"><span class="hljs-string">@"Test2"</span></span>,   feature2), )</code> </pre><br><br>  The idea is that the files Test1 and Test2 should be copied to the files, which is what happens if during installation you select feature1 and feature2. <br>  And if during installation you select only feature1 and then add feature2 (Change installation), then the Test2 folder does not appear - instead it will be ABSOLUTEPATH folder with files for feature2. <br>  Surely in my script something was not taken into account. <br><br>  In general, I liked Wix #, especially if you need to quickly make an installer without diving into XML for WIX. <br><br>  Sources: <br><ol><li>  <a href="http://habrahabr.ru/post/253819/">Translation article about Wix #</a> </li><li>  <a href="https://wixsharp.codeplex.com/wikipage%3Ftitle%3DBuilding%2520MSI%2520with%2520WixSharp%2520%25E2%2580%2593%2520Step%2520by%2520step%2520tutorial">Step-by-step instructions for setting up various development tools for Wix #</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/276175/">https://habr.com/ru/post/276175/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276159/index.html">Real-Time Games and Cross Domain Connection</a></li>
<li><a href="../276163/index.html">Migrating data from various types of storage using EMC VPLEX and EMC RecoverPoint technologies</a></li>
<li><a href="../276165/index.html">C ++ Game State Management</a></li>
<li><a href="../276169/index.html">Report on the fourth UX conference of the Russian school of service design</a></li>
<li><a href="../276171/index.html">Break Windows to fix it: ‚ÄúSeveral attempts were made, but the cause of the problem could not be determined‚Äù</a></li>
<li><a href="../276179/index.html">WLAN architecture: what to choose?</a></li>
<li><a href="../276185/index.html">XAML Developer Chips: Embedded Converters</a></li>
<li><a href="../276187/index.html">We are implementing an analogue of Apple iCloud Voicemail using free grammars from Yandex</a></li>
<li><a href="../276189/index.html">Moxy - MVP implementation for Android with a pinch of magic</a></li>
<li><a href="../276193/index.html">Finite Volume method - implementation on the example of thermal conductivity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>