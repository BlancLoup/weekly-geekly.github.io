<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>50 shades of stub * Hardware reception of PWM-coded signals by Microchip microcontrollers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="* POI - Peripheral Independent of the Core in Microchip microcontrollers, also known as CIP - Core Independent Peripheral. 

 Part 4 
 Previous articl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>50 shades of stub * Hardware reception of PWM-coded signals by Microchip microcontrollers</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/344/eea/f79/344eeaf79b9a424fb5c5272f4506a24f.JPG" width="300"></div><br>  * POI - Peripheral Independent of the Core in Microchip microcontrollers, also known as CIP - Core Independent Peripheral. <br><br><h1>  Part 4 </h1><br>  Previous articles [ <a href="https://geektimes.ru/post/278718">1</a> ], [ <a href="https://geektimes.ru/post/279374/">2</a> ] and [ <a href="https://geektimes.ru/post/280224/">3</a> ] dealt with the Microchip Microcontroller Independent Kernels (PND) Peripherals: configurable logic cells, input / output ports with current limiting function and ADC with a calculator; some possibilities of such peripherals were shown.  Let me remind you that independence is not implied on the type of PIC core of microcontrollers (BaseLine, Mid-Range, Enhanced Mid-Range, PIC18, 16-, 32-bit), but on the operation of the core, i.e.  independent execution of tasks assigned to the periphery from the state of the CPU.  Such peripherals, and in particular the possibility of configuring it for collaboration and the synthesis of hardware functions, are designed to relieve the software part and reduce power consumption. <br><br>  In this small article I want to show examples of the implementation of the reception of ‚Äúcustom‚Äù, non-standard communication interfaces using Peripherals Independent of the Core. <br><a name="habracut"></a><br>  PWM coding of information is quite common, when discrete signals, log.1 and log.0, are encoded with a pulse width.  Consider the option of receiving and decoding such signals using Peripherals Independent of the PIC Core Controllers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Decoding the PWM signal of the AM2302 sensor </h2><br>  In DIY projects, a DHT22 (AM2302) temperature and humidity sensor is often used.  The sensor has 3 outputs, information is transmitted over one wire.  In response to a request (low level with a duration of approximately 1ms), the sensor responds with a start bit, and then with a sequence of 40 bits, where the information is encoded in the pulse duration: log.  ‚Äú0‚Äù - impulse 30¬µs, log.  "1" - 70¬µs (typical values).  The response from the sensor contains 5 bytes: 2 bytes of humidity data, 2 bytes of temperature and 1 control byte. <br><br><img src="https://habrastorage.org/files/d89/ab5/d3a/d89ab5d3a7204c46aeb299ace4023003.png"><br>  <i>Fig.1.</i>  <i>Explanation of the principle of signal generation sensor DHT22.</i> <br><br>  There are many examples of working with such sensors on the Arduino.  Some library implementations use constructs like: <br><br><pre><code class="hljs ruby">loopCnt = TIMEOUT; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(PIN) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(--loopCount == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ErrorTimeout; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (loopCnt &lt; cntOne) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> bit =<span class="hljs-number"><span class="hljs-number">1</span></span> ‚Ä¶ } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> bit =<span class="hljs-number"><span class="hljs-number">0</span></span> ‚Ä¶ }</code> </pre> <br>  In such implementations, I see the following problems: <br><br>  - the program for the whole measurement time (&gt; 5 ms) ‚Äúhangs‚Äù in the measurement code; <br>  - the occurrence of a sufficiently long interruption will ruin the reading of data from the sensor; <br>  - potential problems with working at a low clock frequency of the microcontroller; <br><br>  The algorithm of the program of such decisions has approximately the following form (see Fig. 2) <br><br><img src="https://habrastorage.org/files/c97/8c0/d3f/c978c0d3f5444843aa4caa67c2d62f14.png"><br>  <i>Fig.</i>  <i>2. The algorithm of the software receiving and decoding sensor signals.</i> <br><br>  Below is a variant of the hardware protocol receiving / decoding with minimal software overhead. <br><br>  The idea is to separate the clock pulses from the bitstream, followed by the direction of the original signal and the clock pulses to the hardware SPI module.  In this case, the program of the microcontroller can only take in succession 5 bytes of data from the SPI. <br><br>  Part of the CIP are timers with the ability to run on events (change the state of the input or other peripherals).  Those.  changing the state of the input can start a timer, see the signal TMR6 in Fig.3.  When the timer reaches the specified value, its counting stops and the timer is in the state TMR6 = PR6 (PR is the period register).  The timer state can be an input for a Configurable Logic Cell (CLC, see Part 1). <br><br>  Thus, with the help of a timer and Logic Cells, we can form a signal suitable for applying to the clock input SCK of the SPI module.  To extract information, the duration of such a clock should have an average value between the duration of zero and one.  Then SPI can fix the bit by the decay of the clock (see Figure 3 SCK signal). <br><br>  The signal from the sensor will have false pulses generated from the request and start pulses.  In order for these impulses not to interfere with work, you need to enable SPI only for the time of information impulses, or cut off unnecessary impulses.  This problem can also be solved with the help of CIP. <br><br>  Another timer acts as a pulse counter with switching by decay: write the number 2 to the period register, the timer counts the first 2 pulses (see signal TMR4 in Fig. 3) and stops the count (see EN signal in Fig. 3), which the block of logic cells allows the output of the remaining pulses to the SPI input. <br><br><img src="https://habrastorage.org/files/063/871/47f/06387147f53f4a24b875feee752b271b.png"><br>  <i>Fig.3.</i>  <i>Diagrams explaining the reception of a DHT22 sensor signal.</i> <br><br>  The logical function of the SCK signal generation is implemented on a single logical cell (CLC), the complete circuit in the AND-OR configuration is shown in Fig.4. <br><br>  The logic cell output is connected to the SCK input, and the DHT22 sensor signal is connected to the MOSI of the SPI module.  All connections are made inside the microcontroller (Fig.5).  To control and debug signals can be displayed on the ports of the microcontroller. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f99/2ab/63f/f992ab63fbc048a1ae5b6dad31748263.png"></div><br>  <i>Fig.4.</i>  <i>CLC logic cell configuration in a PIC microcontroller.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b27/d35/f60/b27d35f60fc04de9890ed357bb84309d.png"></div><br>  <i>Fig.</i>  <i>5. Complete configuration structure of the periphery.</i> <br><br>  If it seems that the 2 timers on the task of decoding the protocol of the sensor is a waste of resources, then a counter up to two can be ‚Äúcollected‚Äù on free logical CLC cells. <br><br>  Total, the decoding task is reduced to a very simple algorithm: the microcontroller and its periphery are initialized, if necessary, the SPI module is turned on and a measurement request is generated (log. ‚Äú0‚Äù for ~ 1 ms). <br><br>  It remains to read the data from the buffer when an SPI interrupt occurs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/434/536/fef/434536fef59a4b569a45aa334d9df535.png"></div><br>  <i>Fig.6.</i>  <i>Algorithm of work with the sensor DHT22 when using the stub.</i> <br><br><img src="https://habrastorage.org/files/966/2d4/798/9662d4798e9f4d289957d2c6ff619898.png"><br>  <i>Fig.7.</i>  <i>The signals from the ports of the microcontroller.</i>  <i>SSP1IF signal - byte interrupt by the SPI module.</i> <br><br>  Figure 7 shows signal diagrams, where: <br><blockquote>  DHT (dat) - signal on the sensor signal line - we feed the SPI module MOSI input; <br>  TMR6! = RP6 - dedicated clock signal - send to the SPK SCK; <br>  SSP1IF - interrupt signal (data availability in the SPI buffer) - in fact, this signal shows the load of the microcontroller core - reading the result data. </blockquote><br><h2>  Decoding of other PWM protocols </h2><br>  Such "single-wire" PWM protocols are used in IR control panels for household appliances.  Often, IR transmission uses coding by the position of the pulse, when the duration is constant, and the pause is variable.  This option is also called "Variable pause coding".  In essence, this is the same PWM coding, but with an inverted signal.  If there are logic cells, it is not a problem to make an inversion, besides IR receivers invert the received signal.  In fig.  8 shows the signals after the receiver received from two different consoles. <br><br><img src="https://habrastorage.org/files/6a8/6ca/62e/6a86ca62ec704b029650cfc4cb1d70a8.png"><br><img src="https://habrastorage.org/files/739/1a1/4bb/7391a14bb1764eef9a3d36d4f19c40c9.png"><br>  <i>Fig.8.</i>  <i>Coding options IR control panels.</i> <br><br>  Both consoles have different protocols, but these protocols are easily decoded using the method described above, the only thing is that it is necessary to ensure that the start of the parcel is detected in order to synchronize the activation of SPI, since the IR receiver can catch interference. <br><br><img src="https://habrastorage.org/files/205/4b6/99a/2054b699a4244346990f8748f65733df.png"><br><img src="https://habrastorage.org/files/c3b/4f0/49c/c3b4f049ce3b408b9ff8715cdf017579.png"><br>  <i>Fig.</i>  <i>9. SPI decoded signals.</i> <br><br>  Not all IR remotes have PWM coding.  Some of the protocols, for example RC5, have phase coding (the Manchester code, ‚Äú0‚Äù is transmitted as 10, and ‚Äú1‚Äù as 01) [4].  The decoding of the Manchester code with the help of the periphery of the independent of the core was already considered earlier in the first part [1]. <br><br><h2>  Results </h2><br>  Instead of almost 100% CPU utilization of the microcontroller for decoding the PWM protocol in the Arduino variant (yes, I know, the problem can be solved more efficiently using capture modules or other peripherals), we transferred the reception of the information package to the hardware.  The front of the input signal starts the timer, the timer state determines the output of the block of logic cells, the output of the logic cell is fed to the SPI. <br><br>  The use of peripherals independent of the core allows you to optimize the use of resources, transfer some tasks to hardware, simplify the code, reduce consumption. <br><br><h2>  Literature </h2><br>  1. <a href="https://geektimes.ru/post/278718/">Configurable Logic Cells in PIC Controllers.</a> <br>  2. <a href="https://geektimes.ru/post/279374/">50 shades of stub.</a>  <a href="https://geektimes.ru/post/279374/">I / O Ports</a> <br>  3. <a href="https://geektimes.ru/post/280224/">50 shades of stub.</a>  <a href="https://geektimes.ru/post/280224/">ADC and ADC with the Microchip microcontroller computer</a> <br>  4. <a href="http://sbprojects.com/knowledge/ir/rc5.php">sbprojects.com/knowledge/ir/rc5.php</a> </div><p>Source: <a href="https://habr.com/ru/post/401541/">https://habr.com/ru/post/401541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../401531/index.html">Within the framework of the project ‚ÄúScience is not flour‚Äù, there will be a discussion on the topic: ‚ÄúSex, drugs, rock and roll: addiction or life?‚Äù</a></li>
<li><a href="../401533/index.html">Difficulties in choosing a budget video card on the example of RX 460</a></li>
<li><a href="../401535/index.html">The colony. Chapter 4: Old Military Base</a></li>
<li><a href="../401537/index.html">Technologies don't work anymore</a></li>
<li><a href="../401539/index.html">NVidia GPU stress test on live streaming transcoding</a></li>
<li><a href="../401543/index.html">Using data sets from the open data portal of Russia data.gov.ru</a></li>
<li><a href="../401545/index.html">Chief, and I see you. Intel Unite - a tool for professional communication</a></li>
<li><a href="../401547/index.html">Uber launches UberEats food delivery service in Russia</a></li>
<li><a href="../401549/index.html">Exotic states of matter, LCD displays and the future of water</a></li>
<li><a href="../401551/index.html">Valve develops three VR games at the same time and hopes for technology development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>