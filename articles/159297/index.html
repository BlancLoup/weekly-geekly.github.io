<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IOS application development Aviasales.ru. Airport selection screen</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When creating the application Aviasales.ru for iOS, we faced many interesting tasks. One of them is the implementation of a convenient mechanism for s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IOS application development Aviasales.ru. Airport selection screen</h1><div class="post__text post__text-html js-mediator-article">  When creating the application Aviasales.ru for iOS, we faced many interesting tasks.  One of them is the implementation of a convenient mechanism for selecting points of departure and destination.  In this post, we would like to briefly describe how we solved this task and what features the iOS SDK used. <br><br><img src="https://habrastorage.org/storage2/337/879/84b/33787984ba026594d0686f24dbfac5e1.png"><br><br>  <i>You may have seen this post some time ago.</i>  <i>We just wrote the wrong time last time - and it was removed from the publication.</i>  <i>But I really do not want the material to disappear.</i>  <i>So if you have already seen it - just ignore it.</i> <br><a name="habracut"></a><br>  The screen for selecting the airport of departure is divided into three parts: the nearest airports, the list of airports previously selected by the user, and the airport name entry line. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The functionality of the nearest airports is implemented in two stages: first, the application, after first asking for permission from the user, finds out the coordinates of the device.  By the way, in the request for obtaining geolocation data, you can add a clarification with which, in fact, we are interested in the target.  To do this, you can use the purpose property of the CLLocationManager: <br><br><pre><code class="objectivec hljs">locationManager.purpose = @‚Äù   ‚Äù;</code> </pre> <br><img src="https://habrastorage.org/storage2/b72/091/ce3/b72091ce3e6c4f54cc5e8ce201d77d88.png"><br><br>  We do not need the exact coordinates of the user, it‚Äôs enough to know which city he is located next to.  Therefore, the accuracy of geolocation can be reduced: <br><br><pre> <code class="objectivec hljs">locationManager.desiredAccuracy = kCLLocationAccuracyThreeKilometers;</code> </pre><br>  The second stage - the received coordinates are sent to our server, which determines which airports may be of interest to the user.  For example, residents of St. Petersburg, in addition to Pulkovo, are offered Finnish Lappeenranta. <br><br>  Search history is the last five selected items that are stored in the database (using SQLite with Core Data, nothing complicated). <br><br>  We turn to the most interesting - the search for airports and cities on the line entered by the user.  The search works in three stages: <br><ol><li>  we are looking for an exact match in the list of popular airports; </li><li>  if nothing is found, we look for inaccurate matches in the same list; </li><li>  If the user has entered more than two characters, he can send a search query to the server to find a less popular airport. </li></ol><br>  Now in order. <br><br>  There are a great many airports in the world - about 10 thousand.  But the really popular ones (those that users with a certain regularity use in search queries) are only one and a half thousand.  We decided to deliver this list of popular destinations initially within the application so that when you first start the user can select the desired city as quickly as possible.  To store information about these airports, we also use SQLite with Core Data (on Habr√© there is an article about how to <a href="http://habrahabr.ru/post/149867/">preload Core Data into an application</a> ).  When launched, the application reads the airport data from the database to the array: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number"><span class="hljs-number">0</span></span>), ^{ <span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectContext</span></span>* context = [[ASCoreDataManager sharedInstance] currentManagedObjectContext]; <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *dbAirports = [ASAirport MR_findAllInContext:context]; <span class="hljs-keyword"><span class="hljs-keyword">@synchronized</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>){ _airports = dbAirports; } });</code> </pre><br>  We use the Grand Central Dispatch mechanism to perform this operation in a background thread.  A call via synchronized is necessary to ensure the security of memory access during multi-threaded operation. <br><br>  ‚ÄúWhat is the <code>MR_findAllInContext</code> method?‚Äù You ask.  This is a function of the MagicalRecord library.  The fact is that the Core Data mechanism itself is not thread-safe.  In practice, this may cause the application to crash if fetch read requests are sent from different threads.  This is solved by using separate <code>NSManagedObjectContext</code> for each stream, and they will all have a common <code>persistentStoreCoordinator</code> .  The MagicalRecord library helps coordinate all these contexts. <br><br>  First, it implements the <code>[NSManagedObjectContext MR_contextForCurrentThread]</code> method (used in the <code>currentManagedObjectContext</code> method from the code above), which returns the context for the thread where it was called.  Secondly, MagicalRecord has a lot of life-saving wrappers over the standard blocks of code: for example, creating a variety of <code>NSManagedObjectModel</code> , <code>NSPersistentStoreCoordinator</code> , <code>NSManagedObject</code> and their heirs can be done in one line just by setting the necessary parameters. <br><br>  Sometimes data on popular airports are updated - some destinations become popular, others, on the contrary, become less relevant, some change their names.  Therefore, periodically, the application downloads a JSON file compressed with gzip from the server, the data from which, also in the background thread, updates the database.  First, clear the database of records: <br><br><pre> <code class="objectivec hljs">[ASAirport MR_truncateAllInContext:context];</code> </pre><br>  Then we write new data: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectContext</span></span>* context = [[ASCoreDataManager sharedInstance] currentManagedObjectContext]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (APIAirport *airport <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> airportsArray) { ASAirport *initialAirport = [ASAirport MR_createInContext:context]; <span class="hljs-comment"><span class="hljs-comment">//       } [context MR_save];</span></span></code> </pre><br><br>  Returning to the search: so, the application has read the airport data into memory and is waiting for the user to start typing characters into the search string.  When entering each new character, the program bypasses the data array and finds those airports whose names begin exactly from the line that the user entered.  In case nothing is found, re-traversing the array is started, and those names that have a small <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D1%2581%25D1%2581%25D1%2582%25D0%25BE%25D1%258F%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%259B%25D0%25B5%25D0%25B2%25D0%25B5%25D0%25BD%25D1%2588%25D1%2582%25D0%25B5%25D0%25B9%25D0%25BD%25D0%25B0">Levenshtein distance</a> from the search string are selected.  This helps if the user made a typo or simply does not know how exactly the name of the city is spelled. <br><br><img src="https://habrastorage.org/storage2/d77/07f/de9/d7707fde9d947808f460eaa0cd2d697e.png"><br><br>  The search process can take considerable time, especially if we are looking for a fuzzy match.  Therefore, it is implemented in the heir class <code>NSOperation</code> .  This gives an important advantage over simple asynchronous execution of the block: we can interrupt the operation if the search process is not yet completed, and the user has already changed the search string.  In practice, it looks like this: <br><br>  When implementing the main function, after each iteration of the loop, we check if the operation is not canceled: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ASAirport *currentAirport <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> initialAirports) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.isCancelled) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//    }</span></span></code> </pre><br>  We cancel the operation when it is no longer relevant: <br><br><pre> <code class="objectivec hljs">[_searchOperation cancel];</code> </pre><br>  and it will immediately stop doing so without consuming precious resources. <br><br>  If the user could not find the desired airport in the list of popular, he can always send a request to the server.  Example: looking for Nazran - we find Kazan (Nazran is an unpopular airport, it is not in the local database, and Kazan is closest to Levenshteyn). <br><br><img src="https://habrastorage.org/storage2/40d/9fd/4a6/40d9fd4a6c119cfe66e53eb561902b98.png"><br><br>  A second waiting for a response from the server, and the happy Nazran warrior can now find a cheap ticket and fly away! <br><br>  Thanks for attention! <br><br>  PS <br>  Aviasales app for <a href="https://itunes.apple.com/ru/app/aviasales-poisk-aviabiletov/id498958864">iOS</a> . <br>  And we also have an application for <a href="https://play.google.com/store/apps/details%3Fid%3Dru.aviasales">Android</a> . </div><p>Source: <a href="https://habr.com/ru/post/159297/">https://habr.com/ru/post/159297/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159287/index.html">Opera launches music store specifically for Russia</a></li>
<li><a href="../159289/index.html">Assassin's Creed 3 video review</a></li>
<li><a href="../159291/index.html">GEEK WEEK # 1 | GAME VIDEO DIGEST</a></li>
<li><a href="../159293/index.html">Jolla will present the heir to MeeGo live on November 21-22</a></li>
<li><a href="../159295/index.html">Pebble watch maker is not sure what Kickstarter will use for future projects</a></li>
<li><a href="../159299/index.html">Jailbreak for higher education</a></li>
<li><a href="../159303/index.html">The new letter in the Sony alphabet</a></li>
<li><a href="../159307/index.html">Course lectures "Startup". Peter Thiel. Stanford 2012. Session 6</a></li>
<li><a href="../159309/index.html">Git & Github eyewitness</a></li>
<li><a href="../159313/index.html">JavaScript pitfalls</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>