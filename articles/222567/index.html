<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Visual editing of markup inside an Android application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preamble 
 Eclipse and Idea have their own visual editing tools for Android application markup. NetBeans is deprived of this happiness. The desire to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Visual editing of markup inside an Android application</h1><div class="post__text post__text-html js-mediator-article"><h5>  Preamble </h5><br>  Eclipse and Idea have their own visual editing tools for Android application markup.  NetBeans is deprived of this happiness.  The desire to create something similar for the usual NetBeans using relatively simple means led to the idea of ‚Äã‚Äãtransferring the visual editing process to the application itself.  There are several reasons for this: <br><ul><li>  natural preview markup by means of Android itself; </li><li>  the ability to work autonomously without a desktop IDE (it may be interesting, first of all, to designers); </li><li>  "God - gods, and Caesar - Caesar."  When implementing it is convenient to use already existing data structures of View-objects, class constants, etc ... </li></ul><br><a name="habracut"></a><br><h5>  How does it work? </h5><br>  <b>Mirror tree markup.</b>  The main idea - parallel to the tree of markup objects (View), which Android generates when loading a Layout, the program creates a mirror tree of its own objects (the classes with the same name prefixed with Z - Zview, ZButton, ...).  Each of them has a link to the object - the original.  Classes have inheritance, similar to View, and support all the functionality associated with traversing the tree, for example, when generating xml-markup files, creating lists of View parameters.  In addition, the mirror tree is the main data structure for describing an open Layout: each object contains two important parameters ‚Äî a vector of markup parameters for View and a mirror descriptor object for LayoutParams. <br><img src="https://habrastorage.org/getpro/habr/post_images/405/4b9/874/4054b98749ed9f725b8a50f676e10666.jpg"><br>  <b>View options.</b>  The original variety of the View parameters is supported by a group of classes derived from ZParam, each of them implements all the specifics of the external and internal representation of the parameters of this type, converting, invoking its edit dialog, determining whether the values ‚Äã‚Äãcorrespond to the compiled file.  Currently implemented types are int, hex (hexadecimal int), boolean, float, string, charSequence, dimen (dimension), id (resource identifier), image, color, enumInt (list of named integer constants), enumString, enumClass (list of named integer classes).  In the latter case, a derived class is created for each enum class. <br><br>  The parameter vector for each View is deserialized from the corresponding xml file located in the assets.  To simplify the process of creating such files, the application has a component that, for all View, searches for getters / setters and creates a description of the proposed parameters for them.  Then these files are edited manually according to the documentation. <br><br>  <b>LayoutParams markup options.</b>  There are no similar description files for markup parameters.  Instead, for each View, LayoutParams is read (its type depends on the type of ancestor), then reflection uses the descriptor class of the same name - ZLP and its derivatives; each class creates a vector of parameters and writes values ‚Äã‚Äãread from the corresponding LayoutParams into it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Compiled Layout XML file.</b>  In the Android application (apk) file, the Layout XML descriptors are in compiled form.  A detailed format description is available at <a href="http://justanapplication.wordpress.com/category/android/android-binary-xml/">justanapplication.wordpress.com/category/android/android-binary-xml</a> .  The undoubted advantages of the format are a limited number of internal data types for parameters, sufficient simplicity to parse it with homegrown tools (for example, to view a dump or extract parameters to a mirror markup tree).  In addition, the internal Android parser is the android.content class.  res.XmlBlock is able to create a View from a byte array containing data in a similar format. <br><br>  <b>Remark</b>  In the apk-file itself compiled files are contained in a compressed form.  However, in our case it does not matter, because  the XmlBlock parser gets them unzipped. <br><br><h5>  How it works? </h5><br>  When you start the application, using reflection, it polls the Android classes for collecting the necessary constants and forms the tables in the form of pairs &lt;name-value&gt;: <br><ul><li>  resource identifiers from R.java (separately for different types - subclasses); </li><li>  class constants View; </li><li>  android.R.attr - internal constant names for all parameters; </li><li>  android.R.styleable - character symbols of the constants used in the parameters. </li></ul><br>  For all types of View from xml-files placed in assets, the vectors of object descriptors of parameters (classes ZParam) are deserialized. <br><br>  Editing in general terms happens this way.  The original unedited Layout is loaded via the resource id with the standard LayoutInflater.  According to the loaded View, a mirror tree of objects is created; for each View, the original parameter vector is copied.  Then its own CXmlResourceParser, built on the basis of the standard android.content.res.XmlResourceParser, reads the parameters of all the View and writes them into ZParam objects.  Parameter objects whose values ‚Äã‚Äãhave been read from the markup file are marked, so that they will always be highlighted in the general list of parameters.  Event handlers of all View are configured on the program code of the editing dialog. <br><br>  When changing any parameters, the own CXmlParser writes a byte array in the format of a compiled xml file, from which the XmlBlock parser creates a modified View, thus changing the Preview image.  The same thing CXmlParser does when saving changes to a binary file for a long time.  When loading a modified Layout, the same scheme works, only with a different pair of parsers: internal android.content.  res.XmlBlock for loading View and own CXmlParser - for reading parameters. <br>  For external use, the markup can be exported to a regular xml file.  For this, we use our own tools of the ZView and ZParam class groups. <br><br>  <b>Placement of data</b> .  All data is located in the GUIWizard directory on the SD card.  The application creates a directory named its own package.  The generated xml files of the edited markup are written there with the names of the Layouts.  Auxiliary binary files of compiled markup with the cxml extension are written to the data subdirectory.  The generated parameter files for the View are written to the project directory with the names of their own classes (for example, android.widget.ImageView.xml). <br><br>  <b>Remark</b>  Initially, it was assumed that when editing, the changed parameters will be immediately recorded by the setters in the corresponding View, and if they are not present, they will be written directly into the private View fields.  Similarly, to get the current field values, it was supposed to call getters.  However, later it turned out that there are quite a few exceptions in the uniqueness of the ‚Äúparameter-field-setter-getter‚Äù.  For example, several setters may correspond to one parameter; one setter may take several parameters.  Therefore, it was decided to completely abandon the interaction of objects ZView - View.  Instead, after each parameter change, a compiled xml markup file is generated and written to a byte stream (i.e., it is not a file in the direct sense of the word).  Then the XmlBlock parser creates a modified View for it. <br><br><h5>  Reflection, as without it? </h5><br>  The application makes extensive use of reflection, including for: <br><ul><li>  reading the constants of the names of Android parameters, application resources and constants of the View classes; </li><li>  generating objects of the Zview, Zparam and Zlayout class groups depending on the class name of the current object; </li><li>  bypassing access restrictions in some Android classes. </li></ul><br><h5>  Integration with NetBeans </h5><br>  A module embedded in NetBeans does a trivial job.  When you click an additional button, it calls the contents of the SDCard / GUIWizard / &lt;Android application package name&gt; directory through ADB calls.  The package name is extracted from the manifest file of the current project selected in the project window.  All files with the .xml extension are copied to / res / layout and deleted.  Old versions are renamed with the .orig extension.  Sources of the module - <a href="https://bitbucket.org/solus_rex/netbeans_guiwizard_plugin">bitbucket.org/solus_rex/netbeans_guiwizard_plugin</a> <br><br><h5>  Status quo </h5><br>  Project sources are available on <a href="https://bitbucket.org/solus_rex/android_guiwizard">bitbucket.org/solus_rex/android_guiwizard</a> <br><br>  To debug parsing a compiled markup file, you can use the binary files contained in the application itself.  To do this, you need to unzip the apk-file and copy the xml-files from res / layout to the GUIWizard / &lt;application package&gt; / data subdirectory (recall that they are contained there in compiled binary format).  In the layout, you can perform byte-by-byte comparison of the source binary markup file and the file generated by the program when their dimensions match.  To do this, the application, when writing the output file, sorts the table of names and parameter lists in the order in which they were in the source file. <br><br>  The purpose of the current stage was to test the main ideas and implement them on the layout.  Layout allows you to: <br><ul><li>  view lists of constants; </li><li>  read your own data logs and exception stacks; </li><li>  generate files for describing the View parameters; </li><li>  create new empty layouts; </li><li>  view the Layout list (in all the lists, a short click executes the main command, a long one calls the context menu of the commands). </li></ul>  A short click on the Layout list brings up its Preview, and the last saved in a binary file opens, and if it is not found, the resource in the application itself. <br><table><tbody><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/f7f/05d/ad3/f7f05dad353f6fe22d4c437ae24c712b.jpg" width="275"><br></td><td><img src="https://habrastorage.org/getpro/habr/post_images/fb5/160/709/fb5160709cabc2510f82a58ca45d2c3d.jpg" width="275" height="375"><br></td><td><img src="https://habrastorage.org/getpro/habr/post_images/8e0/385/419/8e0385419fe9e7d098c7fbce13422c05.jpg" width="275" height="375"><br></td></tr></tbody></table><br>  A long click brings up a menu of commands executed above the Layout.  In Preview, a short click on any element causes a list of its parameters, a long one - a message with the generated xml-tag.  In the command menu, the ‚ÄúView List‚Äù item displays a list with the names and types of the View, formatted by nesting.  A short click on this list brings up the already mentioned list of parameters, a long one brings up a context menu in which there is a command to add a new View as a descendant to the selected one. <br><table><tbody><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/728/f51/a1c/728f51a1cd46b53e318a636d9eb1e8b6.jpg" width="275"><br></td><td><img src="https://habrastorage.org/getpro/habr/post_images/2f3/570/05e/2f357005eae90508d9d3a81989215a8d.jpg" width="275" height="375"><br></td><td><img src="https://habrastorage.org/getpro/habr/post_images/df1/9b7/d68/df19b7d6872a7bdf98f743ab298bc82b.jpg" width="275" height="375"><br></td></tr></tbody></table><br>  A short click in the parameter list brings up a dialog corresponding to its type, a long one - a list of resources that can be assigned to it. <br><table><tbody><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/776/698/897/776698897c669ca415eacfb4b6703492.jpg" width="275"><br></td><td><img src="https://habrastorage.org/getpro/habr/post_images/7d4/be9/2a7/7d4be92a78cb8ed834c55bf13a5561f4.jpg" width="275" height="375"><br></td><td><img src="https://habrastorage.org/getpro/habr/post_images/c24/bd3/ee4/c24bd3ee4eef272a5e122a4db1ded960.jpg" width="275" height="375"><br></td></tr></tbody></table><br>  The question of adding new resources remains open - they must be protected in the original project. </div><p>Source: <a href="https://habr.com/ru/post/222567/">https://habr.com/ru/post/222567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222557/index.html">No binding to the vendor! OpenShift Cartridge Standard support will appear on InfoboxCloud Jelastic platform</a></li>
<li><a href="../222559/index.html">Protection from DDoS attacks as a service by VimpelCom - and the story of the won tenders</a></li>
<li><a href="../222561/index.html">Report from the Silicon Valley Open Doors conference in Silicon Valley - meeting people</a></li>
<li><a href="../222563/index.html">Abnormal Programming in InterSystems Cach√©</a></li>
<li><a href="../222565/index.html">As we query is 100 times faster, or not all hash functions are equally bad</a></li>
<li><a href="../222569/index.html">Synthesis-2 - domestic clone ZX-Spectrum</a></li>
<li><a href="../222571/index.html">Smart home - cheap and cheerful</a></li>
<li><a href="../222573/index.html">ReactJS in a nutshell. Part 1</a></li>
<li><a href="../222575/index.html">What's new for developers in Concrete5 CMS v5.7</a></li>
<li><a href="../222577/index.html">Algorithm for solving the backpack problem (version 2, revised)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>