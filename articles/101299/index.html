<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing Debian \ Ubuntu 10.04 on a RAID 5 array</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is posted at the request of a person who does not have an account in Habr√©, but who dreams of joining his ranks. 
 If someone has an invi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing Debian \ Ubuntu 10.04 on a RAID 5 array</h1><div class="post__text post__text-html js-mediator-article">  This article is posted at the request of a person who does not have an account in Habr√©, but who dreams of joining his ranks. <br>  If someone has an invite and a desire to share it, please write to e-mail: cibertox (man‚Äôs friend) bk dot ru <br><br>  Expanding the WEB server, I had to think about not losing the whole project, in the event of an unexpected death of hard drives, as usually happens according to the law of meanness - unexpectedly. <br>  The answer suggests itself - to use RAID, and I also wanted high-speed operation - it means RAID5 (But this method is also suitable for using arrays of the 6th and 10th levels) <br>  The main problem in deploying Debian \ Ubuntu is the inability to install the system, in its pure form, on this array because parts of the file are copied to all disks of the array, and assembling them before the complex calculations. <br>  There are options for installing the system bootloader on a USB flash drive, but this is a dead-end path and I don‚Äôt think it‚Äôs right to use it on a full-fledged production system, there are still hard drives, and running to the data center due to an unexpectedly dead flash drive with a bootloader on board is insanity! <br>  So we have a ready server with four hards, fully assembled. <br><br>  Welcome to the tackle. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Part one: System installation. </h4><br>  The root file system (/) will be on RAID 5. <br>  We start the installation and in the partitioning service of the hard disk, create 3 partitions on each physical volume, of them, the first one will be 2 GB in size, the second we give for the swap partition, how much to cut it under depends on the tasks of your server, I gave 512 MB each.  The third is all the remaining space. <br>  The first and third partitions are created as a physical RAID partition. <br>  After creating partitions on all disks, go to the settings section of the software raid <br>  After all the movements, we got 12 sections, 3 on each disk <br><br> <code>/dev/sda1 <br> /dev/sda5 <br> /dev/sda6 <br> <br> /dev/sdb1 <br> /dev/sdb5 <br> /dev/sdb6 <br> <br> /dev/sdc1 <br> /dev/sdc5 <br> /dev/sdc6 <br> <br> /dev/sdd1 <br> /dev/sdd5 <br> /dev/sdd6 <br></code> <br><br>  Where: <br>  Sections numbered 1 have 2 Gb each. <br>  Sections at number 5 are reserved for swap. <br>  And partitions numbered 6 ‚Äî all remaining disk space. <br>  (This configuration is not an axiom, sections can be cut as much as needed). <br><br>  We proceed to the creation of the array md 0: <br>  Choose the type of RAID1 partition on the proposal to add 2 disks to it, replacing the deuce with 4 and 0 for the backup ones.  Select under it all partitions with number 1 this is sda1 sdb1 sdc1 sdd1 <br>  As a result, we get 1 RAID 1 partition, 2 GB in size (This is important!). <br>  Sections sda5 sdb5 sdc5 sdd5-set aside intact, under swap. <br><br>  Next, we proceed to the creation of the md1 array, on which our RAID 5 itself will live <br>  The offer to add 3 disks is replaced by 4 and 0 under the reserve. <br>  We add to it all disks with the sequence number 6, it is: sda6 sdb6 sdc6 sdd6 <br><br>  If you did everything correctly, then we should have 2 raid devices <br>  RAID 1 device # 0 2Gb <br>  RAID 5 device # 1 24.7Gb <br><br>  For the device, select the file system type and mount point. <br>  For RAID 1, select the / boot mount point <br>  For RAID 5, set the mount point / <br><br>  We save changes to a disk and we start installation <br>  We are waiting for it to finish, we agree to the proposal to install the system bootloader to disk - at 10.04 it will be installed on all 4 disks.  (at 8.04, 8.10, it is automatically placed only on the first disk that is installed in BIOS; this is an important nuance!). <br><br>  We finish the bootloader! <br>  Since we have all disks marked as bootable, there will not be any particular difficulties with them if GRUB2 is left, but it is better to replace it with GRUB1.5, firstly it is well known, secondly it is more stable, thirdly - its capabilities we have enough with the head. <br>  Update Package Lists <br> <code>sudo apt-get update</code> <br> <br>  Remove GRUB2 <br> <code>sudo apt-get purge grub2 grub-pc</code> <br> <br>  install the previous version <br> <code>sudo apt-get install grub</code> <br> <br>  create installation menu <br> <code>sudo update-grub</code> <br>  will be asked to create a file menu.lst answer Y <br><br>  Remove remnants of grub2 <br>  sudo apt-get autoremove <br><br>  Install grub on all hard drives <br><br> <code>sudo su <br> grub-install --no-floppy /dev/sdb <br> grub-install --no-floppy /dev/sdc <br> grub-install --no-floppy /dev/sdd</code> <br> <br>  Mark all disks as bootable. <br><br> <code>grub <br> device (hd1) /dev/sdb <br> root (hd1,0) <br> setup (hd1) <br> device (hd2) /dev/sdc <br> root (hd2,0) <br> setup (hd2) <br> device (hd3) /dev/sdd <br> root (hd3,0) <br> setup (hd3) <br> <br> quit</code> <br>  (It is not necessary to install it on hd0 during the installation automatically) <br><br>  What have we got as a result ?! <br>  We have 2 RAID1 partitions created - a copy of the boot partition was created on four disks - it is stored in its pure form as on a regular disk, so any of the four disks is bootable, then the root partition on the RAID 5 is mounted independently and the OS starts quite calmly. <br><br><h4>  Part Two: Actions when leaving the hard disk. </h4><br><br>  In the event of an unforeseen death of one of the four disks in the array, we have 3 copies of the / boot partition left and a healthy partition / -which went into degraded mode. <br>  Before introducing the system, it is necessary to practice on cats - pull out one disc and see what happened by entering the command: <br><br> <code>cat /proc/mdstat</code> <br> <br>  Will issue a table <br><br> <code>Personalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] <br> md1 : active raid5 sdb6[1] sda6[0] sdc6[3] <br> 24087360 blocks level 5, 64k chunk, algorithm 2 [4/3] [UU_U] <br> <br> md0 : active raid1 sdc1[3] sdb1[1] sda1[0] <br> 1951680 blocks [4/3] [UU_U]</code> <br> <br>  Where: md1 is the list of partitions that remained operable (from the example it is clear that the sdd6 section left us, which was the third in the [UU_U] list, the numbering starts from 0). <br>  The same on the md0 section.  sdd1 only section <br>  Replace the hard drive - if this is a full-fledged server that supports hot-swappable, the new one should decide itself, if this did not happen for any reason, then there is nothing terrible - restart quietly from any of the 3 remaining disks and enter the command. <br>  Pre switch to super user mode: <br> <code>sudo su <br> fdisk ‚Äìl</code> <br>  we get a picture of this content: <br> <code>Disk /dev/sda: 10.7 GB, 10737418240 bytes <br> 255 heads, 63 sectors/track, 1305 cylinders <br> Units = cylinders of 16065 * 512 = 8225280 bytes <br> Sector size (logical/physical): 512 bytes / 512 bytes <br> I/O size (minimum/optimal): 512 bytes / 512 bytes <br> Disk identifier: 0x0004b95a <br> <br> Device Boot Start End Blocks Id System <br> /dev/sda1 1 244 1951744 fd Linux raid autodetect <br> Partition 1 does not end on cylinder boundary. <br> /dev/sda2 244 1306 8530945 5 Extended <br> /dev/sda5 244 306 500736 82 Linux swap / Solaris <br> /dev/sda6 306 1306 8029184 fd Linux raid autodetect <br> <br> Disk /dev/sdb: 10.7 GB, 10737418240 bytes <br> 255 heads, 63 sectors/track, 1305 cylinders <br> Units = cylinders of 16065 * 512 = 8225280 bytes <br> Sector size (logical/physical): 512 bytes / 512 bytes <br> I/O size (minimum/optimal): 512 bytes / 512 bytes <br> Disk identifier: 0x0008e1c9 <br> <br> Device Boot Start End Blocks Id System <br> /dev/sdb1 1 244 1951744 fd Linux raid autodetect <br> Partition 1 does not end on cylinder boundary. <br> /dev/sdb2 244 1306 8530945 5 Extended <br> /dev/sdb5 244 306 500736 82 Linux swap / Solaris <br> /dev/sdb6 306 1306 8029184 fd Linux raid autodetect <br> <br> Disk /dev/sdc: 10.7 GB, 10737418240 bytes <br> 255 heads, 63 sectors/track, 1305 cylinders <br> Units = cylinders of 16065 * 512 = 8225280 bytes <br> Sector size (logical/physical): 512 bytes / 512 bytes <br> I/O size (minimum/optimal): 512 bytes / 512 bytes <br> Disk identifier: 0x00007915 <br> <br> Device Boot Start End Blocks Id System <br> /dev/sdc1 * 1 244 1951744 fd Linux raid autodetect <br> Partition 1 does not end on cylinder boundary. <br> /dev/sdc2 244 1306 8530945 5 Extended <br> /dev/sdc5 244 306 500736 82 Linux swap / Solaris <br> /dev/sdc6 306 1306 8029184 fd Linux raid autodetect <br> <br> Disk /dev/sdd: 10.7 GB, 10737418240 bytes <br> 255 heads, 63 sectors/track, 1305 cylinders <br> Units = cylinders of 16065 * 512 = 8225280 bytes <br> Sector size (logical/physical): 512 bytes / 512 bytes <br> I/O size (minimum/optimal): 512 bytes / 512 bytes <br> Disk identifier: 0x00000000 <br> <br> Disk /dev/sdd doesn't contain a valid partition table <br> <br> Disk /dev/md0: 1998 MB, 1998520320 bytes <br> 2 heads, 4 sectors/track, 487920 cylinders <br> Units = cylinders of 8 * 512 = 4096 bytes <br> Sector size (logical/physical): 512 bytes / 512 bytes <br> I/O size (minimum/optimal): 512 bytes / 512 bytes <br> Disk identifier: 0x00000000 <br> <br> Disk /dev/md0 doesn't contain a valid partition table <br> <br> Disk /dev/md1: 24.7 GB, 24665456640 bytes <br> 2 heads, 4 sectors/track, 6021840 cylinders <br> Units = cylinders of 8 * 512 = 4096 bytes <br> Sector size (logical/physical): 512 bytes / 512 bytes <br> <br> I/O size (minimum/optimal): 65536 bytes / 196608 bytes <br> Disk identifier: 0x00000000 <br></code> <br><br>  From this footcloth you can see that our new disc was defined, but does not contain a section <br><br> <code>Disk /dev/sdd: 10.7 GB, 10737418240 bytes <br> 255 heads, 63 sectors/track, 1305 cylinders <br> Units = cylinders of 16065 * 512 = 8225280 bytes <br> Sector size (logical/physical): 512 bytes / 512 bytes <br> I/O size (minimum/optimal): 512 bytes / 512 bytes <br> Disk identifier: 0x00000000 <br> <br> Disk /dev/sdd doesn't contain a valid partition table</code> <br> <br>  Copy a partition from a live disk, for example, from sda using the ‚Äìforce key (without using the key at 10.04, the system does not want to create it in ubuntu 8, this key is not required) <br> <code>sfdisk -d /dev/sda | sfdisk /dev/sdd --force</code> <br> <br>  check the copying <br> <code>fdisk ‚Äìl</code> <br>  It will show us that there are partitions on all four disks, but there is no partition on the md0 device. <br><br> <code>Disk /dev/md0: 1998 MB, 1998520320 bytes <br> 2 heads, 4 sectors/track, 487920 cylinders <br> Units = cylinders of 8 * 512 = 4096 bytes <br> Sector size (logical/physical): 512 bytes / 512 bytes <br> I/O size (minimum/optimal): 512 bytes / 512 bytes <br> Disk identifier: 0x00000000 <br> <br> Disk /dev/md0 doesn't contain a valid partition table</code> <br> <br>  Correct this by adding our newly created sdd1 to the array. <br><br> <code>mdadm --add /dev/md0 /dev/sdd1</code> <br>  must issue <br><br>  mdadm: added / dev / sdd1 <br>  After that, our raid rebild will start immediately. 1 <br><br>  We do the same with our raid5 <br> <code>mdadm --add /dev/md1 /dev/sdd6</code> <br>  we get: <br> <code>mdadm: added /dev/sdd6</code> <br> <br>  rebuild runs, if you're interested in looking at the process, enter <br> <code>cat /proc/mdstat</code> <br> <br>  will give us: <br><br> <code>Personalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] <br> md1 : active raid5 sdd6[4] sdb6[1] sda6[0] sdc6[3] <br> 24087360 blocks level 5, 64k chunk, algorithm 2 [4/3] [UU_U] <br> [=&gt;...................] recovery = 8.8% (713984/8029120) finish=1.1min speed=101997K/sec</code> <br> <br>  Where the degree of recovery is indicated, when the work is finished, after a short wait, we re-enter the command and get the following: <br><br> <code>Personalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] <br> md1 : active raid5 sdd6[2] sdb6[1] sda6[0] sdc6[3] <br> 24087360 blocks level 5, 64k chunk, algorithm 2 [4/4] [UUUU] <br> <br> md0 : active raid1 sdd1[2] sdc1[3] sdb1[1] sda1[0] <br> 1951680 blocks [4/4] [UUUU]</code> <br> <br>  This shows that all partitions are restored. <br>  It remains for us to make a new disk bootable, <br> <code>grub <br> device (hd2) /dev/sdd <br> root (hd2,0) <br> setup (hd2) <br> quit</code> <br> <br>  Here, perhaps, that's all, your server is as good as new, all the information remains intact. </div><p>Source: <a href="https://habr.com/ru/post/101299/">https://habr.com/ru/post/101299/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../101290/index.html">The art of programming under Unix (and not only). Part Two, Clarity Better than Cleverness</a></li>
<li><a href="../101293/index.html">Overview of the router NETGEAR WNR3500L</a></li>
<li><a href="../101294/index.html">Apache Lenya - an unusual opensource CMS in Java</a></li>
<li><a href="../101297/index.html">We consider the reputation of users of social networks</a></li>
<li><a href="../101298/index.html">On the server park, clusters and data centers Intel</a></li>
<li><a href="../101300/index.html">vds64 - silence of the lambs</a></li>
<li><a href="../101301/index.html">Oracle SQL: Model dialect in examples. Part 2</a></li>
<li><a href="../101303/index.html">Five free invitations to Patterns & Practices Summit Russia 2010</a></li>
<li><a href="../101304/index.html">Vertical scroll with Javascript</a></li>
<li><a href="../101305/index.html">Ironic illustrated HTML5 video tutorial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>