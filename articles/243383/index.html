<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to send push notifications to the Windows Universal app</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are doing a service for students, whose main task is to alert classmates about various events. To do this, we first use the mechanism of push-notif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to send push notifications to the Windows Universal app</h1><div class="post__text post__text-html js-mediator-article">  We are doing a service for students, whose main task is to alert classmates about various events.  To do this, we first use the mechanism of push-notifications.  An application developed for iOS and Android will work both on tablets and on phones with these operating systems and the mechanism for sending push notifications does not depend on the class of the device.  Until recently, Windows and Windows Phone had to write two separate applications, but now it is possible to create a Universal Windows app ‚Äî universal applications that work on both Windows 8.1 and Windows Phone 8.1.  We decided to keep up with progress and developed the Universal Windows app, which we also wanted to make push notifications universal in terms of code. <br><br><img src="https://habrastorage.org/files/57c/a20/b6c/57ca20b6c2684dafb4588b99cf3d2fe9.png"><br><a name="habracut"></a><br>  The Edusty service runs on ASP .NET MVC WebAPI and resides in Windows Azure.  Initially, we decided to use the PushSharp library to send push notifications.  For iOS and Android, it works fine, the same goes for Windows Phone 7.5 / 8.0, as well as Windows 8.0 / 8.1.  When we decided to write the Universal Windows app, we encountered the problem of sending push notifications to devices with Windows Phone 8.1.  The maximum version of Windows Phone that PushSharp supported at that time was 8.0.  On devices with Windows Phone 8.1, it was possible to send push notifications only through a class designed for Windows 8.x, but live tiles did not work this way.  Since we did not wait for a quick update of the library, it was decided to write a code for sending push notifications on our own. <br>  Before the arrival of universal Windows applications, push notifications for Windows Phone were sent through the Microsoft Push Notification Service (MPNS), while for Windows 8.0 applications a new Windows Notification Service (WNS) was created.  Universal Windows applications brought WNS and for Windows Phone 8.1.  Thereby, it is possible to send push notifications for both platforms in one way. <br><br><h2>  Notification content generation </h2><br>  The universal Windows application supports three types of notifications: toast (pop-up notification), live tile (live tile), badge (plaque with a number). A push notification is generated by XML markup, the root tag of which defines the type of notification. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">toast</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">visual</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">...</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">visual</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">toast</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">visual</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">...</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">visual</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tile</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">badge</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">...</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">badge</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The visual tag is required for toast and tile.  You cannot combine different types into one xml, so you have to make three shipments for three types.  For toast and tile there are many templates that allow you to arrange pop-up notifications and live tiles in different ways.  Some templates are supported only on Windows, others only on Windows Phone, and there are those that are supported on both platforms - we chose among them. <br><br>  For the toast and the tile inside the visual tag, a binding tag must be attached with an indication of the selected template, and several templates can be combined into the tile to support different tile sizes.  A full list of templates can be found <a href="http://msdn.microsoft.com/library/windows/apps/hh761494.aspx/">here</a> and <a href="http://msdn.microsoft.com/library/windows/apps/hh761491.aspx/">here</a> . <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">toast</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">visual</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">template</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ToastText02"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span>text1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag">&gt;</span></span>text2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">visual</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">toast</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">visual</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">template</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TileSquare150x150Text02"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fallback</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TileSquareText02"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span>text1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag">&gt;</span></span>text2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">template</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TileWide310x150Text09"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fallback</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TileWideText09"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span>text1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag">&gt;</span></span>text2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">visual</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tile</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  For the badge tag, you only need to specify the value parameter, the values ‚Äã‚Äãof which are numbers or glyphs displayed on the application tile. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">badge</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">badge</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h2>  Getting authorization keys </h2><br>  Before we send a push notification, we need to get a notification channel Uri (PushNotificationChannel.Uri) and an access token (access_token). <br><br>  The notification channel receives the Uri of the service from the client, and in order to receive the access token, you need to send a POST request to <i>https://login.live.com/accesstoken.srf</i> .  The request should contain the header ‚ÄúContent-Type: application / x-www-form-urlencoded‚Äù, and the body should contain the following parameters: grant_type (the value is always ‚Äúclient_credentials‚Äù), client_id, client_secret, scope (the value is always ‚Äúnotify.windows.com ").  The values ‚Äã‚Äãof client_id and client_secret can be found in <a href="https://account.live.com/developers/applications/index">the development center for Microsoft accounts</a> on the page of your application, where client_id has the form "ms-app: // s-1-15 -....", and client_secret has the form "Z9qiptLV ... .. "  In response to the request, json will come with two fields: access_token and token_type, where the first field is the access token we need. <br><br><h2>  Sending push notifications </h2><br>  Now you can start sending push notifications.  To do this, we will create a POST request for the Uri of the notification channel received from the client device.  The request must add the following headers: <ul><li>  "X-WNS-Type", which can take 3 different values: "wns / toast", "wns / tile", "wns / badge", </li><li>  "ContentType" with a value of "text / xml", </li><li>  ‚ÄúAuthorization‚Äù with the value ‚ÄúBearer <i><u>your access token</u></i> ‚Äù. </li></ul>  Add the previously generated XML to the request body and send it.  For each type of notification, separate requests should be made (the access token should not be re-requested if these requests go in a row for a short time). <br><br><h3>  Conclusion </h3><br>  Thus, we solved the issue of universal push notifications for devices running Windows 8.1 and Windows Phone 8.1.  Some time later, we learned that in Windows Azure there is such a great service as <a href="http://azure.microsoft.com/en-us/documentation/services/notification-hubs/">Azure Notification Hub</a> , in which all this has already been implemented, including sending for iOS, Android and other platforms.  Since everything is working with us, we decided not to use this feature of Windows Azure yet. <br><br><div class="spoiler">  <b class="spoiler_title">Especially for lazy people</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> accessToken = GetAccessToken(<span class="hljs-string"><span class="hljs-string">"Z9qiptL..."</span></span>,<span class="hljs-string"><span class="hljs-string">"ms-app://s-1-15..."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xml = <span class="hljs-string"><span class="hljs-string">@"&lt;toast&gt; &lt;visual&gt; &lt;binding template=""ToastText02""&gt; &lt;text id=""1""&gt;"</span></span> + text1 + <span class="hljs-string"><span class="hljs-string">@"&lt;/text&gt; &lt;text id=""2""&gt;"</span></span> + text2 + <span class="hljs-string"><span class="hljs-string">@"&lt;/text&gt; &lt;/binding&gt; &lt;/visual&gt; &lt;/toast&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] content = Encoding.UTF8.GetBytes(xml); SendWindowsPush(pushDevice, accessToken, content, <span class="hljs-string"><span class="hljs-string">"wns/toast"</span></span>); xml = <span class="hljs-string"><span class="hljs-string">@"&lt;tile&gt; &lt;visual version=""2""&gt; &lt;binding template=""TileSquare150x150Text02"" fallback=""TileSquareText02""&gt; &lt;text id=""1""&gt;"</span></span> + text1 + <span class="hljs-string"><span class="hljs-string">@"&lt;/text&gt; &lt;text id=""2""&gt;"</span></span> + text2 + <span class="hljs-string"><span class="hljs-string">@"&lt;/text&gt; &lt;/binding&gt; &lt;binding template=""TileWide310x150Text09"" fallback=""TileWideText09""&gt; &lt;text id=""1""&gt;"</span></span> + text1 + <span class="hljs-string"><span class="hljs-string">@"&lt;/text&gt; &lt;text id=""2""&gt;"</span></span> + text2 + <span class="hljs-string"><span class="hljs-string">@"&lt;/text&gt; &lt;/binding&gt; &lt;/visual&gt; &lt;/tile&gt;"</span></span>; content = Encoding.UTF8.GetBytes(xml); SendWindowsPush(pushDevice, accessToken, content, <span class="hljs-string"><span class="hljs-string">"wns/tile"</span></span>); xml = <span class="hljs-string"><span class="hljs-string">@"&lt;badge value="""</span></span> + pushDevice.User.UnreadMessagesCount + <span class="hljs-string"><span class="hljs-string">@"""/&gt;"</span></span>; content = Encoding.UTF8.GetBytes(xml); SendWindowsPush(pushDevice, accessToken, content, <span class="hljs-string"><span class="hljs-string">"wns/badge"</span></span>);</code> </pre><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OAuthToken </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAccessToken</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> secret, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sid</span></span></span><span class="hljs-function">)</span></span> { HttpContent content = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormUrlEncodedContent(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"grant_type"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_credentials"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"client_id"</span></span>,sid), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"client_secret"</span></span>,secret), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"scope"</span></span>,<span class="hljs-string"><span class="hljs-string">"notify.windows.com"</span></span>) }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); client.DefaultRequestHeaders.TryAddWithoutValidation(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = client.PostAsync(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"https://login.live.com/accesstoken.srf"</span></span>), content).Result; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> json = response.Content.ReadAsStringAsync().Result; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetOAuthTokenFromJson(json); }</code> </pre><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OAuthToken </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOAuthTokenFromJson</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> jsonString</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ms = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream(Encoding.Unicode.GetBytes(jsonString))) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataContractJsonSerializer(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(OAuthToken)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oAuthToken = (OAuthToken)ser.ReadObject(ms); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> oAuthToken; } }</code> </pre><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">DataContract</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OAuthToken</span></span> { [DataMember(Name = <span class="hljs-string"><span class="hljs-string">"access_token"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AccessToken { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DataMember(Name = <span class="hljs-string"><span class="hljs-string">"token_type"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TokenType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendWindowsPush</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PushDevice pushDevice, OAuthToken accessToken, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] content, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = HttpWebRequest.Create(pushDevice.PushCode) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> HttpWebRequest; request.Method = <span class="hljs-string"><span class="hljs-string">"POST"</span></span>; request.Headers.Add(<span class="hljs-string"><span class="hljs-string">"X-WNS-Type"</span></span>, type); request.ContentType = <span class="hljs-string"><span class="hljs-string">"text/xml"</span></span>; request.Headers.Add(<span class="hljs-string"><span class="hljs-string">"Authorization"</span></span>, String.Format(<span class="hljs-string"><span class="hljs-string">"Bearer {0}"</span></span>, accessToken.AccessToken)); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Stream requestStream = request.GetRequestStream()) requestStream.Write(content, <span class="hljs-number"><span class="hljs-number">0</span></span>, content.Length); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = request.GetResponse(); result.GetResponseStream(); }</code> </pre></div></div></div><p>Source: <a href="https://habr.com/ru/post/243383/">https://habr.com/ru/post/243383/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243371/index.html">Let's talk about the differences Mono from MS.NET</a></li>
<li><a href="../243373/index.html">Auto-positioning and autotracing of printed circuit boards</a></li>
<li><a href="../243377/index.html">We invite you to participate in Security Meet Up December 4</a></li>
<li><a href="../243379/index.html">Zabbix + Communigate Pro: low-level discovery and account monitoring</a></li>
<li><a href="../243381/index.html">Work in the office VS Work in coworking for a small team</a></li>
<li><a href="../243385/index.html">Processors, cores and threads. System topology</a></li>
<li><a href="../243389/index.html">What will be new on .NEXT and why it will be good</a></li>
<li><a href="../243391/index.html">Facebook's Osquery Introduction</a></li>
<li><a href="../243393/index.html">Should everyone learn programming?</a></li>
<li><a href="../243395/index.html">Moving from online to offline IDE when programming Nucleo-F401RE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>