<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using MagicalRecord when developing iOS applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, good day! 

 Today I want to present to your attention another translation, do not judge strictly :) I hope you find this material useful in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using MagicalRecord when developing iOS applications</h1><div class="post__text post__text-html js-mediator-article">  Good day, good day! <br><br>  Today I want to present to your attention another translation, do not judge strictly :) I hope you find this material useful in your work. <br><br>  For years, Core Data has been an integral part of many OS X and iOS applications, providing storage and requesting user data.  Apple spends a lot of effort to make Core Data API easier to use and easier for developers to integrate into applications. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This fact indicates that Core Data is a highly modifiable project.  Even if you know how to use Data Core, performing simple, daily tasks may seem like a difficult and voluminous job.  It‚Äôs good that MagicalRecord exists - an independent Core Data library created by MagicalPanda.  And this tutorial will teach you how to speed up work with MagicalRecord quickly and easily. <br><br>  MagicalRecord is easy to use, well designed and popular.  The authors of the project stated that the main task of MagicalRecord is to clean up the code you need to write to use Core Data and, with one simple line of code, sample the data while simultaneously allowing the user to optimize performance.  ‚ÄúHow is this possible?‚Äù - you think.  This is possible thanks to a convenient technology that uses the same template for customizing, querying and updating Core Data.  The design feature is the influence of Ruby on Rails' ActiveRecord storage system. <br><br><a name="habracut"></a><br><br>  Enough theory!  Follow the instructions and you will see how MagicalRecord works.  This article describes how to create an application that will track what your favorite beer is.  This will allow you to: <br><br>  Add beer to taste. <br><br><ul><li>  Rate a beer. </li><li>  Make notes about beer. </li><li>  Make a photo of beer (in case you went over, and you need to make a note) </li></ul><br><br>  <b>Let's start</b> <br><br>  To fully understand this article, you should already have a basic understanding of CoreData, at the level of the CoreData study guide.  In addition, you do not need any prior experience with CoreData. <br><br>  <u><i>If you don‚Äôt even have a basic Core Data experience, I recommend that you first familiarize yourself with this <a href="http://www.raywenderlich.com/934/core-data-tutorial-for-ios-getting-started">Core Data tutorial</a> and then come back here.</i></u> <br><br>  To get started, download <a href="">this</a> starter project.  Once it is loaded, unpack the archive and run the application to check it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8c5/232/28d/8c523228df16cc8e09f1c165cc47e51a.png" alt="image" width="281" height="500"><br><br><br>  The application has a basic navigation controller with the ‚ÄúAdd‚Äù button, as well as a table, a search line (if you pull down an empty table) and a segment choice for sorting alphabetically or by rating.  If you click the Add button, you will be taken to the interface where you will need to enter the name of the beer and view information about it.  If you try to enter something, then until it will not be saved. <br><br>  Now look at the code.  In Project Navigator, you will see: <br><br><ul><li>  All controllers that you use to run the application. </li><li>  Service class ImageSaver </li><li>  Images that will be useful to you later to fill in the source data </li><li>  The Images.xcassets library, which already has several images used by the UI </li><li>  AMRating - convenient for rating control in other libraries </li></ul><br><br>  Looking through, you may notice that the CoreData model is missing, and AppDelegate.m does not contain any code for installation.  This is the perfect scenario for any project that you started without Core Data.  But the understanding that without Core Data - anywhere, will come only later. <br><br>  <b>Meet MagicalRecord</b> <br><br>  In the Project Navigator, select and expand the MagicalRecord group.  Inside you will see the Categories and Core groups, as well as CoreData + MagicalRecord.h.  Expand the Categories group and open a file called NSManagedObjectModel + MagicalRecord.h. <br><br>  You will notice that all names begin with the prefix MR_.  In fact, if you go through any files in the Categories group, you will notice that all names that begin with the prefix MR_. <br><br>  I do not know about you, but it seems to me rather strange to begin each name with the same letters.  It‚Äôs good that MagicalRecord makes it easy to change them using Shorthand Support. <br><br>  Again, in the Project Navigator, expand the Supporting Files group, and open the BeerTracker-Prefix.pch file.  This is a precompiled header for the project.  Add two lines of code to the ‚Äústart project‚Äù to this file: <br><br><pre><code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define MR_SHORTHAND #import ‚ÄúCoreData+MagicalRecord.h‚Äù</span></span></code> </pre> <br><br>  These two lines activate MagicalRecord for your project: <br><br><ol><li>  MR_SHORTHAND tells MagicalRecord that you do not want to enter MR_ before each method with MagicalRecord.  By logging into MagicalRecord + ShorthandSupport.m you can learn more about how it works.  But it is beyond the scope of this article, and therefore will not be discussed here :) </li><li>  By importing CoreData + MagicalRecord.h, you can now access any of the MagicalRecord APIs in the project files, and you no longer have to import them again and again into each file. </li></ol><br><br>  <i>Note: If you want to add MagicalRecord to your project, you can use additional tips on their GitHub page.</i> <br><br>  You can also add MagicalRecord in the same way as I added it to the project: <br><br><ol><li>  Download the MagicalRecord project from GitHub </li><li>  Drag and drop MagicalRecord (containing CoreData + MagicalRecord.h, Categories, and Core) into your Xcode project </li><li>  Make sure that the CoreData database is added to the project settings in Build Phases \ Link Binary with Libraries </li><li>  In your precompiled header, add the following #ifdef __OBJC__: </li></ol><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define MR_SHORTHAND #import ‚ÄúCoreData+MagicalRecord.h‚Äù</span></span></code> </pre><br><br>  <b>Model "Beer"</b> <br><br>  To start tracking your favorite varieties, you need to create a model for this, because you can hardly remember them all, right?  In the Xcode menu, select File \ New \ File ... from the list on the left, select Core Data and select - Data Model. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d2b/2a4/b24/d2b2a4b24dabc579157c1f2457ac58e9.png" alt="image" width="700" height="445"><br><br>  Name the file BeerModel.xcdatamodeld and move it to the BeerTracker group. <br><br>  In the project navigator, select the new BeerModel.xcdatamodeld bundle and start editing it.  Add an object and name it "Beer".  Add property - name of type String. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/68b/b21/65e/68bb2165e90042156b4ea6ab2d49b3be.png" alt="image" width="700" height="445"><br><br>  Add another object called BeerDetails.  This object will monitor such indicators as: user rating, notes and where to find the image.  Add the following BeerDetails properties of the appropriate types: <br><br><ul><li>  Property: Image.  type: String </li><li>  Property: Note.  type: String </li><li>  Property: Rating.  type: Integer 16 </li></ul><br><br><img src="https://habrastorage.org/getpro/habr/post_images/eb0/12b/096/eb012b0964978e1a31598d66892e304f.png" alt="image" width="700" height="445"><br><br>  Next, create a connection between the two objects, so that the beer object must know that BeerDetails belongs to it.  In BeerDetails, create a new relationship and name it ‚Äúbeer‚Äù with a target beer.  By choosing a beer destination, you created the first part of the relationship between subjects. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cc7/aca/0c5/cc7aca0c58820f08632d4e8223d53607.png" alt="image" width="700" height="445"><br><br>  Complete the relationship setup by selecting a Beer object.  Add a relationship with the name beerDetails, with the purpose of BeerDetails and invert Beer.  Now your Beer object will have a BeerDetails object to distinguish the same sorts. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a74/492/fb9/a74492fb9974508f8f5b9f7217ef365f.png" alt="image" width="700" height="445"><br><br>  The next step is to classify data to represent objects.  To do this, use Xcode, but you have to be careful, because Xcode is sometimes buggy. <br><br>  First, change the CoreData model by selecting it in the Xcode project navigator;  make sure you select the Beer object in the ‚Äúobjects‚Äù panel and not among the BeerDetails objects. <br><br>  Next, in the Xcode menu, go to Editor \ Create NSManagedObject Subclass ... check BeerModel, then click Next.  Under the control subjects, check the boxes for Beer and BeerDetails, if they are not set up by default, and double check that Beer is highlighted.  Click ‚ÄúNext‚Äù and then ‚ÄúCreate‚Äù.  This will create new classes, Beer and BeerDetails with corresponding objects and names.  Look at the new classes, and you will see that each class has properties that match the properties of the objects you defined. <br><br>  Check again the properties that represent the relationship between entities.  You should see that the Beer class contains a beerDetails property of type BeerDetails * object.  But, you will also see that the BeerDetails class contains the NSManagedObject * beer feature.  Why properties do not have beer type *?  This is due to limitations in the "Xcode Create NSManagedObject Subclass" command.  It does not affect this project, so just ignore it. <br><br>  <i><b>Note:</b> Tried curiosity?</i>  <i>I wonder why Xcode does not create cdjqcndf * Beer?</i>  <i>This seems to be the result of the restrictions in the CreateNSManagedObjectSubclass Xcode command.</i>  <i>Since Xcode recognizes the CoreData Model, it is logical to assume that the team should be able to conclude that the properties of each class must have a mutual bond with each other.</i> <br><br>  <i>However, this command not only generates properties of different types of classes.</i>  <i>It also generates the names of the classes used to define these types, and the command is not correct enough to fully perform both tasks.</i>  <i>First, you can simply generate the code and set the exact type and subclass property (adding a description as necessary).</i>  <i>Another way is to reduce the number of tasks for Xcode.</i>  <i>If you clearly defined the class name for each object in the Data Model Inspector before you create the classes themselves, then Xcode will create the correct type properties.</i> <br><br>  <i>If you are interested in more complex tools for creating classes from Xcode data models, one of them is <a href="https://github.com/rentzsch/mogenerator">mogenerator</a> .</i> <br><br>  Now that you have created classes for data objects, it's time to initialize the Core Data stack.  Open the AppDelegate.m file, and add the following lines of code before the return statement to the application: didFinishLaunchingWithOptions: delegate method: <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// Setup CoreData with MagicalRecord // Step 1. Setup Core Data Stack with Magical Record // Step 2. Relax. Why not have a beer? Surely all this talk of beer is making you thirsty‚Ä¶ [MagicalRecord setupCoreDataStackWithStoreNamed:@"BeerModel"];</span></span></code> </pre><br><br>  If you‚Äôve worked with a Core Data Xcode project, you‚Äôve probably seen how many codes are required to connect Core Data and initialize it in the AppDelegate file.  With MagicalRecord, all you need is just one line of code! <br><br>  MagicalRecord provides several alternative ways to customize the Core Data stack, depending on the following: <br><br><ul><li>  Backup Storage Type </li><li>  Do you want to use auto-migration </li><li>  And the name of your Core Data Model file </li></ul><br><br>  If your Model file has the same base name as the project name (for example, the BeerTracker.xcdatamodeld model file, as part of a project called BeerTracker), then you can use MagicalRecord in one of three convenient ways -setupCoreDataStack, setupCoreDataStackWithInMemoryStore, or setupAutoMiggrade- restratoratemore antigramdratemtagratyrate, 3DChartCrateDoreStack, you can use setupCoreDataStackWithInMemoryStore, setupCoreDataStackWithInMemoryStore, setupCoreDataStackWithInMemoryStore, setupCoreDataStackWithInMemoryStore. <br><br>  But, since your models are called differently, you should use one of two other types of installation: setupCoreDataStackWithStoreNamed: or setupCoreDataStackWithAutoMigratingsqlitestorenamed: <br><br>  Using the AutoMigrating configuration method, you can change your model, and if you can automatically transfer your storage, MagicalRecord will do it for you.  As a rule, Core Data requires you to add code to process small changes made to the model. <br><br>  Brewing (entity) <br><br>  Now, your model and Core Data stack are tuned.  You can start adding beer to your list.  Open the BeerViewController.h file, and after the AMRatingControl <a href="https://habrahabr.ru/users/class/" class="user_link">class</a> , add: <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Beer</span></span></span><span class="hljs-class">;</span></span></code> </pre><br>  And you can also add the properties of the beer after the <a href="https://habrahabr.ru/users/interface/" class="user_link">interface</a> : <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) Beer *beer;</code> </pre><br><br>  Then go to the BeerViewController.m file and import Beer.h and BeerDetails.h: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Beer.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BeerDetails.h"</span></span></span></span></code> </pre><br><br>  In viewDidLoad, add the following code block: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewDidLoad { <span class="hljs-comment"><span class="hljs-comment">// 1. If there is no beer, create new Beer if (!self.beer) { self.beer = [Beer createEntity]; } // 2. If there are no beer details, create new BeerDetails if (!self.beer.beerDetails) { self.beer.beerDetails = [BeerDetails createEntity]; } // View setup // 3. Set the title, name, note field and rating of the beer self.title = self.beer.name ? self.beer.name : @"New Beer"; self.beerNameField.text = self.beer.name; self.beerNotesView.text = self.beer.beerDetails.note; self.ratingControl.rating = [self.beer.beerDetails.rating integerValue]; [self.cellOne addSubview:self.ratingControl]; // 4. If there is an image path in the details, show it. if ([self.beer.beerDetails.image length] &gt; 0) { // Image setup NSData *imgData = [NSData dataWithContentsOfFile:[NSHomeDirectory() stringByAppendingPathComponent:self.beer.beerDetails.image]]; [self setImageForBeer:[UIImage imageWithData:imgData]]; } }</span></span></code> </pre><br><br>  <i><b>Troubleshooting:</b> if you have any errors after copying the previous code block into your project, and make Clean for your project, press Shift + Command + K, or go to Product \ Clean.</i> <br><br>  BeerViewController loads because: <br><ul><li>  Either beer is selected, or .... </li><li>  Clicked the add button from MasterViewController </li></ul><br><br>  Now that the view has loaded, you need to do the following: <br><br><ol><li>  Check whether the Beer object is loaded.  If not, it means that you need to add a new sort of beer. </li><li>  If Beer does not have any BeerDetails, create an object BeerDetails. </li><li>  To customize the view, enter the name of the beer, its rating and note the content.  If this beer does not have a name yet (in the case of the introduction of a new beer, the project will give it the name ‚Äúnew beer‚Äù). </li><li>  If the beer contains the path to the image, it will load the image in the UIImageView. </li></ol><br><br>  There are a few things that need to be set up so that you can edit and add new beers.  First, you must be able to add or change the name.  Edit textFieldDidEndEditing: so that it looks like the one below: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)textFieldDidEndEditing:(<span class="hljs-built_in"><span class="hljs-built_in">UITextField</span></span> *)textField { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([textField.text length] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.title = textField.text; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.beer.name = textField.text; } }</code> </pre><br><br>  Now, when you finish adding the textField name, it will set the name of the beer and the entire contents of the textField until the field is filled. <br><br>  To save the contents of the note, you need to evaluate the beer, find textViewDidEndEditing :, and change the contents of the method to make it look as shown below: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)textViewDidEndEditing:(<span class="hljs-built_in"><span class="hljs-built_in">UITextView</span></span> *)textView { [textView resignFirstResponder]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([textView.text length] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.beer.beerDetails.note = textView.text; } }</code> </pre><br><br>  Next, make sure that the beer rating is updated after the user changes it in the menu: View Controller.  Find the updateRating method, and add the following: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)updateRating { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.beer.beerDetails.rating = @(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ratingControl.rating); }</code> </pre><br><br>  When the user clicks on the UIImageView on the ‚Äúdetails‚Äù page, this allows him to add or edit a photo.  In UIActionSheet displays, which allows the user to select an image taken with his camera, or take a new photo.  If the user wants to take a picture, he must make sure that the image is saved on the disk.  Instead of saving the image in CoreData (which can cause problems with the performance of the computer), save the image in the user's documents with the rest of the photos, and this path is used only for Core Data. <br><br>  Controlling the interaction between the camera and the photo library is provided by implementing the UIImagePickerControllerDelegate protocol methods.  You need to make BeerViewController a delegate for the UIImagePickerController, since this is a storyboard processing controller.  Find the imagePickerController: didFinishPickingMediaWithinfo :, method and add the following: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)imagePickerController:(<span class="hljs-built_in"><span class="hljs-built_in">UIImagePickerController</span></span> *)picker didFinishPickingMediaWithInfo:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *)info { <span class="hljs-comment"><span class="hljs-comment">// 1. Grab image and save to disk UIImage *image = info[UIImagePickerControllerOriginalImage]; // 2. Remove old image if present if (self.beer.beerDetails.image) { [ImageSaver deleteImageAtPath:self.beer.beerDetails.image]; } // 3. Save the image if ([ImageSaver saveImageToDisk:image andToBeer:self.beer]) { [self setImageForBeer:image]; } [picker dismissViewControllerAnimated:YES completion:nil]; }</span></span></code> </pre><br><br>  Here is what happens in the code above: <br><ol><li>  imagePickerController: didFinishPickingMediaWithInfo: indirectly transfers the link to the image selected by the user, where the image itself is already in the info dictionary, under the UIImagePickerControllerOriginalImage key ... </li><li>  If the Beer object already contains an image, the application will delete it from the disk, so that the Account‚Äôs storage needlessly is not overfilled. </li><li>  And then a new image is saved to disk and its path is added to BeerDetails in the image properties.  Open ImageSaver and search for saveImageToDisk: andToBeer to see what it looks like.  After the image is successfully saved, it is displayed in the UIImageView. </li><li>  After that, the picker is hidden. </li></ol><br><br>  You will need to slightly change the ImageSaver to get started.  Now that the Beer class has been created, you can not comment on the import line, and the line that sets the path to the image object.  Open the ImageSaver.m file and change the import instructions: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ImageSaver.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Beer.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BeerDetails.h"</span></span></span></span></code> </pre><br><br>  Now you need to uncomment the line with the if instruction. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([imgData writeToFile:jpgPath atomically:<span class="hljs-literal"><span class="hljs-literal">YES</span></span>]) { beer.beerDetails.image = path; }</code> </pre><br><br>  The ImageSaver class is now fully prepared to take an image and save it on your phone, documents, directories, and paths in the BeerDetails object. <br><br>  Based on this, the user has two options: cancel or add a new beer.  When creating the view, a Beer object was created, and inserted into the managedObjectContext.  Cancel must delete the Beer object.  Find the cancelAdd method, and add the following: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)cancelAdd { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.beer deleteEntity]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.navigationController popViewControllerAnimated:<span class="hljs-literal"><span class="hljs-literal">YES</span></span>]; }</code> </pre><br><br>  MagicalRecord provides a good way to delete an object that automatically deletes objects from the ManagedObjectContext.  After deletion, the user will return to the main beer list. <br><br>  If the user clicks the Done button, this will save the beer and return to the main list.  Find the addNewBeer method.  It simply displays the view controller and returns to the list.  When the view closes, the viewWillDisapper: method calls.  This in turn will make the callssaveContext call. <br><br>  Right now, the saveContext method is empty, so you need to add some code to save the object.  Add the following code to the saveContext method: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)saveContext { [[<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectContext</span></span> defaultContext] saveToPersistentStoreWithCompletion:^(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> success, <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (success) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"You successfully saved your context."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"Error saving context: %@"</span></span>, error.description); } }]; }</code> </pre><br><br>  There are only a few lines of code!  In AppDelegate.m, you configure the core data of the WithMagicalRecord stack.  This created access to the default application with a managedObjectContext.  When creating Beer and BeerDetails objects, they were added to defaultContext.  MagicalRecord allows you to save a managedObjectContext using saveToPersistentStoreWithCompletion :.  Completing a block gives you access to an NSError object, in case you were unable to save.  Here, you added a simple if / else block that registers to what happens after you save the defaultContext. <br><br>  Are you ready to check your creation?  Now, launch your app!  Click the "+" button, fill in any information you want.  Then click finish. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/899/27d/3e8/89927d3e83c2532b30adfa3c69bca4eb.png" alt="image" width="333" height="500"><br><br>  After you do this, you will notice that the new beer is not displayed in the list.  Do not worry, it is not broken, and you will learn how to fix it all later.  You may also have noticed that the debugger has a whole bunch of information.  Contrary to what your logic can say, this is really good. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2e0/169/e48/2e0169e4835db980f0e7a635a67195bf.png" alt="image" width="700" height="445"><br><br>  <b>Magic debugger</b> <br><br>  When the application is running, MagicalRecord enters four things when entering the Core Data installation stack.  This indicates that the Core Data setting has occurred, and that the defaultContext has been created.  The same defaultContext that was mentioned above when you saved the Beer object. <br><br>  After you click the Done button and save the MagicalRecord several more protocols appear.  In the process of preservation, the following protocols were produced: <br><br><ol><li>  The default thread is stored in defaultContext. </li><li>  All source materials will be saved and flagged 1. </li><li>  Synchronization will not take place simultaneously and all saved files will be marked with a flag 0. </li><li>  The final logs show that MagicalRecord knows about the two objects that should be saved (Beer and BeerDetails objects), and that they have been successfully saved. </li></ol><br><br>  MagicalRecord logs a large amount of information.  If you have problems, or something is not working properly, you should check your protocols, because  They carry a lot of useful information. <br><br>  <i><b>Note:</b></i> <i><br></i>  <i>Although I do not recommend it, but if you really do not want to see what happens when the MagicalRecord protocols, go to MagicalRecord.h and replace line 17:</i> <i><br><br></i> <pre> <i><code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define MR_ENABLE_ACTIVE_RECORD_LOGGING 1</span></span></code></i> </pre> <i><br></i>  <i>on</i> <i><br></i> <pre> <i><code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define MR_ENABLE_ACTIVE_RECORD_LOGGING 0</span></span></code></i> </pre><br><br>  <b>Another beer please!</b> <br><br>  If this app is worth all the effort, you can browse all the beers you added.  Open MasterViewController.m, and import Beer.h, and BeerDetails.h. <br><br>  In order to get all the beers stored in CoreData, you will need to make a selection.  Add a selection to viewWillAppear: before calling the reloadData method. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewWillAppear:(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)animated { [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> viewWillAppear:animated]; <span class="hljs-comment"><span class="hljs-comment">// Check if the user's sort preference has been saved. ... [self fetchAllBeers]; [self.tableView reloadData]; }</span></span></code> </pre><br><br>  When you first view downloads, or when you return after viewing or adding a beer, you should load all types of beer in the table. <br><br>  Find the fetchAllBeers method, and add the following: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)fetchAllBeers { <span class="hljs-comment"><span class="hljs-comment">// 1. Get the sort key NSString *sortKey = [[NSUserDefaults standardUserDefaults] objectForKey:WB_SORT_KEY]; // 2. Determine if it is ascending BOOL ascending = [sortKey isEqualToString:SORT_KEY_RATING] ? NO : YES; // 3. Fetch entities with MagicalRecord self.beers = [[Beer findAllSortedBy:sortKey ascending:ascending] mutableCopy]; }</span></span></code> </pre><br><br>  MasterViewController allows the user to sort beer by rating with a rating from 5 to 1 per beer, or in alphabetical order (AZ).  The first time the application is launched, it creates NSUserDefault (sorting by rating) and sets it as default.  In this case, you: <br><br><ol><li>  The recovered sort key is stored in NSUserDefaults </li><li>  If the sort key is ‚Äúrating‚Äù, then the ascending variable value should be noted as ‚Äúno‚Äù.  If alphabetically, the value is "yes." </li><li>  Running fetch. </li></ol><br><br>  Yes, that's really all you need to do! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3d6/990/0b7/3d69900b744d5e14cca934915993d2fb.jpg" alt="image" width="165" height="115"><br><br>  Once again, you use MagicalRecord as a way to interact with Core Data.  findAllSortedBy: ascending is just one of many ways to sample the core data of subjects using MagicalRecord.  Some others include (note, you'll need to use one of them later): <br><br><ul><li>  indAllInContext: - will find all objects of type in context, provided </li><li>  findAll - find all objects in the context of the current thread </li><li>  findAllSortedBy: ascending: inContext: - similar to the one used earlier, but limited to their context </li><li>  findAllWithPredicate: - allows you to go to NSPredicate to search for objects. </li><li>  findAllSortedBy: ascending: withPredicate: inContext: - allows you to sort what was done, with a flag, in a specific context.  It also allows you to submit to NSPredicate for filtering. </li></ul><br><br>  There are many other things you can use - just check out NSManagedObject + MagicalFinders.m. <br><br>  To display the beer name and rating in the cell, follow configureCell: atIndex :, and add the following: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)configureCell:(<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span>*)cell atIndex:(<span class="hljs-built_in"><span class="hljs-built_in">NSIndexPath</span></span>*)indexPath { <span class="hljs-comment"><span class="hljs-comment">// Get current Beer Beer *beer = self.beers[indexPath.row]; cell.textLabel.text = beer.name; // Setup AMRatingControl AMRatingControl *ratingControl; if (![cell viewWithTag:20]) { ratingControl = [[AMRatingControl alloc] initWithLocation:CGPointMake(190, 10) emptyImage:[UIImage imageNamed:@"beermug-empty"] solidImage:[UIImage imageNamed:@"beermug-full"] andMaxRating:5]; ratingControl.tag = 20; ratingControl.autoresizingMask = UIViewAutoresizingFlexibleLeftMargin; ratingControl.userInteractionEnabled = NO; [cell addSubview:ratingControl]; } else { ratingControl = (AMRatingControl*)[cell viewWithTag:20]; } // Put beer rating in cell ratingControl.rating = [beer.beerDetails.rating integerValue]; }</span></span></code> </pre><br><br>  Now find the prepareForSegue: sender: method, and if that checks if the transition is the identifier ‚ÄúeditBeer,‚Äù add: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([[segue identifier] isEqualToString:<span class="hljs-string"><span class="hljs-string">@"editBeer"</span></span>]) { <span class="hljs-built_in"><span class="hljs-built_in">NSIndexPath</span></span> *indexPath = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.tableView indexPathForSelectedRow]; Beer *beer = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.beers[indexPath.row]; upcoming.beer = beer; }</code> </pre><br><br>  This is to transfer the Beer object to BeerViewController so that it displays information about the beer, allowing you to edit it. <br><br>  Try running the project again. <br><br>  Now you will see the beer that was added earlier, with its rating.  Also, you can choose a beer and edit information.  When you return, the table will be updated!  Very good! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e7d/182/bed/e7d182bedcb5e129a4b355cace268b3e.png" alt="image" width="333" height="500"><br><br>  Try viewing the Beer object separately, and without editing the information, return to the main list.  Take a look at the magazine.  You should see: <br><br><pre> <code class="objectivec hljs">-[<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectContext</span></span>(MagicalSaves) MR_saveWithOptions:completion:](<span class="hljs-number"><span class="hljs-number">0x8b6bfa0</span></span>) <span class="hljs-literal"><span class="hljs-literal">NO</span></span> CHANGES IN ** DEFAULT ** CONTEXT - NOT SAVING</code> </pre><br><br>     , ,   ,        viewWillDisappear:. ,    , MagicalRecord ,      ,     .      ,   ,     ‚Äî    ,   MagicalRecord    . <br><br> <b> </b> <br><br>   ,  , ,     ,  ‚Äî   ,         . <br><br>  <b>Deletion</b> <br><br>  MasterViewController.m,    tableView:commitEditingStyle:forRowAtIndexPath:,    : <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)tableView:(<span class="hljs-built_in"><span class="hljs-built_in">UITableView</span></span> *)tableView commitEditingStyle:(<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCellEditingStyle</span></span>)editingStyle forRowAtIndexPath:(<span class="hljs-built_in"><span class="hljs-built_in">NSIndexPath</span></span> *)indexPath { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (editingStyle == <span class="hljs-built_in"><span class="hljs-built_in">UITableViewCellEditingStyleDelete</span></span>) { Beer *beerToRemove = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.beers[indexPath.row]; <span class="hljs-comment"><span class="hljs-comment">// Remove Image from local documents if (beerToRemove.beerDetails.image) { [ImageSaver deleteImageAtPath:beerToRemove.beerDetails.image]; } // Deleting an Entity with MagicalRecord [beerToRemove deleteEntity]; [self saveContext]; [self.beers removeObjectAtIndex:indexPath.row]; [tableView deleteRowsAtIndexPaths:@[indexPath] withRowAnimation:UITableViewRowAnimationFade]; } }</span></span></code> </pre><br><br>  ,    saveContext.      ,   .        ‚Äî   ,    ? ......? ! <br><br>     saveContext: <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// Save ManagedObjectContext using MagicalRecord [[NSManagedObjectContext defaultContext] saveToPersistentStoreAndWait];</span></span></code> </pre><br><br>      ,   ,       MagicalRecord  managedObjectContext. <br><br>      (  ).     ,     ,   -  !   ,   ,    MagicalRecord . <br><br>  ! <br><br> <b>-</b> <br><br>        ,    ,        .   AppDelegate.m,    Beer.h, BeerDetails.h. ,    Core Data ,  : <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// Setup App with prefilled Beer items. if (![[NSUserDefaults standardUserDefaults] objectForKey:@"MR_HasPrefilledBeers"]) { // Create Blond Ale Beer *blondAle = [Beer createEntity]; blondAle.name = @"Blond Ale"; blondAle.beerDetails = [BeerDetails createEntity]; blondAle.beerDetails.rating = @4; [ImageSaver saveImageToDisk:[UIImage imageNamed:@"blond.jpg"] andToBeer:blondAle]; // Create Wheat Beer Beer *wheatBeer = [Beer createEntity]; wheatBeer.name = @"Wheat Beer"; wheatBeer.beerDetails = [BeerDetails createEntity]; wheatBeer.beerDetails.rating = @2; [ImageSaver saveImageToDisk:[UIImage imageNamed:@"wheat.jpg"] andToBeer:wheatBeer]; // Create Pale Lager Beer *paleLager = [Beer createEntity]; paleLager.name = @"Pale Lager"; paleLager.beerDetails = [BeerDetails createEntity]; paleLager.beerDetails.rating = @3; [ImageSaver saveImageToDisk:[UIImage imageNamed:@"pale.jpg"] andToBeer:paleLager]; // Create Stout Beer *stout = [Beer createEntity]; stout.name = @"Stout Lager"; stout.beerDetails = [BeerDetails createEntity]; stout.beerDetails.rating = @5; [ImageSaver saveImageToDisk:[UIImage imageNamed:@"stout.jpg"] andToBeer:stout]; // Save Managed Object Context [[NSManagedObjectContext defaultContext] saveToPersistentStoreWithCompletion:nil]; // Set User Default to prevent another preload of data on startup. [[NSUserDefaults standardUserDefaults] setBool:YES forKey:@"MR_HasPrefilledBeers"]; [[NSUserDefaults standardUserDefaults] synchronize]; }</span></span></code> </pre><br><br>  ,       ,       .          ,    .    NSUserDefaults     DataModel   ,    . <br><br>   ,         .       ;   .        ,         . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b8a/fcd/266/b8afcd26644fbcafc407c6d2277b1305.png" alt="image" width="333" height="500"><br><br>  <b>Search</b> <br><br> ,       ,   .        ‚Äî    ,   . ,    ,     . <br><br>    MagicalRecord   ,      ,     . ,       ,     . <br>       NSPredicate.         NSPredicate.   ,   ?     doSearch  MasterViewController.m file. <br><br>      doSearch: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)doSearch { <span class="hljs-comment"><span class="hljs-comment">// 1. Get the text from the search bar. NSString *searchText = self.searchBar.text; // 2. Do a fetch on the beers that match Predicate criteria. // In this case, if the name contains the string self.beers = [[Beer findAllSortedBy:SORT_KEY_NAME ascending:YES withPredicate:[NSPredicate predicateWithFormat:@"name contains[c] %@", searchText] inContext:[NSManagedObjectContext defaultContext]] mutableCopy]; // 3. Reload the table to show the query results. [self.tableView reloadData]; }</span></span></code> </pre><br><br>      ,    MagicalRecord. <br><br>        ,   ,     .     ,  ,   ,    .       ? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2df/8b4/d73/2df8b4d732f5a8fe602bea70cc2cf25e.png" alt="image" width="333" height="500"><br><br>  <b>What's next?</b> <br><br> ,    MagicalRecord  ,     MagicalRecord.       ! ,             ,      ,     ,   .  Enjoy! <br><br>      <a href=""></a> .   ,   -   . <br><br>      BeerTracker,    ,      : <br><br><ul><li>   ‚Äú ,  ‚Äù  MasterViewController ‚Äî   hasAtLeastOneEntity   MagicalRecord. </li><li>  , ,     .    ‚Äî   countOfEntitiesWithPredicate:. </li><li>     reset ‚Äî   truncateAll  MagicalRecord </li><li>     MagicalRecordShorthand.h     ‚Äî     ,         ,   MagicalRecord </li></ul></div><p>Source: <a href="https://habr.com/ru/post/236707/">https://habr.com/ru/post/236707/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236693/index.html">Flight to Mars: non-Gomanov trajectory, aero braking and landing difficulties in a rarefied atmosphere</a></li>
<li><a href="../236697/index.html">Quick access to map by key row</a></li>
<li><a href="../236699/index.html">Output video from multiple webcams on one page</a></li>
<li><a href="../236701/index.html">Available pre-order microcomputer Edison board for the Internet of things from Intel</a></li>
<li><a href="../236703/index.html">Modular Analog Synthesizers</a></li>
<li><a href="../236709/index.html">With 1,000,000,000 a day in a year!</a></li>
<li><a href="../236711/index.html">Tesla Battery Factory in Nevada will get 1.3 billion tax breaks</a></li>
<li><a href="../236713/index.html">A post about small video games</a></li>
<li><a href="../236715/index.html">Design Dribbling</a></li>
<li><a href="../236717/index.html">How to hire designers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>