<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HTML5 File API: multiple files upload to server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I once again faced the task of simultaneously uploading several files to the server (without reloading the page, of course), I began to wander ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HTML5 File API: multiple files upload to server</h1><div class="post__text post__text-html js-mediator-article">  When I once again faced the task of simultaneously uploading several files to the server (without reloading the page, of course), I began to wander around the Internet in search of a rather clumsy jQuery plug-in that allows you to simulate ajax file download (the very same plugin that with a hidden frame: it was immediately decided to refuse java- and flash-plug-ins).  During the search, I remembered that in the upcoming html 5 standard, the possibilities for working with files should be significantly expanded, and some of these possibilities are available now.  As a result, it was decided to test them in action. <br><br>  Consider the possibility of File API will be an example of the simultaneous upload of multiple images to the server.  At the end of the article is a ready-made solution, designed in the form of jQuery-plugin. <br><a name="habracut"></a><br><br>  <i><a href="https://habr.com/ru/post/109079/">I do not want to read this, I am interested in a ready-made solution.</a></i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, what are the benefits of using the File API: <br><ol><li>  Independence from external plugins </li><li>  Ability to control the download process and display information about it (the progress bar always adds patience to the user) </li><li>  The ability to read the file and find out its size before the download begins (in our example, this gives us the opportunity to weed out files that do not contain images and show thumbnails of pictures) </li><li>  Ability to select multiple files at once through the standard file selection field </li><li>  Ability to use the drag and drop interface to select files.  Yes, yes, we can drag and drop files to download directly from the desktop or, for example, from the conductor! </li></ol><br>  Among the shortcomings can be noted only the lack of support in browsers.  Currently, the File API only supports Firefox ‚â• 3.6 and Chrome ‚â• 6.0.  There is a feeling that Safari will very soon be tightened, but nothing is clear about IE and Opera (maybe someone has information?).  Upset of course, that the File API does not support IE9 Beta: this is strange, given that the IE developers are now heading for abundant html 5 support. But be that as it may, it is obvious that in the future all browsers will have to pull themselves up. <br><br>  A working example can be seen at <a href="http://safron.pro/playground/html5uploader/">http://safron.pro/playground/html5uploader/</a> , below are only the most important pieces of code. <br><br>  First, let's deal with the html-code.  We will need the default input element, a container for dragging files and a list of ul, where we will place the thumbnails of the images: <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file-field"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiple</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"img-container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"img-list"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  Nothing special, except that attribute <code>multiple="true"</code> is specified for the input element.  This is necessary so that in the standard file selection dialog you can select several of them at once.  By the way, starting with Firefox 4, browser developers promise that the standard file selection fields that are hated by many layout makers can be hidden and the dialog shown by triggering a click event for a hidden item. <br><br>  Now let's move on to JavaScript (note that I used jQuery to simplify DOM manipulations. Anyone who, for whatever reason, wants to abandon jQuery, can easily redo scripts in such a way as to do without it).  At first we will save in variables references to html-elements, starring in the main roles.  Next, we define event handlers for the standard file selection field and for the area where files can be dragged. <br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">//  input   var fileInput = $('#file-field'); // ul-,     var imgList = $('ul#img-list'); // ,      drag and drop var dropBox = $('#img-container'); //        fileInput.bind({ change: function() { displayFiles(this.files); } }); //   drag and drop      dropBox dropBox.bind({ dragenter: function() { $(this).addClass('highlighted'); return false; }, dragover: function() { return false; }, dragleave: function() { $(this).removeClass('highlighted'); return false; }, drop: function(e) { var dt = e.originalEvent.dataTransfer; displayFiles(dt.files); return false; } });</span></span></code> </pre><br><br>  In both cases, in the handler, we get access to the FileList object, which is essentially an array of File objects.  This array is passed to the displayFiles () function, the text of which is shown below. <br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayFiles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function">) </span></span>{ $.each(files, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, file</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file.type.match(<span class="hljs-regexp"><span class="hljs-regexp">/image.*/</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//    return true; } //   li     ,   progress bar, //      file,    File (  ) var li = $('&lt;li/&gt;').appendTo(imgList); $('&lt;div/&gt;').text(file.name).appendTo(li); var img = $('&lt;img/&gt;').appendTo(li); $('&lt;div/&gt;').addClass('progress').text('0%').appendTo(li); li.get(0).file = file; //   FileReader     ,     //     var reader = new FileReader(); reader.onload = (function(aImg) { return function(e) { aImg.attr('src', e.target.result); aImg.attr('width', 150); /* ...      ... */ }; })(img); reader.readAsDataURL(file); }); }</span></span></code> </pre><br><br>  The File object contains metadata about the file, such as its name, size, and type (in MIME format, for example, image / gif), respectively, in the name, size, and type properties.  To access the contents of the file, there is a special FileReader object. <br><br>  Inside the displayFiles () function, we go through the transmitted array of files and first we filter out those that are not images.  Then, for each image, a li list item is created, where an empty img element is placed (note that in each li element, a file property is also created that contains the corresponding object).  Then an instance of FileReader is created and an onload handler is defined for it, in which data is passed directly to the src attribute of the img element created earlier.  The readAsDataURL () method of the FileReader object takes a File object as a parameter and starts reading data from it.  As a result, for all images selected via a standard field or dragged directly into the browser, we see their thumbnails (artificially reduced to 150 pixels). <br><br>  What is left to do?  It remains only to realize the very loading of all selected files on the server.  To do this, create a button or link, when clicked, you can only run through all the created li elements, read their file property and pass it to the uploadFile () function, the text of which is shown below.  I note that here, to simplify, I implemented loading via a function, and in a real example located at <a href="http://safron.pro/playground/html5uploader/">http://safron.pro/playground/html5uploader/</a> , I collected all the loading actions into the uploaderObject object, during the creation of which you can pass additional parameters , such as callback functions for information about the boot process. <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uploadFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file, url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileReader(); reader.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.upload.addEventListener(<span class="hljs-string"><span class="hljs-string">"progress"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.lengthComputable) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> progress = (e.loaded * <span class="hljs-number"><span class="hljs-number">100</span></span>) / e.total; <span class="hljs-comment"><span class="hljs-comment">/* ...      ... */</span></span> } }, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* ...     load  error  xhr.upload ... */</span></span> xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.readyState == <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* ...  !   this.responseText ... */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ... ! ... */</span></span> } } }; xhr.open(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, url); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> boundary = <span class="hljs-string"><span class="hljs-string">"xxxxxxxxx"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   xhr.setRequestHeader("Content-Type", "multipart/form-data, boundary="+boundary); xhr.setRequestHeader("Cache-Control", "no-cache"); //    var body = "--" + boundary + "\r\n"; body += "Content-Disposition: form-data; name='myFile'; filename='" + file.name + "'\r\n"; body += "Content-Type: application/octet-stream\r\n\r\n"; body += reader.result + "\r\n"; body += "--" + boundary + "--"; if(xhr.sendAsBinary) { //   firefox xhr.sendAsBinary(body); } else { // chrome (   W3C) xhr.send(body); } }; //   reader.readAsBinaryString(file); }</span></span></code> </pre><br><br>  Here we create an instance of the FileReader object already familiar to us, just as above;  an onload event handler is assigned to it, in which an XMLHttpRequest is created (unfortunately, you cannot use the jQuery ajax interface yet, since it does not yet provide for downloading files).  In the second version of XMLHttpRequest, an upload property appeared that contains a loader object that can handle the progress, load and error events (see <a href="&amp;xid=17259,15700021,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhjzQ2dCJmj962T_g1zcl15iQ6e2Sg#xml">http://www.w3.org/TR/XMLHttpRequest2/#xmlhttprequesteventtarget</a> for details).  In the example above, only the handling of the progress event is shown.  Next, we assign the request completion handler to the request itself (unlike the loader object events, it is called when all data is loaded and the response from the server is received), add two additional headers and generate the request body by reading the data from the result property of the FileReader object.  After that, the download starts.  I will only note that, according to the current W3C specification, the send () method of the XMLHttpRequest object can accept binary data as a parameter, which was successfully implemented in Google Chrome, however, Firefox did it in its own way, using the special sendAsBinary () method.  Therefore, before sending, we check whether the sendAsBinary () method is defined in the request object, and, if so, use it. <br><br>  That's all.  We look forward to the approval and distribution of html 5! <br><br><h5>  Some links </h5><br><ol><li>  <a href="http://safron.pro/playground/html5uploader/">http://safron.pro/playground/html5uploader/</a> is a working example of what was described above (plus one more thing) </li><li>  <a href="">http://safron.pro/playground/html5uploader/full.zip</a> - the entire code is in the archive </li><li>  <a href="http://html5test.com/">http://html5test.com</a> - checking browsers for compliance with html 5 (very clearly) </li><li>  <a href="http://playground.html5rocks.com/">http://playground.html5rocks.com</a> - platform for experiments with code from Google (its interface will be familiar to those who used numerous Google APIs) </li></ol><br><br>  <b>UPD</b> <br>  To simplify the use of all of the above, a <a href="">jQuery plugin</a> was created.  With it, you can upload files via the File API, where possible, and implement a replacement (for example, a regular form submission) where there is none.  At the request of workers and correlated with the <a href="http://habrahabr.ru/blogs/webdev/109079/">comments of commentators</a> , loading was added through the <a href="http://www.w3.org/TR/XMLHttpRequest2/">FormData</a> object in browsers that support it (Chrome, Safari 5+, FF 4+).  At the very top of the file with the plugin there is a description of the parameters, methods, as well as brief examples of use.  A more complete example of use can be seen <a href="http://safron.pro/playground/damnUploader/demo/">here</a> (this is the initial example from this article, only converted to use a plugin, its full code, including the server part, <s>can be <a href="">downloaded here</a></s> [see UPD2]). <br><br><h5>  Used sources </h5><br><ol><li>  <a href="https://developer.mozilla.org/en/using_files_from_web_applications">https://developer.mozilla.org/en/using_files_from_web_applications</a> - an article about the file interface on the Mozilla developers website </li><li>  <a href="https://developer.mozilla.org/En/XMLHttpRequest/Using_XMLHttpRequest">https://developer.mozilla.org/En/XMLHttpRequest/Using_XMLHttpRequest</a> - article about using XMLHttpRequest ibid </li><li>  <a href="http://www.w3.org/TR/FileAPI/">http://www.w3.org/TR/FileAPI/</a> - the current File API specification on the W3C website </li><li>  <a href="http://www.w3.org/TR/XMLHttpRequest2/">http://www.w3.org/TR/XMLHttpRequest2/</a> - current XMLHttpRequest specification in the same place </li></ol><br><br><a name="UPD2"></a><br>  <b>UPD2</b> <br>  At the request of the user <a href="https://habrahabr.ru/users/glebovgin/" class="user_link">glebovgin, the</a> plugin has been finalized so that you can send not only the File object itself, but also Blob data (Blob object).  This can be useful if there is a need to send to the server, for example, the contents of the canvas, well, or just manually generated data. <br><br>  In the demo (which moved to a slightly <a href="http://safron.pro/playground/damnUploader/demo/">different address</a> ) an example of sending a picture from canvas was added.  At the moment, this feature works in FF, Chrome, IE10. <br><br>  The source code is now <a href="https://github.com/safronizator/damnUploader">available on GitHub</a> .  Comments, suggestions, improvements are welcome! </div><p>Source: <a href="https://habr.com/ru/post/109079/">https://habr.com/ru/post/109079/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109074/index.html">Hg Init: Part 4. Correcting errors</a></li>
<li><a href="../109075/index.html">Overview: 10 Russian SaaS project management systems</a></li>
<li><a href="../109076/index.html">Candy for Valerka</a></li>
<li><a href="../109077/index.html">Functional testing of pain-free web applications</a></li>
<li><a href="../109078/index.html">GPS satellite has been in orbit for the third decade</a></li>
<li><a href="../109084/index.html">Microsoft is preparing its answer for Apple TV</a></li>
<li><a href="../109087/index.html">Ever2One Converter - the first convenient way to import from Evernote to MS OneNote</a></li>
<li><a href="../109088/index.html">The Cloud Services API is the next step in the development of PaaS. How to save more using cloud platforms</a></li>
<li><a href="../109091/index.html">How to make money on mobile applications</a></li>
<li><a href="../109092/index.html">6 most promising startups in 2010</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>