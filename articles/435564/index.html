<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using GtkApplication. Librsvg drawing features</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Abstract of the article. 



- Using GtkApplication. Application framework. Makefile 
- Drawing library librsvg. 
- Exporting an image to GtkImage and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using GtkApplication. Librsvg drawing features</h1><div class="post__text post__text-html js-mediator-article">  Abstract of the article. <br><br><ul><li>  Using GtkApplication.  Application framework.  Makefile </li><li>  Drawing library librsvg. </li><li>  Exporting an image to GtkImage and its scaling. </li><li>  Scaling SVG self-written functions. </li><li>  Getting the full path in applications. </li><li>  GtkDrawingArea vs GtkImage performance tests. </li></ul><a name="habracut"></a><br>  Earlier there were articles (not mine) in the GTK + hub, which use the void function gtk_main (void) in the examples;  The GtkApplication class allows you to explicitly allocate the callback functions application_activate and application_shutdown.  C gtk_main you need to explicitly hook up gtk_main_quit so that when you click on the cross, the application is terminated.  GtkApplication terminates the application by clicking on the cross, which is more logical.  The application framework itself consists of the files main.h, Makefile, string.gresource.xml, main.c. <br><br>  <b>main.h</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> MAIN_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAIN_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;gtk/gtk.h&gt; typedef struct{ GtkApplication *restrict app; GtkWidget *restrict win; GtkBuilder *restrict builder; }appdata; appdata data; appdata *data_ptr; #endif</span></span></span></span></code> </pre> <br>  <b>Makefile</b> <br><br>  here is universal, allows you to compile all source files without specifying specific file names, but if there are extra files in the folder, the compiler will swear. <br>  You can also use CC = g ++ -std = c ++ 11, but in the callback functions you put <br>  extern "C". <br><br><pre> <code class="cmake hljs">CC = gcc -std=c99 PKGCONFIG = $(shell which pkg-config) CFLAGS = $(shell $(PKGCONFIG) --cflags gio-<span class="hljs-number"><span class="hljs-number">2.0</span></span> gtk+-<span class="hljs-number"><span class="hljs-number">3.0</span></span> librsvg-<span class="hljs-number"><span class="hljs-number">2.0</span></span>) -rdynamic -O3 LIBS = $(shell $(PKGCONFIG) --libs gio-<span class="hljs-number"><span class="hljs-number">2.0</span></span> gtk+-<span class="hljs-number"><span class="hljs-number">3.0</span></span> gmodule-<span class="hljs-number"><span class="hljs-number">2.0</span></span> librsvg-<span class="hljs-number"><span class="hljs-number">2.0</span></span> epoxy) -lm GLIB_COMPILE_RESOURCES = $(shell $(PKGCONFIG) --variable=glib_compile_resources gio-<span class="hljs-number"><span class="hljs-number">2.0</span></span>) SRC = $(wildcard *.c) GEN = gresources.c BIN = main ALL = $(GEN) $(SRC) OBJS = $(ALL:.c=.o) all: $(BIN) gresources.c: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.gresource.xml $(shell $(GLIB_COMPILE_RESOURCES) --sourcedir=. --generate-dependencies <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.gresource.xml) $(GLIB_COMPILE_RESOURCES) <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.gresource.xml --<span class="hljs-keyword"><span class="hljs-keyword">target</span></span>=$@ --sourcedir=. --generate-source %.o: %.c $(CC) $(CFLAGS) -c -o $(@F) $&lt; $(BIN): $(OBJS) $(CC) -o $(@F) $(OBJS) $(LIBS) clean: @rm -f $(GEN) $(OBJS) $(BIN)</code> </pre><br>  <b>string.gresource.xml</b> <br><br>  Serves to include resources in the executable file, in this case, the window.glade interface description file <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">gresources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">gresource</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">prefix</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/com/example/YourApp"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">preprocess</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"xml-stripblanks"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">compressed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span>window.glade<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">gresource</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">gresources</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <b>main.c</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"main.h"</span></span></span><span class="hljs-meta"> GtkBuilder* builder_init(void) { GError *</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta"> = NULL; data.builder = gtk_builder_new(); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!gtk_builder_add_from_resource (data.builder, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/com/example/YourApp/window.glade"</span></span></span><span class="hljs-meta">, &amp;</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">)) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//     g_critical ("   : %s", error-&gt;message); g_error_free (error); } gtk_builder_connect_signals (data.builder,NULL); return data.builder; } void application_activate(GtkApplication *application, gpointer user_data) { GtkBuilder *builder=builder_init(); data_ptr=&amp;data; data.win=GTK_WIDGET(gtk_builder_get_object(builder, "window1")); gtk_widget_set_size_request(data.win,360,240); gtk_application_add_window(data.app,GTK_WINDOW(data.win)); gtk_widget_show_all(data.win); } void application_shutdown(GtkApplication *application, gpointer user_data) { g_object_unref(data.builder); } int main (int argc, char *argv[]) { gtk_init (&amp;argc, &amp;argv); gint res; data.app = gtk_application_new("gtk.org", G_APPLICATION_FLAGS_NONE); g_signal_connect(data.app, "activate", G_CALLBACK(application_activate), NULL); g_signal_connect(data.app, "shutdown", G_CALLBACK(application_shutdown), NULL); res = g_application_run(G_APPLICATION(data.app), 0, NULL); return 0; }</span></span></span></span></code> </pre><br>  In the first argument of the gtk_application_new function, you can place any text, but I didn‚Äôt work without a dot.  In this example, the window.glade file is also omitted, which can be created in the Glade UI editor. <br><br>  Divide the window with a GtkBox container into 2 parts, put GtkDrawingArea into one of them, onto the other: <br><br><img src="https://habrastorage.org/webt/d4/_f/qy/d4_fqyifbcg7k12sfrrrw6d-xw0.png"><br><br>  As a result, appdata will change. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class">{</span></span> GtkApplication *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> app; GtkWidget *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> win; GtkBuilder *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> builder; GtkDrawingArea *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> draw; GtkImage *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> image; GtkEventBox *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> eventbox1; RsvgHandle *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> svg_handle_image; RsvgHandle *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> svg_handle_svg; GdkPixbuf *pixbuf; <span class="hljs-keyword"><span class="hljs-keyword">cairo_t</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> cr; <span class="hljs-keyword"><span class="hljs-keyword">cairo_surface_t</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> surf; }appdata;</code> </pre><br>  And accordingly initialization. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">application_activate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkApplication *application, gpointer user_data)</span></span></span><span class="hljs-function"> </span></span>{ GtkBuilder *builder=builder_init(); data_ptr=&amp;data; data.win=GTK_WIDGET(gtk_builder_get_object(builder, <span class="hljs-string"><span class="hljs-string">"window1"</span></span>)); data.draw=GTK_DRAWING_AREA(gtk_builder_get_object(builder, <span class="hljs-string"><span class="hljs-string">"drawingarea1"</span></span>)); data.image=GTK_IMAGE(gtk_builder_get_object(builder, <span class="hljs-string"><span class="hljs-string">"image1"</span></span>)); gtk_widget_set_size_request(data.win,<span class="hljs-number"><span class="hljs-number">640</span></span>,<span class="hljs-number"><span class="hljs-number">480</span></span>); gtk_application_add_window(data.app,GTK_WINDOW(data.win)); gtk_widget_show_all(data.win); }</code> </pre><br>  Add the path #include &lt;librsvg-2.0 / librsvg / rsvg.h&gt;.  (The librsvg and librsvg-dev packages must be installed.) <br><br>  The names of the callback functions are taken from the .glade file, the function is responsible <br>  gtk_builder_connect_signals (data.builder, NULL); <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">gboolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawingarea1_draw_cb</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkWidget *widget, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">cairo_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *cr, gpointer user_data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!data.svg_handle_svg) {data.svg_handle_svg=rsvg_handle_new_from_file(<span class="hljs-string"><span class="hljs-string">"compassmarkings.svg"</span></span>,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);} gboolean result=rsvg_handle_render_cairo(data.svg_handle_svg,cr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(result&amp;&amp;cr) {cairo_stroke(cr);} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">" \n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FALSE; }</code> </pre><br>  In some situations (for example, HMI), SVG resizing may be required.  Can <br>  change parameters width and height in SVG file.  Or translate into GtkPixbuf and scale there.  Since GtkImage is not inherited from GtkBin, it cannot have its own events of type ButtonClick (events associated with the cursor).  For this there is an empty container - GtkEventBox.  And the actual drawing itself can be hung directly on the GtkImage. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">gboolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">image1_draw_cb</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkWidget *widget, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">cairo_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *cr, gpointer user_data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!data.svg_handle_image) { data.svg_handle_image=rsvg_handle_new_from_file(<span class="hljs-string"><span class="hljs-string">"compassmarkings.svg"</span></span>,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); data.surf=cairo_image_surface_create_from_png(<span class="hljs-string"><span class="hljs-string">"2.png"</span></span>); data.pixbuf=rsvg_handle_get_pixbuf(data.svg_handle_image); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(data.pixbuf) { cairo_set_source_surface(cr,data.surf,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); GdkPixbuf *dest=gdk_pixbuf_scale_simple (data.pixbuf,<span class="hljs-number"><span class="hljs-number">250</span></span>,<span class="hljs-number"><span class="hljs-number">250</span></span>,GDK_INTERP_BILINEAR); gtk_image_set_from_pixbuf (data.image,dest); g_object_unref(dest); cairo_paint(cr); } }</code> </pre><br>  This function loads the background image (2.png), which most often represents <br>  drawing 1x1 with transparent pixel.  And then a picture (pixbuf) is rendered on this surface (surface) and then it is scaled and exported to a picture (image). <br><br>  And we must not forget about clearing the memory. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">application_shutdown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkApplication *application, gpointer user_data)</span></span></span><span class="hljs-function"> </span></span>{ cairo_surface_destroy(data.surf); g_object_unref(data.svg_handle_image); g_object_unref(data.svg_handle_svg); g_object_unref(data.pixbuf); g_object_unref(data.builder); }</code> </pre><br>  The result was: <br><br><img src="https://habrastorage.org/webt/hw/bn/yi/hwbnyikg3opargq5pg5pbzqnweg.png"><br>  If the parameters in the SVG are set to small values ‚Äã‚Äãof width and height, then the picture may turn out to be zamylenoi when exporting to png. <br><br>  You can also programmatically change the width and height.  For this, I created separate files. <br>  svg_to_pixbuf_class.c and svg_to_pixbuf_class.h.  That is, the file opens in the width, height. <br><br>  Saved to / dev / shm /.  After exporting the information to svg_handle, you need to delete the file itself and the file path string.  Fractional widths / lengths are also supported. <br><br><div class="spoiler">  <b class="spoiler_title">svg_to_pixbuf_class.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;gtk/gtk.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/stat.h&gt; #include &lt;fcntl.h&gt; #include &lt;math.h&gt; #include &lt;stdbool.h&gt; int char_to_digit(char num) { switch(num) { case '0': return 0; case '1': return 1; case '2': return 2; case '3': return 3; case '4': return 4; case '5': return 5; case '6': return 6; case '7': return 7; case '8': return 8; case '9': return 9; case '.': return -1; default: return -2; } } //     text double read_num_in_text(char* text) { double result=0; int i=0; bool fractional_flag=FALSE; char whole_part[16]={0}; char whole_digits=0; char fractional_part[16]={0}; char fractional_digits=0; while(char_to_digit(text[i])!=-2) { if(char_to_digit(text[i])!=-1&amp;&amp;!fractional_flag) { whole_part[whole_digits]=char_to_digit(text[i]); printf("text_num=%d|%c\n",char_to_digit(text[i]),text[i]); ++whole_digits; ++i; } else { if(char_to_digit(text[i])==-1) { printf("fractional flag is true\n"); fractional_flag=TRUE; ++i; } else { fractional_part[fractional_digits]=char_to_digit(text[i]); ++fractional_digits; printf("frac_digit=%d|%c\n",char_to_digit(text[i]),text[i]); ++i; } } } ///    i=whole_digits; result=whole_part[whole_digits]; while(i&gt;0) { --i; printf("whole=%d\n",whole_part[i]); result=result+pow(10,whole_digits-i-1)*whole_part[i]; } i=0; while(i&lt;=fractional_digits) { result=result+pow(0.1,i+1)*fractional_part[i]; ++i; } printf("result_read_num=%lf\n",result); return result; } //  ,    // int count_of_digits_for_delete(char* text) { int i=0; bool fractional_flag=FALSE; char whole_part[16]={0}; int whole_digits=0; char fractional_part[16]={0}; int fractional_digits=0; while(char_to_digit(text[i])!=-2) { if(char_to_digit(text[i])!=-1&amp;&amp;!fractional_flag) { whole_part[whole_digits]=char_to_digit(text[i]); printf("text_num=%d|%c\n",char_to_digit(text[i]),text[i]); ++whole_digits; ++i; } else { if(char_to_digit(text[i])==-1) { printf("fractional flag is true\n"); fractional_flag=TRUE; ++i; } else { fractional_part[fractional_digits]=char_to_digit(text[i]); ++fractional_digits; printf("frac_digit=%d|%c\n",char_to_digit(text[i]),text[i]); ++i; } } } if(fractional_flag) return whole_digits+1+fractional_digits; else return whole_digits; } //      /dev/shm //      char* create_dump_file(char *file_with_path) { char *file=NULL; int i=0; while(file_with_path[i]!='\0') {++i;} while(file_with_path[i]!='/'&amp;&amp;i&gt;0) {--i;} file=file_with_path+i; GString *string=g_string_new("test -f /dev/shm"); g_string_append(string,file); g_string_append(string,"|| touch /dev/shm/"); g_string_append(string,file); system(string-&gt;str); ///  -  GString *full_path=g_string_new("/dev/shm"); g_string_append(full_path,file); char *result=g_string_free(full_path,FALSE); return result; } //result must be freed with g_string_free GString* read_file_in_buffer(char *file_with_path) { FILE *input = NULL; struct stat buf; int fh, result; char *body=NULL; // GString *resultat=g_string_new(""); fh=open(file_with_path, O_RDONLY); result=fstat(fh, &amp;buf); if (result !=0) printf("  \n"); else { printf("%s",file_with_path); printf(" : %ld\n", buf.st_size); printf(" : %lu\n", buf.st_dev); printf(" : %s", ctime(&amp;buf.st_atime)); input = fopen(file_with_path, "r"); if (input == NULL) { printf("Error opening file"); } body=(char*)calloc(buf.st_size+64,sizeof(char)); //    //    if(body==NULL) { printf("      body\n"); } int size_count=fread(body,sizeof(char),buf.st_size, input); if(size_count!=buf.st_size) printf("   "); resultat=g_string_append(resultat,body); free(body); } fclose(input); return resultat; } void* write_string_to_file(char* writed_file, char* str_for_write, int lenght) { FILE * ptrFile = fopen (writed_file ,"wb"); size_t writed_byte_count=fwrite(str_for_write,1,lenght,ptrFile); //if(writed_byte_count&gt;4) return TRUE; //else return FALSE; fclose(ptrFile); } //      g_free char* get_resized_svg(char *file_with_path, int width, int height) { char *writed_file=create_dump_file(file_with_path); //       GString *body=read_file_in_buffer(file_with_path); char *start_search=NULL; char *end_search=NULL; char *width_start=NULL; char *width_end=NULL; char *height_start=NULL; char *height_end=NULL; start_search=strstr(body-&gt;str,"&lt;svg"); int j=0; //   if(start_search) { end_search=strstr(start_search,"&gt;"); if(end_search) { ///  width width_start=strstr(start_search,"width"); width_end=width_start+strlen("width"); ///   width    while(width_end[j]==0x0A||width_end[j]==0x20) ++j; if(width_end[j]=='=') ++j; while(width_end[j]==0x0A||width_end[j]==0x20) ++j; if(width_end[j]!='"') printf("   svg.     width=%c\n",width_end[j]); else ++j; ///  ///  ,   gssize size=count_of_digits_for_delete(width_end+j); ///   (1  - 1 ) gssize pos=width_end+j-body-&gt;str; ///       g_string_erase(body,pos,size); char width_new[8]; g_snprintf(width_new,8,"%d",width); g_string_insert(body, pos, width_new); ///  height height_start=strstr(start_search,"height"); height_end=height_start+strlen("height"); ///   height    j=0; while(height_end[j]==0x0A||height_end[j]==0x20) ++j; if(height_end[j]=='=') ++j; while(height_end[j]==0x0A||height_end[j]==0x20) ++j; if(height_end[j]!='"') printf("   svg. \    height=%c%c%c\n",height_end[j-1],height_end[j],height_end[j+1]); else ++j; ///  ///  ,   size=count_of_digits_for_delete(height_end+j); ///   (1  - 1 ) pos=height_end+j-body-&gt;str; ///       g_string_erase(body,pos,size); char height_new[8]; g_snprintf(height_new,8,"%d",height); g_string_insert(body, pos, height_new); ///      dev/shm/ ///   write_string_to_file(writed_file,body-&gt;str,strlen(body-&gt;str)); return writed_file; //g_free(writed_file); g_string_free(body,TRUE); } else printf(" :      svg"); } } void resized_svg_free(char *path) { if (remove (path)==-1 ) { printf("    %s\n",path); } }</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">svg_to_pixbuf_class.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> SVG_TO_PIXBUF_CLASS_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SVG_TO_PIXBUF_CLASS_H void resized_svg_free(char *path); char* get_resized_svg(char *file_with_path, int width, int height); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//result must be freed with g_free() #endif</span></span></span></span></code> </pre><br></div></div><br>  Now change the size of the left side (which is GtkDrawingArea) <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">gboolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawingarea1_draw_cb</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkWidget *widget, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">cairo_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *cr, gpointer user_data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!data.svg_handle_svg) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* path=get_resized_svg(<span class="hljs-string"><span class="hljs-string">"/home/alex/svg_habr/compassmarkings.svg"</span></span>, <span class="hljs-number"><span class="hljs-number">220</span></span>, <span class="hljs-number"><span class="hljs-number">220</span></span>); data.svg_handle_svg=rsvg_handle_new_from_file(path,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); resized_svg_free(path); g_free(path); } gboolean result=rsvg_handle_render_cairo(data.svg_handle_svg,cr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(result&amp;&amp;cr) {cairo_stroke(cr);} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">" \n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FALSE; }</code> </pre><br>  As you can see, there is an unpleasant feature - the full path.  That is, it is worth moving the folder as the left side (which is GtkDrawingArea) will no longer be displayed.  The same applies to all resources that are not included in the executable file.  To do this, I wrote a function that calculates the full path to the file being launched, regardless of the launch method. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   data.path void get_real_path(char *argv0) { char* result=(char*)calloc(1024,sizeof(char)); char* cwd=(char*)calloc(1024,sizeof(char)); getcwd(cwd, 1024); int i=0; while(argv0[i]!='\0'&amp;&amp;i&lt;1024) ++i; while(argv0[i]!='/'&amp;&amp;i&gt;0) --i; result[i]='\0'; while(i&gt;0) { --i; result[i]=argv0[i]; } /*alex@alex-System-Product-Name:~/project_manager$ ./manager.elf argv[0]=./manager.elf path=/home/alex/project_manager*/ if(strlen(result)&lt;=strlen(cwd)) //   { free(result); strcpy(data.path,cwd); strcat(data.path,"/"); //printf("path_cwd=%s\n",cwd); free(cwd);} else { /*alex@alex-System-Product-Name:/home$ '/home/alex/project_manager/manager.elf' argv[0]=/home/alex/project_manager/manager.elf path=/home*/ free(cwd); strcpy(data.path,result); strcat(data.path,"/"); //printf("path_result=%s\n",result); free(result); } }</span></span></code> </pre><br>  In the code itself there are 2 examples of how to run the file manager.elf.  You also need to put the beginning of the function main () <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> cwd[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; getcwd(cwd, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(cwd)); get_real_path(argv[<span class="hljs-number"><span class="hljs-number">0</span></span>]);</code> </pre><br>  The rendering function will take the following form <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">gboolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawingarea1_draw_cb</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkWidget *widget, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">cairo_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *cr, gpointer user_data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!data.svg_handle_svg) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> image_path[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">strcat</span></span>(image_path,data.path); <span class="hljs-built_in"><span class="hljs-built_in">strcat</span></span>(image_path,<span class="hljs-string"><span class="hljs-string">"compassmarkings.svg"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"image_path=%s\n"</span></span>,image_path); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* path=get_resized_svg(image_path, <span class="hljs-number"><span class="hljs-number">220</span></span>, <span class="hljs-number"><span class="hljs-number">220</span></span>); data.svg_handle_svg=rsvg_handle_new_from_file(path,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); resized_svg_free(path); g_free(path); } gboolean result=rsvg_handle_render_cairo(data.svg_handle_svg,cr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(result&amp;&amp;cr) {cairo_stroke(cr);} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">" \n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FALSE; }</code> </pre><br>  <b>Quick Tests.</b> <br><br>  We have 2 rendering functions (GtkDrawingArea and GtkImage). <br><br>  Each of them is placed in the view construction (remembering to connect &lt;time.h&gt;) <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">clock_t</span></span> tic = clock(); <span class="hljs-keyword"><span class="hljs-keyword">clock_t</span></span> toc = clock(); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"image1_draw_cb elapsed : %f seconds\n"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)(toc - tic) / CLOCKS_PER_SEC);</code> </pre><br>  And in the htop application, you can see how the program devours 20-30% of each Athlon 2 X3 2.5 GHz core. <br><br>  The error was found quickly. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">gboolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">image1_draw_cb</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkWidget *widget, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">cairo_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *cr, gpointer user_data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">clock_t</span></span> tic = clock(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!data.svg_handle_image) { data.svg_handle_image=rsvg_handle_new_from_file(<span class="hljs-string"><span class="hljs-string">"compassmarkings.svg"</span></span>,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); data.surf=cairo_image_surface_create_from_png(<span class="hljs-string"><span class="hljs-string">"2.png"</span></span>); data.pixbuf=rsvg_handle_get_pixbuf(data.svg_handle_image); <span class="hljs-comment"><span class="hljs-comment">//} //if(data.pixbuf) // { cairo_set_source_surface(cr,data.surf,0,0); GdkPixbuf *dest=gdk_pixbuf_scale_simple (data.pixbuf,250,250,GDK_INTERP_BILINEAR); gtk_image_set_from_pixbuf (data.image,dest); g_object_unref(dest); //cairo_paint(cr); } clock_t toc = clock(); printf("image1_draw_cb elapsed : %f seconds\n", (double)(toc - tic) / CLOCKS_PER_SEC); return FALSE; }</span></span></code> </pre><br>  As it turned out, GtkImage has its own rendering system, and the contents of image1_draw_cb can only be initialized once.  Commented lines were redundant. <br><br><img src="https://habrastorage.org/webt/2s/2p/4i/2s2p4ibxxewesxsfsupstrcwzju.png"><br><br>  As you can see, the first time rendering takes longer for GtkImage than for GtkDrawingArea, but theoretically the update of the image should be faster.  4 million processor cycles for each redrawing of a 220px * 220px image is a bit too much, and you can cache it only through pixbuf (at least, I don‚Äôt know other methods). <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/435564/">https://habr.com/ru/post/435564/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435552/index.html">Import Substitution - Epitaph from Digitalization</a></li>
<li><a href="../435556/index.html">Moving to the data center: how it was</a></li>
<li><a href="../435558/index.html">PostgreSQL testing with HugePages on Linux</a></li>
<li><a href="../435560/index.html">The first commercial quantum computer - IBM</a></li>
<li><a href="../435562/index.html">The path of a smoker: how to enter the profession of a programmer, if you are a humanist</a></li>
<li><a href="../435568/index.html">VyOS OpenSource Router</a></li>
<li><a href="../435572/index.html">Anycubic i3 Mega: a quality remake of Prusa i3</a></li>
<li><a href="../435574/index.html">How does zig work?</a></li>
<li><a href="../435576/index.html">1C, do not hurt</a></li>
<li><a href="../435578/index.html">Spacewalk for Christmas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>