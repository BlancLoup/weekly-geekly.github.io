<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Workers and shared workers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All popular languages ‚Äã‚Äãhave threads. In browser javascript, workers are used for parallel processing. 
 Under the cut there is a story about how to u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Workers and shared workers</h1><div class="post__text post__text-html js-mediator-article">  All popular languages ‚Äã‚Äãhave threads.  In browser javascript, workers are used for parallel processing. <br>  Under the cut there is a story about how to use them, what limitations exist in the workers and about the peculiarities of interaction with them in different browsers. <br><br><a name="habracut"></a><br><h1>  What is a worker </h1><br>  A separate context for performing background tasks that does not block the UI.  Usually a worker is created as a separate script, the worker‚Äôs resources live in the process of the page that created it.  The shared worker is the same, but can be used from several pages. <br>  In worker there are: <br><ul><li>  navigator </li><li>  location </li><li>  applicationCache </li><li>  XHR, websocket </li><li>  importScripts for synchronous script download </li></ul><br><br><h1>  Creating a worker </h1><br>  Worker is created from a separate script: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(scriptUrl); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sharedWorker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SharedWorker(scriptUrl);</code> </pre> <br>  The shared worker is identified by a URL.  To create a second worker from one file, you can add any parameter to the URL (worker.js? Num = 2). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Worker can be created without a separate file.  For example, create it from the function text: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> code = workerFn.toString(); code = code.substring(code.indexOf(<span class="hljs-string"><span class="hljs-string">"{"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>, code.lastIndexOf(<span class="hljs-string"><span class="hljs-string">"}"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blob = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Blob([code], {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'application/javascript'</span></span>}); worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(URL.createObjectURL(blob));</code> </pre><br><br>  You can create a worker from a worker only in Firefox.  In Chrome, you can create a shared worker from a page and transfer its port to another worker (see below). <br><br><h1>  Constraints of workers </h1><br><h2>  Dom </h2><br>  In a worker, you cannot use DOM, instead of a window, the global object is called self.  Cannot access localStorage and draw on canvas.  The same limitations are usually found in all desktop APIs: access to windows only from the UI thread. <br><br><h2>  Access to objects </h2><br>  From worker it is impossible to return object.  There are no lock-s and other thread-safety features in javascript, so objects cannot be transferred from a worker by reference, everything sent to or will be copied from the worker. <br><br><h2>  CORS </h2><br>  So far, workers do not support CORS, you can create a worker only by downloading it from your domain. <br><br><h2>  Stack size </h2><br>  For workers, a smaller stack size is allocated, sometimes it matters: <br><table><tbody><tr><th></th><th>  Chrome / osx </th><th>  Firefox / osx </th><th>  Safari / osx </th><th>  Chrome / win </th><th>  Firefox / win </th><th>  IE11 / win </th></tr><tr><td>  web </td><td>  20,800 </td><td>  48,000 </td><td>  63,000 </td><td>  41 900 </td><td>  51 000 </td><td>  63,000 </td></tr><tr><td>  worker </td><td>  5 300 </td><td>  43 300 </td><td>  6,100 </td><td>  21 300 </td><td>  37,000 </td><td>  30 100 </td></tr></tbody></table><br><h2>  console </h2><br>  Until recently, it was not, but usually now there is.  In some browsers, there is no console in the worker, so it‚Äôs better to check its availability before accessing it. <br><br><h1>  Interaction with worker </h1><br>  After creating a worker, you can send him a message: <br><pre> <code class="javascript hljs">worker.postMessage({<span class="hljs-attr"><span class="hljs-attr">hello</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span>}); worker.onmessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ e.data ... }; sharedWorker.port.postMessage({<span class="hljs-attr"><span class="hljs-attr">hello</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span>}); sharedWorker.port.onmessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ e.data... };</code> </pre><br><br>  Subscribe to a message in worker as follows: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// worker self.onmessage = function(e) { e.data... }; // shared worker self.onconnect = function(e) { var port = e.ports[0]; port.onmessage = function(e) { e.data... }; };</span></span></code> </pre><br><br>  Similarly, back from a worker, you can call either self.postMessage or port.postMessage for shared workers. <br><br>  The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage">postMessage</a> method uses the <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/API/DOM/The_structured_clone_algorithm">structured clone</a> algorithm for cloning objects.  This is not the same as serialization in JSON.  The algorithm is able: <br><ul><li>  copy RegExp, Blob, File, ImageData </li><li>  restore circular references </li></ul><br>  But can not: <br><ul><li>  Error, Function, DOM elements (the error will fall) </li><li>  properties and prototypes (they are not cloned) </li></ul><br><br><h2>  Transferables </h2><br>  You can send something by reference.  For this, there is a second parameter in postMessage, <a href="https://developers.google.com/web/updates/2011/12/Transferable-Objects-Lightning-Fast%3Fhl%3Den">transferList</a> : <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ab = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ArrayBuffer</span></span>(size); worker.postMessage({ <span class="hljs-attr"><span class="hljs-attr">data</span></span>: ab }, [ab]);</code> </pre><br>  In transferList you can transfer a list of objects that will be moved.  Only ArrayBuffer and MessagePort are supported.  In the calling context, the object will be cleared (neutered): the ArrayBuffer will have a zero length, and trying to send it again will result in an error: <br><pre> <code class="javascript hljs">Uncaught DOMException: Failed to execute <span class="hljs-string"><span class="hljs-string">'postMessage'</span></span> on <span class="hljs-string"><span class="hljs-string">'Worker'</span></span>: An <span class="hljs-built_in"><span class="hljs-built_in">ArrayBuffer</span></span> is neutered and could not be cloned.</code> </pre><br><br><h1>  The interaction of two workers </h1><br>  In Firefox, you can create a worker from a worker (standard defines <a href="https://html.spec.whatwg.org/multipage/workers.html">subworkers</a> ). <br>  Now in chrome, you cannot create a worker from a worker, and sometimes workers need to interact with each other.  The easiest way is to make the transfer of messages from one to another through the page code.  But this is inconvenient because: 1. it is necessary to write additional code, 2. increases the number of interactions and data copying by 2 times, 3. requires execution of the code in a UI context. <br>  The Worker can be taught to communicate with a shared worker by passing him the port of a shared worker, while losing the transmitted port in a UI context;  if it is needed, it will be necessary to reconnect to the shared worker, creating it again.  The transfer port looks like this: <br><pre> <code class="javascript hljs">worker.postMessage({ <span class="hljs-attr"><span class="hljs-attr">port</span></span>: sharedWorker.port }, [sharedWorker.port]); <span class="hljs-comment"><span class="hljs-comment">//  worker-      -  </span></span></code> </pre><br>  True, the V8 engine uses the UI context for synchronization, as can be seen by hanging the page for a while: the workers continue to work, and the postMessage do not go between them, waiting for the UI context to be specific. <br><br><h1>  PostMessage performance </h1><br>  Performance is different for several cases, different data sizes and use of transferList (trlist): <br><ul><li>  dedicated worker </li><li>  shared worker in creating process </li><li>  shared worker in another process </li></ul><br>  The table shows the number of data transfer cycles from the worker and back per second. <br><table><tbody><tr><th></th><th>  Chrome / osx </th><th>  FF / osx </th><th>  Safari / osx </th><th>  Chrome / win </th><th>  FF / win </th><th>  IE11 / win </th></tr><tr><td>  dedicated: 10B </td><td>  9 300 </td><td>  8,400 </td><td>  21,000 </td><td>  6,800 </td><td>  7 300 </td><td>  3,200 </td></tr><tr><td>  dedicated: 10kB </td><td>  4,000 </td><td>  7,000 </td><td>  5,000 </td><td>  3,000 </td><td>  5,000 </td><td>  1,800 </td></tr><tr><td>  dedicated: 1MB </td><td>  80 </td><td>  500 </td><td>  90 </td><td>  60 </td><td>  400 </td><td>  200 </td></tr><tr><td>  dedicated: 10MB </td><td>  eight </td><td>  40 </td><td>  7 </td><td>  7 </td><td>  52 </td><td>  thirty </td></tr><tr><td>  dedicated: trlist: 10MB </td><td>  8,400 </td><td>  1,100 </td><td>  2,500 </td><td>  6,200 </td><td>  1,900 </td><td>  2,200 </td></tr><tr><td>  shared: 10B </td><td>  3,100 </td><td>  8 300 </td><td>  - </td><td>  2,200 </td><td>  5 500 </td><td>  - </td></tr><tr><td>  shared: 10kB </td><td>  1,800 </td><td>  6,900 </td><td>  - </td><td>  1,400 </td><td>  4,500 </td><td>  - </td></tr><tr><td>  shared: 1MB </td><td>  40 </td><td>  500 </td><td>  - </td><td>  32 </td><td>  400 </td><td>  - </td></tr><tr><td>  shared: 10MB </td><td>  four </td><td>  40 </td><td>  - </td><td>  four </td><td>  53 </td><td>  - </td></tr><tr><td>  shared: trlist: 10MB </td><td>  - </td><td>  260 </td><td>  - </td><td>  - </td><td>  1,800 </td><td>  - </td></tr><tr><td>  shared-ipc: 10B </td><td>  3,000 </td><td>  - </td><td>  - </td><td>  2 700 </td><td>  - </td><td>  - </td></tr><tr><td>  shared-ipc: 10kB </td><td>  1,600 </td><td>  - </td><td>  - </td><td>  1,700 </td><td>  - </td><td>  - </td></tr><tr><td>  shared-ipc: 1MB </td><td>  40 </td><td>  - </td><td>  - </td><td>  thirty </td><td>  - </td><td>  - </td></tr><tr><td>  shared-ipc: 10MB </td><td>  four </td><td>  - </td><td>  - </td><td>  3 </td><td>  - </td><td>  - </td></tr></tbody></table><br>  Conclusions that can be drawn from the data: <br><ul><li>  the cost of interaction with a dedicated worker in chrome is less than with a shared one; </li><li>  large amounts of data transfer much faster through transferList; </li><li>  but still transferList transfer is not equivalent to sending a link or several bytes. </li></ul><br><br><h1>  Killing a worker </h1><br>  A decicated worker can be killed by calling worker.terminate ().  It‚Äôs not possible with shared worker, its execution will be terminated: <br><ul><li>  when it closes itself by calling self.close () </li><li>  when all the pages that close it are closed (the worker will not be able to complete the calculations) </li><li>  when the user forcibly terminates it (for example, in chrome from chrome: // inspect) </li><li>  when either he falls or the process of the page where he lives </li></ul><br>  Let's try to call the process crash from a shared worker.  Together with the worker, of course, the tab that created it will also fall.  In the tab where it was still used, we will see the following message: <br><img src="https://habrastorage.org/files/313/3db/f67/3133dbf6751a418a98addd8c74cfe300.png"><br><br>  Unfortunately, now there is no regular way to track the closure of the worker or the page that uses it. <br><br><h1>  Resource accounting in shared worker in Chrome </h1><br>  SharedWorker lives by the process in the page that created it.  It takes into account and displays in the task manager CPU and the memory that the worker consumes.  If the page is closed, its worker process will return the memory used by the page (not immediately, some time after closing) and will remain alive while other pages use this worker.  Interestingly, this process will completely disappear from chrome statistics: neither the memory nor the CPU will be able to be tracked by the user in his internal task manager.  This is unpleasant, because  the user is most likely not to guess why the browser began to consume so many resources. <br><br><h1>  Debugging workers </h1><br>  In chrome shared, workers are available on the chrome: // inspect / # workers page: <br><img src="https://habrastorage.org/files/aa3/cc3/db8/aa3cc3db8ee44ebc86779e209830a82a.png"><br>  This is where the console output from the worker is written. <br>  The dedicated worker in chrome and IE is debugged in the page where it is executed: <br><img src="https://habrastorage.org/files/13f/f08/cf7/13ff08cf77c244c09ae50171a518459c.png"><br>  In other browsers with debugging, workers are bad for now. <br><br><h1>  Can I Use ... </h1><br>  Support for different workers on <a href="http://caniuse.com/">Can I Use</a> .  Briefly, with reference to today's web: the worker is on modern browsers, sharedworker on advanced desktop browsers, serviceworker is too early. <br><br><h1>  ... </h1><br>  Everything written is relevant for the summer of 2015, do not forget that the web is changing rapidly. <br><br><h1>  Links </h1><br>  <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">Using Web Workers (MDN)</a> <br>  <a href="http://www.html5rocks.com/en/tutorials/workers/basics/">The Basics of Web Workers</a> <br>  <a href="https://html.spec.whatwg.org/multipage/workers.html">Living Standard: Web workers</a> <br>  <a href="https://developers.google.com/web/updates/2011/12/Transferable-Objects-Lightning-Fast%3Fhl%3Den">Transferable objects</a> <br>  <a href="https://hacks.mozilla.org/2015/07/how-fast-are-web-workers/">How fast are web workers?</a> </div><p>Source: <a href="https://habr.com/ru/post/261307/">https://habr.com/ru/post/261307/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261291/index.html">Entity Framework or Why I Implement Repository</a></li>
<li><a href="../261293/index.html">Effective logo design, part 1: symbols, metaphors and intuition capabilities</a></li>
<li><a href="../261295/index.html">Commercial VPN service in opensource</a></li>
<li><a href="../261301/index.html">SSL / TLS traffic analysis in Wireshark</a></li>
<li><a href="../261305/index.html">The digest of interesting materials for the mobile # 109 developer (June 22-28)</a></li>
<li><a href="../261309/index.html">Retina authentication methods</a></li>
<li><a href="../261311/index.html">Webinar "New Features of WebLogic 12c Application Server"</a></li>
<li><a href="../261313/index.html">2 in 1: the premiere of the "official" laptop at the opening of the official youtube channel</a></li>
<li><a href="../261323/index.html">OpenCL. How to start</a></li>
<li><a href="../261327/index.html">PHP Digest number 65 - interesting news, materials and tools (June 14 - 28, 2015)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>