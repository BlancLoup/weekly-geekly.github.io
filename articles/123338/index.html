<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>16 practical tips on working with CouchDB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About a year ago when developing our project, we reached a certain development point, when either the painstaking tuning and optimization of the MySQL...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>16 practical tips on working with CouchDB</h1><div class="post__text post__text-html js-mediator-article">  About a year ago when developing our project, we reached a certain development point, when either the painstaking tuning and optimization of the MySQL server begins, or the painstaking study of queries that go to the database begins again.  It so happened that it was then that there was a boom of articles about MongoDB, CouchDB and other NoSQL databases and the temptation to try them on a live project was extremely great. <br><br>  When choosing, the main role was played by the phrase ‚ÄúCouchDB is designed specifically for the web‚Äù, as well as the fact that no layers were required for access - access is provided via my favorite REST, and the API looks very simple and elegant.  In addition to this, CouchDB has a very convenient web interface for administering <a href="http://www.google.ru/search%3Fq%3Dcouchdb%2Bfuton%26um%3D1%26ie%3DUTF-8%26tbm%3Disch%26source%3Dog%26sa%3DN%26hl%3Dru%26tab%3Dwi">Futon</a> , which MongoDB did not have at that time, as well as iron fall resistance. <br><br>  Looking ahead, I will say that the choice was completely justified - we got rid of a huge number of problems in developing and designing the database, the project code was much simpler and became much better structured, but the most important thing was the very turn in consciousness that CouchDB gave us.  During this time, I personally crammed a lot of cones when developing and would like to share my experience with the Habrasoobschestvom.  These tips are not for beginners - these are tips for using CouchDB in live production. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Use more databases </h4><br>  In many manuals for beginners (including <a href="http://guide.couchdb.org/">CouchDB: The Definitive Guide</a> ), the examples look very nice, but they are completely incompatible with life.  The bottom line is that as soon as the number of your documents grows any real scale, say 100,000 documents in the database, the development of temporary views becomes almost unreal, because the server now needs to go through all your documents for the map function.  Plus, each map will contain something like this: <br><blockquote><code><font color="black"><font color="#0000ff">function</font> (doc) { <br> <font color="#0000ff">if</font> (doc.type == <font color="#A31515">'photo'</font> ) { <br> ... <br> } <br> } <br></font></code> </blockquote>  which resembles a small bicycle. <br><br>  The CouchDB logic is such that when updating a single document in the database, this update "affects" all samples.  That is, absolutely all samples will update their ETag when updating only one document.  This is another drawback of using multiple documents with different type fields in one database.  At the same time, updating one document does not affect the ETag, which will be given by other documents of this database, since ETag for documents are their latest revisions. <br><br><h4>  Replication should occur in the same local network </h4><br>  Replication is considered one of the competitive advantages of CouchDB.  It starts with a POST request and can work in the background.  On a live server, it became clear that the replication process is successful only in the local network.  As soon as your servers begin to be far away from each other, then completely untreatable glitches begin, such as: connection breakage, inability to receive changes, and so on.  With all this replica can give a message to the log and calmly pretend that all is well.  Therefore advice: <b>replicate data only in one local network</b> . <br><br><h4>  Use native reduce-functions on Erlang </h4><br>  Do not reinvent the wheel.  The documentation often uses such things as examples of reduce-functions: <br><blockquote> <code><font color="black"><font color="#0000ff">function</font> (key, values, rereduce) { <br> <font color="#0000ff">return</font> sum(values); <br> }</font></code> </blockquote>  Try to avoid them and use native reduce written in Erlang: "_count" and "_sum", which also work much faster than their Javascript counterparts. <br><br><h4>  Think three times before using complex reduce-functions </h4><br>  This moment is not covered in the documentation, but it says that if you do not use reduce-functions, then it is quite possible that you lose a lot.  Reduce can cause itself if the sample is too large, causing rereduce.  But in life, all this loses its meaning as soon as your sample becomes a little more complex. <br><br>  In our project we have a comments base in which we store comments.  Each comment is in a separate document, this document also stores the commentary city (we have a Russian portal, several cities), as well as its so-called.  affiliation - belongs field.  The challenge is to bring up the last N discussions.  In MySQL, the task comes down to something like this: <br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> comments <font color="#0000ff">GROUP</font> <font color="#0000ff">BY</font> (belongs, city) <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> timestamp</font></code> </blockquote>  The main problem of sampling in CouchDB is that it is sorted by key, and we need to forward the newest discussion threads ahead.  This means that grouping through group / group_level will no longer be possible.  This is where we turned to (re) reduce.  The truncation function of the sample at the end looked like this: <br><blockquote> <code><font color="black"><font color="#0000ff">function</font> (key, values, rereduce) { <br> <font color="#0000ff">if</font> (rereduce) { <br> <font color="#0000ff">var</font> data = [], meta = [], record, tmp, index, total = []; <br> <br> <font color="#0000ff">for</font> ( <font color="#0000ff">var</font> i <font color="#0000ff">in</font> values) { <br> <font color="#0000ff">for</font> (j=0; j&lt;values[i].length; j++) { <br> record = values[i][j]; <br> <br> tmp = record[2] + <font color="#A31515">'_'</font> + record[3]; <br> index = meta.indexOf(tmp); <br> <br> <font color="#0000ff">if</font> (index === -1) { <br> meta.push(tmp); <br> data.push(record); <br> } <font color="#0000ff">else</font> { <br> data[index][1] = Math.max(data[index][1], record[1]); <br> } <br> } <br> } <br> <br> data.sort( <font color="#0000ff">function</font> (a, b) { <br> <font color="#0000ff">if</font> (a[1] === b[1]) { <br> <font color="#0000ff">return</font> 0; <br> } <br> <br> <font color="#0000ff">return</font> (a[1] &gt; b[1]) <br> ? -1 <br> : 1; <br> }); <br> <br> <font color="#0000ff">return</font> data.slice(0, 7); <br> } <font color="#0000ff">else</font> { <br> <font color="#0000ff">var</font> output = []; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">var</font> i <font color="#0000ff">in</font> values) { <br> output.push([values[i]._id, values[i].ts, values[i].belongs, values[i].city]); <br> } <br> <br> <font color="#0000ff">return</font> output; <br> } <br> }</font></code> </blockquote>  And everything worked well, but there was a problem with the speed of updating the sample.  After entering one comment, the update of this sample took 2 seconds on a server with 4GB of memory and an Athlon 64 X2 5600+ processor ( <a href="http://www.hetzner.de/en/hosting/produkte_rootserver/x4">link</a> ).  And with a constant stream of comments, a constant database sag was unacceptable.  Now the number of documents in the database - 22,000, in the sample - 258,000.  From here an output: <b>use powerful reduce-functions only at a powerful server.</b>  <b>Otherwise, the whole idea becomes meaningless.</b> <br><br><h4>  Cache data through ETag </h4><br>  Receiving data through the ‚ÄúIf-Modified-Since / ETag‚Äù bundle is really faster than simply receiving data by about 3 times (synthetic tests).  Do not forget that when you use If-None-Match headers, <b>with a response status of 304, the response body is always empty</b> , since the server means that you keep data on your side.  In our project for this purpose we use Memcached with a small simple shell for working with CouchDB ( <a href="https://github.com/1999/couchdb-php">link</a> ) <br><br><h4>  Think CouchDB Style </h4><br>  Thinking in CouchDB is a separate thing that requires understanding.  It is not enough to write a parser from% DBMS% to CouchDB, it is important to really get used to thinking in the CouchDB style, and then all tasks will be perceived by you from a completely different point of view. <br><br>  I will give a simple example.  There are events that take place at some point in time.  If we need to find out in MySQL which events are taking place exactly today, then we write such a query: <br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> table_name <font color="#0000ff">WHERE</font> UNIX_TIMESTAMP() <font color="#0000ff">BETWEEN</font> start_timestamp <font color="#0000ff">AND</font> finish_timestamp</font> <br></code> </blockquote>  Now back to CouchDB and recall that in the samples there is no such thing as the current time.  All samples are generated 1 time, and later on, when documents are modified / created / deleted, they are only updated.  Accordingly, we have only documents and nothing more.  It is important to understand that you must make a sample so that you can pass a parameter to it as a key.  That is, you can only limit the selection by key.  The solution to this problem is to make a sample, in which for each document <b>all days in which the event takes place are</b> selected <b>as a key</b> for each document.  And in the future to get all the events taking place on this day, you will only need to refer to the form with the key "? Key = current_day" <br><br><h4>  Almost everything you do in SQL is implemented on CouchDB much easier and more beautiful. </h4><br>  I will only dilute this pseudo-yellow title with my observation 3 years ago.  At one time I had the opportunity to work as a junior programmer at a company that stamps satellites.  At these sites, the attendance was no more than 30 people per day, but under each of them was a powerful engine with an XSL template converter on the server side.  I don't even want to explain why this is stupid.  The general idea is that you should always choose the one that best suits problem solving.  In the case of sattelites, these are simple html pages that your CMS can generate;  in the case of powerful portals with high traffic, this is by no means a free Joomla. <br><br>  Let's go back to the title.  Not all programmers understand how their code works, and especially how it interacts with the database.  Often there are requests in which there are a huge number of JOINs for sampling simple data, and even EXPLAIN will not help this person determine which part of his request is slowing down, since the entire request is made without using a head.  Moreover, on a live project it all comes down to simple PRIMARY KEY samples, all other queries become a burden, and knowledge of composing complex SQL queries becomes useless. <br><br>  At the moment, I am deeply convinced that CouchDB allows novice programmers to turn their heads on and not to fence the most powerful requests just to make them work.  The convenience of reduce-functions allows you not to write stupid data truncation, discarding memory overflow.  Almost all things that are used when working with simple sites with up to 5,000 visitors per day are much more beautiful and easier to implement on CouchDB: getting pages by URL, getting a list of news, working with a guest book, photo galleries, and so on.  At the same time, the only possible UTF-8 encoding used will save you from many things that you don‚Äôt need to think about during development. <br><br><h4>  Use utilities to view current actions. </h4><br>  All current actions in CouchDB can be viewed.  In MacOS, the CouchDB utility is called <a href="http://janl.github.com/couchdbx">CouchDBX</a> .  A similar utility is for Windows.  They run a CouchDB server on port 5984 and allow you to view current requests to the server in real time.  On Linux, it is enough to start the server in non-daemon mode (the -d option in / usr / bin / couchdb is responsible for this) and all requests will be output to the console. <br><br>  Also, all current actions can be viewed in the ‚ÄúStatus‚Äù tab of ‚ÄúFuton‚Äù. <br><br><h4>  Do not use CouchDB for frequently updated data. </h4><br>  Every thing has its own best practices.  At CouchDB, working with frequently updated data is not exactly related to these parties.  Sampling the same data in CouchDB is the ideal.  Why it happens?  When one document in the database is updated, ETag is reset for all samples in the database.  This means that they all become invalid, obsolete.  For samples, this means updating and updating their ETag on the next call (i.e. min +1 query for all samples in the database).  At the server level, this means database expansion in size, which will have to be fought with the Compaction operation. <br><br><h4>  Do not forget about Compaction </h4><br>  Each update of a document leads to the creation of a newer revision.  It also leads to the regeneration of samples in which this document participates (regeneration is also affected by the operations of adding and deleting documents) the next time they are called.  All old revisions are preserved, and not always you need to have access to 600 revisions of the document, while its current revision is thousandth.  The size of the database is growing, and the server space is not always rubber, so do not forget to perform the compaction operation for views and documents.  This will save a lot of free disk space. <br><br><h4>  Regeneration of species.  Stale = update_after </h4><br>  Prior to the release of CouchDB version 1.10, a small problem was the sampling of data from non-generated species.  For this, it was proposed to use the ‚Äústale = ok‚Äù parameter when selecting a view, and hang the regeneration of the species itself, for example, in the crontab.  Starting from version 1.10, the ‚Äústale = update_after‚Äù parameter appeared, which acts in the same way as ‚Äústale = ok‚Äù, but causes an update of the view after receiving it.  Together with the simple receipt of data of the form, we have all the possibilities for quick work with even complex design documents. <br><br><h4>  Adding or changing the view on the production server affects the adjacent views of the design document </h4><br>  When a view is added to a design document, it is assembled.  This means that all the time while the view will be collected (say, _design / list / _view / by_name), its neighboring views (say, _design / list / _view / by_age) will not be available.  Don't forget about it when you add a view on a production server. <br><br><h4>  Install from source codes.  Update more often. </h4><br>  As many have become accustomed to, Ubuntu / Debian maintainers are not in a hurry to update packages in the repositories.  This means that in Ubuntu Maverick CouchDB is version 1.0.1, and in Lucid it is generally 0.10, while CouchDB has long been included in the list of priority Apache projects and is constantly evolving.  The latest version at the moment (1.10) contains the following things: <br><ul><li>  Native SSL support </li><li>  The list of databases is finally sorted alphabetically. </li><li>  More accurate ETag support for species (in the discussion it is said that the samples will not change their ETag when updating documents that are not part of them); </li><li>  CommonJS module support in map-functions (remember about NodeJS) </li><li>  The option ‚Äústale = update_after‚Äù, which acts in the same way as ‚Äústale = ok‚Äù, but causes an update of the view after receiving it </li></ul><h4>  Full text search </h4><br>  I said that CouchDB is suitable for many tasks, but not all.  Full-text search just falls under this exception.  Since we cannot pass any parameter straight to the view, we cannot search for something exactly in the database.  Therefore, you can not organize a search on the site using CouchDB.  There are various solutions to these problems, but all this is bicycles.  Frankly, this is not always so bad: it often allows you to understand that your visitors will want to search.  There is one more important point: search is almost not needed on a low-visited site.  And on a large portal, the search should be sufficiently relevant, which will not allow you to do with simple LIKE / LOCATE queries. <br><br>  A simple solution to this problem is to use <a href="http://site.yandex.ru/">Search on a site</a> from Yandex or <a href="http://www.google.ru/cse/">Custom Search Engine</a> from Google. <br><br>  A more complex and solid solution to this problem may be the use of a <b>separate search engine</b> .  This could be Sphinx, Apache Solr, Lucene (there is a bunch of <a href="https://github.com/rnewson/couchdb-lucene">couchdb-lucene</a> mentioned in the documentation).  In fact, this is a topic for a separate article, so now I will not focus on this. <br><br>  In addition, you should clearly separate the full-text search and tag search in your head, although they are similar in appearance to URL addresses. <br><br><h4>  Geopoisk </h4><br>  Another problem in CouchDB is a geo-search, for example, finding all objects within a radius of N meters.  In SQL-like databases, this task is implemented using a small function that allows determining the distance between two points by latitude and longitude.  In CouchDB, we have only one sorting scale in the keys, so finding all the points that fit in a square is almost impossible.  However, the author of CouchDB on Twitter mentioned that you can implement a geo-search in the same way as it is implemented in MongoDB, namely using the idea of <a href="http://en.wikipedia.org/wiki/Geohash">Geohash</a> .  it lies in the fact that <b>any coordinates can be represented as a numerical-alphabetic hash</b> .  In this case, the more accurate the coordinates, the greater will be the length of the hash.  Thus, you can pass geohash as a key and vary its length in the startkey / endkey parameters to refine the search radius (of course, this is not quite the radius).  There are a great many implementations of geohash, you can always read them or <a href="">write your own</a> . <br><br><h4>  Data backups </h4><br>  Data backups are one of the things in CouchDB that you should love for.  Backups are done by simply copying the database files from the / var / lib / couchdb directory.  Remember that <b>you can copy files only when the CouchDB server is turned off</b> , otherwise all your database files will be beaten.  Thus, the general procedure is as follows: <br><ol><li>  turn off the CouchDB server </li><li>  copy the databases we need </li><li>  enable CouchDB server </li></ol>  Replication is performed when the server is running.  Files with the extension * .couch contain all the documents of the respective databases.  The.% Database_name% _design directories contain the generated views of the respective databases.  If you do not copy the view directories, there will be nothing terrible: the first time you request views, they will be generated on your computer. <br><br>  Do not forget that all database files and views must belong to the appropriate CouchDB user, so check the file permissions when copying and install them, if necessary, through the chown utility. <br><br><hr><br>  The post is written in <a href="https://habrahabr.ru/users/1999/" class="user_link">1999</a> and published at his request. </div><p>Source: <a href="https://habr.com/ru/post/123338/">https://habr.com/ru/post/123338/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123331/index.html">Choosing a multiplatform engine for developing mobile games (part 1)</a></li>
<li><a href="../123333/index.html">Coworking in Thailand: an alternative point of view</a></li>
<li><a href="../123335/index.html">Speed ‚Äã‚Äãdating in Spanish or business forum BIZ BARCELONA</a></li>
<li><a href="../123336/index.html">12 laws and rules that will help in creating a successful design</a></li>
<li><a href="../123337/index.html">Jquery 1.6.2 released</a></li>
<li><a href="../123339/index.html">Node.js for beginners</a></li>
<li><a href="../123340/index.html">Remove application icon from launcher</a></li>
<li><a href="../123343/index.html">Competition Russian articles Ubuntu 2011</a></li>
<li><a href="../123344/index.html">CUnit: Automatic testing with dynamic test loading</a></li>
<li><a href="../123345/index.html">SQL Server 2011 - Standalone Database</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>