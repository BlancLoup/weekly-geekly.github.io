<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Game of God, or how I wrote "Wolf Island"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A long time ago, when I was still at university, I heard that programmers in the Faculty of Mathematics at our university are assigned an interesting ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Game of God, or how I wrote "Wolf Island"</h1><div class="post__text post__text-html js-mediator-article">  A long time ago, when I was still at university, I heard that programmers in the Faculty of Mathematics at our university are assigned an interesting task: to simulate the so-called ‚Äúwolf island‚Äù.  Its essence is approximately as follows. <br><br><img src="https://habrastorage.org/web/d43/f48/4aa/d43f484aa7bf4b0c8ee09674dcff9905.PNG"><br><br><div class="spoiler">  <b class="spoiler_title">What is in the picture</b> <div class="spoiler_text">  <i>Stop / Start</i> - Run the world <br>  <i>Turn</i> - Stop the World <br>  <i>Restart</i> - Recreate the World <br>  <i>Green cells</i> - Cells with grass.  The greener, the more grass. <br>  <i>Little hares and wolves - puppies</i> <br>  <i>Large hares and wolves - adults</i> <br>  <i>Red and blue stripes on the icon of animals</i> - the current satiety.  Red - males, blue - females. <br>  <i>The number in the lower left corner of each cell</i> is the number of creatures on a given cell. <br>  <i>Below, the</i> total number of hares and wolves, as well as the time taken to process the last move <br></div></div><a name="habracut"></a><br>  The wolf island of size <i>N</i> * <i>N is</i> inhabited by wild hares and wolves.  There are several representatives of each species.  Hares at each time point with the same probability 1/9 move to one of eight adjacent squares (with the exception of areas limited by the coastline) or sit motionless.  Each hare with probability <i>p (br)</i> turns into two birds with one stone.  Each wolf with probability <i>p (bw)</i> turns into two wolves.  Each wolf moves randomly (like a hare) until there is a hare in one of the neighboring eight squares, which he hunts for.  If the wolf and the hare are in the same square, the wolf eats the hare and gets <i>h</i> "points".  Otherwise, he loses <i>d</i> points.  Wolves with zero points die.  At the initial time, all wolves have <i>H0</i> points.  The parameters of the task could slightly change, often there were modifications: for example, ‚Äúhonest‚Äù sexual reproduction at least of wolves, but the essence remained the same. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I was extremely interested in this model, and I wanted to try to implement it at least in some form.  But it just so happened that the hands reached only recently.  However, now I could do it much more interesting, including ‚Äúfantasizing‚Äù the behavior of wolves and hares.  In this article I would like to tell you about the thorny, but extremely interesting path to the balance of a complex ecosystem. <br><br><h1>  Selection of initial parameters </h1><br>  First, I did not want to be limited to a square field, and I took a rectangular basis.  There was, of course, the idea to make a hexagonal one, but I wanted to bring something alive to the screen as quickly as possible, so the classic rectangular grid and 4 possible directions seemed the most successful choice. <br><br>  Next, it was necessary to decide, by which the population would be supported by hares and wolves.  As in the animal world, this role is assumed by the reproduction of organisms.  In the initial version, the choice fell on asexual breeding of hares and sexual reproduction for wolves.  In the first case, with a certain probability, each move the hare generates its own copy (as it was originally described in the problem), but the second case is much more interesting in implementation.  Wolves should have been of two sexes - female and male, and there would be no other differences at all.  The algorithm was extremely simple: if two wolves of opposite sexes met on the same cage, then a new wolf of a random sex was simply generated. <br><br>  Now you need to decide how to prevent the uncontrolled reproduction of creatures.  It was assumed that the population of hares will be controlled by the population of wolves, for which, in turn, the model of hunger is proposed in the original problem.  According to this model, wolves would lose certain ‚Äúpoints‚Äù of satiety every turn, replenish them by eating hares on the same cage and die when satiety became zero. <br><br>  It remains only to establish a behavior model for creatures.  The easiest thing was to take the initial behavior: let the hares be pieces of meat moving chaotically in space, and wolves aimlessly wandering predators until they notice the hare, after which they immediately begin to hunt. <br><br>  Java 8 was chosen as the implementation language simply because the most familiar technology, and the object-oriented language, was excellent for this kind of model.  For output, I used the graphical primitives of standard Java tools - after all, the model itself interested me a lot more than its presentation. <br><br><h1>  First pancake </h1><br>  Yes, he was a lump.  Initially, it seemed that the ecosystem would work the first time, but no.  The first problem I encountered was the poor survival of wolves: wolves did not always have time to multiply.  Yes, they hunted hares, but there was no interest in the opposite sex.  Only occasionally two wolves collided on the next cage, gave birth to the third and continued wandering aimlessly through the forest.  So I decided to add a few wolves to the map.  The first launch of a large pack of wolves into the forest showed how unstable the ecosystem is.  Let's speculate like a wolf (for definiteness - a male): we wander through the forest, if we meet a hare, then we eat.  If we meet a female, then we generate our own small copy.  And on the next move another small copy, because the female, most likely, did not have time to escape anywhere.  Moreover, the rules did not introduce any exclusive access to the partner, and in fact, the same wolf or wolf could be used to generate the third wolf more than once per turn.  The worst thing is that the newborn wolves immediately began to act on the same algorithm.  In such conditions, the growth of the wolf population occurred as an avalanche ‚Äî they did not even need to eat hares: new wolves were born completely fed, and for their satiety they had time to produce many more wolves than one. <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">breed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Visibility visibility)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    if (this.sex != Sex.FEMALE || !adult()) { return; } ... }</span></span></code> </pre> <br>  Such an alignment can hardly be called a success, so immediately attempts were made to modify the system.  The following restrictions have been added: <br><br><ol><li>  only the wolf generated a small wolf of random sex when it met the male (at least two new wolves appeared earlier); </li><li>  introduced the concept of "age" and "adulthood": wolves could breed only from a certain age.  Both wolves and hares became mortal.  This restriction was introduced to prevent a too strong explosion of the population; </li><li>  the concept of "visibility" was introduced: the wolf could analyze only objects that were within a certain radius (while on its cage), but did not know anything about objects beyond its limits; <br></li><li>  hares began to give more ‚Äúpoints‚Äù of fullness to compensate for the reduced efficiency of reproduction as a means of maintaining the population. </li></ol><br>  I will not intrigue - this was not enough.  The probability of birth of the hares allowed the species to not disappear, the age at a certain value (depending on the probability of generation of the hare) made it possible to limit them from above.  But the wolves then began to die out, because there were too few hares, they began to live right on the hares, because there were too many of them.  The system was unstable and very dependent on the initial parameters.  Definitely needed modifications to simulate a real ecosystem. <br><br><h1>  Balancing </h1><br>  It was decided to add a "pregnancy" for wolves.  The mechanic was that the new wolf did not appear immediately, but after a certain number of moves.  During the "pregnancy" wolf could not get pregnant again, which was supposed to save the effect of the explosion of the population. <br><br>  But nevertheless the survival rate of a wolf (as well as of any other living creature) strongly depends on the behavior model.  Therefore, the simplest implementation of the behavior of wolves was added.  For this, ‚Äúvisibility‚Äù turned out to be very useful - when we will transfer part of the objects of the world for analysis to a concrete being. <br><br><div class="spoiler">  <b class="spoiler_title">Wolves start guarding grass from hares</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/89e/19c/184/89e19c18474049d0808176a1425158b9.jpeg"><br>  <i>Brown squares</i> - asexual hares <br>  <i>Blue circles</i> - wolves <br>  <i>Yellow circles</i> - wolves <br></div></div><br>  The course of the creature becomes more complex - this required a certain refactoring.  Now clearly distinguished the phases of the course of creatures: <br><br><ul><li>  update ‚Äî updating natural creature counters: hunger (health), pregnancy, and age; </li><li>  move - the function of selecting the direction of movement from the state of the creature and the list of objects within the radius of visibility.  Hares move erratically, and wolves chase hares in the field of visibility and individuals of the opposite sex; </li><li>  feed - the wolf eats a hare in the same cage, while the hares feed on solar energy for the time being; </li><li>  multiply - a hare with a certain probability generates its own copy, the case of wolves is described above. </li></ul><br><h1>  The behavior of the wolf "reasonable" </h1><br>  The behavior of a creature in this system is a set of functions responsible for all the basic actions in which it is necessary to make a choice.  At that time, the choice of the wolf is determined only by the direction of movement (move). <br><br>  It seemed a good idea to separate the basic functions of the animal (update), which do not affect its choice and should occur automatically (rules) from the behavioral functions, which ideally should be replaced with more advanced versions in the development of algorithms.  Thus, the first version of the wolf "reasonable".  For further presentation, we introduce the concept of "object of interest" - a creature in the field of visibility, which can be potentially eaten or with which the continuation of the species is possible.  Wolf "reasonable" acted as follows: <br><br><ol><li>  all possible directions of movement are scored; </li><li>  determines whether the wolf wants to eat (if health is less than half); </li><li>  if the wolf wants to eat, then among the visible objects the closest object of interest is selected, which can be eaten (if there are several, then the first one that comes across); </li><li>  if the wolf does not want to eat, then among the visible objects the closest object of interest is selected, with which it is possible to multiply; </li><li>  returns the direction of movement to the selected object of interest; </li><li>  if there are no objects of interest, then the random direction of motion returns from the possible ones. </li></ol><br>  Such a scheme allowed the wolves to catch all the nearest hares rather quickly to maintain their own satiety, and also to get lost in the pack while allowing the feeling of hunger for quick access to the opposite sex.  However, such a world also degenerated: wolves remained in packs, occasionally eating rabbits running past, and slowly died, while hares bred with impunity at the other end of the world, which they subsequently seized.  It became clear that it was necessary to introduce complicating rules for hares as well, in order to prevent their uncontrolled reproduction. <br><br><div class="spoiler">  <b class="spoiler_title">And the result of such reproduction</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/483/fb8/7f7/483fb87f753144cb85d9c723545cc93d.jpeg"><br></div></div><br><h1>  The behavior of the hare "reasonable" </h1><br>  In the next version, hares have a desire to have a desire to live and, just like wolves, sex.  First, it was decided to try to add the "desire to eat." <br>  Now, for the existence of a hare, you need to maintain its own health scale.  Eating a hare will be grass, which slowly but surely grows under your feet (feeding on solar energy).  Initially, the idea was that the number of food units in the square should limit the population of hares from above.  Thus, using the parameters of grass growth and reducing the hares satiety, one could get a fairly accurate value of their maximum number on the island. <br><br>  To implement the ‚Äúdesire to eat‚Äù we add a simple algorithm for calculating the direction from the nearest predator.  However, with such rules, the wolf will never catch up with a single hare, so the concept of ‚Äúspeed‚Äù was introduced ‚Äî the number of complete life cycles ‚Äúmove‚Äù and ‚Äúeat‚Äù.  Thus, a fairly hungry wolf with a speed of 2 almost always catches up with a hare at a speed of 1 if he appears in his area of ‚Äã‚Äãvisibility.  So that the wolves did not interfere with each other, a slight unwillingness to move in the direction of a wolf of the same sex was added to their algorithm for calculating the target, because it is a competitor and can eat the hare earlier. <br><br>  And here, in the process of stabilizing the current model, it took me into my head to add a smell (in order to shatter the already fragile ecological balance even more).  The smell is left by the hares on the cell where they are located (the initial value of <i>S</i> ), each turn this value is reduced by a certain <i>dS</i> to zero.  Such a mechanism allowed to theoretically increase the appearance of the wolf, because if he was on a cage with the smell of <i>N</i> , then this meant that somewhere within <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.896ex" height="2.66ex" viewBox="0 -832 6843.9 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336330/&amp;xid=25657,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhWJYe5UdFvNNyBZufcM9fPODbKyA#MJMAIN-28" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336330/&amp;xid=25657,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhWJYe5UdFvNNyBZufcM9fPODbKyA#MJMATHI-53" x="389" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336330/&amp;xid=25657,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhWJYe5UdFvNNyBZufcM9fPODbKyA#MJMAIN-2212" x="1257" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336330/&amp;xid=25657,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhWJYe5UdFvNNyBZufcM9fPODbKyA#MJMATHI-4E" x="2257" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336330/&amp;xid=25657,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhWJYe5UdFvNNyBZufcM9fPODbKyA#MJMAIN-29" x="3146" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336330/&amp;xid=25657,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhWJYe5UdFvNNyBZufcM9fPODbKyA#MJMATHI-6F" x="3785" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336330/&amp;xid=25657,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhWJYe5UdFvNNyBZufcM9fPODbKyA#MJMATHI-76" x="4271" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336330/&amp;xid=25657,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhWJYe5UdFvNNyBZufcM9fPODbKyA#MJMATHI-65" x="4756" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336330/&amp;xid=25657,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhWJYe5UdFvNNyBZufcM9fPODbKyA#MJMATHI-72" x="5223" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336330/&amp;xid=25657,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhWJYe5UdFvNNyBZufcM9fPODbKyA#MJMATHI-64" x="5674" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336330/&amp;xid=25657,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhWJYe5UdFvNNyBZufcM9fPODbKyA#MJMATHI-53" x="6198" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-1"> (S - N) \ over dS </script>  cell is the hare who left him. <br><br>  The first dozen launches made it clear that nothing changes as a whole: the reproduction of hares overrides the need to eat, because it is easier to generate your own copy than to eat grass.  This means that it is necessary to hinder the reproduction of hares in a different way, and this will be the same reproduction as wolves, but with slightly different parameters: an increased probability of the appearance of more than one descendant and a reduced hare pregnancy.  Such a change will require greater rationality for hares, since now they need to eat, to flee from predators, and to multiply.  A similar algorithm has already been used for wolves, you just need to redefine the weight for food, predator, partner and competitor. <br><br>  However, negative weights do not want to work as expected along with positive ones.  So, you need to distribute the weight of each cell to its neighbors in descending order.  Now on the creature's scope, the central points, spreading the effect decreasing with distance (in the current implementation 1 for each step) are placed.  The result is a map of weights, according to which the creature ‚Äúrolls‚Äù into positive pits in order to achieve the desired. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//    static { VALUE_MAP.put(RegularRabbitTargetAttitude.PREDATOR, -20); VALUE_MAP.put(RegularRabbitTargetAttitude.COMPETITOR, -5); VALUE_MAP.put(RegularRabbitTargetAttitude.MATE, 10); VALUE_MAP.put(RegularRabbitTargetAttitude.FOOD, 10); } public Optional&lt;Position&gt; move(Visibility visibility) { //     Map&lt;Position, Set&lt;RegularRabbitTargetAttitude&gt;&gt; positionValues = updateWithUnits(visibility.units()); //     HashMap&lt;Position, Integer&gt; positionValueMap = positionValues.entrySet().stream() .collect(Collectors.toMap( Map.Entry::getKey, e -&gt; e.getValue().stream() .mapToInt(VALUE_MAP::get).sum(), Integer::sum, HashMap::new)); //     Map&lt;Position, Integer&gt; predatorValueMap = updateProliferatingValues(visibility, PREDATOR, positionValues); //        Map&lt;Position, Integer&gt; competitorValueMap = updateProliferatingValues(visibility, COMPETITOR, positionValues); //     () Integer foodCellValue = VALUE_MAP.get(FOOD); Map&lt;Position, Integer&gt; cellValues = visibility.cells() .collect(Collectors.toMap( Cell::getPosition, c -&gt; c.getGrass().getFoodCurrent() &gt;= c.getGrass().getFoodValue() ? foodCellValue : 0)); Map&lt;Position, Integer&gt; totalValueMap = CollectionUtils.mergeMaps( Integer::sum, predatorValueMap, competitorValueMap, positionValueMap, cellValues); return totalValueMap.entrySet().stream() .max(Comparator.comparingInt(Map.Entry::getValue)) .map(max -&gt; { List&lt;Direction&gt; availableDirections = Direction.shuffledValues() .filter(dir -&gt; !getPosition().by(dir) .adjustableIn( 0, 0, visibility.getWidth(), visibility.getHeight())) .collect(Collectors.toList()); return getPosition() .inDirectionTo(max.getKey(), availableDirections); }); } private Map&lt;Position, Integer&gt; updateProliferatingValues( Visibility visibility, RegularRabbitTargetAttitude key, Map&lt;Position, Set&lt;RegularRabbitTargetAttitude&gt;&gt; positionValues ) { List&lt;Position&gt; negativePositions = positionValues.entrySet().stream() .filter(e -&gt; e.getValue().contains(key)) .map(Map.Entry::getKey) .collect(Collectors.toList()); Integer epicenterValue = VALUE_MAP.get(key); return negativePositions.stream() .map(position -&gt; (Map&lt;Position, Integer&gt;) visibility.cells() .map(Cell::getPosition) .collect(Collectors.toMap( Function.identity(), pos -&gt; epicenterValue + position.distance(pos), Integer::sum, HashMap::new))) .reduce((map1, map2) -&gt; CollectionUtils.mergeMaps(Integer::sum, map1, map2)) .orElse(Collections.emptyMap()); } private Map&lt;Position, Set&lt;RegularRabbitTargetAttitude&gt;&gt; updateWithUnits( Stream&lt;LivingUnit&gt; units ) { Map&lt;Position, Set&lt;RegularRabbitTargetAttitude&gt;&gt; positionValues = new HashMap&lt;&gt;(); Map&lt;Position, List&lt;LivingUnit&gt;&gt; positionUnits = units.collect(Collectors.groupingBy(LivingUnit::getPosition)); positionUnits.forEach((key, value) -&gt; value.stream() .map(InterestUnit::new) .forEach(iu -&gt; { if (iu.asPredator != null) { positionValues.computeIfAbsent(key, (pos) -&gt; new HashSet&lt;&gt;()).add(PREDATOR); } if (iu.asMate != null) { RegularRabbitTargetAttitude attitude = goodPartner(iu.asMate) ? MATE : COMPETITOR; positionValues.computeIfAbsent(key, (pos) -&gt; new HashSet&lt;&gt;()).add(attitude); } })); return positionValues; }</span></span></code> </pre><br>  And this was the very point at which the system finally stabilized: the population of hares no longer grew uncontrollably, the wolves did not die out because of their "stupidity."  There was a balance in the world, and I set about optimizing and implementing additional amenities for the observer. <br><br>  You can see the story "in a section", as well as run and play <a href="https://github.com/Evlikat/siberian-forest">on github</a> . <br><br>  <b>Update.</b>  Already compiled version with a simple config <a href="https://github.com/Evlikat/siberian-forest/blob/master/bin">on github'e</a> </div><p>Source: <a href="https://habr.com/ru/post/336330/">https://habr.com/ru/post/336330/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336316/index.html">Basics of contractual work in IT: contractors and employees</a></li>
<li><a href="../336318/index.html">Automatic sales funnels: technical implementation</a></li>
<li><a href="../336320/index.html">Linux redirection</a></li>
<li><a href="../336326/index.html">How complex automation can help if you have a small business</a></li>
<li><a href="../336328/index.html">Creating a quiz on Vue.js</a></li>
<li><a href="../336332/index.html">Fish, fish: how to use the "data lake" in the bank. VTB experience</a></li>
<li><a href="../336334/index.html">Paraquire, or Stop Trusting Libraries</a></li>
<li><a href="../336336/index.html">OCaml and RESTful JSON API using Eliom</a></li>
<li><a href="../336338/index.html">Accelerate Viola-Jones Method</a></li>
<li><a href="../336342/index.html">Agents, principals and online ticket booths in between</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>