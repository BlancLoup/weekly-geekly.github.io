<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Attached properties to restrict text input.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="WPF is no longer a new technology on the market, but relatively new to me. And, as often happens when learning something new, there is a desire / need...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Attached properties to restrict text input.</h1><div class="post__text post__text-html js-mediator-article">  WPF is no longer a new technology on the market, but relatively new to me.  And, as often happens when learning something new, there is a desire / need to invent bicycles with square wheels and alloy wheels to solve some typical tasks. <br><br>  One such task is to limit user input to certain data.  For example, we want to allow only integer values ‚Äã‚Äãto be entered in some text field, and a date in a specific format to another, and only floating-point numbers to the third.  Of course, the final validation of such values ‚Äã‚Äãwill still occur in the view models, but such input restrictions make the user interface more friendly. <br><br>  In Windows Forms, this task was solved fairly easily, and when the same TextBox from DevExpress was available with the built-in ability to limit input using regular expressions, then everything was generally simple.  There are <a href="http://lurkmore.to/%25D0%25A1%25D1%2582%25D0%25BE%25D0%25BF%25D0%25B8%25D1%2586%25D0%25BE%25D1%2582">quite a few</a> examples of solving the same problem in WPF, most of which boil down to one of two options: using a <a href="http://msdn.microsoft.com/en-us/library/system.windows.controls.textbox.aspx">TextBox</a> class heir or adding <a href="http://msdn.microsoft.com/en-us/library/ms749011.aspx">attached property</a> with necessary restrictions. <br><a name="habracut"></a><br>  <font color="#526e66"><strong>NOTE</strong></font> <font color="#526e66"><strong><br></strong></font>  <font color="#526e66">If you are not very interested in my reasoning, and you need code samples right away, then you can either download the entire</font> <a href="https://github.com/SergeyTeplyakov/WpfEx"><font color="#526e66">WpfEx</font></a> <font color="#526e66">project</font> <a href="https://github.com/SergeyTeplyakov/WpfEx"><font color="#526e66">from GitHub</font></a> <font color="#526e66">, or download the main implementation contained in</font> <a href=""><font color="#526e66">TextBoxBehavior.cs</font></a> <font color="#526e66">and</font> <a href=""><font color="#526e66">TextBoxDoubleValidator.cs</font></a> <font color="#526e66">.</font> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Well, let's get started? </h5><br><br>  Since inheritance introduces a rather rigid restriction, I personally prefer using attached properties in this case, since this mechanism allows you to limit the application of these properties to controls of a certain type (I don‚Äôt want this attached property <strong>IsDouble to</strong> be applied to TextBlock for which it does not make sense). <br>  In addition, you should take into account that when restricting user input, you cannot use any specific separators for the integer and fractional parts (such as '.' (Dot) or ',' (comma)), as well as the '+' and '-', since it all depends on the user's regional settings. <br>  To realize the possibility of restricting data entry, we need to intercept the data entry event by the user as a student, analyze it and cancel these changes if they do not suit us.  Unlike Windows Forms, in which the use of a pair of events <strong>XXXChanged</strong> and <strong>XXXChanging is taken</strong> , WPF uses for these purposes Preview versions of events that can be processed in such a way that the main event does not work.  (A classic example is the handling of mouse or keyboard events that prohibit certain keys or their combinations). <br><br>  And everything would be nice if the <a href="http://msdn.microsoft.com/en-us/library/system.windows.forms.textbox.aspx">TextBox</a> class together with the <a href="http://msdn.microsoft.com/en-us/library/system.windows.forms.control.textchanged.aspx">TextChanged</a> event would also <strong>contain a PreviewTextChanged</strong> , which could be processed and ‚Äúinterrupted‚Äù by the user if we consider the text to be entered incorrect.  And since it does not exist, it is necessary for everyone to invent their foolish fools. <br><br><h5>  The solution of the problem </h5><br><br>  The solution of the problem is reduced to the creation of the TextBoxBehavior class containing the attached property IsDoubleProperty, after setting which the user cannot enter anything except the symbols +, -, in this text field.  (separator of the whole and fractional parts), as well as numbers (do not forget that we need to use the settings of the current stream, and not the hard-coded values). <br><br><pre><code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> TextBoxBehavior { // Attached   ,     //     <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static readonly DependencyProperty IsDoubleProperty = DependencyProperty.RegisterAttached( "IsDouble", typeof (<span class="hljs-type"><span class="hljs-type">bool</span></span>), typeof (TextBoxBehavior), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FrameworkPropertyMetadata(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, OnIsDoubleChanged)); //      IsDouble     // UI ,  TextBox    [AttachedPropertyBrowsableForType(typeof (TextBox))] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">bool</span></span> GetIsDouble(DependencyObject element) {} <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> SetIsDouble(DependencyObject element, <span class="hljs-type"><span class="hljs-type">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) {} // ,   TextBoxBehavior.IsDouble="True"  XAML- private static <span class="hljs-type"><span class="hljs-type">void</span></span> OnIsDoubleChanged(DependencyObject d, DependencyPropertyChangedEventArgs e) { //   } }</code> </pre> <br><br>  The main difficulty in implementing the <strong>PreviewTextInput</strong> handler (as well as the text paste events from the clipboard) is that the event arguments are not transmitted the total value of the text, but only the newly entered part of it.  Therefore, the summary text must be formed manually, taking into account the possibility of selecting text in a TextBox, the current position of the cursor in it and, possibly, the state of the Insert button (which we will not analyze): <br><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ ,   TextBoxBehavior.IsDouble="True"  XAML- private static void OnIsDoubleChanged(DependencyObject d, DependencyPropertyChangedEventArgs e) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     attached    /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ TextBox   ,    -  var textBox = (TextBox) d; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       : /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 1.     /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 2.      textBox.PreviewTextInput += PreviewTextInputForDouble; DataObject.AddPastingHandler(textBox, OnPasteForDouble); }</span></span></code> </pre><br><br><h5>  Class TextBoxDoubleValidator </h5><br><br>  The second important point is the implementation of the validation logic of the newly entered text, responsibility for which is assigned to the <strong>IsValid</strong> method of a separate <strong>TextBoxDoubleValidator</strong> class. <br><br>  The easiest way to understand how the <strong>IsValid</strong> method of this class should behave is to write a unit test for it that covers all corner case (this is just one of those cases when parameterized unit tests rule with terrible force): <br><br>  <font color="#526e66"><strong>NOTE</strong></font> <font color="#526e66"><br></font>  <font color="#526e66">This is exactly the case when a unit test is not just a test that checks the correctness of the implementation of a certain functionality.</font>  <font color="#526e66">This is exactly the case that Kent Beck repeatedly referred to, describing accountability;</font>  <font color="#526e66">After reading this test, you can understand what the developer of the validation method was thinking about, ‚Äúreuse‚Äù his knowledge and find errors in his reasoning and, thus, probably in the implementation code.</font>  <font color="#526e66">This is not just a test suite - this is an important part of the specification of this method!</font> <br><br><pre> <code class="hljs pgsql">private static <span class="hljs-type"><span class="hljs-type">void</span></span> PreviewTextInputForDouble(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, TextCompositionEventArgs e) { // e.Text    ,     //  TextBox-   var textBox = (TextBox)sender; string fullText; //  TextBox   ,     e.Text <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (textBox.SelectionLength &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { fullText = textBox.Text.Replace(textBox.SelectedText, e.Text); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //          fullText = textBox.Text.<span class="hljs-keyword"><span class="hljs-keyword">Insert</span></span>(textBox.CaretIndex, e.Text); } //     <span class="hljs-type"><span class="hljs-type">bool</span></span> isTextValid = TextBoxDoubleValidator.IsValid(fullText); //    TextChanged    e.Handled = !isTextValid; }</code> </pre><br><br>  The test method returns <strong>true</strong> if the <strong>text</strong> parameter is valid, and this means that the corresponding text can be inserted into the <strong>TextBox</strong> with the IsDouble property attached.  Pay attention to a few points: (1) use the <strong>SetCulture</strong> attribute, which sets the desired locale and (2) on some input values, such as ‚Äú-.‚Äù, Which are not valid values ‚Äã‚Äãfor the <strong>Double</strong> type. <br><br>  Explicit setting of the locale is needed so that tests do not fall off developers with other personal settings, because in the Russian locale, the symbol ',' (comma) is used as a separator, and in the US -.  (point).  Strange text such as ‚Äú-.‚Äù Is correct, since we must complete the input if the user wants to enter the string ‚Äú-.1‚Äù, which is the correct value for <strong>Double</strong> .  (It is interesting that on StackOverflow for solving this task it is often advised to simply use <a href="http://msdn.microsoft.com/ru-ru/library/system.double.tryparse.aspx">Double.TryParse</a> , which obviously will not work in some cases). <br><br>  <font color="#526e66"><strong>NOTE</strong></font> <font color="#526e66"><br></font>  <font color="#526e66">I do not want to clutter up the article with details of the implementation of the <strong>IsValid</strong> method, I just want to note the use of <a href="http://msdn.microsoft.com/en-us/library/dd642243.aspx">ThreadLocal &lt;T&gt;</a> in the body of this method, which allows you to get and <strong>DoubleSeparator</strong> local for each stream.</font>  <font color="#526e66">The full implementation of the <strong>TextBoxDoubleValidator.IsValid</strong> method can be found <a href="">here</a> , more information about <strong>ThreadLocal &lt;T&gt;</strong> can be found in Joe Albahari's article <a href="http://sergeyteplyakov.blogspot.com/2010/08/c-3.html">Working with Threads.</a></font>  <font color="#526e66"><a href="http://sergeyteplyakov.blogspot.com/2010/08/c-3.html">Part 3</a></font> <br><br><h5>  Alternative solutions </h5><br><br>  In addition to intercepting the <strong>PreviewTextInput</strong> event and pasting text from the clipboard, there are other solutions.  So, for example, I met an attempt to solve the same problem by intercepting the <strong>PreviewKeyDown</strong> event with filtering all keys except the digital ones.  However, this solution is more complicated, since you still have to bother with the ‚Äútotal‚Äù state of the TextBox, and theoretically, the integer and fractional part separator can be not one character, but an entire string ( <a href="http://msdn.microsoft.com/en-us/library/system.globalization.numberformatinfo.numberdecimalseparator.aspx">NumberFormatInfo.NumberDecimalSeparator</a> returns <strong>string</strong> , not <strong>char</strong> ). <br>  There is another option in the <strong>KeyDown event</strong> to keep the previous state of <strong>TextBox.Text</strong> , and in the <strong>TextChanged</strong> event <strong>,</strong> return the old value to it if the new value does not suit.  But this solution looks unnatural, and it will not be so easy to implement it using attached properties. <br><br><h5>  Conclusion </h5><br><br>  When we last discussed with colleagues the lack of useful and very typical features in WPF, we came to the conclusion that there is an explanation for this, and there is a positive side to this.  The explanation comes down to the fact that there is no way out of the <a href="http://sergeyteplyakov.blogspot.com/2011/10/blog-post_26.html">law of leaky abstractions,</a> and WPF, being an ‚Äúabstraction‚Äù rather complicated, flows like a sieve.  The useful side is that the lack of some useful features sometimes makes us think (!) And not forget that we are programmers, not masters of paste and paste. <br><br>  I recall that the full implementation of the classes of classes, examples of their use and unit tests can be found on <a href="https://github.com/SergeyTeplyakov/WpfEx">github</a> . <br></div><p>Source: <a href="https://habr.com/ru/post/137822/">https://habr.com/ru/post/137822/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137815/index.html">Microsoft has released the OneNote application for Android</a></li>
<li><a href="../137817/index.html">Lightpack 6 is available for pre-order.</a></li>
<li><a href="../137818/index.html">"Noodles" from callbacks - keep it simple</a></li>
<li><a href="../137820/index.html">We collect sensor readings from an Android smartphone. Bug work</a></li>
<li><a href="../137821/index.html">Presentation: "Sphinx - full-text search on the site, easy and accessible"</a></li>
<li><a href="../137823/index.html">Prayer "Our C"</a></li>
<li><a href="../137824/index.html">Everything in the cloud, part 2</a></li>
<li><a href="../137825/index.html">Community or social network?</a></li>
<li><a href="../137828/index.html">ZFConf 2012 will be held in the spring in Moscow - pre-registration is open</a></li>
<li><a href="../137830/index.html">Release ReactOS 0.PI (0.3.14)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>