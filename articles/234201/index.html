<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Increase disk subsystem performance in the next release of the XenServer hypervisor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Transfer. The original article is available on the Xen blog . 
 The author is Felipe Franciosi . 

 The latest test builds of XenServer Creedence Alph...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Increase disk subsystem performance in the next release of the XenServer hypervisor</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c11/07a/89d/c1107a89da604c2fb82bfbc9177ec8fb.jpg"><br>  <i>Transfer.</i>  <i>The original article is available <a href="http://xenserver.org/discuss-virtualization/virtualization-blog/entry/tapdisk3.html">on the Xen blog</a> .</i> <br>  <i>The author is <a href="http://xenserver.org/discuss-virtualization/virtualization-blog/blogger/listings/franciozzy.html">Felipe Franciosi</a> .</i> <br><br>  The latest test builds of <a href="http://xenserver.org/component/content/article.html%3Fid%3D142">XenServer Creedence Alpha</a> are notable for their increased disk subsystem performance compared to XenServer 6.2 (see the details in Marcus Granado's blog - <a href="http://xenserver.org/blog/entry/overview-of-the-performance-improvements-between-xenserver-6-2-and-creedence-alpha-2.html">Performance Improvements in Creedence</a> ).  In general, the improvements are related to the introduction of a new disk subsystem architecture - tapdisk3.  We will describe this technology of organizing virtual storage, as well as present and explain the results of experiments in which the performance of approximately 10Gb / s is achieved by a single host with connected cluster storage. <br><br>  A few months ago, I wrote about the project Karcygwins, which included a series of experiments and studies aimed at studying the features of disk I / O.  We focused on the case where a load is generated by one VM with one virtual disk.  In particular, we were interested in understanding the nature of additional costs (overhead) for virtualization, especially on devices with low latencies, for example, modern SSDs.  By comparing the different ways of virtualizing disk I / O available to the user (that is, blktap and blktap2), we were able to explain where and why additional costs arise, as well as how to significantly reduce them.  More information about the project Karcygwins can be found at the <a href="http://xenserver.org/blog/entry/karcygwins.html">link.</a> <br><a name="habracut"></a><br>  From this point on, we expanded the range of studies for cases with a more complex load structure.  We were especially interested in the joint load from several VMs, which completely loaded the storage.  We studied the features of the tapdisk3 subsystem developed for XenServer by Thanos Makatos.  Tapdisk3 is written to simplify the architecture and bring it fully into user space, and this, in turn, leads to a significant increase in performance. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are two major differences between tapdisk2 and tapdisk3.  The first is the way tapdisk connects to the disk I / O subsystem: the old tapdisk accesses the blkback and blktap2 devices inside the hypervisor, and the new one directly to the paravirtual driver inside the VM.  The second is the method by which the guest VM and the hypervisor exchange data: the old tapdisk uses access to the displayed memory pages in the VM memory and then copies them to the address space of the hypervisor, while the second uses a copy-on-access technology (grant copy). <br><br>  All other modifications are necessary in order to make such a change in architecture possible.  Most of them affect the level of control of virtual machines (control plane).  To do this, we changed the control stack (xapi) so that it maintains constant communication with the tapdisk module.  Because of these changes (and also because of some others related to how tapdisk3 is processing incoming data), the way the virtual disk is represented in the hypervisor's memory has changed.  Since tapdisk3 has not yet been officially released, other changes are possible in the future. <br>  To measure the performance achieved within tapdisk3, we chose the fastest server and fastest storage available to us. <br><ul><li>  Dell PowerEdge R720 Platform </li><li>  64 GB RAM </li><li>  Intel Xeon E5-2643 v2 @ 3.5 GHz processor </li><li>  2 sockets, 6 cores per socket, hyperthreading = 24 pCPU </li><li>  Turbo Frequency - 3.8 GHz </li><li>  The hypervisor CPU scheduler is switched to ‚ÄúPerformance‚Äù mode (by default, it is set to ‚ÄúOn Demand‚Äù to save power).  Rachel Berry (Rachel Berry) in <a href="http://xenserver.org/partners/developing-products-for-xenserver/19-dev-help/138-xs-dev-perf-turbo.html">her blog</a> described the work scheduler in more detail. </li><li>  The BIOS is set to Performance per Watt (OS), the Maximum C-State mode is set to 1 </li><li>  4 x Micron P320 PCIe SSD (175 GB each) </li><li>  2 x Intel 910 PCIe SSD (400 GB each) </li><li>  Each of them is represented as 2 SCSI devices of 200 GB each (total - 4 devices and 800 GB in total) </li><li>  1 x Fusion-io ioDrive2 (785 GB) </li></ul><br><br>  After installing XenServer Creedence with build number 86278 (about 5 numbers older than <a href="http://xenserver.org/overview-xenserver-open-source-virtualization/download/11-product/142-download-pre-release.html">XenServer Creedence Alpha 2</a> ) and Fusion-io drives, we created a storage on each available device.  It turned out 9 storage and approximately 2.3 TB of free space.  On each storage we created 10 virtual disks in RAW format of 10 GB each.  We connected each virtual disk with its virtual machine, choosing disks ‚Äúin a circle,‚Äù as shown in the diagram below.  Ubuntu 14.04 (x86_64 architecture, 2 logical CPUs not rigidly tied to real, 1024 MB of RAM) was chosen as the guest OS.  We also passed 24 logical CPUs to the hypervisor and decided not to associate them with real ones (in the <a href="http://support.citrix.com/article/CTX139714">XenServer 6.2.0 CTX139714</a> article, the methodology for linking logical CPUs to real ones is described in more detail). <br><br><img src="https://habrastorage.org/files/cda/813/916/cda813916ee840688194d321078d6121.png"><br><br>  First, we measured the aggregate channel performance between the hypervisor and the virtual machine, if the disks are connected in the standard way tapdisk2 &lt;-&gt; blktap2 &lt;-&gt; blkback.  To do this, we forced one virtual machine to send 10-second write requests to all of its disks at the same time, and then calculated the total amount of data transferred.  Request size ranged from 512 bytes to 4 MB.  After that, we increased the number of virtual machines to 10, and then changed the write requests with read requests.  The result is shown in the graphs below: <br><br><img src="https://habrastorage.org/files/55d/ca1/c82/55dca1c826fa4171bc6836dcce3c568e.png"><br><br><img src="https://habrastorage.org/files/5ad/b0a/cbb/5adb0acbb16745faa2b356a3aec5171a.png"><br><br>  Measurements have shown that virtual machines are not able to access the disk at a speed of more than 4 Gb / s.  Then we repeated the experiment using tapdisk3.  The result has clearly improved: <br><br><img src="https://habrastorage.org/files/9b3/f0f/ec7/9b3f0fec71504dbf87bbdfd65a566f55.png"><br><br><img src="https://habrastorage.org/files/72a/2a0/54b/72a2a054bedd42af8983d419f342d06f.png"><br><br>  In the case of writing, the aggregate throughput of the disk subsystem for all VMs reaches 8 Gb / s, in the case of reading - 10 Gb / s.  From the graph it follows that in some cases the performance of tapdsik3 is greater than the performance of tapdisk2 approximately 2 times per write and 2.5 times per read. <br><br>  To understand why tapdisk3 is so superior to tapdisk2 in performance, you should first consider the virtual storage subsystem architecture, which is used by para-virtual VMs and hypervisor.  We will focus on the components that XenServer and a regular VM running Linux use.  However, it should be borne in mind that the information outlined below is also relevant for VMs running Windows, if this OS uses the installed para-virtual drivers. <br><br>  As a rule, a guest VM running Linux loads a driver called blkfront when it starts.  From the point of view of the guest VM, this is a regular block device.  The difference is that instead of interacting with real hardware, blkfront communicates with the blkback driver in the body of the hypervisor via shared memory and the event channel, which is used to transfer interrupts between domains. <br><br>  Applications inside the guest OS initiate read or write operations (via libc, libaio, etc.) of files or directly block devices.  Operations are ultimately translated into requests for block devices and are transmitted by blkfront through randomly selected memory pages in the guest's address space.  Blkfront, in turn, provides the hypervisor with access to these pages in such a way that blkback can read and write to them.  This type of access is called ‚Äúgranting access to the displayed memory pages‚Äù (grant mapping). <br><br><img src="https://habrastorage.org/files/4f4/b22/d3f/4f4b22d3fc944b3b9e07e0ee25d11e5e.png"><br><br>  Despite the fact that the Xen Project developer community is campaigning to improve the scalability and performance of the mechanism for accessing the displayed pages, there is still a lot of work because the system is complex and has several limitations, especially regarding sharing access to storage from several VMs.  The most notable recent change is a <a href="http://lists.xen.org/archives/html/xen-devel/2013-11/msg01518.html">patch</a> set <a href="http://lists.xen.org/archives/html/xen-devel/2013-11/msg01518.html">by Matt Wilson</a> to improve the locking mechanism and better performance. <br><br>  To reduce the additional cost of allocating and freeing memory for each request in the access mechanism for the displayed pages, Roger Pau Monne implemented the blkback / blkfront protocol with an innovation called ‚Äúpersistent grant‚Äù.  Such access can be used if both domains (hypervisor and VM) support it.  In this case, blkfront provides blkback with access to a permanent page set, and both drivers use this set as long as they can. <br><br>  The downside is that blkfront cannot indicate which pages will be associated with the request received from the block level device of the guest VM.  In any case, it has to copy the data from the request to this set before sending the request to blkback.  However, even if we take into account this copying operation, access to permanent addresses remains a good method for increasing scalability while simultaneously I / O from several VMs. <br><br><img src="https://habrastorage.org/files/fe3/a91/bf8/fe3a91bf8e344c10ae1f325e6565b831.png"><br><br>  Both of the above changes are fully implemented in the hypervisor kernel space.  However, we do not take into account that the request to the block level of the hypervisor contains a link to pages in the guest address space.  This can cause a race condition when using network storage, such as NFS, and possibly iSCSI: if the network packet (which contains a pointer to the exchange page) is queued for retransmission and the transfer of the original packet is received, the hypervisor can resubmit incorrect data or even crash, because the exchange page may either contain incorrect data or be released altogether. <br><br>  To avoid problems, XenServer copies pages to the hypervisor instead of using them directly.  This feature first appeared in the blktap2 driver and the tapdisk2 component, along with technologies for allocating space on demand (thin-provisioning) and moving VM disks between storage systems (Storage Motion).  Within this architecture, blktap2 copies pages before transferring them to tapdisk2 to ensure the secure operation of network storage.  For the same reason, blktap2 provides the hypervisor with a full-featured block device for each virtual disk, regardless of its nature (including thin-provisioned thin-provisioning disks hosted on NFS storage). <br><br><img src="https://habrastorage.org/files/ee8/13b/355/ee813b3559d6489584a73bec0b5f39c3.png"><br><br>  As we see from the results of the above measurements, this technology has limitations.  It is good for various types of classic storage, but demonstrates poor performance when working with modern storage media, such as SSD disks connected directly to the server via a PCIe bus.  To take into account recent changes in data storage technology, XenServer Creedence will contain a new component - tapdisk3, which uses another method of memory access - grant copy. <br><br>  Starting with the 3.x kernel version as the hypervisor domain (dom0) and the advent of the access device (gntdev), we have accessed the pages of other domains directly from the hypervisor's user space.  This technology is implemented in tapdisk3 and uses the gntdev device, as well as the evtchn event channel, to exchange data directly with the blkfront. <br><br>  Copying on access is much faster than just granting access to permanent addresses, and then copying.  With this access, most of the operations are performed inside the Xen Project Hypervisor core, in addition, the presence of data in the address space of the hypervisor domain is ensured for the secure operation of network storage.  Also, since the logic is implemented entirely in user space, the inclusion of additional functionality (such as thin-provisioning, snapshots, or Storage Motion) does not create any particular difficulties.  To provide the hypervisor access to the block device, the corresponding virtual machine disk (for copying the disk and other operations) we connect tapdisk3 to blktap2 <br><br><img src="https://habrastorage.org/files/4df/d5e/96b/4dfd5e96b70f435fbf380deb21599758.png"><br><br>  Last (but not least), what we wanted to write about: a sophisticated reader may ask why XenServer does not use the capabilities of qemu-qdisk, which implements the technology of accessing permanent addresses in user space?  The fact is that, to ensure the safe operation of network storage (including access to permanent addresses, in which the request to the storage refers to pages in the memory of the guest VM), qemu-qdisk clears the O_DIRECT flag when accessing virtual disks.  This causes the data to be copied to the hypervisor domain cache, which ensures secure access to the data.  Thus, access to permanent addresses in this case leads to redundant copying and delays in servicing requests.  We believe that copying on access is a better alternative than qemu-qdisk. </div><p>Source: <a href="https://habr.com/ru/post/234201/">https://habr.com/ru/post/234201/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234183/index.html">Conversion optimization: ruthless criticism of 10 landing pages</a></li>
<li><a href="../234185/index.html">Probably the easiest way to overcome stress on your way to your goal.</a></li>
<li><a href="../234191/index.html">DEF CON CTF 22 Final</a></li>
<li><a href="../234195/index.html">GNS3 1.0 beta and Cisco IOU</a></li>
<li><a href="../234197/index.html">Microsoft has built Bing search engine in the context menu of Skype</a></li>
<li><a href="../234203/index.html">How does the camera rotate in 3D games or what is a rotation matrix</a></li>
<li><a href="../234211/index.html">Personal cloud on Raspberry Pi and development of uninterruptible power supply for it</a></li>
<li><a href="../234213/index.html">Acceptance test planning for a cloud site</a></li>
<li><a href="../234215/index.html">A little research on the use of functors in the standard library STL C ++</a></li>
<li><a href="../234219/index.html">Medical anatomical illustration - the history of the study of the human body in the atlases of 5 centuries. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>