<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About security in Meteor and not only (part 2)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are not scared by the first part , I suggest to continue the conversation about the security mechanisms of Meteor. Starting with the loginToken...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About security in Meteor and not only (part 2)</h1><div class="post__text post__text-html js-mediator-article">  If you are not scared by the <a href="http://habrahabr.ru/post/211002/">first part</a> , I suggest to continue the conversation about the security mechanisms of Meteor.  Starting with the <a href="https://habr.com/ru/post/211020/">loginToken</a> issued to the client, <a href="https://habr.com/ru/post/211020/">allow / deny rules</a> when the client <a href="https://habr.com/ru/post/211020/">modifies</a> the database, touch <a href="https://habr.com/ru/post/211020/">trusted and untrusted code</a> , <a href="https://habr.com/ru/post/211020/">server methods</a> , <a href="&amp;xid=17259,15700022,15700186,15700190,15700253,15700256&amp;usg=ALkJrhjASYOYAvt7FXTwB8Z5hhoU0gfitQ#">use of HTTPS and force-ssl</a> , <a href="https://habr.com/ru/post/211020/">browser-policy</a> (Content Security Policy and X-Frame-Options), and finish with the <a href="https://habr.com/ru/post/211020/">built-in data validation mechanism</a> (the check () function and the audit-arguments-check package). <br><a name="habracut"></a><br><a name="loginToken"></a><h4>  loginToken </h4><br>  After authorization, the client receives a temporary token that authorizes the current user, which is stored in localStorage: <br><pre><code class="javascript hljs">&gt; localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"Meteor.loginToken"</span></span>) <span class="hljs-string"><span class="hljs-string">"eEg4T3fNPGLns7MfY"</span></span></code> </pre> <br>  Strictly speaking, it is stored in the <a href="">Meteor._locaStorage</a> object, which is a window.localStorage wrapper for browsers that support it. <br>  You can also find out this token through the object Accounts: <br><pre> <code class="javascript hljs">Accounts._storedLoginToken()</code> </pre><br>  The same token is stored on the server in the <a href="http://docs.meteor.com/">Meteor.users</a> collection: <br><pre> <code class="javascript hljs">&gt; Meteor.user().services.resume { <span class="hljs-string"><span class="hljs-string">"loginTokens"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"token"</span></span>:<span class="hljs-string"><span class="hljs-string">"DXC3BqekpPy97fmYs"</span></span>, <span class="hljs-string"><span class="hljs-string">"when"</span></span>:<span class="hljs-string"><span class="hljs-string">"2014-01-31T10:53:54.347Z"</span></span> } ] }</code> </pre> <br>  Of course, in the browser console this field is available only if it is explicitly published. <br><br>  Any browser that has a pair of token + user ID is considered authorized.  To verify this, you can log in to the browser and get the current loginToken and userId: <br><pre> <code class="javascript hljs">localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"Meteor.loginToken"</span></span>); localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"Meteor.userId"</span></span>);</code> </pre><br>  Then install them in another browser: <br><pre> <code class="javascript hljs">localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"Meteor.loginToken"</span></span>, <span class="hljs-string"><span class="hljs-string">"'+loginToken+'"</span></span>); localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"Meteor.userId"</span></span>, <span class="hljs-string"><span class="hljs-string">"'+userId+'"</span></span>);</code> </pre><br>  And in a few moments the browser session will be authorized. <br><br><h6>  Token lifetime </h6><br>  The token exists until the user logs out, or the timeout specified by the parameter has expired (60 days by default): <br><pre> <code class="javascript hljs">Accounts.config({<span class="hljs-attr"><span class="hljs-attr">loginExpirationInDays</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>})</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="allow_deny"></a><h4>  Restricting a client to change a collection - <a href="http://docs.meteor.com/">allow</a> / <a href="http://docs.meteor.com/">deny</a> rules </h4><br>  If we try to change the services subdocument, it will not work out of the browser: <br><pre> <code class="javascript hljs">&gt; Meteor.users.update({ <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: Meteor.userId() }, {<span class="hljs-attr"><span class="hljs-attr">$set</span></span>: { <span class="hljs-string"><span class="hljs-string">"services.test"</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span> } }) <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> update failed: Access denied</code> </pre><br>  This happens because on the server access to this document is restricted by <a href="http://docs.meteor.com/">allow</a> / <a href="http://docs.meteor.com/">deny</a> rules.  Let's see how this mechanism is implemented in the <a href="">accounts-base</a> package source code: <br><pre> <code class="javascript hljs">Meteor.users.allow({ <span class="hljs-comment"><span class="hljs-comment">// clients can modify the profile field of their own document, and // nothing else. update: function (userId, user, fields, modifier) { // make sure it is our record if (user._id !== userId) return false; // user can only modify the 'profile' field. sets to multiple // sub-keys (eg profile.foo and profile.bar) are merged into entry // in the fields list. if (fields.length !== 1 || fields[0] !== 'profile') return false; return true; }, fetch: ['_id'] // we only look at _id. });</span></span></code> </pre><br>  From the code it can be seen that only the document whose userId matches the current user is allowed to change, and you can make changes only in the sub-document profile.  The fetch parameter tells Meteor that it is not necessary to receive the entire modified document for checking the credentials (it can be large); only one _id field is enough for checking.  Since the allow rule is declared only for the update operation, the insert and remove operations for the client are prohibited: <br><pre> <code class="javascript hljs">&gt; Meteor.users.insert({}) <span class="hljs-string"><span class="hljs-string">"qs8HbcSDjgbgb3vgS"</span></span> insert failed: Access denied. No allow validators set on restricted collection <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> method <span class="hljs-string"><span class="hljs-string">'insert'</span></span>.</code> </pre><br>  With the deny rule, you can disable the operation allowed by allow.  That is, if one of the allow rules (more than one rule can be specified) returns true, then this permission can be blocked if one of the deny rules returns true, and the record will be denied in this case, despite allow rules. <br><br><h5>  Verification of access rights to subdocuments </h5><br>  With the update operation, verification capabilities are somewhat limited.  For example, if it is necessary to prohibit writing to any field of a subdocument, for example, doc.field1, but allowing it to another field, for example, doc.field2 of our test collection, this will not work.  Let us see which parameters are transferred in this case to the rule by adding on the server the output of the input parameters for the allow and deny rules: <br><pre> <code class="javascript hljs">Test.allow({ <span class="hljs-attr"><span class="hljs-attr">update</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">userId, document, fields, modifier</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Test.allow(): userId:'</span></span>, userId, <span class="hljs-string"><span class="hljs-string">'; document:'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>, <span class="hljs-string"><span class="hljs-string">'; fields:'</span></span>, fields, <span class="hljs-string"><span class="hljs-string">'; modifier:'</span></span> , modifier); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }); Test.deny({ <span class="hljs-attr"><span class="hljs-attr">update</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">userId, document, fields, modifier</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Test.deny(): userId:'</span></span>, userId, <span class="hljs-string"><span class="hljs-string">'; document:'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>, <span class="hljs-string"><span class="hljs-string">'; fields:'</span></span>, fields, <span class="hljs-string"><span class="hljs-string">'; modifier:'</span></span> , modifier); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } });</code> </pre><br>  And perform the update operation for the doc.field1 field, having previously recognized the _id of one of the documents (make sure that the Test collection has the necessary fields published by setting the variable projection = {} in the code of our example, otherwise the result will not be visible): <br><pre> <code class="javascript hljs">&gt; Test.findOne({<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"FG7FaQqYgB7Rs9RDy"</span></span>}) <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span> {<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"FG7FaQqYgB7Rs9RDy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"First"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>} &gt; Test.update({<span class="hljs-attr"><span class="hljs-attr">_id</span></span>:<span class="hljs-string"><span class="hljs-string">"FG7FaQqYgB7Rs9RDy"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">$set</span></span>: { <span class="hljs-string"><span class="hljs-string">"doc.field1"</span></span>: <span class="hljs-string"><span class="hljs-string">"value1"</span></span> } } ) <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &gt; Test.findOne({<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"FG7FaQqYgB7Rs9RDy"</span></span>}) <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span> {<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"FG7FaQqYgB7Rs9RDy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"First"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">doc</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>} &gt; Test.findOne({<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"FG7FaQqYgB7Rs9RDy"</span></span>}).doc.field1 <span class="hljs-string"><span class="hljs-string">"value1"</span></span></code> </pre><br>  The server log will display: <br><pre> <code class="javascript hljs">I20140131<span class="hljs-number"><span class="hljs-number">-13</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">27.582</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>)? Test.deny(): userId: kL7Fkuk29ci4vz8q4 ; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>: { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">'FG7FaQqYgB7Rs9RDy'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'First'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } ; fields: [ <span class="hljs-string"><span class="hljs-string">'doc'</span></span> ] ; modifier: { <span class="hljs-string"><span class="hljs-string">'$set'</span></span>: { <span class="hljs-string"><span class="hljs-string">'doc.field1'</span></span>: <span class="hljs-string"><span class="hljs-string">'value1'</span></span> } } I20140131<span class="hljs-number"><span class="hljs-number">-13</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">27.582</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>)? Test.allow(): userId: kL7Fkuk29ci4vz8q4 ; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>: { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">'FG7FaQqYgB7Rs9RDy'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'First'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } ; fields: [ <span class="hljs-string"><span class="hljs-string">'doc'</span></span> ] ; modifier: { <span class="hljs-string"><span class="hljs-string">'$set'</span></span>: { <span class="hljs-string"><span class="hljs-string">'doc.field1'</span></span>: <span class="hljs-string"><span class="hljs-string">'value1'</span></span> } }</code> </pre><br>  In the fields parameter, the passive fields of the topmost level are transferred, that is, based on it, it is possible to determine access rights to the doc field (and all its subdocuments), but it is impossible to apply different rights to the doc.field1 and doc.field fields based on this array.  To do this, you can use the modifier parameter, in which an object containing the MongoDb operation is passed, and, in order not to carry out a full analysis of the operation, allow only some hard format and bar all other options like this: <br><pre> <code class="javascript hljs">Test.allow({ <span class="hljs-attr"><span class="hljs-attr">update</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">userId, user, fields, modifier</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Test.allow(): userId:'</span></span>, userId, <span class="hljs-string"><span class="hljs-string">'; document:'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>, <span class="hljs-string"><span class="hljs-string">'; fields:'</span></span>, fields, <span class="hljs-string"><span class="hljs-string">'; modifier:'</span></span> , modifier); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> setData = modifier[<span class="hljs-string"><span class="hljs-string">"$set"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> setData &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(setData).length===<span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; setData[<span class="hljs-string"><span class="hljs-string">"doc.field1"</span></span>]; } });</code> </pre><br>  Of course, <a href="http://docs.meteor.com/">allow</a> / <a href="http://docs.meteor.com/">deny</a> rules work only if the insecure package is removed from the project.  By the way, these handlers can also be used for server-side changes made by the client. <br><br><a name="trusted"></a><h4>  Trusted and untrusted code </h4><br>  So far we have changed the record by its identifier.  The fact is that the client cannot perform the update operation, specifying something else in the query selector, for example: <br><pre> <code class="java hljs">Test.update({ value: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $set: { <span class="hljs-string"><span class="hljs-string">"doc.field1"</span></span>: <span class="hljs-string"><span class="hljs-string">"value1"</span></span> } } ) Error: Not permitted. Untrusted code may only update documents by ID. [<span class="hljs-number"><span class="hljs-number">403</span></span>]</code> </pre><br>  This is due to the fact that Meteor shares trusted and untrusted code.  A trusted code is considered to be executed on the server, including server methods called by the client.  Untrusted - code executed on the client in the browser. <br>  The untrusted code is allowed to modify documents only one at a time, with an indication of the _id of the document and checking the rules of allow / deny.  Also, the upsert operation is prohibited (inserting a document when it is out).  The remove operation can similarly be applied only to a single document, with its _id indicated.  For more information, see the <a href="http://docs.meteor.com/">docs.meteor.com/#update</a> and <a href="http://docs.meteor.com/">docs.meteor.com/#remove documentation</a> . <br><br><a name="methods"></a><h4>  Server methods </h4><br>  As an alternative to direct client access to the database, server methods can be used.  Since the code executed on the server is considered trusted, it is possible to place the logic of critical operations on the server, prohibiting changes to the corresponding collections on the client.  For example, add on the server: <br><pre> <code class="javascript hljs">Meteor.startup(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ Meteor.methods({ <span class="hljs-attr"><span class="hljs-attr">testMethod</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'testMethod(): data:'</span></span>, data); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'testMethod finished (data:'</span></span>,data,<span class="hljs-string"><span class="hljs-string">')'</span></span>; } }); });</code> </pre><br>  And call from the client, passing the last parameter callback, called at the end of the method: <br><pre> <code class="javascript hljs">&gt; Meteor.call(<span class="hljs-string"><span class="hljs-string">'testMethod'</span></span>, <span class="hljs-string"><span class="hljs-string">'test data'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, result</span></span></span><span class="hljs-function">) </span></span>{<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err, result);}) <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> <span class="hljs-string"><span class="hljs-string">"testMethod finished (data:test data)"</span></span></code> </pre><br><br><a name="https"></a><h4>  HTTPS and <a href="http://docs.meteor.com/">force-ssl</a> package </h4><br>  Meteor itself does not include HTTPS support, and it requires an intermediate server that terminates the SSL on which the certificate resides.  The built-in <a href="http://docs.meteor.com/">force-ssl</a> package allows you to redirect an HTTP connection to an HTTPS URL, excluding connections from localhost. <br>  When using Nginx in this package is not necessary, since the redirection can be implemented as follows <br><div class="spoiler">  <b class="spoiler_title">(example of setting Nginx to localhost as a proxy for Meteor, including the generation of an auto-signed certificate)</b> <div class="spoiler_text"><h5>  Generate key and certificate </h5><br><pre> <code class="bash hljs">$ openssl genrsa -des3 -out localhost.key 1024 $ openssl req -new -key localhost.key -out localhost.csr Common Name (eg, YOUR name) :localhost $ openssl x509 -req -days 1024 -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> localhost.csr -signkey localhost.key -out localhost.crt</code> </pre><br>  Copy the certificate and key to the / etc / nginx / ssl folder <br><pre> <code class="bash hljs">$ mkdir /etc/nginx/ssl $ cp ./localhost.key /etc/nginx/ssl $ cp ./localhost.crt /etc/nginx/ssl</code> </pre><br><h5>  Nginx configuration </h5><br>  Create the /etc/nginx/sites-available/meteor.conf file (if Nginx is installed ‚Äúfrom scratch‚Äù, you must delete or reconfigure the default file in the same directory that contains the same ports): <br><pre> <code class="hljs lua">server { listen <span class="hljs-number"><span class="hljs-number">80</span></span>; server_name localhost; # $scheme will get the http protocol # <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span> is best practice <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tablet, phone, desktop <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> seo # <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span> $scheme://example.com$request_uri; # We want to redirect people to the https site when they come to the http site. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span> https://localhost$request_uri; } server { listen <span class="hljs-number"><span class="hljs-number">443</span></span>; server_name localhost; client_max_body_size <span class="hljs-number"><span class="hljs-number">500</span></span>M; access_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/meteorapp.access.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/meteorapp.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>; location / { proxy_pass http://localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span>; proxy_set_header X-Real-IP $remote_addr; proxy_http_version <span class="hljs-number"><span class="hljs-number">1.1</span></span>; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection <span class="hljs-string"><span class="hljs-string">"upgrade"</span></span>; } ssl on; ssl_certificate /etc/nginx/ssl/localhost.crt; ssl_certificate_key /etc/nginx/ssl/localhost.key; ssl_verify_depth <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre><br>  Create link: <br><pre> <code class="bash hljs">ln -s /etc/nginx/sites-available/meteor.conf /etc/nginx/sites-enabled/meteor.conf</code> </pre><br>  Restart Nginx: <br><pre> <code class="bash hljs">$ sudo service nginx restart</code> </pre><br></div></div><br><br><a name="policy"></a><h4>  Package browser-policy, Content Security Policy and X-Frame-Options </h4><br>  In fact, two other packages are hidden behind <a href="http://docs.meteor.com/">browser-policy</a> , each of which can be used separately, browser-policy-content and browser-policy-framing.  The first of these provides an interface for defining <a href="https://developer.mozilla.org/en-US/docs/Security/CSP/Introducing_Content_Security_Policy">Content Security Policy</a> rules, with the help of which a white list of sources for loading various types of resources is specified.  The second is the <a href="https://developer.mozilla.org/en-US/docs/HTTP/X-Frame-Options">X-Frame-Origin</a> parameter, which allows the page to be displayed inside the frame or iframe tags, depending on the site URI that is trying to do this (at the moment, specifying the source URI in X-Frame-Origin only supports Firefox and IE 8+). <br>  Adding a package includes a default policy, while downloading content is allowed only from the same site as the page itself, XMLHTTPRequest requests and WebSocket connections can be directed to any sites.  In addition, functions of type eval () are blocked and the application can be included in the frame and iframe only by the same site from which it was downloaded. <br><br>  At the same time, the following parameters are added to the header of the server response when the page loads: <br><pre> <code class="hljs pgsql">content-<span class="hljs-keyword"><span class="hljs-keyword">security</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-src <span class="hljs-string"><span class="hljs-string">'self'</span></span>; script-src <span class="hljs-string"><span class="hljs-string">'self'</span></span> <span class="hljs-string"><span class="hljs-string">'unsafe-inline'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>-src * <span class="hljs-string"><span class="hljs-string">'self'</span></span>; img-src data: <span class="hljs-string"><span class="hljs-string">'self'</span></span>; style-src <span class="hljs-string"><span class="hljs-string">'self'</span></span> <span class="hljs-string"><span class="hljs-string">'unsafe-inline'</span></span>; x-frame-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span>: SAMEORIGIN</code> </pre><br>  And, in our example, user images from external sites (Google and Facebook) will no longer be displayed with the following message in the console: <br><pre> <code class="hljs pgsql">Refused <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> the image <span class="hljs-string"><span class="hljs-string">'https://lh6.googleusercontent.com/-aCxpjiDMNcM/AAAAAAAAAAI/AAAAAAAAJMY/9hZytqLLZ6Q/photo.jpg'</span></span> because it violates the <span class="hljs-keyword"><span class="hljs-keyword">following</span></span> Content <span class="hljs-keyword"><span class="hljs-keyword">Security</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span> directive: "img-src data: 'self'".</code> </pre><br>  In order for images from external sites to start displaying again, you need to add the following lines on the server: <br><pre> <code class="javascript hljs">Meteor.startup(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ BrowserPolicy.content.allowImageOrigin(<span class="hljs-string"><span class="hljs-string">"https://*.googleusercontent.com"</span></span>); BrowserPolicy.content.allowImageOrigin(<span class="hljs-string"><span class="hljs-string">"http://profile.ak.fbcdn.net"</span></span>); BrowserPolicy.content.allowImageOrigin(<span class="hljs-string"><span class="hljs-string">"http://graph.facebook.com"</span></span>); });</code> </pre><br>  In this case, the title will look like this: <br><pre> <code class="hljs pgsql">content-<span class="hljs-keyword"><span class="hljs-keyword">security</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-src <span class="hljs-string"><span class="hljs-string">'self'</span></span>; script-src <span class="hljs-string"><span class="hljs-string">'self'</span></span> <span class="hljs-string"><span class="hljs-string">'unsafe-inline'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>-src * <span class="hljs-string"><span class="hljs-string">'self'</span></span>; img-src data: <span class="hljs-string"><span class="hljs-string">'self'</span></span> https:/<span class="hljs-comment"><span class="hljs-comment">/*.googleusercontent.com http://profile.ak.fbcdn.net http://graph.facebook.com; style-src 'self' 'unsafe-inline'; x-frame-options: SAMEORIGIN</span></span></code> </pre><br>  In addition to the default limitations, the Meteor documentation recommends disabling inline Javascript on the page by calling BrowserPolicy.content.disallowInlineScripts () on the server side (of course, if inline Javascript is not used). <br><br><a name="check"></a><h4>  Data validation: the <a href="http://docs.meteor.com/">check ()</a> function and the <a href="http://docs.meteor.com/">audit-arguments-check</a> package </h4><br>  Meteor has a mechanism for validating data passed to server methods and publish functions.  For this purpose, the function <a href="http://docs.meteor.com/">check ()</a> , which is passed the checked value and the pattern to be checked.  A template can be an explicit type indication, or a <a href="http://docs.meteor.com/">Match</a> object that defines more complex validation rules (see http://docs.meteor.com/#match) <br>  Installing the <a href="http://docs.meteor.com/">audit-argument-checks</a> package blocks the execution of the methods and functions of the publication to which data that has not been validated has been transferred. <br>  If validation is not required, you can call the check function with the following parameter <pre> <code class="javascript hljs">check(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>, [Match.Any])</code> </pre> <br>  Add a package <br><pre> <code class="bash hljs">$ mrt add audit-argument-checks</code> </pre><br>  Now the attempt to call the server method will return an error: <br><pre> <code class="javascript hljs">&gt; Meteor.call(<span class="hljs-string"><span class="hljs-string">'testMethod'</span></span>, <span class="hljs-string"><span class="hljs-string">'test data'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, result</span></span></span><span class="hljs-function">) </span></span>{<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err, result);}) <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> errorClass {<span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-attr"><span class="hljs-attr">reason</span></span>: <span class="hljs-string"><span class="hljs-string">"Internal server error"</span></span>, <span class="hljs-attr"><span class="hljs-attr">details</span></span>: <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-string"><span class="hljs-string">"Internal server error [500]"</span></span>, <span class="hljs-attr"><span class="hljs-attr">errorType</span></span>:<span class="hljs-string"><span class="hljs-string">"Meteor.Error"</span></span>‚Ä¶} <span class="hljs-literal"><span class="hljs-literal">undefined</span></span></code> </pre><br>  And on the server: <br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> invoking <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> <span class="hljs-string"><span class="hljs-string">'testMethod'</span></span> Error: Did <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> arguments during <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-string"><span class="hljs-string">'testMethod'</span></span></code> </pre><br>  After adding validation to the server method, it will again correctly work out: <br><pre> <code class="javascript hljs"> check(data, <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>);</code> </pre><br><br><h4>  Instead of conclusion </h4><br>  Trying to share my work, I didn‚Äôt notice how big the material turned out to be, despite the fact that I was able to touch only a very, very small part of Meteor. <br>  I hope this text will help you to get to know Meteor and learn something new about it. </div><p>Source: <a href="https://habr.com/ru/post/211020/">https://habr.com/ru/post/211020/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211008/index.html">Impact of Motorola Mobility Absorption by IBM-Lenovo Alliance</a></li>
<li><a href="../211012/index.html">Transparent encryption of network folders in the corporate space</a></li>
<li><a href="../211014/index.html">HGST HelioSeal - a promising platform for the next decade</a></li>
<li><a href="../211016/index.html">Pocket PaaS with Dokku</a></li>
<li><a href="../211018/index.html">Probability in algorithms. Yandex lecture</a></li>
<li><a href="../211022/index.html">Use EXPLAIN. Query enhancement</a></li>
<li><a href="../211024/index.html">Proxmox API. Introduction</a></li>
<li><a href="../211026/index.html">You like to read exciting books - love and wear a vest ...</a></li>
<li><a href="../211028/index.html">Browser game "Cyberset" - continued</a></li>
<li><a href="../211030/index.html">Google enters into a contract with the sea driver</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>