<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work on hardware errors on the SQL server side and the benefits of load tests</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some of our users began to report that reports sometimes return a value in excess of 100% to show data growth. 

 At the same time, it turned out that...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work on hardware errors on the SQL server side and the benefits of load tests</h1><div class="post__text post__text-html js-mediator-article">  Some of our users began to report that reports sometimes return a value in excess of 100% to show data growth. <br><br>  At the same time, it turned out that the service delivering data from the equipment sometimes makes gaps in the values. <br>  Where the server read the hardware directly, instead of values, it inserted NULL, and where it read through SNMP, it inserted 0. <br><br>  That is, a series of counter values ‚Äã‚Äãwas: <b>4, 10, 20, NULL, NULL, 31, 0, 0, 0, 50,</b> and now <b>4, 10, 20, 20, 20, 31, 31, 31, 31, 50</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Probably it would be possible to approximate the data, but it suits the stackers, and our business is to satisfy the customers. <br>  What to do became clear, the question is only on which side what to correct. <br><br><a name="habracut"></a><br><br>  The reporters themselves decided not to touch them - there are a lot of them, therefore, in addition to repairing the reading service, we must also correct the data in the database itself. <br><br>  In the beginning, because they complained about one report, the solution was simple - to fix the data that participated in the report.  All the analysis could not be done, because the customers (due to the volumes) could not send their bases, so the decision was made on the basis of logs. <br><br>  The first solution was obvious and simple. <br><br>  for MSSQL 2008: <br><br><pre><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">Update</span></span> curr <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> curr.dev_counter_color=<span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(curr.dev_counter_color, prev.dev_counter_color) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> device_counter curr <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> device_counter prev <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> curr.dev_id = prev.dev_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> curr.dev_counter_color <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> prev.dev_counter_date = (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(sub.dev_counter_date) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> device_counter sub <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> sub.dev_counter_date &lt; curr.dev_counter_date <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dev_counter_color <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre> <br><br>  for Oracle: <br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">merge</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> DEVICE_COUNTER t <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROWID</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> rid, <span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span>(dev_counter_duplex <span class="hljs-keyword"><span class="hljs-keyword">ignore</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nulls</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dev_id <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dev_counter_date, dev_counter_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> new_cnt_value <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> DEVICE_COUNTER t ) v <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.rowid = v.rid) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">matched</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dev_counter_duplex = new_cnt_value</code> </pre><br><br>  And half a year later, as a user appeared with a base of tens of thousands of devices with data for several years (about five million records), he began complaining that he could not wait for the end of the database upgrade. <br><br>  At the same time, we received a letter from the technical report of those who decided to offer to repair the base with all 57 counters. <br><br>  It would seem that you fix the query column by column and the end of it. <br><br>  When we still pulled the database from the client, it turned out that the request runs on one column for almost two minutes on an average virtual server, and a weak laptop client complaining about the update speed, according to our calculations, did all 57 sql of queries in ~ 52 hours! .. <br><br>  As usual, we recommend our clients to work with a technique whose parameters are specified in the technical requirements, but is it really that bad in relational languages? <br><br>  I had to remember about the good old cursor, - the task itself is simple - to go through several million entries and if there is something to edit, then edit. <br><br>  If the data skips were in all columns, then a simple pass with an update of all rows takes about the same time as the original version - 38 minutes versus 92 in the relational approach ... <br><br>  And only the fact that the passes are rare - reduced the upgrade to 2!  minutes is for 22,000 lines of 3 million. <br><br><div class="spoiler">  <b class="spoiler_title">The final TSQL code.</b>  <b class="spoiler_title">The number of fields reduced to 2 so that the code does not look so loud:</b> <div class="spoiler_text"><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @cur_dev_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @cur_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @cur_counter_total_color <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @cur_counter_total_mono <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @next_dev_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @next_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @next_counter_total_color <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @next_counter_total_mono <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> UPDCURSOR <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dev_id, dev_counter_id, dev_counter_total_color, dev_counter_total_mono <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> device_counter d <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dev_id, dev_counter_date <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> UPDCURSOR <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> UPDCURSOR <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> @cur_dev_id, @cur_id, @cur_counter_total_color; WHILE @@FETCH_STATUS = 0 <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> UPDCURSOR <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @next_dev_id, @next_id , @next_counter_total_color, @next_counter_total_mono <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @@FETCH_STATUS = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> @cur_dev_id = @next_dev_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( ((@next_counter_total_color <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> @cur_counter_total_color <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (@next_counter_total_color = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (@cur_counter_total_color &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @cur_counter_total_color <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ))) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> ((@next_counter_total_mono <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> @cur_counter_total_mono <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (@next_counter_total_mono = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (@cur_counter_total_mono &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @cur_counter_total_mono <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ))) ) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @cur_counter_total_color = (<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @next_counter_total_color <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @next_counter_total_color = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> @cur_counter_total_color <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> @next_counter_total_color <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>), @cur_counter_total_mono = (<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @next_counter_total_mono <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @next_counter_total_mono = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> @cur_counter_total_mono <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> @next_counter_total_mono <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = @<span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> device_counter <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> dev_counter_total_color = @cur_counter_total_color, dev_counter_total_mono = @cur_counter_total_mono <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OF</span></span> UPDCURSOR <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @cur_counter_total_color = @next_counter_total_color, @cur_counter_total_mono = @next_counter_total_mono; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @cur_dev_id = @next_dev_id <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLOSE</span></span> UPDCURSOR <span class="hljs-keyword"><span class="hljs-keyword">DEALLOCATE</span></span> UPDCURSOR <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre></div></div><br><br>  I didn‚Äôt invent anything especially in this article, just practicing the real SQL developer requires to avoid using the cursor, but as this example showed, if there is an <strike>ugly</strike> alternative solution and it works better, then you need to use it ... <br><br>  And it is especially important to do not only unit tests but load tests at the highest possible volumes. </div><p>Source: <a href="https://habr.com/ru/post/276835/">https://habr.com/ru/post/276835/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276821/index.html">The use of machine learning in the field of fintech</a></li>
<li><a href="../276823/index.html">Overview of WhatsApp Toolkit</a></li>
<li><a href="../276825/index.html">Using VS Code for Web Development</a></li>
<li><a href="../276827/index.html">Windows Phone as an experimental platform</a></li>
<li><a href="../276831/index.html">Shodan collected the IPv6 addresses of NTP clients and scanned them in response</a></li>
<li><a href="../276837/index.html">New 2GIS for Android - we begin public testing</a></li>
<li><a href="../276839/index.html">Objective Perl Code Quality Criteria</a></li>
<li><a href="../276841/index.html">On February 13, a conference of software developers Dev2Dev Just.Net will take place in Krasnoyarsk</a></li>
<li><a href="../276843/index.html">New free courses virtual academy Microsoft Virtual Academy, February 2016</a></li>
<li><a href="../276845/index.html">himawari8 wallpaper for linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>