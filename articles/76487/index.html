<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>nginx + FastCGI (over spawn-fcgi) + lua</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="And so we have a task. Making the lightweight web server nginx and lua work together (in this case lua via wsapi (lua web server API) -fastcgi). 
 Wha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>nginx + FastCGI (over spawn-fcgi) + lua</h1><div class="post__text post__text-html js-mediator-article">  And so we have a task.  Making the lightweight web server nginx and lua work together (in this case lua via wsapi (lua web server API) -fastcgi). <br>  What do we need?  Well, for starters head on his shoulders.  Well, that is not something that would be particularly needed, but useful. <br>  And then ... And then the server in our case with GNU / Linux on board (but I think it will come down and, say, FreeBSD), we will look at the example of Ubuntu GNU / Linux, this has happened historically. <br><a name="habracut"></a><br>  We put nginx. <br><blockquote><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># apt-get install nginx</span></span></code> </pre> </blockquote><br>  and nginx itself is with us, this is understandable, everything is simple here. <br>  Further miracles begin. <br>  As our programmers working with lua in Ubuntu say, luarocks is <a href="http://article.gmane.org/gmane.comp.lang.lua.general/58237">so</a> subdued <a href="http://article.gmane.org/gmane.comp.lang.lua.general/58237">that my mother does not recognize</a> , plus luarocks released version 2.0 a few days before the release of Ubuntu 9.10 and the version was not included in the release, but programmers want it.  So luarocks will temporarily be made from raw, and later we will make our repository and we will collect the bag. <br><br>  but for now ... <br><blockquote><pre>    1. $ sudo apt-get install unzip lua5.1 liblua5.1-dev libreadline-dev
    2. $ mkdir -p ~ / build &amp;&amp; cd ~ / build
    3. $ wget http://luarocks.org/releases/luarocks-2.0.tar.gz (get the latest version from http://luarocks.org)
    4. $ tar -zxf luarocks-2.0.tar.gz &amp;&amp; cd luarocks-2.0
    5. $ ./configure --with-lua-include = / usr / include / lua5.1
    6. $ make
    7. $ sudo make install
</pre></blockquote><br>  Yes, so of course we will sort out some dustbin in the system, but for the time being we will leave it this way, for the time being. <br><br>  luarocks we set, well done. <br>  we put wsapi-fcgi <br><blockquote><pre> # luarocks install wsapi-fcgi
</pre></blockquote><br>  Yeah, well done, set. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      now perhaps spawn-cgi is useful to us, so that our wsapi-fcgi would be waiting for us somewhere :) <br><blockquote><pre> # apt-get install spawn-cgi
</pre></blockquote><br>  The next problem is the lack of a startup script for spawn-fcgi in Ubuntu.  is solved using approximately such a script: <br><br><blockquote> <code><font color="#666666">#! /bin/sh</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#666666">### BEGIN INIT INFO</font> &lt;br/&gt; <br> <font color="#666666"># Provides: spawn-fcgi</font> &lt;br/&gt; <br> <font color="#666666"># Required-Start: $all</font> &lt;br/&gt; <br> <font color="#666666"># Required-Stop: $all</font> &lt;br/&gt; <br> <font color="#666666"># Default-Start: 2 3 4 5</font> &lt;br/&gt; <br> <font color="#666666"># Default-Stop: 0 1 6</font> &lt;br/&gt; <br> <font color="#666666"># Short-Description: starts FastCGI</font> &lt;br/&gt; <br> <font color="#666666"># Description: starts FastCGI with spawn-fcgi</font> &lt;br/&gt; <br> <font color="#666666">### END INIT INFO</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#007800">PATH</font> = <font color="#000000">/</font> usr <font color="#000000">/</font> local <font color="#000000">/</font> sbin: <font color="#000000">/</font> usr <font color="#000000">/</font> local <font color="#000000">/</font> bin: <font color="#000000">/</font> sbin: <font color="#000000">/</font> bin: <font color="#000000">/</font> usr <font color="#000000">/</font> sbin: <font color="#000000">/</font> usr <font color="#000000">/</font> bin&lt;br/&gt; <br> <font color="#007800">NAME</font> =spawn-fcgi&lt;br/&gt; <br> <font color="#007800">PID</font> = <font color="#000000">/</font> var <font color="#000000">/</font> run <font color="#000000">/</font> spawn-fcgi.pid&lt;br/&gt; <br> <font color="#007800">DAEMON</font> = <font color="#000000">/</font> usr <font color="#000000">/</font> bin <font color="#000000">/</font> spawn-fcgi&lt;br/&gt; <br> <font color="#007800">DAEMON_OPTS</font> = <font color="#ff0000">"-f /usr/local/lib/luarocks/bin/wsapi.fcgi -a 127.0.0.1 -p 9000 -u www-data -g www-data -P <font color="#007800">$PID</font> "</font> &lt;br/&gt; <br> . <font color="#000000">/</font> lib <font color="#000000">/</font> lsb <font color="#000000">/</font> init-functions&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#7a0874">test</font> <font color="#660033">-x</font> <font color="#007800">$DAEMON</font> <font color="#000000">||</font> <font color="#7a0874">exit</font> <font color="#000000">0</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#000000">set</font> <font color="#660033">-e</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#000000">case</font> <font color="#ff0000">"$1"</font> <font color="#000000">in</font> &lt;br/&gt; <br> start <font color="#7a0874">)</font> &lt;br/&gt; <br> log_daemon_msg <font color="#ff0000">"spawn-fcgi starting"</font> &lt;br/&gt; <br> start-stop-daemon <font color="#660033">--start</font> <font color="#660033">--pidfile</font> <font color="#007800">$PID</font> <font color="#660033">--exec</font> <font color="#007800">$DAEMON</font> <font color="#660033">--</font> <font color="#007800">$DAEMON_OPTS</font> &lt;br/&gt; <br> <font color="#7a0874">echo</font> <font color="#ff0000">"done."</font> &lt;br/&gt; <br> <font color="#000000">;;</font> &lt;br/&gt; <br> stop <font color="#7a0874">)</font> &lt;br/&gt; <br> log_daemon_msg <font color="#ff0000">"spawn-fcgi stopping"</font> &lt;br/&gt; <br> start-stop-daemon <font color="#660033">--stop</font> <font color="#660033">--pidfile</font> <font color="#007800">$PID</font> <font color="#660033">--retry</font> <font color="#000000">5</font> &lt;br/&gt; <br> <font color="#c20cb9">rm</font> <font color="#660033">-f</font> <font color="#007800">$PID</font> &lt;br/&gt; <br> <font color="#7a0874">echo</font> <font color="#ff0000">"done."</font> &lt;br/&gt; <br> <font color="#000000">;;</font> &lt;br/&gt; <br> restart <font color="#7a0874">)</font> &lt;br/&gt; <br> <font color="#7a0874">echo</font> <font color="#ff0000">"Stopping <font color="#007800">$NAME</font> : "</font> &lt;br/&gt; <br> start-stop-daemon <font color="#660033">--stop</font> <font color="#660033">--pidfile</font> <font color="#007800">$PID</font> <font color="#660033">--retry</font> <font color="#000000">5</font> &lt;br/&gt; <br> <font color="#c20cb9">rm</font> <font color="#660033">-f</font> <font color="#007800">$PID</font> &lt;br/&gt; <br> <font color="#7a0874">echo</font> <font color="#ff0000">"done..."</font> &lt;br/&gt; <br> <font color="#c20cb9">sleep</font> <font color="#000000">1</font> &lt;br/&gt; <br> <font color="#7a0874">echo</font> <font color="#ff0000">"Starting <font color="#007800">$NAME</font> : "</font> &lt;br/&gt; <br> start-stop-daemon <font color="#660033">--start</font> <font color="#660033">--pidfile</font> <font color="#007800">$PID</font> <font color="#660033">--exec</font> <font color="#007800">$DAEMON</font> <font color="#660033">--</font> <font color="#007800">$DAEMON_OPTS</font> &lt;br/&gt; <br> <font color="#7a0874">echo</font> <font color="#ff0000">"done."</font> &lt;br/&gt; <br> <font color="#000000">;;</font> &lt;br/&gt; <br> <font color="#000000">*</font> <font color="#7a0874">)</font> &lt;br/&gt; <br> <font color="#7a0874">echo</font> <font color="#ff0000">"Usage: /etc/init.d/ <font color="#007800">$NAME</font> {start|stop|restart}"</font> <font color="#000000">&gt;&amp;</font> <font color="#000000">2</font> &lt;br/&gt; <br> <font color="#7a0874">exit</font> <font color="#000000">1</font> &lt;br/&gt; <br> <font color="#000000">;;</font> &lt;br/&gt; <br> <font color="#000000">esac</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#7a0874">exit</font> <font color="#000000">0</font></code> </blockquote> <br><br>  we put the script in place in /etc/init.d/spawn-fcgi, add it to the load level, voila!  With the launch as fcgi wsapi the issue is resolved. <br><blockquote><pre> # update-rc.d spawn-fcgi defaults 21 
</pre></blockquote><br><br>  we configure nginx that would give everything that comes to our host which is necessary further for processing of wsapi-fcgi <br>  My example is not particularly correct, just for the needs for which it was written was enough. <br><br>  in / etc / nginx / sites-available, create the fcgi file with the following content: <br><blockquote><pre>  server {
         listen to our-server-wsapi.cxm: 80;
         server_name our-server-wsapi.cxm;
         access_log /var/log/nginx/ourserver-wsapi.cxm.access.log;

         location / {
                           fastcgi_pass localhost: 9000;
                           fastcgi_index index.lua;

                           fastcgi_param SCRIPT_FILENAME / srv / www / nginx / fcgi / lua $ fastcgi_script_name;
                           fastcgi_param QUERY_STRING $ query_string;
                           fastcgi_param REQUEST_METHOD $ request_method;
                           fastcgi_param CONTENT_TYPE $ content_type;
                           fastcgi_param CONTENT_LENGTH $ content_length;
                          }
 }
</pre></blockquote><br><br>  create a symlink from it in / etc / nginx / sites-enabled, restart nginx <br><br>  at / srv / www / nginx / fcgi / lua we place our test index.lua <br>  go to the browser and check if it works. <br><br>  This text was written for internal documentation, but decided to publish, suddenly someone will come in handy. <br>  I did not meet the documentation on such a bundle in Russian (however, in English too) <br><br></div><p>Source: <a href="https://habr.com/ru/post/76487/">https://habr.com/ru/post/76487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../76479/index.html">John Birrell, one of the FreeBSD project committers, died.</a></li>
<li><a href="../76481/index.html">boolean - fighting for Java memory ...</a></li>
<li><a href="../76482/index.html">What I found interesting on the mail server meteorologists</a></li>
<li><a href="../76483/index.html">Romeo and Juliet</a></li>
<li><a href="../76485/index.html">Debugging Javascript</a></li>
<li><a href="../76488/index.html">Kubuntu 9.10 + Qt4 + Oracle Express Edition</a></li>
<li><a href="../76489/index.html">New type of posts: "Trust"</a></li>
<li><a href="../76490/index.html">Mail.Ru Agent for iPhone - first experience</a></li>
<li><a href="../76491/index.html">stillborn lighttpd 1.5</a></li>
<li><a href="../76492/index.html">Eugene Butman answers to our questions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>