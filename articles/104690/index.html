<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a trial search engine on Sphinx + php</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 Previously, we used the usual fulltext search to search the site. But at a certain point, he stopped arranging us and we decided to try o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a trial search engine on Sphinx + php</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  Previously, we used the usual fulltext search to search the site.  But at a certain point, he stopped arranging us and we decided to try out an alternative search technology: Sphinx.  Unfortunately, the Sphinx has no Russian documentation at all, so this article is similar to the article <a href="http://www.ibm.com/developerworks/library/os-php-sphinxsearch/">Build a custom search engine with PHP</a> , only in Russian and for my local environment (windows 7, mysql / php) <br>  The article consists of 4 parts: <br><ol><li>  A short story about the preparation of the base for the search. </li><li>  The story about the initial installation and configuration of the Sphinx </li><li>  Database indexing and test search from the command line </li><li>  Php test search </li></ol><br><a name="habracut"></a><br><h4>  1. Prepare a database for search </h4><br>  Before you start using the Sphinx, it is better to immediately prepare a database for easier indexing and searching. <br>  I have three tables: products, companies, categories, respectively products, companies and product categories.  Create a view in which we merge the data from all three tables that will be searched: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> <span class="hljs-string"><span class="hljs-string">`catalog`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> p.<span class="hljs-string"><span class="hljs-string">`id`</span></span> , p.<span class="hljs-string"><span class="hljs-string">`id_company`</span></span> , p.<span class="hljs-string"><span class="hljs-string">`id_category`</span></span> , p.<span class="hljs-string"><span class="hljs-string">`name`</span></span> , p.<span class="hljs-string"><span class="hljs-string">`keyword`</span></span> , p.<span class="hljs-string"><span class="hljs-string">`short_desc`</span></span> , com.<span class="hljs-string"><span class="hljs-string">`name`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> company_name, cat.<span class="hljs-string"><span class="hljs-string">`name`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> category_name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`products`</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`categories`</span></span> cat <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.id_category = cat.id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`companies`</span></span> com <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.id_company = com.id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  In my case, the search is conducted by the fields: name, keyword, a brief description of the product, the name of the manufacturing company and the name of the product category.  In WHERE, you can add additional conditions, for example, so that the search is only for active companies and products.  At this preparatory work with the database is completed. <br><br><h4>  2. Install Sphinx </h4><br>  It is necessary to download the latest distribution from offsite: <a href="http://www.sphinxsearch.com/downloads.html">www.sphinxsearch.com/downloads.html</a> <br>  I downloaded the Win32 version of binaries w / MySQL support 1.10 beta.  Next, unpack the contents of the archive in any folder (I unpacked in C: \ Sphinx) <br><br><h5>  Configuring Sphinx </h5><br>  After downloading and unpacking the archive, the next step is setting.  I took the sphinx.conf.in file as a basis. <br>  In this section, I‚Äôll just give configs with a few comments, everything seems to be clear there.  All the text from this section is in one sphinx.conf.in file. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  Data source </h6><br><pre> <code class="hljs vbscript">#     source catalog { #   #  : mysql, pgsql, mssql, xmlpipe, xmlpipe2, odbc type = mysql #        sql_host = localhost sql_user = root sql_pass = sql_db = products sql_port = <span class="hljs-number"><span class="hljs-number">3306</span></span> # ,   <span class="hljs-number"><span class="hljs-number">3306</span></span> # -,           #       UTF<span class="hljs-number"><span class="hljs-number">-8</span></span>,           sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NAMES utf8 # ,       #        ID  sql_query = \ <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * \ FROM catalog # ,     ,    sql_attr_uint = id_company sql_attr_uint = id_category # document info query, ONLY <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CLI search (ie. testing <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> debugging) # optional, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">empty</span></span> # must contain $id macro <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> must fetch the document by that id sql_query_info = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * FROM products WHERE id=$id }</code> </pre><br><br><h6>  Product indexing options </h6><br><pre> <code class="hljs 1c"><span class="hljs-meta"><span class="hljs-meta">#    </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  index catalog { #   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  source = catalog # ,      path = C:\Sphinx/data/catalog #     morphology = stem_ru #    </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  min_word_len = 1 #  charset_type = utf-8 }</span></span></code> </pre> <br><br><h6>  Settings daemon (service) </h6><br><pre> <code class="hljs pgsql">#   () searchd { #      ""  <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> = <span class="hljs-number"><span class="hljs-number">9312</span></span> #    <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> = C:\Sphinx/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/searchd.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> #      query_log = C:\Sphinx/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/query.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> # PID file, searchd process ID file <span class="hljs-type"><span class="hljs-type">name</span></span> # mandatory pid_file = C:\Sphinx/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/searchd.pid }</code> </pre> <br><br>  This completes the configuration of the Sphinx. <br>  Now we install our service.  To do this, in the address bar write <b>C: \ Sphinx \ bin \ searchd --install --config C: \ Sphinx \ sphinx.conf.in --servicename SphinxSearch</b> <br>  The service is installed and should appear in the administration - service.  While not running - our data is not yet indexed. <br><br><h4>  3. Indexing and Test Search </h4><br>  Now on the command line, write <b>C: \ Sphinx \ bin \ indexer --all --config C: \ Sphinx \ sphinx.conf.in</b> .  We get a result like this: <br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Iskander</span></span></span></span>&gt; C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Sphinx</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bin</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">indexer</span></span></span></span> --all --config C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Sphinx</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sphinx</span></span></span></span>.conf.in Sphinx 1.10-beta (r2420) Copyright (c) 2001-2010, Andrew Aksyonoff Copyright (c) 2008-2010, Sphinx Technologies Inc (http://sphinxsearch.com) using config file 'C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Sphinx</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sphinx</span></span></span></span>.conf.in'... indexing index 'catalog'... collected 572 docs, 0.1 MB sorted 0.0 Mhits, 100.0<span class="hljs-comment"><span class="hljs-comment">% done total 572 docs, 115192 bytes total 0.380 sec, 303124 bytes/sec, 1505.19 docs/sec total 2 reads, 0.000 sec, 31.6 kb/call avg, 0.0 msec/call avg total 9 writes, 0.001 sec, 14.6 kb/call avg, 0.1 msec/call avg</span></span></code> </pre> <br><br>  Everything, the index is created.  Now we start our SphinxSearch service and in the search line we write something like <br>  <b>C: \ Sphinx \ bin \ search --config C: \ Sphinx \ sphinx.conf.in computer</b> and get the result <br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Iskander</span></span></span></span>&gt; C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Sphinx</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bin</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">search</span></span></span></span> --config C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Sphinx</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sphinx</span></span></span></span>.conf.in computer Sphinx 1.10-beta (r2420) Copyright (c) 2001-2010, Andrew Aksyonoff Copyright (c) 2008-2010, Sphinx Technologies Inc (http://sphinxsearch.com) using config file 'C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Sphinx</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sphinx</span></span></span></span>.conf.in'... index 'catalog': query 'computer': returned 1 matches of 1 total in 0.000 sec displaying matches: 1. document=1, weight=2812, id_company=2, id_category=1263 id=1 id_company=2 id_category=1263 words: 1. 'computer': 1 documents, 2 hits</code> </pre><br><br>  Search works! <br><br><h4>  4. Search from php </h4><br>  Well, everything is simple.  For example, conduct a search for the query "Computer" <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//    api include('C:\Sphinx\api\sphinxapi.php'); //   -        $cl = new SphinxClient(); $cl-&gt;SetServer( "localhost", 9312 ); //   $cl-&gt;SetMatchMode( SPH_MATCH_ANY ); //    1     $result = $cl-&gt;Query("computer"); //   //    if ( $result === false ) { echo "Query failed: " . $cl-&gt;GetLastError() . ".\n"; //     } else { if ( $cl-&gt;GetLastWarning() ) { echo "WARNING: " . $cl-&gt;GetLastWarning() . " //      "; } if ( ! empty($result["matches"]) ) { //     -   foreach ( $result["matches"] as $product =&gt; $info ) { echo $product . "&lt;br /&gt;"; //   id   } } } exit;</span></span></code> </pre><br><br>  That's all, we installed sphinx, indexed our database and wrote php code that searches through our database and displays the id of the products found. <br><br>  The time has come to further study the <a href="http://www.sphinxsearch.com/docs/manual-1.10.html">documentation</a> , adjust the ranking as the project requires, and generally continue the transfer of functionality from full-text search to sphinx. <br><br>  I hope this article will be able to help someone to do a ‚Äúquick start‚Äù with a sphinx, because I think there‚Äôs a lack of normal Russian articles and documentation on this rather complex, in my opinion, product. </div><p>Source: <a href="https://habr.com/ru/post/104690/">https://habr.com/ru/post/104690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../104678/index.html">Google launched Transparency Report</a></li>
<li><a href="../104679/index.html">Announcement of the first meeting of the Java User Group LV</a></li>
<li><a href="../104681/index.html">Cd error</a></li>
<li><a href="../104683/index.html">Qt 4.7.0 Released</a></li>
<li><a href="../104686/index.html">Beautiful Django configs</a></li>
<li><a href="../104693/index.html">Latvian information portal</a></li>
<li><a href="../104701/index.html">Phone numbers on various Internet resources</a></li>
<li><a href="../104702/index.html">Meebo updated interface</a></li>
<li><a href="../104704/index.html">Using git in flash development</a></li>
<li><a href="../104706/index.html">VMware View Client in Russian</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>