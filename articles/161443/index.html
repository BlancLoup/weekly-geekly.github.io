<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing Prosody v0.8 (Jabber Server) with LDAP Authentication</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good all the time of day! 
 It all started with the fact that the OpenFire I used with a load of 80 clients began to consume about 2 GB of RAM. The se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing Prosody v0.8 (Jabber Server) with LDAP Authentication</h1><div class="post__text post__text-html js-mediator-article">  Good all the time of day! <br>  It all started with the fact that the OpenFire I used with a load of 80 clients began to consume about 2 GB of RAM.  The server resources of course allowed this, but I think everyone will agree - this is not good.  And since for a long time the developers of OpenFire did not eliminate the memory leaks, it was decided to switch to another, more lightweight server. <br>  The following task is to: raise the jabber-server, which is useless for resources, with authorization by ldap-records, and with a list of contacts from ldap-user groups. <br>  Of all the options, I chose Prosody.  But faced with the limited literature and some problems during installation and configuration.  Under the cut how it was all overcome. <br><a name="habracut"></a><br>  I started to install according to the <a href="http://habrahabr.ru/post/138995/">instructions</a> for <a href="https://habrahabr.ru/users/acidumirae/" class="user_link">AcidumIrae</a> <br>  There were a lot of problems.  That saslauthd did not want to connect to LDAP, then it turned out that saslauthd is looking for a user using the userPrincipalName key, which is simply missing in my LDAP entries, and creating it for each record with a large number of users is inconvenient.  There were some other trifles, I don‚Äôt remember now, but I was carrying out for two days without any results. <br>  As a result, it was decided to do from scratch, without instructions, using the latest versions of Prosody and plug-ins. <br><br>  Let's get started <br>  I will install on Debian 6.0, so I will perform all operations under the root. <br><br>  At the moment, the prosody package is presented in the repository, but version 0.7, in which interaction with LDAP is extremely inconvenient, in fact, because of which I had problems.  Therefore I put the package version 0.8 for the 64bit system <a href="http://prosody.im/download/start">from here</a> .  There are also instructions for installing on other systems.  At the same time, we need a LuaSec module from the same place. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      ,     apt-get install lua5.1 liblua5.1-0 liblua5.1-expat0 liblua5.1-socket2 liblua5.1-filesystem0 #  , ,  Prosody wget http://prosody.im/downloads/debian/prosody_0.8.2-1_amd64.deb wget http://prosody.im/downloads/debian/liblua5.1-sec0_0.3.2-2prosody1_amd64.deb dpkg -i liblua5.1-sec0_0.3.2-2prosody1_amd64.deb dpkg -i prosody_0.8.2-1_amd64.deb</span></span></code> </pre> <br><br>  To interact with LDAP, we need several Prosody modules that are not put out of the box: mod_auth_ldap, mod_storage_ldap, as well as the ldap.lib.lua library (mod_lib_ldap) and vcard.lib.lua <br>  I got them here - <a href="http://0-8.prosody-modules.googlecode.com/hg/">0-8.prosody-modules.googlecode.com/hg</a> <br>  In addition to the mod_auth_ldap module, I downloaded it from <a href="http://scm.stefant.org/svn/tools/stuff/trunk/patches/prosody/">scm.stefant.org/svn/tools/stuff/trunk/patches/prosody</a> , since other versions did not want to work correctly for me.  Just in case (all of a sudden, the developer decides to remove it, once he changed the location of the file, or the end of the world happened) the sun into the spoiler module text <br><div class="spoiler">  <b class="spoiler_title">mod_auth_ldap.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> new_sasl = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">"util.sasl"</span></span>.new; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> nodeprep = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">"util.encodings"</span></span>.stringprep.nodeprep; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">"util.logger"</span></span>.init(<span class="hljs-string"><span class="hljs-string">"auth_ldap"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ldap_server = module:get_option(<span class="hljs-string"><span class="hljs-string">"ldap_server"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ldap_rootdn = module:get_option(<span class="hljs-string"><span class="hljs-string">"ldap_rootdn"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ldap_password = module:get_option(<span class="hljs-string"><span class="hljs-string">"ldap_password"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ldap_tls = module:get_option(<span class="hljs-string"><span class="hljs-string">"ldap_tls"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ldap_base = <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span>(module:get_option(<span class="hljs-string"><span class="hljs-string">"ldap_base"</span></span>), <span class="hljs-string"><span class="hljs-string">"ldap_base is a required option for ldap"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ldap_scope = module:get_option(<span class="hljs-string"><span class="hljs-string">"ldap_scope"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">"onelevel"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ldap_filter = module:get_option(<span class="hljs-string"><span class="hljs-string">"ldap_filter"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> lualdap = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">"lualdap"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ld = <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span>(lualdap.open_simple(ldap_server, ldap_rootdn, ldap_password, ldap_tls)); module.unload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> ld:<span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldap_filter_escape</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (s:<span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(<span class="hljs-string"><span class="hljs-string">"[\\*\\(\\)\\\\%z]"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-string"><span class="hljs-string">"\\%02x"</span></span>):<span class="hljs-built_in"><span class="hljs-built_in">format</span></span>(c:<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find_userdn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(username)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> iter, err = ld:search { base = ldap_base; <span class="hljs-comment"><span class="hljs-comment">-- we need to set scope here, else ldap-search may fail (silently!!) scope = ldap_scope; filter = "(&amp;(uid="..ldap_filter_escape(username)..")"..ldap_filter..")"; } if not iter then module:log("error", "LDAP usersearch failed (%s): %s", username, err); return false; end for dn, attribs in iter do return dn; end return false; end local provider = { name = "ldap" }; function provider.test_password(username, password) local userdn = find_userdn(username); if not userdn then return false; end local ldu = lualdap.open_simple(ldap_server, userdn, password, ldap_tls); if not ldu then return false; end ldu:close(); return true; end function provider.user_exists(username) return find_userdn(username); end function provider.get_password(username) return nil, "Passwords unavailable for LDAP."; end function provider.set_password(username, password) return nil, "Passwords unavailable for LDAP."; end function provider.create_user(username, password) return nil, "Account creation/modification not available with LDAP."; end function provider.get_sasl_handler() local realm = module:get_option("sasl_realm") or module.host; local testpass_authentication_profile = { plain_test = function(sasl, username, password, realm) local prepped_username = nodeprep(username); if not prepped_username then log("debug", "NODEprep failed on username: %s", username); return "", nil; end return provider.test_password(prepped_username, password), true; end }; return new_sasl(realm, testpass_authentication_profile); end module:add_item("auth-provider", provider);</span></span></code> </pre></div></div><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#       Prosody      #    /usr/lib/prosody/modules cd /usr/lib/prosody/modules wget http://scm.stefant.org/svn/tools/stuff/trunk/patches/prosody/mod_auth_ldap.lua wget http://0-8.prosody-modules.googlecode.com/hg/mod_storage_ldap/mod_storage_ldap.lua wget http://0-8.prosody-modules.googlecode.com/hg/mod_lib_ldap/ldap.lib.lua #  vcard.lib.lua     ldap mkdir ldap cd ldap wget http://0-8.prosody-modules.googlecode.com/hg/mod_storage_ldap/ldap/vcard.lib.lua</span></span></code> </pre><br>  Now we will configure configs. <br><br>  /etc/prosody/prosody.cfg.lua <br>  1. Enable client encryption: <br>  find the option "--c2s_require_encryption = false", uncomment and change false to true <br>  2. Configure LDAP authentication: <br>  find authentication = "internal_plain" and change <br><pre> <code class="lua hljs">authentication = <span class="hljs-string"><span class="hljs-string">"ldap"</span></span>; ldap_server = <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>; ldap_base = <span class="hljs-string"><span class="hljs-string">"ou=users,dc=example,dc=com"</span></span>; ldap_rootdn = <span class="hljs-string"><span class="hljs-string">"cn=manager,dc=example,dc=com"</span></span>; ldap_password = <span class="hljs-string"><span class="hljs-string">"password"</span></span>;</code> </pre>  Instructions for these options - <a href="https://code.google.com/p/prosody-modules/wiki/mod_auth_ldap">code.google.com/p/prosody-modules/wiki/mod_auth_ldap</a> <br>  3. Enable configuration for module mod_storage_ldap <br><pre> <code class="lua hljs">Include <span class="hljs-string"><span class="hljs-string">'/etc/prosody/prosody-posix-ldap.cfg.lua'</span></span></code> </pre>  4. Set up our virtual host, for this we will add to the Virtual hosts section <br><pre> <code class="lua hljs">VirtualHost <span class="hljs-string"><span class="hljs-string">"example.com"</span></span> ssl = { key = <span class="hljs-string"><span class="hljs-string">"/etc/prosody/certs/localhost.key"</span></span>; certificate = <span class="hljs-string"><span class="hljs-string">"/etc/prosody/certs/localhost.cert"</span></span>; }</code> </pre><br>  As a result, I got the following config: <br><div class="spoiler">  <b class="spoiler_title">/etc/prosody/prosody.cfg.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">-- Prosody XMPP Server Configuration -- -- Information on configuring Prosody can be found on our -- website at http://prosody.im/doc/configure -- -- Tip: You can check that the syntax of this file is correct -- when you have finished by running: luac -p prosody.cfg.lua -- If there are any errors, it will let you know what and where -- they are, otherwise it will keep quiet. -- ---------- Server-wide settings ---------- -- Settings in this section apply to the whole server and are the default settings -- for any virtual hosts -- This is a (by default, empty) list of accounts that are admins -- for the server. Note that you must create the accounts separately -- (see http://prosody.im/doc/creating_accounts for info) -- Example: admins = { "user1@example.com", "user2@example.net" } admins = { } -- Enable use of libevent for better performance under high load -- For more information see: http://prosody.im/doc/libevent use_libevent = false; -- This is the list of modules Prosody will load on startup. -- It looks for mod_modulename.lua in the plugins folder, so make sure that exists too. -- Documentation on modules can be found at: http://prosody.im/doc/modules modules_enabled = { -- Generally required "roster"; -- Allow users to have a roster. Recommended ;) "saslauth"; -- Authentication for clients and servers. Recommended if you want to log in. "tls"; -- Add support for secure TLS on c2s/s2s connections "dialback"; -- s2s dialback support "disco"; -- Service discovery -- Not essential, but recommended "private"; -- Private XML storage (for room bookmarks, etc.) "vcard"; -- Allow users to set vCards --"privacy"; -- Support privacy lists --"compression"; -- Stream compression -- Nice to have "legacyauth"; -- Legacy authentication. Only used by some old clients and bots. "version"; -- Replies to server version requests "uptime"; -- Report how long server has been running "time"; -- Let others know the time here on this server "ping"; -- Replies to XMPP pings with pongs "pep"; -- Enables users to publish their mood, activity, playing music and more "register"; -- Allow users to register on this server using a client and change passwords "adhoc"; -- Support for "ad-hoc commands" that can be executed with an XMPP client -- Admin interfaces "admin_adhoc"; -- Allows administration via an XMPP client that supports ad-hoc commands --"admin_telnet"; -- Opens telnet console interface on localhost port 5582 -- Other specific functionality "posix"; -- POSIX functionality, sends server to background, enables syslog, etc. --"bosh"; -- Enable BOSH clients, aka "Jabber over HTTP" --"httpserver"; -- Serve static files from a directory over HTTP --"groups"; -- Shared roster support --"announce"; -- Send announcement to all online users --"welcome"; -- Welcome users who register accounts --"watchregistrations"; -- Alert admins of registrations --"motd"; -- Send a message to users when they log in }; -- These modules are auto-loaded, should you -- (for some mad reason) want to disable -- them then uncomment them below modules_disabled = { -- "presence"; -- Route user/contact status information -- "message"; -- Route messages -- "iq"; -- Route info queries -- "offline"; -- Store offline messages }; -- Disable account creation by default, for security -- For more information see http://prosody.im/doc/creating_accounts allow_registration = false; -- These are the SSL/TLS-related settings. If you don't want -- to use SSL/TLS, you may comment or remove this ssl = { key = "/etc/prosody/certs/localhost.key"; certificate = "/etc/prosody/certs/localhost.cert"; } -- Only allow encrypted streams? Encryption is already used when -- available. These options will cause Prosody to deny connections that -- are not encrypted. Note that some servers do not support s2s -- encryption or have it disabled, including gmail.com and Google Apps -- domains. c2s_require_encryption = true --s2s_require_encryption = false -- Select the authentication backend to use. The 'internal' providers -- use Prosody's configured data storage to store the authentication data. -- To allow Prosody to offer secure authentication mechanisms to clients, the -- default provider stores passwords in plaintext. If you do not trust your -- server please see http://prosody.im/doc/modules/mod_auth_internal_hashed -- for information about using the hashed backend. --authentication = "internal_plain" authentication = "ldap"; ldap_server = "localhost"; ldap_base = "ou=users,dc=example,dc=com"; ldap_rootdn = "cn=manager,dc=example,dc=com"; ldap_password = "password"; --ldap_filter = "(authorizedService=jabber)"; -- optional Include '/etc/prosody/prosody-posix-ldap.cfg.lua' -- Select the storage backend to use. By default Prosody uses flat files -- in its configured data directory, but it also supports more backends -- through modules. An "sql" backend is included by default, but requires -- additional dependencies. See http://prosody.im/doc/storage for more info. --storage = "sql" -- Default is "internal" -- For the "sql" backend, you can uncomment *one* of the below to configure: --sql = { driver = "SQLite3", database = "prosody.sqlite" } -- Default. 'database' is the filename. --sql = { driver = "MySQL", database = "prosody", username = "prosody", password = "secret", host = "localhost" } --sql = { driver = "PostgreSQL", database = "prosody", username = "prosody", password = "secret", host = "localhost" } -- Logging configuration -- For advanced logging see http://prosody.im/doc/logging -- Hint: If you create a new log file or rename them, don't forget -- to update the logrotate config at /etc/logrotate.d/prosody log = { -- Log all error messages to prosody.err error = "/var/log/prosody/prosody.err"; -- Log everything of level "info" and higher (that is, all except "debug" messages) -- to prosody.log info = "/var/log/prosody/prosody.log"; -- Change 'info' to 'debug' for more verbose logging --"*syslog"; -- Uncomment this for logging to syslog } -- Pidfile, used by prosodyctl and the init.d script pidfile = "/var/run/prosody/prosody.pid"; ----------- Virtual hosts ----------- -- You need to add a VirtualHost entry for each domain you wish Prosody to serve. -- Settings under each VirtualHost entry apply *only* to that host. VirtualHost "localhost" VirtualHost "example.com" -- enabled = false -- Remove this line to enable this host -- Assign this host a certificate for TLS, otherwise it would use the one -- set in the global section (if any). -- Note that old-style SSL on port 5223 only supports one certificate, and will always -- use the global one. ssl = { key = "/etc/prosody/certs/localhost.key"; certificate = "/etc/prosody/certs/localhost.cert"; } ------ Components ------ -- You can specify components to add hosts that provide special services, -- like multi-user conferences, and transports. -- For more information on components, see http://prosody.im/doc/components ---Set up a MUC (multi-user chat) room server on conference.example.com: --Component "conference.example.com" "muc" -- Set up a SOCKS5 bytestream proxy for server-proxied file transfers: --Component "proxy.example.com" "proxy65" ---Set up an external component (default component port is 5347) -- -- External components allow adding various services, such as gateways/ -- transports to other networks like ICQ, MSN and Yahoo. For more info -- see: http://prosody.im/doc/components#adding_an_external_component -- --Component "gateway.example.com" -- component_secret = "password"</span></span></code> </pre></div></div><br>  We need to create another config for mod_lib_ldap, I will download the sample and change it to fit my needs <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/prosody wget http://0-8.prosody-modules.googlecode.com/hg/mod_lib_ldap/dev/prosody-posix-ldap.cfg.lua chmod 755 prosody-posix-ldap.cfg.lua</code> </pre><br>  Documentation and samples are here - <a href="http://0-8.prosody-modules.googlecode.com/hg/mod_lib_ldap/dev/">0-8.prosody-modules.googlecode.com/hg/mod_lib_ldap/dev</a> <br>  I will cite immediately a sample of the finished config: <br><div class="spoiler">  <b class="spoiler_title">/etc/prosody/prosody-posix-ldap.cfg.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">-- Use Include 'prosody-posix-ldap.cfg.lua' from prosody.cfg.lua to include this file authentication = 'ldap' -- Indicate that we want to use LDAP for authentication --storage = 'ldap' -- Indicate that we want to use LDAP for roster/vcard storage storage = { roster = "ldap"; vcard = "ldap"; } ldap = { hostname = 'localhost', -- LDAP server location bind_dn = 'cn=manager,dc=example,dc=com', -- Bind DN for LDAP authentication (optional if anonymous bind is supported) bind_password = 'password', -- Bind password (optional if anonymous bind is supported) user = { basedn = 'ou=users,dc=example,dc=com', -- The base DN where user records can be found filter = 'objectClass=posixAccount', -- Filter expression to find user records under basedn usernamefield = 'uid', -- The field that contains the user's ID (this will be the username portion of the JID) namefield = 'cn', -- The field that contains the user's full name (this will be the alias found in the roster) }, groups = { basedn = 'ou=groups,dc=example,dc=com', -- The base DN where group records can be found memberfield = 'memberUid', -- The field that contains user ID records for this group (each member must have a corresponding entry under the user basedn with the same value in usernamefield) namefield = 'cn', -- The field that contains the group's name (used for matching groups in LDAP to group definitions below) { name = 'First Group', -- The group name that will be seen in users' rosters cn = 'first_group', -- This field's key *must* match ldap.groups.namefield! It's the name of the LDAP group this definition represents admin = false, -- (Optional) A boolean flag that indicates whether members of this group should be considered administrators. }, { name = 'Second Group', cn = 'second_group', admin = true, }, }, vcard_format = { displayname = 'cn', -- Consult the vCard configuration section in the README nickname = 'uid', }, }</span></span></code> </pre></div></div><br>  In this config in the groups array I listed the groups from LDAP.  Now the user will see all users belonging to his group. <br>  But I need the user to see all users, including those who do not belong to his group.  This will require adjustments in /usr/lib/prosody/modules/mod_storage_ldap.lua.  <u>If you do not have such a need, skip this item.</u> <br>  Find the /usr/lib/prosody/modules/mod_storage_ldap.lua line <br><pre> <code class="lua hljs"> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> filter = memberfield .. <span class="hljs-string"><span class="hljs-string">'='</span></span> .. <span class="hljs-built_in"><span class="hljs-built_in">tostring</span></span>(username);</code> </pre>  Comment out and just declare the variable without assigning values: <br><pre> <code class="lua hljs"> <span class="hljs-comment"><span class="hljs-comment">--local filter = memberfield .. '=' .. tostring(username); local filter;</span></span></code> </pre><br>  Check the logs (/ var / log / prosody) for errors. <br>  It is possible that you will need to install lualdap, and you will have to compile it from source. <br>  First you need to download raw <a href="">lualdap</a> and <a href="http://files.luaforge.net/releases/compat/Compat-5.1/Compat-5.1release5">compat</a> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      apt-get install libldap-dev liblua5.1-0-dev #        mkdir /tmp/lualdap cd /tmp/lualdap #   wget http://files.luaforge.net/releases/lualdap/lualdap/LuaLDAP1.1.0/lualdap-1.1.0.tar.gz wget http://files.luaforge.net/releases/compat/Compat-5.1/Compat-5.1release5/compat-5.1r5.tar.gz #  tar xvfz compat-5.1r5.tar.gz tar xvfz lualdap-1.1.0.tar.gz</span></span></code> </pre><br>  Now it is necessary to make configs, specify the correct paths.  My configs look like this: <br><div class="spoiler">  <b class="spoiler_title">lualdap-1.1.0 / config</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Installation directories # System's libraries directory (where binary libraries are installed) LUA_LIBDIR= /usr/lib/lua/5.1 # Lua includes directory LUA_INC= /usr/include/lua5.1 # OpenLDAP includes directory OPENLDAP_INC= /usr/include # OpenLDAP library (an optional directory can be specified with -L&lt;dir&gt;) OPENLDAP_LIB= -lldap # OS dependent LIB_OPTION= -shared #for Linux #LIB_OPTION= -bundle -undefined dynamic_lookup #for MacOS X # Lua version number (first and second digits of target version) LUA_VERSION_NUM= 500 LIBNAME= $T.so.$V COMPAT_DIR= ../compat-5.1r5 # Compilation parameters WARN= -O2 -Wall -fPIC -W -Waggregate-return -Wcast-align -Wmissing-prototypes -Wnested-externs -Wshadow -Wwrite-strings -ansi INCS= -I$(LUA_INC) -I$(OPENLDAP_INC) -I$(COMPAT_DIR) CFLAGS= $(WARN) $(INCS) CC= gcc # $Id: config,v 1.5 2006/07/24 01:42:06 tomas Exp $</span></span></code> </pre> </div></div><div class="spoiler">  <b class="spoiler_title">lualdap-1.1.0 / Makefile</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># $Id: Makefile,v 1.30 2007/03/13 22:07:33 godinho Exp $ T= lualdap V= 1.1.0 CONFIG= ./config include $(CONFIG) ifeq "$(LUA_VERSION_NUM)" "500" COMPAT_O= $(COMPAT_DIR)/compat-5.1.o endif OBJS= src/lualdap.o $(COMPAT_O) src/$(LIBNAME): $(OBJS) export MACOSX_DEPLOYMENT_TARGET="10.3"; $(CC) $(CFLAGS) $(LIB_OPTION) -o src/$(LIBNAME) $(OBJS) $(OPENLDAP_LIB) $(COMPAT_DIR)/compat-5.1.o: $(COMPAT_DIR)/compat-5.1.c $(CC) -c $(CFLAGS) -o $@ $(COMPAT_DIR)/compat-5.1.c install: src/$(LIBNAME) mkdir -p $(LUA_LIBDIR) cp src/$(LIBNAME) $(LUA_LIBDIR) cd $(LUA_LIBDIR); ln -f -s $(LIBNAME) $T.so clean: rm -f $(OBJS) src/$(LIBNAME)</span></span></code> </pre></div></div><br>  Compile and install <br><pre> <code class="bash hljs">make make install</code> </pre><br>  That's all, thank you for your attention! <br><br>  useful links <br><ul><li>  <a href="http://www.prosody.im/doc">Prosody documentation</a> </li><li>  <a href="https://code.google.com/p/prosody-modules/">Modules not included in the main package</a> </li><li>  <a href="https://wiki.koumbit.net/ProsodyConfiguration">Additional documentation on the Prosody + LDAP bundle</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/161443/">https://habr.com/ru/post/161443/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../161429/index.html">About healthy reflection and honesty</a></li>
<li><a href="../161431/index.html">Only 25 developers get 50% of profits in the App Store and Play</a></li>
<li><a href="../161433/index.html">Virtualization index</a></li>
<li><a href="../161437/index.html">MapReduce 2.0. What is modern digital elephant?</a></li>
<li><a href="../161439/index.html">New ICS firmware (6.1.1.B.1.54) for Sony Xperia P, U, go and sola</a></li>
<li><a href="../161447/index.html">AWS: RDS Micro instances are now available in VPC</a></li>
<li><a href="../161449/index.html">Stubborn Maverick Huang Zhang and his Meizu smartphones</a></li>
<li><a href="../161451/index.html">NASA talked about the new rover and other Mars exploration plans</a></li>
<li><a href="../161453/index.html">Runetology (176): Sergey Zhitinsky, Director of Web Services Development Subscribe.ru</a></li>
<li><a href="../161455/index.html">Tricks of the developer under iOS. Splash screen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>