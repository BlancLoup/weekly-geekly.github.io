<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Attempt to do without regular expressions for phone numbers of own region</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% username%! 
 In the process of administering Asterisk PBX, sooner or later there is a need to route calls to directions and most often it is: city...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Attempt to do without regular expressions for phone numbers of own region</h1><div class="post__text post__text-html js-mediator-article"><h4>  Hi% username%! </h4><br>  In the process of administering Asterisk PBX, sooner or later there is a need to route calls to directions and most often it is: city, MN, intra-zone communication, MG.  With the first two everything is clear.  But the last two ... Well, and what is difficult you say?  A car and a small cart of articles and scripts about the compilation of regular expressions for DEF and ABC codes have already been written, but periodically all these regulars have to be updated.  And then there was a thought, is it possible to automate it.  Unfortunately, something ready, and most importantly suitable, could not be found.  So we will reinvent your bike. <br><a name="habracut"></a><br>  To do this, we need to do the following: <br><br><ol><li>  Configure an asterisk connection to the database </li><li>  Create and fill in a table with DEF and ABC region codes </li><li>  Describe the functions additional features for asterisk </li><li>  Write contexts for the directions we need. </li></ol><br><br><h5>  Step 1. Configure the asterisk connection to the database </h5><br>  I assume that you already have a database installed and configured.  Due to the fact that I have implemented a realtime mechanism that uses the postgresql database, all the described further actions will be valid for postgresql, for other databases, minor changes may be required. <br>  On the server with asterisk, install unixodbc, as well as the postgresql driver for odbc with all dependencies.  For Debian / Ubuntu, this is done with the command: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>#apt-get install unixodbc odbc-postgresql</code> <br> <br>  We give the odbc driver description file to the following form: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat /etc/odbcini.ini [PostgreSQL ANSI] Description = PostgreSQL ODBC driver (ANSI version) Driver = /usr/lib/x86_64-linux-gnu/odbc/psqlodbca.so Setup = /usr/lib/x86_64-linux-gnu/odbc/libodbcpsqlS.so Debug = 0 CommLog = 1 UsageCount = 1 [PostgreSQL Unicode] Description = PostgreSQL ODBC driver (Unicode version) Driver = /usr/lib/x86_64-linux-gnu/odbc/psqlodbcw.so Setup = /usr/lib/x86_64-linux-gnu/odbc/libodbcpsqlS.so Debug = 0 CommLog = 1 UsageCount = 1</span></span></code> </pre><br><br>  For 32-bit systems, the path to the drivers will be different. <br><br>  Create a connection with a previously created database: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/odbc.ini [config] Description = PostgreSQL connection to 'asterisk' database Driver = PostgreSQL ANSI Database = asterisk Servername = 192.168.204.167 UserName = asterisk Password = Uidj$5tuYF Port = 5432 Protocol = 9.1 KSQO = No ReadOnly = No RowVersioning = No ShowSystemTables = No ShowOidColumn = No FakeOidIndex = No ConnSettings =</span></span></code> </pre><br><br>  Check the connection to the database: <br><br><pre> <code class="bash hljs">isql config</code> </pre> <br>  If we see the following invitation: <br><pre> <code class="bash hljs">+---------------------------------------+ | Connected! | | | | sql-statement | | <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> [tablename] | | quit | | | +---------------------------------------+ SQL&gt;</code> </pre> <br><br>  it means that our connection is working fine. <br><br>  Register this connection in /etc/asterisk/res_odbc.conf: <br><br><pre> <code class="bash hljs">[asterisk] enabled =&gt; yes dsn =&gt; config username =&gt; asterisk password =&gt; Uidj<span class="hljs-variable"><span class="hljs-variable">$5tuYF</span></span> pre-connect =&gt; yes</code> </pre> <br><br><h5>  Step 2. Create and fill in a table with DEF and ABC region codes </h5><br>  On the database server we create an asterisk database inside, with which we create approximately the following table (the minimum required number of columns is indicated): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> zones ( <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">finish</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITHOUT</span></span> OIDS;</code> </pre><br><br>  Fill in the created table by running the following script: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash REGION='' echo "COPY zones FROM stdin;" &gt; zones.sql wget -q http://www.rossvyaz.ru/docs/articles/DEF-9x.html -O DEF-9x.html cat DEF-9x.html|iconv -f cp1251 -t utf8|grep -i $REGION|awk '{print($3"\t"$6"\t"$9)}' &gt;&gt; zones.sql rm DEF-9x.html wget -q http://rossvyaz.ru/docs/articles/ABC-3x.html -O ABC-3x.html cat ABC-3x.html |iconv -f cp1251 -t utf8|grep -i $REGION|awk '{print($3"\t"$6"\t"$9)}' &gt;&gt; zones.sql rm ABC-3x.html wget -q http://rossvyaz.ru/docs/articles/ABC-4x.html -O ABC-4x.html cat ABC-4x.html |iconv -f cp1251 -t utf8|grep -i $REGION|awk '{print($3"\t"$6"\t"$9)}' &gt;&gt; zones.sql rm ABC-4x.html wget -q http://rossvyaz.ru/docs/articles/ABC-8x.html -O ABC-8x.html cat ABC-8x.html |iconv -f cp1251 -t utf8|grep -i $REGION|awk '{print($3"\t"$6"\t"$9)}' &gt;&gt; zones.sql rm ABC-8x.html echo "\." &gt;&gt; zones.sql psql -U asterisk -d asterisk -c 'DELETE FROM zones' psql -U asterisk -d asterisk -f zones.sql rm zones.sql</span></span></code> </pre><br><br><h5>  Step 3. Describe the functions additional functions for asterisk </h5><br>  We will need an additional function, which we will describe in /etc/asterisk/func_odbc.conf <br><br><pre> <code class="bash hljs">[ZONES] prefix=CHECK dsn=asterisk readhandle=asterisk readsql=SELECT count(*) from zones <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> def=<span class="hljs-string"><span class="hljs-string">'${ARG1:1:3}'</span></span> and start&lt;=<span class="hljs-string"><span class="hljs-string">'${ARG1:4}'</span></span> and finish&gt;=<span class="hljs-string"><span class="hljs-string">'${ARG1:4}'</span></span></code> </pre><br><br><h5>  Step 4. Write contexts for the directions we need. </h5><br>  Final step: describe contexts. <br><br>  The first context is for subscribers who are allowed only intrazone calls: <br><br><pre> <code class="bash hljs">[zones] include =&gt; template</code> </pre><br><br>  The second for those who are allowed long distance calls: <br><br><pre> <code class="bash hljs">[meggorod] include =&gt; template</code> </pre><br><br>  Yes, they are the same: <br><br><pre> <code class="bash hljs">[template] exten =&gt; _8XXXXXXXXXX,1,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CHECK_ZONES(${EXTEN}</span></span></span><span class="hljs-string">)}"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span>]?4) same =&gt; 2,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CONTEXT}</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"meggorod"</span></span>]?6:error,1) same =&gt; 3,Hangup() same =&gt; 4,Dial(SIP/prov1/<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>,30,tTS(3600)gxX) same =&gt; 5,Hangup() same =&gt; 6,Dial(SIP/prov2/<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>,30,tTS(3600)gxX) exten =&gt; error,1,Playback(an-error-has-occured) exten =&gt; error,n,Hangup()</code> </pre><br><br>  Well, that seems to be all.  The option is far from ideal, but it works. </div><p>Source: <a href="https://habr.com/ru/post/148401/">https://habr.com/ru/post/148401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148391/index.html">Webinar Announcement: Managing Account Locks in a Corporate Environment</a></li>
<li><a href="../148394/index.html">100-watt USB 3.0 will put an end to proprietary chargers</a></li>
<li><a href="../148396/index.html">Dating "Mamba" on Windows Phone</a></li>
<li><a href="../148398/index.html">Installing Windows 7/8 on a Mac without using an optical drive</a></li>
<li><a href="../148400/index.html">We connect AWS Elastic Beanstalk and –°loudBees</a></li>
<li><a href="../148402/index.html">Gittip - Github crowdfunding</a></li>
<li><a href="../148403/index.html">SOAP Web service using Spring-WS</a></li>
<li><a href="../148404/index.html">A simple bookmarklet as a tool to clean webpage content from unwanted items.</a></li>
<li><a href="../148406/index.html">New standoff between WHATWG and W3C: in whose hands is the future of HTML5?</a></li>
<li><a href="../148407/index.html">PyBrain work with neural networks in Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>