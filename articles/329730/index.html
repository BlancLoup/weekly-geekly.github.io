<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Confrontation" PHDays or what we were called the "All-seeing Eye"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last week, the Positive Hack Days 7 conference was held, within which we can now say the traditional (second time, what is not tradition?) Battle of D...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Confrontation" PHDays or what we were called the "All-seeing Eye"</h1><div class="post__text post__text-html js-mediator-article">  Last week, the <a href="https://www.phdays.ru/">Positive Hack Days 7</a> conference was held, within which we can now say the traditional (second time, what is not tradition?) Battle of Defenders and Attacking - The Standoff. <br><br>  The bottom line is ... A participant can play with SOCs, guarding the city and the villain.  And if a user plays as defenders, he is given various means of protection, and villains infiltrate the city segments.  You can rob a cow ... <br><br><img src="https://habrastorage.org/web/6ed/4b7/ea8/6ed4b7ea8630465bb78254a388981850.jpg" alt="image"><br><a name="habracut"></a><br><h2>  <font color="orange">Participants of the Confrontation</font> </h2><br>  A more detailed description of the roles of the participants is on the organizer's website (Positive Technologies): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Spoiler header</b> <div class="spoiler_text">  <b>Attackers</b> <br>  Attackers are free to do anything, the main thing is not to violate the logic of construction and operation of the landfill.  No troubles and flags, the participants decide for themselves what they want from the city.  The task of the attackers is to accomplish the goals set for them by any means convenient for them. <br><br>  <b>Defenders</b> <br>  Both corporate teams and individual specialists can act as defenders (it is possible under a pseudonym).  The defenders will have several specialized teams, each of which will ensure the safety of one object on the range - the operator, the office, etc. <br><br>  The tasks of the teams include the design, installation, configuration and operation of protective equipment, as well as ensuring the safety and security of the assets of the company to which they are assigned.  During the game, the defenders must periodically report on the incidents and work done. <br><br>  There are 5 objects of protection: <br><br><ul><li>  Telecom operator </li><li>  Office </li><li>  CHP and substation </li><li>  Oil company </li><li>  Railway company </li></ul><br>  <b>External SOC</b> <br><br>  During the Confrontation, the SOC must promptly notify the defenders of the attacks and propose protective measures.  As well as defenders, SOC teams must publicly report on the attacks carried out and the hacking methods used, provide statistics on the security of the test site (attack trends and other metrics). <br></div></div><br><h2>  <font color="orange">Training</font> </h2><br>  The first general briefing of the participants in the Confrontation took place on April 12, where the organizers told about plans to build a city that would have to be ‚Äúhacked‚Äù and protected.  <a href="https://habrahabr.ru/company/pm/blog/326810/">We got the role of SOC</a> in one of the office segments.  SPAN (Servionica Palo Alto Networks) team has become the defenders of this segment. <br><br><img src="https://habrastorage.org/web/fe4/355/6ac/fe43556acf7e431c92d866eeb5ae51c7.jpg" alt="image"><br><br>  They turned out to be trained professionals and excellent guys, with whom we quickly found a common language and worked together on the site of the game itself. <br><br>  Our secondary task was to monitor the city in order to detect and analyze attacks on the urban infrastructure. <br><br><img src="https://habrastorage.org/web/fe7/989/64c/fe798964cfb948c5b378747a1c7c3e0b.jpg" alt="image"><br><br>  The office segment of the city was fully raised by the organizers in a virtual infrastructure based on VMware. <br><br>  About three weeks before the event, we got access (thanks to the organizers) to the virtual machine with MaxPatrol 8 for scanning and building a network map.  It turned out 1719 pages pdf-report. <br><br>  The week we installed and tested our monitoring tools.  We planned to use: <br><br><ul><li>  IDS for Office. </li><li>  IDS for the City. </li><li>  Moloch for recording and analyzing traffic. </li><li>  Network Analyzer to detect anomalies in office traffic. </li><li>  Network Analyzer to detect anomalies in the traffic of the City. </li><li>  HIDS (host IDS) to monitor key Office servers. </li><li>  TIAS for log analysis, monitoring and analytics. </li></ul><br>  Everything worked as it should.  We painted a shift watch group monitoring. <br><br>  Pentester said that "on the site I will be all 30 hours and have a great time off." <br><br>  PR said ‚ÄúPHDays is the only way to make a carbon banner‚Äù. <br><br><img src="https://habrastorage.org/web/ec3/ac2/c4b/ec3ac2c4b27f4d1e82028ff786619b37.jpg" alt="image"><br><br>  There was a feeling that we are ready. <br><br><h2>  <font color="orange">Began!</font> </h2><br><img src="https://habrastorage.org/web/85d/d2f/726/85dd2f7262004f13b821e608d731329e.jpg" alt="image"><br><br>  Not really. <br><br>  ‚ÄúGuys, there is no traffic on our sensors!‚Äù Is our motto and a call to the organizers for the first 8 hours of the Confrontation, which began at about 11-30. <br><br>  Unfortunately, due to technical difficulties, only by 19 o'clock was it possible to send traffic to both IDS: <br><br><ul><li>  Only traffic from the DMZ was sent to the Office, although a mirror of all traffic was required. </li><li>  On the City, traffic was given to the Office‚Äôs outer perimeter and traffic to several more vlans without specification. </li></ul><br>  In terms of volume and observed events, it was clear that far from all traffic was mirrored (although it was requested to the maximum).  About traffic mirror on Moloch and say no.  And without it, the analysis of anomalies does not make sense. <br><br>  In fact, everything we did in the week before the event had to be redone again right on the site.  Nevertheless, all the same it is necessary to thank the admins of the organizers, they harnessed and helped, where they could. <br><br>  Valiant defenders for a long time tried to deploy the HIDS agents for control, however, due to the periodic fall of the infrastructure and the lack of access to the Internet from the infrastructure for connections to the repositories, this was never possible. <br><br>  There was no direct access to the controlled infrastructure, everyone was climbing through a VPN, which also did not add joy.  Sadness sadness melancholy ... But the sad thing ends here! <br><br><ol><li>  Do not forget that the Attackers were in the same conditions, but for them the space is important, freedom - they periodically sat much more sad than the defenders. </li><li>  At least some traffic is received - it means you can already work! </li><li>  The defenders to the interaction are open, the gaps overlap - it means everything is not so bad today. </li></ol><br>  Another interesting story was the dynamic allocation of resources on a virtualization farm.  Two SOC analysts sat side by side.  Their jobs are also in virtuals.  One flew everything, and the other quietly swore at the monitor and said that he had never seen the console slow down. <br><br><img src="https://habrastorage.org/web/10d/98f/aab/10d98faabfdc430e9cb6ff2e153ed225.png" alt="image"><br><br>  As a result, during the night and for almost a whole day of monitoring, we managed both to attack and to monitor the controlled segment. <br><br><h2>  <font color="orange">What was fixed</font> </h2><br><h3>  By office segment </h3><br><ol><li>  As soon as traffic was given, someone constantly broke from one of our web servers (198.18.12.177) with incomprehensible and always the same credits from the address 198.18.78.12.  They checked - the activity is strange, but not dangerous.  Then we will think about it all night long.  What they wanted - remains a mystery.  Apparently, something went wrong with the Attackers. </li><li>  Against the background of claim 1.  scans were constantly coming from the same address, exploits and other devilry were falling.  Identified NAT Attackers.  It was a pity it was impossible to block - fair-play and all that. </li><li>  Suspicion of the compromise of our server (198.18.12.169) from the DMZ - from it there was an unhealthy interest in the mysql internal resource (10.25.153.24).  The defenders did not answer, how many did not ask.  Nothing else came from this address.  The compromise was not confirmed, possibly a system checker.  Watched him with one eye. </li><li>  While monitored, in parallel investigated their own DMZ.  XSS was detected on another web server (198.18.12.179).  We until the next day's lunch loomed about this to the defenders.  As soon as they began to massively try to inject xss, they quickly responded and banned the special characters in the url.  As none of the attackers took advantage of - a mystery! </li><li>  On the same web server (198.18.12.179) fixed pureFTP.  SZI blocked alien calls to FTP.  Everything is good. </li><li>  On the third web-server (198.18.12.180) we found an open repository of the site (/.git) and notified defenders.  They promptly shut down.  Teamwork! </li><li>  At about 00:30, the subnet 10.64.94.0/24 was activated on the internal network.  From there immediately began brute force services in the DMZ.  Defenders blocked this subnet, there was no other way out.  * Yes, yes, blocking is impossible, but the enemy can not be left inside, it‚Äôs impossible to break everything! </li><li>  Another web server (198.18.12.141), another available directory / install.  Attackers could drag the site to their database and compromise users.  The defenders closed access to the folder. </li><li>  In the middle of the night, anomalous activity began between the user segment and the domain controller!  Attacked SMB.  The analysis showed that the DSS from the NSD Secret Net lives its own life and tries to communicate with the main server.  Ok, false positive - go further. </li><li>  On 198.18.12.169 found / wp_include with all sources.  The defenders closed down. </li><li>  From 05:00 to 07:00 calm.  Pokemaril. </li><li>  From 8:00 they started to scan with new forces, no longer trying to hide and not being embarrassed in the means: nmap, sqlmap, nessus, a bunch of self-written scanners (well, or just scripts for nmap).  Particularly pleased with the scanner, judging by the user-agent: go-http-client - samopisny, walked through a decent set of vulnerabilities. </li><li>  Around the mess - exploits, injections, brute force, scans.  All in all, but all the same, useless and uninteresting. </li><li>  We saw that the node appeared 198.18.12.143.  It was wordpress (almost like everywhere else) with open API access with credits admin: admin123.  Hand picked up from the second attempt.  Zaalertili, promptly closed. </li><li>  Until the last brutey access to FTP.  Connections were cut SZI. </li></ol><br>  Facebook member of the SPAN team <br><blockquote>  ‚ÄúI‚Äôm a safeguard, I don‚Äôt want to solve anything, I want to write custom signatures and watch the packages drop.‚Äù <br><br>  - Oh, send drops! </blockquote><br><img src="https://habrastorage.org/web/8d3/bee/bf3/8d3beebf38d6414480929579d0272827.jpg" alt="image"><br><br><h3>  By the city </h3><br><ol><li>  20:26 recorded a successful brutfors smb 172.20.3.147 from 10.25.21.23.  Whose address is unknown.  No luck to anyone. </li><li>  In general, smb, snmp, sql stuck around the city.  The attackers walked on them like on their own.  Brutfors on all fronts. </li><li>  We fixed that on site 203.0.113.169 (like the Telecom object) wordpress and the admin panel was open ... If it weren't for the white hat, they would break it. </li><li>  At the end, re-successfully sbled 17.2.20.3.147 smb from 10.25.21.24 (maybe the same ones, just didn't turn off the script). </li></ol><br><h2>  <font color="orange">What happened and did not work</font> </h2><br>  If you evaluate globally - attacking well done!  They broke the process control system and cleaned out the bank and intercepted even the ‚Äúmayor‚Äù sms.  As for our Office, it remained untouched, and the defense team completed the standoff with a full 100% "reputation." <br><br>  Of course, from the attackers, we expected a stronger pressure.  What were their difficulties related to?  We have three hypotheses: <br><br><ol><li>  They did not use all their arsenal.  Confrontation is still a game and, perhaps, we were not shown all the tools in order to have a reserve for real projects.  And the well-known tools and techniques are easily blocked by means of protection. </li><li>  The attackers (like the defenders) did not have direct access to the City‚Äôs network, perhaps part of the arsenal simply did not take off. </li><li>  Attackers face difficulties when they are actively and quickly counteracted.  If you act on the forehead, this is obvious, and if it is thinner, then it will take more time, and the requirements for the skill are different. </li></ol><br>  It is very sad that there were such large-scale technical difficulties, there was little traffic.  But this is still elegant space for analytics! <br><br>  By next year, we will take into account all the mistakes and understand what to demand from the organizers.  We are waiting for PHDays 8. <br><br><img src="https://habrastorage.org/web/bae/d65/79d/baed6579dae842db8f026f85f43e1de7.jpg" alt="image"><br><br><h2>  <font color="orange">Thanks</font> </h2><br>  We thank Positive Technologies (especially Victoria, Alexey, Mikhail and Tamara) for organizing this holiday. <br><br>  We thank the SPAN team for their protection, experience and a good team game. <br><br>  Thanks to our whole team, you are very cool. <br><br>  And a special thank you to captain of the monitoring team Maxim <a href="https://habrahabr.ru/users/baymaxx/" class="user_link">Baymaxx</a> for preparing this report. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://coub.com/embed/ukh2i" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Now a ‚ÄúAll-Seeing Eye‚Äù sign adorns one of the walls of the Monitoring Center. <br><br><img src="https://habrastorage.org/web/165/91c/341/16591c341cd845c58e79612c7cf83760.jpg" alt="image"><br><br><h2>  <font color="orange">Other blog articles</font> </h2><br>  <a href="https://habrahabr.ru/post/328008/">UAC Bypass or the story of three escalations</a> <br><br>  <a href="https://habrahabr.ru/post/326810/">Report of the Information Security Monitoring Center for the first quarter of 2017</a> <br><br>  <a href="https://habrahabr.ru/post/325716/">Life without SDL.</a>  <a href="https://habrahabr.ru/post/325716/">Winter 2017</a> </div><p>Source: <a href="https://habr.com/ru/post/329730/">https://habr.com/ru/post/329730/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329720/index.html">About circumventing access restrictions to postal services</a></li>
<li><a href="../329722/index.html">A comprehensive guide to using HTTP / 2 Server Push</a></li>
<li><a href="../329724/index.html">Another DoS vulnerability</a></li>
<li><a href="../329726/index.html">Educational online project: "Start in web development"</a></li>
<li><a href="../329728/index.html">Nikita Lipsky and Dmitry Chuiko on AOT in Java on jug.msk.ru</a></li>
<li><a href="../329732/index.html">Innopolis and the slow pursuit of the silicon valleys</a></li>
<li><a href="../329734/index.html">Cisco CloudCenter - Any Application. Any Cloud. One platform</a></li>
<li><a href="../329736/index.html">Apache Cassandra + Apache Ignite - how to combine the best</a></li>
<li><a href="../329738/index.html">Chronobank: we sell time, we ‚Äúbuy‚Äù people</a></li>
<li><a href="../329740/index.html">Mock dependency in node.js applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>