<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Server javascript, 1ms per transformation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What for? 

 The question ‚ÄúWhy?‚Äù Is the most important when making any decision. In our case, there were several reasons. 

 First, the people. The cu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Server javascript, 1ms per transformation</h1><div class="post__text post__text-html js-mediator-article"><h4>  What for? </h4><br><br>  The question ‚ÄúWhy?‚Äù Is the most important when making any decision.  In our case, there were several reasons. <br><br>  First, the people.  The current templating engine was processed by C.  All questions about his changes were not resolved quickly.  And the most important thing is that some people wrote the templating engine, but used completely different ones. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, this is a frequent and, in my opinion, not very good practice of writing tools for web designers.  It is clear that they need tools, but these tools are implemented by people who very remotely imagine the daily tasks of layout designers.  Rather, on the contrary, the decisions of the plan are often made ‚Äúwe will let them write the conditions and cycles, but nothing more can be needed in the layout‚Äù.  Perhaps it is the blame of the designers and their qualifications. <br><br>  But Mail.Ru Group has a whole team of highly qualified people who know JS, who are able to write a tool on their own, and most importantly, they will use it. <br><br>  Secondly, the task.  Take the project Mail.ru.  We can‚Äôt refuse to use templating on the server - we need a fast download on the first login  We can‚Äôt refuse the standardization on the client - people should see a high reaction rate to their actions, which means that AJAX and the standardization on the client are required. <br><br>  The problem is obvious: two sets of completely different templates on the server and on the client.  And the most annoying that they solve the same problem.  Duplication of logic simply exhausted us. <br><br>  v8 is a JavaScript interpreter, which means we can get one template that works both on the server and on the client. <br><br>  Third, speed.  After reading a lot of articles, in which they praise the speed of v8, they decided to check their fairness.  But first it was necessary to understand how we want to see the new template engine. <br><a name="habracut"></a><br><h4>  What do you need </h4><br><br>  I will say right away that we are very limited in terms of server time for transformation, so there was no way to implement something very functional.  However, leaving the old functionality with the only difference in adding a layer from v8 is a strange idea. <br><br>  I have been using a lot of XSLT for transformation for a long time (not the fastest transformation option), although, if used correctly, it shows good numbers (I'm talking about libxslt).  But XSLT has a very powerful templating tool - redefining templates.  We decided to implement something similar, but much easier. <br><br><pre><code class="xml hljs">/head.xml ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:get</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtitle‚Äù/</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:set</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtitle‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span>Mail.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:set</span></span></span><span class="hljs-tag">&gt;</span></span> /mail.xml ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:include</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùhead.xml‚Äù/</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:set</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtitle‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span> Mail.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:set</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  It would be strange to use v8 and not to allow access to JavaScript in templates. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:script</span></span></span><span class="hljs-tag">&gt;</span></span> var text = ‚Äúmail.ru‚Äù <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:value</span></span></span><span class="hljs-tag">&gt;</span></span>text<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:value</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  And a lot of small things, in addition to standard conditions and cycles. <br><br><h4>  XML </h4><br><br>  We took XML as the syntax for the template engine. <br><br>  Support for basic functionality in the IDE.  One hundred percent of popular IDEs know what XML is.  Hyphenation, highlighting, basic autocompletion you get for free. <br><br>  Validation at IDE level.  Valid HTML is obtained through valid templates.  Again, all IDEs can validate xml as such. <br><br>  Modularity out of the box (name spaces).  The basic capabilities of the template engine very quickly want to expand.  For example, add a tag that allows you to do projects in multiple languages.  The Name Spaces system makes it easy to do. <br><br>  A wide range of ready-made tools.  Over the years, many tools have been accumulated for processing XML, for example, libraries for processing XML via XSL or a whole class of SAX parsers, XSD and DTD schemes for validation, etc. <br><br>  Matching syntax processing structures and resulting structures.  In other words, creating XML in XML is convenient, fest-templates are easy to read.  Plus resolved all data screening issues. <br><br><h4>  Implementation </h4><br><br><img src="https://habrastorage.org/getpro/habr/post_images/d5b/a4f/429/d5ba4f429255592a15d37e0a685018b0.jpg"><br><br>  Cowboy  I myself recently learned that there is such a term. <br><br>  Before that, I was sure that the most reliable way to accomplish a task was pair programming and tests.  Tests, as always, justified themselves, but there were alternatives to pair programming. <br><br>  The difference from the typical task: the template was known and the resulting HTML, which this template should produce.  Kostya and I (frontend mail developer) started writing our implementations.  Once a week we compared the transformation speed measurements. <br><br>  We chose two different approaches: he compiled the template into a function, and I into the structure.  An example of the simplest structure: <br><br><pre> <code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">01</span></span> [ <span class="hljs-number"><span class="hljs-number">02</span></span> {<span class="hljs-attr"><span class="hljs-attr">action</span></span>:<span class="hljs-string"><span class="hljs-string">"template"</span></span>}, <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;..."</span></span>, <span class="hljs-number"><span class="hljs-number">04</span></span> {<span class="hljs-attr"><span class="hljs-attr">action</span></span>:<span class="hljs-string"><span class="hljs-string">"value"</span></span>}, <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-string"><span class="hljs-string">"json.value"</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span> ]</code> </pre><br><br>  The second line marks the beginning of the pattern.  The third is just to give the browser.  The fourth says that the fifth should be executed as JavaScript and the result of the execution should be given to the browser. <br><br><pre> <code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">01</span></span> [ <span class="hljs-number"><span class="hljs-number">02</span></span> {<span class="hljs-attr"><span class="hljs-attr">action</span></span>:<span class="hljs-string"><span class="hljs-string">"template"</span></span>}, <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;....‚Äù, 04 {action:"</span></span><span class="hljs-keyword"><span class="hljs-keyword">if</span></span><span class="hljs-string"><span class="hljs-string">"}, 05 "</span></span>json.value<span class="hljs-string"><span class="hljs-string">", 06 "</span></span>&lt;span&gt;<span class="hljs-literal"><span class="hljs-literal">true</span></span>&lt;<span class="hljs-regexp"><span class="hljs-regexp">/span&gt;", 07 "&lt;span&gt;false&lt;/</span></span>span&gt;<span class="hljs-string"><span class="hljs-string">" 08 ]</span></span></code> </pre><br><br>  The option is a bit more complicated.  The fourth line means that the fifth must be executed, and if the result is true or false, then give the sixth or seventh line, respectively. <br><br>  The option with the function does not need to be specifically explained. <br><br><pre> <code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">template</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">json</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> html = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-number"><span class="hljs-number">03</span></span> html += <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;‚Ä¶"</span></span>; <span class="hljs-number"><span class="hljs-number">04</span></span> html += json.value; <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> html; <span class="hljs-number"><span class="hljs-number">07</span></span> }</code> </pre><br><br>  Looking ahead, I will say that his version was faster.  For some time we walked almost evenly, but the variant with the structure rested on the ceiling much earlier. <br><br>  To understand what gave such an approach: my first implementation carried out the task in 200ms.  When we squeezed everything we could and then put together the best of our two programs, we got 3ms. <br><br>  If we describe the current implementation briefly, we translate the cycles into cycles, conditional operators into conditional operators, etc. <br><br><pre> <code class="hljs cs">fest:<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">foreach</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; i &lt; l; i++</span></span></span><span class="hljs-function">)</span></span> {} fest:<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> {} fest:<span class="hljs-function"><span class="hljs-function">choose </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> {} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {}</code> </pre><br><br>  No context narrowing.  Yes, this is a restriction, but there is no overhead for restricting the context, and most importantly, as soon as you narrow the context, the problem immediately arises to get something from the global context or from the context a higher level. <br><br>  It is important that the templates are translated into the JS-function, which works in strict mode.  This does not give designers a chance to write code that will lead to memory leaks. <br><br>  Wherever a logical work with data is needed, JavaScript is available. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:if</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">test</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äù_javascript_‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:if</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:value</span></span></span><span class="hljs-tag">&gt;</span></span>_javascript_<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:value</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  All constructions that assume the execution of JavaScript are wrapped in a try catch. <br><br>  All constructions that assume output in HTML after the execution of JavaScript, by default, pass HTML escape. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:value</span></span></span><span class="hljs-tag">&gt;</span></span>json.name<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fest:value</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { html += __escape(json.name) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) {}</code> </pre><br><br>  From the very beginning, the development of a template engine is carried out in the open form. <br>  <a href="https://github.com/mailru/fest">https://github.com/mailru/fest</a> <br><br><h4>  Integration capabilities </h4><br><br>  On the one hand, v8 is only a library that allows you to interpret JavaScript.  By itself, it seems useless - no access to the system.  But, on the other hand, it is easily screwed to other languages. <br><br>  Having zero programming experience in C and Perl, I made test examples in both languages.  Plus, at the moment we have a bunch of Python. <br><br>  And, of course, NodeJS for prototypes and browsers are environments where JavaScript templates work out of the box. <br><br><h4>  Conditions close to combat </h4><br><br>  After receiving 3ms, I went to the server-side programmers.  When they asked how much time I had for a request that gave the list of letters to the user, they said: no more than 4ms.  I already had 3ms to transform, I had to try. <br><br>  The list of letters we give our own http-server written in C.  Data acquisition - operations that do not compete for the processor, so they were not measured.  We stopped on the preparation of data for transformation and on the transformation itself. <br><br>  For historical reasons, our http server stores data in a flat hash. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">msg_length</span></span> = <span class="hljs-number"><span class="hljs-number">5</span></span> msg_1_title = ‚Äúletter‚Äù msg_1_Unread = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><br>  As we are talking about javascript, the first thing that comes to mind is JSON <br><br><pre> <code class="javascript hljs">msg = [ {<span class="hljs-attr"><span class="hljs-attr">title</span></span>: ‚Äúletter‚Äù, <span class="hljs-attr"><span class="hljs-attr">Unread</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>} ]</code> </pre><br><br>  We took a string with a flat hash, put it in memory and began to achieve a result when, when transforming a template into v8, JavaScript operated on JSON. <br><br>  Sifted through a lot of options.  To forward an object, forward a string and parse it in JavaScript, forward the string and pass it through JSON.parse. <br><br>  Oddly enough, the fastest is to convert a flat hash into a string that matches JSON, and in v8 to give the string <br><br><pre> <code class="hljs pgsql">‚Äú<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>([ {title: \‚Äúletter\‚Äù, Unread: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>} ])‚Äù</code> </pre><br><br>  But, despite everything, we rested on 6ms with the transformation of 2ms.  Everyone was ready to give up.  I nevertheless decided to take the source data, a string with a flat hash and, using the same compiled template, get the desired HTML on NodeJS. <br><br>  Got 4ms.  When I came to our sishnik with this number, to be honest, I expected the phrase ‚ÄúIt's great, but we have no resources to write NodeJS‚Äù But instead I heard ‚ÄúIf NodeJS can in 4ms, then we can also!‚Äù. <br><br><img src="http://content.foto.mail.ru/corp/a.sumin/3/i-4.jpg"><br><br>  It was at that moment that I realized that we would bring it to production.  There was a second wind! <br><br>  The solution was simple.  Since we lose 67% of the time on data preparation, and in principle we already have data, we need to throw out data preparation. <br><br>  We threw the function __get ('key') into v8.  Thus, we took data from v8 directly from the hash of our http server.  There is no data conversion in the desired format.  There is no conversion of this string to an object within v8.  We went out at 3ms and had a stock of 1ms. <br><br><img src="http://content.foto.mail.ru/corp/sumin/_myphoto/i-2.jpg" width="600"><br><br><h4>  Almost production </h4><br><br>  So, everything looks great, but we have not been close to the production yet.  Itching to try. <br><br>  We take a separate server, pick up on it the http version of the server that works with v8, and duplicate the real requests for it.  We leave for 30 hours one 2.2 GHz Xeon core. <br><br><pre> 10,000,000+ hits
 1.6ms average transformation time<font></font>
<font></font>
 992 422 10% between 2 and 5ms
 208 464 2% between 5 and 10ms
 39,649 0.4% more than 10ms
</pre><br><br>  Only 12% were over 2ms.  v8 behaves consistently from memory. <br><br><h4>  Production </h4><br><br>  I came with the latest figures to the deputy technical director, saying that v8 is ready for production, you need to do a separate small project, which, if anything, you can forget in case of failure.  In response, he received ‚Äúthe numbers are good, a separate project, the failure of which is not terrible - this is correct, but do you really want to run v8?  Start with the main Mail.Ru page. ‚Äù  The question is posed correctly - either we are doing business or having fun in the sidelines. <br><br>  The layout of the main page at the fest took three days.  Turned off one server from the balancer, filled in the version with v8 and duplicated requests.  All calculations will occur in the context of a single daemon / kernel. <br><br>  Then I will tell a very instructive story with a good ending. <br><br>  Always find out what your graphics show.  We allowed half of the load on the test server.  Processor consumption was three times higher than usual.  It looked like a failure, losing resources by six times compared with the current template engine. <br><br>  Began to watch.  Here I will talk a little about the main architecture.  It collects information from different projects.  Gathers its internal development, we call it RB.  Of the 165kb, which are generated for the return of the main, 100kb collects RB.  And the following happens: RB gives HTML chunks via http server in v8, v8 concatenates them with its own strings, and the result returns it all back to the http-server. <br><br>  There is a double probros data.  Did the optimization.  Now, v8 instead of building one big line, which includes data from the RB, sends the data immediately to the http-server. <br><br><pre> <code class="javascript hljs">__push_string(<span class="hljs-string"><span class="hljs-string">'foo'</span></span>); __push_rb(id); __push_string(<span class="hljs-string"><span class="hljs-string">'bar'</span></span>);</code> </pre><br><br>  As a plus, there is no string concatenation on v8, there is no RB double forwarding from server to v8 and back, and most importantly, any data forwarding is the conversion from utf-8 to utf-16 and back.  V8 stores everything in utf-16. <br><br>  There was a profit, resources were consumed twice as much as usual, and not three.  Those.  we still lost four times, although everything seemed to be squeezed to the last drop. <br><br>  And now the instructive part.  I took the interest for the sake of the load that we tested, multiplied by two, by the number of demons on the machine and by the number of machines.  Got 440 million hits.  In this case, we have 110 000 000 hits per day.  Vague doubts crept in. <br><br>  Let's go watch logies.  It turned out that for each request with a load, we received three requests with log reports for statistics!  The actual load on one http-server is four times lower than the one on which we are testing! <br><br>  The next morning, we rolled out a version of the main page with v8. <br><br>  Data for today: <br>  The size of the HTML generated, which generates v8 65kb. <br>  Time, work v8 on request 1ms. <br>  On average, v8 requires 40MB per context. <br><br><h4>  A pair of refinements </h4><br><br>  Everyone who thinks about v8, stumbled upon an article by Igor Sysoev <a href="http://sysoev.ru/prog/v8.html">sysoev.ru/prog/v8.html</a> <br><br>  For all the time we've been working on this task, V8 Vyacheslav Egorov (http://mrale.ph) has helped us a lot. <br><br>  Fears about memory are justified.  If correct work is critical for you (provided that the lack of memory is a normal situation), then you will have problems.  It is possible to intercept the allocation error correctly, but all that can be done about this is to correctly restart. <br><br>  But to be honest, we have only one product where this is critical.  As for the main page, we have multiple memory reserves and we monitor it very well. <br><br>  It turned out that our v8 trunk is flowing.  Vyacheslav did not succeed in reproducing this, but I think we will put together a test case that will help developers find a leak.  Version 3.6 behaves perfectly from memory. <br><br><h4>  useful links </h4><br>  - <a href="https://github.com/mailru/fest">github.com/mailru/fest</a> template engine <br>  - <a href="http://code.google.com/p/v8/">code.google.com/p/v8</a> v8 API <br>  - <a href="http://sysoev.ru/prog/v8.html">sysoev.ru/prog/v8.html</a> article by Igor Sysoev <br><br><br>  Andrei Sumin, Head of Client Development, Mail.ru </div><p>Source: <a href="https://habr.com/ru/post/141361/">https://habr.com/ru/post/141361/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141354/index.html">Flyway: database migration management</a></li>
<li><a href="../141355/index.html">Good alternative to tariff packages</a></li>
<li><a href="../141356/index.html">Computer Control via DropBox</a></li>
<li><a href="../141357/index.html">In the assembly of Opera Labs (Mobile) appeared support extensions</a></li>
<li><a href="../141358/index.html">How UniSender works: instructions for use</a></li>
<li><a href="../141362/index.html">Unity3d Lessons from Unity 3D Student (B00-B03)</a></li>
<li><a href="../141363/index.html">Building a data center, part 3: serve chilled</a></li>
<li><a href="../141364/index.html">Google CodeF in Russia!</a></li>
<li><a href="../141365/index.html">Blackhole + CVE-2012-0507 = Carberp</a></li>
<li><a href="../141366/index.html">Electronic Accountant # 15: Pocket Promoter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>