<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cach√© Native Access - working with native libraries in Cach√©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Picture to attract attention 

 As you know, Cach√© is not only a DBMS, but also a full-fledged programming language (Cach√© ObjectScript). Both from th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cach√© Native Access - working with native libraries in Cach√©</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e19/f6b/d73/e19f6bd731e019a2746f7863cac1ef39.jpg" alt="image"><br>  <font color="gray"><i>Picture to attract attention</i></font> <br><br>  As you know, Cach√© is not only a DBMS, but also a full-fledged programming language (Cach√© ObjectScript).  Both from the DBMS and Cach√© ObjectScript (COS) side, access beyond Cach√© is rich in capabilities (in .Net / Java through .Net / Java Gateway, to relational DBMS through SQL Gateway, working with web services).  But if we talk about working with native binary libraries, this interaction is implemented through the <a href="">Cach√© Callout Gateway</a> , which is somewhat specific.  On how to radically facilitate the work with native libraries directly from COS can be learned by cat. <br><br><a name="habracut"></a><br><h2>  Cach√© Callout Gateway </h2><br>  Today, Cach√© uses the <a href="">Cach√© Callout Gateway</a> to work with native code.  This name means several functions united under one name - $ ZF ().  These functions are divided into two groups: <br><ul><li>  $ ZF (-1), $ ZF (-2).  The first group of functions allows you to work with system commands and console programs.  This is an effective tool, but its drawback is obvious - the entire functionality of the library is difficult to implement in one or several programs. <br><div class="spoiler">  <b class="spoiler_title">Example using $ ZF (-1)</b> <div class="spoiler_text">  Creating a new folder in the working directory with the name ‚Äúnewfolder‚Äù: <br><pre><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = <span class="hljs-string"><span class="hljs-string">"newfolder"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = $ZF(<span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-string"><span class="hljs-string">"mkdir "</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>)</code> </pre> </div></div><br></li><li>  $ ZF (-3), $ ZF (-5), $ ZF ().  The second group of functions provides access to dynamic and static libraries.  This is more like what we need.  But not everything is so simple: $ ZF () does not work with any libraries, but only with libraries of a <i>special</i> type - <a href="">Callout Libraries</a> .  Callout Library differs from the usual library in the presence of a special character table ZFEntry in the code, which contains some analogue of the prototypes of the exported functions.  Moreover, the type of arguments of exported functions is strictly limited - only int and several types of pointers are supported.  That is, to make a Callout Library from an arbitrary library, you <i>will most likely</i> have to write a wrapper over the entire library, which is not convenient. <br><div class="spoiler">  <b class="spoiler_title">An example of creating a Callout Library and calling a function from it</b> <div class="spoiler_text">  Callout Library, test.c file: <br><pre> <code class="hljs lua">#define ZF_DLL #include &lt;cdzf.h&gt; //  cdzf.h    Cache/dev/cpp/include int square(int <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>, int *<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>) { *<span class="hljs-built_in"><span class="hljs-built_in">output</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ZF_SUCCESS; } ZFBEGIN //   ZFENTRY(<span class="hljs-string"><span class="hljs-string">"square"</span></span>, <span class="hljs-string"><span class="hljs-string">"iP"</span></span>, square) // <span class="hljs-string"><span class="hljs-string">"iP"</span></span> ,   square   - int  int * ZFEND</code> </pre><br>  Compile (mingw): <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">gcc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-mdll</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-fpic</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.c</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-o</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span></code> </pre>  On Linux, you must replace -mdll with -shared. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Calling square () from Cach√©: <br><pre> <code class="hljs perl">USER&gt; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> $ZF(-<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"test.dll"</span></span>, <span class="hljs-string"><span class="hljs-string">"square"</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-number"><span class="hljs-number">81</span></span></code> </pre></div></div><br></li></ul><br><br><h2>  Cach√© Native Access </h2><br>  To remove the limitations of Callout Gateway and make working with native libraries convenient, a <abbr title="Cach√© Native Access">CNA</abbr> project was created.  Name - tracing from a similar project for a Java-machine <a href="https://github.com/twall/jna">JNA</a> . <br><br><h4>  CNA features: </h4><ul><li>  You can call functions from any dynamic (shared) library that is binary compatible with C </li><li>  To call functions, only COS code is needed - there is no need to write anything on C or another compiled in computer code </li><li>  Support for all simple types of C language, size_t and pointers </li><li>  Support for structures (and nested structures) </li><li>  Cach√© thread support </li><li>  Platforms Supported: Linux (x86-32 / 64), Windows (x86-32 / 64) </li></ul><br><br><h2>  Installation </h2><br>  First we collect the C part, compiled by one command - <pre> <code class="bash hljs">make libffi &amp;&amp; make</code> </pre>  Under Windows, you can use to compile mingw, or download ready-made <a href="https://github.com/intersystems-ru/cna/releases">binaries</a> .  Then we import the cna.xml file into any convenient area: <pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> $system.OBJ.Load(<span class="hljs-string"><span class="hljs-string">"  cna.xml"</span></span>, <span class="hljs-string"><span class="hljs-string">"c"</span></span>)</code> </pre> <br><br><h2>  CNA example </h2><br>  The simplest native library that is on all systems is the standard C library. On Windows, it is usually located at C: \ Windows \ System32 \ msvcrt.dll, on Linux it is /usr/lib/libc.so.  Let's try to call some function from it, for example strlen, it has such a prototype: <pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *);</code> </pre> <br><br><pre> <code class="lisp hljs">Class CNA.Strlen Extends %RegisteredObject { ClassMethod Call(<span class="hljs-name"><span class="hljs-name">libcnaPath</span></span> As %String, libcPath As %String, string As %String) As %Integer { set cna = ##class(<span class="hljs-name"><span class="hljs-name">CNA</span></span>.CNA).%New(<span class="hljs-name"><span class="hljs-name">libcnaPath</span></span>) //    CNA.CNA do cna.LoadLibrary(<span class="hljs-name"><span class="hljs-name">libcPath</span></span>) //  libc  CNA set pString = cna.ConvertStringToPointer(<span class="hljs-name"><span class="hljs-name">string</span></span>) //     C      //  strlen:   ,   , //         set result = cna.CallFunction(<span class="hljs-string"><span class="hljs-string">"strlen"</span></span>, cna.#SIZET, $lb(<span class="hljs-name"><span class="hljs-name">cna</span></span>.#POINTER), pString) do cna.FreeLibrary() return result } }</code> </pre><br>  In the terminal: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;w ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(CNA.Strlen).<span class="hljs-keyword"><span class="hljs-keyword">Call</span></span>("libcna.dll", "C:\Windows\system32\msvcrt.dll", "hello") <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre><br><br><h2>  Implementation details </h2><br>  CNA is a bundle of C and Cach√© libraries.  Mostly CNA relies on <a href="https://sourceware.org/libffi/">libffi</a> .  libffi is a library that allows you to organize the "low level" of the interface of external functions (FFI).  It helps to forget about the existence of various calling conventions and to call functions at run time, without providing their specifications at compile time.  But to call functions from libffi you need the address of the function, and we would like to call functions only by name.  To get the address of the function from any of the name will have to use the platform-dependent interfaces: POSIX and WinAPI.  In POSIX, there is a dlopen () / dlsym () mechanism for loading the library and finding the address of a function; in WinAPI, the LoadLibrary () and GetProcAddress () functions.  This is one of the obstacles to porting CNA to other platforms, although on the other hand, almost all modern systems are at least partially, but they support the POSIX standard (except, of course, Windows). <br><br>  libffi is written in C and assembler.  Hence libffi is the native library, and access to it from Cach√© can only be obtained with the help of Callout Gateway.  That is, you need to write a layer that connects libffi and Cach√© and is a Callout Library so that it can be accessed from COS.  Approximate scheme of work of CNA: <br><img src="https://habrastorage.org/files/9dd/558/d53/9dd558d534d64892ac59dc41db17342e.png"><br><br>  At this stage, there is a data conversion problem.  When we call a function from COS, we pass arguments in the internal Cach√© format.  You need to transfer them to Callout Gateway, then to libffi, but you still need to convert them to C format somewhere. But Callout Gateway supports very few data types and if we converted data on the C side, we would have to send everything to as strings, and then parse them, which is not convenient for many reasons.  Therefore, it was decided to convert the data on the Cache side and pass all the arguments in the form of strings with binary data already in the C format. <br><br>  Since all data types C, except for composite, are numbers, in fact, the task of converting data comes down to converting numbers to binary strings using COS.  For these purposes, Cach√© has great features that allow you to bypass the need for direct data access: $ CHAR and $ ASCII, which convert an 8-bit number to a character and vice versa.  There are analogs for all the necessary numbers - for 16, 32 and 64-bit integers and double-precision floating-point numbers.  But there is one thing - all these functions work only for either signed or unsigned numbers (of course, when working with integers).  In C, as is well known, a number of any size can be either signed or unsigned.  To complement these functions to complete the work will have to manually. <br><br>  <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25BE%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BD%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BE%25D0%25B4_(%25D0%25BF%25D1%2580%25D0%25B5%25D0%25B4%25D1%2581%25D1%2582%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D1%2587%25D0%25B8%25D1%2581%25D0%25BB%25D0%25B0)">Additional code is</a> used to represent signed numbers in C: <br><ul><li>  The first bit is responsible for the sign of the number: 0 - plus, 1 - minus </li><li>  Positive numbers are encoded similarly unsigned. </li><li>  The maximum positive number is 2 <sup>k-1</sup> -1, k is the number of bits </li><li>  The code of a negative number x is the same as the code of an unsigned number 2 <sup>k</sup> + x </li></ul><br>  This method allows you to use the same implementation of addition as for unsigned numbers.  This is achieved through <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D1%2580%25D0%25B8%25D1%2584%25D0%25BC%25D0%25B5%25D1%2582%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B5_%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B5%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BD%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5">arithmetic overflow</a> . <br><br>  Consider an example conversion for unsigned 32-bit numbers.  If the number is positive, then we simply use the $ ZLCHAR function, if it is negative, then we need to find such an unsigned number so that they coincide in binary form.  How to search for this number directly follows from the definition of the additional code - you need to add the initial number to the minimum number that does not fit in 32 bits - 2 <sup>32</sup> or FFFFFFFF <sub>16</sub> + 1. The result is the following code: <br><br><pre> <code class="hljs bash"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x &lt; 0) { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> x = <span class="hljs-variable"><span class="hljs-variable">$ZLCHAR</span></span>(<span class="hljs-variable"><span class="hljs-variable">$ZHEX</span></span>(<span class="hljs-string"><span class="hljs-string">"FFFFFFFF"</span></span>) + x + 1) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> x = <span class="hljs-variable"><span class="hljs-variable">$ZLCHAR</span></span>(x) }</code> </pre><br>  The next problem is the transformation of the structures of the composite type of the C language. Everything would be simple if the structures in memory were represented in the same way as they were written - all fields follow in succession, one after another.  But in memory, the structure is arranged so that the address of each of the fields is a multiple of a special number, field alignment.  The end of the structure is also aligned - by the greatest field alignment.  Alignment is necessary due to the fact that most platforms either do not know how to work with non-aligned data, or they do it rather slowly.  Usually x86 alignment is equal to the size of the field, but there is an exception - 32-bit Linux, there the alignment of all fields that are larger than 4 bytes is equal to just 4 bytes.  More information about the alignment of data can be read in <a href="http://www.viva64.com/ru/l/0021/">this article</a> . <br><br>  Take, as an example, such a structure: <br><pre> <code class="hljs pgsql">struct X { <span class="hljs-type"><span class="hljs-type">char</span></span> a, b; // sizeof(<span class="hljs-type"><span class="hljs-type">char</span></span>) == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> c; // sizeof(<span class="hljs-type"><span class="hljs-type">double</span></span>) == <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-type"><span class="hljs-type">char</span></span> d; };</code> </pre><br>  On x86-32, it will be located in different OS in different OS: <br><br>  In practice, such a representation of the structure is formed quite simply.  It is necessary to write the fields in memory successively, but each time to form an indent (padding) is an empty space before writing.  Indent is calculated as follows: <br><pre> <code class="lisp hljs">set padding = (<span class="hljs-name"><span class="hljs-name">alignment</span></span> - (<span class="hljs-name"><span class="hljs-name">offset</span></span> # alignment)) # alignment //offset -    </code> </pre><br><br><h2>  What is not working yet </h2><br>  1) Integers in Cach√© are presented in such a way that accurate work with them is guaranteed only as long as the number does not go beyond the 64-bit signed number.  But in C there is a 64-bit unsigned type (unsigned long long).  That is, a number that exceeds the maximum 64-bit signed value, 2 <sup>63</sup> -1 (~ 9 * 10 <sup>18</sup> ), cannot be transferred to the external function. <br><br>  2) There are two types for working with real numbers in Cach√©: the <a href="">native decimal</a> and the double-precision floating point numbers of the <a href="https://ru.wikipedia.org/wiki/IEEE_754">IEEE 754</a> standard.  That is, there are no analogs of the C language types float and long double in Cach√©.  It is possible to work in CNA with these types, but with each hit in Cach√© they will be converted into double. <br><br>  3) When working on Windows with long double, everything will most likely work incorrectly.  This is due to the fact that Microsoft and the mingw development team have fundamentally different views on what should be a long double.  Microsoft considers that both 32 and 64-bit systems have a long double size - 8 bytes.  In mingw, on 32 bits - 12 bytes, on 64 - 16. And since CNA is compiled using mingw, it is better to forget about long double. <br><br>  4) There is no support for unions and bit fields in structures (bitfields).  This is because libffi does not support them. <br><br>  Criticism, comments, suggestions - are welcome. <br><br>  The entire source code is laid out on a githab under a MIT license. <br>  <b><a href="http://github.com/intersystems-ru/cna">github.com/intersystems-ru/cna</a></b> </div><p>Source: <a href="https://habr.com/ru/post/235473/">https://habr.com/ru/post/235473/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../235459/index.html">Monitoring system of active network equipment of the federal network</a></li>
<li><a href="../235461/index.html">How to cross the designer "Expert" and Arduino do it yourself</a></li>
<li><a href="../235463/index.html">Place under the ... antenna</a></li>
<li><a href="../235465/index.html">Oracle vs Teradata vs Hadoop</a></li>
<li><a href="../235467/index.html">The Skip. How the ‚ÄúSkip Track‚Äù button influenced music consumption patterns</a></li>
<li><a href="../235477/index.html">Firefox 32 release</a></li>
<li><a href="../235479/index.html">Another "smart" outlet with your own hands. Part 1</a></li>
<li><a href="../235483/index.html">On the verge of madness</a></li>
<li><a href="../235485/index.html">Yii2 RBAC setup</a></li>
<li><a href="../235487/index.html">How we (almost) defeated DirCrypt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>