<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Updating document.title in the background tab</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suppose that we have a ticket sales site on which we want to show the price in document.title in order to increase user satisfaction and let them know...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Updating document.title in the background tab</h1><div class="post__text post__text-html js-mediator-article">  Suppose that we have a ticket sales site on which we want to show the price in document.title in order to increase user satisfaction and let them know that in which tab they have open (because we do not know whether place of departure / arrival, date, favorite carrier, and so on, and the price, by contrast, for different combinations is almost always different).  At the same time, we know that, starting from version 56, Chrome has a policy of locking background tabs.  What does this mean for this functionality? <br><a name="habracut"></a><br>  According to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame">documentation</a> , rAF (requestAnimationFrame) is usually called 60 times per second.  For screens that have a higher refresh rate, this value will also be higher (although you may not notice it with your eye). <br><br>  Further it is written that if the tab is background and not active, the frequency may decrease, which is what happens, as we will see below. <br><br>  Let's do an experiment.  In the code under the spoiler, by requestAnimationFrame, the title is updated in the simplest way: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">requestAnimationFrame page</b> <div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> requestAnimationFrame(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.title += </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">' RAF'</span></span></span><span class="javascript"> }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>tab<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span>tab<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br>  The result in chrome is as follows: <br><br><div class="spoiler">  <b class="spoiler_title">Chrome</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/714/e1e/55c/714e1e55c8ba4c3f99276158bf436004.gif"><br></div></div><br>  Yes, it should be so.  Let's see what other browsers do: <br><br><div class="spoiler">  <b class="spoiler_title">IE11</b> <div class="spoiler_text">  In order not to go to the settings and not to allow execution of scripts on local sites, we use the combination of the <a href="http-server">http-server</a> and <a href="https://localtunnel.github.io/www/">lt -p 8080</a> commands: <br><br><img src="https://habrastorage.org/web/649/2aa/6fc/6492aa6fc8f247db829c1a56aef7b8ce.gif"><br><br>  * Edge works in a similar way. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Safari</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/bfe/cf4/40d/bfecf440dec841e7bf01a8709eb00f26.gif"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Firefox</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/b3d/6da/a52/b3d6daa52bd54907ab65c4f5ef4c26c4.gif"><br>  where e10s is electrolysis <br></div></div><br>  The result - only Firefox runs the rAF in the background tab.  It would seem surprising that even IE11 does not perform rAF in the background, however, <a href="https://developers.google.com/web/updates/2017/03/background_tabs">Per the documentation, Chrome doesn‚Äôt call requestAnimationFrame () when a page is in the background.</a>  <a href="https://developers.google.com/web/updates/2017/03/background_tabs">This behavior has been in place since 2011</a> .  Since 2011, Karl !, which means that this behavior does not surprise anyone.  Do not be surprised, even if music is playing in the background (via <code>&lt;audio src="sound.mp3" autoplay&gt;&lt;/audio&gt;</code> or whatever else), rAF, in the background, under any conditions, in any browser different from FF, will not be executed. <br><br>  Therefore, answering the initial question "How to show the price in the title," the answer is quite simple - to show it not at the time of displaying the component, but at the time of receiving data from the API.  The second solution would be to take away from the function that is used to animate the page when returning data from the API (a large loader on the whole screen is beautifully cleaned simply)), the initializer function.  Unfortunately, it so happened that for some reason there are more than one such function, so this option entails large permutations and it was decided to abandon it.  By the way, setTimeout / setInterval, are executed correctly, a third solution to the problem is possible through them. <br><br>  In this story, you can finish and close, and now let's move on to what is actually happening, using the <a href="">source code requestAnimationFrame from WebKit</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Document::requestAnimationFrame(Ref&lt;RequestAnimationFrameCallback&gt;&amp;&amp; callback) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_scriptedAnimationController) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> USE(REQUEST_ANIMATION_FRAME_DISPLAY_MONITOR) m_scriptedAnimationController = ScriptedAnimationController::create(*this, page() ? page()-&gt;chrome().displayID() : 0); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> m_scriptedAnimationController = ScriptedAnimationController::create(*this, 0); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// It's possible that the Page may have suspended scripted animations before // we were created. We need to make sure that we don't start up the animation // controller on a background tab, for example. if (!page() || page()-&gt;scriptedAnimationsSuspended()) m_scriptedAnimationController-&gt;suspend(); if (page() &amp;&amp; page()-&gt;isLowPowerModeEnabled()) m_scriptedAnimationController-&gt;addThrottlingReason(ScriptedAnimationController::ThrottlingReason::LowPowerMode); if (!topOrigin().canAccess(securityOrigin()) &amp;&amp; !hasHadUserInteraction()) m_scriptedAnimationController-&gt;addThrottlingReason(ScriptedAnimationController::ThrottlingReason::NonInteractedCrossOriginFrame); } return m_scriptedAnimationController-&gt;registerCallback(WTFMove(callback)); }</span></span></span></span></code> </pre><br>  The first if is pretty straightforward, for details on <a href="">suspendScriptedAnimations</a> and <a href="">setIsVisibleInternal</a> . <br><br>  In the second if, the value of the function <a href="">isLowPowerModeEnabled</a> , each OS will be taken from different sources;  in iOS, it is probably taken from <a href="">_didReceiveLowPowerModeChange</a> . <br><br>  The third if is most interesting;  <a href="">topOrigin</a> is just a top-level <a href="https://lazka.github.io/pgi-docs/WebKit-3.0/classes/SecurityOrigin.html">SecurityOrigin</a> document;  the method itself is <a href="">here</a> , in the comments in this method it is described in some detail what is happening in it.  This method returns true if two scripts from different <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/origin">origin</a> can communicate with each other (read or write).  At the same time, the user has a place to maneuver with NonInteractedCrossOriginFrame. <br><br>  Thus, webkit browsers will acquire an rAF lock every time they enter one of the three if. <br><br>  Let's go back to Firefox.  We convert the original function that changes the page title to the following: <br><br><div class="spoiler">  <b class="spoiler_title">Change the title for each animationFrame</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> requestAnimationFrame(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.title += <span class="hljs-string"><span class="hljs-string">'R'</span></span> requestAnimationFrame(handler); });</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Result</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/43d/79f/26d/43d79f26d58f40d690e47dfdb95c282b.gif"><br></div></div><br>  As you can see, everything happens a bit differently in <a href="">Firefox / Gecko</a> than in webkit.  If you find the implementation of <a href="">request_animation_frame</a> , then you will notice that: <br><br><ol><li>  // TODO: Should tick animation only when document is visible - which means that someday the behavior will correspond to the behavior of other browsers, so what is happening now, you can not particularly get hung up. </li><li>  There is <a href="">is_faking_animation_frames</a> where it turns out that the guys from Gecko, in case you have a <a href="">lot of</a> fake animations, throw you on FakeRequestAnimationFrameCallback. </li></ol><br>  I do not even know who is cooler. <br><br>  Good links: <br><br><ul><li>  <a href="https://docs.google.com/document/d/18_sX-KGRaHcV3xe5Xk_l6NNwXoxm-23IOepgMx4OlE4/pub">Background tabs &amp; offscreen frames - Chrome team future plans</a> </li><li>  <a href="https://medium.com/%40paul_irish/requestanimationframe-scheduling-for-nerds-9c57f7438ef4">requestAnimationFrame Scheduling For Nerds</a> </li><li>  <a href="http://www.vsynctester.com/firefoxisbroken.html">Vsync if firefox</a> </li><li>  <a href="https://bugs.chromium.org/p/chromium/issues/detail%3Fid%3D467617">How to dramatically improve Chrome's requestAnimationFrame VSYNC accuracy in Windows</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/332174/">https://habr.com/ru/post/332174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332162/index.html">FinWin-2017: competition fintech projects and the latest trends in the banking sector</a></li>
<li><a href="../332164/index.html">Introduction to procedural animation</a></li>
<li><a href="../332166/index.html">We simulate device control with actor</a></li>
<li><a href="../332168/index.html">Three years of successful provision of public rental services of virtual machines with Apache CloudStack</a></li>
<li><a href="../332172/index.html">5 free assets for Unity3D, which will facilitate the development process</a></li>
<li><a href="../332176/index.html">Programming Contest: JSDash</a></li>
<li><a href="../332178/index.html">How computer pros crack hackers</a></li>
<li><a href="../332180/index.html">How to search for people among Pi and what's the point about Python</a></li>
<li><a href="../332182/index.html">How to quickly remove multiple rows from a large database in MySQL</a></li>
<li><a href="../332184/index.html">Six Myths about Big Data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>