<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sculpt microservice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="They threw the task of making microservice, which receives data from RabbitMQ, processes it, and sends the data further down the stage to RabbitMQ. Af...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sculpt microservice</h1><div class="post__text post__text-html js-mediator-article"><p>  They threw the task of making microservice, which receives data from RabbitMQ, processes it, and sends the data further down the stage to RabbitMQ.  After sending the job, I looked at what I learned.  It turned out that this set of components can be used for rapid prototyping of the <a href="https://habrahabr.ru/company/oleg-bunin/blog/310418">pipeline architecture.</a> </p><br><p>  Components Used: </p><br><ul><li>  <a href="https://github.com/CopernicaMarketingSoftware/REACT-CPP">REACT-CPP</a> ; </li><li>  <a href="https://github.com/CopernicaMarketingSoftware/AMQP-CPP">AMQP-CPP</a> ; </li><li>  <a href="https://github.com/miloyip/rapidjson">RapidJSON</a> ; </li><li>  <a href="https://github.com/google/leveldb">LevelDB</a> ; </li><li>  <a href="https://github.com/easylogging/easyloggingpp">Easylogging ++</a> . </li></ul><br><p>  For example, I will do microservice to issue a rating of players.  The following messages come from the kernel of the system to microservice: </p><br><ul><li>  <em>player_registered (id, name)</em> ; </li><li>  <em>player_renamed (id, name)</em> ; </li><li>  <em>player_won (id, points)</em> . </li></ul><br><p>  The service should send a message with the contents of the rating once a minute. The rating is sorted by points for the calendar week. </p><a name="habracut"></a><br><h2 id="react-cpp">  <strong>REACT-CPP</strong> </h2><br><p>  <strong>REACT-CPP</strong> is a wrapper over <a href="http://software.schmorp.de/pkg/libev.html">libev</a> in C ++ 11.  This library is needed to organize the event loop.  Since  in addition to working with a socket, timers and unix signal handlers are required. </p><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Application(); ~Application(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IntervalWatcherPtr = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;React::IntervalWatcher&gt;; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shutdown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//... private: bool onMinute(); //... private: React::MainLoop m_loop; IntervalWatcherPtr m_minuteTimer; //... };</span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::run() { m_minuteTimer = m_loop.onInterval(<span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">60.0</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::bind(&amp;Application::onMinute, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); m_loop.onSignal(SIGTERM, [<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>]() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> { shutdown(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }); m_loop.onSignal(SIGUSR1, [<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>]()-&gt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>{ cleanRating(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }); <span class="hljs-comment"><span class="hljs-comment">//... m_loop.run(); } bool Application::onMinute() { calculateRating(); sendRating(); return true; }</span></span></code> </pre> <br><p>  Here I create a timer that starts in 5 seconds and which the handler will call every 60 seconds.  Any decent daemon / service must have a <strong>SIGTERM</strong> handler to ask it to exit correctly from the outside.  As for the <strong>SIGUSR1</strong> handler, you can independently calculate the beginning / end of the week via <a href="http://www.boost.org/doc/libs/1_61_0/doc/html/date_time.html">Boost.Date_Time</a> , but I am too lazy when there is a cron + pkill in GNU / Linux. </p><br><h2 id="amqp-cpp">  <strong>AMQP-CPP</strong> </h2><br><p>  Since I published <a href="https://habrahabr.ru/post/253317/">RabbitMQ tutorials on C ++,</a> AMQP-CPP has acquired the implementation of a handler on libev and libuv. </p><br><p>  Connection and processing of the message: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::createChannel(AMQP::TcpConnection &amp;connection) { m_channel = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_unique&lt;AMQP::TcpChannel&gt;(&amp;connection); m_channel-&gt;declareQueue(m_cfg.source().name, AMQP::durable) .onSuccess([&amp;](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;name, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> messagecount, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> consumercount) { LOG(INFO) &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Declared queue "</span></span> &lt;&lt; name &lt;&lt; <span class="hljs-string"><span class="hljs-string">", message count: "</span></span> &lt;&lt; messagecount; m_channel-&gt;consume(m_cfg.source().name) .onReceived([&amp;](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AMQP::Message &amp;message, <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> deliveryTag, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> redelivered) { onMessage(message, deliveryTag, redelivered); }) .onError([](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *message) { LOG(ERROR) &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Error consume:"</span></span> &lt;&lt; message; APP-&gt;shutdown(); }); }) .onError([&amp;](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *message) { LOG(ERROR) &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Error declare queue:"</span></span> &lt;&lt; message; shutdown(); }); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::onMessage(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AMQP::Message &amp;message, <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> deliveryTag, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> redelivered) { parseMessage(message); m_channel-&gt;ack(deliveryTag); }</code> </pre> <br><p>  Post publication: </p><br><pre> <code class="cpp hljs">AMQP::<span class="hljs-function"><span class="hljs-function">Envelope </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">env</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s.GetString())</span></span></span></span>; m_channel-&gt;publish(<span class="hljs-string"><span class="hljs-string">""</span></span>, m_cfg.destination().name, env);</code> </pre> <br><h2 id="leveldb">  <strong>Leveldb</strong> </h2><br><p>  May require local data storage.  I took LelevDB, I wrote about it in <a href="https://habrahabr.ru/post/256207/">Using LevelDB</a> .  Made only a small RAII wrapper: </p><br><div class="spoiler">  <b class="spoiler_title">Wrapper code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataBase</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: DataBase(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;path2base, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> compression = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteArray &amp;value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sync = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ByteArray </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;key)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Snapshot </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">snapshot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Iterator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;leveldb::DB&gt; m_backend; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Snapshot</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Snapshot(); ~Snapshot(); <span class="hljs-function"><span class="hljs-function">ByteArray </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;key)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Iterator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: Snapshot(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::weak_ptr&lt;leveldb::DB&gt; &amp;backend, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> leveldb::Snapshot *snapshot); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataBase</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::weak_ptr&lt;leveldb::DB&gt; m_backend; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> leveldb::Snapshot *m_shapshot; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterator</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Iterator(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;leveldb::Iterator&gt; rawIterator); Iterator(Iterator &amp;&amp;iter); <span class="hljs-comment"><span class="hljs-comment">/*! * Create empty iterator */</span></span> Iterator() = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; ~Iterator(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prev</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">key</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ByteArray </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/*! * Seek to first */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toFirst</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/*! * Seek to last */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toLast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; Iterator(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Iterator &amp;) = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>; Iterator &amp;<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>=(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Iterator &amp;) = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;leveldb::Iterator&gt; m_iterator; };</code> </pre> </div></div><br><p>  LevelDB is used to save / restore state. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::loadFromLocalStorage() { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> snapshot = m_localStorage-&gt;snapshot(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> iter = snapshot.iterator(); iter.toFirst(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (iter.isValid()) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> player = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Player(iter.value()); m_id2player[player-&gt;id] = player; m_players.push_back(player); iter.next(); } } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::updatePlayerInBD(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Player *player) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_localStorage-&gt;put(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::to_string(player-&gt;id), player-&gt;serialize())) { LOG(ERROR) &lt;&lt; <span class="hljs-string"><span class="hljs-string">"["</span></span> &lt;&lt; player-&gt;id &lt;&lt; <span class="hljs-string"><span class="hljs-string">", "</span></span> &lt;&lt; player-&gt;name &lt;&lt; <span class="hljs-string"><span class="hljs-string">"] is not updated in the database"</span></span>; } }</code> </pre> <br><h2 id="logika-servisa">  <strong>Service Logic</strong> </h2><br><p>  Data comes in JSON format.  Parses json using <strong>RapidJSON</strong> , looking for a suitable method, calling the appropriate handler: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::parseMessage(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AMQP::Message &amp;message) { <span class="hljs-comment"><span class="hljs-comment">/* *    * { * "method":"player_registered", * "params":{ * ... * } * } */</span></span> rapidjson::Document doc; doc.Parse(message.body(), message.bodySize()); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> method = doc[<span class="hljs-string"><span class="hljs-string">"method"</span></span>].GetString(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> iter = m_handlers.find(method); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iter != m_handlers.end()) { iter-&gt;second(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, doc[<span class="hljs-string"><span class="hljs-string">"params"</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { LOG(WARNING) &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Unknown method:"</span></span> &lt;&lt; method; } }</code> </pre> <br><p>  The methods themselves are simple: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::onPlayerRegistered(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> JValue &amp;params) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> obj = params.GetObject(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> playerId = obj[<span class="hljs-string"><span class="hljs-string">"id"</span></span>].GetUint64(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isRegistred(playerId)) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> player = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Player; player-&gt;id = playerId; player-&gt;name = obj[<span class="hljs-string"><span class="hljs-string">"name"</span></span>].GetString(); m_players.push_back(player); m_id2player[playerId] = player; updatePlayerInBD(player); } } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::onPlayerRenamed(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> JValue &amp;params) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> obj = params.GetObject(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> playerId = obj[<span class="hljs-string"><span class="hljs-string">"id"</span></span>].GetUint64(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isRegistred(playerId)) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> player = m_id2player[playerId]; player-&gt;name = obj[<span class="hljs-string"><span class="hljs-string">"name"</span></span>].GetString(); updatePlayerInBD(player); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { LOG(WARNING) &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Renaming an unknown user["</span></span> &lt;&lt; playerId &lt;&lt; <span class="hljs-string"><span class="hljs-string">"]"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::onPlayerWon(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> JValue &amp;params) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> obj = params.GetObject(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> playerId = obj[<span class="hljs-string"><span class="hljs-string">"id"</span></span>].GetUint64(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isRegistred(playerId)) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> player = m_id2player[playerId]; player-&gt;points += obj[<span class="hljs-string"><span class="hljs-string">"points"</span></span>].GetInt64(); updatePlayerInBD(player); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { LOG(WARNING) &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Unknown player["</span></span> &lt;&lt; playerId &lt;&lt; <span class="hljs-string"><span class="hljs-string">"]"</span></span>; } }</code> </pre> <br><p>  Once a minute we sort the players and send the rating: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Application::onMinute() { calculateRating(); sendRating(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::calculateRating() { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::sort(m_players.begin(), m_players.end(), [](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Player *a, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Player *b) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a-&gt;points &gt; b-&gt;points; }); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::sendRating() { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> rapidjson; StringBuffer s; Writer&lt;StringBuffer&gt; writer(s); writer.StartArray(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> count = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::min(m_players.size(), <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; ++i) { writer.StartObject(); writer.Key(<span class="hljs-string"><span class="hljs-string">"id"</span></span>); writer.Uint64(m_players[i]-&gt;id); writer.Key(<span class="hljs-string"><span class="hljs-string">"name"</span></span>); writer.String(m_players[i]-&gt;name.c_str()); writer.Key(<span class="hljs-string"><span class="hljs-string">"points"</span></span>); writer.Int64(m_players[i]-&gt;points); writer.EndObject(); } writer.EndArray(); AMQP::<span class="hljs-function"><span class="hljs-function">Envelope </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">env</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s.GetString())</span></span></span></span>; m_channel-&gt;publish(<span class="hljs-string"><span class="hljs-string">""</span></span>, m_cfg.destination().name, env); }</code> </pre> <br><p>  All code is available on <a href="https://github.com/RPG-18/SimpleMicroservice">GitHub</a> .  Library sources are shipped with the service and automatically compiled to GNU / Linux with gcc. </p><br><p>  Let's sum up what we have: </p><br><ul><li>  event loop with timers, signal handlers and all other libev buns; </li><li>  work with RabbitMQ; </li><li>  built-in key-value storage; </li><li>  json support </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/315268/">https://habr.com/ru/post/315268/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315258/index.html">Comparing objects by value - 4, or Inheritance & Equality operators</a></li>
<li><a href="../315260/index.html">A little bit about empty interfaces. Quick look inside</a></li>
<li><a href="../315262/index.html">MegaFon Laboratory: How a Mobile Operator Tests a Technique</a></li>
<li><a href="../315264/index.html">We learn the current weather and forecast with a simple Python script</a></li>
<li><a href="../315266/index.html">Telnet and botnet</a></li>
<li><a href="../315270/index.html">Translation of excerpts from Robert Heinlein‚Äôs book, Take Your Government Back - part 18</a></li>
<li><a href="../315278/index.html">23 Free Incident Investigation Tools for the Information Security Specialist</a></li>
<li><a href="../315280/index.html">Co-iterators on timers</a></li>
<li><a href="../315282/index.html">Configure the Sharepoint Application Environment (SharePoint Add-ins)</a></li>
<li><a href="../315284/index.html">Pepelats with Gravizapa - as I searched (and even found) CRM for a medical center</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>