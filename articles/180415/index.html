<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Elastic redundant S3-compatible storage in 15 minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="S3 today probably will not surprise anyone. It is used as a backend storage for web services, and as a file storage in the media industry, as well as ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Elastic redundant S3-compatible storage in 15 minutes</h1><div class="post__text post__text-html js-mediator-article">  S3 today probably will not surprise anyone.  It is used as a backend storage for web services, and as a file storage in the media industry, as well as an archive for backups. <br><br><img src="https://habrastorage.org/storage2/d70/402/5fd/d704025fd8503027567edafd4b0700f7.png"><br><br>  Consider a small sample deployment of S3-compatible storage based on Ceph object storage. <br><a name="habracut"></a><br><h5>  Quick reference </h5><br>  <a href="http://ceph.com/">Ceph</a> is an open source development of resilient, highly scalable petabyte storage.  The basis is the integration of disk spaces of several dozen servers into object storage, which allows for the implementation of flexible multiple pseudo-random data redundancy.  Ceph developers complement this object storage with three more projects: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  RADOS Gateway - S3- and Swift-compatible RESTful interface </li><li>  RBD - block device with support for thin growth and snapshots </li><li>  Ceph FS - Distributed POSIX Compatible File System </li></ul><br><h5>  Example Description </h5><br>  In my example, I <a href="http://habrahabr.ru/post/179823/">continue to</a> use 3 servers with 3 SATA disks in each: <code>/dev/sda</code> as the system and <code>/dev/sdb</code> and <code>/dev/sdc</code> for the data of the object storage.  Various programs, modules, frameworks for working with an S3 compatible storage can act as a client.  I have successfully tested <a href="http://www.dragondisk.com/">DragonDisk</a> , <a href="http://www.crossftp.com/">CrossFTP</a> and <a href="http://s3browser.com/">S3Browser</a> . <br>  Also in this example, I use only one RADOS Gateway on node01 node.  S3 interface will be available at <code><a href="http://s3.ceph.labspace.studiogrizzly.com/"></a> s3.ceph.labspace.studiogrizzly.com</code>  <code><a href="http://s3.ceph.labspace.studiogrizzly.com/"></a> s3.ceph.labspace.studiogrizzly.com</code> . <br>  It is worth noting that at the moment Ceph supports such S3 operations <a href="http://ceph.com/docs/master/radosgw/s3/">http://ceph.com/docs/master/radosgw/s3/</a> . <br><br><h4>  Let's get started </h4><br><h5>  Step 0. Preparing Ceph </h5><br>  As I continue to use the already <a href="http://habrahabr.ru/post/179823/">deployed Ceph cluster</a> , I only need to slightly adjust the configuration of <code>/etc/ceph/ceph.conf</code> ‚Äî add a definition for RADOS Gateway <br><br><pre> <code class="bash hljs">[client.radosgw.gateway] host = node01 keyring = /etc/ceph/keyring.radosgw.gateway rgw socket path = /tmp/radosgw.sock <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> file = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/ceph/radosgw.log rgw dns name = s3.ceph.labspace.studiogrizzly.com rgw <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre><br>  and update it on other nodes <br><br><pre> <code class="bash hljs">scp /etc/ceph/ceph.conf node02:/etc/ceph/ceph.conf scp /etc/ceph/ceph.conf node03:/etc/ceph/ceph.conf</code> </pre><br><h5>  Step 1. Install Apache2, FastCGI and RADOS Gateway </h5><br><pre> <code class="bash hljs">aptitude install apache2 libapache2-mod-fastcgi radosgw</code> </pre><br><h5>  Step 2. Apache configuration </h5><br>  Include required modules <br><br><pre> <code class="bash hljs">a2enmod rewrite a2enmod fastcgi</code> </pre><br>  Create VirtualHost for RADOS Gateway <code>/etc/apache2/sites-available/rgw.conf</code> <br><br><pre> <code class="bash hljs">FastCgiExternalServer /var/www/s3gw.fcgi -socket /tmp/radosgw.sock &lt;VirtualHost *:80&gt; ServerName s3.ceph.labspace.studiogrizzly.com ServerAdmin tweet@studiogrizzly.com DocumentRoot /var/www RewriteEngine On RewriteRule ^/([a-zA-Z0-9-_.]*)([/]?.*) /s3gw.fcgi?page=<span class="hljs-variable"><span class="hljs-variable">$1</span></span>¬∂ms=<span class="hljs-variable"><span class="hljs-variable">$2</span></span>&amp;%{QUERY_STRING} [E=HTTP_AUTHORIZATION:%{HTTP:Authorization},L] &lt;IfModule mod_fastcgi.c&gt; &lt;Directory /var/www&gt; Options +ExecCGI AllowOverride All SetHandler fastcgi-script Order allow,deny Allow from all AuthBasicAuthoritative Off &lt;/Directory&gt; &lt;/IfModule&gt; AllowEncodedSlashes On ErrorLog /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/apache2/error.log CustomLog /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/apache2/access.log combined ServerSignature Off &lt;/VirtualHost&gt;</code> </pre><br>  Turn on the created VirtualHost and turn off the default <br><br><pre> <code class="bash hljs">a2ensite rgw.conf a2dissite default</code> </pre><br>  Create the FastCGI script <code>/var/www/s3gw.fcgi</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh exec /usr/bin/radosgw -c /etc/ceph/ceph.conf -n client.radosgw.gateway</span></span></code> </pre><br>  and make it executable <br><br><pre> <code class="bash hljs">chmod +x /var/www/s3gw.fcgi</code> </pre><br><h5>  Step 3. Prepare RADOS Gateway </h5><br>  Create the necessary directory <br><br><pre> <code class="bash hljs">mkdir -p /var/lib/ceph/radosgw/ceph-radosgw.gateway</code> </pre><br>  We generate a key for the new RADOS Gateway service <br><br><pre> <code class="bash hljs">ceph-authtool --create-keyring /etc/ceph/keyring.radosgw.gateway chmod +r /etc/ceph/keyring.radosgw.gateway ceph-authtool /etc/ceph/keyring.radosgw.gateway -n client.radosgw.gateway --gen-key ceph-authtool -n client.radosgw.gateway --<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span> osd <span class="hljs-string"><span class="hljs-string">'allow rwx'</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span> mon <span class="hljs-string"><span class="hljs-string">'allow r'</span></span> /etc/ceph/keyring.radosgw.gateway</code> </pre><br>  and add it to the cluster <br><br><pre> <code class="bash hljs">ceph -k /etc/ceph/ceph.keyring auth add client.radosgw.gateway -i /etc/ceph/keyring.radosgw.gateway</code> </pre><br><h5>  Step 4. Launch </h5><br>  Restarting Apache2 and RADOS Gateway <br><br><pre> <code class="bash hljs">service apache2 restart /etc/init.d/radosgw restart</code> </pre><br><h5>  Step 5. Create the first user </h5><br>  To use the S3 client, we need to obtain the <code>access_key</code> and <code>secret_key</code> for the new user. <br><br><pre> <code class="bash hljs">radosgw-admin user create --uid=i --display-name=<span class="hljs-string"><span class="hljs-string">"Igor"</span></span> --email=tweet@studiogrizzly.com</code> </pre><br>  see the output of the command and copy the keys to your client <br><br><h5>  Step 6. DNS </h5><br>  In order to earn buckets, we need a DNS server, when requesting any subdomain for <code>s3.ceph.labspace.studiogrizzly.com</code> point to the IP address of the host running RADOS Gateway. <br>  For example, when creating a bucket called <code>mybackups</code> , the domain is <code>mybackups.s3.ceph.labspace.studiogrizzly.com.</code>  should point to the node01 IP address, which is - 192.168.2.31. <br>  In my case, I'll just add a CNAME record. <br><br><pre> <code class="bash hljs">* IN CNAME node01.ceph.labspace.studiogrizzly.com.</code> </pre><br><h5>  Afterword </h5><br>  In 15 minutes we managed to deploy an S3-compatible storage.  Now try connecting your favorite S3 client. <br><br><hr><br><h4>  Bonus part </h4><br>  I asked <a href="https://habrahabr.ru/users/sn00p/" class="user_link">sn00p to</a> tell about his experience of using RADOS Gateway in production at <a href="http://habrahabr.ru/company/2gis/">2GIS</a> .  Below is his review: <br><br><h5>  general description </h5><br>  We have Varnish, Varnish backends picked up 4 Apache Radosgateveev.  The application first climbs into varnish, if there is a bummer, then roundrobin breaks directly into the Apaches.  This piece presses 20,000 rps without any problems according to the synthetic tests jmeter with access log for a month.  Inside half a million photos, the workload on the frontend is about 300 rps. <br><br><img src="https://habrastorage.org/storage2/1ed/532/627/1ed5326273399df81f3a73179848a404.png"><br><br>  Ceph so far on 5 machines, there is a separate disk for osd and for the magazine a separate ssd.  Default replication, ^ 2.  The system without problems survives the fall of two nodes at the same time and there further with variations.  For six months, no errors have yet been shown to the client. <br><br>  There are no problems with flexibility - the size of the repository, the inodes, the layout of the directories - all this is left in the past. <br><br><h5>  Solution features </h5><br><ul><li>  Five HP Proliant Gen8 DL360e Servers.  Under the Ceph tasks on each server, one 300 GB SAS 15krpm is allocated.  For a significant increase in performance, the osd daemons logs are rendered on Hitachi Ultrastar 400M ssd disks. </li><li>  Two kvm virtual machines with apache2 and radosgw inside.  How nginx works with FastCGI I personally did not like it.  Nginx, when uploaded, uses buffering before giving content to the backend.  Theoretically, problems may arise with large files or streams.  But, a matter of taste and situation, nginx also works. </li><li>  Apache2 uses a modified one that allows you to handle a <code>100-continue HTTP response</code> .  Ready packages can be taken <a href="http://ceph.com/docs/master/radosgw/manual-install/">here</a> . </li><li>  The varnish application looks at both radosgw nodes.  There can be any cache or balancer.  If it crashes, the application can interrogate radosgw directly: <br><div class="spoiler">  <b class="spoiler_title">to uncover</b> <div class="spoiler_text"><pre> <code class="python hljs">backend radosgw1 { .host = <span class="hljs-string"><span class="hljs-string">"radosgw1"</span></span>; .port = <span class="hljs-string"><span class="hljs-string">"8080"</span></span>; .probe = { .url = <span class="hljs-string"><span class="hljs-string">"/"</span></span>; .interval = <span class="hljs-number"><span class="hljs-number">2</span></span>s; .timeout = <span class="hljs-number"><span class="hljs-number">1</span></span>s; .window = <span class="hljs-number"><span class="hljs-number">5</span></span>; .threshold = <span class="hljs-number"><span class="hljs-number">3</span></span>; } } backend radosgw2 { .host = <span class="hljs-string"><span class="hljs-string">"radosgw2"</span></span>; .port = <span class="hljs-string"><span class="hljs-string">"8080"</span></span>; .probe = { .url = <span class="hljs-string"><span class="hljs-string">"/"</span></span>; .interval = <span class="hljs-number"><span class="hljs-number">2</span></span>s; .timeout = <span class="hljs-number"><span class="hljs-number">1</span></span>s; .window = <span class="hljs-number"><span class="hljs-number">5</span></span>; .threshold = <span class="hljs-number"><span class="hljs-number">3</span></span>; } } director cephgw round-robin { { .backend = radosgw1; } { .backend = radosgw2; } }</code> </pre></div></div></li><li>  Each application has its own bucket.  Different acl is supported, you can flexibly adjust access rights for the bucket and for each object in it. </li><li>  To work with the entire kitchen, we use <code>python-boto</code> .  Here is an example python script (carefully, indents), which is able to upload everything into the bucket from the file system.  This method is convenient for batch processing of a heap of files in automatic mode.  If you don't like python, no problem, you can use other popular languages. <br><div class="spoiler">  <b class="spoiler_title">to uncover</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import fnmatch import os, sys import boto import boto.s3.connection access_key = 'insert_access_key' secret_key = 'insert_secret_key' pidfile = "/tmp/copytoceph.pid" def check_pid(pid): try: os.kill(pid, 0) except OSError: return False else: return True if os.path.isfile(pidfile): pid = long(open(pidfile, 'r').read()) if check_pid(pid): print "%s already exists, doing natting" % pidfile sys.exit() pid = str(os.getpid()) file(pidfile, 'w').write(pid) conn = boto.connect_s3( aws_access_key_id = access_key, aws_secret_access_key = secret_key, host = 'cephgw1', port = 8080, is_secure=False, calling_format = boto.s3.connection.OrdinaryCallingFormat(), ) mybucket = conn.get_bucket('test') mylist = mybucket.list() i = 0 for root, dirnames, filenames in os.walk('/var/storage/photoes', followlinks=True): for filename in fnmatch.filter(filenames, '*'): myfile = os.path.join(root,filename) key = mybucket.get_key(filename) i += 1 if not key: key = mybucket.new_key(filename) key.set_contents_from_filename(myfile) key.set_canned_acl('public-read') print key print i os.unlink(pidfile)</span></span></code> </pre></div></div></li><li>  Out of the box, radosgw is very talkative and generates large files with logs under normal load.  With our loads, we have necessarily reduced the logging level: <br><div class="spoiler">  <b class="spoiler_title">to uncover</b> <div class="spoiler_text">  [client.radosgw.gateway] <br>  ... <br>  debug rgw = 2 <br>  rgw enable ops log = false <br>  log to stderr = false <br>  rgw enable usage log = false <br>  ... </div></div></li><li>  For monitoring, we use a template for Zabbix, the source code can be collected <a href="https://github.com/thelan/ceph-zabbix">here</a> . </li></ul><br>  All this has been working with us for half a year already and does not require administrator intervention)) <br><br><h5>  Future plans </h5><br>  Now I am trying to use Ceph to store and upload already 15 million files of ~ 4-200kb.  With S3, this is not very convenient - there are no bulk-copy operations, it is impossible to delete the bucket with data in order to initially fill the storage - this is slowly gut.  We investigate how to twist it. <br><br>  But the main task is a geocluster, we are in Siberia and we want to give data from a geographically close point to the client.  To Moscow, we have content flies with a delay already - up to 100ms plus, this is no good.  Well, Ceph developers seem to have everything in their <a href="http://wiki.ceph.com/01Planning/02Blueprints/Dumpling/RGW_Geo-Replication_and_Disaster_Recovery">plans</a> . </div><p>Source: <a href="https://habr.com/ru/post/180415/">https://habr.com/ru/post/180415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../180405/index.html">Salary survey for Ukrainian developers: May 2013</a></li>
<li><a href="../180407/index.html">Start-up story of the month Microsoft Contest Microsoft BizSpark</a></li>
<li><a href="../180409/index.html">Review of time series forecasting models: pen test</a></li>
<li><a href="../180411/index.html">Mac Mini home server on Debian for thirty minutes for dummies</a></li>
<li><a href="../180413/index.html">Runet in pictures. E-commerce in RuNet. How Russians Shop Online</a></li>
<li><a href="../180417/index.html">Why and how we do audits</a></li>
<li><a href="../180421/index.html">TeamViewer QuickSupport for Android is now not only for Samsung</a></li>
<li><a href="../180425/index.html">Got tired of smartphones? GSM Arena calls for the release of more smart phones of a reasonable size. Support initiative</a></li>
<li><a href="../180427/index.html">May 23 at 10.00 live broadcast launch RAD Studio XE4</a></li>
<li><a href="../180431/index.html">Monitoring the performance and availability of IT services without GUI robots and RUM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>