<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Internal ASLR device in Windows 8</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ASLR is the Address Space Layout Randomization, address space randomization. This is a security mechanism that includes the randomization of virtual m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Internal ASLR device in Windows 8</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/pt/blog/162617/"><img src="https://habrastorage.org/storage2/3ff/6c9/d73/3ff6c9d739ce59db2d8732fd41af3709.png" align="left"></a>  ASLR is the Address Space Layout Randomization, address space randomization.  This is a security mechanism that includes the randomization of virtual memory addresses of various data structures that are sensitive to attacks.  The location in the memory of the target structure is difficult to predict, so the attacker's chances for success are small. <br><br>  The implementation of ASLR in Windows is closely related to the relocation mechanism of the executable images.  Relocation allows a PE file to be loaded not only on a fixed preferred base.  The relocation section in the PE file is a key structure when moving an image.  It describes what changes need to be made to certain elements of the code and data to ensure the correct functioning of the application at a different base address. <a name="habracut"></a><br><br>  A key role in the work of ASLR is played by a random number generator and a couple of functions that modify the base address of the loaded PE file. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Windows 8 relies on a random number generator, which is essentially a Fibonacci delayed generator with parameters j = 24 and k = 55.  Its kernel is initialized in the winload.exe module at system startup.  Winload.exe collects entropy from various sources: registry keys, TPM, current time, ACPI, as well as with the help of the new rdrand instruction.  The initialization of a nuclear random number generator is described in detail in the source [1]. <br><br>  Let us consider the new rdrand instruction in more detail.  In processors based on the Ivy Bridge architecture, Intel Secure Key technology was introduced to generate high-quality pseudo-random numbers.  It is implemented using a hardware digital random number generator (DRNG) and rdrand instructions for programmatically extracting values ‚Äã‚Äãfrom it. <br><br>  From a hardware point of view, DRNG is a separate module on a processor chip.  It works asynchronously with the processor cores at 3 GHz.  DRNG uses thermal noise as a source of entropy;  in addition, it has a built-in testing system that performs a series of quality checks on the extracted random values.  In the event of an unsatisfactory test result, the DRNG stops generating random values. <br><br>  To extract random numbers from DRNG, use the rdrand instruction.  The documentation for it notes that, in theory, the DRNG can return zero values ‚Äã‚Äãin the event of an unsatisfactory test result or empty internal queue of random values.  However, in practice, it was not possible to empty the DRNG. <br><br>  The Intel Secure Key is a powerful random number generator that produces high quality random values ‚Äã‚Äãat very high speeds.  It is practically impossible to predict the initial state of the generator, initialized using the rdrand instruction (unlike other sources of entropy). <br><br>  The internal interface function of a nuclear PRNG is ExGenRandom ().  It also has an exported wrapper function RtlRandomEx ().  ASLR in Windows 8 uses ExGenRandom () - unlike previous versions that relied on the rdtsc instruction.  The latter is used to obtain a time counter on the CPU, which varies linearly and, therefore, cannot ensure the proper quality of the generated values, which is unsafe. <br><br>  The main function of the ASLR mechanism is MiSelectImageBase ().  In Windows 8, it can be described by the following pseudocode. <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MI_64K_ALIGN(x) (x + 0x0F) &gt;&gt; 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MmHighsetUserAddress 0x7FFFFFEFFFF typedef PIMAGE_BASE ULONG_PTR; typedef enum _MI_MEMORY_HIGHLOW { MiMemoryHigh = 0, MiMemoryLow = 1, MiMemoryHighLow = 2 } MI_MEMORY_HIGHLOW, *PMI_MEMORY_HIGHLOW; MI_MEMORY_HIGHLOW MiSelectBitMapForImage(PSEGMENT pSeg) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!(pSeg-&gt;SegmentFlags &amp; FLAG_BINARY32)) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// WOW binary { if (!(pSeg-&gt;ImageInformation-&gt;ImageFlags &amp; FLAG_BASE_BELOW_4GB)) { if (pSeg-&gt;BasedAddress &gt; 0x100000000) { return MiMemoryHighLow; } else { return MiMemoryLow; } } } return MiMemoryHigh; } PIMAGE_BASE MiSelectImageBase(void* a1&lt;rcx&gt;, PSEGMENT pSeg) { MI_MEMORY_HIGHLOW ImageBitmapType; ULONG ImageBias; RTL_BITMAP *pImageBitMap; ULONG_PTR ImageTopAddress; ULONG RelocationSizein64k; MI_SECTION_IMAGE_INFORMATION *pImageInformation; ULONG_PTR RelocDelta; PIMAGE_BASE Result = NULL; // rsi = rcx // rcx = rdx // rdi = rdx pImageInformation = pSeg-&gt;ImageInformation; ImageBitmapType = MiSelectBitMapForImage(pSeg); a1-&gt;off_40h = ImageBitmapType; if (ImageBitmapType == MiMemoryLow) { // 64-bit executable with image base below 4 GB ImageBias = MiImageBias64Low; pImageBitMap = MiImageBitMap64Low; ImageTopAddress = 0x78000000; } else { if (ImageBitmapType == MiMemoryHighLow) { // 64-bit executable with image base above 4 GB ImageBias = MiImageBias64High; pImageBitMap = MiImageBitMap64High; ImageTopAddress = 0x7FFFFFE0000; } else { // MiMemoryHigh 32-bit executable image ImageBias = MiImageBias; pImageBitMap = MiImageBitMap; ImageTopAddress = 0x78000000; } } // pSeg-&gt;ControlArea-&gt;BitMap ^= (pSeg-&gt;ControlArea-&gt;BitMap ^ (ImageBitmapType &lt;&lt; 29)) &amp; 0x60000000; // or bitfield form pSeg-&gt;ControlArea.BitMap = ImageBitmapType; RelocationSizein64k = MI_64K_ALIGN(pSeg-&gt;TotalNumberOfPtes); if (pSeg-&gt;ImageInformation-&gt;ImageCharacteristics &amp; IMAGE_FILE_DLL) { ULONG StartBit = 0; ULONG GlobalRelocStartBit = 0; StartBit = RtlFindClearBits(pImageBitMap, RelocationSizein64k, ImageBias); if (StartBit != 0xFFFFFFFF) { StartBit = MiObtainRelocationBits(pImageBitMap, RelocationSizein64k, StartBit, 0); if (StartBit != 0xFFFFFFFF) { Result = ImageTopAddress - (((RelocationSizein64k) + StartBit) &lt;&lt; 0x10); if (Result == (pSeg-&gt;BasedAddress - a1-&gt;SelectedBase)) { GlobalRelocStartBit = MiObtainRelocationBits(pImageBitMap, RelocationSizein64k, StartBit, 1); StartBit = (GlobalRelocStartBit != 0xFFFFFFFF) ? GlobalRelocStartBit : StartBit; Result = ImageTopAddress - (RelocationSizein64k + StartBit) &lt;&lt; 0x10; } a1-&gt;RelocStartBit = StartBit; a1-&gt;RelocationSizein64k = RelocationSizein64k; pSeg-&gt;ControlArea-&gt;ImageRelocationStartBit = StartBit; pSeg-&gt;ControlArea-&gt;ImageRelocationSizeIn64k = RelocationSizein64k; return Result; } } } else { // EXE image if (a1-&gt;SelectedBase != NULL) { return pSeg-&gt;BasedAddress; } if (ImageBitmapType == MiMemoryHighLow) { a1-&gt;RelocStartBit = 0xFFFFFFFF; a1-&gt;RelocationSizein64k = (WORD)RelocationSizein64k; pSeg-&gt;ControlArea-&gt;ImageRelocationStartBit = 0xFFFFFFFF; pSeg-&gt;ControlArea-&gt;ImageRelocationSizeIn64k = (WORD)RelocationSizein64k; return ((DWORD)(ExGenRandom(1) % (0x20001 - RelocationSizein64k)) + 0x7F60000) &lt;&lt; 16; } } ULONG RandomVal = ExGenRandom(1); RandomVal = (RandomVal % 0xFE + 1) &lt;&lt; 0x10; RelocDelta = pSeg-&gt;BasedAddress - a1-&gt;SelectedBase; if (RelocDelta &gt; MmHighsetUserAddress) { return 0; } if ((RelocationSizein64k &lt;&lt; 0x10) &gt; MmHighsetUserAddress) { return 0; } if (RelocDelta + (RelocationSizein64k &lt;&lt; 0x10) &lt;= RelocDelta) { return 0; } if (RelocDelta + (RelocationSizein64k &lt;&lt; 0x10) &gt; MmHighsetUserAddress) { return 0; } if (a1-&gt;SelectedBase + RandomVal == 0) { Result = pSeg-&gt;BasedAddress; } else { if (RelocDelta &gt; RandomVal) { Result = RelocDelta - RandomVal; } else { Result = RelocDelta + RandomVal; if (Result &lt; RelocDelta) { return 0; } if (((RelocationSizein64k &lt;&lt; 0x10) + RelocDelta + RandomVal) &gt; 0x7FFFFFDFFFF) { return 0; } if (((RelocationSizein64k &lt;&lt; 0x10) + RelocDelta + RandomVal) &lt; (RelocDelta + (RelocationSizein64k &lt;&lt; 0x10)))) { return 0; } } } //random_epilog a1-&gt;RelocStartBit = 0xFFFFFFFF; a1-&gt;RelocationSizein64k = RelocationSizein64k; pSeg-&gt;ControlArea-&gt;ImageRelocationStartBit = 0xFFFFFFFF; pSeg-&gt;ControlArea-&gt;ImageRelocationSizeIn64k = RelocationSizein64k; return Result; }</span></span></span></span></code> </pre> <br>  As you can see, there are three different bitmap images.  The first is for 32-bit executable applications, the second is for 64-bit applications, the third is for 64-bit applications with a base higher than 4 GB, which gives them a virtual address with high entropy. <br><br>  Randomization of executable images directly affects their base address.  In the case of loading libraries, ASLR is part of the module relocation process: a random variable when choosing a new base address is the ImageBias variable, which is initialized at system start. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">VOID </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MiInitializeRelocations</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ MiImageBias = ExGenRandom(<span class="hljs-number"><span class="hljs-number">1</span></span>) % <span class="hljs-number"><span class="hljs-number">256</span></span>; MiImageBias64Low = ExGenRandom(<span class="hljs-number"><span class="hljs-number">1</span></span>) % MiImageBitMap64Low.SizeOfBitMap; MiImageBias64High = ExGenRandom(<span class="hljs-number"><span class="hljs-number">1</span></span>) % MiImageBitMap64High.SizeOfBitMap; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre><br>  Bitmaps of executable images display the address space of current user processes.  The executable image gets the base address at boot time, it will be re-loaded into other processes at the same base address.  This behavior of the loader is most effective in terms of speed and memory saving due to the use of copy-on-write mechanism by executable images. <br><br>  The current implementation of ASLR in Windows 8 allows you to randomize the base address of applications that do not support randomization.  Below is a table showing the loader behavior depending on the combinations of linker flags associated with ASLR. <br><br><img src="https://habrastorage.org/storage2/0c4/b9b/328/0c4b9b3285f2d04b600ee2f42e74ddba.png"><br><br>  <i>* It is impossible to build an image using MSVS, because the / DYNAMICBASE flag requires the / FIXED: NO flag, which generates a relocation section</i> <br><br>  You can notice a change in the bootloader behavior characteristic of Windows 8: if the executable image has a relocation section, then it will be loaded anyway.  This is further evidence of the relationship between the ASLR and the relocation mechanism. <br><br>  In general, it can be said that the implementation of new ASLR functions in Windows 8 does not have a significant impact on the logic of the code, so it is rather difficult to detect useful vulnerabilities in it.  Increasing entropy for randomizing various objects is essentially a replacement for the constant expression in the code.  In addition, the code columns can be noted inspection code. <br><br>  <i>Sources</i> <br>  [1] Valasek Ch., Mandt T. Windows 8 Heap Internals.  2012 <br>  [2] Johnson K., Miller M. Exploit Mitigation Improvements in Windows 8. Slides, Black Hat USA, 2012. <br>  [3] Intel.  IntelDigital Random Number Generator (DRNG): Software Implementation Guide.  Intel Corporation, 2012. <br>  [4] Analysis of the Address Space Layout.  Symantec Advances Threat Research, 2007. <br>  [5] Sotirov A., Dowd M. Bypassing Browser Memory Protections.  2008 <br><br>  Authors: Artem Shishkin ( <a href="http://habrahabr.ru/users/honorarybot/" class="user_link">honorarybot</a> ) and Ilya Smith ( <a href="http://habrahabr.ru/users/blackzert/" class="user_link">blackzert</a> ), Research Center Positive Research. </div><p>Source: <a href="https://habr.com/ru/post/162617/">https://habr.com/ru/post/162617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../162599/index.html">Open beta testing steam for linux next week</a></li>
<li><a href="../162601/index.html">Would you like Web Notifications support in Opera browser (like in Chrome)?</a></li>
<li><a href="../162603/index.html">MongoDB for Developers and DBA</a></li>
<li><a href="../162605/index.html">YouTube has come to Ukraine</a></li>
<li><a href="../162613/index.html">GPS and Maps: Displaced Coordinates in China</a></li>
<li><a href="../162619/index.html">Sony Xperia V Review</a></li>
<li><a href="../162621/index.html">Course "Introduction to Financial Engineering"</a></li>
<li><a href="../162623/index.html">Large, long, uncircumcised (or ‚ÄúHow to make a lot of text at home‚Äù)</a></li>
<li><a href="../162625/index.html">Web service as a real-time system</a></li>
<li><a href="../162627/index.html">We fasten monitoring of smart or any temperature parameters (cpu, motherboard) to Zabbix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>