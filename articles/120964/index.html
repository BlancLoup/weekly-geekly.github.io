<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Removing the unlock key from the MBR-blocker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We decided to take into account the wishes of readers of our blog and prepared a short article on how to extract the unlock code from the blocker. Vya...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Removing the unlock key from the MBR-blocker</h1><div class="post__text post__text-html js-mediator-article">  <i>We decided to take into account the wishes of readers of our blog and prepared a short article on how to extract the unlock code from the blocker.</i>  <i>Vyacheslav Zakorzhevsky, senior virus analyst at Kaspersky Lab, is responding! ..</i> <br><br>  To parse, I selected one of the representatives of the new Trojan-Ransom.Win32.Mbro family.  These blockers infect the MBR and extort money from the user for unlocking the computer. <a name="habracut"></a><br><br>  I decided not to go into the analysis of the process of hitting the computer on the computer and the algorithm for infecting the boot sector, but immediately proceed to analyze the modified MBR.  So, after starting the blocker in question, the operating system will reboot, and the next text will be displayed upon the next boot of the computer. <br><img src="https://habrastorage.org/getpro/habr/post_images/0bd/180/4ed/0bd1804edb476e3c3d40ef57f9008996.png" alt="image"><br>  <i>The message that appears when the computer starts after the blocker starts</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Below are screenshots of the initial sectors of the hard disk before and after their infection with a blocker. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c5c/d80/23b/c5cd8023b1a4528ffef6479f609dfb4f.png" alt="image"><br>  <i>Initial hard disk sectors before infection</i> <br><img src="https://habrastorage.org/getpro/habr/post_images/2e7/b6f/6e2/2e7b6f6e232602b04adbb752472e266e.png" alt="image"><br>  <i>Fragment of the same hard drive area after infection</i> <br><br>  It is clearly seen that the beginning of the hard disk has been significantly transformed - an additional code has been added, EGA patterns and the text that was shown in the first picture. <br>  Below, I will gradually describe all the functionality of the modified Master Boot Record, and at the end of the article there will be a complete diagram containing the sectors used by the blocker and their purpose.  To debug MBR, I used a combination of IDA and Bochs for Windows. <br>  First of all, the malicious code reads the ninth sector and stores it at 0186A: 0000.  Then, a transition is performed to it using CALLF 0186A: 0000. <br><img src="https://habrastorage.org/getpro/habr/post_images/272/682/77c/27268277c39a63e255ff06f2452a0b8f.png" alt="image"><br>  <i>A snippet of code that reads the ninth sector</i> <br><br>  Next, the current date and time is checked with a reference value.  In my case, this value (obviously, presented in a convenient form) was 04.06.2011 15:04.  A message requesting payment will appear only if the current time stamp is less than the reference.  And if it is more, then the blocker restores the original ICBM and loads the computer, as if nothing had happened.  The time and date are obtained directly from the BIOS using the following sequence of commands: <br><br> <b><br></b>  <b>mov al, x</b> <b><br></b>  <b>out 70h, al</b> <b><br></b>  <b>in al, 71h</b> <b><br></b>  <b>aam 10h</b> <b><br></b>  <b>aad</b> <br><br>  Where 'x' takes different values ‚Äã‚Äãdepending on what you want to get.  It is worth noting that the BIOS returns numbers in BCD format.  The AAM and AAD instructions convert these numbers to hex. <br><br>  If the check for time and date was successful, then the malware reads the sectors from the third to the fifth inclusive.  The third and fourth contain the so-called ‚Äúuser font table‚Äù, and the fifth contains the text displayed at startup.  To use your own ‚Äústyle‚Äù (loudly) writing the text, INT 10h is called.  Further, sectors 5‚Äì8 inclusive are read out, and the text contained in the fifth and zero sectors (‚ÄúEnter Code:‚Äù) is displayed. <br><img src="https://habrastorage.org/getpro/habr/post_images/cfb/754/134/cfb754134ac99ab80c0ab94b07749f1b.png" alt="image"><br>  <i>Code snippet that displays text</i> <br><br>  After that, the cycle of checking the entered text starts working.  The cycle is implemented as follows.  Initially, the INT 16h instruction is called.  This interrupt returns to AX the value of the pressed button (AH = scan code, AL is the character) of the keyboard: <br><br>  <b>mov ah, 0</b> <b><br></b>  <b>push di</b> <b><br></b>  <b>int 16h</b> <b><br></b>  <b>pop di</b> <b><br></b>  <b>jmp short loc_7CC7</b> <br><br>  Then there is a check on the entered character.  If it is between 20h and 7Fh, then its value is written in ES: DI using the STOSB instruction.  If the Enter key (0Dh) was pressed, then the input and reference lines are checked using REPE CMPSB. <br><img src="https://habrastorage.org/getpro/habr/post_images/d1f/a87/998/d1fa8799896ef0451555bb71afe0da84.png" alt="image"><br>  <i>Comparison of the entered string and unlock code</i> <br><br>  From the screenshot it can be seen that at the address ES: 7DA5 there is a line necessary to unlock the computer boot.  Here is what is located at this address: '002158RD', 0.  And since the number ‚Äú6‚Äù is entered in CL, this means that it is enough to enter only ‚Äú002158‚Äù. <br>  If the correct code is entered, then the malware takes the original MBR from the second sector and writes it to the beginning of the hard disk. <br><br>  Sectors used by the blocker: <br><br>  1 - the main code; <br>  2 - the original first sector; <br>  3 - 4 - user font tables; <br>  5 - 6 - text displayed to the user; <br>  7 - 8 - sectors filled with zeros; <br>  9 - code that performs verification of the current date and time; <br><br>  PS And it was just possible to look at the beginning of the hard disk from the Hiew "eyes" and find the notorious code. <br><br>  Now, if by some miracle you pick up a similar thing, it will not be difficult for you to unlock it yourself.  But in case of infection with unidentified objects, you should follow the link <a href="http://support.kaspersky.ru/viruses/deblocker">http://support.kaspersky.ru/viruses/deblocker</a> .  I will be glad to answer all the questions in the comments. </div><p>Source: <a href="https://habr.com/ru/post/120964/">https://habr.com/ru/post/120964/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120958/index.html">Local dictionaries in ABBYY Lingvo x5: constructor for translators and not only</a></li>
<li><a href="../120960/index.html">Vertical page scrolling with jQuery and cross-browser compatibility</a></li>
<li><a href="../120961/index.html">CPanel and Parallels Plesk Panel from the point of view of a hoster. Part Three and Last</a></li>
<li><a href="../120962/index.html">Webasyst: open PHP framework for creating business applications</a></li>
<li><a href="../120963/index.html">Ancient Lamers</a></li>
<li><a href="../120965/index.html">Nortel's patent weapon</a></li>
<li><a href="../120966/index.html">Be rosary! Be brave! Be always with Semkah!</a></li>
<li><a href="../120967/index.html">What did you do (do) your project (startup) for?</a></li>
<li><a href="../120970/index.html">New features of the service "Simple Business" in version 1.5.0.0</a></li>
<li><a href="../120975/index.html">Visual PHP for Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>