<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of the hacking of the classic game Dendy or Contra for 100 lives</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As some Japanese company , still carefully keeps its copyright. I can not provide you with either my version of the rum or the source I used. Let me j...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of the hacking of the classic game Dendy or Contra for 100 lives</h1><div class="post__text post__text-html js-mediator-article"><p>  As <a href="https://ru.wikipedia.org/wiki/Nintendo">some Japanese company</a> , still carefully keeps its copyright.  I can not provide you with either my version of the rum or the source I used.  Let me just say that I found it in the torrent collection "All games on Dendy".  Taking from there the Japanese version of the game "Contra (J) [T + Rus_Chronix]" translated into Russian, I went through it several times and, being an extremely inquisitive person, decided to scratch the <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B1%25D1%2580%25D0%25B0%25D0%25B7_%25D0%259F%25D0%2597%25D0%25A3">ROM image a</a> little, in particular, to give some lives to the players. <a name="habracut"></a></p><br><div class="spoiler">  <b class="spoiler_title">Here is a live, boring, and boring recording of this process.</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/Zvzn3EG44tE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><p>  For hacking the game, I used the <a href="http://www.fceux.com/web/home.html">FCEUX</a> emulator. </p><br><p>  And these are all preliminary preparations, not counting the settings of the screen and gamepad. </p><br><p>  The hacking itself takes place in several stages: </p><br><ol><li>  Search for the necessary values, or rather the variables storing them, or rather the addresses containing the necessary values </li><li>  Search for instructions that change or read these values, depending on what interests you </li><li>  Analysis of code blocks containing these instructions </li><li>  Changing blocks of code of interest, followed by recording in a ROM file </li></ol><br><p>  Moreover, if the result of the analysis of blocks of code will be other addresses, paragraphs 2 and 3 will have to be repeated.  Then I will show this moment. </p><br><p>  To search for values ‚Äã‚Äãin memory, the RAM search tool built into the emulator is used. </p><br><p><img src="https://habrastorage.org/webt/uv/bf/ov/uvbfovvgu1q2v4unan-svploj-y.png"></p><br><p>  I do not know if they used encryption in games for NES, such games have not come across to me so far.  And on the screen after the splash screen and before the start of the level I saw the number of lives ‚Äúthree‚Äù. </p><br><p><img src="https://habrastorage.org/webt/bj/5o/aq/bj5oaqf0k8bpbd8uecosyx3j-ta.png"></p><br><p>  I started the search from the troika. </p><br><p>  The comparison operator "equals to", compare with a certain value of "3" and do not click on the search button before the start of the level.  The idea for the NES game is not important, but I prefer to perebdet and start the search after I know exactly what the desired value lies in its place in memory, that is, after the beginning of the level. </p><br><p>  The search for addresses is very routine, you need to slightly change the different values ‚Äã‚Äãexcept for the desired one, repeat the search and so on several times.  By the way, right now the value of lives does not change at all and you can delete all the values ‚Äã‚Äãthat have changed recently several times, but it is better to do this if you open the search window after the start of the level, or if you reset the search before the first comparison, but after the start of the level.  Then you can change the desired value (in this case, kill the character) and set a new value in the comparison field and so on until one variable remains. </p><br><p>  But I didn‚Äôt have any variables after this and there could be two reasons for this: </p><br><ol><li>  human factor, simply put, I was wrong in the search process </li><li>  in the variable responsible for life is something else </li></ol><br><p>  The first option will be postponed later, not that I rarely make a mistake, I just always start the search with checks on everything else, so I'm self-confident. </p><br><p>  And before you think through a plan to circumvent cunning encryption, look at the screen again. </p><br><p><img src="https://habrastorage.org/webt/tj/4k/ly/tj4klyzapeinwkzfihmrpzvaiy4.png"></p><br><p>  The player has three lives, and two medals hang over him.  Perhaps when a player has three lives, the meaning of "two" is recorded in memory (two spare lives).  Having reset the game and starting a new search, already with the number of medals and two players, I almost immediately found two addresses with suitable values. </p><br><p><img src="https://habrastorage.org/webt/4p/z0/od/4pz0oddvsghpo4dajwwjvc4hwfm.png"></p><br><p>  These are 32 <sub>16</sub> and 33 <sub>16</sub> addresses.  The easiest way to check the address found is to change its value.  To do this, you need the HEX Editor tool built into the emulator, and in the "RAM Search" window it can be opened by right-clicking on the address, so you will open this address in memory.  And putting in the 32 <sub>16</sub> address of the "four" I saw how the stock of the first player changed, and putting it in the 33 <sub>16</sub> address I changed the life of the second player. </p><br><p>  The most boring and routine part of the work is done.  With the "Watch" button you can add an address to the "RAM Watch" window created for monitoring values, and in my case, the computer remembers the addresses I need, my memory is full, I will forget.  By the way, these variables are stored in the static memory of the emulator and having found them once you can always use them without fear of restarting the game, the emulator and even the computer. </p><br><p>  At the second stage, you need to look for functions / subroutines / code blocks (favorite underline) changing these values.  If the game was not created by fools, but it is, at the beginning of the game of life, both players are given one subroutine, but without knowing this in advance such things are better to check.  For these purposes, a debugger is built into the emulator, the "Debugger" window. </p><br><p><img src="https://habrastorage.org/webt/ek/a-/lb/eka-lbd4prql2whcx0_ig0j7fvq.png"></p><br><p>  And this is probably the most difficult window in the emulator.  Formally, it can be divided into two parts; a large field on the left shows the entire contents of the memory, breaking it into <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25B4_%25D0%25BE%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D0%25B8">opcodes</a> with parameters / arguments and writing the mnemonics corresponding to them.  And in the right half, at first glance, the devil himself will break his leg.  Although there is nothing complicated, you just need to read everything carefully and, if possible, remember.  I am here first of all interested in the "Breakpoints" field, where you can add breakpoints on the addresses using the "Add" button.  To find out what instructions write data to these addresses, I checked the "Write" checkbox. </p><br><p><img src="https://habrastorage.org/webt/k9/3s/9g/k93s9gnzqx3a5s51mu-n87xbrvs.png"></p><br><p>  Setup is ready. </p><br><p>  You can restart the game and see what instructions, from which subroutines and what values ‚Äã‚Äãthey write to this address.  Remembering that I am interested in writing to this address of a two, we can safely ignore all subroutines writing zeros there.  To continue the program after stopping, click the "Run" button in the debugger window. </p><br><p>  And finally, an interesting piece of code. </p><br><table><thead><tr><th>  Address </th><th>  Opcode </th><th>  Mnemonic </th><th>  Arguments </th><th>  A </th><th>  X </th><th>  Y </th></tr></thead><tbody><tr><td><del>  C2E7 </del></td><td><del>  85 39 </del></td><td><del>  Sta </del></td><td><del>  $ 0039 </del></td><td>  ?? </td><td><del>  00 </del></td><td>  ?? </td></tr><tr><td>  C2E9 </td><td>  A9 02 </td><td>  Lda </td><td>  # $ 02 </td><td>  ?? </td><td>  00 </td><td>  ?? </td></tr><tr><td>  C2EB </td><td>  A4 24 </td><td>  LDY </td><td>  $ 0024 </td><td>  02 </td><td>  00 </td><td>  00 </td></tr><tr><td>  C2ED </td><td>  F0 02 </td><td>  BEQ </td><td>  $ C2F1 </td><td>  02 </td><td>  00 </td><td>  00 </td></tr><tr><td>  C2EF </td><td>  A9 1D </td><td>  Lda </td><td>  # $ 1D </td><td>  02 </td><td>  00 </td><td>  00 </td></tr><tr><td>  C2F1 </td><td>  95 32 </td><td>  Sta </td><td>  $ 32, X </td><td>  02 or 1D </td><td>  00 </td><td>  00 </td></tr><tr><td>  C2F3 </td><td>  CA </td><td>  Dex </td><td></td><td>  02 or 1D </td><td>  00 </td><td>  00 </td></tr><tr><td>  C2F4 </td><td>  10 F3 </td><td>  BPL </td><td>  C2E9 </td><td>  02 or 1D </td><td>  FF </td><td>  00 </td></tr><tr><td><del>  C2F6 </del></td><td><del>  A9 C8 </del></td><td><del>  Lda </del></td><td><del>  # $ C8 </del></td><td><del>  02 or 1D </del></td><td><del>  FF </del></td><td><del>  00 </del></td></tr><tr><td><del>  C2F8 </del></td><td><del>  85 3C </del></td><td><del>  Sta </del></td><td><del>  $ 003C </del></td><td><del>  02 or 1D </del></td><td><del>  FF </del></td><td><del>  00 </del></td></tr></tbody></table><br><p> The crossed out instructions do not interest me, because  they work with completely different addresses.  And I will consider in detail the instructions that interest me.  At address C2E9 <sub>16</sub> lies the opcode A9 <sub>16</sub> writing the value to register A, it corresponds to the human-readable abbreviation LDA "LoaD A", which means writing to register A. This reduction corresponds to eight opcodes and specifically A9 <sub>16</sub> means that the value following is written in the following byte instruction .  In addition to the value itself, an address can be transmitted from where the value should be taken.  You can read more about opcodes <a href="http://www.thealmightyguru.com/Games/Hacking/Wiki/index.php/6502_Opcodes">here</a> , about mnemonics (abbreviations) <a href="http://www.6502.org/tutorials/6502opcodes.html">here</a> , and study the given assembly language <a href="http://www.6502.org/tutorials/">here</a> in detail (although why?).  Now you are armed with knowledge can decipher the rest of the instructions.  Only the debugger in the emulator is a little tricky and in the address C2EB <sub>16</sub> shows the instruction LDY $ 0024 and in fact this instruction is written as LDY $ 24, both of these entries are the same, but the first one converted to the opcode will take one byte more and will look like AC 24 00. To the instructions at the address C2ED <sub>16</sub> questions may also arise, this branching instruction is triggered when it is equal, but nothing compares to it, how does it work?  In fact, very simple, this instruction reads only the Zero flag of the status register.  The comparison instruction in the assembly works by subtracting one value from another without writing the result to somewhere, but with changing the flags of the status register.  Therefore, branch instructions read only flags.  In this case, the LDY instruction from the C2EB <sub>16</sub> address puts in the Y register the zero previously written in the address 0024 <sub>16</sub> and puts the one in the Zero Flag, because the result of the last operation was zero.  And the branch instruction ignores everything except the Zero flag state and seeing the unit in it jumps 2 bytes forward, from the beginning of the instruction following it, that is, to the address C2EF <sub>16</sub> + 2 <sub>16</sub> = C2F1 <sub>16</sub> .  In this address in register A lies 2 <sub>16</sub> or 1D <sub>16</sub> , depending on whether the jump was made or not, the jump was and therefore there is a two in the register.  It falls into the address 32 <sub>16</sub> indented into the value of the register X, that is, 0032 <sub>16</sub> + 00 <sub>16</sub> = 0032 <sub>16</sub> .  The following DEX instruction reduces the value of register X by 1 by writing the value of FF <sub>16 to it</sub> .  Remember that in 8 bit sign arithmetic, the values ‚Äã‚Äã(00 <sub>16</sub> - 7F <sub>16</sub> are positive, and the values ‚Äã‚Äã(80 <sub>16</sub> - FF <sub>16</sub> ) are negative. It is the sign of the number that the BPL instruction checks and if the number is positive it returns execution to the address C2E9 <sub>16.</sub> F3 <sub>16</sub> = - 13 <sub>10</sub> = -D <sub>16</sub> , C2F6 <sub>16</sub> - D <sub>16</sub> = C2E9 <sub>16.</sub> Here we can assume that somewhere before in the code in the register X was written 0 if the game is for one player or 1 if the game is for two. Obviously, the second player has already received his portion of lives on the previous iteration of the cycle (C2E9 <sub>16</sub> - C2F4 <sub>16</sub> ), and the address monitor it shows, in the address 0033 <sub>16 there</sub> is a two. View  The EE code above in the C2DD <sub>16</sub> address shows an entry in the X register of the value from the address 0022 <sub>16</sub> , if you set a breakpoint to this address on the entry and check when and what is written there, you can see that the value in this address really changes to 0 if the player is alone and 1 if there are two players. I disassembled this moment. Now we need to deal with the record. At first glance, the obvious solution is to transfer the argument C2E9 <sub>16</sub> to the opcode A9 argument 99 <sub>10</sub> = 63 <sub>16</sub> , but if the player enters "Konami code"? </p><br><p>  I had to go on a more difficult path. </p><br><p>  The idea is this: the code entered by Konami cannot be canceled, which means you can convince the game that the code has already been entered, and enter the value 99 <sub>10</sub> in the instruction argument from the C2EF <sub>16</sub> address, the one that is triggered by the entered Konami code.  So I am guaranteed to enter both players for 99 <sub>10</sub> spare lives, regardless of whether they entered the code or not.  It sounds simple enough and I started by analyzing the address 0024 <sub>16</sub> , from where the game reads Konami Code, setting a breakpoint to write to this address, I got into the next block of code. </p><br><table><thead><tr><th>  Address </th><th>  Opcode </th><th>  Mnemonic </th><th>  Arguments </th><th>  A </th><th>  X </th><th>  Y </th></tr></thead><tbody><tr><td>  F95B </td><td>  91 00 </td><td>  Sta </td><td>  ($ 00) Y </td><td>  00 </td><td>  ?? </td><td>  24 or 23 ... or FF </td></tr><tr><td>  F95D </td><td>  88 </td><td>  DEY </td><td></td><td>  00 </td><td>  ?? </td><td>  24 or 23 ... or FF </td></tr><tr><td>  F95E </td><td>  C0 FF </td><td>  CPY </td><td>  $ FF </td><td>  00 </td><td>  ?? </td><td>  23 or 22 ... or FF </td></tr><tr><td>  F960 </td><td>  D0 F9 </td><td>  Bne </td><td>  $ F95B </td><td>  00 </td><td>  ?? </td><td>  23 or 22 ... or FF </td></tr></tbody></table><br><p>  After carefully reading it, I came to the conclusion that this subroutine nulls the address range, which means it does not suit me.  More than this address nothing touched the player selection screen.  Where did the Konami code itself write the unit to this address?  Therefore, simply changing the value in the address 0024 <sub>16</sub> will not work.  Then you can pay a little more attention to the instructions: </p><br><table><thead><tr><th>  Address </th><th>  Opcode </th><th>  Mnemonic </th><th>  Arguments </th><th>  A </th><th>  X </th><th>  Y </th></tr></thead><tbody><tr><td>  C2EB </td><td>  A4 24 </td><td>  LDY </td><td>  $ 0024 </td><td>  02 </td><td>  00 </td><td>  00 </td></tr></tbody></table><br><p>  As written above, it writes the value from the address 0024 <sub>16</sub> into the Y register and it is already clear that the value of this address cannot easily be changed.  Why not change the value of the register itself.  To do this, change the opcode A4 <sub>16</sub> to opcode A0 <sub>16</sub> and pass any value other than zero to the argument.  It is said - done, but here another problem arises.  Having opened the "HEX Editor" (you cannot do this from the Debugger, you will have to use the window menu) I cannot change this opcode.  The explanation is very simple, the game uses the so-called mapping.  The technology allows you to run on the console of the game a larger volume than the console is able to accept.  It works by replacing the real ROM addresses with the addresses available to the processor, transferring to it for processing the pieces necessary for the work of the game right now.  That is, the address that I see in the debugger does not correspond to the real address on ROM, and I have no idea where to look for this instruction in ROM.  It is at this moment that the selected emulator begins to shine, because all I need now is to click on the opcode with the right mouse button and select the item "Go Here In ROM File", this will take me to the same instruction in ROM itself where I can safely change the opcode to new value.  In exactly the same way, I changed the instruction argument: </p><br><table><thead><tr><th>  Address </th><th>  Opcode </th><th>  Mnemonic </th><th>  Arguments </th><th>  A </th><th>  X </th><th>  Y </th></tr></thead><tbody><tr><td>  C2EF </td><td>  A9 1D </td><td>  Lda </td><td>  # $ 1D </td><td>  02 </td><td>  00 </td><td>  00 </td></tr></tbody></table><br><p>  From 1D <sub>16</sub> to 63 <sub>16</sub> .  Afterwards I will definitely save the result to a new file, because if I didn‚Äôt get around all the defenses of the game, I just broke ROM and I don‚Äôt want to be left without a working original. </p><br><p>  PS: I apologize for mnogabukaff and thorough, perhaps too thorough chewing.  Ready to accept any criticism, comments and corrections.  Thank you very much, your Victor. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/447758/">https://habr.com/ru/post/447758/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447746/index.html">Business logic in a database using SchemaKeeper</a></li>
<li><a href="../447748/index.html">Linux Virtual File Systems: Why Do They Need It and How Do They Work? Part 2</a></li>
<li><a href="../447750/index.html">New processors for data centers - parse announcements of recent months</a></li>
<li><a href="../447754/index.html">Application in the menu bar for macOS</a></li>
<li><a href="../447756/index.html">New Gartner Application Monitoring Solution (APM) quadrant</a></li>
<li><a href="../447760/index.html">Broadcasting the moon landing [22: 00MSK 11 Apr 2019]</a></li>
<li><a href="../447762/index.html">Radiation: the war with the invisible killer or a little more about radon</a></li>
<li><a href="../447764/index.html">Simply space! How is the planetarium Lakhta Center</a></li>
<li><a href="../447770/index.html">What information products are fraught with evil?</a></li>
<li><a href="../447772/index.html">Path pre-engineer, or internship, life-changing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>