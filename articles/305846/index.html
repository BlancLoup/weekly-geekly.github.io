<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>API Yandex.Panoram: how to make your virtual walk or just bring a person from the subway</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have been asked for a very long time to create an API that allows embedding Yandex Panoramas on our sites, and we were finally able to do it. Even ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>API Yandex.Panoram: how to make your virtual walk or just bring a person from the subway</h1><div class="post__text post__text-html js-mediator-article"><p>  We have been asked for a very long time to create an API that allows embedding Yandex Panoramas on our sites, and we were finally able to do it.  Even more: our API allows you to create your own panoramas. </p><br><p>  In this post I will tell you what you need to know to do such virtual walks.  Why it was not so easy to make an API for them, as we resolved various problems arising in the way and explain in detail what you can do with the help of our API (more than it might seem at first glance). </p><br><p> <a href="https://habrahabr.ru/company/yandex/blog/305846/"><img src="https://habrastorage.org/files/850/903/34f/85090334f7444d57a1662511079dd10f.jpg"></a> </p><br><h2>  Engine </h2><br><p>  Panorama service launched on Yandex.Maps back in September 2009.  At first, there were only a few panoramas of the sights and they worked, as you might guess, in Flash.  Since then much water has flowed under the bridge, several million panoramas have begun, mobile platforms have begun to grow rapidly, and Flash has not made its way there.  Therefore, around 2013, we decided that we needed a new technology.  And the basis for this technology was HTML5. </p><a name="habracut"></a><br><p>  The API we started with is Canvas2D.  Now it may seem strange, but in 2013 this choice was quite reasonable.  WebGL was standardized only two years earlier, didn‚Äôt really get to mobiles (in iOS, for example, WebGL worked only in the iAd which had almost died), and it didn‚Äôt work very well on desktops.  A reader may object to me that everything had to be done on CSS 3D, as it was then popular.  But using CSS 3D, you can draw only a cubic panorama, while all Yandex panoramas are spherical (stored in an equidistant projection). </p><br><p>  This was the most important technical difficulty in the development.  The fact is that correctly and accurately projecting a spherical panorama on the screen is not easy due to the nonlinearity of this transformation.  A naive implementation of such a projection would require a whole heap of trigonometric calculations for each pixel of the screen - after all, you need to find the corresponding point in the panoramic image and determine its color.  In addition, Canvas 2D does not provide an effective way to manipulate each image pixel separately. </p><br><p>  One of the oldest tricks in computer graphics, linear interpolation, comes to the rescue in this difficult situation.  We will not accurately calculate the coordinates of the corresponding point in the panoramic image for each pixel of the screen.  We will do this only for some pixels, which we will choose in advance - and for the rest we will find the coordinates, interpolating between those already calculated.  The only question is how to select these pixels. </p><br><p>  As already noted, recording pixel-by-pixel color in Canvas2D is inconvenient, but it is convenient to work with images and their two-dimensional transformations.  In addition, such transformations actually implement interpolation for us.  It was their decision to use as the basis of the panorama rendering algorithm.  And since a two-dimensional linear transformation is uniquely defined by two triplets of points, one on the screen and the other on a panoramic image, the choice of a set of points for which we will consider the projection exactly turns out by itself: we divide the panoramic sphere into triangles.  The final rendering algorithm is as follows: </p><br><p><img src="https://habrastorage.org/files/f8d/41a/492/f8d41a49287941fd9473ea07f2535bbe.png" alt="Canvas2D rendering algorithm"></p><br><p> Having written all this and running it, I saw something well described by the word ‚Äúslideshow‚Äù.  The frame rate was completely unacceptable.  After profiling, I found that the <code>save()</code> and <code>restore()</code> Canvas 2D context functions consume most of the time.  Where did they come from?  Of the features of working with trimming in Canvas2D.  Unfortunately, to be able to reset the current cropping and set a new one, you must save the context state before setting (this is just <code>save()</code> ), and after all the necessary drawing, restore the saved state (and this is <code>restore()</code> ).  And since these operations work with the entire state <br>  context, they are not cheap.  In addition, we do the same trimming every time (after initialization, the division of the sphere into triangles and their imposition on the panoramic image does not change).  It makes sense to cache it! </p><br><p>  No sooner said than done.  After generating the triangulated sphere, we ‚Äúcut out‚Äù each triangle from the panoramic image and save it in a separate cache canvas.  The rest of this cache remains transparent.  After this optimization, it was possible to get 30-60 frames per second even on mobile devices.  From this experience, the following lesson can be learned: when designing rendering on Canvas 2D, all you can do is cache and pre-render.  And if something is suddenly impossible - do it so that it is possible, and also prerender. </p><br><p><img src="https://habrastorage.org/files/929/567/eb0/929567eb0a7940d58a091e536637a717.png" alt="Cutting triangle caches"></p><br><p>  Any caching (like many things in this life) has a downside: memory consumption inevitably increases.  This is exactly what happened with the rendering of the panorama.  Increased appetites have created many problems.  The most noticeable are the crashes of browsers even on desktop platforms, and also a rather slow start.  In the end, tired of fighting these problems, we abandoned the reprojection of the panoramic image on Canvas 2D and went the other way.  But he is not interesting at all :) </p><br><p>  However, even before we started looking from the side of WebGL.  We were pushed to this by various reasons, the main one of which, perhaps, was iOS 8, which WebGL earned in Safari. </p><br><p>  The main problem in the development of WebGL-rendering version was the size of the panoramas.  Panoramic image is not completely climbed into any texture.  We solved this problem again, guided by the principle ‚Äúfollow the old principles as the world principles‚Äù, and divided the panoramic sphere into sectors.  Each sector has its own texture.  At the same time, to save memory and GPU resources, invisible sectors are completely removed.  When they should appear on the screen again, the data for them is reloaded again (usually from the browser cache). </p><br><h2>  Embedding panoramas </h2><br><p>  Embedding panoramas using the Maps API begins with the connection of the necessary modules.  This can be done in two ways: either by specifying them in the <code>load</code> parameter when the API is connected, or by using a modular system (we will soon add the panorama modules to the default module set). </p><br><pre> <code class="html hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!--       API. --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://api-maps.yandex.ru/2.1/?lang=ru_RU&amp;amp;load=panorama.locate,panorama.Player"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">//     . ymaps.modules.require([ 'panorama.createPlayer', 'panorama.isSupported' ]) .done(function () { // ... }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Before you start working with panoramas, you must make sure that the user's browser is supported by the engine.  This can be done using the function <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/panorama.isSupported-docpage/"><code>ymaps.panorama.isSupported</code></a> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ymaps.panorama.isSupported()) { <span class="hljs-comment"><span class="hljs-comment">//   ,   // , etc. } else { //   . }</span></span></code> </pre> <br><p>  To open a panorama, we first need to get its description from the server.  This is done using the <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/panorama.locate-docpage/"><code>ymaps.panorama.locate</code></a> function: </p><br><pre> <code class="javascript hljs">ymaps.panorama.locate( [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-comment"><span class="hljs-comment">//   ).done(function (panoramas) { // ... });</span></span></code> </pre> <br><p>  The result that will be resolved by the promis returned by a call to <code>ymaps.panorama.locate</code> will be an array of panoramas located in a certain neighborhood of the passed point.  If there is no such panorama, the array will be empty.  If several such panoramas are found, they will be sorted by distance from the transmitted point.  The first one will be closest. </p><br><p>  You can also request aerial panoramas: </p><br><pre> <code class="javascript hljs">ymaps.panorama.locate( [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-comment"><span class="hljs-comment">//   { layer: 'yandex#airPanorama' } ).done(function (panoramas) { // ... });</span></span></code> </pre> <br><p>  Having received the description of the panorama, we can create a player that displays it on the page: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> player = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ymaps.panorama.Player( <span class="hljs-string"><span class="hljs-string">'player'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// ID ,      panorama // ,       );</span></span></code> </pre> <br><p>  And we will see on the page: </p><br><p><img src="https://habrastorage.org/files/207/44b/e6a/20744be6a9234b2ba94ba39336caf724.png" alt="Player panoramas"></p><br><p>  The fastest and easiest way to open a panorama is the function <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/panorama.createPlayer-docpage/"><code>ymaps.panorama.createPlayer</code></a> : </p><br><pre> <code class="javascript hljs">ymaps.panorama.createPlayer( <span class="hljs-string"><span class="hljs-string">'player'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// ID DOM-,      [0, 0] //  ,     ).done(function (player) { // ... });</span></span></code> </pre> <br><p>  In this case, you can specify one or more <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/panorama.createPlayer-docpage/">options by the</a> third parameter: </p><br><pre> <code class="javascript hljs">ymaps.panorama.createPlayer( <span class="hljs-string"><span class="hljs-string">'player'</span></span>, [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>], { <span class="hljs-comment"><span class="hljs-comment">// ,     layer: 'yandex#airPanorama', //   direction: [120, 10], //      span: [90, 90], //   controls: ['zoomControl', 'closeControl'] } ).done(function (player) { // ... });</span></span></code> </pre> <br><p>  After creation, the player provides a compact API for managing the display of panoramas and subscriptions to user events.  But, as it seems to me, this is not the most interesting feature of the API panoramas. </p><br><h2>  Your panoramas </h2><br><p>  Perhaps the most interesting opportunity that the API provides is to create your own panoramas and embed them on the site. </p><br><p>  Any panorama begins with shooting and preparing a panoramic image.  For shooting, you can use a special device, an ordinary camera or even a smartphone.  The main thing is that the result of shooting and glueing should be a spherical panorama in an equidistant projection.  For example, a standard camera application on Android can shoot and glue panoramas in the desired projection.  That we used them for shooting panoramas of our cozy openspace. </p><br><p>  After we have shot the panoramic image, it is necessary to prepare it for display in the player.  For this we need to cut it into tiles.  In addition, we can prepare images of several different sizes for different levels of mastabilization.  The player will select the most appropriate level for the current size of the DOM element in which the player is open and the angular dimensions of the visible panorama area.  And if the smallest level is less than 2048 pixels across the width of the image, it will be used to create the ‚Äúprogressive jeep-effect‚Äù.  The player will load the tiles of this level with the highest priority and will show them where there are no better quality tiles (for example, if they have not yet been loaded or have been pushed out of memory and have not yet rebooted). </p><br><p>  To cut images into tiles, you can use any software (if you have a certain perseverance - even Paint).  The size of the tiles should be a power of two (those of you who worked with WebGL, I think, guess where your legs grow from this restriction).  I used ImageMagick: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      ,    #       (  , ,  ). $ convert src.jpg -resize 7168x3584 hq.jpg #      512  512 . $ convert hq.jpg -crop 512x512 \ -set filename:tile "%[fx:page.x/512]-%[fx:page.y/512]" \ "hq/%[filename:tile].jpg" #       ¬´ #  ¬ª.      ,   #    . $ convert hq.jpg -resize 512x256 lq/0-0.jpg</span></span></code> </pre> <br><p>  Let's finally write some code for our panorama.  An API is a system of interconnected interfaces.  These interfaces describe the panorama object and all associated with it. </p><br><p><img src="https://habrastorage.org/files/182/ff0/fb7/182ff0fb745c40158e5212d4c39a2b4f.png" alt="Interfaces"></p><br><p>  Let's now analyze this image by entities. </p><br><p>  The panorama object must implement the <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/IPanorama-docpage/"><code>IPanorama</code></a> interface.  To write your panorama class was easier, made the abstract class <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/panorama.Base-docpage/"><code>ymaps.panorama.Base</code></a> .  It provides reasonable default implementations for some <code>IPanorama</code> methods, as well as the <code>validate</code> method, which checks whether the panorama satisfies the restrictions imposed by the player (for example, if the specified tile size is a power of two).  Let's take it and use it. </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Panorama</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ Panorama.superclass.constructor.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... //  ,     . this.validate(); } ymaps.util.defineClass(Panorama, ymaps.panorama.Base, { // ,   . });</span></span></code> </pre> <br><p>  We begin by describing the player to the panorama geometry.  To do this, you need to implement the <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/IPanorama-docpage/"><code>getAngularBBox</code></a> method, which returns, according to the documentation, an array of four numbers.  What is the meaning of these numbers?  To answer this question, let us recall that our panorama is spherical, that is, superimposed on a sphere.  To describe the position of the panoramic image on the sphere, it is necessary to select some "reference" points.  Usually for a rectangle (and a panoramic image, not being on a sphere, it is just like any other image in a computer) that the coordinates of its two opposite corners are chosen.  In our case, this approach continues to work on the sphere, because the vertical sides of the image become meridians when they are superimposed, and the horizontal sides become parallels.  This means that each side of the rectangle has its own angular coordinate, common to all points of this side.  It is these coordinates of the sides that make up the array returned by the <code>getAngularBBox</code> method, defining a kind of spherical rectangle bounding the panorama (hence the name of the method). </p><br><p>  The player imposes an important limitation on the geometry of the panorama (and therefore on the panoramic image itself): the panoramic image must be closed on the sphere horizontally, forming a full circle.  For the values ‚Äã‚Äãreturned by the <code>getAngularBBox</code> method, this means that the difference between the right and left corner of the panorama should be 2œÄ.  As for the vertical borders, they can be any. </p><br><p>  The panorama that we shot with a smartphone is not only complete horizontally, but also vertically, that is, from pole to pole.  Therefore, the boundaries of the panorama on the sphere will be the intervals <code>[œÄ/2, -œÄ/2]</code> vertically (from the upper pole to the lower) and <code>[0, 2œÄ]</code> horizontally (here, for simplicity, we assume that the direction to the joint of the panorama coincided with the direction to north, which of course is not true).  It turns out this code: </p><br><pre> <code class="javascript hljs">getAngularBBox: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-number"><span class="hljs-number">0.5</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, <span class="hljs-number"><span class="hljs-number">-0.5</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, <span class="hljs-number"><span class="hljs-number">0</span></span> ]; }</code> </pre> <br><p>  You also need to implement methods that return the position of the panorama and the coordinate system in which it is set.  This data will be used by the player for correct positioning in the scene of objects related to the panorama (about them below). </p><br><pre> <code class="javascript hljs">getPosition: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//         , ... return [0, 0]; }, getCoordSystem: function () { // ...    ,     //  -   . return ymaps.coordSystem.cartesian; },</span></span></code> </pre> <br><p>  Now we will describe the panoramic images themselves - how they are cut into tiles and where these tiles lie.  To do this, we need to implement the <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/IPanorama-docpage/"><code>getTileSize</code></a> and <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/IPanorama-docpage/"><code>getTileLevels</code></a> .  With the first one everything is obvious: it returns the size of the tiles. </p><br><pre> <code class="javascript hljs">getTileSize: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>]; }</code> </pre> <br><p>  <code>getTileLevels</code> returns an array of objects describing the zoom levels of the panoramic image.  We have them, I remind you, there were two: high (relatively) and low quality.  Each such description object must implement the <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/IPanoramaTileLevel-docpage/"><code>IPanoramaTileLevel</code></a> interface, which consists of two methods: <code>getImageSize</code> and <code>getTileUrl</code> .  For simplicity, we will not start a separate class for this, just return the objects with the necessary methods. </p><br><pre> <code class="javascript hljs">getTileLevels: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ { <span class="hljs-attr"><span class="hljs-attr">getTileUrl</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'/hq/'</span></span> + x + <span class="hljs-string"><span class="hljs-string">'-'</span></span> + y + <span class="hljs-string"><span class="hljs-string">'.jpg'</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">getImageSize</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-number"><span class="hljs-number">7168</span></span>, <span class="hljs-number"><span class="hljs-number">3584</span></span>]; } }, { <span class="hljs-attr"><span class="hljs-attr">getTileUrl</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'/lq/'</span></span> + x + <span class="hljs-string"><span class="hljs-string">'-'</span></span> + y + <span class="hljs-string"><span class="hljs-string">'.jpg'</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">getImageSize</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">256</span></span>]; } } ]; }</code> </pre> <br><p>  This completes the minimum description of the panorama, and the player will be able to display it: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> player = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ymaps.panorama.Player(<span class="hljs-string"><span class="hljs-string">'player'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Panorama());</code> </pre> <br><p>  By the way, such a minimal description of the panorama can be made faster and simpler with the help function <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/panorama.Base.createPanorama-docpage/"><code>ymaps.panorama.Base.createPanorama</code></a> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> player = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ymaps.panorama.Player( <span class="hljs-string"><span class="hljs-string">'player'</span></span>, ymaps.panorama.Base.createPanorama({ <span class="hljs-attr"><span class="hljs-attr">angularBBox</span></span>: [ <span class="hljs-number"><span class="hljs-number">0.5</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, <span class="hljs-number"><span class="hljs-number">-0.5</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, <span class="hljs-number"><span class="hljs-number">0</span></span> ], <span class="hljs-attr"><span class="hljs-attr">position</span></span>: [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-attr"><span class="hljs-attr">coordSystem</span></span>: ymaps.coordSystem.cartesian, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">' -'</span></span>, <span class="hljs-attr"><span class="hljs-attr">tileSize</span></span>: [<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>], <span class="hljs-attr"><span class="hljs-attr">tileLevels</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">getTileUrl</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'/hq/'</span></span> + x + <span class="hljs-string"><span class="hljs-string">'-'</span></span> + y + <span class="hljs-string"><span class="hljs-string">'.jpg'</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">getImageSize</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-number"><span class="hljs-number">7168</span></span>, <span class="hljs-number"><span class="hljs-number">3584</span></span>]; } }, { <span class="hljs-attr"><span class="hljs-attr">getTileUrl</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'/lq/'</span></span> + x + <span class="hljs-string"><span class="hljs-string">'-'</span></span> + y + <span class="hljs-string"><span class="hljs-string">'.jpg'</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">getImageSize</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">256</span></span>]; } } ] }) );</code> </pre> <br><p>  In addition to the panorama itself, the player can display three types of objects: markers, transitions and links. </p><br><p>  Markers allow you to mark objects in a panorama (for example, markers with house numbers in Yandex panoramas).  The token object must implement the <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/IPanoramaMarker-docpage/"><code>IPanoramaMarker</code></a> interface.  This interface contains only three methods: <code>getIconSet</code> , <code>getPosition</code> and <code>getPanorama</code> .  The purpose of the last two is quite understandable from their names.  The first I see necessary to clarify.  The fact is that the marker is an interactive element.  It changes state by responding to user events.  These states and how they change by events in the UI can be written with the following diagram: </p><br><p><img src="https://habrastorage.org/files/cd8/26f/c28/cd826fc28f6e4d3aa8d988ea2e4a331f.png" alt="Marker states"></p><br><p>  For example, a marker denoting a house.  Here is its default state, the state when the cursor is pointing, and the expanded state: </p><br><p><img src="https://habrastorage.org/files/ba5/5fc/d4a/ba55fcd4a6c74aaaae18dc5da46099a8.png" alt="Marker states"></p><br><p>  It is the icons of these states that the <code>getIconSet</code> method returns to the player.  The icon can be either loaded from the server (this is exactly what this method is made asynchronous for), and procedurally generated (using the canvas).  In our example, we assume that in the panorama one marker and its icons are already loaded: </p><br><pre> <code class="javascript hljs">getMarkers: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     ,     // ,  . var panorama = this; return [{ properties: new ymaps.data.Manager(), getPosition: function () { return [10, 10]; }, getPanorama: function () { return panorama; }, getIconSet: function () { return ymaps.vow.resolve({ 'default': { image: defaultMarkerIcon, offset: [0, 0] }, hovered: { image: hoveredMarkerIcon, offset: [0, 0] } // ,     , //   `default`. }); } }]; }</span></span></code> </pre> <br><p>  Transitions are the same arrows, on click on which the player moves to the next panorama.  Objects that describe transitions must implement the <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/IPanoramaThoroughfare-docpage/"><code>IPanoramaThorougfare</code></a> interface: </p><br><pre> <code class="javascript hljs">getThoroughfares: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       :) var panorama = this; return [{ properties: new ymaps.data.Manager(), getDirection: function () { //    ,    // ,     . return [Math.PI, 0]; }, getPanorama: function () { return panorama; }, getConnectedPanorama: function () { //       . // ,        // ,      ymaps.panorama.locate. return ymaps.panorama.locate(/* ... */) .then(function (panoramas) { if (panoramas.lengths == 0) { return ymaps.vow.reject(); } return panoramas[0]; }); } }]; }</span></span></code> </pre> <br><p>  Connections are a kind of hybrid of markers and transitions: they look like the first, and behave like the last.  In the code, they are implemented in the same way as markers, but with the addition of the <code>getConnectedPanorama</code> method (see <a href="https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/IPanoramaConnection-docpage/"><code>IPanoramaConnection</code></a> ). </p><br><h2>  Instead of conclusion </h2><br><p>  The Panoramas API is currently running in beta status.  Embed, test on your websites and applications, tell us about it in a <a href="https://yandex.ru/blog/mapsapi">club</a> , a <a href="https://vk.com/ymapsapi">group on VKontakte</a> , <a href="https://www.facebook.com/ymapsapi/">Facebook</a> or through <a href="https://tech.yandex.ru/maps/doc/geocoder/desc/feedback/troubleshooting-docpage/">support</a> .  Here is CIAN already :) </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/305846/">https://habr.com/ru/post/305846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305836/index.html">Mobile programmatic "on the fingers": the revolution will be velvet</a></li>
<li><a href="../305838/index.html">Big Data from A to Z. Part 5.2: Advanced hive features</a></li>
<li><a href="../305840/index.html">Basics of game design: 20 board games. Part Four: Train Ticket, Carcassonne, Colonialists</a></li>
<li><a href="../305842/index.html">Improving colors on the web (for eplofilov)</a></li>
<li><a href="../305844/index.html">Lenovo will fix a 0day ThinkPwn vulnerability in the firmware of its computers</a></li>
<li><a href="../305848/index.html">A collection of songs with a guitar to the day of the system administrator (with chords!)</a></li>
<li><a href="../305850/index.html">Tales of Ransomwhere</a></li>
<li><a href="../305852/index.html">Azure DevTest Labs</a></li>
<li><a href="../305854/index.html">Since July 18, a new procedure for registering computer programs at Rospatent. What changed?</a></li>
<li><a href="../305856/index.html">Data center cooling market news: air conditioners of a new generation InRow DX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>