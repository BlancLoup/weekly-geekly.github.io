<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>LAppS application server for microservice architecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 


 On December 20th of last year I went on vacation, for the whole 2 weeks. What to do on vacation? That's right - code. Code, which there...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>LAppS application server for microservice architecture</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/getpro/habr/post_images/5e1/d85/bd2/5e1d85bd2816c6f5dabfd63f85506c50.png" alt="image"></p><br><h1 id="predystoriya">  Prehistory </h1><br><p>  On December 20th of last year I went on vacation, for the whole 2 weeks.  What to do on vacation?  That's right - code.  Code, which there is no time to do during working hours.  The last few years I have had very little code.  Hands were miserable.  What code is written on vacation?  I do not know about you, but I write bicycles.  What for?  There can be many reasons, but the main one is interesting to me.  I love C ++ and Lua.  I also love bash and awk.  Do not throw stones, this is personal, it happened.  I don‚Äôt really like JavaScript (although for the last 2 years, if something has been coding something on JS), this is also personal. </p><a name="habracut"></a><br><h1 id="chto-v-itoge-poluchilos">  What is the result? </h1><br><p>  The result of boredom on vacation was <a href="https://github.com/ITpC/LAppS">LAppS - Lua Application Server</a> .  This holiday coding lasted for 6 months (of course, after December I didn‚Äôt spend a lot of time on the code, this is evident from commits in github).  But in the last 2 weeks we managed to grab a lot of time to get something working. </p><br><h2 id="chto-eto">  What is it </h2><br><p>  As it is already clear from the name, - <strong>LAppS</strong> Lua application server.  Lua is quite a popular language, a bunch of Nginx + Lua with OpenResty libraries is actively used throughout the world, one Cloudflare is worth.  At the time of development, the above-mentioned Lua module for Nginx and Tarantool, luvit.io already existed.  But none of them supported WebSockets.  <strong>LAppS</strong> does not support HTTP.  But now <strong>LAppS</strong> exceeds the performance of uWebSockets (at the cost of consumption of large computing resources). </p><br><p>  The main idea was to minimize the development cycle of microservices.  Lua has a lower entry threshold than JavaScript.  I'm more than sure, even middle school students can quite easily start programming in Lua.  But here all the available web application development tools for Lua, have not such a minimum threshold of entry. </p><br><p>  Therefore, the main emphasis in the development was placed on the minimalist API and the ease of creating applications, as well as the ease of configurability of the application server and services. </p><br><h2 id="detali">  Details </h2><br><p>  Lua applications (services) in <strong>LAppS</strong> do not block I / O.  This is probably the biggest difference from a web server with Lua scripting.  <strong>LAppS</strong> uses 2 configuration files to configure the behavior of the WebSockets server and to deploy applications. </p><br><p>  By default, if there are no configuration files, then LAppS will try to launch demo applications running in the distribution. </p><br><h3 id="wsjson---konfiguracionnyy-fayl-servera-websockets">  ws.json - WebSockets server configuration file </h3><br><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">0.7</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5083</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">1000</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span> : <span class="hljs-string"><span class="hljs-string">"/opt/lapps/etc/ssl/cert.pem"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span> : <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/cert.pem"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span> : <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/key.pem"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbound_message_size"</span></span> : <span class="hljs-number"><span class="hljs-number">300000</span></span> }</code> </pre> <br><ul><li>  <em>listeners</em> - the number of listeners launched in parallel, this parameter affects how quickly <strong>LAppS</strong> accepts incoming connections </li><li>  <em>connection_weight</em> is a parameter for the internal balancer comparing the depth of the IOWorker I / O queue and the number of connections.  The more simultaneous connections, the smaller this parameter should be, since  connections can use different services with different load profiles.  In such a situation, it is better to use a less loaded IOWorker for a new connection than an IOWorker with a smaller number of connections. </li><li>  <em>ip</em> - IP address of the interface on which the server will listen for incoming connections.  By default - all interfaces. </li><li>  <em>port</em> - the port.  The default is 5083. </li><li>  <em>workers.workers</em> - Number of concurrently working IOWorkers.  The default is 3. </li><li>  <em>workers.max_connections</em> - not yet used.  In the future, it will set the limit of active connections for the 1st IOWorker. <br><ul><li>  <em>tls</em> - use tls?  The default is yes.  In general, the parameter is useless.  Whether to use TLS is dictated by the build option.  By default, the server is built using LibreSSL, and TLS 1.2. </li></ul></li><li>  <em>tls_certificates.ca</em> - The path to the certificate supplied with LibreSSL. </li><li>  <em>tls_certificates.cert</em> - Certificate path (the default is self-signed certificate localhost) </li><li>  <em>tls_certificates.key</em> - certificate key </li><li>  <em>auto_fragment</em> ‚Äî whether to use auto-fragmentation for outgoing messages (not yet effective) </li><li>  <em>max_inbound_message_size</em> - limit the size of incoming messages (not yet effective) </li></ul><br><h3 id="lappsjson---fayl-konfiguracii-servisov">  lapps.json - Services Configuration File </h3><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span> : <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span> : <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"echo"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span> : <span class="hljs-string"><span class="hljs-string">"/echo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span> : <span class="hljs-string"><span class="hljs-string">"raw"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"echo_lapps"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span> : <span class="hljs-string"><span class="hljs-string">"/echo_lapps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span> : <span class="hljs-string"><span class="hljs-string">"LAppS"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> } } }</code> </pre> <br><ul><li>  <em>directories.applications</em> - path to the directory with applications, relative to the environment variable LAPPS_HOME (default / opt / lapps), - default apps </li><li>  <em>directories.app_conf_dir</em> - path to the service configuration files (not used yet) </li><li>  * directories. {tmp, workdir} - not yet used either </li><li>  <em>services</em> - service settings map </li></ul><br><p>  In the above example, 2 demo services are configured: echo and echo_lapps.  The service name is the default path and search for Lua modules of applications.  In fact, applications in <strong>LAppS</strong> are modules following a specific interface. </p><br><p>  In addition to the <strong>internal</strong> parameter, all other service settings are required. </p><br><ul><li>  <em>services. {name}</em> - in the example services.echo and services.echo_lapps, the name of the service. </li><li>  <em>services. {name} .request_target</em> - target in WebSockets URL, example wss: //127.0.0.1: 5083 / echowss: //127.0.0.1: 5083 / echo or wss: //127.0.0.1: 5083 / echo_lapps.  IOWorkers after handshake associate sockets with a specific application based on this goal.  If there is no target requested by the client in the service map, the handshake is broken with code 403. </li><li>  <em>services. {name} .protocol</em> - the protocol type of the application.  Now only 2 types of protocols are used: raw and LAppS (about them below) </li><li>  <em>services. {name} .instances</em> - the number of concurrently running instances of the application.  Each connection is assigned to its own instance of the application. </li></ul><br><h2 id="sborka-i-ustanovka">  Assembly, and installation </h2><br><p>  Installation and installation instructions can be found on <a href="https://github.com/ITpC/LAppS/wiki">the project‚Äôs wiki page.</a> </p><br><p>  You can use the prepared <a href="">deb</a> package for installation in ubuntu-xenial </p><br><h1 id="prilozheniyaservisy">  Applications / Services </h1><br><p>  Applications are actually Lua modules that should have several predefined methods with predefined behavior: </p><br><ul><li>  <em>onStart</em> - the onStart method, executed once before the application starts.  Here you can carry out the initial configuration, execute any code important for the initialization of the application.  This method should not block the Lua virtual machine indefinitely.  Those.  performing a while (1) loop in this method will result in the service not responding to incoming requests. </li><li>  <em>onShutdown is</em> similar to onStart, the method is executed once, when the application is stopped.  Also, do not endlessly block the flow of the Lua machine.  Otherwise, the service will not stop itself and will not allow the application server to stop. </li><li>  <em>onMessage</em> is implemented differently for the raw and LAppS protocols.  Depending on the parameter specified in the configuration, this method will receive data of different types. <br><ul><li>  raw: <em>bool onMessage (handler, opcode, message)</em> - where <em>handler</em> is the unique identifier of the connection;  <em>opcode</em> - WebSockets OpCode, which accepts only two values ‚Äã‚Äã1 (TEXT) or 2 (BINARY), all frames with other opcodes are processed by the server and are not transmitted to the application;  <em>message</em> is a Lua string value containing a binary or text message (depending on the opcode with which the frame was sent). </li><li>  LAppS: <em>bool onMessage (handler, msg_type, message)</em> - <em>handler</em> is the unique identifier of the connection;  <em>message</em> - the actual message corresponding to the LAppS 1.0 specification, is a userdata object of type nljson;  <em>msg_type</em> - auxiliary parameter, message type, takes four values ‚Äã‚Äãfrom 1 to 4: <br><ul><li>  1 - Client Notification (CN) </li><li>  2 - CN with additional parameters in the params array </li><li>  3 - request to execute the method without parameters </li><li>  4 - request for the method execution with parameters in the params array </li></ul></li></ul></li><li>  <em>onDisconnect (handler)</em> - a method called upon breaking (resetting or correctly closing in accordance with RFC 6455) the connection by the client.  handler - unique identifier of the connection. </li></ul><br><p>  Note: the <em>onMessage</em> method is <em>required</em> to return a boolean value.  If the value is returned false, the connection for which the method was called is broken (close code 1000). </p><br><h2 id="prosteyshee-prilozhenie-skelet-implementiruyuschee-echo-server-protokol-raw">  The simplest skeleton application implementing echo-server (raw protocol). </h2><br><pre> <code class="lua hljs">myapp = {} myapp.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span> = myapp; myapp[<span class="hljs-string"><span class="hljs-string">"onStart"</span></span>]=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">-- do something on start end myapp["onDisconnect"]=function(handler) -- handler - is a unique client identifier -- react on client disconnect end myapp["onShutdown"]=function() -- do something on shutdown end myapp["onMessage"]=function(handler,opcode, message) -- it is an echo, - we return back the same message local result, errmsg=ws:send(handler,opcode,message); if(not result) then print("myapp::OnMessage(): "..(errmsg or "none")); end return result; end return myapp;</span></span></code> </pre> <br><p>  Configuration for this service: </p><br><pre> <code class="hljs objectivec"> <span class="hljs-string"><span class="hljs-string">"myapp"</span></span> : { <span class="hljs-string"><span class="hljs-string">"internal"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"request_target"</span></span> : <span class="hljs-string"><span class="hljs-string">"/myapp"</span></span>, <span class="hljs-string"><span class="hljs-string">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"raw"</span></span> }</code> </pre> <br><h1 id="protokol-lapps">  LAppS protocol </h1><br><p>  The LAppS protocol specification is based on the Google JSON-RPC specification with the following key points: </p><br><ul><li>  binary messaging in CBOR format </li><li>  the protocol specifies "Out of Order Notifications" (OON), the type of messages initiated by the server. </li><li>  the protocol specifies the message channels.  Given the need for request-response messages, as well as the need for notifications from the server side, the channels allow the client application to have a parallel data stream on different channels on the same connection.  Channel 0 (CCH) is reserved for request-response messages, all other channels are agreed by the application. </li></ul><br><p>  The specification is available on <a href="">github.</a> </p><br><h2 id="prilozhenie-s-podderzhkoy-protokola-lapps">  LAppS-enabled application </h2><br><p>  I will not give the full code of the application, I will give only the implementation of the onMessage method.  Details of the demo application can be found in the source code on github. </p><br><pre> <code class="lua hljs">echo_lapps[<span class="hljs-string"><span class="hljs-string">"onMessage"</span></span>]=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,msg_type, message)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">--       local switch={ [1] = function() --        -- (      ) --    local err_msg=nljson.decode([[{ "status" : 0, "error" : { "code" : -32600, "message": "This server does not accept Client Notifications without params" }, "cid" : 0 }]]); --     ws:send(handler,err_msg); --  WebSocket   1003 - " " ws:close(handler,1003); end, [2] = function() -- CN  . . local method=methods._cn_w_params_method[message.method] or echo_lapps.method_not_found; method(handler,message.params); end, [3] = function() --      local method=echo_lapps.method_not_found; method(handler); end, [4] = function() --     local method=methods._request_w_params_method[message.method] or echo_lapps.method_not_found; method(handler,message.params); end } --   switch[msg_type](); return true; end</span></span></code> </pre><br><h1 id="avto-podgruzhaemye-moduli">  Auto-loadable modules </h1><br><p>  <strong>LAppS</strong> loads several modules before starting the service: <em>nljson</em> , <em>ws</em> , <em>bcast</em> .  details of the specification of the modules can be found on the project wiki. </p><br><p>  Briefly: </p><br><ul><li>  <strong>nljson</strong> is a module for working with JSON (ecode / decode / cbor). </li></ul><br><p>  Working with a module is not much different from working with native Lua tables.  Moreover, Lua tables are converted to nljson userdata using simple assignment.  However, Lua does not distinguish between objects (key-value) and arrays, so for example, for empty Lua-tables, converting them to nljson presents some obstacle.  for example </p><br><pre> <code class="lua hljs"> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> object=nljson.decode({})</code> </pre> <br><p>  Will create a JSON-Array named object.  Therefore, it is better to use this initialization: </p><br><pre> <code class="lua hljs"> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> object=nljson.decode(<span class="hljs-string"><span class="hljs-string">'{}'</span></span>)</code> </pre> <br><p>  This definition will uniquely create a JSON-Object. </p><br><p>  Further, this object can be used as a native table: </p><br><pre> <code class="lua hljs"> object[<span class="hljs-string"><span class="hljs-string">"test"</span></span>]=<span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(object.test) object[<span class="hljs-string"><span class="hljs-string">"map"</span></span>]={ [<span class="hljs-string"><span class="hljs-string">"key1"</span></span>] = <span class="hljs-string"><span class="hljs-string">"value"</span></span>, [<span class="hljs-string"><span class="hljs-string">"key2"</span></span>] = <span class="hljs-number"><span class="hljs-number">33</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(object)</code> </pre> <br><p>  The speed of working with nljson objects differs little from native Lua tables. </p><br><ul><li>  <strong>ws</strong> is a module for sending WebSocket messages; it has only 2 methods: send, close. </li><li>  <strong>bcast</strong> - broadcast messages module, available methods: subscribe, unsubscribe, create, send. </li></ul><br><h1 id="klientskie-prilozheniya">  Client applications </h1><br><p>  It's all simpler than steamed turnip, - the benefit of WebSockets API for browsers is thought out and simple. <br>  Mandatory library cbor.js.  Webix is ‚Äã‚Äãused to display bar-chart. <br>  Do not kick the password in the code text.  This is just a demo. </p><br><div class="spoiler">  <b class="spoiler_title">customer demo code</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://cdn.webix.com/edge/webix.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://cdn.webix.com/edge/webix.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cbor.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chart"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width:100%;height:300px;margin:3px"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stime"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width:100%;height:300px;margin:3px"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// globals window["secs_since_start"]=0; window["roundtrips"]=0; window["subscribed"]=false; window["lapps"]={ authkey : 0 }; // initial data set for the chart var dataset = [ { id:1, rps:0, second:0 } ] // the chart webix.ui({ id:"barChart", container:"chart", view:"chart", type:"bar", value:"#rps#", label:"#rps#", radius:0, gradient:"rising", barWidth:40, tooltip:{ template:"#rps#" }, xAxis:{ title:"Ticking RPS", template:"#second#", lines: false }, padding:{ left:10, right:10, top:50 }, data: dataset }); // might be a dialog instead. never do this in production. var login = { lapps : 1, method: "login", params: [ { user : "admin", password : "admin" } ] }; // echo request var echo= { lapps : 1, method: "echo", params: [ { authkey : 0 }, [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25] ] }; // create a websocket var websocket = new WebSocket("wss://127.0.0.1:5083/echo_lapps"); websocket.binaryType = "arraybuffer"; // on response websocket.onmessage = function(event) { window.roundtrips=window.roundtrips+1; // CBOR to native JavaScript object var message = CBOR.decode(event.data); // Verifying the channel if(message.cid === 0) { if(message.status === 1) { if(window.lapps.authkey === 0) { if(typeof message.result[0].authkey !== "undefined") // authkey is arrived { window.lapps.authkey=message.result[0].authkey; echo.params[0].authkey = window.lapps.authkey; websocket.send(CBOR.encode(echo)); } else { console.log("No authkey: "+JSON.stringify(message)); } } else { websocket.send(CBOR.encode(echo)); // already authenticaed, may subscribe to OONs if(!window.subscribed) { var subscribe={ lapps : 1, method: "subscribe", params: [ { authkey: window.lapps.authkey } ], cid: 5 }; websocket.send(CBOR.encode(subscribe)); window.subscribed=true; } } } else { console.log("ERROR: "+JSON.stringify(message)); } } else if(message.cid === 5) // server time OON { console.log("OON is received"); webix.message({ text : message.message[0], type: "info", expire: 999 }); window.secs_since_start++; $$("barChart").add({rps: window.roundtrips, second: window.secs_since_start}); window.roundtrips=0; if(window.secs_since_start &gt; 30 ) { $$("barChart").remove($$("barChart").getFirstId()); } } else // other OONs are just printed to console { console.log("OON: "+JSON.stringify(message)); } }; // login on connection websocket.onopen=function() { console.log('is open'); window.teststart=Date.now()/1000; websocket.send(CBOR.encode(login)); } // close connection if peer sent close frame websocket.onclose=function() { console.log("is closed"); } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br><p>  The client application is an echo client for the LAppS protocol.  The server part of the application broadcasts once a second its time, the schedule is updated on this OON. </p><br><p>  Note: If several clients are launched in the browser, then the number of broadcasts will increase, because  Broadcast sent from onMessage, once a second. </p><br><p>  To fix this, you need to implement standalone applications that communicate with the rest of the LAppS stack.  This part is now in development. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/354882/">https://habr.com/ru/post/354882/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354872/index.html">Richard Hamming: Chapter 11. Coding Theory - II</a></li>
<li><a href="../354874/index.html">MIT course "Computer Systems Security". Lecture 1: Introduction: Threat Models, Part 1</a></li>
<li><a href="../354876/index.html">Swift for data scientist: quick dive in 2 hours</a></li>
<li><a href="../354878/index.html">Richard Hamming: Chapter 15. Digital Filters - 2</a></li>
<li><a href="../354880/index.html">Is it possible to consciously refuse functional programming?</a></li>
<li><a href="../354884/index.html">The city falls asleep, hackers wake up</a></li>
<li><a href="../354886/index.html">ReactiveValidation: data validation in WPF</a></li>
<li><a href="../354888/index.html">Practice implementing Cisco ISE. Engineer's look</a></li>
<li><a href="../354890/index.html">We optimize the web with Vitaly Friedman, - compression, images, fonts, HTTP / 2 features and Resource Hints</a></li>
<li><a href="../354892/index.html">Commenting code: good, bad, evil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>