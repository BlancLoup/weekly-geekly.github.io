<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple authentication on NGINX using LUA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. In this article I want to talk about simple authentication using nginx and lua-scripts. 

 Having picked up a home server on ubuntu with ple...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple authentication on NGINX using LUA</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/tt/_n/dr/tt_ndr7kcf87wkccjnetdie8gvi.jpeg" alt="image"><br>  Good day.  In this article I want to talk about simple authentication using nginx and lua-scripts. <br><a name="habracut"></a><br>  Having picked up a home server on ubuntu with plex and transmission and acquiring a domain through which I brought this good to the big world, I realized that it would be nice to get a single authentication point.  Moreover, I already had nginx installed (even nginx-extras, which is important, since lua is there). <br><br>  Gathering his thoughts, he formulated the requirements: <br><br><ul><li>  No need to install additional software </li><li>  Separate authentication page </li><li>  Pass-through authentication for all services for nginx </li><li>  At least minimal brute force protection </li></ul><br>  The variant with nginx did not suit basic auth due to the lack of brute-force protection; the variant with nginx auth PAM caused me to mistrust because of authentication by the OS login / password.  And both options do not allow authentication through its separate form. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The authentication algorithm is pretty simple: <br><img src="https://habrastorage.org/webt/7i/fz/ce/7ifzcegfqxv2gvmbmfyuooily2o.jpeg" alt="image"><br><br>  Well, let's get started. <br><br>  To begin, create a lua script with some functions that we will need in the future: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/lua/secure.lua</b> <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--    ip/32  User-Agent local ip_ua_max = 10 --    ip/32 local ip_4_max = 50 --    ip/16 local ip_3_max = 100 --    ip/8 local ip_2_max = 500 --    ip/0 local ip_1_max = 1000 counters = {} counters["ip_ua"] = {} counters["ip_4"] = {} counters["ip_3"] = {} counters["ip_2"] = {} counters["ip_1"] = {} --    (is_cnt=false)     (is_cnt=true) function is_secure(ip, user_agent, is_cnt) local md5_ip_ua = ngx.md5(ip..user_agent) local md5_ip_4 = ngx.md5(ip) local md5_ip_3 = "" local md5_ip_2 = "" local md5_ip_1 = "" local cnt = 0 for i in string.gmatch(ip, "%d+") do cnt = cnt + 1 if cnt &lt; 4 then md5_ip_3 = md5_ip_3.."."..i end if cnt &lt; 3 then md5_ip_2 = md5_ip_2.."."..i end if cnt &lt; 2 then md5_ip_1 = md5_ip_1.."."..i end end md5_ip_3 = ngx.md5(md5_ip_3) md5_ip_2 = ngx.md5(md5_ip_2) md5_ip_1 = ngx.md5(md5_ip_1) if is_cnt then --    counters["ip_ua"][md5_ip_ua] = (counters["ip_ua"][md5_ip_ua] or 0) + 1 counters["ip_4"][md5_ip_4] = (counters["ip_4"][md5_ip_4] or 0) + 1 counters["ip_3"][md5_ip_3] = (counters["ip_3"][md5_ip_3] or 0) + 1 counters["ip_2"][md5_ip_2] = (counters["ip_2"][md5_ip_2] or 0) + 1 counters["ip_1"][md5_ip_1] = (counters["ip_1"][md5_ip_1] or 0) + 1 --       log_file = io.open("/var/log/nginx/access.log", "a") log_file:write(ip.." "..(counters["ip_ua"][md5_ip_ua] or 0).." "..(counters["ip_4"][md5_ip_4] or 0).." "..(counters["ip_3"][md5_ip_3] or 0).." "..(counters["ip_2"][md5_ip_2] or 0).." "..(counters["ip_1"][md5_ip_1] or 0).." "..user_agent.."\n") log_file:close() else --     if (counters["ip_ua"][md5_ip_ua] or 0) &gt; ip_ua_max or (counters["ip_4"][md5_ip_4] or 0) &gt; ip_4_max or (counters["ip_3"][md5_ip_3] or 0) &gt; ip_3_max or (counters["ip_2"][md5_ip_2] or 0) &gt; ip_2_max or (counters["ip_1"][md5_ip_1] or 0) &gt; ip_1_max then return false else return true end end end --  / --         ,         /   (  ) function sing_in(log, pass) local auth_file = io.open("/etc/nginx/auth/pass","r") for line in io.lines("/etc/nginx/auth/pass") do if line == log..":"..ngx.md5(pass) then auth_file:close() return true end end auth_file:close() return false end --      secure local secure = ngx.shared.secure secure:set("sing_in", sing_in) secure:set("is_secure", is_secure)</span></span></code> </pre> <br></div></div><br>  Add initialization of this script to the global nginx config: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/nginx.conf</b> <div class="spoiler_text"><pre> <code class="nginx hljs">‚Ä¢ ‚Ä¢ ‚Ä¢ <span class="hljs-section"><span class="hljs-section">http</span></span> { ‚Ä¢ ‚Ä¢ ‚Ä¢ <span class="hljs-comment"><span class="hljs-comment">#    lua_shared_dict secure 10m; #   init_by_lua_file /etc/nginx/lua/secure.lua; ‚Ä¢ ‚Ä¢ ‚Ä¢ include /etc/nginx/conf.d/*.conf; }</span></span></code> </pre> <br></div></div><br>  Now we will create a lua script for checking the cookie (steps 2, 2.1, 3): <br><br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/lua/access.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--    local req_url_err = "https://auth.somedomain.ru" --  User-Agent   local ua = ngx.req.get_headers()["User-Agent"] --      cookie local auth_str = ngx.var.cookie_sv_auth local auth_token = "" local life_time = "" if auth_str ~= nil and auth_str:find("|") ~= nil then local divider = auth_str:find("|") auth_token = auth_str:sub(0,divider-1) life_time = auth_str:sub(divider+1) -- 2.    if auth_token == ngx.encode_base64(ngx.hmac_sha1("______-_32-_",ua.."|"..life_time)) and tonumber(life_time) &gt;= ngx.time() then --   return end end --      -- 2.1.   coockie url  ngx.header["Set-Cookie"] = "sv_req_url="..ngx.req.get_headers()["Host"].."; path=/; domain=.somedomain.ru; Expires="..ngx.cookie_time(ngx.time()+60*60).."; Secure; HttpOnly" --       return ngx.redirect(req_url_err)</span></span></code> </pre> <br></div></div><br>  Let's add a check with this script to the configs of internal services: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/conf.d/plex.conf</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> plex.somedomain.ru; <span class="hljs-attribute"><span class="hljs-attribute">access_by_lua_file</span></span> /etc/nginx/lua/access.lua; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://localhost:32400; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Upgrade <span class="hljs-variable"><span class="hljs-variable">$http_upgrade</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Connection <span class="hljs-variable"><span class="hljs-variable">$connection_upgrade</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">ssl</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; ‚Ä¢ ‚Ä¢ ‚Ä¢ }</code> </pre> <br></div></div><br>  Create an authentication page: <br><br><div class="spoiler">  <b class="spoiler_title">/var/www/html/auth.html</b> <div class="spoiler_text"><pre> <code class="hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE HTML&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>somedomain<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width=device-width, initial-scale=1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">body</span></span></span><span class="css">{ </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100%</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background-color</span></span></span><span class="css">: </span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">rgb</span></span></span><span class="css">(64, 64, 64); </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">text-align</span></span></span><span class="css">:center; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">align</span></span></span><span class="css">:center; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">vertical-align</span></span></span><span class="css">: middle; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">form</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">display</span></span></span><span class="css">: inline-block; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">text-align</span></span></span><span class="css">: center; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">vertical-align</span></span></span><span class="css">: middle; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">position</span></span></span><span class="css">:absolute; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">top</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">50%</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">right</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">left</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">input</span></span></span><span class="css">{ </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">color</span></span></span><span class="css">: </span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">rgb</span></span></span><span class="css">(0, 255, 0); </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">text-align</span></span></span><span class="css">: center; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">2px</span></span></span><span class="css"> solid; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-color</span></span></span><span class="css">: </span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">rgb</span></span></span><span class="css">(0, 255, 0); </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background-color</span></span></span><span class="css">: </span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">rgb</span></span></span><span class="css">(64, 64, 64); } </span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">::-webkit-input-placeholder</span></span></span><span class="css">{ </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">color</span></span></span><span class="css">:</span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">rgb</span></span></span><span class="css">(0, 255, 0); </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">text-align</span></span></span><span class="css">: center; } </span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">::-moz-placeholder</span></span></span><span class="css">{ </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">color</span></span></span><span class="css">:</span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">rgb</span></span></span><span class="css">(0, 255, 0); </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">text-align</span></span></span><span class="css">: center; } </span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:-moz-placeholder</span></span></span><span class="css">{ </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">color</span></span></span><span class="css">:</span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">rgb</span></span></span><span class="css">(0, 255, 0); </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">text-align</span></span></span><span class="css">: center; } </span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:-ms-input-placeholder</span></span></span><span class="css">{ </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">color</span></span></span><span class="css">:</span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">rgb</span></span></span><span class="css">(0, 255, 0); </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">text-align</span></span></span><span class="css">: center; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">br</span></span></span><span class="css">{ </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">display</span></span></span><span class="css">: block; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">7px</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">line-height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">7px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">content</span></span></span><span class="css">: </span><span class="hljs-string"><span class="css"><span class="hljs-string">" "</span></span></span><span class="css">; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"login"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"login"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">autocomplete</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"off"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">autocomplete</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"off"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sign in"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  And add the nginx config for it: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/conf.d/auth.conf</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> auth.somedomain.ru; <span class="hljs-attribute"><span class="hljs-attribute">access_by_lua_file</span></span> /etc/nginx/lua/auth_access.lua; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/html/; <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> auth.html; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$request_method</span></span> = POST ) { <span class="hljs-attribute"><span class="hljs-attribute">content_by_lua_file</span></span> /etc/nginx/lua/auth.lua; } } <span class="hljs-attribute"><span class="hljs-attribute">ssl</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; ‚Ä¢ ‚Ä¢ ‚Ä¢ }</code> </pre><br></div></div><br>  In this config, we check the number of authentication attempts using ‚Äúauth_access.lua‚Äù (step 4, 4.2) <br><br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/lua/auth_access.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--     secure    local secure = ngx.shared.secure is_secure = secure:get("is_secure") --  ip   local ip = ngx.var.remote_addr --  User-Agent   local ua = ngx.req.get_headers()["User-Agent"] -- 4.     if is_secure(ip,ua,false) then --  ,    ngx.header["Set-Cookie"] = {"sv_auth=; path=/; domain=.somedomain.ru; Expires="..ngx.cookie_time(ngx.time()-60).."; Secure; HttpOnly"} return end -- 4.2.   ,  HTTP 403 ngx.exit(ngx.HTTP_FORBIDDEN)</span></span></code> </pre> <br></div></div><br>  And verification of login / password using "auth.lua" (step 5, 5.1, 2.2) <br><br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/lua/auth.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--     secure    local secure = ngx.shared.secure sing_in = secure:get("sing_in") is_secure = secure:get("is_secure") --  ip   local ip = ngx.var.remote_addr --  User-Agent   local ua = ngx.req.get_headers()["User-Agent"] --    local req_url_err = "https://auth.somedomain.ru" --    cookie   ,   cookie   local req_url = "https://"..(ngx.var.cookie_sv_req_url or "somedomain.ru") --    POST- ngx.req.read_body() local args, err = ngx.req.get_post_args() if args then -- 4.1.   POST-    local log local pass for key, val in pairs(args) do if key == "login" then log = val elseif key == "password" then pass = val end end -- ,       if log ~= nil and pass ~= nil then -- 5.       if sing_in(log, pass) then --   --     () local life_time = ngx.time()+86400 --   local auth_str = ngx.encode_base64(ngx.hmac_sha1("______-_32-_",ua.."|"..life_time)).."|"..life_time -- 5.1.    cookie    url  ngx.header["Set-Cookie"] = {"sv_auth="..auth_str.."; path=/; domain=.somedomain.ru; Expires="..ngx.cookie_time(ngx.time()+60*60*24).."; Secure; HttpOnly","sv_req_url="..ngx.req.get_headers()["Host"].."; path=/; domain=.somedomain.ru; Expires="..ngx.cookie_time(ngx.time()-60).."; Secure; HttpOnly"} -- 2.2.      return ngx.redirect(req_url) end -- 5.2.  / ,        is_secure(ip,ua,true) end end -- 3.        ,      ngx.redirect(req_url_err)</span></span></code> </pre> <br></div></div><br>  Now we will create a file with login and password: <br><br><pre> <code class="bash hljs">md5=<span class="hljs-string"><span class="hljs-string">"`echo -n "</span></span>PASSWORD<span class="hljs-string"><span class="hljs-string">" | md5sum`"</span></span>;<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">"LOGIN"</span></span><span class="hljs-string"><span class="hljs-string">":`sed 's/^\([^ ]\+\) .*$/\1/' &lt;&lt;&lt; "</span></span><span class="hljs-variable"><span class="hljs-variable">$md5</span></span><span class="hljs-string"><span class="hljs-string">"`"</span></span> &gt; ~/pass; sudo mv ~/pass /etc/nginx/auth/pass; sudo chown nginx:nginx /etc/nginx/auth/pass</code> </pre> <br>  Substituting the login instead of LOGIN, and the password instead of PASSWORD. <br><br>  That's it, authentication is implemented. <br><br>  When adding services, it will suffice to specify in the configs the check for ‚Äúaccess.lua‚Äù: <br><br><pre> <code class="lua hljs">access_by_lua_file /etc/nginx/lua/access.lua;</code> </pre> <br>  Thanks for attention. <br><br>  UPD <a href="https://habrahabr.ru/users/yourchief/" class="user_link">03/26/2018</a> (thanks to <a href="https://habrahabr.ru/users/yourchief/" class="user_link">YourChief</a> ): <br>  - Removed the function nvl, as unnecessary <br>  - md5 replaced by HMAC during token generation <br>  - Token added the time of his life <br>  - md5 and HMAC are used built into nginx </div><p>Source: <a href="https://habr.com/ru/post/351904/">https://habr.com/ru/post/351904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351890/index.html">REST API Best Practices</a></li>
<li><a href="../351894/index.html">Spread S3 Buckets across different pools in Ceph Luminous</a></li>
<li><a href="../351896/index.html">Issue # 15: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../351898/index.html">Hackathon and game jam in Yekaterinburg</a></li>
<li><a href="../351900/index.html">Flask Mega-Tutorial, Part XVI: Full-Text Search</a></li>
<li><a href="../351906/index.html">JavaScript compiler using ANTLR</a></li>
<li><a href="../351908/index.html">Cisco ASA: Patched Firewall Critical Vulnerability</a></li>
<li><a href="../351910/index.html">Monster of advanced threats and targeted attacks.</a></li>
<li><a href="../351912/index.html">Gartner Data & Analytics Summit 2018</a></li>
<li><a href="../351914/index.html">Marvin Minsky "The Emotion Machine": Chapter 2 "Impressors"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>