<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asternic CDR Reports. Listening to calls in FreePBX with access restrictions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Software Versions 
 FreePBX 2.11.0.41 
 Asternic CDR Reports 1.5.1 

 Introduction 
 Task: it is necessary to give a person the opportunity to listen ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asternic CDR Reports. Listening to calls in FreePBX with access restrictions</h1><div class="post__text post__text-html js-mediator-article"><h4>  Software Versions </h4><br>  FreePBX 2.11.0.41 <br>  Asternic CDR Reports 1.5.1 <br><br><h4>  Introduction </h4><br>  Task: it is necessary to give a person the opportunity to listen to recordings of conversations, but strictly on a certain range of internal extensions.  We are trying to create a new administrator and even assign the Extension Range to it, hoping in this way to give him limited access to listening. <br><br><img src="https://habrastorage.org/files/789/a11/cbb/789a11cbbbe0484fa7d978d807937dde.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But then, going under the created account and going to the call reports, we understand that it was a fiasco - CDR Reports ignores the specified Extension Range and displays information on all numbers. <br><a name="habracut"></a><br>  Scratching the back of the head, we are looking for an alternative module of reports - and, lo and behold, we find it: Asternic CDR Reports.  It is wonderful and works only with those numbers whose range is limited for the authorized administrator. <br><br><img src="https://habrastorage.org/files/0d9/547/627/0d95476275804099815c3d5b192eba86.png"><br><br>  But what is it?  No listening to calls?  Does the Listen column show voice mail?  No, that won't do ... <br><br><h4>  Fix </h4><br>  Information on calls to Asterisk is stored in Mysql in the ‚Äúasteriskcdrdb‚Äù database, table cdr.  This is evident from the following code taken from the page.cdr.php file of the regular CDR Reports <br><br><pre><code class="php hljs">$resultscdr = $dbcdr-&gt;getAll($query, DB_FETCHMODE_ASSOC); ... <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($resultscdr <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) ...       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($row[<span class="hljs-string"><span class="hljs-string">'recordingfile'</span></span>]) {          $rec_parts = explode(<span class="hljs-string"><span class="hljs-string">'-'</span></span>,$row[<span class="hljs-string"><span class="hljs-string">'recordingfile'</span></span>]);          $fyear = substr($rec_parts[<span class="hljs-number"><span class="hljs-number">3</span></span>],<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>);          $fmonth = substr($rec_parts[<span class="hljs-number"><span class="hljs-number">3</span></span>],<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>);          $fday = substr($rec_parts[<span class="hljs-number"><span class="hljs-number">3</span></span>],<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>);          $monitor_base = $amp_conf[<span class="hljs-string"><span class="hljs-string">'MIXMON_DIR'</span></span>] ? $amp_conf[<span class="hljs-string"><span class="hljs-string">'MIXMON_DIR'</span></span>] : $amp_conf[<span class="hljs-string"><span class="hljs-string">'ASTSPOOLDIR'</span></span>] . <span class="hljs-string"><span class="hljs-string">'/monitor'</span></span>;          $recordingfile = <span class="hljs-string"><span class="hljs-string">"$monitor_base/$fyear/$fmonth/$fday/"</span></span> . $row[<span class="hljs-string"><span class="hljs-string">'recordingfile'</span></span>];          <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists($recordingfile)) {             $recordingfile = <span class="hljs-string"><span class="hljs-string">''</span></span>;          }       } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {          $recordingfile = <span class="hljs-string"><span class="hljs-string">''</span></span>;       }</code> </pre> <br>  So, all we need is to read the value of the recordingfile cell where the string ‚Äúfilename.wav‚Äù is stored and add the full path to this file to it, which is taken, by the way, from the very name of the file (year, month, day). <br><br>  Open the file /var/www/html/admin/modules/asternic_cdr/functions.inc.php module Asternic. <br><br>  Looking for line 154 <br><br><pre> <code class="php hljs">$query.= <span class="hljs-string"><span class="hljs-string">"billsec,duration,duration-billsec as ringtime,src,"</span></span>;</code> </pre><br>  and replace with <br><br><pre> <code class="php hljs">$query.= <span class="hljs-string"><span class="hljs-string">"billsec,duration,duration-billsec as ringtime,src,recordingfile,"</span></span>;</code> </pre><br>  So in the query to the database, we added the field recordingfile, the value of which, respectively, will now be in the resulting array, from which we will take it later to form a link to the file. <br><br>  Looking for line 208 <br><br><pre> <code class="php hljs">$detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].= <span class="hljs-string"><span class="hljs-string">"\n&lt;td&gt;"</span></span>; $uni = $row[<span class="hljs-string"><span class="hljs-string">'uniqueid'</span></span>]; $uni = str_replace(<span class="hljs-string"><span class="hljs-string">"."</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,$uni); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($row[<span class="hljs-string"><span class="hljs-string">'userfield'</span></span>]&lt;&gt;<span class="hljs-string"><span class="hljs-string">""</span></span>) { $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].=<span class="hljs-string"><span class="hljs-string">"&lt;a href=\"javascript:void(0);\" onclick='javascript:playVmail(\""</span></span>.$row[<span class="hljs-string"><span class="hljs-string">'userfield'</span></span>].<span class="hljs-string"><span class="hljs-string">"\",\"play"</span></span>.$uni.<span class="hljs-string"><span class="hljs-string">"\");'&gt;"</span></span>; $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].=<span class="hljs-string"><span class="hljs-string">"&lt;div class='playicon' title='Play' id='play"</span></span>.$uni.<span class="hljs-string"><span class="hljs-string">"' style='float:left;'&gt;"</span></span>; $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].=<span class="hljs-string"><span class="hljs-string">"&lt;img src='images/blank.gif' alt='pixel' height='16' width='16' border='0'&gt;"</span></span>; $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].=<span class="hljs-string"><span class="hljs-string">"&lt;/div&gt;&lt;/a&gt;"</span></span>; $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].=<span class="hljs-string"><span class="hljs-string">"&lt;a href=\"javascript:void(0); return false;\" onclick='javascript:downloadVmail(\""</span></span>.$row[<span class="hljs-string"><span class="hljs-string">'userfield'</span></span>].<span class="hljs-string"><span class="hljs-string">"\",\"play"</span></span>.$uni.<span class="hljs-string"><span class="hljs-string">"\",\"$ftype\",\"$fdisplay\",\"$ftab\"); return false;'&gt;"</span></span>; $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].=<span class="hljs-string"><span class="hljs-string">"&lt;div class='downicon' title='Download' id='dload"</span></span>.$uni.<span class="hljs-string"><span class="hljs-string">"' style='float:left;'&gt;"</span></span>; $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].=<span class="hljs-string"><span class="hljs-string">"&lt;img src='images/blank.gif' alt='pixel' height='16' width='16' border='0'&gt;"</span></span>; $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].=<span class="hljs-string"><span class="hljs-string">"&lt;/div&gt;&lt;/a&gt;"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].= <span class="hljs-string"><span class="hljs-string">" "</span></span>; } $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].= <span class="hljs-string"><span class="hljs-string">"&lt;/td&gt;\n"</span></span>;</code> </pre><br><br>  replace with <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($row[<span class="hljs-string"><span class="hljs-string">'recordingfile'</span></span>]) {         $rec_parts = explode(<span class="hljs-string"><span class="hljs-string">'-'</span></span>,$row[<span class="hljs-string"><span class="hljs-string">'recordingfile'</span></span>]);         $fyear = substr($rec_parts[<span class="hljs-number"><span class="hljs-number">3</span></span>],<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>);         $fmonth = substr($rec_parts[<span class="hljs-number"><span class="hljs-number">3</span></span>],<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>);         $fday = substr($rec_parts[<span class="hljs-number"><span class="hljs-number">3</span></span>],<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>);         $monitor_base = $amp_conf[<span class="hljs-string"><span class="hljs-string">'MIXMON_DIR'</span></span>] ? $amp_conf[<span class="hljs-string"><span class="hljs-string">'MIXMON_DIR'</span></span>] : $amp_conf[<span class="hljs-string"><span class="hljs-string">'ASTSPOOLDIR'</span></span>] . <span class="hljs-string"><span class="hljs-string">'/monitor'</span></span>;         $recordingfile = <span class="hljs-string"><span class="hljs-string">"$monitor_base/$fyear/$fmonth/$fday/"</span></span> . $row[<span class="hljs-string"><span class="hljs-string">'recordingfile'</span></span>];         <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists($recordingfile)) {            $recordingfile = <span class="hljs-string"><span class="hljs-string">''</span></span>;            $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].= <span class="hljs-string"><span class="hljs-string">"\n&lt;td&gt;"</span></span>;         }         <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {         $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].= <span class="hljs-string"><span class="hljs-string">"\n&lt;td style='text-align: center;' title=\"$row[recordingfile]\"&gt;&lt;a href=\""</span></span>.$PHP_SELF.<span class="hljs-string"><span class="hljs-string">"?getRec="</span></span>.base64_encode($recordingfile).<span class="hljs-string"><span class="hljs-string">"\" target=\"_blank\"&gt;&lt;img src=\"images/asternic_playicon.png\" alt=\"Call recording\" /&gt;&lt;/a&gt;"</span></span>;         }      } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {         $recordingfile = <span class="hljs-string"><span class="hljs-string">''</span></span>;         $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].= <span class="hljs-string"><span class="hljs-string">"\n&lt;td&gt;"</span></span>;      }         $detail[$row[<span class="hljs-string"><span class="hljs-string">'chan1'</span></span>]].= <span class="hljs-string"><span class="hljs-string">"&lt;/td&gt;\n"</span></span>;</code> </pre><br>  Thus, in the table cell, instead of outputting voice mail, we checked for the recording of this call and, if found, output a small Play icon with a link encoded in base64 to the audio recording file itself. <br><br><img src="https://habrastorage.org/files/089/aa6/bf0/089aa6bf04c74c678664b976fc340793.png"><br><br>  The attentive reader noticed that in the link being formed there is a GET request variable called getRec.  Since the web server does not have access to the directory with audio recordings, we give the file via php, and for this at the end of the functions.inc.php file we check for the getRec variable, in the case of which we refer to the function giving the file <br><br>  Add the code to the very end of the file, up to, of course, the closing php-tag "?&gt;" <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">recordfile_uri</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($path)</span></span></span><span class="hljs-function"> </span></span>{   $size = filesize($path);   $name = basename($path);   $extension = strtolower(substr(strrchr($name,<span class="hljs-string"><span class="hljs-string">"."</span></span>),<span class="hljs-number"><span class="hljs-number">1</span></span>));   <span class="hljs-comment"><span class="hljs-comment">// This will set the Content-Type to the appropriate setting for the file   $ctype ='';   switch( $extension ) {      case "WAV":         $ctype="audio/x-wav";         break;      case "wav":         $ctype="audio/x-wav";         break;      case "ulaw":         $ctype="audio/basic";         break;      case "alaw":         $ctype="audio/x-alaw-basic";         break;      case "sln":         $ctype="audio/x-wav";         break;      case "gsm":         $ctype="audio/x-gsm";         break;      case "g729":         $ctype="audio/x-g729";         break;      default: //not downloadable         // echo ("&lt;b&gt;404 File not found! foo&lt;/b&gt;");         // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> what to do if none of the above work?      break ;   } $fp=fopen($path, "rb"); if ($size &amp;&amp; $ctype &amp;&amp; $fp) {   header("Pragma: public");   header("Expires: 0");   header("Cache-Control: must-revalidate, post-check=0, pre-check=0");   header("Cache-Control: public");   header("Content-Description: audio file");   header("Content-Type: " . $ctype);   header("Content-Disposition: attachment; filename=" . $name);   header("Content-Transfer-Encoding: binary");   header("Content-length: " . $size);   $chunksize = 1*(1024*1024);   while (!feof($fp)) {       $buffer = fread($fp, $chunksize);       echo $buffer;       ob_flush();       flush();   }   fclose($fp); } } if(isset($_GET['getRec'])){   recordfile_uri(base64_decode($_GET['getRec']));   die(); }</span></span></code> </pre><br><br><h4>  Done! </h4><br>  Everyone is happy and happy - because now you can easily download the recording of the conversation and listen to it locally in the audio player. </div><p>Source: <a href="https://habr.com/ru/post/244321/">https://habr.com/ru/post/244321/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244309/index.html">The benefits and harm of deadlines in programming</a></li>
<li><a href="../244311/index.html">Collect the best of two worlds - frameworks and CMS (part 1)</a></li>
<li><a href="../244315/index.html">Connect ("Russia") seminars in Moscow - for those who want to understand what has happened over the past couple of months in the Microsoft ecosystem</a></li>
<li><a href="../244317/index.html">Useful and pleasant for the developer in Mojolicious</a></li>
<li><a href="../244319/index.html">Modeling an object as a whole and as a composition</a></li>
<li><a href="../244325/index.html">10 languages ‚Äã‚Äãinto which to translate your mobile game</a></li>
<li><a href="../244327/index.html">Southernmost data center</a></li>
<li><a href="../244329/index.html">Arachnidium self-made framework for testing web and mobile applications. Part 2. A bit about the settings</a></li>
<li><a href="../244331/index.html">Is there a future for bid managers in contextual advertising?</a></li>
<li><a href="../244337/index.html">Validation and verification of system requirements</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>