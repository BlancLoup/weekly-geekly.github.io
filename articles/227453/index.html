<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to find out the real version of Windows from compatibility mode</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think everyone at least once faced with a situation where it was not possible to run the old program on a modern OS, and in this case Windows compat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to find out the real version of Windows from compatibility mode</h1><div class="post__text post__text-html js-mediator-article">  I think everyone at least once faced with a situation where it was not possible to run the old program on a modern OS, and in this case Windows compatibility mode helped. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e5d/9b2/681/e5d9b2681959c92ed6d83a9b7451bc1a.png"><br><br>  At the heart of this mechanism is the interception of various functions and emulation of their behavior inherent in the specified version of Windows, for example, emulated registry keys, directories of documents and stuff.  All this is necessary in order for the program to think that it is running in the chosen environment. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If the application is running in compatibility mode, the call to GetVersionEx will return a dummy version of Windows, which is probably not suitable for system programs such as OS tweakers.  How to be in this case? <br><a name="habracut"></a><br><h4>  Analysis of exported functions </h4><br>  In the open spaces of the network, I came across a detection method based on the presence / absence of exported functions in system libraries.  Code example: <br><pre><code class="delphi hljs">TDSiWindowsVersion = (wvUnknown, wvWin31, wvWin95, wvWin95OSR2, wvWin98, wvWin98SE, wvWinME, wvWin9x, wvWinNT3, wvWinNT4, wvWin2000, wvWinXP, wvWinNT, wvWinServer2003, wvWinVista); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DSiGetTrueWindowsVersion</span></span></span><span class="hljs-function">:</span></span> TDSiWindowsVersion; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExportsAPI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(module: HMODULE; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> apiName: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> boolean; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := GetProcAddress(module, PChar(apiName)) &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-comment"><span class="hljs-comment">{ ExportsAPI }</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hKernel32: HMODULE; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-comment"><span class="hljs-comment">{ DSiGetTrueWindowsVersion }</span></span> hKernel32 := GetModuleHandle(<span class="hljs-string"><span class="hljs-string">'kernel32'</span></span>); Win32Check(hKernel32 &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ExportsAPI(hKernel32, <span class="hljs-string"><span class="hljs-string">'GetLocaleInfoEx'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Result := wvWinVista <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ExportsAPI(hKernel32, <span class="hljs-string"><span class="hljs-string">'GetLargePageMinimum'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Result := wvWinServer2003 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ExportsAPI(hKernel32, <span class="hljs-string"><span class="hljs-string">'GetNativeSystemInfo'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Result := wvWinXP <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ExportsAPI(hKernel32, <span class="hljs-string"><span class="hljs-string">'ReplaceFile'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Result := wvWin2000 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ExportsAPI(hKernel32, <span class="hljs-string"><span class="hljs-string">'OpenThread'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Result := wvWinME <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ExportsAPI(hKernel32, <span class="hljs-string"><span class="hljs-string">'GetThreadPriorityBoost'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Result := wvWinNT4 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ExportsAPI(hKernel32, <span class="hljs-string"><span class="hljs-string">'IsDebuggerPresent'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">//is also in NT4! Result := wvWin98 else if ExportsAPI(hKernel32, 'GetDiskFreeSpaceEx') then //is also in NT4! Result := wvWin95OSR2 else if ExportsAPI(hKernel32, 'ConnectNamedPipe') then Result := wvWinNT3 else if ExportsAPI(hKernel32, 'Beep') then Result := wvWin95 else // we have no idea Result := DSiGetWindowsVersion; end; { DSiGetTrueWindowsVersion }</span></span></code> </pre> <br><br>  The solution is interesting, but I do not consider it acceptable, since with the release of each version of Windows, nontrivial support is required. <br><br><h4>  Using WMI </h4><br>  From <a href="http://ru.wikipedia.org/wiki/WMI">wikipedia</a> <br><blockquote>  The literal translation of Windows Management Instrumentation (WMI) is a Windows management toolkit.  More generally, WMI is one of the core technologies for centralized management and monitoring of various parts of the computer infrastructure running on the Windows platform. <br></blockquote><br>  Windows version can also be obtained from WMI.  From the documentation it follows that this can be done by such a request: <br><br> <code>SELECT Version FROM Win32_OperatingSystem</code> <br> <br>  By running <a href="http://www.ks-soft.net/hostmon.eng/wmi/">WMI Explorer</a> in compatibility mode for Windows XP, you can see that this value is not emulated: <br><img src="https://habrastorage.org/getpro/habr/post_images/e83/9da/865/e839da865c156eb1ddff260b624b8c3e.png"><br><br>  The method works, moreover, it is fully documented, but slow, and requires a lot of code to work with WMI into the project. <br><br><h4>  We are looking in the registry </h4><br>  Perhaps the most elegant and correct way found on the net is to look at the value in the registry: <br> <code>HLKM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\CurrentVersion</code> <br>  Well, let's try: <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> TRegistry.Create <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> RootKey := HKEY_LOCAL_MACHINE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> OpenKeyReadOnly(<span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\Windows NT\CurrentVersion'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Edit1.Text := ReadString(<span class="hljs-string"><span class="hljs-string">'CurrentVersion'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Unfortunately, checking it on Windows 7 turned out that this registry key is emulated.  It seems that in previous versions of Windows this method worked, but, alas, <b>now this trick will not work</b> . <br><br><h4>  Analysis of kernel32.dll version </h4><br>  I did not check it myself, but they say that the file version of kernel32.dll coincides with the version of Windows.  On my Windows 7 computer, it‚Äôs like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/0c4/87c/6c0/0c487c6c00bc33108a4b6451a1f3bd45.png"><br>  It is a good way, but for me, for unknown reasons, I don‚Äôt like it, since there is still an alternative. <br><br><h4>  Analyzing the PEB process </h4><br>  Each Windows process has a structure describing it, it is called PEB.  It is filled at the start of the process and contains the download address, the list of loaded modules, command line parameters, and, in particular, the Windows version.  Below is an example of a module, using which you can get a real version of Windows (tested on Delphi 2010 Win32): <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">unit</span></span> RealWindowsVerUnit; <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> Windows; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-comment"><span class="hljs-comment">//  ,         //   Win32MajorVersionReal: Integer; Win32MinorVersionReal: Integer; implementation type PPEB=^PEB; PEB = record InheritedAddressSpace: Boolean; ReadImageFileExecOptions: Boolean; BeingDebugged: Boolean; Spare: Boolean; Mutant: Cardinal; ImageBaseAddress: Pointer; LoaderData: Pointer; ProcessParameters: Pointer; //PRTL_USER_PROCESS_PARAMETERS; SubSystemData: Pointer; ProcessHeap: Pointer; FastPebLock: Pointer; FastPebLockRoutine: Pointer; FastPebUnlockRoutine: Pointer; EnvironmentUpdateCount: Cardinal; KernelCallbackTable: PPointer; EventLogSection: Pointer; EventLog: Pointer; FreeList: Pointer; //PPEB_FREE_BLOCK; TlsExpansionCounter: Cardinal; TlsBitmap: Pointer; TlsBitmapBits: array[0..1] of Cardinal; ReadOnlySharedMemoryBase: Pointer; ReadOnlySharedMemoryHeap: Pointer; ReadOnlyStaticServerData: PPointer; AnsiCodePageData: Pointer; OemCodePageData: Pointer; UnicodeCaseTableData: Pointer; NumberOfProcessors: Cardinal; NtGlobalFlag: Cardinal; Spare2: array[0..3] of Byte; CriticalSectionTimeout: LARGE_INTEGER; HeapSegmentReserve: Cardinal; HeapSegmentCommit: Cardinal; HeapDeCommitTotalFreeThreshold: Cardinal; HeapDeCommitFreeBlockThreshold: Cardinal; NumberOfHeaps: Cardinal; MaximumNumberOfHeaps: Cardinal; ProcessHeaps: Pointer; GdiSharedHandleTable: Pointer; ProcessStarterHelper: Pointer; GdiDCAttributeList: Pointer; LoaderLock: Pointer; OSMajorVersion: Cardinal; OSMinorVersion: Cardinal; OSBuildNumber: Cardinal; OSPlatformId: Cardinal; ImageSubSystem: Cardinal; ImageSubSystemMajorVersion: Cardinal; ImageSubSystemMinorVersion: Cardinal; GdiHandleBuffer: array [0..33] of Cardinal; PostProcessInitRoutine: Cardinal; TlsExpansionBitmap: Cardinal; TlsExpansionBitmapBits: array [0..127] of Byte; SessionId: Cardinal; end; //  PEB   function GetPDB: PPEB; stdcall; asm MOV EAX, DWORD PTR FS:[30h] end; initialization //    Win32MajorVersionReal := GetPDB^.OSMajorVersion; Win32MinorVersionReal := GetPDB^.OSMinorVersion; end.</span></span></code> </pre><br><br>  The speed of work is immediate, nothing superfluous, the only BUT is the undocumented PEB structure, but as you know, Microsoft is very concerned about backward compatibility, so with a large degree of optimism we can assume that since the structure description has been browsing the Internet for a long time, then Microsoft already considers it documented. <br><br><h4>  findings </h4><br>  And the conclusions are simple, if you really need to get the real version, then WMI is a great option, if you need a lightweight solution - see PEB. </div><p>Source: <a href="https://habr.com/ru/post/227453/">https://habr.com/ru/post/227453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../227443/index.html">How to buy a Linux VPS server</a></li>
<li><a href="../227445/index.html">Navio - autopilot card for the Raspberry Pi</a></li>
<li><a href="../227447/index.html">Continuing Amateur</a></li>
<li><a href="../227449/index.html">Who could tell me how to require to connect</a></li>
<li><a href="../227451/index.html">A year long crash, or an Android game development experience</a></li>
<li><a href="../227455/index.html">Useful code implementation</a></li>
<li><a href="../227459/index.html">Russian stage of the World Olympics Robots - we did it!</a></li>
<li><a href="../227467/index.html">Stories that have taught us a lot: the results of habrakrakursa</a></li>
<li><a href="../227471/index.html">Russian physicists have discovered two types of dust in the atmosphere of Mars.</a></li>
<li><a href="../227473/index.html">DIY Epilepsy Attack Detector</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>