<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android screen stabilization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Did you try to read a book or an article like this on a bus or walking down the street? I tried to argue! In this case, you should have noticed that r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android screen stabilization</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/bdd/e6f/34d/bdde6f34d15f08142b6b1a653c0d9ad6.jpg" alt="image"><br><br>  Did you try to read a book or an article like this on a bus or walking down the street?  I tried to argue!  In this case, you should have noticed that reading the text in this way is not the best idea because of the constant shaking.  It seems that shaking the screen is quite a serious problem and eliminating it can give a very good improvement in UX.  My idea is to use acceleration sensors to compensate for shaking as well as <a href="https://www.youtube.com/watch%3Fv%3DlMyp5QfTb0U">SLR cameras</a> stabilize the sensor or lenses.  Technically, this is possible so why not try it yourself! <br><a name="habracut"></a><br><h3>  Existing solutions </h3><br>  First, let's look at existing solutions.  There are several interesting articles on the web on the same subject. <br><br><ol><li>  <a href="http://www.ahmad.rahmati.com/papers/09.PerCom.NoShake.pdf">NoShake: Content Stabilization for Shaking Screens of Mobile Devices</a> by Lin Zhong, Ahmad Rahmati and Clayton Shepard on iPhone Screen Stabilization (3) published in 2009. The article sums up that screen stabilization works and gives noticeable results, but the algorithm consumes ‚Äúan average of 30 % power at 620 MHz ARM processor ‚Äù.  This makes this implementation impractical for real use.  And although modern iPhones can easily cope with this task, the authors did not provide either the source code or the assembled application so that you can try it in action. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </li><li>  <a href="">Walking with your Smartphone: Stabilizing Screen Content</a> by Kevin Jeisy.  This article was published in 2014 and has a good mathematical justification.  The article sums up that ‚Äúusing the hidden Markov model we got a good stabilization in theory‚Äù.  Unfortunately, neither source codes, nor the assembled application are provided, so it will not work. <br><br></li><li>  <a href="http://build18.ece.cmu.edu/wiki/index.php/Shake-Free_Screen">Shake-Free Screen</a> .  The same question is being investigated, but there are no ready-made results to try. </li></ol><br>  These articles give a good explanation of the topic of our article, but unfortunately they do not give either source codes or compiled applications to look at it live.  Let's try to reinvent the wheel and realize the stabilization of the screen in its own way. <br><br><h3>  Theory </h3><br>  The acceleration sensor can be used to determine the movement of the device.  But judging by the name of this sensor is still designed to determine the acceleration.  To answer the question "how to determine the movement with acceleration," let's look at the device with sensors: <br><img src="https://habrastorage.org/getpro/habr/post_images/72e/0b2/f99/72e0b2f994525a0cc31c42696b6e65cc.png" alt="image"><br>  As you can see there are three axes, respectively, the sensor gives three values ‚Äã‚Äãat the output.  Technically, the sensor consists of three sensors located along different axes, but let's take it as a whole. <br><br>  Three output values ‚Äã‚Äãindicate acceleration along the corresponding axis: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/84c/63e/7b8/84c63e7b85267275ea4e42b1619f42f9.png" alt="image"><br><br>  Acceleration is measured in ‚Äúm / s2‚Äù.  As you can see there is some acceleration along the Y axis. In fact, this is the <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D1%2581%25D0%25BA%25D0%25BE%25D1%2580%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D1%2581%25D0%25B2%25D0%25BE%25D0%25B1%25D0%25BE%25D0%25B4%25D0%25BD%25D0%25BE%25D0%25B3%25D0%25BE_%25D0%25BF%25D0%25B0%25D0%25B4%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F">acceleration of gravity</a> and any rotation of the device will change all three values: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/883/04f/f6e/88304ff6e8023aab4cb39c7e666c081d.png" alt="image"><br><br>  You can imagine it as a ball tied to a device with a rope.  This is a pretty good explanation because if you replace the ball with an arrow, you get an acceleration vector. <br><br><h4>  OK, but what about the definition of displacement? </h4><br>  I cannot show some illustrative example, but if you move the device a little, the vector will change: in fact, it will consist of two vectors: 1) the vector of gravity as before;  2) the acceleration vector of the device due to movement along the respective axes.  The most interesting thing for us is the ‚Äúpure‚Äù displacement vector.  It is easy enough to get it by subtracting the vector of gravity from the resulting vector, but how to determine the true vector of gravity?  This task can be solved in different ways, but fortunately, Android has a special <a href="https://developer.android.com/guide/topics/sensors/sensors_motion.html">linear acceleration sensor</a> that does exactly what we need.  Under normal conditions, the output values ‚Äã‚Äãare at sensor 0, and only by moving the device you can get non-zero values.  <a href="">Here is</a> its source code if interested.  We are one step closer to determining the movement of a device.  Let's start programming something. <br><br><h3>  Implementation </h3><br>  To find out how to calculate the movement of a device, let's develop one simple application with one activation.  This application will monitor the change in acceleration and move the special view item accordingly.  It will also show raw acceleration values ‚Äã‚Äãon a graph: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c96/51a/6ca/c9651a6ca46974699e11ae0ea4323db0.png" alt="image"><br><br>  I will show only key code examples.  Completely all the code is in the GIT repository.  The key things are: <br><br><h4>  1. A special element that we will move.  This is a blue block with text inside the container: </h4><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FrameLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_above</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@id/graph1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:background</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@drawable/dots_repeat_bg"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:clipChildren</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LinearLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/layout_sensor"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"20dp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vertical"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:background</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#5050FF"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ImageView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/img_test"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@mipmap/ic_launcher"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/txt_test"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_below</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@id/img_test"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:textSize</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"15sp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/test"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LinearLayout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FrameLayout</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  To move the layout_sensor, we will use the <a href="https://developer.android.com/reference/android/view/View.html">View.setTranslationX</a> and <a href="https://developer.android.com/reference/android/view/View.html">View.setTranslationY methods</a> . <br><br>  We will also subscribe to the event of clicking on any element to reset the internal values ‚Äã‚Äãto 0 because at first they can be very naughty: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ position[<span class="hljs-number"><span class="hljs-number">0</span></span>] = position[<span class="hljs-number"><span class="hljs-number">1</span></span>] = position[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; velocity[<span class="hljs-number"><span class="hljs-number">0</span></span>] = velocity[<span class="hljs-number"><span class="hljs-number">1</span></span>] = velocity[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; timestamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; layoutSensor.setTranslationX(<span class="hljs-number"><span class="hljs-number">0</span></span>); layoutSensor.setTranslationY(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre><br><h4>  2. Sign up for acceleration sensor events: </h4><br><pre> <code class="java hljs">sensorManager = (SensorManager) getSystemService(SENSOR_SERVICE); accelerometer = sensorManager.getDefaultSensor(Sensor.TYPE_LINEAR_ACCELERATION); sensorManager.registerListener(sensorEventListener, accelerometer, SensorManager.SENSOR_DELAY_FASTEST);</code> </pre><br><h4>  3. And most importantly: the change listener.  Its basic implementation is: </h4><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>[] velocity = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>[] position = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> timestamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SensorEventListener sensorEventListener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SensorEventListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAccuracyChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sensor sensor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> accuracy)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSensorChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SensorEvent event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timestamp != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dt = (event.timestamp - timestamp) * Constants.NS2S; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; index &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; ++index) { velocity[index] += event.values[index] * dt; position[index] += velocity[index] * dt * <span class="hljs-number"><span class="hljs-number">10000</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { velocity[<span class="hljs-number"><span class="hljs-number">0</span></span>] = velocity[<span class="hljs-number"><span class="hljs-number">1</span></span>] = velocity[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0f</span></span>; position[<span class="hljs-number"><span class="hljs-number">0</span></span>] = position[<span class="hljs-number"><span class="hljs-number">1</span></span>] = position[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0f</span></span>; } } };</code> </pre><br>  Let's see what's going on here.  The onSensorChanged method is called each time the acceleration value changes (note of the translator: well, in fact, it is called by a timer, regardless of what acceleration values ‚Äã‚Äãare).  First you check whether the timestamp variable is initialized.  In this case, we simply initialize the main variables.  If the method is called again, we perform calculations using the following formula: <br><br><pre> <code class="java hljs">deltaT = time() - lastTime; velocity += acceleration * deltaT; position += velocity * deltaT; lastTime = time();</code> </pre><br>  You should have noticed an interesting constant of 10,000. Think of it as a kind of magic number. <br><br>  And the result: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/9_fqguLdTmA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  As you can see, the current implementation has two problems: <br><br><ul><li>  Drifting and crawling values </li><li>  The control element does not return to 0 </li></ul><br>  In fact, the solution for both problems is common - you need to enter braking in the formula.  The modified formula looks like this: <br><br><pre> <code class="java hljs">deltaT = time() - lastTime; velocity += acceleration * deltaT - VEL_FRICTION * velocity; position += velocity * deltaT - POS_FRICTION * position; lastTime = time();</code> </pre><br><iframe width="560" height="315" src="https://www.youtube.com/embed/84-29YgOIgU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Good.  The current implementation looks good.  I would add some cosmetic enhancements such as a low-pass filter for smoothing, cutting off invalid values ‚Äã‚Äãand program settings. <br><br>  The finished application is located in the repository in the ‚Äústandalone_app‚Äù branch. <br><br><h3>  AOSP </h3><br>  We have developed a basic stabilization algorithm and made a demo application which shows that screen stabilization is possible.  Now we can apply our work to the device as a whole.  This is not an easy task, but it will be more interesting to solve it. <br><br>  This task requires some experience in building <a href="https://en.wikipedia.org/wiki/Android_(operating_system)">AOSPs</a> .  Google provides all the necessary <a href="https://source.android.com/source/initializing.html">documentation</a> .  In general, you need to download the Android source code for the <a href="https://source.android.com/source/build-numbers.html">selected</a> Nexus device.  Collect firmware for Nexus and flash it.  Do not forget to include all the necessary <a href="https://developers.google.com/android/drivers">drivers</a> before building. <br><br>  As soon as you manage to collect the stock firmware, you can begin to develop and integrate screen stabilization. <br><br><h4>  The implementation plan is as follows: </h4><br><ol><li>  Find a way to shift the screen in the device </li><li>  Develop an API in the insides of AOSP to give the ability to set the offset in a standard Android application </li><li>  Develop a service in the demo application that will process data from the acceleration sensor and set the offset using the API above.  The service will start automatically when the device is turned on so that stabilization will work immediately after switching on. </li></ol><br><h4>  Now I just tell you how I solved these problems. </h4><br>  1. The first file for the study <a href="">DisplayDevice.cpp</a> which controls the parameters of the screen.  Method to look at void DisplayDevice :: setProjection (int orientation, const Rect &amp; newViewport, const Rect &amp; newFrame).  The most interesting is in line 483: <br><br><img src="http://blog.lemberg.co.uk/sites/blog/files/imce/%5E5B40D0C94EF11B16B24388346D2A919B161F7E3CD79AA64B65%5Epimgpsh_fullsize_distr.png" alt="image"><br><br>  where the final transformation matrix is ‚Äã‚Äãformed from other components.  All of these variables are instances of the <a href="">Transform</a> class.  This class is designed to handle transformations and has several overloaded operators (for example *).  To add a shift, add a new element: <br><br><img src="http://blog.lemberg.co.uk/sites/blog/files/imce/%5E6ED59935F3E29F91CB4C2E5C40D0E9B550CB311E2035329842%5Epimgpsh_fullsize_distr.png" alt="image"><br><br>  If you compile and flash your device, the screen there will be shifted by translateX pixels horizontally and translateY pixels vertically.  Finally, we need to add a new method void setTranslate (int x, int y);  which will be responsible for the shift matrix. <br><br>  2. The second interesting file is <a href="">SurfaceFlinger.cpp</a> .  This file is key in creating an API for accessing screen parameters.  Just add a new method: <br><br><img src="http://blog.lemberg.co.uk/sites/blog/files/imce/%5E399E74EA695720FF615C7583C47FBA87BCA68419850DDA8BE2%5Epimgpsh_fullsize_distr.png" alt="image"><br><br>  which will call the setTranslate method for all displays.  The other part looks a bit strange, but I'll explain it later.  We need to modify the status_t method of SurfaceFlinger :: onTransact (uint32_t code, const Parcel &amp; data, Parcel * reply, uint32_t flags) by adding a new section to the switch construction: <br><br><img src="http://blog.lemberg.co.uk/sites/blog/files/imce/%5E631012B98649CFB3D27B1A05DB3839D01144591CC166528080%5Epimgpsh_fullsize_distr.png" alt="image"><br><br>  This code is the entry point to our improvement. <br><br>  3. The data processing service is quite simple: it uses the algorithm developed earlier to obtain the offset values.  Further, these values ‚Äã‚Äãare transmitted via IPC to SurfaceFlinger: <br><br><img src="http://blog.lemberg.co.uk/sites/blog/files/imce/%5EF2D56DE3BE87BBC36A1881CAC9F9220909D1D9032F11211425%5Epimgpsh_fullsize_distr.png" alt="image"><br><br>  ServiceManager is not recognized by Android Studio because it is not available for non-system applications.  System applications should be bundled with AOSP using a makefile build system.  This will allow our application to get the necessary access rights in the hidden Android API.  To access the SurfaceFlinger service, the application must have the rights ‚Äúandroid.permission.ACCESS_SURFACE_FLINGER‚Äù.  Only system applications can have these rights (see below).  In order to have the right to call our API with code 2020, the application must have the ‚Äúandroid.permission.HARDWARE_TEST‚Äù rights.  Only system applications can have these rights.  And that in the end to make our application system, modify its manifest as follows: <br><br><img src="http://blog.lemberg.co.uk/sites/blog/files/imce/%5E522BA25288110CEAA82538180FDEB74A1896C0E11A3F0BB7E8%5Epimgpsh_fullsize_distr.png" alt="image"><br><br>  Also create the corresponding makefile: <br><br><img src="http://blog.lemberg.co.uk/sites/blog/files/imce/%5EE6BD5F61A5FB94590B8F4E7B350E3CF7E6D20B2703CBBC549B%5Epimgpsh_fullsize_distr.png" alt="image"><br><br>  The rest of the things in the application (broadcast receiver downloads, settings, other) are fairly standard and I will not be concerned here.  It remains to show how to make this application preinstalled (i.e., embedded in the firmware).  Simply place the source code in the <b>{aosp} / packages / apps</b> directory and modify the <b>core.mk</b> file so that it includes our application: <br><br><img src="http://blog.lemberg.co.uk/sites/blog/files/imce/%5E858784F72E8B81A5FED6F1CB31D045675CB20B805081A797B3%5Epimgpsh_fullsize_distr.png" alt="image"><br><br>  Final Demonstration: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/16r9gC-2xbE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h4>  You can find detailed information and source code on <a href="https://github.com/ryanchyshyn/aosp_screen_stabilization">github</a> </h4><br><br>  There is a ScreenStabilization application that should be placed in the <b>{aosp} / packages / apps</b> directory, AOSP patch files: <b>0001-ScreenStabilization-application-added.patch</b> should be applied to the <b>{aosp} / build</b> directory, <b>0001-Translate-methods-added .patch</b> must be applied to the <b>{aosp} / frameworks / native</b> directory. <br><br>  The firmware for <a href="">Nexus 2013 Mobile is</a> built in the ‚Äú <a href="https://source.android.com/source/building.html">userdebug</a> ‚Äù configuration so that it is more suitable for testing.  To flash the firmware, boot into bootloader mode by holding the ‚Äúvolume down‚Äù button and pressing the ‚Äúpower‚Äù button at the same time.  Next enter: <br><br><pre> <code class="hljs swift">fastboot -w update aosp_deb_screen_stabilization.<span class="hljs-built_in"><span class="hljs-built_in">zip</span></span></code> </pre> <br>  This procedure will delete all existing data on your device.  Keep in mind that in order to flash any non-standard firmware you must unlock the bootloader with the command: <br><br><pre> <code class="hljs sql">fastboot oem <span class="hljs-keyword"><span class="hljs-keyword">unlock</span></span></code> </pre> <br><h3>  Conclusion </h3><br>  This article shows how to implement a simple screen stabilization algorithm and apply it to the entire device by modifying the Android source codes and building custom firmware.  The algorithm is not perfect but sufficient for demonstration purposes.  We have created a modified firmware for the Nexus 2013 Mobile device, but our source code can be applied to any <a href="https://en.wikipedia.org/wiki/Google_Nexus">Nexus</a> device and even to any AOSP system like <a href="https://www.cyanogenmod.org/">CyanogenMod,</a> which makes it possible to integrate screen stabilization into new devices. <br><br>  <b>PS</b> In fact, I am also the author of the original English version of the article, which was published on <a href="http://blog.lemberg.co.uk/no-shake-screen-stabilization-android">blog.lemberg.co.uk</a> , so I can answer technical questions. </div><p>Source: <a href="https://habr.com/ru/post/317462/">https://habr.com/ru/post/317462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317450/index.html">Pre-New Year's Release API and Portal Scorocode</a></li>
<li><a href="../317454/index.html">How to protect the smart home: Solution from the ITMO University team</a></li>
<li><a href="../317456/index.html">JetBrains Night in Moscow. Video. How CLion handles the complexities of C ++</a></li>
<li><a href="../317458/index.html">Creating a web application in PHP using Firebird and Laravel</a></li>
<li><a href="../317460/index.html">How to become a product manager (and stop being a sales director). Part 3</a></li>
<li><a href="../317464/index.html">Remember everything: the roman room method</a></li>
<li><a href="../317466/index.html">Rollback in Cisco IOS XR</a></li>
<li><a href="../317468/index.html">Yandex.Metrica or specialized monitoring system - what and when to choose?</a></li>
<li><a href="../317470/index.html">My story of emigration, the dream of the administrator</a></li>
<li><a href="../317472/index.html">New Year! Distributing 10 Trips to New Orleans on VeeamON 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>