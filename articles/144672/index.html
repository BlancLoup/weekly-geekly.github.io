<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Debugging Native Android NDK Code on Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Good day! 

 Once I faced the task of catching an incomprehensible fall in my application. As far as I knew then, the Android NDK provi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Debugging Native Android NDK Code on Windows</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Good day! <br><br>  Once I faced the task of catching an incomprehensible fall in my application.  As far as I knew then, the Android NDK provided the ability to debug C ++ code, but I had a vague idea of ‚Äã‚Äãhow to do this.  Unfortunately, there was very little sensible information on debugging native code.  Having spent several evenings on this matter, I nevertheless figured out and adjusted debugging.  Now I will talk about how this can be done and tell you what rakes can expect you if you plan to repeat my way. <br><br><a name="habracut"></a><br>  For convenience, I created a project for debugging application - NdkDebugTest.  The application shows a black screen, and when you click on the screen, the native code is called, which kills the application.  The project consists of two java-files and one jni-file.  This is, respectively, the Activity code, the code for the JNI shell, and the native code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Activity code is quite simple - with any touch, the native OnInput function is called.  Also, when creating an Activity, an empty DoInit () method is called, whose task is to start the static loading of native libraries from JniWrapper.java (if this is not done, we will end up with a rake, see below). <br><br>  Here is the code: <br><br> <code>package fishrungames.ndkdebugtest; <br> <br> //... <br> <br> public class MainActivity extends Activity <br> { <br> <br> protected void onCreate(Bundle icicle) <br> { <br> super.onCreate(icicle); <br> JniWrapper.DoInit(); <br> } <br> <br> public boolean onTouchEvent(MotionEvent event) <br> { <br> float x = event.getX(); <br> float y = event.getY(); <br> <br> JniWrapper.OnInput(x, y); <br> return true; <br> } <br> <br> }</code> <br> <br>  Jni shell is also pretty simple: <br><br> <code>package fishrungames.ndkdebugtest; <br> <br> public class JniWrapper <br> { <br> <br> static { <br> System.loadLibrary("gnustl_shared"); <br> System.loadLibrary("NdkDebugTestLib"); <br> } <br> <br> public static void DoInit() <br> { <br> //To force libraries to load <br> } <br> <br> public static native void OnInput(float x, float y); <br> } <br></code> <br><br>  Well, actually native code.  Here, another function is called from the Jni-function, which kills the application: <br><br> <code>#include "android_api.h" <br> <br> void crusher() <br> { <br> int *x = 0; <br> *x = 1; <br> } <br> <br> JNIEXPORT void JNICALL Java_fishrungames_ndkdebugtest_JniWrapper_OnInput(JNIEnv * env, jobject obj, float x, float y) <br> { <br> crusher(); <br> }</code> <br> <br>  As I wrote above, after launching the application, whenever you press a finger, the application drops.  Our task is to find the place of the fall and see the backtrace.  So let's get started. <br><br><h4>  Instruments </h4><br>  We should have at our disposal: <br><ul><li>  Eclipse with the open project NdkBuildTest </li><li>  Cygwin </li><li>  Installed android-sdk </li><li>  Installed android-ndk, the path to which must be specified in the PATH environment variable.  The older the ndk version, the better (I used android-ndk-r8) </li></ul><br><br><h4>  Training </h4><br>  1) Make sure the debuggable = "true" parameter is set in the manifest: <br>  <i>&lt;application android: icon = "@ drawable / ic_menu_template" android: label = "NdkDebugTest" android: debuggable = "true"&gt;</i> <br><br>  2) Add the following line to Application.mk: <br>  <i>APP_OPTIM: = debug</i> <br>  This parameter, if I‚Äôm not mistaken, removes stripping (deletion of unused characters) when copying libraries, and does some other useful things for debugging. <br>  In Android.mk, add the -g -ggdb -O0 parameters to LOCAL_CFLAGS, and remove -s and -S from the LOCAL_LDLIBS parameters (if any). <br><br>  3) After that, run Cygwin, go to the directory with the project and run the build with the key NDK_DEBUG = 1: <br>  <i>ndk-build NDK_DEBUG = 1</i> <br><br>  If everything is done correctly, the gdb.setup and gdbserver files will appear in the project directory in the libs / &lt;platform&gt; subdirectory. <br><br>  4) In gdb.setup, the basic debugger settings are specified - in which directories to search for headers and libraries.  It is necessary to check whether all the paths to the headings are indicated and, if necessary, add their own paths. <br>  <b>Here are the rakes.</b>  <b>For some reason, at each reassembly in this file, the characters of line breaks are lost, which is why settings are not read.</b>  <b>You should make sure that the file is applied UNIX-linefeed.</b>  <b>I had to re-save gdb.setup with another line break after each call to ndk-build!</b> <br><br>  When you start the debugger, this file (gdb.setup) is automatically supplemented with other parameters and copied into obj / local / &lt;platform&gt; /.  All native libraries necessary for the application to work are also stored in obj / local / &lt;platform&gt; /.  If the build is correct, then the libraries contain debase symbols.  If you are in doubt, it is possible to check the presence or absence of debazh characters directly from the Cygwin console using the nm utility, specifying the required so-file as a parameter: <br>  <i>nm /obj/local/armeabi/libNdkDebugLib.so</i> <br>  In some older versions of android-ndk, it was also recommended to edit the file build / core / build-binary.mk, namely: change the line: <br><br>  <i>$ (hide) $ (call cmd-strip, $ (PRIVATE_DST))</i> <br><br>  On the lines: <br><br>  <i>ifneq ($ (APP_OPTIM), debug)</i> <i><br></i>  <i>$ (hide) $ (call cmd-strip, $ (PRIVATE_DST))</i> <i><br></i>  <i>endif</i> <br><br><h4>  Debugging </h4><br>  Everything is ready for debugging.  We start debugging through eclipse, we wait until the debugger is picked up.  Then in cygwin go to the directory with the project and run the native ndk-gdb debugger.  The --adb parameter specifies the path to adb, which is included with android-sdk: <br><img src="http://fishrungames.ru/4habr/habr3.png"><br><br>  <b>Here are another rake.</b>  <b>Make sure that all the native libraries (in our case, NdkDebugTestLib) are loaded before launch!</b>  <b>You can check this by putting a breakpoint on the library loading.</b> <br><br>  If everything is done correctly, you will see a long list of libraries for which characters have not been loaded.  Make sure that your library is not among them (in our case - libNdkDebugTestLib.so). <br>  If everything goes well, we will see an invitation to enter: <br><img src="http://fishrungames.ru/4habr/habr4.png"><br><br>  Continue with the continue command.  Then press a finger on the screen of the device, and the application falls, indicating the drop point: <br><img src="http://fishrungames.ru/4habr/habr5.png"><br><br>  The crash occurred when calling * x = 1;  in line 6 in the jni / android_api.cpp file, as expected. <br><br>  We enter backtrace - and we see a stack of calls of functions which led to falling: <br><img src="http://fishrungames.ru/4habr/habr6.png"><br><br><h4>  Conclusion </h4><br>  Well, the goal is achieved - we found the place of the application crash, and saw the call stack.  Using the debugger, you can set breakpoint, evaluate expressions and do much more, but it‚Äôs not a problem to find information about how to use the command line debugger. <br><br>  Here is a link to the project, which is described in the article: <a href="">http://fishrungames.ru/4habr/NdkDebugTest.rar</a> . <br><br><h4>  Sources </h4><br>  <a href="http://vilimpoc.org/blog/2010/09/23/hello-gdbserver-a-debuggable-jni-example-for-android/">http://vilimpoc.org/blog/2010/09/23/hello-gdbserver-a-debuggable-jni-example-for-android/</a> <br>  <a href="http://blog.sephiroth.it/2010/12/14/how-to-debug-native-code-with-android/">http://blog.sephiroth.it/2010/12/14/how-to-debug-native-code-with-android/</a> <br>  <a href="http://mhandroid.wordpress.com/2011/01/23/using-eclipse-for-android-cc-debugging/">http://mhandroid.wordpress.com/2011/01/23/using-eclipse-for-android-cc-debugging/</a> </div><p>Source: <a href="https://habr.com/ru/post/144672/">https://habr.com/ru/post/144672/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144665/index.html">IT R & D Cream (release 9) - will you deliver 1000 boxes of marshmallow to Mars?</a></li>
<li><a href="../144667/index.html">Results of the week. Issue 7 - with Igor Belkin</a></li>
<li><a href="../144668/index.html">Microsoft Xbox 360 may prohibit selling in the United States</a></li>
<li><a href="../144670/index.html">Creating flexible profiles in Drupal 7</a></li>
<li><a href="../144671/index.html">Mechanical display on the AVR from scratch. Part 0: Programmer (s)</a></li>
<li><a href="../144673/index.html">Testing iOS Applications</a></li>
<li><a href="../144674/index.html">Roaming Guide 2012: choose fares for travel</a></li>
<li><a href="../144675/index.html">Install and configure OSM-based tile generator in Ubuntu or Debian</a></li>
<li><a href="../144678/index.html">Apple patent application: Safari 3D interface</a></li>
<li><a href="../144679/index.html">Subtleties advancement in FaceBook</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>