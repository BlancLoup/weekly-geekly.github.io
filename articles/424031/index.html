<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reactive programming with JAX-RS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 The latest Java Enterprise Developer course this year has been successfully launched and we have the latest material on this topic that we w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reactive programming with JAX-RS</h1><div class="post__text post__text-html js-mediator-article"> Hello! <br><br>  The latest <a href="https://otus.pw/01Gu/">Java Enterprise Developer</a> course this year has been successfully launched and we have the latest material on this topic that we want to share with you about using asynchronous approach and styling to develop responsive reactive applications. <br><br>  Go. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Reactive programming first sounds like the name of the emerging paradigm, but in fact, refers to a programming method that uses an event-oriented approach to work with asynchronous data streams.  Based on constantly running data, reactive systems respond to them by performing a series of events. <br>  Reactive programming follows the ‚ÄúObserver‚Äù design pattern, which can be defined as follows: if a state change occurs in one object, all other objects are notified and updated accordingly.  Therefore, instead of polling events for changes, events are pushed asynchronously so that observers can process them.  In this example, observers are functions that are executed when an event is sent.  And the mentioned data stream is the actual observable. <br><br>  Almost all languages ‚Äã‚Äãand frameworks use this approach in their ecosystem, and the latest versions of Java are no exception.  In this article, I will explain how you can apply reactive programming using the latest version of JAX-RS in Java EE 8 and Java 8 functionality. <br><br><img src="https://habrastorage.org/webt/zp/g6/dr/zpg6dry4ynjfjnr6y6fkmkluoea.png"><a name="habracut"></a><br><br>  <b>Jet Manifesto</b> <br><br>  The <a href="https://www.reactivemanifesto.org/">Reactive Manifesto</a> lists four fundamental aspects that an application needs to be more flexible, loosely coupled and easy to scale, and therefore capable of being reactive.  It says that the application must be responsive, flexible (and therefore scalable), robust and message-driven. <br><br>  The underlying goal is a truly responsive application.  Suppose there is an application in which one large stream deals with the processing of user requests, and after performing the work, this stream sends the answers back to the original requesters.  When an application receives more requests than it can handle, this thread becomes a bottleneck, and the application loses its former responsiveness.  To maintain responsiveness, the application must be scalable and sustainable.  Sustainable can be considered an application in which there is functionality for auto-recovery.  According to the experience of most developers, only the message-driven architecture allows the application to be scalable, stable and responsive. <br><br>  Reactive programming was introduced in Java 8 and Java EE 8. Java introduced concepts such as <code>CompletionStage</code> and its implementation <code>CompletableFuture</code> , and Java began to use these functions in specifications such as the Reactive Client API in JAX-RS. <br><br>  <b>JAX-RS 2.1 Reactive Client API</b> <br><br>  Let's see how reactive programming can be used in Java EE 8 applications. To understand the process, you need a basic knowledge of the Java EE API. <br><br>  JAX-RS 2.1 introduced a new way to create a REST client with support for reactive programming.  The default invoker implementation offered by JAX-RS is synchronous, which means that the client being created will send a blocking call to the server‚Äôs endpoint.  An example implementation is presented in Listing 1. <br><br>  Listing 1 <br><br><pre> <code class="java hljs">Response response = ClientBuilder.newClient() .target(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/service-url"</span></span>) .request() .get();</code> </pre> <br>  Starting with version 2.0, JAX-RS provides support for creating an asynchronous invoker on the client API using a simple call to the <code>async()</code> method, as shown in Listing 2. <br><br>  Listing 2 <br><br><pre> <code class="java hljs">Future&lt;Response&gt; response = ClientBuilder.newClient() .target(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/service-url"</span></span>) .request() .async() .get();</code> </pre> <br>  Using an asynchronous invoker on the client returns a <code>Future</code> instance with type <code>javax.ws.rs.core.Response</code> .  This can lead to polling the response, calling <code>future.get()</code> , or registering a callback, which will be called when there is an available HTTP response.  Both implementations are suitable for asynchronous programming, but are usually complicated if you want to group callbacks or add conditional cases to these asynchronous execution minima. <br><br>  JAX-RS 2.1 provides a reactive way to overcome these problems with the new JAX-RS Reactive Client API for building a client.  This is as simple as calling the <code>rx()</code> method during client building.  In Listing 3 <code>rx()</code> method returns a reactive invoker that exists during client execution, and the client returns a response with the type <code>CompletionStage.rx()</code> , which allows the transition from synchronous invoker to asynchronous using a simple call. <br><br>  Listing 3 <br><br><pre> <code class="java hljs">CompletionStage&lt;Response&gt; response = ClientBuilder.newClient() .target(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/service-url"</span></span>) .request() .rx() .get();</code> </pre> <br>  <code>CompletionStage&lt;&gt;</code> is a new interface introduced in Java 8. It represents a calculation, which can be a step in a larger calculation, as the name suggests.  This is the only representative of Java 8 reactivity that got into JAX-RS. <br>  After receiving the response instance, I can call <code>AcceptAsync()</code> , where I can provide a snippet of code that will be executed asynchronously when the answer becomes available, as shown in Listing 4. <br><br>  Listing 4 <br><br><pre> <code class="java hljs">response.thenAcceptAsync(res -&gt; { Temperature t = res.readEntity(Temperature.class); <span class="hljs-comment"><span class="hljs-comment">//do stuff with t });</span></span></code> </pre> <br>  <b>Adding reactivity to the endpoint REST</b> <br><br>  The reactive approach is not limited to the client side of JAX-RS;  it can also be used on the server side.  For example, first I‚Äôll create a simple script where I can query the list of locations for one destination.  For each position, I will make a separate call with the location data to another point to get the temperature values.  The interaction of the destination points will be as shown in Figure 1. <br><br><img src="https://habrastorage.org/webt/rd/zr/cr/rdzrcrvbeyyfkp_bc5szid_t9au.png"><br>  <i>Figure 1. Interaction between destination points</i> <br><br>  At first, I simply define the model of the domain, and then the services for each model.  Listing 5 shows how the <code>Forecast</code> class is defined, which wraps the <code>Location</code> and <code>Temperature</code> classes. <br><br>  Listing 5 <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Temperature</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Double temperature; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String scale; <span class="hljs-comment"><span class="hljs-comment">// getters &amp; setters } public class Location { String name; public Location() {} public Location(String name) { this.name = name; } // getters &amp; setters } public class Forecast { private Location location; private Temperature temperature; public Forecast(Location location) { this.location = location; } public Forecast setTemperature( final Temperature temperature) { this.temperature = temperature; return this; } // getters }</span></span></code> </pre> <br>  For wrapping a list of predictions, the <code>ServiceResponse</code> class <code>ServiceResponse</code> implemented in Listing 6. <br><br>  Listing 6 <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceResponse</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> processingTime; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Forecast&gt; forecasts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setProcessingTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> processingTime)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.processingTime = processingTime; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ServiceResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forecasts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Forecast&gt; forecasts)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.forecasts = forecasts; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// getters }</span></span></code> </pre> <br>  <code>LocationResource</code> shown in Listing 7 defines three sample locations returned with the <code>/location</code> path. <br><br>  Listing 7 <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(<span class="hljs-string"><span class="hljs-string">"/location"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocationResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.APPLICATION_JSON) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLocations</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Location&gt; locations = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); locations.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Location(<span class="hljs-string"><span class="hljs-string">"London"</span></span>)); locations.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Location(<span class="hljs-string"><span class="hljs-string">"Istanbul"</span></span>)); locations.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Location(<span class="hljs-string"><span class="hljs-string">"Prague"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response.ok(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericEntity&lt;List&lt;Location&gt;&gt;(locations){}).build(); } }</code> </pre> <br>  <code>TemperatureResource</code> , shown in Listing 8, returns a randomly generated temperature value between 30 and 50 for a given location.  A 500 ms delay is added to the implementation to simulate the sensor readout. <br><br>  Listing 8 <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(<span class="hljs-string"><span class="hljs-string">"/temperature"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TemperatureResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(<span class="hljs-string"><span class="hljs-string">"/{city}"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.APPLICATION_JSON) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAverageTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"city"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String cityName) </span></span>{ Temperature temperature = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Temperature(); temperature.setTemperature((<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random().nextInt(<span class="hljs-number"><span class="hljs-number">20</span></span>) + <span class="hljs-number"><span class="hljs-number">30</span></span>)); temperature.setScale(<span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Thread.sleep(<span class="hljs-number"><span class="hljs-number">500</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException ignored) { ignored.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response.ok(temperature).build(); } }</code> </pre> <br>  First, I'll show the synchronous <code>ForecastResource</code> implementation (see Listing 9), which gives all the locations.  Then, for each position, it calls temperature service to get the values ‚Äã‚Äãin degrees Celsius. <br><br>  Listing 9 <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(<span class="hljs-string"><span class="hljs-string">"/forecast"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForecastResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Uri</span></span>(<span class="hljs-string"><span class="hljs-string">"location"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WebTarget locationTarget; <span class="hljs-meta"><span class="hljs-meta">@Uri</span></span>(<span class="hljs-string"><span class="hljs-string">"temperature/{city}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WebTarget temperatureTarget; <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.APPLICATION_JSON) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLocationsWithTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> startTime = System.currentTimeMillis(); ServiceResponse response = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceResponse(); List&lt;Location&gt; locations = locationTarget .request() .get(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericType&lt;List&lt;Location&gt;&gt;(){}); locations.forEach(location -&gt; { Temperature temperature = temperatureTarget .resolveTemplate(<span class="hljs-string"><span class="hljs-string">"city"</span></span>, location.getName()) .request() .get(Temperature.class); response.getForecasts().add( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Forecast(location).setTemperature(temperature)); }); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> endTime = System.currentTimeMillis(); response.setProcessingTime(endTime - startTime); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response.ok(response).build(); } }</code> </pre> <br>  When the forecast destination is requested as <code>/forecast</code> , you will get a conclusion similar to that shown in Listing 10. Note that the request processing took 1.533 ms, which is logical, since a synchronous request for temperature values ‚Äã‚Äãfrom three different locations adds up to 1.5 ms <br><br>  Listing 10 <br><br><pre> <code class="java hljs">{ <span class="hljs-string"><span class="hljs-string">"forecasts"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"London"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">33</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Istanbul"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">38</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Prague"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">46</span></span> } } ], <span class="hljs-string"><span class="hljs-string">"processingTime"</span></span>: <span class="hljs-number"><span class="hljs-number">1533</span></span> }</code> </pre><br>  As long as everything goes according to plan.  It is time to introduce reactive programming on the server side, where calls to each location can be executed in parallel after receiving all the locations.  This clearly can improve the synchronous flow shown earlier.  This is done in Listing 11, where the definition of the reactive version of the forecast service is shown. <br><br>  Listing 11 <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(<span class="hljs-string"><span class="hljs-string">"/reactiveForecast"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForecastReactiveResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Uri</span></span>(<span class="hljs-string"><span class="hljs-string">"location"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WebTarget locationTarget; <span class="hljs-meta"><span class="hljs-meta">@Uri</span></span>(<span class="hljs-string"><span class="hljs-string">"temperature/{city}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WebTarget temperatureTarget; <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.APPLICATION_JSON) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLocationsWithTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Suspended </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> AsyncResponse async)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> startTime = System.currentTimeMillis(); <span class="hljs-comment"><span class="hljs-comment">//   (stage)    CompletionStage&lt;List&lt;Location&gt;&gt; locationCS = locationTarget.request() .rx() .get(new GenericType&lt;List&lt;Location&gt;&gt;() {}); //      , //  ,   , //    CompletionStage final CompletionStage&lt;List&lt;Forecast&gt;&gt; forecastCS = locationCS.thenCompose(locations -&gt; { //      //   ompletionStage List&lt;CompletionStage&lt;Forecast&gt;&gt; forecastList = //      //     locations.stream().map(location -&gt; { //     //      //    final CompletionStage&lt;Temperature&gt; tempCS = temperatureTarget .resolveTemplate("city", location.getName()) .request() .rx() .get(Temperature.class); //   CompletableFuture,   //    //      return CompletableFuture.completedFuture( new Forecast(location)) .thenCombine(tempCS, Forecast::setTemperature); }).collect(Collectors.toList()); //    CompletableFuture, //     completable future //  return CompletableFuture.allOf( forecastList.toArray( new CompletableFuture[forecastList.size()])) .thenApply(v -&gt; forecastList.stream() .map(CompletionStage::toCompletableFuture) .map(CompletableFuture::join) .collect(Collectors.toList())); }); //   ServiceResponse, //       //    . //   future    // forecastCS,    //      CompletableFuture.completedFuture( new ServiceResponse()) .thenCombine(forecastCS, ServiceResponse::forecasts) .whenCompleteAsync((response, throwable) -&gt; { response.setProcessingTime( System.currentTimeMillis() - startTime); async.resume(response); }); } }</span></span></code> </pre> <br>  A reactive implementation may seem complicated at first glance, but after a closer look, you will notice that it is quite simple.  In the implementation of <code>ForecastReactiveResource</code> I first create a client call to location services using the JAX-RS Reactive Client API.  As I mentioned above, this is an add-on for Java EE 8, and it helps to create a reactive call simply by using the <code>rx()</code> method. <br><br>  Now I create a new stage based on location to collect a list of forecasts.  They will be stored as a list of forecasts in one large completion stage, called <code>forecastCS</code> .  Ultimately, I will create a service call response using only <code>forecastCS</code> . <br><br>  And now, let's collect the forecasts in the form of a list of completion stages defined in the variable <code>forecastList</code> .  To create a completion stage for each forecast, I transmit the data by location, and then create the <code>tempCS</code> variable, again using the JAX-RS Reactive Client API, which calls the temperature service with the name of the city.  Here, I use the <code>resolveTemplate()</code> method to build the client, and this allows me to pass the city name to the collector as a parameter. <br><br>  As the last step of streaming, I make a call to <code>CompletableFuture.completedFuture()</code> , passing the new <code>Forecast</code> instance as a parameter.  I combine this future with the <code>tempCS</code> stage so that I have a temperature value for the iterated locations. <br><br>  The <code>CompletableFuture.allOf()</code> method in Listing 11 converts the completion stage list to <code>forecastCS</code> .  Performing this step returns a large instance of a completable future when all the objects provided are completable future. <br><br>  The service response is an instance of the <code>ServiceResponse</code> class, so I create a completed future, and then combine the <code>forecastCS</code> completion stage with the list of forecasts and calculate the response time of the service. <br><br>  Of course, reactive programming forces only the server side to run asynchronously;  the client side will be blocked until the server sends the response back to the requester.  To overcome this problem, Server Sent Events (SSEs) can be used to partially send a response as soon as it is available, so that the temperature values ‚Äã‚Äãfor each location are transmitted to the client one by one.  The output of the <code>ForecastReactiveResource</code> will be similar to that presented in Listing 12. As shown in the output, the processing time is 515 ms, which is the ideal execution time for obtaining temperature values ‚Äã‚Äãfrom one location. <br><br>  Listing 12 <br><br><pre> <code class="java hljs">{ <span class="hljs-string"><span class="hljs-string">"forecasts"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"London"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">49</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Istanbul"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">32</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Prague"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">45</span></span> } } ], <span class="hljs-string"><span class="hljs-string">"processingTime"</span></span>: <span class="hljs-number"><span class="hljs-number">515</span></span> }</code> </pre> <br>  <b>Conclusion</b> <br><br>  In the examples of this article, I first showed the synchronous method of obtaining forecasts using location and temperature services.  Then, I switched to the reactive approach so that asynchronous processing was performed between service calls.  When you use the JAX-RS Reactive Client API in Java EE 8 along with the <code>CompletionStage</code> and <code>CompletableFuture</code> classes available in Java 8, the power of asynchronous processing is pulled free by reactive programming. <br><br>  Reactive programming is more than just an implementation of an asynchronous model from a synchronous one;  it also simplifies working with concepts such as the nesting stage.  The more it is used, the easier it will be to manage complex scenarios in parallel programming. <br><br>  THE END <br><br>  Thanks for attention.  As always, we are waiting for your comments and questions. </div><p>Source: <a href="https://habr.com/ru/post/424031/">https://habr.com/ru/post/424031/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424021/index.html">The complexities of self-learning programming and how to overcome them</a></li>
<li><a href="../424023/index.html">Automating the assembly of iOS applications using Fastlane</a></li>
<li><a href="../424025/index.html">Routing in a large application on React</a></li>
<li><a href="../424027/index.html">We study Adversarial Tactics, Techniques & Common Knowledge (ATT @ CK). Enterprise Tactics. Part 2</a></li>
<li><a href="../424029/index.html">And again about laziness</a></li>
<li><a href="../424033/index.html">What is it like to do Kotlin: an interview with Andrei Breslav</a></li>
<li><a href="../424035/index.html">2019 - the year Intel stopped</a></li>
<li><a href="../424037/index.html">A quick tour of GraphQL</a></li>
<li><a href="../424039/index.html">Cryptography after the landing of aliens</a></li>
<li><a href="../424041/index.html">Brief Introduction to Cell Biology</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>