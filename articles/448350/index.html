<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python dictionary implementation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone, April 30, the course ‚ÄúAlgorithms for Developers‚Äù starts at OTUS, and this is where the publication of today's material is timed. Let's...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python dictionary implementation</h1><div class="post__text post__text-html js-mediator-article">  Hello everyone, April 30, the course <a href="https://otus.pw/DQkd/">‚ÄúAlgorithms for Developers‚Äù</a> starts at OTUS, and this is where the publication of today's material is timed.  Let's start. <br><br><img src="https://habrastorage.org/webt/hq/5t/r4/hq5tr4-0h1wb2kxrkaggtq_fatm.png"><br><br>  In this article, you will learn how dictionaries are implemented in Python. <br>  Dictionaries are indexed using keys, and they can be viewed as associated arrays.  Let's add 3 key / value pairs to the dictionary: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>d = {<span class="hljs-string"><span class="hljs-string">'a'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'b'</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>} &gt;&gt;&gt; d[<span class="hljs-string"><span class="hljs-string">'c'</span></span>] = <span class="hljs-number"><span class="hljs-number">3</span></span> &gt;&gt;&gt; d {<span class="hljs-string"><span class="hljs-string">'a'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'b'</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'c'</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>}</code> </pre> <a name="habracut"></a><br>  Values ‚Äã‚Äãcan be accessed as follows: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>d[<span class="hljs-string"><span class="hljs-string">'a'</span></span>] <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt;&gt; d[<span class="hljs-string"><span class="hljs-string">'b'</span></span>] <span class="hljs-number"><span class="hljs-number">2</span></span> &gt;&gt;&gt; d[<span class="hljs-string"><span class="hljs-string">'c'</span></span>] <span class="hljs-number"><span class="hljs-number">3</span></span> &gt;&gt;&gt; d[<span class="hljs-string"><span class="hljs-string">'d'</span></span>] Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">"&lt;stdin&gt;"</span></span>, line <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;module&gt; KeyError: <span class="hljs-string"><span class="hljs-string">'d'</span></span></code> </pre> <br>  The key <code>‚Äúd‚Äù</code> does not exist, so a KeyError error will appear <br><br>  <b>Hash tables</b> <br><br>  Dictionaries in Python are implemented using hash tables.  They are arrays whose indices are calculated using hash functions.  The purpose of the hash function is to evenly distribute the keys in the array.  A good hash function minimizes the number of collisions, i.e.  the probability that different keys will have one hash.  Python doesn't have this kind of hash function.  Its most important hash functions (for strings and integer values) produce similar values ‚Äã‚Äãin general cases: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>map(hash, (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)) [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>] &gt;&gt;&gt; map(hash, (<span class="hljs-string"><span class="hljs-string">"namea"</span></span>, <span class="hljs-string"><span class="hljs-string">"nameb"</span></span>, <span class="hljs-string"><span class="hljs-string">"namec"</span></span>, <span class="hljs-string"><span class="hljs-string">"named"</span></span>)) [<span class="hljs-number"><span class="hljs-number">-1658398457</span></span>, <span class="hljs-number"><span class="hljs-number">-1658398460</span></span>, <span class="hljs-number"><span class="hljs-number">-1658398459</span></span>, <span class="hljs-number"><span class="hljs-number">-1658398462</span></span>]</code> </pre> <br>  We will assume that by the end of this article we will use strings as keys.  The hash function in Python for strings is defined as follows: <br><br><pre> <code class="python hljs">arguments: string object returns: hash function string_hash: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hash cached: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> it set len to string<span class="hljs-string"><span class="hljs-string">'s length initialize var p pointing to 1st char of string object set x to value pointed by p left shifted by 7 bits while len &gt;= 0: set var x to (1000003 * x) xor value pointed by p increment pointer p set x to x xor length of string object cache x as the hash so we don'</span></span>t need to calculate it again <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> the hash</code> </pre> <br>  If you execute <code>hash('a')</code> in Python, it will work out <code>string_hash()</code> and return <code>12416037344</code> .  Here we are using the default 64-bit machine. <br><br>  If an array of size <code></code> used to store value / key pairs, then a mask will be used to calculate the cell index of the pair in the array, which is calculated as <code>-1</code> .  This approach makes computing cell indices quick.  The probability of finding an empty cell is quite high due to the resizing mechanism, which is described below.  This means that a simple calculation makes sense in most cases.  The array size is 8, the index for <code>'a'</code> will be: <code>hash('a') &amp; 7 = 0</code> .  The index for <code>'b'</code> is 2, the index for <code>'c'</code> is 3, the index for <code>'z'</code> is 3, just like for <code>'b'</code> , and it is here that we have a collision. <br><br><img src="https://habrastorage.org/webt/m0/uu/ie/m0uuieays-qf4xbaurxripjwdi8.png"><br><br>  As we can see, the hash function in Python performs its work qualitatively, in the case when the keys are sequential, which is good, since you often have to work with such data.  However, as soon as we add the key <code>'z'</code> , a collision occurs because it is not consistent with the previous ones. <br><br>  We could use a linked list for storing pairs, while having the same hash, but that would increase the search time, and it would not equal O (1) on average.  The following section describes the collision resolution method used for dictionaries in Python. <br><br>  <b>Public addressing</b> <br><br>  Open addressing is a collision resolution method that uses probing.  In the case of <code>'z'</code> , cell 3 is already used in the array, so we need to find another index that has not yet been used.  The operation of adding a key / value pair takes an average O (1), as well as a search operation. <br><br>  To search for free cells, a quadratic probing sequence is used.  It is implemented as follows: <br><br><pre> <code class="python hljs">j = (<span class="hljs-number"><span class="hljs-number">5</span></span>*j) + <span class="hljs-number"><span class="hljs-number">1</span></span> + perturb; perturb &gt;&gt;= PERTURB_SHIFT; use j % <span class="hljs-number"><span class="hljs-number">2</span></span>**i <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> the next table index;</code> </pre> <br>  Recursion in (5 * j) +1 quickly increases large differences in bits that did not affect the original index.  The variable <code>"perturb"</code> in this case takes the other bits of the hash code. <br><br>  Out of curiosity, let's see what happens if we have a probing sequence with a table size of 32 and j = 3. <br><br>  3 -&gt; 11 -&gt; 19 -&gt; 29 -&gt; 5 -&gt; 6 -&gt; 16 -&gt; 31 -&gt; 28 -&gt; 13 -&gt; 2 ... <br><br>  You can learn more about this sampling sequence by accessing the source code for <a href="">dictobject.c</a> .  A detailed explanation of the operation of the probing mechanism can be found at the top of the file. <br><br><img src="https://habrastorage.org/webt/jq/vo/l3/jqvol3q4ekq8yullsftv4ylm-p4.png"><br><br>  Let's look at the Python source code with this example. <br><br>  <b>Dictionary structure C</b> <br><br>  The following C structure is used to store entries in the dictionary: key / value pair.  Stores hash, key and value.  <code>PyObject</code> is the base class for objects in Python. <br><br><pre> <code class="python hljs">typedef struct { Py_ssize_t me_hash; PyObject *me_key; PyObject *me_value; } PyDictEntry;</code> </pre> <br>  The following structure is a dictionary.  <code>ma_fill</code> is the total number of used and inactive cells.  A slot is considered inactive when a key pair is removed.  <code>ma_used</code> is the number of cells used (active).  <code>ma_mask</code> equals array size -1 and is used to calculate the cell index.  <code>ma_table</code> is an array, and <code>ma_smalltable</code> is the original array of size 8. <br><br><pre> <code class="python hljs">typedef struct _dictobject PyDictObject; struct _dictobject { PyObject_HEAD Py_ssize_t ma_fill; Py_ssize_t ma_used; Py_ssize_t ma_mask; PyDictEntry *ma_table; PyDictEntry *(*ma_lookup)(PyDictObject *mp, PyObject *key, long hash); PyDictEntry ma_smalltable[PyDict_MINSIZE]; };</code> </pre> <br>  <b>Dictionary initialization</b> <br><br>  When you first create a dictionary, the <code>PyDict_New()</code> function is <code>PyDict_New()</code> .  I deleted some lines and converted the C code to pseudocode to focus on key concepts. <br><br>  <code>PyDict_New()</code> function: <br><br><ul><li>  Returns a dictionary object; </li><li>  Allocates a new dictionary object; </li><li>  Clears the dictionary table; </li><li>  Sets the number of used dictionary cells and unused cells ( <code>ma_fill</code> ) to 0; </li><li>  Sets the number of active cells ( <code>ma_used</code> ) to 0; </li><li>  Sets the dictionary mask ( <code>ma_value</code> ) to a value equal to the size of the dictionary - 1 = 7; </li><li>  Sets the dictionary search function <code>lookdict_string</code> ; </li><li>  Returns an allocated dictionary object. </li></ul><br>  <b>Add item</b> <br><br>  When a new key / value pair is added, <code>PyDict_SetItem()</code> called.  This function takes as input a pointer to a dictionary object and a key / value pair.  It checks whether the key is a string and calculates a hash or re-uses the cached one if it exists.  <code>insertdict()</code> is called to add a new key / value pair and the dictionary size changes if the number of used and unused cells is more than 2/3 of the array size. <br><br>  Why exactly 2/3?  This is necessary to make sure that the probing sequence can find free cells quickly enough.  Later we will consider the function for resizing. <br><br><pre> <code class="python hljs">arguments: dictionary, key, value returns: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> OK <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> function PyDict_SetItem: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> key<span class="hljs-string"><span class="hljs-string">'s hash cached: use hash else: calculate hash call insertdict with dictionary object, key, hash and value if key/value pair added successfully and capacity over 2/3: call dictresize to resize dictionary'</span></span>s table</code> </pre> <br>  <code>inserdict()</code> uses the <code>lookdict_string()</code> lookup function to find an <code>lookdict_string()</code> cell.  The same function is used to find the key. <br><br>  <code>lookdict_string()</code> calculates the cell index using a hash and mask values.  If she cannot find the key by the value cell index = hash &amp; mask (slot index = hash &amp; mask), she starts probing using the cycle described above until she finds a free cell.  On the first attempt at probing, if the key is <code>null</code> , it returns an unused cell if it is found during the first search.  This ensures priority for the reuse of previously deleted cells. <br>  We want to add the following key / value pairs: <code>{'a': 1, 'b': 2‚Ä≤, 'z': 26, 'y': 25, 'c': 5, 'x': 24}</code> .  Here is what will happen: <br><br>  The dictionary structure is allocated with a table size of 8. <br><br><ul><li>  PyDict_SetItem: key = 'a', value = 1 <br><ul><li>  hash = hash ('a') = 12416037344 </li><li>  insertdict <br><ul><li>  lookdict_string <br><ul><li>  slot index = hash &amp; mask = 12416037344 &amp; 7 = 0 </li><li>  slot 0 not used, return this cell </li></ul></li><li>  initialization of entry at index 0 with key, value and hash </li><li>  ma_used = 1, ma_fill = 1 </li></ul></li></ul></li><li>  PyDict_SetItem: key = 'b', value = 2 <br><ul><li>  hash = hash ('b') = 12544037731 </li><li>  insertdict <br><ul><li>  lookdict_string <br><ul><li>  slot index = hash &amp; mask = 12544037731 &amp; 7 = 3 </li><li>  slot 3 not used, return this cell </li></ul></li><li>  initialization of entry at index 3 with key, value and hash </li><li>  ma_used = 2, ma_fill = 2 <br></li></ul></li></ul></li><li>  PyDict_SetItem: key = 'z', value = 26 <br><ul><li>  hash = hash ('z') = 15616046971 </li><li>  insertdict <br><ul><li>  lookdict_string <br><ul><li>  slot index = hash &amp; mask = 15616046971 &amp; 7 = 3 </li><li>  slot 3 is in use, try another slot: 5 is free <br></li></ul><br>  initialization of entry at index 5 with key, value and hash <br>  ma_used = 3, ma_fill = 3 <br></li></ul></li></ul></li><li>  PyDict_SetItem: key = 'y', value = 25 <br><ul><li>  hash = hash ('y') = 15488046584 </li><li>  insertdict <br><ul><li>  lookdict_string <br><ul><li>  slot index = hash &amp; mask = 15488046584 &amp; 7 = 0 </li><li>  slot 0 is used, try another cell: 1 is free </li></ul></li><li>  initialization of entry at index 1 with key, value and hash </li><li>  ma_used = 4, ma_fill = 4 </li></ul></li></ul></li></ul><br>  PyDict_SetItem: key = 'c', value = 3 <br><ul><li>  hash = hash ('c') = 12672038114 </li><li>  insertdict <br><ul><li>  lookdict_string <br><ul><li>  slot index = hash &amp; mask = 12672038114 &amp; 7 = 2 </li><li>  slot 2 not used, return this cell </li></ul></li><li>  initialization of entry at index 2 with key, value and hash </li><li>  ma_used = 5, ma_fill = 5 </li></ul></li></ul><br>  PyDict_SetItem: key = 'x', value = 24 <br><ul><li>  hash = hash ('x') = 15360046201 </li><li>  insertdict <br><ul><li>  lookdict_string <br><ul><li>  slot index = hash &amp; mask = 15360046201 &amp; 7 = 1 </li><li>  slot 1 is used, try another cell: 7 is free </li></ul></li><li>  initialization of entry at index 7 with key, value and hash </li><li>  ma_used = 6, ma_fill = 6 </li></ul></li></ul><br>  Here is what we get: <br><br><img src="https://habrastorage.org/webt/f9/wa/hf/f9wahfryuhllv1zykzjmwjcqllk.png"><br><br>  Now 6 cells out of 8 are used, more than 2/3 of the array capacity is occupied.  <code>dictresize()</code> is called to allocate a larger array.  This function also deals with copying records from the old table to the new one. <br><br>  <code>dictresize ()</code> is called with <code>minused</code> = 24 in our case, where 4 * <code>ma_used</code> .  2 * <code>ma_used</code> used when the number of cells used is very large (more than 50,000).  Why 4 times more cells?  This reduces the number of steps to implement resizing and increases sparseness. <br><br>  The new size of the table should be greater than 24, it is calculated by shifting the current size by 1 bit to the left until the size of the table is larger than 24. As a result, it will be 32, for example, 8 -&gt; 16 -&gt; 32. <br><br>  Here is what happens to our table during resizing: a new table with a size of 32 is allocated. Old table entries are inserted into a new table using a new mask value of 31. As a result, the following is obtained: <br><br><img src="https://habrastorage.org/webt/qy/ue/ke/qyueke3baeooxaxzskg8dphcpli.png"><br><br>  <b>Deleting items</b> <br><br>  <code>PyDict_DelItem()</code> is called to delete entries.  For the record key, the hash is calculated, then the search function is called to return the record.  Now the cell is empty. <br><br>  We want to remove the "c" key from our dictionary.  As a result, we get the following array: <br><br><img src="https://habrastorage.org/webt/sw/x1/l1/swx1l1efqzzelggasprbesixdqw.png"><br><br>  Please note that the operation of deleting an element does not change the size of the array, if the number of cells used is much smaller than their total number.  However, when a key / value pair is added, the need for resizing depends on the number of used and inactive cells, so the addition operation can also reduce the array. <br><br>  This publication has come to an end, and we traditionally welcome your comments and invite everyone to an <a href="https://otus.pw/rDqL/">open lesson</a> , which will be held on April 18th. </div><p>Source: <a href="https://habr.com/ru/post/448350/">https://habr.com/ru/post/448350/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448336/index.html">Seminar "Hybrid Clouds - Pros and Cons: What Business and IT Should Prepare for" - April 25, Moscow</a></li>
<li><a href="../448340/index.html">The creation of the game "35MM". Postapocalypse in Russia</a></li>
<li><a href="../448342/index.html">MyDrops - inexpensive TWS with good sound and reliable Bluetooth</a></li>
<li><a href="../448346/index.html">From GNU to Doom: TechTrain 2019 Announcement</a></li>
<li><a href="../448348/index.html">Elements, the basis for the development</a></li>
<li><a href="../448354/index.html">GraphQL Voyager as a tool for finding vulnerabilities</a></li>
<li><a href="../448358/index.html">We listen to music and lectures from Youtube with a locked smartphone screen and without advertising using Telegram</a></li>
<li><a href="../448360/index.html">A small backdoor on Flask or how to control a computer on a local network</a></li>
<li><a href="../448362/index.html">I thought I needed to send the designers to ...</a></li>
<li><a href="../448364/index.html">Stormglass - Crystals Predictors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>