<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Failover Cluster for Load Balancing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Let's talk about horizontal scaling. Suppose your project has grown to a size where one server cannot cope with the load, and there are no longer any ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Failover Cluster for Load Balancing</h1><div class="post__text post__text-html js-mediator-article"><p>  Let's talk about horizontal scaling.  Suppose your project has grown to a size where one server cannot cope with the load, and there are no longer any possibilities for vertical growth of resources. </p><a name="habracut"></a><br><p>  In this case, the further development of the project infrastructure usually occurs due to an increase in the number of servers of the same type with load distribution between them.  Such an approach not only solves the problem with resources, but also adds to the reliability of the project ‚Äî if one or more components fail, its overall performance will not be compromised. </p><br><p>  An important role in this scheme is played by the balancer - a system that deals with the distribution of requests / traffic.  At the design stage, it is important to provide the following key requirements: </p><br><ul><li>  Fault tolerance.  You need at least two servers that simultaneously deal with the task of distributing requests / traffic.  Without explicit separation of roles into lead and backup. </li><li>  Scaling.  Adding new servers to the system should give a proportional increase in resources. </li></ul><br><p>  In fact, this is a description of a cluster whose nodes are balancer servers. </p><br><p>  In this article, we want to share a recipe for such a cluster, simple and unpretentious to resources, the concept of which we successfully apply in our own infrastructure for balancing requests to the servers of our control panel, internal DNS server, <a href="http://galeracluster.com/">Galera cluster</a> and various microservices. </p><br><h4>  <b>Agree on terms:</b> </h4><br><p>  - Servers that are part of a cluster will be called nodes or balancers. <br>  - We will call the end servers the hosts to which the traffic through the cluster is proxied. <br>  - Virtual IP will be called the address ‚Äúfloating‚Äù between all nodes, and which should indicate the names of the services in the DNS. </p><br><h4>  <b>What is required:</b> </h4><br><p>  - To configure the cluster, you will need at least two servers (or virtual machines) with two network interfaces on each. <br>  - The first interface will be used to communicate with the outside world.  The real and virtual IP addresses will be configured here. <br>  - The second interface will be used for service traffic to communicate with each other nodes.  Here the address from the private (‚Äúgray‚Äù) network 172.16.0.0/24 will be configured. <br>  The second interfaces of each node must be in the same network segment. </p><br><h4>  <b>Used technologies:</b> </h4><br><p>  <b>VRRP, Virtual Router Redundancy Protocol</b> - in the context of this article, the implementation of a "floating" between the cluster nodes of the virtual IP address.  At one point in time, such an address can be raised on a single node, called MASTER.  The second node is called BACKUP.  Both nodes are constantly exchanging special heartbeat messages.  Receiving or not receiving such messages within specified intervals gives grounds for reassigning the virtual IP to a ‚Äúlive‚Äù server.  More details about the protocol can be found <a href="https://ru.wikipedia.org/wiki/VRRP">here</a> . </p><br><p>  <b>LVS, Linux Virtual Server</b> is a balancing mechanism at the transport / session level, embedded in the Linux kernel as an IPVS module.  A good description of LVS features can be found <a href="https://habrahabr.ru/post/104621/">here</a> and <a href="http://www.rhd.ru/docs/manuals/enterprise/RHEL-5-Manual/Virtual-Server-Administration/ch-lvs-overview-VSA.html">here</a> . <br>  The essence of the work is reduced to indicating that there is a certain pair of ‚ÄúIP + port‚Äù and it is a virtual server.  For this pair, addresses of real servers responsible for processing requests are assigned, a balancing algorithm is set, as well as a request redirection mode. </p><br><p>  In our system, we will use Nginx as an intermediate between LVS and end servers for which you need to proxy traffic.  Nginx will be present on each node. </p><br><p>  For VRRP settings and IPVS interaction, we will use the <a href="http://www.keepalived.org/">Keepalived</a> daemon, written as part of the Linux Virtual Server project. </p><br><h4>  <b>CONCEPT</b> </h4><br><p>  The system will be a bundle of two independent from each other equivalent nodes, balancers, clustered by means of LVS technology and VRRP protocol. </p><br><p>  The entry point for traffic will be a virtual IP address, raised either on one or on the second node. </p><br><p>  Incoming LVS requests are redirected to one of the running instances of Nginx - local or on the neighboring node.  This approach allows you to evenly smear requests between all nodes in the cluster, i.e.  more optimal use of the resources of each balancer. </p><br><img src="https://habrastorage.org/files/292/b71/385/292b7138582f4716b8ce1fc863557160.gif"><br><br><p>  Nginx‚Äôs job is to proxying requests to destination servers.  Starting from version 1.9.13, proxying functions are available at the tcp and udp transport protocol level. </p><br><p>  Each vhost / stream will be configured to receive requests both through the service interface from the neighboring balancer and incoming to the virtual IP.  And even if the virtual IP address is not physically raised on this balancer (Keepalived has assigned the server role BACKUP). </p><br><p>  Thus, the scheme of traffic walking depending on the state of the balancer (MASTER or BACKUP) looks like this: </p><br><p>  <b>MASTER:</b> </p><br><ul><li>  request comes to virtual IP.  IPVS routes the packet to the local server; </li><li>  since the local Nginx listens including virtual IP, it receives the request; </li><li>  according to the proxy settings for this virtual IP, Nginx sends a request to one of the listed upstream; </li><li>  the response received is sent to the client. </li></ul><br><p>  <b>BACKUP:</b> </p><br><ul><li>  request comes to virtual IP.  IPVS routes the packet to a neighboring server; </li><li>  on the adjacent balancer, this virtual IP is not raised.  Therefore, the dst_ip in the packet must be replaced with the corresponding gray IP from the network of the current balancer.  DNAT is used for this; </li><li>  after that, the local Nginx receives a request to a gray IP address; </li><li>  according to the proxy settings for this virtual IP, Nginx sends a request to one of the listed upstream; </li><li>  the received response is sent to the client directly with src_ip equal to the virtual IP (with the participation of conntrack) </li></ul><br><h4>  <b>REALIZATION:</b> </h4><br><p>  As an operating system, we will use Debian Jessie with <a href="https://backports.debian.org/Instructions/">backports repositories</a> connected. </p><br><p>  We will install packages with the software required for cluster operation on each balancer node and make several system-wide settings: </p><br><pre><code class="bash hljs">apt-get update apt-get install -t jessie-backports nginx apt-get install keepalived ipvsadm</code> </pre> <br><p>  On the <code>eth1</code> interface, we configure addresses from the gray network <code>172.16.0.0/24</code> : </p><br><pre> <code class="bash hljs">allow-hotplug eth1 iface eth1 inet static address 172.16.0.1 <span class="hljs-comment"><span class="hljs-comment">#    -- 172.16.0.2 netmask 255.255.255.0</span></span></code> </pre> <br><p>  You do not need to prescribe a virtual IP address on the <code>eth0</code> interface.  This will keepalived. </p><br><p>  Add the following directives to the <code>/etc/sysctl.d/local.conf</code> file: </p><br><pre> <code class="bash hljs">net.ipv4.ip_nonlocal_bind = 1 net.ipv4.vs.drop_entry = 1 net.nf_conntrack_max = 4194304</code> </pre> <br><p>  The first includes the ability to listen to IPs that are not picked up locally (this is necessary for the work of Nginx).  The second includes automatic protection against DDoS at the level of the IPVS balancer (if there is not enough memory for the session table, some of the entries will be automatically cleaned).  The third increases the size of the conntrack table. </p><br><p>  In <code>/etc/modules</code> enable the loading of the IPVS module at system startup: </p><br><pre> <code class="bash hljs">ip_vs conn_tab_bits=18</code> </pre> <br><p>  The <code>conn_tab_bits</code> parameter determines the size of the table with connections.  Its value is a power of two.  The maximum allowed value is 20. </p><br><p>  By the way, if the module is not loaded before the start of Keepalived, the latter starts to segfolt. </p><br><p>  Now restart both balancer nodes.  So we will make sure that at the start the entire configuration will correctly rise. </p><br><hr><br><p>  General settings are made.  Further actions will be performed in the context of two tasks: </p><br><ul><li>  Http traffic balancing between three web servers; </li><li>  Balancing udp traffic on port 53 of two DNS servers. </li></ul><br><p>  <strong>Input data:</strong> </p><br><ul><li>  We will use <code>192.168.0.100</code> as the virtual IP address; </li><li>  Web servers will have addresses <code>192.168.0.101</code> , <code>192.168.0.102</code> and <code>192.168.0.103</code> respectively, their sequence numbers; </li><li>  The DNS servers are <code>192.168.0.201</code> and <code>192.168.0.202</code> . </li></ul><br><p>  Let's start with the Nginx configuration. </p><br><p>  Add a description of the stream section in <code>/etc/nginx/nginx.conf</code> : </p><br><pre> <code class="bash hljs">stream { include /etc/nginx/stream-enabled/*; }</code> </pre> <br><p>  And create the appropriate directory: </p><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> /etc/nginx/stream-enabled</code> </pre> <br><p>  Settings for web servers add to <code>/etc/nginx/sites-enabled/web_servers.conf</code> </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> web_servers { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">192.168.0.101:80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">192.168.0.102:80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">192.168.0.103:80</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">172.16.0.1:80</span></span> default_server; <span class="hljs-comment"><span class="hljs-comment">#    -- 172.16.0.2 listen 192.168.0.100:80 default_server; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://web_servers; proxy_redirect default; } }</span></span></code> </pre> <br><p>  Settings for DNS servers add to <code>/etc/nginx/stream-enabled/dns_servers.conf</code> </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> dns_servers { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">192.168.0.201:53</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">192.168.0.202:53</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">172.16.0.1:53</span></span> udp reuseport; <span class="hljs-comment"><span class="hljs-comment">#    -- 172.16.0.2 listen 192.168.0.100:53 udp reuseport; proxy_pass dns_servers; }</span></span></code> </pre> <br><p>  Next, it remains to configure Keepalived (VRRP + LVS).  This is a bit more complicated, since we will need to write a special script that will be launched when the balancer node transitions between the MASTER / BACKUP states. </p><br><p>  All Keepalived settings should be in one file - <code>/etc/keepalived/keepalived.conf</code> .  Therefore, all of the following blocks with VRRP and LVS configurations should be consistently saved in this file. </p><br><p>  VRRP settings: </p><br><pre> <code class="hljs 1c">vrrp_instance <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">0.100</span></span> { interface eth1 <span class="hljs-meta"><span class="hljs-meta">#      VRRP track_interface { # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">     </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta"> eth0 #   ,     eth1 # FAULT, ..      IP  #   LVS } virtual_router_id 1 #      nopreempt # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">      BACKUP # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">         priority 102 # .      authentication { auth_type PASS auth_pass secret #      } virtual_ipaddress { 192.168.0.100/24 dev eth0 } notify /usr/local/bin/nat-switch }</span></span></code> </pre> <br><p>  The script mentioned above is <code>/usr/local/bin/nat-switch</code> .  It starts every time the current state of the current VRRP instance changes.  Its task is to ensure that the balancer, in the BACKUP state, is able to correctly process packets addressed to virtual IP.  To solve this situation, DNAT features are used.  Namely, the rule of the form: </p><br><pre> <code class="hljs matlab">-A PREROUTING -d <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> eth1 -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> DNAT --to-destination ${IP_on_eth1}</code> </pre> <br><p>  When switching to the MASTER state, the script deletes this rule. </p><br><p>  <a href="https://gist.githubusercontent.com/0xef53/5f7855e11adf3e7eaa77a9d52f70063b/raw/9f64c5444a48b0d8f374221c3244286fc6a2575d/1_nat-switch">Here</a> you can find a variant of the script <code>nat-switch</code> , written for this example. </p><br><p>  LVS settings for a group of web servers: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">virtual_server</span></span> <span class="hljs-number"><span class="hljs-number">192.168.0.100</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">lb_algo</span></span> wlc <span class="hljs-comment"><span class="hljs-comment">#   # wlc --       - #  . lb_kind DR #   . Direct routing protocol TCP delay_loop 6 #    healthchecker' real_server 172.16.0.1 80 { weight 1 TCP_CHECK { #     connect_timeout 2 #    Nginx } } real_server 172.16.0.2 80 { weight 1 TCP_CHECK { connect_timeout 2 } } }</span></span></code> </pre> <br><p>  LVS settings for a group of DNS servers: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">virtual_server</span></span> <span class="hljs-number"><span class="hljs-number">192.168.0.100</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">lb_algo</span></span> wlc lb_kind DR protocol UDP delay_loop <span class="hljs-number"><span class="hljs-number">6</span></span> real_server <span class="hljs-number"><span class="hljs-number">172.16.0.1</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">weight</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> MISC_CHECK { <span class="hljs-attribute"><span class="hljs-attribute">connect_timeout</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> misc_path <span class="hljs-string"><span class="hljs-string">"/bin/nc -zn -u 172.16.0.1 53"</span></span> } } real_server <span class="hljs-number"><span class="hljs-number">172.16.0.2</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">weight</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> MISC_CHECK { <span class="hljs-attribute"><span class="hljs-attribute">connect_timeout</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> misc_path <span class="hljs-string"><span class="hljs-string">"/bin/nc -zn -u 172.16.0.2 53"</span></span> } } }</code> </pre> <br><p>  Finally, restart the Nginx and Keepalived configuration: </p><br><pre> <code class="hljs swift">nginx -s reload &amp;&amp; /etc/<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>.d/keepalived reload</code> </pre> <br><h4 id="testirovanie">  <strong>TESTING:</strong> </h4><br><p>  Let's see how the balancer distributes requests to destination servers.  To do this, on each of the web servers, create <code>index.php</code> with some simple content: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> sleep(rand(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello from "</span></span>.gethostname().<span class="hljs-string"><span class="hljs-string">" !"</span></span>); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br><p>  And we will make several requests via http to the virtual IP <code>192.168.0.100</code> : </p><br><pre> <code class="hljs bash"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(seq 10); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'GET / HTTP/1.0\n\n\n'</span></span> | nc 192.168.0.100 80 | grep Hello <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  Result: </p><br><pre> <code class="hljs pgsql">Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> ! Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> ! Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> ! Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> ! Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> ! Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> ! Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> ! Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> ! Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> ! Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> !</code> </pre> <br><p>  If, during the execution of this cycle, you look at the statistics of the LVS operation (on the MASTER node), then we can see the following picture: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ipvsadm</span></span> -Ln</code> </pre> <br><p>  Result: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">IP</span></span> Virtual Server version <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> (size=<span class="hljs-number"><span class="hljs-number">262144</span></span>) Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP <span class="hljs-number"><span class="hljs-number">192.168.0.100:80</span></span> wlc -&gt; <span class="hljs-number"><span class="hljs-number">172.16.0.1:80</span></span> Route <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">172.16.0.2:80</span></span> Route <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> UDP <span class="hljs-number"><span class="hljs-number">192.168.0.100:53</span></span> wlc -&gt; <span class="hljs-number"><span class="hljs-number">172.16.0.1:53</span></span> Route <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">172.16.0.2:53</span></span> Route <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Here you can see how requests are distributed between the cluster nodes: there are two active connections that are being processed at the moment and 6 already processed connections. </p><br><p>  Statistics on all connections passing through LVS can be viewed as: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ipvsadm</span></span> -Lnc</code> </pre> <br><p>  Result: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">IPVS</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">connection</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">entries</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pro</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">expire</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">state</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">source</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">virtual</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">destination</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TCP</span></span> 14<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ESTABLISHED</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59474</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TCP</span></span> 01<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:49</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FIN_WAIT</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59464</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TCP</span></span> 01<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:43</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FIN_WAIT</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59462</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TCP</span></span> 14<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ESTABLISHED</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59476</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TCP</span></span> 01<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FIN_WAIT</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59468</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TCP</span></span> 01<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FIN_WAIT</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59472</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TCP</span></span> 01<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:50</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FIN_WAIT</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59466</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TCP</span></span> 01<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:43</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FIN_WAIT</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59460</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:80</span></span></code> </pre> <br><p>  Here, respectively, we see the same thing: 2 active and 6 inactive compounds. </p><br><h4 id="posleslovie">  <strong>AFTERWORD:</strong> </h4><br><p>  The proposed configuration can serve as a starting point for designing a private solution for a specific project with its own requirements and peculiarities. </p><br><p>  If you have any questions about the article or something seemed controversial - please leave your comments, we will be happy to discuss. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/326400/">https://habr.com/ru/post/326400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326390/index.html">Why did it take 100 years to find the exact value of the Planck constant?</a></li>
<li><a href="../326392/index.html">VR development methodology</a></li>
<li><a href="../326394/index.html">Why use static types in javascript? (Advantages and disadvantages)</a></li>
<li><a href="../326396/index.html">Besides science: what else are our students interested in?</a></li>
<li><a href="../326398/index.html">How we build lean manufacturing (Lean) in our company</a></li>
<li><a href="../326402/index.html">Five principles for creating a secure "connected" car</a></li>
<li><a href="../326404/index.html">Why do some startups win</a></li>
<li><a href="../326406/index.html">Visualization of simple geometry in WPF</a></li>
<li><a href="../326408/index.html">Ubuntu 17.04: what's new</a></li>
<li><a href="../326410/index.html">Courier client interaction and scaling service</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>