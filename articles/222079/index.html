<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Caching all HTML and connecting JS ‚Äúon the go‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once I did a terrible thing - I looked at the source code of the Yandex main page and thought about something wrong here. I see 5 latest news headline...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Caching all HTML and connecting JS ‚Äúon the go‚Äù</h1><div class="post__text post__text-html js-mediator-article">  Once I did a terrible thing - I looked at the source code of the <a href="http://yandex.ru/">Yandex</a> main page and thought about something wrong here.  I see 5 latest news headlines, a few pictures, a search field, a link, and this is the question: <br>  Where is the 700Kb, which require 1.56s of my time?  (according to Safari 7.0.3 Web Inspector) <br><br>  We all go through the sites, get kilobytes of useful information for ourselves or generally perceived by a person and spend at that speed of 3 Mbit / s seconds.  In this post I will try to describe how you can transfer only the kilobyte that a person needs, and everything else is either cached or only loaded when needed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d88/34a/1ee/d8834a1ee0c5235ac78046d44ec1e253.png" alt="image"><br><a name="habracut"></a><br><h4>  First in line for optimization - HTML </h4><br>  It would be nice to cache all HTML or at least most of it - you can use block caching for this: we divide the page into blocks and put these blocks into a separate JS file, which the user then remains.  The advantage of this approach is simplicity, but in our case there will be a non-trivial solution - everything needs to be improved a little. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A page can not just be divided into blocks, and everything in the body can be replaced with an XML structure, observing all parenting relationships - radically and efficiently.  No styles and frills.  For example, take the Yandex code to display 5 news: <br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"b-tabs__items"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tabs088905610376_0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"b-news-list"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"b-news-list__item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"b-news-list__item_num"</span></span></span><span class="hljs-tag">&gt;</span></span>1.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span>    <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"b-news-list__item-link"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://news.yandex.ru/yandsearch?cl4url=www.rg.ru%2F2014%2F05%2F06%2Fserdukov-anons.html&amp;lang=ru&amp;lr=172"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onmousedown</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cp('v12.news.news.links.1',this)"</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  It turned out the following: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">news</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tab</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ids</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tabs088905610376_0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">newsr</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pre</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://news.yandex.ru/yandsearch?cl4url=www.rg.ru%2F2014%2F05%2F06%2Fserdukov-anons.html&amp;lang=ru&amp;lr=172"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onmd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cp('v12.news.news.links.1',this)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ahr</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"   "</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tab</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">news</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Each news item now becomes one tag.  If we present the whole page in a similar way, then we‚Äôll get just some kind of a mixture of HTML and XML, you can call it [X] HTML, because in fact it is HTML, only now it is extensible - in the truest sense of the word.  Suppose a page is represented in XML, now for each block I add its template to the JS file - how it should look like in reality.  By analogy with PHP, I selected '$' in templates for variables that should be taken from attributes and $ HTML $ - innerHTML tag. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> news=<span class="hljs-string"><span class="hljs-string">'&lt;div class="b-tabs__items"&gt;$HTML$&lt;/div&gt;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tab=<span class="hljs-string"><span class="hljs-string">'&lt;div id="$ids$"&gt;&lt;ul class="b-news-list"&gt;$HTML$&lt;/ul&gt;&lt;/div&gt;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newsr=<span class="hljs-string"><span class="hljs-string">'&lt;li class="b-news-list__item"&gt;&lt;span class="b-news-list__item_num"&gt;$num$.&lt;/span&gt; $pre$ &lt;a class="b-news-list__item-link" href="$src$" onmousedown="$onmd$"&gt;$ahr&lt;/a&gt;&lt;/li&gt;'</span></span>;</code> </pre><br><br>  The result is that all HTML is placed in the JS file, and on the page itself only what the user needs is, but this is only half the story, because the main page traffic, in addition to images, is JS. <br><br><h4>  JS Optimization </h4><br>  If the JS file weighs 100-200Kb, then its download is about 0.5s.  It will load and remain in the cache, but the delay before its execution will still remain - this is due to the fact that the JS file is first loaded, then the whole is analyzed and only after that it starts to run.  This feature allows, for example, to call a function before it is declared.  The larger the file - the longer the analysis, up to 300ms, and sometimes more.  There is a very good way to shorten the time - to make the file discrete: split it into separate functions or just parts and connect them when they are needed.  They will also be cached, only the time of their analysis will be much less - within 1-2ms. <br><br>  Suppose we have a function that connects JS files in real time, for example, like this: <br><br><pre> <code class="javascript hljs">inc({ <span class="hljs-comment"><span class="hljs-comment">//  /  name:'id' ‚Äì name-  ( ), id-   },function() { //JS       });</span></span></code> </pre><br><br>  For her, there are several requirements.  Firstly, it must remember already connected functions and files, secondly it must support loading from different directories, as well as be asynchronous.  To specify a directory, you can use the global variable includesrc = ‚Äú <a href="http://xn--80abybgtwk5h.xn--p1ag/%25D0%25BA%25D0%25B0%25D1%2582%25D0%25B0%25D0%25BB%25D0%25BE%25D0%25B3/">any site.ru / directory</a> ‚Äù for connecting files and ‚Äú <a href="http://xn--80abybgtwk5h.xn--p1ag/%25D0%25BA%25D0%25B0%25D1%2582%25D0%25B0%25D0%25BB%25D0%25BE%25D0%25B3/%25D1%2584%25D1%2583%25D0%25BD%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F_">any site.ru / directory / function_</a> ‚Äù for functions ‚Äî id (postfix) will be added to this path.  Suppose you need to split a file into several parts or functions, then the resulting files should be something like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,  ludes["id"]=function(a1, .., aN){ // } //  : // (   ) ludes["id"]++;//id -   ,  </span></span></code> </pre><br><br>  Thus, in the file with the function the part of the file name must be indicated, and when the file is connected, its name must be indicated, but without the extension. <br><br><h4>  Ess </h4><br>  I wrote above how you can render all HTML and cache, transfer only the necessary information in XML, then it is written how you can reduce the delay before executing JS to a few milliseconds, but there is no solution to the problem - <a href="http://fous.name/ess">this is</a> it.  It can be called ESS - Easy Stylesheets, similar to CSS.  Consists of 2 + 1 functions.  For ESS there is <a href="http://fous.name/ess/documentation.php">documentation</a> in which syntax and illustrative examples of use are described. <br><br>  Auxiliary function g (a, b, c);  - Searches object by CSS lines of view.  a - with which tag / # id / @ name / .class to search for an object, b - in which object to search for and with - the flag 0/1, indicating whether it is necessary in any case to return an array. <br><br>  ess (a, b, ch, f);  - the function that replaces the XML blocks on the page with templates from the JS file, it must pass a - the DOM element and b - the pattern string, ch - the character that highlights the variables and f - the function to be called after completion.  For the example above, this is: <br><pre> <code class="javascript hljs">ess(g(<span class="hljs-string"><span class="hljs-string">'newsr'</span></span>), newsr, <span class="hljs-string"><span class="hljs-string">'$'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ess(g(<span class="hljs-string"><span class="hljs-string">'tab'</span></span>), tab, <span class="hljs-string"><span class="hljs-string">'$'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ess(g(<span class="hljs-string"><span class="hljs-string">'news'</span></span>), news); });});</code> </pre><br><br>  inc ();  - a function that allows you to asynchronously connect any file from any domain and then continue working.  It should dwell on it.  Here is an example from the file connection documentation: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   includesrc='http://fous.name/ess/';//   inc({ file1:'file1.js' }, function() { ggg(); }); // file1.js function ggg() { alert('       .'); } ludes["file1"]++;</span></span></code> </pre><br>  Specifies the full path to the directory and the file name - very similar to require.js.  The difference is that you can connect not only files, but also functions: <br><pre> <code class="javascript hljs">includesrc=<span class="hljs-string"><span class="hljs-string">'http://fous.name/ess/function_'</span></span>; inc({ <span class="hljs-attr"><span class="hljs-attr">goodjob</span></span>:<span class="hljs-string"><span class="hljs-string">'1'</span></span><span class="hljs-comment"><span class="hljs-comment">// "1" - ,      ludes    }, function() { goodjob();//   }); //  function_1.js ludes["1"]=function(){alert('    .');}</span></span></code> </pre><br>  This is also an example from the documentation, but not one example shows the advantages of using this approach - it requires a good Demo and a detailed comparative analysis, which will be in the next article.  In it, I will try to take into account all your advice and comments, since this is only my first article - from the sandbox. </div><p>Source: <a href="https://habr.com/ru/post/222079/">https://habr.com/ru/post/222079/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222061/index.html">Working with external device registers in the C language, part 3</a></li>
<li><a href="../222063/index.html">The TinkerForge do-it-yourself kit will make your home more comfortable</a></li>
<li><a href="../222065/index.html">Light controllers with AngularJS</a></li>
<li><a href="../222067/index.html">Own impressions and review NAS Synology DS214</a></li>
<li><a href="../222077/index.html">Java 8, Spring, Hibernate, SSP - we start playing</a></li>
<li><a href="../222083/index.html">Down with the shackles of MongoDB</a></li>
<li><a href="../222085/index.html">Turning a conventional electric convector into a wireless</a></li>
<li><a href="../222089/index.html">Investigation of manipulations with the control panel. Part 2</a></li>
<li><a href="../222099/index.html">Clean sheet problem</a></li>
<li><a href="../222101/index.html">Mirrorless cameras and the law of computer power</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>