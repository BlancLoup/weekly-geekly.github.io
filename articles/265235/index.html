<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sony PlayStation 4 security analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since no public statements about the PS4 hacking have been received for a long time, it is time to break the silence and tell a little about how far t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sony PlayStation 4 security analysis</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/91a/e48/7df/91ae487dfe252271b1a67a06d82ce97a.jpg" alt="image"></div><br>  Since no public statements about the PS4 hacking have been received for a long time, it is time to break the silence and tell a little about how far the progress has been with regard to the PS4 hacking, as well as about the reasons that prevent further progress. <br><br>  In this article, I will touch on some of the security principles that apply to all modern systems, as well as share my findings made through the implementation of <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25BE%25D0%25B7%25D0%25B2%25D1%2580%25D0%25B0%25D1%2582%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">ROP tests</a> on my PS4. <br><br>  If you are not familiar with the use of exploits, you should first read <a href="http://cturt.github.io/DS-exploit-finding.html">my last article</a> on hacking DS games using stack integrity vulnerabilities in save files. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Download everything you need for your own experiments <a href="https://github.com/CTurt/PS4-playground">here</a> , currently only firmware 1.76 is supported. <br><a name="habracut"></a><br><h2>  <font color="#2284BE">PS4 Known Facts</font> </h2><br><blockquote>  As you most likely know, the PS4 uses a special eight-core x86-64 CPU from AMD, about the architecture of which quite a lot of research has been published, and even if this particular version of the processor is slightly different from the generally accepted standard, it will hardly be noticeable.  For example, PFLA ( <i>Page Fault Liberation Army</i> ) at 29C3 ( <i>29th Chaos Communication Congress</i> ) showed proof of a <i>proof-of-concept</i> that you can implement a full Turing machine using only page faults ( <i>page fault</i> ) and x86 MMU, the video is available on YouTube .  It will be interesting to those who, having run the code in a virtual machine, at the same time want to execute instructions on the host CPU. </blockquote>  <i><a href="http://www.eurasia.nu/modules.php%3Fname%3DNews%26file%3Darticle%26sid%3D3251%26mode%3D%26order%3D0%26thold%3D0">EurAsia news article numbered 3251</a></i> <br><br>  And we are dealing not only with a well-documented CPU architecture - the <a href="https://en.wikipedia.org/wiki/PlayStation_4_system_software">software</a> used in <a href="https://en.wikipedia.org/wiki/PlayStation_4_system_software">PS4</a> mostly belongs to <a href="http://www.scei.co.jp/ps4-license/">open source</a> . <br><br>  For us, the most important thing is that Orbis OS, on which the console runs, is based on FreeBSD and uses separate parts of NetBSD, repeating the situation with PS3 in this regard;  in addition to FreeBSD 9.0, <a href="http://www.mono-project.com/docs/advanced/runtime/">Mono VM</a> and <a href="https://www.webkit.org/">WebKit</a> are used from other notable major software. <br><br><h2>  <font color="#2284BE">Entry Point - WebKit</font> </h2><br>  WebKit is an open engine for rendering web pages in browsers for iOS, Wii U, 3DS, PS Vita and PS4. <br><br>  Despite such widespread use and maturity of the project, WebKit is not devoid of individual vulnerabilities;  You can learn about most of them from the <a href="https://en.wikipedia.org/wiki/Pwn2Own">Pwn2Own</a> entries. <br><br>  In particular, the browser in PS4 with firmware 1.76 uses a version of WebKit vulnerable to <a href="https://www.exploit-db.com/exploits/28081/">CVE-2012-3748</a> , a buffer overflow in the <i>heap-based buffer overflow</i> data area in the <code>JSArray::sort(...)</code> method. <br><br>  In 2014, nas and Proxima stated that they were able to <a href="http://wololo.net/talk/viewtopic.php%3Fp%3D368577">successfully port this exploit</a> for use on the PS4 browser, and put the PoC code in public, which initiated the PS4 hacking process. <br><br>  This code gives random access to reading and writing everything that the WebKit process can read / write, and this in turn can be used to dump modules and overwrite return addresses on the stack, allowing us to establish control over the instruction counter (for ROP). <br><br>  Since then, <a href="http://wololo.net/2015/04/22/new-webkit-exploit-found-vita-maybe-playstation-4/">many other vulnerabilities</a> have been discovered <a href="http://wololo.net/2015/04/22/new-webkit-exploit-found-vita-maybe-playstation-4/">in WebKit</a> , which presumably allow dumping modules and ROPs on the latest PS4 firmware, but at the time of writing none of these exploits were ported to PS4. <br><br><h2>  <font color="#2284BE">What is ROP (return oriented programming)?</font> </h2><br>  Unlike primitive devices like <a href="http://cturt.github.io/exploits.html">DS</a> and PSP, the PS4 uses a kernel that controls the options of different memory areas.  Memory pages that are marked as executable cannot be overwritten;  pages marked as recordable cannot be executed;  This principle is known as <a href="https://en.wikipedia.org/wiki/Data_Execution_Prevention">Data Execution Prevention (DEP)</a> . <br><br>  For us, this means the impossibility of using a simple path: copying the payload into the memory and its subsequent execution.  However, we can execute code that is already loaded into memory and marked as executable. <br><br>  By itself, the possibility of jumping to the same address does not bear any particular benefit if we cannot write our own code at this address - that is why we will resort to ROP. <br><br>  <a href="https://en.wikipedia.org/wiki/Return-oriented_programming">Return-oriented programming (ROP)</a> is just an enhanced version of the traditional ‚Äústack smashing‚Äù (buffer overflow attack), but instead of overwriting a single value that a PC will jump to, we can link together many different addresses known as ‚Äúgadgets‚Äù <br><br>  Usually, a gadget is just the only desired construction, followed by <code>ret</code> . <br><br>  In x86_64 assembler, when execution reaches the <code>ret</code> instruction, the 64-bit value is pushed out of the stack and the PC jumps onto it;  since we can control the stack, we can force each <code>ret</code> instruction to jump to the next necessary gadget. <br><br>  For example, starting from <code>0x80000</code> instructions can be stored: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mov</span></span> rax, <span class="hljs-number"><span class="hljs-number">0</span></span> ret</code> </pre> <br>  And starting from <code>0x90000</code> following instructions are stored: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mov</span></span> rbx, <span class="hljs-number"><span class="hljs-number">0</span></span> ret</code> </pre> <br>  If we rewrite the return address on the stack so that it <code>0x80000</code> and then <code>0x90000</code> , then as soon as the execution reaches the first <code>ret</code> instruction, it will jump to <code>mov rax, 0</code> , and immediately after this the next <code>ret</code> will <code>0x90000</code> from the stack <code>0x90000</code> and jump to <code>mov rbx, 0</code> . <br><br>  Thus, this chain will play into our hands and set both the <code>rax</code> and <code>rbx</code> to 0, as if we simply wrote the code in one place and executed it sequentially. <br><br>  ROP chains are not limited to a list of addresses;  Suppose that the following instructions go from <code>0xa0000</code> : <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> rax ret</code> </pre> <br>  We can set the first element of the chain to <code>0xa0000</code> and the next element to any desired value for <code>rax</code> . <br><br>  Gadgets also do not need to end on <code>ret</code> instructions;  we can use <code>jmp</code> terminated gadgets: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rax, <span class="hljs-number"><span class="hljs-number">8</span></span> jmp rcx</code> </pre> <br>  By making <code>rcx</code> point to a <code>ret</code> instruction, the chain will execute in the usual way: <br><br><pre> <code class="hljs cs">chain.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rcx"</span></span>, <span class="hljs-string"><span class="hljs-string">"ret"</span></span>); chain.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"add rax, 8; jmp rcx"</span></span>);</code> </pre> <br>  Sometimes you will not be able to find exactly the gadget that you need, by itself - only with other instructions after it.  For example, if you want to set <code>r8</code> to some value, but you only have this gadget, then you have to set <code>r9</code> to some dummy value: <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> r8 <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> r9 ret</code> </pre> <br>  Although from time to time you will have to show your creative abilities when writing ROP chains, nevertheless, it is considered that using a sufficiently large code dump of the gadgets will be sufficient for full Turing functionality;  this makes ROP a viable DEP bypass method. <br><br><h2>  <font color="#2284BE">Gadget Search</font> </h2><br>  The following metaphor will help you understand ROP. <br><br>  Imagine that you are writing a new chapter in a book, while using only those words that stood at the end of the sentences in previous chapters.  Obviously, by virtue of the principles of constructing phrases, you can hardly find the words ‚Äúand‚Äù or ‚Äúor‚Äù at the end of one of the sentences ‚Äî but we will need these connecting elements if we want to write something meaningful. <br><br>  It is possible, however, that one of the sentences ended on the word "sand".  And, although according to the author's intention, we must read this word entirely starting with the letter ‚Äús‚Äù, if we begin our reading with ‚Äúa‚Äù, then by <i>pure chance</i> we will get a completely different word - ‚Äúand‚Äù, which is what we needed. <br><br>  These principles also apply to ROP. <br><br>  Since the structure of almost all functions looks like this: <br><pre> <code class="hljs perl">;   <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> rbp mov rbp, rsp <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> r15 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> r14 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> r13 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> r12 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> rbx <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rsp</span></span></span><span class="hljs-function">, 18</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function"> </span></span>;   ;   add rsp, <span class="hljs-number"><span class="hljs-number">18</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> rbx <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> r12 <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> r13 <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> r14 <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> r15 <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> rbp ret</code> </pre> <br>  Therefore, we should expect the discovery of only <code>pop</code> gadgets, or, more rarely, <code>xor rax, rax</code> , which set the value to 0 before returning. <br><br>  Comparison like <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">cmp</span></span> [rax], r12 ret</code> </pre> <br>  does not make any sense, since the result of the comparison is not used by the function.  However, the likelihood of finding such gadgets still remains. <br><br>  The x86_64 instructions are similar to words in that they have a variable length, and can mean completely different things depending on where the decoding begins. <br><br><blockquote>  The x86_64 architecture is a variable-length CISC instruction set.  Return-oriented programming on x86_64 takes advantage of the fact that the instruction set is very ‚Äúdense‚Äù - in the sense that any arbitrary sequence of bytes can most often be interpreted as a valid x86_64 instruction set. </blockquote><br>  <i>- Wikipedia</i> <br><br>  To demonstrate this, take a look at the end of this function from the WebKit module: <br><br><pre> <code class="hljs css">000000000052<span class="hljs-selector-tag"><span class="hljs-selector-tag">BE0D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rdx+8]</span></span> 000000000052<span class="hljs-selector-tag"><span class="hljs-selector-tag">BE10</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsi+10h]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> 000000000052<span class="hljs-selector-tag"><span class="hljs-selector-tag">BE13</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">or</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsi+39h]</span></span>, 20<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> 000000000052<span class="hljs-selector-tag"><span class="hljs-selector-tag">BE17</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  Now take a look at what the code will look like if we start decoding from <code>0x52be14</code> : <br><pre> <code class="hljs css">000000000052<span class="hljs-selector-tag"><span class="hljs-selector-tag">BE14</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r12</span></span> 000000000052<span class="hljs-selector-tag"><span class="hljs-selector-tag">BE17</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  Even if this code was never intended to be executed, it is located in the memory area marked ‚Äúexecutable‚Äù, which makes it very attractive for use as a gadget. <br><br>  Of course, it would be incredibly costly to spend time searching for all possible ways of interpreting the code before each <code>ret</code> instruction manually;  existing utilities can do this for us.  To search for ROP gadgets, I prefer to use <a href="https://github.com/0vercl0k/rp/">rp ++</a> ;  to generate a text file filled with gadgets, just enter the command: <br><br><pre> <code class="hljs pgsql">rp-win-x64 -f mod14.bin <span class="hljs-comment"><span class="hljs-comment">--raw=x64 --rop=1 --unique &gt; mod14.txt</span></span></code> </pre> <br><br><h2>  <font color="#2284BE">Segmentation errors</font> </h2><br>  If we try to execute a non-executable page of memory, or try to write to a non-writable page of memory, a segmentation error will occur. <br><br>  For example, this is an attempt to execute code on a stack that is read-only and write-only (rw): <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">setU8to</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">chain</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.data</span></span> + 0, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xeb</span></span>); <span class="hljs-selector-tag"><span class="hljs-selector-tag">setU8to</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">chain</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.data</span></span> + 1, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfe</span></span>); <span class="hljs-selector-tag"><span class="hljs-selector-tag">chain</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.add</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">chain</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.data</span></span>);</code> </pre> <br>  And so - an attempt to write code that is "mamapped" only for reading and execution (rx): <br><br><pre> <code class="hljs lisp">setU8to(<span class="hljs-name"><span class="hljs-name">moduleBases</span></span>[webkit], <span class="hljs-number"><span class="hljs-number">0</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  If a segmentation error occurs, the message ‚ÄúNot enough free system memory‚Äù appears on the screen, and the page will not load: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/576/a2e/390/576a2e3907a0599b8e93e9c0e3f356c6.png" alt="image"></div><br>  The reason for the output of this message may be something else - for example, the execution of a wrong instruction or an unrealized system call - but most often it gets out because of a segmentation error. <br><br><h2>  <font color="#2284BE">ASLR</font> </h2><br>  <a href="https://ru.wikipedia.org/wiki/Address_Space_Layout_Randomization">Address Space Layout Randomization</a> (ASLR) is a security technology used in operating systems, which randomly changes the location of important structures in the process address space, namely, the image of the executable file, loadable libraries, heaps and stacks.  Because of her, the base addresses of the modules change each time you launch your PS4. <br><br>  I received evidence that <a href="https://www.youtube.com/watch%3Fv%3DaEu208625XA">in the oldest versions of the firmware (1.05), the ASLR was disabled</a> , but it appeared somewhere around 1.70.  Note that the ASLR is disabled for the kernel, at least for firmware versions 1.76 and below, and this will be proved further. <br><br>  For most exploits, ASLR will be a problem, because if you don‚Äôt know the addresses of gadgets in memory, you won‚Äôt guess what you need to write to the stack. <br><br>  Fortunately for us, we are not limited to writing static ROP chains.  We can use JavaScript to read the module table, which will help us get the base addresses of the loaded modules.  Using these addresses, we can calculate the addresses of all our gadgets before executing the ROP chain, bypassing the ASLR. <br><br>  The module table also includes the module file names: <br><ul><li>  WebProcess.self </li><li>  libkernel.sprx </li><li>  libSceLibcInternal.sprx </li><li>  libSceSysmodule.sprx </li><li>  libSceNet.sprx </li><li>  libSceNetCtl.sprx </li><li>  libSceIpmi.sprx </li><li>  libSceMbus.sprx </li><li>  libSceRegMgr.sprx </li><li>  libSceRtc.sprx </li><li>  libScePad.sprx </li><li>  libSceVideoOut.sprx </li><li>  libScePigletv2VSH.sprx </li><li>  libSceOrbisCompat.sprx </li><li>  libSceWebKit2.sprx </li><li>  libSceSysCore.sprx </li><li>  libSceSsl.sprx </li><li>  libSceVideoCoreServerInterface.sprx </li><li>  libSceSystemService.sprx </li><li>  libSceCompositeExt.sprx </li></ul><br>  Despite the fact that the PS4 mostly uses the [Signed] PPU Relocatable Executable ([S] PRX) format for modules, lines that refer to the [Signed] Executable and Linking Format ([S] ELF) object files are seen in the libSceSysmodule.sprx dump. ) - bdj.elf, web_core.elf and orbis-jsc-compiler.self. <br><br>  This combination of modules and objects resembles the one used in the PSP and PS3. <br><br>  A complete <a href="http://www.psdevwiki.com/ps4/Libraries">list of all available modules</a> (and not only those that are loaded by the browser) is available in <code>libSceSysmodule.sprx</code> .  We can download and dump some of them thanks to several special system calls for Sony authorship, which will be discussed further. <br><br><h2>  <font color="#2284BE">JuSt-ROP</font> </h2><br>  Using JavaScript to write and execute dynamic ROP chains gives us a huge advantage over the usual buffer overflow attack. <br><br>  In addition to the ASLR bypass, we can read the browser user agent, and substitute another ROP chain for another browser version, giving our exploit the highest possible compatibility level. <br><br>  We can even use javascript to read the memory of our gadget addresses in order to make sure they are correct, which gives us almost perfect reliability. <br><br>  Dynamic writing of ROP chains acquires meaning compared to their preliminary generation by the script. <br><br>  For these reasons, I created my own JavaScript framework for writing ROP chains, <a href="https://github.com/CTurt/JuSt-ROP">JuSt-ROP</a> . <br><br><h2>  <font color="#2284BE">JavaScript pitfalls</font> </h2><br>  JavaScript uses the double-precision (64-bit) <a href="https://en.wikipedia.org/wiki/IEEE_floating_point">IEEE-754</a> representation of numbers.  This gives us 53 bits of precision (the VT_R8 mantissa has only 53 bits), which means that it is impossible to display every 64-bit value ‚Äî for some of them, you will have to apply an approximation. <br><br>  If you just need to set a 64-bit number to some small value, like <code>256</code> , then <code>setU64to</code> will cope with the task.  But for cases when you need to write a buffer or data structure, there is a possibility that individual bytes will be written incorrectly if they were written in blocks of 64 bits.  Instead, you must write data in 32-bit blocks (remembering that the PS4 uses little-endian order) to make sure that each byte is identical. <br><br><h2>  <font color="#2284BE">System calls</font> </h2><br>  Interestingly, PS4 uses the same call format as Linux and MS-DOS for system calls, with arguments stored in registers rather than the traditional UNIX method (which FreeBSD uses by default) when the arguments are stored on the stack: <br><table><tbody><tr><th>  Register </th><th>  Value </th></tr><tr><td>  rax </td><td>  System call number </td></tr><tr><td>  rdi </td><td>  Argument 1 </td></tr><tr><td>  rsi </td><td>  Argument 2 </td></tr><tr><td>  rdx </td><td>  Argument 3 </td></tr><tr><td>  r10 </td><td>  Argument 4 </td></tr><tr><td>  r8 </td><td>  Argument 5 </td></tr><tr><td>  r9 </td><td>  Argument 6 </td></tr></tbody></table><br>  We can try to make any system call using the JuSt-ROP method: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.syscall = function(name, systemCallNumber, arg1, arg2, arg3, arg4, arg5, arg6) { console.log(<span class="hljs-string"><span class="hljs-string">"syscall "</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rax"</span></span>, systemCallNumber); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg1) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rdi"</span></span>, arg1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg2) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rsi"</span></span>, arg2); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg3) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rdx"</span></span>, arg3); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg4) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rcx"</span></span>, arg4); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg5) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop r8"</span></span>, arg5); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg6) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop r9"</span></span>, arg6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rbp"</span></span>, stackBase + returnAddress - (chainLength + <span class="hljs-number"><span class="hljs-number">8</span></span>) + <span class="hljs-number"><span class="hljs-number">0x1480</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"mov r10, rcx; syscall"</span></span>); }</code> </pre> <br><br>  Using system calls can tell us a lot about the PS4 core.  Moreover, the use of system calls is the only way we can interact with the kernel, and can potentially perform a kernel exploit. <br><br>  If you reverse engineer the modules to identify some of the special Sony system calls, you can find an alternative call format: <br><br><table><tbody><tr><th>  Register </th><th>  Value </th></tr><tr><td>  rax </td><td>  0 </td></tr><tr><td>  rdi </td><td>  System call number </td></tr><tr><td>  rsi </td><td>  Argument 1 </td></tr><tr><td>  rdx </td><td>  Argument 2 </td></tr><tr><td>  r10 </td><td>  Argument 3 </td></tr><tr><td>  r8 </td><td>  Argument 4 </td></tr><tr><td>  r9 </td><td>  Argument 5 </td></tr></tbody></table><br><br>  Apparently, Sony has done so for simple compatibility with the function calling convention, for example: <br><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">syscall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, ...)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">register</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> rax </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"rax"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">asm</span></span>(<span class="hljs-string"><span class="hljs-string">"mov r10, rcx"</span></span>); rax = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">asm</span></span>(<span class="hljs-string"><span class="hljs-string">"syscall"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rax; }</code> </pre> <br>  Using this approach, they can perform any system call from C. <br>  When writing ROP chains, we can use the following convention: <br><br><pre> <code class="hljs pgsql">//    ID  : chain.syscall("getpid", <span class="hljs-number"><span class="hljs-number">20</span></span>); chain.syscall("getpid", <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>);</code> </pre> <br><br>  This is useful to remember if you can choose the most convenient of the available gadgets. <br><br><h2>  <font color="#2284BE">getpid</font> </h2><br>  A single system call number <code>20</code> , <code>getpid(void)</code> , is already able to tell us a lot about the kernel. <br><br>  The very fact that this system call works tells us that Sony did not even bother to mix the system call numbers, as required by the <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25B5%25D0%25B7%25D0%25BE%25D0%25BF%25D0%25B0%25D1%2581%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C_%25D1%2587%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B7_%25D0%25BD%25D0%25B5%25D1%258F%25D1%2581%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">security through obscurity</a> technique (and under the BSD license they could do it without publishing new system numbers on the Internet calls). <br><br>  Thus, we automatically got our hands on a <a href="http://fxr.watson.org/fxr/source/kern/syscalls.master%3Fv%3DFREEBSD9">list of system calls</a> that you can try to make in the PS4 core. <br><br>  Second, by calling <code>getpid()</code> , restarting the browser, and then calling it again, we will get a return value 1 greater than the previous one.  Although FreeBSD has been supporting <a href="http://security.stackexchange.com/questions/88692/do-randomized-pid-bring-more-security">PID randomization</a> since version 4.0, consistent PID allocation is the default behavior.  Apparently, Sony did not bother to strengthen the protection here, like it was done in projects like <a href="https://hardenedbsd.org/">HardenedBSD</a> . <br><br><h2>  <font color="#2284BE">How many system calls are there?</font> </h2><br>  The last system call on FreeBSD 9 is <code>wait6</code> number <code>523</code> ;  all that has the number above - special system calls Sony. <br><br>  Attempting to call any of the special Sony system calls without valid arguments will return error <code>0x16</code> , <code>"Invalid argument"</code> ;  however, any compatible system calls, or unrealized system calls, will result in the error <code>"There is not enough free system memory"</code> . <br><br>  Through trial and error, I found out that the system call number <code>617</code> is the last call by Sony, all calls are not implemented further. <br><br>  Based on this, we can make a logical conclusion that in the PS4 core there are 85 special system calls (617-532) authored by Sony. <br><br>  This is significantly less than in the PS3, in which there were almost 1000 system calls in general.  Well, even if this indicates less room for potential attack vectors, it will be easier for us to document all the challenges. <br><br>  We go further.  9 of these 85 system calls always return 0x4e, ENOSYS, which means a simple thing - these calls work only on test devices for developers, leaving us with just 76 useful calls. <br><br>  Of these 76, libkernel.sprx refers only to 45 (all applications that are not part of the kernel use this module to make system calls).  Total, the developer has only 45 available special system calls. <br><br>  Interestingly, although only 45 calls were intended for use (since there are wrappers for them in libkernel.sprx), some of the remaining 31 are still accessible from the browser process.  It is possible that in these unintentionally abandoned calls the likelihood of finding a vulnerability is much higher, since it took the least time to test them. <br><br><h2>  <font color="#2284BE">libkernel.sprx</font> </h2><br>  In order to understand how special system calls are used by the kernel, the main thing is to remember that this is just a modification of the standard FreeBSD 9.0 libraries. <br><br>  Here is an excerpt of the <code>_libpthread_init</code> code from the <a href=""><code>thr_init.c</code></a> file: <br><br><pre> <code class="hljs vbscript">/* * Check <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the special <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> of this process running as * <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> place of init as pid = <span class="hljs-number"><span class="hljs-number">1</span></span>: */ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((_thr_pid = getpid()) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { /* * Setup a <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> session <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> this process which <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> * assumed <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> be running as root. */ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setsid() == <span class="hljs-number"><span class="hljs-number">-1</span></span>) PANIC(<span class="hljs-string"><span class="hljs-string">"Can't set session ID"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (revoke(_PATH_CONSOLE) != <span class="hljs-number"><span class="hljs-number">0</span></span>) PANIC(<span class="hljs-string"><span class="hljs-string">"Can't revoke console"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((fd = __sys_open(_PATH_CONSOLE, O_RDWR)) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) PANIC(<span class="hljs-string"><span class="hljs-string">"Can't open console"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setlogin(<span class="hljs-string"><span class="hljs-string">"root"</span></span>) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) PANIC(<span class="hljs-string"><span class="hljs-string">"Can't set login to root"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_ioctl(fd, TIOCSCTTY, (char *) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) PANIC(<span class="hljs-string"><span class="hljs-string">"Can't set controlling terminal"</span></span>); }</code> </pre> <br>  The same function can be found on offset <code>0x215F0</code> from <code>libkernel.sprx</code> .  Here‚Äôs how the code above looks in the libkernel dump: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">call</span></span> getpid mov cs:dword_5B638, eax cmp eax, <span class="hljs-number"><span class="hljs-number">1</span></span> jnz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> loc_2169F <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> setsid cmp eax, <span class="hljs-number"><span class="hljs-number">0</span></span>FFFFFFFFh jz loc_21A0C lea rdi, aDevConsole ; "/dev/console" <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">revoke</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> eax, eax jnz loc_21A24 lea rdi, aDevConsole ; "/dev/console" mov esi, 2 xor al, al <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> mov r14d, eax <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> r14d, r14d js loc_21A3C lea rdi, aRoot ; "root" <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> setlogin cmp eax, <span class="hljs-number"><span class="hljs-number">0</span></span>FFFFFFFFh jz loc_21A54 mov edi, r14d mov esi, <span class="hljs-number"><span class="hljs-number">20007461</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> edx, edx <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> al, al <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ioctl cmp eax, <span class="hljs-number"><span class="hljs-number">0</span></span>FFFFFFFFh jz loc_21A6C</code> </pre> <br><br><h2>  <font color="#2284BE">Reversing dumps of modules for analyzing system calls</font> </h2><br>  libkernel is not fully open: it includes a large number of Sony‚Äôs own code that could uncover their system calls. <br><br>  Although the analysis process will differ depending on the selected system call, for some of them it is quite easy to figure out the composition of the arguments that are passed to the call. <br><br>  The system call wrapper will be declared somewhere in libkernel.sprx and will almost always follow the following pattern: <br><pre> <code class="hljs mel"><span class="hljs-number"><span class="hljs-number">000000000000</span></span>DB70 syscall_601 <span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> near <span class="hljs-number"><span class="hljs-number">000000000000</span></span>DB70 mov rax, <span class="hljs-number"><span class="hljs-number">259</span></span>h <span class="hljs-number"><span class="hljs-number">000000000000</span></span>DB77 mov r10, rcx <span class="hljs-number"><span class="hljs-number">000000000000</span></span>DB7A syscall <span class="hljs-number"><span class="hljs-number">000000000000</span></span>DB7C jb short <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> <span class="hljs-number"><span class="hljs-number">000000000000</span></span>DB7E retn <span class="hljs-number"><span class="hljs-number">000000000000</span></span>DB7F <span class="hljs-number"><span class="hljs-number">000000000000</span></span>DB7F <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>: <span class="hljs-number"><span class="hljs-number">000000000000</span></span>DB7F lea rcx, sub_DF60 <span class="hljs-number"><span class="hljs-number">000000000000</span></span>DB86 jmp rcx <span class="hljs-number"><span class="hljs-number">000000000000</span></span>DB86 syscall_601 endp</code> </pre> <br>  Note that the instruction <code>mov r10, rcx</code> does not necessarily mean that the system call takes at least 4 arguments;  This instruction is available for all system call wrappers, and even for those that do not take any arguments ‚Äî for example, <code>getpid</code> . <br><br>  Once you have found the wrapper, you can look at the xrefs to it: <br><br><pre> <code class="hljs sql">0000000000011D50 mov edi, 10h 0000000000011D55 xor esi, esi 0000000000011D57 mov edx, 1 0000000000011D5C <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> syscall_601 <span class="hljs-number"><span class="hljs-number">0000000000011</span></span>D61 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> eax, eax <span class="hljs-number"><span class="hljs-number">0000000000011</span></span>D63 jz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> loc_11D6A</code> </pre> <br><br>  A good idea would be to look for a few more pieces, just to make sure that the registers were not changed for something unrelated: <br><pre> <code class="hljs sql">0000000000011A28 mov edi, 9 0000000000011A2D xor esi, esi 0000000000011A2F xor edx, edx 0000000000011A31 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> syscall_601 <span class="hljs-number"><span class="hljs-number">0000000000011</span></span>A36 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> eax, eax <span class="hljs-number"><span class="hljs-number">0000000000011</span></span>A38 jz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> loc_11A3F</code> </pre> <br>  ,             (rdi, rsi,  rdx),       ,     . <br><br>  ,         JuSt-ROP: <br><br><pre> <code class="hljs objectivec">chain.syscall(<span class="hljs-string"><span class="hljs-string">"unknown"</span></span>, <span class="hljs-number"><span class="hljs-number">601</span></span>, <span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); chain.syscall(<span class="hljs-string"><span class="hljs-string">"unknown"</span></span>, <span class="hljs-number"><span class="hljs-number">601</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br>     ,    0   ,     ,  <code>jz</code>    <code>test</code>   . <br><br>  -  ,   ,             ,       . <br><br><h2> <font color="#2284BE">  </font> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despite the fact that reverse engineering of module dumps is the most reliable way to identify system calls, some of them are not mentioned in the dumps, so we are forced to analyze them blindly. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we assume that a particular system call can take a specific set of arguments, then we can brute force all system calls that return a specific value (0 for success) with the selected arguments, and ignore all those that returned an error. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We can also transfer zeros for all arguments, and brute force, all system calls that return helpful error like </font></font><code>0xe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>"Bad address"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that indicate that the call is received at least one pointer.</font></font><br><br> -,    ROP-    .           <code>onload</code>  <code>body</code> : <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"exploit()"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>             HTTP GET.         JavaScript,     PHP: <br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Sony = <span class="hljs-number"><span class="hljs-number">533</span></span>; chain.syscall(<span class="hljs-string"><span class="hljs-string">"Sony system call"</span></span>, Sony + <span class="xml"><span class="php"><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span></span><span class="xml"><span class="php"> </span></span><span class="hljs-keyword"><span class="xml"><span class="php"><span class="hljs-keyword">print</span></span></span></span><span class="xml"><span class="php">($_GET[</span></span><span class="hljs-string"><span class="xml"><span class="php"><span class="hljs-string">"b"</span></span></span></span><span class="xml"><span class="php">]); </span></span><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span><span class="xml">, 0, 0, 0, 0, 0, 0); chain.write_rax_ToVariable(0);</span></span></code> </pre> <br>     ,     ,        ,      : <br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(chain.getVariable(<span class="hljs-number"><span class="hljs-number">0</span></span>) == <span class="hljs-number"><span class="hljs-number">0x16</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.assign(<span class="hljs-string"><span class="hljs-string">"index.php?b="</span></span> + (<span class="xml"><span class="php"><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span></span><span class="xml"><span class="php"> </span></span><span class="hljs-keyword"><span class="xml"><span class="php"><span class="hljs-keyword">print</span></span></span></span><span class="xml"><span class="php">($_GET[</span></span><span class="hljs-string"><span class="xml"><span class="php"><span class="hljs-string">"b"</span></span></span></span><span class="xml"><span class="php">]); </span></span><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span><span class="xml"> + 1).toString());</span></span></code> </pre> <br>    ?b=0         Sony. <br><br>       ,   ,       ,     . <br><br><h2> <font color="#2284BE">  538</font> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As an example, let's look at system call 538 without relying on dumps of any modules. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here are the return values ‚Äã‚Äãdepending on what is passed as the first argument:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 - 0x16, "Invalid argument" </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 - 0xe, ‚ÄúBad address‚Äù </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The pointer to 0 is initially 0x64, but with each page refresh the value increases by 1. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other potential arguments that you can try to substitute are the PID, the thread ID, and the file descriptor. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despite the fact that most system calls return 0 when successful, some calls return an incrementing value with each new call ‚Äî apparently, these calls allocate a resource, like a file descriptor. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next step is to monitor the data before and after making a system call in order to understand whether anything has been recorded in it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since there are no changes in the data, we can assume with a clear conscience that this is input.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then try to feed the method a long string as the first argument. </font><font style="vertical-align: inherit;">You should try this with every input that you can detect, since there is a possibility of detecting a buffer overflow.</font></font><br><br><pre> <code class="hljs kotlin">writeString(chain.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-string"><span class="hljs-string">"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span></span>); chain.syscall(<span class="hljs-string"><span class="hljs-string">"unknown"</span></span>, <span class="hljs-number"><span class="hljs-number">538</span></span>, chain.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We obtain as the value of the return </font></font><code>0x3f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>ENAMETOOLONG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Alas, but we see that the system call correctly restricts the name (32 bytes including the terminator </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), but now we know that the method expects a string, not a structure. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, now we have a few ideas on what this challenge can do. The most obvious option is some kind of action related to the file system (for example, a special version </font></font><code>mkdir</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>open</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), but this version is unlikely to suit us - because the resource is allocated before we write any data to the index. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's try to check if the first parameter is a path. We split it up into several characters </font></font><code>/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and see if it will allow a long string to be passed to the method:</font></font><br><br><pre> <code class="hljs kotlin">writeString(chain.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-string"><span class="hljs-string">"aaaaaaaaaa/aaaaaaaaaa/aaaaaaaaaa"</span></span>); chain.syscall(<span class="hljs-string"><span class="hljs-string">"unknown"</span></span>, <span class="hljs-number"><span class="hljs-number">538</span></span>, chain.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since this call also returns 0x3f, we can assume that the first argument is not a path; this is the name for something that will be placed in memory and will get a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sequential identifier</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After analyzing other system calls, I was able to find that all of the following have the same behavior:</font></font><br><ul><li>  533 </li><li>  538 </li><li>  557 </li><li>  574 </li><li>  580 </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using the information received, it is almost impossible to guess what these system calls are doing, but if you run other tests, you will gradually uncover the mystery. </font><font style="vertical-align: inherit;">I will save you some time - system call 538 allocates memory for </font></font><a href="https://en.wikipedia.org/wiki/Event_flag"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the event flag</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (and takes not only the name as a parameter). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With basic knowledge of how the kernel works, you can guess and then check what memory is allocated for system calls ‚Äî semaphores, mutexts, and so on.</font></font><br><br><h2> <font color="#2284BE"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dump additional modules</font></font></font> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We can dump additional modules as follows: </font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Load the module </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Get the base address of the module </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dump the module. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I took on the tedious work of loading and dumping every possible module from the browser with my hands and published the results on </font></font><a href="http://www.psdevwiki.com/ps4/Libraries"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">psdevwiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">All modules with a ‚ÄúYes‚Äù marker can be dumped by this method. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To load the module, we need to use the function </font></font><code>sceSysmoduleLoadModule</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from </font></font><code>libSceSysmodule.sprx + 0x1850</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The first parameter is the identifier of the loadable module, the other three simply pass 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The following JuSt-ROP method is useful for making this call:</font></font><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.call = function(name, module, address, arg1, arg2, arg3, arg4, arg5, arg6) { console.log(<span class="hljs-string"><span class="hljs-string">"call "</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg1) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rdi"</span></span>, arg1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg2) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rsi"</span></span>, arg2); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg3) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rdx"</span></span>, arg3); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg4) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rcx"</span></span>, arg4); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg5) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop r8"</span></span>, arg5); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(arg6) !== <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop r9"</span></span>, arg6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rbp"</span></span>, stack_base + return_va - (chainLength + <span class="hljs-number"><span class="hljs-number">8</span></span>) + <span class="hljs-number"><span class="hljs-number">0x1480</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(module_bases[module] + address); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, for loading we </font></font><code>libSceAvSetting.sprx (0xb)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use:</font></font><br><br><pre> <code class="hljs pgsql">chain.<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>("sceSysmoduleLoadModule", libSysmodule, <span class="hljs-number"><span class="hljs-number">0x1850</span></span>, <span class="hljs-number"><span class="hljs-number">0xb</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Like most system calls, this one should return 0 if successful. </font><font style="vertical-align: inherit;">To see the identifier of the module allocated in memory, we can use one of the Sony system calls at number 592 to get the list of loaded modules:</font></font><br><pre> <code class="hljs pgsql">var countAddress = chain.data; var modulesAddress = chain.data + <span class="hljs-number"><span class="hljs-number">8</span></span>; //   <span class="hljs-number"><span class="hljs-number">592</span></span>, getLoadedModules(<span class="hljs-type"><span class="hljs-type">int</span></span> *destinationModuleIDs, <span class="hljs-type"><span class="hljs-type">int</span></span> max, <span class="hljs-type"><span class="hljs-type">int</span></span> *count); chain.syscall("getLoadedModules", <span class="hljs-number"><span class="hljs-number">592</span></span>, modulesAddress, <span class="hljs-number"><span class="hljs-number">256</span></span>, countAddress); chain.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>() { var count = getU64from(countAddress); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(var <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> &lt; count; <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>++) { logAdd("Module: 0x" + getU32from(modulesAddress + <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span>).toString(<span class="hljs-number"><span class="hljs-number">16</span></span>)); } });</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Running this code without loading other optional modules will display the following list: </font></font><br><pre> <code class="hljs">0x0, 0x1, 0x2, 0xc, 0xe, 0xf, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1e, 0x37, 0x59</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, if we run it after loading the 0xb module, we will see an additional element, 0x65. </font><font style="vertical-align: inherit;">Remember - the module identifier is not the same as the identifier of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loaded</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> module. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we can use another Sony system call number 593, which takes the identifier of the loaded module and the buffer, and fills the buffer with information about the loaded module, including its base address. </font><font style="vertical-align: inherit;">Since the identifier of the loaded module is always 0x65, we can ‚Äúhard-code‚Äù it in our chain, instead of storing the result from the list of modules. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The buffer must start with a structure size to be returned, otherwise, it returns an error </font></font><code>0x16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>"Invalid argument"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><pre> <code class="hljs matlab">setU64to(moduleInfoAddress, <span class="hljs-number"><span class="hljs-number">0x160</span></span>); chain.syscall(<span class="hljs-string"><span class="hljs-string">"getModuleInfo"</span></span>, <span class="hljs-number"><span class="hljs-number">593</span></span>, <span class="hljs-number"><span class="hljs-number">0x65</span></span>, moduleInfoAddress); chain.execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logAdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(hexDump(moduleInfoAddress, 0x160)</span></span></span><span class="hljs-function">); });</span></span></code> </pre> <br>     0,     ,    : <br><br><pre> <code class="hljs delphi"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = readString(moduleInfoAddress + <span class="hljs-number"><span class="hljs-number">0</span></span>x8); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> codeBase = getU64from(moduleInfoAddress + <span class="hljs-number"><span class="hljs-number">0</span></span>x108); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> codeSize = getU32from(moduleInfoAddress + <span class="hljs-number"><span class="hljs-number">0</span></span>x110); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataBase = getU64from(moduleInfoAddress + <span class="hljs-number"><span class="hljs-number">0</span></span>x118); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataSize = getU32from(moduleInfoAddress + <span class="hljs-number"><span class="hljs-number">0</span></span>x120);</code> </pre><br>         ! <br><br><pre> <code class="hljs lisp">dump(<span class="hljs-name"><span class="hljs-name">codeBase</span></span>, codeSize + dataSize)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>     Sony,   608,     593 ,        : <br><br><pre> <code class="hljs lisp">setU64to(<span class="hljs-name"><span class="hljs-name">moduleInfoAddress</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>x1a8)<span class="hljs-comment"><span class="hljs-comment">; chain.syscall("getDifferentModuleInfo", 608, 0x65, 0, moduleInfoAddress); logAdd(hexDump(moduleInfoAddress, 0x1a8));</span></span></code> </pre><br> ,     . <br><br><h2> <font color="#2284BE">  </font> </h2><br>      PS4     FreeBSD 9.0. <br><br> ,         <code>/dev/</code> ,   ‚Äî , <code>/</code> ‚Äî . <br>  ,   ,    <code>gendents</code>  <code>read</code>  ,      : <br><br><pre> <code class="hljs kotlin">writeString(chain.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-string"><span class="hljs-string">"/dev/"</span></span>); chain.syscall(<span class="hljs-string"><span class="hljs-string">"open"</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, chain.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); chain.write_rax_ToVariable(<span class="hljs-number"><span class="hljs-number">0</span></span>); chain.read_rdi_FromVariable(<span class="hljs-number"><span class="hljs-number">0</span></span>); chain.syscall(<span class="hljs-string"><span class="hljs-string">"getdents"</span></span>, <span class="hljs-number"><span class="hljs-number">272</span></span>, undefined, chain.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> + <span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-number"><span class="hljs-number">1028</span></span>);</code> </pre> <br>   : <br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">0000010</span></span>: <span class="hljs-number"><span class="hljs-number">0700</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">0205</span></span> <span class="hljs-number"><span class="hljs-number">6469</span></span> <span class="hljs-number"><span class="hljs-number">7073</span></span> <span class="hljs-number"><span class="hljs-number">7700</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> ........dipsw... <span class="hljs-number"><span class="hljs-number">0000020</span></span>: <span class="hljs-number"><span class="hljs-number">0800</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">0204</span></span> <span class="hljs-number"><span class="hljs-number">6e75</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c6c <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> ........null.... <span class="hljs-number"><span class="hljs-number">0000030</span></span>: <span class="hljs-number"><span class="hljs-number">0900</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">0204</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>a65 <span class="hljs-number"><span class="hljs-number">726f</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> ........zero.... <span class="hljs-number"><span class="hljs-number">0000040</span></span>: <span class="hljs-number"><span class="hljs-number">0301</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>c00 <span class="hljs-number"><span class="hljs-number">0402</span></span> <span class="hljs-number"><span class="hljs-number">6664</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>b00 <span class="hljs-number"><span class="hljs-number">0000</span></span> ........fd...... <span class="hljs-number"><span class="hljs-number">0000050</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a05 <span class="hljs-number"><span class="hljs-number">7374</span></span> <span class="hljs-number"><span class="hljs-number">6469</span></span> <span class="hljs-number"><span class="hljs-number">6e00</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">0d</span></span>00 <span class="hljs-number"><span class="hljs-number">0000</span></span> ....stdin....... <span class="hljs-number"><span class="hljs-number">0000060</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a06 <span class="hljs-number"><span class="hljs-number">7374</span></span> <span class="hljs-number"><span class="hljs-number">646f</span></span> <span class="hljs-number"><span class="hljs-number">7574</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">0f</span></span>00 <span class="hljs-number"><span class="hljs-number">0000</span></span> ....stdout...... <span class="hljs-number"><span class="hljs-number">0000070</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a06 <span class="hljs-number"><span class="hljs-number">7374</span></span> <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">7272</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> ....stderr...... <span class="hljs-number"><span class="hljs-number">0000080</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">0205</span></span> <span class="hljs-number"><span class="hljs-number">646d</span></span> <span class="hljs-number"><span class="hljs-number">656d</span></span> <span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1100</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> ....dmem0....... <span class="hljs-number"><span class="hljs-number">0000090</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">0205</span></span> <span class="hljs-number"><span class="hljs-number">646d</span></span> <span class="hljs-number"><span class="hljs-number">656d</span></span> <span class="hljs-number"><span class="hljs-number">3100</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1300</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> ....dmem1....... <span class="hljs-number"><span class="hljs-number">00000</span></span>a0: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">0206</span></span> <span class="hljs-number"><span class="hljs-number">7261</span></span> <span class="hljs-number"><span class="hljs-number">6e64</span></span> <span class="hljs-number"><span class="hljs-number">6f</span></span>6d <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> ....random...... <span class="hljs-number"><span class="hljs-number">00000</span></span>b0: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a07 <span class="hljs-number"><span class="hljs-number">7572</span></span> <span class="hljs-number"><span class="hljs-number">616</span></span>e <span class="hljs-number"><span class="hljs-number">646f</span></span> <span class="hljs-number"><span class="hljs-number">6d</span></span>00 <span class="hljs-number"><span class="hljs-number">1600</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> ....urandom..... <span class="hljs-number"><span class="hljs-number">00000</span></span>c0: <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">020</span></span>b <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6369</span></span> <span class="hljs-number"><span class="hljs-number">5f</span></span>73 <span class="hljs-number"><span class="hljs-number">7464</span></span> <span class="hljs-number"><span class="hljs-number">6f</span></span>75 <span class="hljs-number"><span class="hljs-number">7400</span></span> ....deci_stdout. <span class="hljs-number"><span class="hljs-number">00000d</span></span>0: <span class="hljs-number"><span class="hljs-number">1700</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">020</span></span>b <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6369</span></span> <span class="hljs-number"><span class="hljs-number">5f</span></span>73 <span class="hljs-number"><span class="hljs-number">7464</span></span> ........deci_std <span class="hljs-number"><span class="hljs-number">00000e0</span></span>: <span class="hljs-number"><span class="hljs-number">6572</span></span> <span class="hljs-number"><span class="hljs-number">7200</span></span> <span class="hljs-number"><span class="hljs-number">1800</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">0209</span></span> <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6369</span></span> err.........deci <span class="hljs-number"><span class="hljs-number">00000f</span></span>0: <span class="hljs-number"><span class="hljs-number">5f</span></span>74 <span class="hljs-number"><span class="hljs-number">7479</span></span> <span class="hljs-number"><span class="hljs-number">3200</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1900</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">0209</span></span> _tty2........... <span class="hljs-number"><span class="hljs-number">0000100</span></span>: <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6369</span></span> <span class="hljs-number"><span class="hljs-number">5f</span></span>74 <span class="hljs-number"><span class="hljs-number">7479</span></span> <span class="hljs-number"><span class="hljs-number">3300</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>a00 <span class="hljs-number"><span class="hljs-number">0000</span></span> deci_tty3....... <span class="hljs-number"><span class="hljs-number">0000110</span></span>: <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">0209</span></span> <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6369</span></span> <span class="hljs-number"><span class="hljs-number">5f</span></span>74 <span class="hljs-number"><span class="hljs-number">7479</span></span> <span class="hljs-number"><span class="hljs-number">3400</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> ....deci_tty4... <span class="hljs-number"><span class="hljs-number">0000120</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>b00 <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">0209</span></span> <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6369</span></span> <span class="hljs-number"><span class="hljs-number">5f</span></span>74 <span class="hljs-number"><span class="hljs-number">7479</span></span> ........deci_tty <span class="hljs-number"><span class="hljs-number">0000130</span></span>: <span class="hljs-number"><span class="hljs-number">3500</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>c00 <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">0209</span></span> <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6369</span></span> <span class="hljs-number"><span class="hljs-number">5.</span></span>..........deci <span class="hljs-number"><span class="hljs-number">0000140</span></span>: <span class="hljs-number"><span class="hljs-number">5f</span></span>74 <span class="hljs-number"><span class="hljs-number">7479</span></span> <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1d</span></span>00 <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">0209</span></span> _tty6........... <span class="hljs-number"><span class="hljs-number">0000150</span></span>: <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6369</span></span> <span class="hljs-number"><span class="hljs-number">5f</span></span>74 <span class="hljs-number"><span class="hljs-number">7479</span></span> <span class="hljs-number"><span class="hljs-number">3700</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1e00</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> deci_tty7....... <span class="hljs-number"><span class="hljs-number">0000160</span></span>: <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">020</span></span>a <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6369</span></span> <span class="hljs-number"><span class="hljs-number">5f</span></span>74 <span class="hljs-number"><span class="hljs-number">7479</span></span> <span class="hljs-number"><span class="hljs-number">6130</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> ....deci_ttya0.. <span class="hljs-number"><span class="hljs-number">0000170</span></span>: <span class="hljs-number"><span class="hljs-number">1f</span></span>00 <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">020</span></span>a <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6369</span></span> <span class="hljs-number"><span class="hljs-number">5f</span></span>74 <span class="hljs-number"><span class="hljs-number">7479</span></span> ........deci_tty <span class="hljs-number"><span class="hljs-number">0000180</span></span>: <span class="hljs-number"><span class="hljs-number">6230</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">020</span></span>a <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6369</span></span> b0.. .......deci <span class="hljs-number"><span class="hljs-number">0000190</span></span>: <span class="hljs-number"><span class="hljs-number">5f</span></span>74 <span class="hljs-number"><span class="hljs-number">7479</span></span> <span class="hljs-number"><span class="hljs-number">6330</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">2200</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span> <span class="hljs-number"><span class="hljs-number">020</span></span>a _ttyc0..<span class="hljs-string"><span class="hljs-string">"....... 00001a0: 6465 6369 5f73 7464 696e 0000 2300 0000 deci_stdin..#... 00001b0: 0c00 0203 6270 6600 2400 0000 1000 0a04 ....bpf.$....... 00001c0: 6270 6630 0000 0000 2900 0000 0c00 0203 bpf0....)....... 00001d0: 6869 6400 2c00 0000 1400 0208 7363 655f hid.,.......sce_ 00001e0: 7a6c 6962 0000 0000 2e00 0000 1000 0204 zlib............ 00001f0: 6374 7479 0000 0000 3400 0000 0c00 0202 ctty....4....... 0000200: 6763 0000 3900 0000 0c00 0203 6463 6500 gc..9.......dce. 0000210: 3a00 0000 1000 0205 6462 6767 6300 0000 :.......dbggc... 0000220: 3e00 0000 0c00 0203 616a 6d00 4100 0000 &gt;.......ajm.A... 0000230: 0c00 0203 7576 6400 4200 0000 0c00 0203 ....uvd.B....... 0000240: 7663 6500 4500 0000 1800 020d 6e6f 7469 vce.E.......noti 0000250: 6669 6361 7469 6f6e 3000 0000 4600 0000 fication0...F... 0000260: 1800 020d 6e6f 7469 6669 6361 7469 6f6e ....notification 0000270: 3100 0000 5000 0000 1000 0206 7573 6263 1...P.......usbc 0000280: 746c 0000 5600 0000 1000 0206 6361 6d65 tl..V.......came 0000290: 7261 0000 8500 0000 0c00 0203 726e 6700 ra..........rng. 00002a0: 0701 0000 0c00 0403 7573 6200 c900 0000 ........usb..... 00002b0: 1000 0a07 7567 656e 302e 3400 0000 0000 ....ugen0.4..... 00002c0: 0000 0000 0000 0000 0000 0000 0000 0000 ................</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some of these devices can be read, for example reading will </font></font><code>/dev/urandom</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fill the memory with random data. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can also parse this memory and get a list of entities; </font><font style="vertical-align: inherit;">Take a look at </font></font><code>browser.html</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from the repository, which serves as a file manager:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0ca/3a4/4cb/0ca3a44cb6a8a67821897808ec1d2512.jpg" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alas, because of the sandbox, we do not have full access to the file system. </font><font style="vertical-align: inherit;">Attempt to read files or directories that </font></font><a href="http://www.psdevwiki.com/ps4/Talk:Files_on_the_PS4"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exist</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but access to them is limited, you will return error 2 </font></font><code>ENOENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>"No such file or directory"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">True, we can still get access to various interesting features - encrypted saving files, trophies and account information - I will tell you more about them in my next articles.</font></font><br><br><h2> <font color="#2284BE"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sandbox</font></font></font> </h2><br>          ‚Äî    ,      . <br><br>  ,       1, <code>EPERM</code> , <code>"Operation not permitted"</code> ;       <code>ptrace</code> ,           . <br><br>    .  ,     <code>mmap</code> ,    <a href="http://fxr.watson.org/fxr/source/kern/syscalls.master%3Fv%3DFREEBSD9">   477</a> ,   <a href="http://fxr.watson.org/fxr/source/kern/syscalls.master%3Fv%3DFREEBSD9">71</a>  <a href="http://fxr.watson.org/fxr/source/kern/syscalls.master%3Fv%3DFREEBSD9">197</a> ;   ,   . <br><br>   ,  <code>exit</code> ,     ( <i>segmentation fault</i> ): <br><br><pre> <code class="hljs objectivec">chain.syscall(<span class="hljs-string"><span class="hljs-string">"exit"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><br>   SCTP-   <code>0x2b</code> , <code>EPROTONOSUPPORT</code> ,   ,  SCTP-     PS4: <br><br><pre> <code class="hljs pgsql">//<span class="hljs-type"><span class="hljs-type">int</span></span> socket(<span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> protocol); //socket(AF_INET, SOCK_STREAM, IPPROTO_SCTP); chain.syscall("socket", <span class="hljs-number"><span class="hljs-number">97</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">132</span></span>);</code> </pre><br> ,   <code>mmap</code>  <code>PROT_READ | PROT_WRITE | PROT_EXEC</code>   ,  <code>PROT_EXEC</code>  .     3 (RW),        : <br><br><pre> <code class="hljs cs">chain.syscall(<span class="hljs-string"><span class="hljs-string">"mmap"</span></span>, <span class="hljs-number"><span class="hljs-number">477</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4096</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2</span></span> | <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">4096</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); chain.write_rax_ToVariable(<span class="hljs-number"><span class="hljs-number">0</span></span>); chain.read_rdi_FromVariable(<span class="hljs-number"><span class="hljs-number">0</span></span>); chain.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"pop rax"</span></span>, <span class="hljs-number"><span class="hljs-number">0xfeeb</span></span>); chain.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"mov [rdi], rax"</span></span>); chain.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"mov rax, rdi"</span></span>); chain.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"jmp rax"</span></span>);</code> </pre><br>  <a href="http://www.scei.co.jp/ps4-license/">open source ,   PS4</a> ,          <a href="https://www.freebsd.org/cgi/man.cgi%3Fquery%3Dcapsicum">Capsicum</a> ,   PS4   ¬´¬ª <a href="https://www.freebsd.org/doc/handbook/jails.html">jails  FreeBSD</a> ,          (  ). <br><br><h2> <font color="#2284BE">Jail</font> </h2><br>       jail-  FreeBSD   PS4     auditon,      jailed-: <br><br><pre> <code class="hljs objectivec">chain.syscall(<span class="hljs-string"><span class="hljs-string">"auditon"</span></span>, <span class="hljs-number"><span class="hljs-number">446</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><br> ,     <code>audition</code> ‚Äî   <code>jailed</code> <a href=""></a> ,    ,  ENOSYS: <br><br><pre> <code class="hljs lisp">if (<span class="hljs-name"><span class="hljs-name">jailed</span></span>(<span class="hljs-name"><span class="hljs-name">td-&gt;td_ucred</span></span>)) return (<span class="hljs-name"><span class="hljs-name">ENOSYS</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br><br>    ,      <code>EPERM</code>  <code>mac_system_check_auditon</code> <a href=""></a> : <br><br><pre> <code class="hljs lua"><span class="hljs-built_in"><span class="hljs-built_in">error</span></span> = mac_system_check_auditon(td-&gt;td_ucred, uap-&gt;cmd); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>);</code> </pre><br><br>   <code>priv_check</code> <a href=""></a> : <br><br><pre> <code class="hljs lua"><span class="hljs-built_in"><span class="hljs-built_in">error</span></span> = priv_check(td, PRIV_AUDIT_CONTROL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>);</code> </pre><br><br>  ,     ,    <code>priv_check</code> , <a href=""></a> ,   <code>EINVAL</code> -  ,  0: <br><br><pre> <code class="hljs lisp">if ((<span class="hljs-name"><span class="hljs-name">uap-&gt;length</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) || (<span class="hljs-name"><span class="hljs-name">uap-&gt;length</span></span> &gt; sizeof(<span class="hljs-name"><span class="hljs-name">union</span></span> auditon_udata))) return (<span class="hljs-name"><span class="hljs-name">EINVAL</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br><br>  <code>mac_system_check_auditon</code>  <code>priv_check</code>    <code>ENOSYS</code> ,    <code>jailed</code> ‚Äî  ,   <code>ENOSYS</code> . <br><br>   , <i></i> <code>ENOSYS</code> ( <code>0x48</code> ). <br><br>     ,   ,  PS4,     jail-,    <code>jailed</code> . <br><br><h2> <font color="#2284BE">  FreeBSD 9.0</font> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is not much point in searching for new vulnerabilities in the </font></font><a href="https://github.com/freebsd/freebsd/tree/release/9.0.0/sys/kern"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source code of the FreeBSD 9.0 kernel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , since since its release in 2012, </font></font><a href="https://www.exploit-db.com/platform/%3Fp%3Dfreebsd"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">several kernel exploits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> have been </font><a href="https://www.exploit-db.com/platform/%3Fp%3Dfreebsd"><font style="vertical-align: inherit;">found</font></a><font style="vertical-align: inherit;"> , to which PS4 could be potentially vulnerable. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We can drop some of them at once: </font></font><br><br> <a href="https://www.exploit-db.com/exploits/26368/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeBSD 9.0-9.1 mmap / ptrace - Privilege Escalation Exploit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - will not work, because we do not have access to the system call </font></font><code>ptrace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br> <a href="https://www.exploit-db.com/exploits/28718/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeBSD 9.0 - Intel SYSRET Kernel Privilege Escalation Exploit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - will not work, because the PS4 uses an AMD processor. </font></font><br> <a href="https://www.exploit-db.com/exploits/35938/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeBSD Kernel - Multiple Vulnerabilities</font></font></a> ‚Äî ,       ,       SCTP,    PS4 ,    . <br><br>  ,  <a href="http://www.cvedetails.com/vulnerability-list/vendor_id-6/product_id-7/version_id-118765/Freebsd-Freebsd-9.0.html">  </a> ,      - . <br><br><h2> <font color="#2284BE">getlogin</font> </h2><br>   ,    ‚Äî <a href="http://www.cvedetails.com/cve/CVE-2014-8476/">   getlogin      </a> . <br><br>   <a href="https://www.freebsd.org/cgi/man.cgi%3Fquery%3Dgetlogin%26sektion%3D2">getlogin</a>          , , - ,    ,       .  ,         ,    . <br><br> ,    (49)    <code>int getlogin_r(char *name, int len);</code> ,   <code>char *getlogin(void);</code>  . <br><br> ,           : <br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">chain</span></span>.syscall(<span class="hljs-string"><span class="hljs-string">"getlogin"</span></span>, <span class="hljs-number"><span class="hljs-number">49</span></span>, chain.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">, 17);</span></span></code> </pre> <br><br> ,  17     , : <br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The username length is limited to MAXLOGNAME (from &lt;sys / param.h&gt;) characters, currently 17 characters, including empty ones. </font></font></blockquote> <i><a href="https://www.freebsd.org/cgi/man.cgi%3Fquery%3Dgetlogin%26sektion%3D2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- FreeBSD Man Pages</font></font></a></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> After executing the chain, the return value is 0, which means that the system call worked! </font><font style="vertical-align: inherit;">Great start. </font><font style="vertical-align: inherit;">Now let's take a look at the memory we pointed out:</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before the execution of the chain:</font></font><br><br><pre> <code class="hljs">00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> After completing the chain: </font></font><br><br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> fe ff ff <span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-number"><span class="hljs-number">62</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">82</span></span> ff ff ff ff <span class="hljs-number"><span class="hljs-number">00</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> After decoding the first four bytes in ASCII: </font></font><br><br><pre> <code class="hljs">root</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It turns out that the browser runs from the root! </font><font style="vertical-align: inherit;">This is a surprise. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But what is even more interesting is that the leaked memory resembles a pointer to something in the core, that every time the chain starts, it remains the same; </font><font style="vertical-align: inherit;">This evidence confirms Yifanlu‚Äôs theory that </font></font><a href="https://twitter.com/yifanlu/status/551498289284009984"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there is no ASLR protection ( </font></font></a> <a href="http://habrahabr.ru/company/xakep/blog/260877/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">address space randomization</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) at the kernel level </font><a href="https://twitter.com/yifanlu/status/551498289284009984"><font style="vertical-align: inherit;">in PS4</font></a><font style="vertical-align: inherit;"> !</font></font><br><br><h2>  <font color="#2284BE">Total</font> </h2><br>    ,  PS4      FreeBSD 9.0.  ,          ,    .  Sony         ,    ,   ,    . <br><br>       ,   PS4     ¬´¬ª ,     FreeBSD 9.0! <br><br>  ,             WebKit     (      jails  FreeBSD). ,      FreeBSD 9   ,        ,     ,  .  ,      PS4         ,     . <br><br>     -  ,   ,           Sony;   ,        ,      FreeBSD. <br><br>  <a href="http://hackinformer.com/2015/06/24/breaking-news-discovered-two-communication-ports-uart-playstation-4/">Jaicrab   PS4    (UART)</a> ,       hardware-  .   hardware-     RAM  (    <a href="">DSi</a> ),             WebKit ‚Äî ,     ,   ¬´¬ª ,     <a href="http://pure-virtual.blogspot.ru/2010/01/ps3.html">    PS3   geohot</a> . ,    ,      PS4      . <br><br> <i>  ! <br>    ,    /,       .</i> </div><p>Source: <a href="https://habr.com/ru/post/265235/">https://habr.com/ru/post/265235/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265225/index.html">Local network organization with simultaneous connection to two Internet providers using MikroTik router</a></li>
<li><a href="../265227/index.html">Bypass authorization via social networks when connecting to public Wi-Fi</a></li>
<li><a href="../265229/index.html">What is ITIL and what does it eat?</a></li>
<li><a href="../265231/index.html">Use the official docker image of NGINX in InfoboxCloud: part 1</a></li>
<li><a href="../265233/index.html">Study: Vulnerabilities of a cryptotransponder allow keyless entry of over 100 models of machines.</a></li>
<li><a href="../265239/index.html">How to sue a captured domain if you are not a company</a></li>
<li><a href="../265243/index.html">Microconference UX-Environment ‚Ññ24: Long-reads and modern tools of publishing</a></li>
<li><a href="../265245/index.html">Creating shortcodes in WordPress CMS</a></li>
<li><a href="../265247/index.html">HTML5 game development for Android from scratch to release</a></li>
<li><a href="../265249/index.html">Pedestrian Routing - New Challenge for OpenStreetMap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>