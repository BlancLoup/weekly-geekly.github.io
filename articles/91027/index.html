<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>.NET 4: ‚Äúslim‚Äù sync</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Finally, the RTM version of .NET 4 and Visual Studio 2010 came out. The final optimizations in the final version of the platform have been carried out...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>.NET 4: ‚Äúslim‚Äù sync</h1><div class="post__text post__text-html js-mediator-article">  Finally, the <a href="http://www.microsoft.com/visualstudio/ru-ru/download">RTM version of</a> .NET 4 and Visual Studio 2010 came out. The final optimizations in the final version of the platform have been carried out and can be safely tested. <br><a name="habracut"></a><br>  It's no secret that one of the major innovations of .NET 4 is <a href="http://msdn.microsoft.com/ru-ru/concurrency/ee851578%2528en-us%2529.aspx">Parallel Extensions</a> - a set of tools to facilitate code parallelization and work in a multithreaded environment.  Among other tools of this set there are synchronization primitives, which have also been processed. <br><br>  In particular, a modified version of the highly popular primitive <a href="http://msdn.microsoft.com/en-us/library/system.threading.manualresetevent.aspx">ManualResetEvent</a> .  For those who are not very familiar with this tool: with its help you can synchronize the execution of code sections running in different threads.  The object can be in 2 states - fixed and uninstalled.  The transition from one to another is performed using the Set () and Reset () methods.  In a nutshell, how it works (here mre is an instance of type ManualResetEvent): <br><table border="1" width="400"><tbody><tr><th>  Stream 1 </th><th>  Stream 2 </th><th>  Time </th></tr><tr><td>  mre.Reset (); <br>  mre.WaitOne (); </td><td>  // code execution </td><td>  0 </td></tr><tr><td>  //expectation </td><td>  // code execution </td><td>  one </td></tr><tr><td>  //expectation </td><td>  // code execution </td><td>  2 </td></tr><tr><td>  //expectation </td><td>  // code execution </td><td>  3 </td></tr><tr><td>  //expectation </td><td>  mre.Set (); </td><td>  four </td></tr><tr><td>  // code execution </td><td>  // ... </td><td>  five </td></tr></tbody></table><br>  An improved version of this primitive from .NET 4 is called <a href="http://msdn.microsoft.com/en-us/library/system.threading.manualreseteventslim%2528VS.100%2529.aspx">ManualResetEventSlim</a> .  The basic idea is to reduce the overhead in case only 1 thread is accessing the primitive.  Used so-called.  A ‚Äúhybrid scheme‚Äù that can be implemented like this: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">internal</font> <font color="#0000ff">sealed</font> <font color="#0000ff">class</font> SimpleHybridLock : IDisposable <br> { <br> <font color="#0000ff">private</font> <font color="#2B91AF">Int32</font> m_waiters = 0; <br> <font color="#0000ff">private</font> AutoResetEvent m_waiterLock = <font color="#0000ff">new</font> AutoResetEvent( <font color="#0000ff">false</font> ); <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Enter() <br> { <br> <font color="#0000ff">if</font> (Interlocked.Increment( <font color="#0000ff">ref</font> m_waiters) == 1) <br> <font color="#0000ff">return</font> ; <br> m_waiterLock.WaitOne(); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Leave() <br> { <br> <font color="#0000ff">if</font> (Interlocked.Decrement( <font color="#0000ff">ref</font> m_waiters) == 0) <br> <font color="#0000ff">return</font> ; <br> m_waiterLock.Set(); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Dispose() <br> { <br> m_waiterLock.Dispose(); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  This is an example from Richter‚Äôs book <a href="http://www.amazon.com/CLR-via-Dev-Pro-Jeffrey-Richter/dp/0735627045/ref%3Dsr_1_1%3Fie%3DUTF8%26s%3Dbooks%26qid%3D1271301676%26sr%3D1-1">‚ÄúCLR via C #‚Äù, 3rd edition</a> .  A primitive SimpleHybridLock has a couple of public methods Enter () and Leave ().  Calling these methods should frame a critical section of our code that we always want to execute in only one thread.  The class code is quite transparent: the first thread that called Enter () increases the internal counter by 1. The second thread also increases the counter, while blocking until someone calls Set () on the m_waiterLock object.  So  if there is no competitive access to the primitive, the very WaitOne () and Set () methods, which are very heavy in terms of performance, will not be called.  This can positively affect the speed of the code. <br><br>  A similar principle is built and ManualResetEventSlim.  I think there are more intelligent mechanisms, such as control of recursive calls, etc.  As an end user of the platform, I was interested in the real performance difference between ManualResetEvent and its * -Slim version.  To find it, I prepared a small ‚Äúbenchmark‚Äù.  This is a console application of this type: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">static</font> <font color="#0000ff">void</font> Main( <font color="#0000ff">string</font> [] args) <br> { <br> ManualResetEventSlim mres = <font color="#0000ff">new</font> ManualResetEventSlim( <font color="#0000ff">false</font> ); <br> ManualResetEventSlim mres2 = <font color="#0000ff">new</font> ManualResetEventSlim( <font color="#0000ff">false</font> ); <br> <br> ManualResetEvent mre = <font color="#0000ff">new</font> ManualResetEvent( <font color="#0000ff">false</font> ); <br> <br> <font color="#0000ff">long</font> total = 0; <br> <font color="#0000ff">int</font> COUNT = 50; <br> <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; COUNT; i++) <br> { <br> mres2.Reset(); <br> <font color="#008000">//  </font> <br> Stopwatch sw = Stopwatch.StartNew(); <br> <br> <font color="#008000">//    </font> <br> ThreadPool.QueueUserWorkItem((obj) =&gt; <br> { <br> <font color="#008000">//Method(mres, true);</font> <br> Method2(mre, <font color="#0000ff">true</font> ); <br> mres2.Set(); <br> }); <br> <font color="#008000">//    </font> <br> <font color="#008000">//Method(mres, false);</font> <br> Method2(mre, <font color="#0000ff">false</font> ); <br> <br> <font color="#008000">//,    </font> <br> mres2.Wait(); <br> sw.Stop(); <br> <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"Pass {0}: {1} ms"</font> , i, sw.ElapsedMilliseconds); <br> total += sw.ElapsedMilliseconds; <br> } <br> <br> <font color="#2B91AF">Console</font> .WriteLine(); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"==============================="</font> ); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"Done in average="</font> + total / ( <font color="#0000ff">double</font> )COUNT); <br> <font color="#2B91AF">Console</font> .ReadLine(); <br> } <br> <br> <font color="#008000">//   ManualResetEventSlim</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Method(ManualResetEventSlim mre, <font color="#0000ff">bool</font> <font color="#0000ff">value</font> ) <br> { <br> <font color="#008000">//       </font> <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; 9000000; i++) <br> { <br> <font color="#0000ff">if</font> ( <font color="#0000ff">value</font> ) <br> { <br> mre.Set(); <br> } <br> <font color="#0000ff">else</font> <br> { <br> mre.Reset(); <br> } <br> } <br> } <br> <br> <font color="#008000">//    ManualResetEvent</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Method2(ManualResetEvent mre, <font color="#0000ff">bool</font> <font color="#0000ff">value</font> ) <br> { <br> <font color="#008000">//       </font> <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; 9000000; i++) <br> { <br> <font color="#0000ff">if</font> ( <font color="#0000ff">value</font> ) <br> { <br> mre.Set(); <br> } <br> <font color="#0000ff">else</font> <br> { <br> mre.Reset(); <br> } <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  In the Main () method, we create instances of primitives and model access to them from 2 threads - the main thread and the pool thread.  In this case, the pool thread will set a state in a loop, and the main thread will reset.  Repeat the COUNT experiment once and display the average value on the screen.  This is what happened on my laptop (2-core T7250 CPU, Win 7 x64): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <table border="1" width="400"><tbody><tr><td>  ManualResetEvent </td><td>  ManualResetEvent <strong>Slim</strong> </td></tr><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/316/3f4/d83/3163f4d837b6ef090143d7f5436e4694.png" alt="image"></td><td><img src="https://habrastorage.org/getpro/habr/post_images/235/e29/988/235e299885d0e368ddaf509fc663a460.png" alt="image"></td></tr></tbody></table><br>  The difference is obvious and quite significant - about 10 times. <br><br>  So  Preferred is the use of ManualResetEventSlim, since it is not always when calling Set () and Reset () there will be a long call to the Windows kernel objects and you can win a lot of money in speed;) </div><p>Source: <a href="https://habr.com/ru/post/91027/">https://habr.com/ru/post/91027/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../91020/index.html">ncomputing: inventing a cheap pedal-driven car on two wheels</a></li>
<li><a href="../91022/index.html">Version 1.1.0 released</a></li>
<li><a href="../91023/index.html">Forbes: "Young managers have destroyed the culture of meetings"</a></li>
<li><a href="../91024/index.html">Video editor Lightworks goes under Open Source</a></li>
<li><a href="../91026/index.html">Joomla customers mini review</a></li>
<li><a href="../91028/index.html">New Youtube Chips</a></li>
<li><a href="../91029/index.html">Catalog of unusual travel HipWay.ru</a></li>
<li><a href="../91030/index.html">Google follow finder</a></li>
<li><a href="../91034/index.html">Released real-time strategy Bos Wars 2.6</a></li>
<li><a href="../91037/index.html">Git to upload updated files to the site</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>