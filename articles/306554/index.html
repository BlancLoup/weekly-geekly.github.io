<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to optimize the game using polygonal atlases</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As everyone knows, the life of a mobile gaming developer is not easy. He must find his way on a very narrow path. On the one hand, the requirements of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to optimize the game using polygonal atlases</h1><div class="post__text post__text-html js-mediator-article">  As everyone knows, the life of a mobile gaming developer is not easy.  He must find his way on a very narrow path.  On the one hand, the requirements of game designers, confidently rushing to infinity.  More functionality, more beautiful graphics, more effects, more animations, more sounds.  On the other hand, limited resources of the mobile device.  And first of all, as a rule, RAM ends. <br><br>  For example, iPad 2 - just 512 MB of RAM in it.  However, only about 275 MB are available to the application.  When the memory occupied by the application approaches this boundary, the operating system will send the so-called ‚ÄúMemory warning‚Äù - gently but aggressively offers to free the memory.  And if the limit is still exceeded, the operating system will stop the application.  The user will think that your game has fallen and will run to write an angry letter to the support. <br><br> <a href="https://habrahabr.ru/company/playrix/blog/306554/"><img src="https://habrastorage.org/getpro/habr/post_images/fc7/c05/878/fc7c0587893685cb83be74203b8135da.png"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main consumer of memory is, of course, graphics.  In this article, we will try to talk about a slightly complicated but effective method that is used to reduce the memory occupied by textures, as well as to increase the rendering speed. <br><a name="habracut"></a><br><h2>  Textures and Atlases </h2><br>  As everyone again knows, drawing textures directly from source files is a bad idea.  Instead, they are packaged in textural atlases. <br><br>  Texture Atlas is a large image obtained by gluing small textures.  This saves memory and, more importantly, decreases the number of batch files when drawing.  There are two videos that vividly demonstrate why the atlas is good, and the individual textures are bad: <a href="https://www.codeandweb.com/what-is-a-sprite-sheet">one</a> and <a href="https://www.codeandweb.com/what-is-a-sprite-sheet-performance">two</a> <a href="https://www.codeandweb.com/what-is-a-sprite-sheet">times</a> .  Thus, the task of packing a texture atlas usually comes down to the following: take rectangles of different sizes (original textures) and place them as closely as possible into one large rectangle, or, more often, a square.  We are not at the Olympics and we don‚Äôt need the perfect packaging, and it‚Äôs not hard to write an algorithm that packs textures tightly within a reasonable time.  We have been using such an algorithm for a long time, which generates texture atlases for us.  Some such: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/89b/59b/380/89b59b380d53cf6e8668ef8fae650a77.png"><br><br>  As it is easy to notice, there is a lot of free space in it and I really want to pack textures more tightly.  The reason for inefficient packaging is that many textures contain fairly large transparent areas.  Therefore, once we decided to try to abandon the usual rectangular packaging and do what eventually became known as the "polygonal atlas".  For this you need to solve 2 problems: <br><br>  <b>1.</b> For each original texture, it is necessary to find such a set of triangles so that it contains all its opaque pixels.  Then, if we draw all these triangles, the original texture will appear on the screen.  At the same time there is an important limitation - there should not be too many triangles, otherwise drawing will be very slow.  Thus, a compromise is needed between the number of triangles and the area they occupy.  Therefore, at first, an algorithm was written with a variety of parameters for fine tuning, and only then, conducting experiments on real textures, we selected these parameters. <br><br>  <b>2.</b> The resulting figures of complex shape (the same polygons) should be packed as closely as possible into the atlas.  Here, one of the variants of the <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25BE%25D0%25B5%25D0%25B2%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B5%25D0%25BB%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2582">bee swarm</a> algorithm was used, which, conducting numerous attempts using a random number generator, tried to find a sufficiently dense packaging variant.  It took a different kind of compromise - between the quality of the packaging and the time spent on packaging. <br><br>  Having traveled a rather long way and attempted to pack a test atlas about 100,000 times, we finally achieved the result: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/45a/2a5/002/45a2a5002be0c1ae3d66ff35fe364b49.png"><br><br>  As you can see, the packaging is really much denser.  Depending on the texture, the gain can be up to 1/4 of their area.  You can also create a debug version of the atlas, which shows the breakdown of textures into triangles. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/146/d42/d2f/146d42d2fc7ae97beacf98e4ffba9d1e.png"><br><br>  In addition to the atlas itself, its description is generated, in which the names of the source textures and the coordinates of the resulting triangles are indicated. <br><br>  When using polygonal atlases, the drawing process, on the one hand, accelerates, on the other hand, it slows down.  It is accelerated because the total drawn area has become smaller, and, therefore, the overdraw value has also become less.  And it slows down because if before any texture was drawn with just two triangles, now, as can be seen in the example, they have become much more.  In general, with reasonable settings of the atlas packer, we have not had a big change in the speed of the rendering system. <br><br>  There is one more problem that we encountered when switching to new atlases.  Often it is required to draw not a whole texture, but only a part of it.  For example, if you need to make a gradual appearance of the object on the screen or some progress indicator.  When using conventional atlases, the problem is easily solved by correcting the uv-coordinates.  In the case of polygonal atlases, everything becomes more complicated.  Let's look at an example.  The blue part of the image highlights the part of the texture to be drawn: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fbe/54f/725/fbe54f725960af79b8de87060ada4d37.png"></div><br>  Would need: <br><br><ul><li>  Exclude from drawing triangles that do not fall into the drawing part of the texture <br></li><li>  Find the intersection of the new texture border with the original triangles.  The result may no longer be a triangle, and it may be necessary to split it into 2 new triangles. <br></li></ul><br>  The solution of such a problem will provide an opportunity to practice well in the school course of geometry.  In addition, this algorithm may not work very quickly. <br><br>  There are more complex cases.  For example, circular progress or some kind of distortion of the texture.  Therefore, it turned out that it is easier to pack some textures into ordinary atlases or not to pack them at all, so as not to complicate the rendering process. <br><br>  Some technical details.  The packing time of polygonal atlas is highly dependent on the quality setting of the packaging.  Since at any change in the texture set, atlases must be re-compiled, this has to be done quite often.  Therefore, we usually have the ‚Äúminimum density, maximum speed‚Äù mode enabled.  In this mode, 8 atlases of size 2048x2048 are packaged for about 5 minutes.  In general terms, the packaging process looks like this: <br><br><ul><li>  textures are divided into triangles; <br></li><li>  textures are sorted by decrease in height; <br></li><li>  pre-pack textures.  All textures are selected in order and each one is searched for free space in the atlas; <br></li><li>  several attempts are made to repack textures more densely.  The number of attempts depends on the quality settings; <br></li><li>  if the original packaging was improved, then additional textures are added to the atlas. <br></li></ul><br>  As a rule, pre-packaging is already quite dense.  When trying to improve the quality, the packing time grows very strongly - up to several hours per 1 atlas - and the gain can be 2-3 additional packed textures. <br><br>  In the games we use our own engine.  To go to the polygonal atlases had to modify it a bit.  Fortunately, we already had an abstract drawable entity - the Drawable class: <br><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Drawable</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Width</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Height</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HitTest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Draw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SpriteBatch* batch, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> FPoint&amp; position</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br>  It already had functions for getting the size, checking the pixel opacity for handling clicks and rendering.  It only took to create another PolygonalSprite class that would correctly implement these functions, taking into account the splitting of the texture into triangles. <br><br>  Also, so that the client code could get a list of texture triangles and perform some transformations with them, a function was added to the interface. <br><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGeometry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">vector</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;QuadVert&gt;&amp; geometry)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>;</code> </pre> <br>  For regular textures and ordinary atlases, this function returns four vertices that form a rectangle corresponding to the original texture.  And for textures from polygonal atlases - an array of vertices of triangles into which the texture is broken. <br><br>  Now polygonal atlases are used in many of our projects and we can assume that they have passed the test of time.  For example, in our next free-to-play project, Gardenscapes, the world release of which will take place <i><b>very soon</b></i> , the main part of the gameplay takes place in the player‚Äôs garden. <br><br>  For him, just drawn a huge variety of textures, some of them are used in this article as examples.  Now all these textures fit in 8 polygonal atlases 2048x2048.  But if we packed atlases in the usual way, they would have already been 11. Thus, we get savings in RAM, depending on the graphic format used, from 6 to 48 MB.  And game designers can offer a quarter more pretty textures more! <br><br>  <i>About the author: Sergey Shestakov, technical director of the company Playrix.</i> </div><p>Source: <a href="https://habr.com/ru/post/306554/">https://habr.com/ru/post/306554/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306542/index.html">Urgently required VPS with SLA: analysis of services of 32 Russian data centers</a></li>
<li><a href="../306544/index.html">Universal https using GOST certificate</a></li>
<li><a href="../306548/index.html">Distributed execution of Python tasks using Apache Mesos. Yandex experience</a></li>
<li><a href="../306550/index.html">JavaScript in 2016: functional programming has come seriously and for a long time</a></li>
<li><a href="../306552/index.html">Features of application promotion in the CIS, in Western markets and in Asia</a></li>
<li><a href="../306556/index.html">Bible movements doom. Part 1</a></li>
<li><a href="../306558/index.html">Is it beneficial for Apple to be an ally of Google in the fight for the online advertising market?</a></li>
<li><a href="../306560/index.html">Cloud storage: new API functions</a></li>
<li><a href="../306562/index.html">The story ‚ÄúNIICHOSHI. Duty night "</a></li>
<li><a href="../306564/index.html">Ruby Ecosystem (on Rails) with a bitter aftertaste, or ‚ÄúHow we love to poke PHP‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>