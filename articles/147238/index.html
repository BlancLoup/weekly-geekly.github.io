<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bash: autodetection of the enemy for online play on Macs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From time to time I like to write some not too trivial things on bash . It seems to be a network chess, which I already talked about at Habr√©. 

 Rece...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bash: autodetection of the enemy for online play on Macs</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/8e3/430/2b4/8e34302b4d59191ca2841763c693447e.jpg" align="left" width="300" height="300">  From time to time I like to write some not too trivial things on <i>bash</i> .  It seems to be a network chess, which I already <a href="http://habrahabr.ru/post/128549/">talked about</a> at Habr√©. <br><br>  Recently, I mentally returned to them and thought how cool it would be if the game itself would find a partner to play on the network.  Those.  being launched, the toy must somehow search the network for those who are ready for the fight. <br><br>  It is impossible to scan all addresses for a long time.  There are two ugly ‚Äúhead-on‚Äù solutions - scan the current subnet or look at the <i>ARP</i> table, connect to those who are there.  But, firstly, such a search will still be slow, and secondly, it will not find all potential rivals (rivals may be on other subnets, and in the <i>ARP</i> table, not all network members at all). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, a similar problem was solved long ago in OSes - for example, when I set up a network printer at home, the operating system found it myself, I did not specify <i>IP</i> or something else.  In the "Macs" for this is the technology " <a href="http://ru.wikipedia.org/wiki/Bonjour">Bonjour</a> " (implementation of " <a href="http://ru.wikipedia.org/wiki/Zeroconf">Zerokonfa</a> "). <br><br>  Is it possible to use this technology in the "Bash"? <a name="habracut"></a><br><br>  I didn‚Äôt rewrite network chess, the thought about which it all started, instead I made a goal to make a file transfer utility that would work according to the following algorithm: it runs on two machines, indicating which file to transfer if computers see each other network, the file is transferred.  All this without specifying the <i>IP of</i> these machines or their names. <br><br>  On Macs, there is the <i>dns-sd</i> utility (or its older version of <i>mDNS</i> ), which advertises and discovers network services.  Those.  being launched with the same keys, she says ‚Äúthis computer can do this,‚Äù with others, she is not looking for the indicated any computer on the network. <br><br>  This is how it happens. <br><br>  Services are specified by name, the service name is a unicode string (in <i>UTF-8</i> format), up to 63 bytes in length (not characters), specified in the form ‚Äú <i>_app-proto._tcp</i> ‚Äù or ‚Äú <i>_app-proto._udp</i> ‚Äù, where the string (which and is the name of the service) ‚Äú <i>app-proto</i> ‚Äù needs to be registered on a special site, but since the utility takes any value, it will come down without this step. <br><br>  In general, if you run <i>dns-sd</i> with the "-R" key, then it will register a new service on the network: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/042/316/5d9/0423165d9a2bd81100d2c4a9d565aad4.png" alt="New service" width="724" height="54"></div><br><br>  which you can then search online by running the same command with the key ‚Äú-B‚Äù: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6be/091/702/6be09170217124f6eb367459e3b79a6d.png" alt="We are looking for a created service" width="656" height="164"></div><br><br>  As you can see, besides the name of the service there are other parameters, but besides the line ‚ÄúHello!‚Äù There is actually nothing interesting there, they do not affect anything in this implementation.  Instead of saying ‚Äúhello‚Äù, something more useful can be written on this line.  I write there information about the <i>IP of the</i> machine that announced the service and checksum of the file being transferred. <br><br>  Some code. <br><br>  It looks like this in my server announcement code: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#             dns-sd #         ‚Äî dns-sd,    function _ClearServer { ps -f | awk"\$2==$1 &amp;&amp; /_bolk-fileshare._tcp/ { print \$2 }" | xargs kill } dns-sd -R "$myownip $checksum" "_bolk-fileshare._tcp" . 1 &gt;/dev/null &amp; trap "_ClearServer $!" EXIT</span></span></code> </pre> <br>  As you can see, I am launching an announcement of the service in the background, and at the exit from the utility I beat the <i>dns-sd</i> working in the background.  If I would not use the launch in the background, then the execution of my script stopped at this place - <i>dns-sd</i> after launch does not return control and removes the service from the announced ones upon exit. <br><br>  Now the discovery service.  In this mode, <i>dns-sd</i> is similar to the <i>top</i> utility ‚Äî the console is also not released, and events about the advertised and de-advertised services appear on the screen.  Therefore, I had to use the <i>expect</i> utility that is very useful in such cases: <br><br><pre> <code class="bash hljs"> <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> info=($(expect &lt;&lt;CMDS | awk <span class="hljs-string"><span class="hljs-string">'NR&gt;2 {print $7 " " $8}'</span></span> | sort -u | tr -d <span class="hljs-string"><span class="hljs-string">'\r'</span></span> | head -n1 spawn -noecho dns-sd -B _bolk-fileshare._tcp expect Timestamp expect -- <span class="hljs-string"><span class="hljs-string">"_bolk-fileshare._tcp"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> CMDS))</code> </pre><br><br>  The point is this: I ask <i>expect</i> to return control to me when <i>dns-sd</i> prints a string with the name of my service.  After that, I select the right for me - the very line where I transmit the server's <i>IP</i> address and the checksum of the file being transferred.  In the variable <i>info</i> , I get an array of two elements - the sum and <i>IP</i> . <br><br>  The rest is not very interesting, on the ‚ÄúGitHub‚Äù <a href="">is the</a> resulting code - then I just connect to the specified address and get the file with the utility <i>netcat</i> . <br><br>  I summarize, the idea is this: a network game, to search for an opponent, announces a service with some given name, scanning simultaneously announced services to ask the player with whom he wants to play.  The player chooses someone, then the machines are connected to the specified addresses and the game begins. </div><p>Source: <a href="https://habr.com/ru/post/147238/">https://habr.com/ru/post/147238/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147226/index.html">Font anatomy</a></li>
<li><a href="../147229/index.html">Yota CEO Denis Sverdlov appointed Deputy Minister of Communications</a></li>
<li><a href="../147230/index.html">Transferring Files from a Siemens Phone to Linux - SieFS</a></li>
<li><a href="../147231/index.html">Hi from 1996: personal computer for 5 million rubles</a></li>
<li><a href="../147232/index.html">Editing and pricing Windows Server 2012</a></li>
<li><a href="../147239/index.html">10 rules that will help the application to receive a recommendation from Google Play</a></li>
<li><a href="../147241/index.html">Generation of alignment for card games</a></li>
<li><a href="../147242/index.html">Blocking mobile parasites</a></li>
<li><a href="../147243/index.html">Free ways to promote Android applications</a></li>
<li><a href="../147244/index.html">Contrast and durable marker board</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>