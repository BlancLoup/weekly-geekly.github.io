<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I made it easy to develop on Vue.js with server-side rendering</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 I'll start with a little background. 

 I decided to try my new project on Vue.js. I needed server rendering (SSR), CSS modules, code-splitt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I made it easy to develop on Vue.js with server-side rendering</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  I'll start with a little background. <br><br>  I decided to try my new project on Vue.js.  I needed server rendering (SSR), CSS modules, code-splitting and other delights.  Of course, a hot reboot (HMR) was needed to increase development productivity. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I did not want to use ready-made solutions, such as Nuxt.js, because  as the project grows, it is important to have the possibility of customization.  And any high-level solutions, as a rule, do not allow to do this, or give it, but with great effort (there was a similar experience with using Next.js for React). <br><br>  The main problem of local development when using server rendering and hot reloading was that it is not enough to run one <i>webpack-dev-server</i> .  We must also do something with the sources that Node.js runs, otherwise the next time we reload the page, we‚Äôll receive a code that was not updated on the server but updated on the client. <br><br>  Having plunged into the documentation and the Internet, I, unfortunately, did not find ready-made adequately working examples and templates.  Therefore, I created my own. <br><br><img src="https://habrastorage.org/webt/fr/yn/fq/frynfqwfukcvkxd1a673bleocno.jpeg"><br><a name="habracut"></a><br>  I determined what my template should consist of in order to be able to develop a comfortable development: <br><br><ul><li>  Vuejs </li><li>  SSR </li><li>  Vuex </li><li>  CSS modules </li><li>  Code splitting </li><li>  ESLint, Prettier </li></ul><br>  In local development, all of this should be updated in the browser on the fly, and the server code should also be updated. <br><br>  In production mode, bundles should be minified, a hash should be added for static caching, the paths to bundles should be automatically put in the html-template. <br><br>  All this is implemented in the <a href="https://github.com/horprogs/vue-ssr-hmr">repository on GitHub</a> , I will give the code and describe the solution. <br><br>  It is worth noting that Vue.js has quite comprehensive documentation for setting up server rendering, so it makes sense to <a href="https://ssr.vuejs.org/">look</a> there. <br><br><h2>  Server part </h2><br>  So, as a server for Node.js, we will use Express, we also need <i>vue-server-renderer</i> .  This package will allow us to render the code in the html-string, based on the server bundle, html-template and client manifest, in which the names and the path to the resources are indicated. <br><br>  The <i>server.js</i> file will look like this: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { createBundleRenderer } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'vue-server-renderer'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> template = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>).readFileSync( path.join(__dirname, <span class="hljs-string"><span class="hljs-string">'./templates/index.html'</span></span>), <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> serverBundle = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../dist/vue-ssr-server-bundle.json'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> clientManifest = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../dist/vue-ssr-client-manifest.json'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = express(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> renderer = createBundleRenderer(serverBundle, { <span class="hljs-comment"><span class="hljs-comment">//           ,     runInNewContext: false, template, clientManifest, inject: false, }); //         nginx server.use('/dist', express.static(path.join(__dirname, '../dist'))); server.get('*', (req, res) =&gt; { const context = { url: req.url }; renderer.renderToString(context, (err, html) =&gt; { if (err) { if (+err.message === 404) { res.status(404).end('Page not found'); } else { console.log(err); res.status(500).end('Internal Server Error'); } } res.end(html); }); }); server.listen(process.env.PORT || 3000);</span></span></code> </pre> <br>  As you can see, we use 2 files: <i>vue-ssr-server-bundle.json</i> and <i>vue-ssr-client-manifest.json</i> . <br><br>  They are generated when building the application;  The first one contains the code that will be executed on the server, the second one contains the names and paths to the resources. <br><br>  Also, in the <i>createBundleRenderer</i> options <i>,</i> we specified the <i>inject: false</i> parameter.  This means that it will not automatically generate html code to load resources and other things, since  we need complete flexibility.  In the template, we will independently mark the places where we want to output this code. <br><br>  The template itself will look like this: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UTF-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width=device-width, initial-scale=1"</span></span></span><span class="hljs-tag">&gt;</span></span> {{{ meta.inject().title.text() }}} {{{ meta.inject().meta.text() }}} {{{ renderResourceHints() }}} {{{ renderStyles() }}} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"app"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-comment"><span class="hljs-comment">&lt;!--vue-ssr-outlet--&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> {{{ renderState() }}} {{{ renderScripts() }}} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Consider more. <br><br><ul><li>  <i>Meta.inject (). Title.text ()</i> and <i>meta.inject (). Meta.text ()</i> are needed to display headings and meta descriptions.  The <i>vue-meta</i> package is responsible for this, which I will discuss below </li><li>  <i>renderResourceHints ()</i> - will return <i>rel = "preload / prefetch"</i> links to resources specified in the client manifest </li><li>  <i>renderStyles ()</i> - returns links to the styles specified in the client manifest </li><li>  <i>renderState ()</i> - returns the default state of the window .__ INITIAL_STATE__ </li><li>  <i>renderScripts ()</i> - will return the scripts necessary for the application to work </li></ul><br>  Instead of a comment, the markup of our application will be substituted.  It is required. <br><br>  The entry point to our Vue application from the server side is the file <i>entry-server.js</i> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { createApp } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./app'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> context =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">//      Vue const { app, router, store } = createApp(); // $meta - ,   vue-meta   Vue const meta = app.$meta(); //      router.push(context.url); //  -  ,      context.meta = meta; router.onReady(() =&gt; { context.rendered = () =&gt; { //    ,     ,  window.__INITIAL_STATE__ context.state = store.state; }; const matchedComponents = router.getMatchedComponents(); //     if (!matchedComponents.length) { return reject(new Error(404)); } return resolve(app); }, reject); });</span></span></code> </pre><br><h2>  Client part </h2><br>  The client-side entry point is the <i>entry-client.js file</i> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { createApp } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./app'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { app, router, store } = createApp(); router.onReady(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__INITIAL_STATE__) { <span class="hljs-comment"><span class="hljs-comment">//    ,     store.replaceState(window.__INITIAL_STATE__); } app.$mount('#app'); }); //    HMR  ,  webpack-dev-server     hot if (module.hot) { const api = require('vue-hot-reload-api'); const Vue = require('vue'); api.install(Vue); if (!api.compatible) { throw new Error( 'vue-hot-reload-api is not compatible with the version of Vue you are using.', ); } module.hot.accept(); }</span></span></code> </pre><br>  In <i>app.js</i> , our instance of Vue is created, which is then used both on the server and on the client. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Vue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vue'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { sync } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vuex-router-sync'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { createRouter } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./router'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { createStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./client/store'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> App <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./App.vue'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createApp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> router = createRouter(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = createStore(); sync(store, router); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vue({ router, store, <span class="hljs-attr"><span class="hljs-attr">render</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">h</span></span></span><span class="hljs-function"> =&gt;</span></span> h(App), }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { app, router, store }; }</code> </pre><br>  <b>We always create a new instance to avoid a situation where several queries use one instance.</b> <br><br>  <i>App.vue</i> is the root component, which contains the <i>&lt;router-view&gt; &lt;/ router-view&gt;</i> directive, which will substitute the necessary components, depending on the route. <br><br>  The router itself looks like this <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Vue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vue'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Router <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vue-router'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> VueMeta <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vue-meta'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> routes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./routes'</span></span>; Vue.use(Router); Vue.use(VueMeta); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRouter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Router({ <span class="hljs-attr"><span class="hljs-attr">mode</span></span>: <span class="hljs-string"><span class="hljs-string">'history'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routes</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">path</span></span>: routes.pages.main, <span class="hljs-attr"><span class="hljs-attr">component</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>(<span class="hljs-string"><span class="hljs-string">'./client/components/Main.vue'</span></span>) }, { <span class="hljs-attr"><span class="hljs-attr">path</span></span>: routes.pages.about, <span class="hljs-attr"><span class="hljs-attr">component</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>(<span class="hljs-string"><span class="hljs-string">'./client/components/About.vue'</span></span>) }, ], }); }</code> </pre><br>  Through <i>Vue.use</i> we connect two plugins: <i>Router</i> and <i>VueMeta</i> . <br>  In routes, we do not specify the components themselves, but through <br><br><pre> <code class="javascript hljs">() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>(<span class="hljs-string"><span class="hljs-string">'./client/components/About.vue'</span></span>)</code> </pre> <br>  This is necessary for code separation (code-splitting). <br><br>  As for state management (implemented by Vuex), its configuration is not distinguished by anything special.  The only thing is that I have divided the module into modules and use constants with the name in order to make it easier to navigate by code. <br><br>  Now consider some of the nuances in the Vue components themselves. <br><br>  The <i>metaInfo</i> property is responsible for rendering meta data using the <i>vue-meta</i> package.  You can specify a large number of various parameters ( <a href="https://vue-meta.nuxtjs.org/api/">more</a> ). <br><br><pre> <code class="javascript hljs">metaInfo: { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">'Main page'</span></span>, }</code> </pre><br>  Components have a method that runs only on the server side. <br><br><pre> <code class="javascript hljs">serverPrefetch() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Run only on server'</span></span>); }</code> </pre><br>  Also, I wanted to use CSS modules.  I like the idea when you are not obliged to take care of naming classes, so as not to overlap between components.  Using CSS modules, the resulting class will look like <i>&lt;class name&gt; _ &lt;hash&gt;</i> . <br><br>  To do this, you need to specify the <i>style module</i> in the component. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">module</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-class"><span class="css"><span class="hljs-selector-class">.item</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">padding</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">3px</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; } </span><span class="hljs-selector-class"><span class="css"><span class="hljs-selector-class">.controls</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin-top</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">12px</span></span></span><span class="css">; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  And in the template, specify the attribute <i>: class</i> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$style.item"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Also, it is necessary to specify in the settings of the webpack that we will use the modules. <br><br><h2>  Assembly </h2><br>  Let us turn to the webpack settings themselves. <br><br>  We have a basic config that inherit the config for the server and client parts. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpack = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> OptimizeCSSAssetsPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'optimize-css-assets-webpack-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UglifyJsPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'uglifyjs-webpack-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> merge = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-merge'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VueLoaderPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'vue-loader/lib/plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isProduction = process.env.NODE_ENV === <span class="hljs-string"><span class="hljs-string">'production'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> config = { <span class="hljs-attr"><span class="hljs-attr">mode</span></span>: isProduction ? <span class="hljs-string"><span class="hljs-string">'production'</span></span> : <span class="hljs-string"><span class="hljs-string">'development'</span></span>, <span class="hljs-attr"><span class="hljs-attr">module</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.vue$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'vue-loader'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.js$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'babel-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">exclude</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function"> =&gt;</span></span> /node_modules/.test(file) &amp;&amp; !<span class="hljs-regexp"><span class="hljs-regexp">/\.vue\.js/</span></span>.test(file), }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.(png|jpe?g|gif|svg)(\?.*)?$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: { <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'url-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">options</span></span>: { <span class="hljs-attr"><span class="hljs-attr">limit</span></span>: <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'images/[name].[hash:8].[ext]'</span></span>, }, }, }, ], }, <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VueLoaderPlugin(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> webpack.DefinePlugin({ <span class="hljs-string"><span class="hljs-string">'process.env.NODE_ENV'</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(process.env.NODE_ENV), }), ], }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isProduction) { config = merge(config, { <span class="hljs-attr"><span class="hljs-attr">optimization</span></span>: { <span class="hljs-attr"><span class="hljs-attr">minimizer</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OptimizeCSSAssetsPlugin(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UglifyJsPlugin()], }, }); } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = config;</code> </pre><br>  The config for building server code is no different from the one in the <a href="https://ssr.vuejs.org/guide/build-config.html">documentation</a> .  Except for CSS processing. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> merge = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-merge'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> nodeExternals = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-node-externals'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VueSSRServerPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'vue-server-renderer/server-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> baseConfig = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./webpack.base.js'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = merge(baseConfig, { <span class="hljs-attr"><span class="hljs-attr">entry</span></span>: <span class="hljs-string"><span class="hljs-string">'./app/entry-server.js'</span></span>, <span class="hljs-attr"><span class="hljs-attr">target</span></span>: <span class="hljs-string"><span class="hljs-string">'node'</span></span>, <span class="hljs-attr"><span class="hljs-attr">devtool</span></span>: <span class="hljs-string"><span class="hljs-string">'source-map'</span></span>, <span class="hljs-attr"><span class="hljs-attr">output</span></span>: { <span class="hljs-attr"><span class="hljs-attr">libraryTarget</span></span>: <span class="hljs-string"><span class="hljs-string">'commonjs2'</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">externals</span></span>: nodeExternals({ <span class="hljs-attr"><span class="hljs-attr">whitelist</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, }), <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VueSSRServerPlugin()], <span class="hljs-attr"><span class="hljs-attr">module</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'css-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">options</span></span>: { <span class="hljs-attr"><span class="hljs-attr">modules</span></span>: { <span class="hljs-attr"><span class="hljs-attr">localIdentName</span></span>: <span class="hljs-string"><span class="hljs-string">'[local]_[hash:base64:8]'</span></span>, }, }, }, ], }, });</code> </pre><br>  First, all the CSS processing I had was moved to the base config, since  it is needed both on the client and on the server.  There also occurred minification for the production regime. <br>  However, I ran into the problem that a <i>document</i> appeared on the server side, and, accordingly, an error occurred.  This turned out to be <a href="https://github.com/webpack-contrib/mini-css-extract-plugin/issues/48">a</a> <i>mini-css-extract-plugin</i> <a href="https://github.com/webpack-contrib/mini-css-extract-plugin/issues/48">error</a> , which was fixed by dividing the CSS processing for the server and client. <br><br>  <i>VueSSRServerPlugin</i> generates the file <i>vue-ssr-server-bundle.json</i> , which indicates the code that runs on the server. <br><br>  Now consider the client config. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpack = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> merge = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-merge'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VueSSRClientPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'vue-server-renderer/client-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MiniCssExtractPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mini-css-extract-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> baseConfig = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./webpack.base.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isProduction = process.env.NODE_ENV === <span class="hljs-string"><span class="hljs-string">'production'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> config = merge(baseConfig, { <span class="hljs-attr"><span class="hljs-attr">entry</span></span>: [<span class="hljs-string"><span class="hljs-string">'./app/entry-client.js'</span></span>], <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VueSSRClientPlugin()], <span class="hljs-attr"><span class="hljs-attr">output</span></span>: { <span class="hljs-attr"><span class="hljs-attr">path</span></span>: path.resolve(<span class="hljs-string"><span class="hljs-string">'./dist/'</span></span>), <span class="hljs-attr"><span class="hljs-attr">filename</span></span>: <span class="hljs-string"><span class="hljs-string">'[name].[hash:8].js'</span></span>, <span class="hljs-attr"><span class="hljs-attr">publicPath</span></span>: <span class="hljs-string"><span class="hljs-string">'/dist/'</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">module</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: [ isProduction ? MiniCssExtractPlugin.loader : <span class="hljs-string"><span class="hljs-string">'vue-style-loader'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'css-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">options</span></span>: { <span class="hljs-attr"><span class="hljs-attr">modules</span></span>: { <span class="hljs-attr"><span class="hljs-attr">localIdentName</span></span>: <span class="hljs-string"><span class="hljs-string">'[local]_[hash:base64:8]'</span></span>, }, }, }, ], }, ], }, }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isProduction) { config = merge(config, { <span class="hljs-attr"><span class="hljs-attr">output</span></span>: { <span class="hljs-attr"><span class="hljs-attr">filename</span></span>: <span class="hljs-string"><span class="hljs-string">'[name].js'</span></span>, <span class="hljs-attr"><span class="hljs-attr">publicPath</span></span>: <span class="hljs-string"><span class="hljs-string">'http://localhost:9999/dist/'</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> webpack.HotModuleReplacementPlugin()], <span class="hljs-attr"><span class="hljs-attr">devtool</span></span>: <span class="hljs-string"><span class="hljs-string">'source-map'</span></span>, <span class="hljs-attr"><span class="hljs-attr">devServer</span></span>: { <span class="hljs-attr"><span class="hljs-attr">writeToDisk</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">contentBase</span></span>: path.resolve(__dirname, <span class="hljs-string"><span class="hljs-string">'dist'</span></span>), <span class="hljs-attr"><span class="hljs-attr">publicPath</span></span>: <span class="hljs-string"><span class="hljs-string">'http://localhost:9999/dist/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">hot</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">inline</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">historyApiFallback</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-number"><span class="hljs-number">9999</span></span>, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Origin'</span></span>: <span class="hljs-string"><span class="hljs-string">'*'</span></span>, }, }, }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { config = merge(config, { <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MiniCssExtractPlugin({ <span class="hljs-attr"><span class="hljs-attr">filename</span></span>: <span class="hljs-string"><span class="hljs-string">'[name].[hash:8].css'</span></span>, }), ], }); } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = config;</code> </pre><br>  Of noteworthy, in local development, we specify the <i>publicPath</i> that refers to the <i>webpack-dev-server</i> and generate the name of the file without the hash.  Also, for <i>devServer</i> we specify the <i>writeToDisk</i> parameter <i>: true</i> . <br><br>  An explanation is needed here. <br><br>  By default, <i>webpack-dev-server</i> distributes resources from RAM without writing them to disk.  In this case, we are faced with the problem that in the client manifest ( <i>vue-ssr-client-manifest.json</i> ), which is located on the disk, irrelevant resources will be indicated, since  It will not be updated.  To get around this, we tell the dev server to write the changes to disk, in which case the client manifest will be updated and the necessary resources will be pulled. <br><br>  In fact, in the future I want to get rid of it.  One of the solutions is in virgins.  In <i>server.js</i> mode, connect the manifest not from the <i>/ dist</i> directory, but from the url of the dev server.  But in this case, it becomes an asynchronous operation.  I will be glad to a beautiful solution to the problem in the comments. <br><br>  Nodemon is responsible for server side <a href="https://github.com/remy/nodemon">reloading</a> , which monitors the two files: <i>dist / vue-ssr-server-bundle.json</i> and <i>app / server.js</i> and, when changed, restarts the application. <br><br>  To be able to restart the application when changing <i>server.js</i> , we do not specify this file as an input point in <i>nodemon</i> , but create a file <i>nodemon.js</i> , in which we include <i>server.js</i> .  And the input point is the <i>nodemon.js</i> file. <br><br>  In production mode, the input point is <i>app / server.js</i> . <br><br><h2>  Conclusion </h2><br>  Total, we have a repository with settings and several teams. <br><br>  <b>For local development:</b> <br><br><pre> <code class="javascript hljs">yarn run dev</code> </pre> <br>  On the client side: launches a <i>webpack-dev-server</i> , which monitors the change in Vue components and just the code, generates a client manifest with paths to the dev server, saves it to disk and updates the code, styles on the fly in the browser. <br><br>  From the server side: launches the <i>webpack</i> in monitoring mode, <i>builds the</i> server bundle ( <i>vue-ssr-server-bundle.json</i> ) and when changed, restarts the application. <br><br>  In this case, the code changes consistently on the client and the server automatically. <br>  When you first start it may be an error that the server bundle is not found.  This is normal.  Just need to restart the command. <br><br>  <b>For production builds:</b> <br><br><pre> <code class="javascript hljs">yarn run build</code> </pre> <br>  On the client side: collects and minifies js and css, adding a hash to the name and generates a client manifest with relative paths to the resources. <br><br>  From the server side: builds a server bundle. <br><br>  Also, I also created the <i>yarn run start-node</i> command, which starts <i>server.js</i> , but this is done for example only, in a production application, you should use process managers, for example, PM2, to start. <br><br>  I hope that the described experience will help to quickly set up the ecosystem for comfortable work and focus on the development of functionality. <br><br><h2>  useful links </h2><br><ul><li>  <a href="https://github.com/horprogs/vue-ssr-hmr">code repository</a> </li><li>  <a href="https://vue-ssr-hmr.herokuapp.com/">demo applications</a> </li><li>  <a href="https://ssr.vuejs.org/">Vue.js configuration documentation with SSR</a> </li><li>  <a href="https://vue-loader.vuejs.org/guide/css-modules.html">CSS module configuration documentation</a> </li><li>  <a href="https://vuex.vuejs.org/">Vuex documentation</a> </li><li>  <a href="https://vue-meta.nuxtjs.org/guide/">Vue Meta documentation</a> </li><li>  <a href="https://github.com/vuejs/vue-hot-reload-api">Vue Hot Reload Api repository</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/458396/">https://habr.com/ru/post/458396/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458382/index.html">Why do we teach this?</a></li>
<li><a href="../458384/index.html">HP 3D Structured Light Scanner Pro S3 3D Scanner Review and Testing</a></li>
<li><a href="../458388/index.html">Deep (Learning + Random) Forest and parsing articles</a></li>
<li><a href="../458390/index.html">Ceph - from ‚Äúon the knee‚Äù to ‚Äúproduction‚Äù part 2</a></li>
<li><a href="../458394/index.html">Securing wireless protocols using LoRaWAN as an example</a></li>
<li><a href="../458398/index.html">Remote hygiene or telepathy benefits</a></li>
<li><a href="../4584/index.html">Rambler turned off the TV</a></li>
<li><a href="../45840/index.html">Operator @ in php</a></li>
<li><a href="../458402/index.html">Micro-computer UKNTS Elektronika MS 0511 - installation of a DC-DC converter for powering the C2 (RS232)</a></li>
<li><a href="../458406/index.html">30+ questions about service and non-service programs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>