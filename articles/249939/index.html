<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A little more reverse engineering of UEFI PEI modules on another useful example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="And hello again, dear habrachititeli. 

 As part of the struggle for the possibility of modifying UEFI on HP laptops, we had to break off another prot...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A little more reverse engineering of UEFI PEI modules on another useful example</h1><div class="post__text post__text-html js-mediator-article">  And hello again, dear habrachititeli. <br><br>  As part of the struggle for the possibility of modifying UEFI on HP laptops, we had to break off another protection, this time more modern.  Apparently, HP‚Äôs firmware development department guessed that the <a href="http://habrahabr.ru/post/249655/">previous protection was not so hot</a> , and therefore they decided to improve it radically, so the DXE-volume protection method from the previous article stopped working, and I again needed to arm myself with a disassembler and develop a <abbr title="Terse executable">TE</abbr> to <abbr title="Portable executable">PE</abbr> converter and answer the same questions: where is the digital signature, who exactly is checking it and how to make it so that the check always ends in success. <br><br>  If you are interested in the answers and description of the process of their search - I ask for cat. <br><a name="habracut"></a><br><h2>  Brief background </h2><br>  Protection, about the burglary of which will be discussed in this text, was introduced by HP about a year and a half ago, and (as far as I know) was still considered reliable.  HP laptop users with UEFI protected by it periodically visited the <a href="https://www.bios-mods.com/forum/">bios-mods.com forum</a> hoping for help in getting rid of the white lists of equipment or opening the hidden UEFI Setup settings, but with the same periodicity they received the answer - protection is resistant and nothing is done.  In the early summer of 2014, <a href="http://donovan6000.blogspot.de/">one of the administrators of bios-mods</a> got tired of this and decided to take the initiative on hacking into his own hands.  The process has begun, but extremely slowly, and the result of the public has not yet appeared, and repairmen really need it, who would be happy to install other processors / video cards / modems on these laptops, but they cannot, because  for their proper operation, a modification of the DXE drivers is needed, and after it the firmware does not start.  As a result, I got sick of this nonsense and I decided to break off the protection myself, since, as it turned out, HP couldn‚Äôt think of anything more complicated than the previous protection. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Likbeza will not </h2><br>  If you do not understand what is happening here, read the <a href="http://habrahabr.ru/post/249655/">previous article</a> , there is a brief introduction to the course of the case and a list of tools used. <br><br><h2>  What is given and what is required to find </h2><br>  There is an HP laptop, which responds to any change in the DXE volume by first rebooting almost immediately after switching on, and then flows into an endless cycle, blinking lights on the keyboard.  There is also a <a href="">dump of its firmware</a> and kind repair guys ready to take the time to check the next modified firmware for performance. <br><br>  The ultimate goal - the firmware should work after modifications. <br><br><h2>  Search </h2><br>  Open the <a href="https://github.com/LongSoft/UEFITool/releases/latest">UEFITool</a> firmware <a href="https://github.com/LongSoft/UEFITool/releases/latest">again</a> and look at the Messages panel.  Thanks to the experience gained in the last article, the utility now knows how to display non-standard data in the tree (that is, it is not necessary now to unpack the entire DXE volume to get to them) and stores it when reassembling a volume: <br><br><img src="https://habrastorage.org/files/0e7/555/db5/0e7555db57224dbbbf0c8bc2c0199fad.png"><br><br>  Like last time, the suspicious data is at the very end of the DXE volume, but now you can get it directly from the tree, which we do, we get the file <i>key.bin</i> , which we then open in the Hex editor: <br><br><img src="https://habrastorage.org/files/cfa/e74/ab1/cfae74ab18c84f8b955cb5441c20dc10.png"><br><br>  And again an unknown piece of data with a size of 100h (similar to the public key in RSA2048) appears before it, but now it has a signature - <i>$ HSS</i> .  As I already wrote, data of this kind can be found either by signature or by offset within the volume, or by absolute address (taking into account that the last byte of the SPI-flash chip turns out to be at the start at FFFFFFFFh).  First check the first option using the UEFITool text search: <br><br><img src="https://habrastorage.org/files/ff7/d94/6bd/ff7d946bd6ea4321b252beb539d924b6.png"><br><br>  We find 4 occurrences of the required string, one of which we have already looked at (the one that is inside Non-UEFI data), we need to deal with the rest.  The first is in the DXE driver called BiosImageInterface, but he himself is in the volume that is intended to check, so that the presence of the main test there is very unlikely.  If we do not find it in other places, it will be necessary to return to it. <br><br>  The last two entries indicate two copies of the same PEI-module, the first of which is in the packed copy of the PEI-volume (it can be used to automatically recover the damaged PEI-volume), and the other - in the "real" PEI-volume.  That's our suspect, everything indicates that it is he who checks the integrity, and you need to get its contents to the <i>hss.bin</i> file for further analysis. <br><br>  Last time at this place we loaded the resulting file into IDA and began to analyze it, but in this case only the holders of IDA 6.7 and above can do this.  It was in 6.7 that the native support for <a href="http://wiki.phoenix.com/wiki/index.php/Terse_Executable_Format">the Terse Executable format appeared</a> , in which our PEI module is stored.  This format was developed by the authors of the UEFI PI specification to save space in the processor cache, in fact it is PE32 with a heavily truncated header, which was left only for the vital ones needed for the field image to load properly.  Moreover, in the PEI phase, most manufacturers use an extremely primitive executable file loader that does not support relocations, and therefore its base address must match the physical address.  All this is wonderful, of course, but we need not an incomprehensible TE, but an understandable PE32, so we <a href="https://github.com/NikolajSchlej/TE2PE">had to write a TE to PE converter</a> that tries to reconstruct the header of the PE file from the data that we found in the TE file.  The utility was written in half an hour and for a specific file, so I cannot vouch for the correctness of converting any pre-defined TE-image. <br><br>  Now we have a <i>pe.bin</i> file and we can open it in IDA and conduct analysis.  This time, let's go a little different way and start not from the entry point, but from the place where the <i>$ HSS</i> signature is encountered.  Go to <i>Search -&gt; Text ...</i> (or press <i>Alt + T</i> ), enter $ HSS, set the Find all occurences checkbox and ... find nothing.  We think a little and we understand that we have a LittleEndian-machine, and $ HSS will look like SSH $ or 53534824h when loaded into the register.  We are looking for this option and voila, one entry: <br><br><img src="https://habrastorage.org/files/748/5be/1a4/7485be1a4abd48a18773ce8cb3bb64e3.png"><br><br>  Go to double click on the message and get here: <br><br><img src="https://habrastorage.org/files/df3/89d/527/df389d5271634288a9c5bde507d62e9c.png"><br><br>  And here is a check that 53534824h lies at the address from EBX, and if it really lies there - EBX + 20h is saved to the stack, i.e.  just the address of the first byte of the key, and if it does not lie, 10h is added to EBX and checked again.  It is also seen that the value FFF3DF00h, which is the physical address of the first key byte, can fall into the same variable from another branch of the code.  You can check this, for which it suffices to subtract FFF3DF00h from 100000000h and retreat received C2100h bytes from the end of the file - as expected, we are exactly at the beginning of the block with the key.  Whether the key is found by signature or absolute address depends on the BootMode.  If the current mode is 20h, i.e.  <a href="http://feishare.com/edk2doxygen/d9/d44/_include_2_boot_mode_8h_source.html">BOOT_IN_RECOVERY_MODE</a> - the key will be found at the absolute address, otherwise - by the signature. <br><br>  Look further: <br><br><img src="https://habrastorage.org/files/e5b/13d/6b7/e5b13d6b74314d38828b871548e6c7b4.png"><br><br>  And then there is a function call from some HP-specific <abbr title="PEI-to-PEI Interface">PPI</abbr> , which performs the check.  If this function returns 0 (i.e. EFI_SUCCESS), then we move down to return from this screen, if the check fails, everything depends on the BootMode again, in the case of BOOT_IN_RECOVERY_MODE, the function is called from another PPI (which I suspect will try to recover the DXE volume from the Recovery image).  Then, independently of BootMode, another function is called from the second PPI, after which 6 and 0CF9h are put on the stack and the short function is called, in our case it looks like this: <br><br><pre><code class="hljs objectivec">mov al, <span class="hljs-number"><span class="hljs-number">6</span></span> mov dx, <span class="hljs-number"><span class="hljs-number">0</span></span>CF9h <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> dx, al</code> </pre> <br>  If you suddenly did not recognize it in make-up, this is the most common method of hard reset via IO-ports.  And if the reset suddenly did not happen, an infinite loop will happen that immediately follows it. <br><br>  Well, with the reasons for the reset figured out, now we need to get around it, and so, to return EFI_SUCCESS to EAX from the function in which all this happens.  In my opinion, the easiest way to achieve the desired is to change the first <i>test eax, eax</i> to <i>xor eax, eax</i> , as a result 0 will appear in EAX, and JGE will work 100% of the time, and the reset will become a dead code. <br><br>  <b>UPD by numerous requests from the LAN</b> : to quickly find a place for a patch, you need to get from the file with GUID 86D70125-BAA3-4296-A62F-602BEBBB9081 an executable section (it can be both TE and PE, I met both options), open it in the Hex editor, find the $ HSS line and find the first occurrence of the pattern 85 C0 after $ HSS - with a very high probability this is the place for the patch.  If not, you will have to look for it yourself. <br><br><h2>  Testing and conclusion </h2><br>  Said and done, patch 85 C0 -&gt; 31 C0, collect the firmware (do not forget that we have two copies of this file and we need to replace both) and send it to our repairmen for testing.  After 5 minutes, a message arrives: ‚Äúit starts and runs, thank you very much.‚Äù  Now you can sit down and write an article about cool vendor defenses, which are held for a year and a half, and then removed in an hour and a half. <br><br>  Thank you for your attention, successful firmware and modifications. <br><br><div class="spoiler">  <b class="spoiler_title">PS As a bonus, a fig photo of a running laptop with a replaced Boot Logo, stored in a DXE volume.</b>  <b class="spoiler_title">Indicates that protection is really removed.</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/53f/4fd/688/53f4fd688de043359f67815371aa2c03.jpg"><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/249939/">https://habr.com/ru/post/249939/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249923/index.html">Radio electronics, or how I began to comprehend it</a></li>
<li><a href="../249927/index.html">Free and safe: the main myths of free software</a></li>
<li><a href="../249929/index.html">Random maze on js in you know how many lines</a></li>
<li><a href="../249931/index.html">EMC VMAX 3: Enterprise Data Management Platform</a></li>
<li><a href="../249933/index.html">Automating Storage Infrastructure with ViPR Controller: IT as a Service in Action</a></li>
<li><a href="../249945/index.html">Automate backup tasks with vCenter Orchestrator via Veeam Restful API</a></li>
<li><a href="../249949/index.html">Reliable localStorage for bookmarklets</a></li>
<li><a href="../249951/index.html">TheRole 3. Authorization for Ruby on Rails</a></li>
<li><a href="../249953/index.html">Freeloot: is freelance free?</a></li>
<li><a href="../249955/index.html">Survey online courses in mathematics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>