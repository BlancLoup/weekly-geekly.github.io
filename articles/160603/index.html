<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Localization of VN on the example of Hoshizora no Memoria</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Just do not say that geeks do not read VN. So, there is one visual (profile on vndb) . 
 Very good, by the way, a rating of 8.06, I advise you to read...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Localization of VN on the example of Hoshizora no Memoria</h1><div class="post__text post__text-html js-mediator-article">  Just do not say that geeks do not read VN.  So, there is one visual <a href="http://vndb.org/v1474">(profile on vndb)</a> . <br>  Very good, by the way, a rating of 8.06, I advise you to read to those who are not confused by a certain amount of hentai. <br>  Well, in general, not about this article. <br>  There is an English patch, there is a Chinese.  There is no Russian.  Not fair.  Let's try to fix it. <br>  It will take: <br><ul><li>  <b>WinHex.</b>  Where do without him. </li><li>  <b>MadEdit.</b>  An open source alternative to the Winhex, which I couldn‚Äôt force to display Shift-JIS normally.  In general, according to Wiki, in the made the richest support for languages ‚Äã‚Äãand encodings. </li><li>  To collect the localization program in C, so some IDE.  I used <b>Visual Studio</b> , although there are no particularly specific things, probably, any will. </li></ul><br><br><a name="habracut"></a><br><h4>  Study </h4><br>  Let's start a new game, see the first sentence - <b>"„ÅØ ÂΩºÂ•≥ „Åå Â•Ω „Åç „Åç „Å† „Å£ „Åü"</b> .  In the English version - <b>"I liked her"</b> .  Remember, it is still useful to us.  Close the game, go to the folder.  We see there a couple of suspicious files - <b>‚ÄúMemoria.hcb‚Äù</b> and <b>‚ÄúMemoriaEN.hcb‚Äù,</b> respectively.  Let's start with the first.  Open the hex editor, see the first 4 bytes.  Something very similar.  We check with <b>..En.hcb</b> , and make sure that this is nothing more than a file size of minus 2029 bytes in Big Endian.  The last 2029 bytes are occupied by the code that is called when the game is closed (smooth shading of the image and output of the farewell text).  In principle, it might be necessary to change this, but in this version of localization is not required. <br><br>  Now we are looking for the phrase <b>‚ÄúI liked her‚Äù.</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/3b1/9f6/972/3b19f6972cdf22ef6806876338a451a4.png"><br><br>  If you write a few lines in a row, some regularity becomes visible: <br><ul><li>  All strings begin with 0EXX, where XX is the size of the string in bytes, including the null character </li><li>  After the line - 06 XX XX XX.  These 4 bytes obviously increase from line to line. </li></ul><br>  Suppose this is again some kind of offset.  Well, let's follow it.  We appear immediately after the phrase <b>"‰ø∫ „ÅØ ÂΩºÂ•≥ „Åå Â•Ω „Åç „Å† „Å£ „Åü".</b>  Almost.  The first pair of characters turned into some kind of mess. <br><br><img src="https://habrastorage.org/storage2/8f7/484/738/8f748473862b2a53fb36e031dd42e955.png"><br><br>  The first 5 bytes are replaced by similar ones <b>06 XX XX XX XX!</b>  At this address is just the beginning of the <b>‚ÄúI liked her‚Äù</b> , or rather, 0E.  After the line, some kind of magic begins.  It was experimentally established that the sequence <b>08 08 08 02 E3 89 04 00 02 7F 98 04 00 is</b> waiting for a mouse click or keystroke ‚Äî confirming the transition to the next line.  This is still useful. <br><br>  If to generalize, the following structure turns out: <br>  In the original script: <br>  0E &lt;size, 1 byte&gt; &lt;Text, size bytes, encoded in <b>Shift-JIS</b> &gt; &lt;13 bytes, confirmation that the player has read the text&gt; <br>  &lt;some checks, depending on them &lt;06 move to the next line or to another storyline branch &gt;&gt; <br><br>  In the English patch, a classic trick was used - if you need to insert the code in a certain place, but you can't knock down the addressing, then we jump to the end of the file, we do our business there, we go back. <br><br>  Thus, 5 bytes of the original string are changed to &lt;06&gt; &lt;address slightly further than the original end of the file&gt; <br>  and there is &lt;0E&gt; &lt;jump to that 13-byte check&gt; <br><br><h4>  Ripping text </h4><br>  The utility was written in haste, which tears out the text from the script <br><div class="spoiler">  <b class="spoiler_title">ripper</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;conio.h&gt; #include &lt;iostream&gt; void main() { FILE *en; FILE *jp; FILE *out; en = fopen("MemoriaEN.hcb", "rb"); jp = fopen("Memoria.hcb", "rb"); out = fopen("out.txt", "w"); fseek(en, 0x8c827, SEEK_SET); fseek(jp, 0x8c827, SEEK_SET); unsigned char todo_en[50]; unsigned char todo_jp[50]; unsigned char size_en; unsigned char size_jp; char str_en[255]; char str_jp[255]; unsigned int off_en; unsigned int off_en2; unsigned int off_en3; bool r = true; do { fread(&amp;todo_en, 1, 1, en); fread(&amp;todo_jp, 1, 1, jp); if ((todo_en[0] ) != 6 || (todo_jp[0] ) != 14) break; fread(&amp;size_jp, 1, 1, jp); fread(str_jp, size_jp, 1, jp); fread(&amp;off_en, 1, 4, en); fseek(en, off_en, SEEK_SET); fread(&amp;todo_en, 1, 1, en); if ((todo_en[0] ) != 14) break; fread(&amp;size_en, 1, 1, en); fread(str_en, size_en, 1, en); //fwrite(str_jp, size_jp, 1, out); //fwrite((const char *) "\n", 1, 1, out); fwrite(str_en, size_en, 1, out); fwrite((const char *) "\n", 1, 1, out); fwrite((const char *) "\n", 1, 1, out); fread(&amp;todo_en, 1, 1, en); if ((todo_en[0] ) != 6) break; fread(&amp;off_en, 1, 4, en); if (off_en == 0x0045793e) break; off_en2 = ftell(en); fseek(en, off_en, SEEK_SET); fseek(jp, ftell(en), SEEK_SET); do { fread(&amp;todo_jp, 1, 1, jp); fread(&amp;todo_en, 1, 1, en); if (todo_en[0] == 6 &amp;&amp; todo_jp[0] == 14) break; } while (!feof(en)); fseek(en, -1, SEEK_CUR); fseek(jp , ftell(en), SEEK_SET); } while (true); fclose(jp); fclose(en); fclose(out); }</span></span></span></span></code> </pre> </div></div><br><br>  The code is completely non-optimal, but it copes with its work, in a few seconds it generates 2.5 megabytes (or Mibibite?) Of the text.  If you uncomment 2 lines in the middle, the text will be collected - Japanese - English bilingual. <br><br>  Here I cheated a little, because I didn‚Äôt study the format of the checks after the text in detail, and I get the address of the beginning of the next line by comparing the English and the Japanese script. <br><br><h4>  Putting text back </h4><br>  Suppose we somehow translated the received text, now it would be nice to shove it back. <br>  One more softinka, the code is already corrected, the error description - further. <br><br><div class="spoiler">  <b class="spoiler_title">puffer</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;conio.h&gt; #include &lt;iostream&gt; unsigned char buff[0x7fffff]; unsigned int end; //offset of russian strings unsigned char s[1024]; unsigned int retpos; //return here after russian unsigned char cl[13] = {0x08, 0x08, 0x08, 0x02 , 0xE3 , 0x89 , 0x04, 0x00, 0x02, 0x7F, 0x98, 0x04, 0x00}; //prompt for click unsigned char ro = 250; //max len of string unsigned char todo_en; //must be 0x06 or 0x14 unsigned char size_en; //size of engish string unsigned char jmp = 0x06; //jumps to xx xx xx xx in LE unsigned char stl = 0x0E; //indicates new sring int ts; int k; unsigned char d; int parts; FILE *en; FILE *trans; FILE *text; char str1[255]; void main() { en = fopen("MemoriaENO.hcb", "rb"); //non-modifed english script text = fopen("text.txt", "r"); //translated strings trans = fopen("MemoriaEN.hcb", "wb"); //translated script rewind(trans); rewind(text); fseek(en, 0, SEEK_END); end = ftell(en); //begin writing localization here rewind(en); fread(buff, end, 1, en); fwrite(buff, end, 1, trans); fseek(en, 0x45798e, SEEK_SET); do { s[0] = '\0'; ts = 0; do { fscanf(text, "%c", &amp;s[ts]); ts++; } while (s[ts-1] != 0); fseek(text, 4, SEEK_CUR); //get new string, terminated with \0 fseek(trans, ftell(en), SEEK_SET); fread(&amp;todo_en, 1, 1, en); //if ((todo_en) != 14) break; fread(&amp;size_en, 1, 1, en); fseek(en, size_en, SEEK_CUR); retpos = ftell(en); //english string begin + len = return here after russian fwrite(&amp;jmp, 1, 1, trans); fwrite(&amp;end, 4, 1, trans); //jump to the russian line fseek(trans, end, SEEK_SET); if (ts &lt;= ro) { //if length of line &lt; byte, just write it fwrite(&amp;stl, 1, 1, trans); fwrite(&amp;ts, 1, 1, trans); fwrite(s, ts, 1, trans); end += (ts + 2 + 5); } else { //get maximum amount of words, which does not exceed byte //and write it end += (ts + 2 + 5); do { str1[0] = '\0'; memcpy(str1, &amp;s, ro); strrev(str1); d = strcspn(str1, " "); strrev(str1); str1[ro-d] = '\0'; d = strlen(str1); memcpy(s, &amp;s[d], ts - d); ts -= (d + 1); str1[d-1] = 0x00; fwrite(&amp;stl, 1, 1, trans); fwrite(&amp;d, 1, 1, trans); fwrite(&amp;str1, d, 1, trans); fwrite(cl, 13, 1, trans); end += 15; } while (ts &gt; ro); //write the remaining part of line s[ts] = 0x00; fwrite(&amp;stl, 1, 1, trans); fwrite(&amp;ts, 1, 1, trans); fwrite(&amp;s, ts+1, 1, trans); } fwrite(&amp;jmp, 1, 1, trans); fwrite(&amp;retpos, 4, 1, trans); //jump back to english fseek(en, 5, SEEK_CUR); if (retpos == 0x732aaf) break; //exit in case of last line } while (true); fclose(en); fclose(trans); fclose(text); }</span></span></span></span></code> </pre><br></div></div><br><br>  Another ‚Äúmasterpiece‚Äù of the code, of course, but it does what it takes, and also in a couple of seconds. <br><br>  Run, going.  We are trying to play with the translation.  The first few sentences are fine, <br>  and suddenly - Runtime Error! <br>  Again, take the hex editor, looking for a problem proposal.  That's it.  The length of the line is 1 byte, the translation is longer, as a result, the size overflows, and the game considers that the text is not 300 bytes, but 45. Accordingly, the engine tries to ‚Äúexecute‚Äù some symbol in the middle of a sentence as an instruction, with a clear result. <br>  Recall those 13 bytes.  So, when the size is exceeded, we break the text into parts, give the first, <br>  waiting for a click, give the second, until the text is over.  You can, of course, rephrase the translation, but it's better to be safe. <br><br><h4>  Total </h4><br><br>  Install the font Segoe UI in the game ... <br><br><img src="https://habrastorage.org/storage2/a9b/0fc/78a/a9b0fc78adcd870c1f37688ba0c03b08.png"><br><br>  True, line breaks are not always optimal, sometimes the phrase breaks right in the middle of a word. <br>  The game supports the manual indication of the location of the gap, for this you need to place a tilde in the desired location.  It would be necessary to modify the "zapihivatel", so that he arranged tildes.  Also, until the names of the characters and menus are translated.  Names are easy to change right in the script, but I‚Äôm not sure about the menu yet.  It looks like you need to dig out more resources and redraw some of the graphics. <br><br>  I created a project for the translation on the Notabenoid, who wants to - can participate, alone and cannot master it for a year. <br>  <a href="http://www.notabenoid.com/book/35231">Notabenoid</a> . </div><p>Source: <a href="https://habr.com/ru/post/160603/">https://habr.com/ru/post/160603/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160591/index.html">RTLS, GPS and video surveillance. Instead of or together?</a></li>
<li><a href="../160593/index.html">Podgames Weekly # 113 - Podcast on games and industry</a></li>
<li><a href="../160595/index.html">Non-binary logic</a></li>
<li><a href="../160597/index.html">Gelius Team Presentation</a></li>
<li><a href="../160599/index.html">Notifications about password expiration in Active Directory using PowerShell</a></li>
<li><a href="../160605/index.html">Why does Apple need Twitter?</a></li>
<li><a href="../160607/index.html">Natural death monopolies</a></li>
<li><a href="../160609/index.html">Open Build Service - we create our own repositories</a></li>
<li><a href="../160611/index.html">UIDesign Group office</a></li>
<li><a href="../160613/index.html">HTC Windows Phone 8X - the ease of novelty</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>