<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yii 2.0: Dynamic addition of validated form fields through a ‚Äújacket‚Äù (pjax) for a multi-model form</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, Habr! 
 Not so long ago, I was faced with the task of developing a form with the ability to dynamically add fields, each field was a separat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yii 2.0: Dynamic addition of validated form fields through a ‚Äújacket‚Äù (pjax) for a multi-model form</h1><div class="post__text post__text-html js-mediator-article">  Good day, Habr! <br>  Not so long ago, I was faced with the task of developing a form with the ability to dynamically add fields, each field was a separate database entity, that is, a field = an entry in the database.  Despite the fact that my task was not trivial, everyone may well be faced with something similar in one way or another.  For example, adding a new element right inside the GridView and then editing and saving. <br><br>  So, let's begin. <br><a name="habracut"></a><br><br><h4>  Lyrical digression </h4><br>  During the development of this solution, I rummaged through the entire Internet and did not find a single worthwhile recipe either on the English-speaking forums, nor on the SO or GitHub.  Moreover, by that time, support for the validation of dynamic fields by Yii was not yet ready.  More details <a href="http://habrahabr.ru/post/238447/">here</a> .  And now, as it seems to me, it does not suit me. <br>  The decision itself does not pretend to be super-elegant, so I‚Äôll listen with pleasure to any constructive, criticism and advice. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Initial setup </h4><br>  First of all, we need a model that is able to get multiple records from one or several tables.  In my case, I had the relationship hasMany.  Thus, we can get an array of models of all addresses as follows: <br><br><pre><code class="php hljs">$addresses = $model-&gt;addresses;</code> </pre> <br><br>  For the sake of example, you can imagine that we have a view for the user who wants to display a list of addresses with the ability to edit each one, as well as add a new address (entities are taken from the ceiling). <br>  Prepare the form itself (we will assume that the controller gives only $ model as a user model): <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">widgets</span></span>\<span class="hljs-title"><span class="hljs-title">ActiveForm</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">helpers</span></span>\<span class="hljs-title"><span class="hljs-title">Url</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">helpers</span></span>\<span class="hljs-title"><span class="hljs-title">Html</span></span>; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $form = ActiveForm::begin([ <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; Url::toRoute([<span class="hljs-string"><span class="hljs-string">'addresses/update'</span></span>, <span class="hljs-string"><span class="hljs-string">'userId'</span></span> =&gt; $model-&gt;id]), <span class="hljs-string"><span class="hljs-string">'options'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'data-pjax'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1'</span></span> ], <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'adressesUpdateForm'</span></span> ]); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($model-&gt;adresses <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $address): <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= $form-&gt;field($address, <span class="hljs-string"><span class="hljs-string">"[$key]name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= $form-&gt;field($address, <span class="hljs-string"><span class="hljs-string">"[$key]value"</span></span>) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">endforeach</span></span> <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= Html::submitButton(<span class="hljs-string"><span class="hljs-string">''</span></span>, [<span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'btn btn-primary'</span></span>]) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> ActiveForm::end(); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  The form is ready.  In the code above, we first connect the necessary classes ‚Äî the ActiveForm widget and two helpers. <br>  Next, create an ActiveForm with the following parameters: <br><ul><li>  action - it is clear, it sends the form to a specific action controller of the addresses with the parameter userId.  (this parameter will come in handy later) </li><li>  options array with a single data-pjax value, which activates the work of the ‚Äújacket‚Äù for a specific form (activation is not required for links, but the forms must be specified). </li><li>  and form id - if you do not set the form id and still have many widgets on the page or several ActiveForm, then after working by the server, pjax will return the form with id w0, and identifiers may intersect with other forms on the page, which we absolutely do not need. </li></ul><br><br>  After creating the form, we start the cycle to the addresses, I used the getter directly, and you should not be afraid that at each iteration a request to the database will occur, Yii stores all relational requests in a private array of relations.  Next, print the name and value from the table (or any other fields and more complex markup.) <br><br>  The impatient reader will probably ask: ‚ÄúBut what about the button for adding a new address?‚Äù - do not rush, everything is in order. <br><br>  There are basic blanks, let's connect the view file as an internal view file to the complex view user. <br>  Suppose we have a user profile page, and the addresses are displayed immediately below it, add view addresses and ‚Äúdress in a jacket‚Äù at the same time: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">widgets</span></span>\<span class="hljs-title"><span class="hljs-title">Pjax</span></span>; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'_profile'</span></span>, [<span class="hljs-string"><span class="hljs-string">'model'</span></span> =&gt; $model]) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> Pjax::begin([<span class="hljs-string"><span class="hljs-string">'enablePushState'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>]); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'_addresses'</span></span>, [<span class="hljs-string"><span class="hljs-string">'model'</span></span> =&gt; $model]) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> Pjax::end(); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  I draw your attention to the parameter enablePushState, without it we will get the address change in the address bar of the browser.  We do not need this, because all the work of the controller will go through renderAjax, and we will not have a full view with the layout in this part. <br><br><h4>  Controller </h4><br>  I specifically identified the controller as a separate chapter. <br>  Let's first think about how it will work.  It looks simple.  We receive a request for action update with information about the user id, then we update the model and give renderAjax ('_ addresses', ['model' =&gt; $ user]);  In turn, we get $ user through User :: findOne ($ userId), which we carefully passed along with the form. <br>  However, the reality is a little more complicated: <br><ol><li>  We have more than one model </li><li>  We need batch upload </li><li>  Need batch validation </li></ol><br><br>  So, let's go: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">backend</span></span>\<span class="hljs-title"><span class="hljs-title">controllers</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yii</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">common</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">common</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>\<span class="hljs-title"><span class="hljs-title">Addresses</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">base</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">filters</span></span>\<span class="hljs-title"><span class="hljs-title">AccessControl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">web</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">web</span></span>\<span class="hljs-title"><span class="hljs-title">NotFoundHttpException</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Addresses controller */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddressesController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre><br><br>  This is what the controller class will look like without methods. <br><br>  Add batch loading as a controller method (you can do with the model method, but it seemed to me more correct, besides, in my example, I needed to save not only the models, but also the link to the user table via link ()): <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Update all addresses * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Model $items * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> nothing */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">batchUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($items)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Model::loadMultiple($items, Yii::$app-&gt;request-&gt;post()) &amp;&amp; Model::validateMultiple($items)) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($items <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $item) { $item-&gt;save(); } } }</code> </pre><br><br>  We can improve the method by returning true or the number of updated records in case of success and false if there is no data to update.  I did not need it. <br><br>  Add two methods to search for models.  The first is for User, the second is for Address (I just wondered if it would be possible to wrap these two methods in one): <br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Finds the Addresses model based on its primary key value. * If the model is not found, a 404 HTTP exception will be thrown. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> integer $id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Addresses the loaded model * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> NotFoundHttpException if the model cannot be found */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($model = Addresses::findOne($id)) !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $model; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotFoundHttpException(<span class="hljs-string"><span class="hljs-string">'The requested page does not exist.'</span></span>); } } <span class="hljs-comment"><span class="hljs-comment">/** * Finds the User model based on its primary key value. * If the model is not found, a 404 HTTP exception will be thrown. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> integer $id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> User the loaded model * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> NotFoundHttpException if the model cannot be found */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($model = User::findOne($id)) !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $model; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotFoundHttpException(<span class="hljs-string"><span class="hljs-string">'The requested page does not exist.'</span></span>); } }</code> </pre><br><br>  And finally, we write our action: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userId)</span></span></span><span class="hljs-function"> </span></span>{ $user = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;findUser($userId); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;batchUpdate($user-&gt;addresses); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;renderAjax(<span class="hljs-string"><span class="hljs-string">'_addresses'</span></span>, [<span class="hljs-string"><span class="hljs-string">'model'</span></span> =&gt; $user]); }</code> </pre><br><br>  Do not forget to add access control. <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">behaviors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'access'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; AccessControl::className(), <span class="hljs-string"><span class="hljs-string">'rules'</span></span> =&gt; [ [ <span class="hljs-string"><span class="hljs-string">'actions'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'create'</span></span>, <span class="hljs-string"><span class="hljs-string">'update'</span></span>, <span class="hljs-string"><span class="hljs-string">'delete'</span></span>], <span class="hljs-string"><span class="hljs-string">'allow'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">'roles'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'@'</span></span>], ], ], ] ]; }</code> </pre><br>  In the method above, I hurried and immediately showed the create and delete methods.  They are not there yet, but it is better to add two methods to the access control in advance than to catch the exception about forbidden access. <br><br>  Well, now we have a great form, which updates pjax data for all addresses.  In the usual case, we could add a ‚Äúadd‚Äù and ‚Äúdelete‚Äù button to the form and send a request for a specific action, and in the case of ‚Äúadd‚Äù a separate view as well. <br><br><h4>  Dynamic fields with validation </h4><br>  So we got to the most important. <br>  Simply adding a new entity comes down to the following actions: <br><ul><li>  Add a button in view that leads to action - addresses / create </li><li>  Add a function to create fake records in the database. </li><li>  Add action </li><li>  Display the view via ajax. </li></ul><br><br>  Creating fake entries is done through the addOne () model method. <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;name = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DEFAULT_NAME; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;value = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DEFAULT_VALUE; }</code> </pre><br>  Remember to create constants in the model class. <br><br>  The action in the controller will look like this: <br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * action call by AJAX to create new fake address * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> integer $userId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userId)</span></span></span><span class="hljs-function"> </span></span>{ $user = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;findUser($userId); $model = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Addresses; $model-&gt;addOne(); $user-&gt;link(<span class="hljs-string"><span class="hljs-string">'addresses'</span></span>, $model); <span class="hljs-comment"><span class="hljs-comment">// link      ,   return $this-&gt;renderAjax('_addresses', ['model' =&gt; $user]); }</span></span></code> </pre><br><br>  Button to add an entry to the view inside pjax, but outside the loop: <br><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= Html::a(<span class="hljs-string"><span class="hljs-string">' '</span></span>, Url::toRoute([<span class="hljs-string"><span class="hljs-string">'addresses/create'</span></span>, <span class="hljs-string"><span class="hljs-string">'userId'</span></span> =&gt; $model-&gt;id]), [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'btn btn-success'</span></span>, ]) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  Actually, everything.  Now, when you click on the ‚ÄúAdd address‚Äù button, the database will create a fake entry with the initial data, and the view will be re-rendered along with the new validation rules. <br>  It is possible to improve this part of the code by adding a validation rule stating that the values ‚Äã‚Äãshould not be equivalent to the default.  Since the link method saves without validation, this is completely realizable, and for the rest I can advise save (false) - false disables validation while saving the model. <br><br>  Let's do the same for the delete button, in the end our view will look like this inside the loop: <br><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= $form-&gt;field($address, <span class="hljs-string"><span class="hljs-string">"[$key]name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= $form-&gt;field($address, <span class="hljs-string"><span class="hljs-string">"[$key]value"</span></span>) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= Html::a(<span class="hljs-string"><span class="hljs-string">''</span></span>, Url::toRoute([<span class="hljs-string"><span class="hljs-string">'addresses/delete'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; $address-&gt;id]), [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'btn btn-danger'</span></span>, ]) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  and action controller: <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionDelete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $model = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;findModel($id); $user = $model-&gt;user; $model-&gt;delete(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;renderAjax(<span class="hljs-string"><span class="hljs-string">'_addresses'</span></span>, [<span class="hljs-string"><span class="hljs-string">'model'</span></span> =&gt; $user]); }</code> </pre><br><br><h4>  But what about the changed values ‚Äã‚Äãand UX? </h4><br>  That's right.  For the standard situation, the functionality described above is enough, but the user is used to the fact that when a field is dynamically added, he does not need to worry about saving the data before that.  As a result, the user can fill in 5 fields, understand that he did not have enough, add the 6th ... and that‚Äôs all.  Forgive 5 minutes of life for the user, forgive the user for our resource. <br><br>  The only thing I could think of in this situation is to save the form every time the user presses the button (no matter which one). <br>  What I needed for this: <br><ul><li>  Add batchUpdate to create and delete actions just before return $ this-&gt; renderAjax (...) </li><li>  Write a simple script that changes the action of the form depending on the pressed button, and then submit it. </li></ul><br><br>  First creaks: <br><pre> <code class="javascript hljs">$(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ $(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).on(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-string"><span class="hljs-string">'[data-toggle=reroute]'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ e.preventDefault(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> = $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = $<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> action = data.action; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $form = $<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.closest(<span class="hljs-string"><span class="hljs-string">'form'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($form &amp;&amp; action) { $form.attr(<span class="hljs-string"><span class="hljs-string">'action'</span></span>, action).submit(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { alert(<span class="hljs-string"><span class="hljs-string">'! ,  .'</span></span>); } }); });</code> </pre><br>  A simple code snippet that took me 1 minute or less.  A link or element with the data-toggle = reroute attribute gets into the handler, and the form nearest to it (among parents, of course) changes its action to the one that is stored in the data-action, and then submitted.  In the case of incorrect configuration of the handler from the html template, an alert crashes. <br><br>  It remains to change our buttons in the view as follows: <br><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= Html::a(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'btn btn-success'</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'toggle'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'reroute'</span></span>, <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; Url::toRoute([<span class="hljs-string"><span class="hljs-string">'addresses/create'</span></span>, <span class="hljs-string"><span class="hljs-string">'userId'</span></span> =&gt; $model-&gt;id]) ] ]) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= Html::a(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'btn btn-danger'</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'toggle'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'reroute'</span></span>, <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; Url::toRoute([<span class="hljs-string"><span class="hljs-string">'addresses/delete'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; $variable-&gt;id]) ] ]) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br><h4>  What can be improved </h4><br>  As always, there is something to strive for. <br><ul><li>  For a start, you can optimize batch loading (if it is, of course, not optimized at the kernel level, which I did not find confirmation of) in such a way that unchanged records will not be saved to the database.  To do this, it is enough to compare the oldAttributes and attributes of a specific model in the model method beforeSave ().  Otherwise, if such a check does not occur at the framework level, the sql server will be surprised to repeat entries with the same values. </li><li>  Then you can wrap the model search methods in the controller into a single method, findModel ($ classname, $ params) </li><li>  And, as I have already said, create a validation rule for non-compliance of the model fields with its constants with default values. </li></ul><br><br>  I would be glad if someone prompts improvements or corrections to this recipe.  All good! <br><br><div class="spoiler">  <b class="spoiler_title">useful links</b> <div class="spoiler_text">  <a href="http://demos.krajee.com/builder-details/tabular-form">demos.krajee.com/builder-details/tabular-form</a> is something similar, but very monster and made for the GridView.  In addition, there is no saving of fields when deleting / adding new <br>  <a href="http://www.yiiframework.com/wiki/666/handling-tabular-data-loading-and-validation-in-yii-2/">www.yiiframework.com/wiki/666/handling-tabular-data-loading-and-validation-in-yii-2</a> is not a bad demo from the same author, which served as an example of batch loading. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/239147/">https://habr.com/ru/post/239147/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../239135/index.html">InkCase Plus, smartphone case with E-ink display, goes on sale this month</a></li>
<li><a href="../239137/index.html">Check your hoster for Shellshock vulnerability</a></li>
<li><a href="../239139/index.html">The presentation of the new Tesla electric car will be held on October 9</a></li>
<li><a href="../239141/index.html">Mikrotik, DHCP Classless Route</a></li>
<li><a href="../239143/index.html">Create a 2D platformer using the Unreal Engine 4. Part 1.5 - Jumping</a></li>
<li><a href="../239149/index.html">Sqimitive.js - Frontend Primitive or ‚ÄúBackbone without wrappers‚Äù</a></li>
<li><a href="../239151/index.html">Numeric Classes of Types in Rust</a></li>
<li><a href="../239153/index.html">How to set the order of visiting new pages by a search robot based on the prediction of the popularity of a web page (Part I)</a></li>
<li><a href="../239155/index.html">How I stopped being afraid and loved Windows 10</a></li>
<li><a href="../239159/index.html">7 best tools for solving business problems from a business consultant generalist</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>