<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Core Data for iOS. Chapter number 1. Practical part</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, good day! 
 Today I want to start writing a series of lectures with practical tasks on the book by Michael Privat and Robert Warner "Pro Cor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Core Data for iOS. Chapter number 1. Practical part</h1><div class="post__text post__text-html js-mediator-article">  Good day, good day! <br>  Today I want to start writing a series of lectures with practical tasks on the book by Michael Privat and Robert Warner "Pro Core Data for iOS", which you can buy from <a href="http://www.apress.com/9781430236566">this</a> link.  Each chapter will contain a theoretical and practical part. <br><br><img src="https://habrastorage.org/storage3/f39/8f2/7fe/f398f27fe69976e2305f4055fc97c9b2.png"><br><br>  Content: <br><ul><li>  <a href="http://habrahabr.ru/post/191334/">Chapter number 1.</a>  <a href="http://habrahabr.ru/post/191334/">Getting Started</a> ( <a href="http://habrahabr.ru/post/191472/">Practical Part</a> ) </li><li>  Chapter number 2.  Digest Core Data </li><li>  Chapter number 3.  Data storage: SQLite and other options </li><li>  Chapter 4  Creating a data model </li><li>  Chapter number 5.  We work with data objects </li><li>  Chapter number 6.  Processing Result Sets </li><li>  Chapter number 7.  Performance tuning and memory usage </li><li>  Chapter number 8.  Version Control and Migration </li><li>  Chapter number 9.  Managing tables using NSFetchedResultsController </li><li>  Chapter number 10.  Using Core Data in Advanced Applications </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h4>  Practical part </h4><br>  Since this is the first chapter and it can be considered introductory, then as a practical task we will choose the creation of a regular social application that will display a list of our friends from the VC and use Core Data to store data about them. <br>  Approximately (in the process we decide what to add / exclude), this is how our application will look like after several hours (and maybe minutes) of persistent programming: <br><table><tbody><tr><td align="center"><img src="https://habrastorage.org/getpro/habr/post_images/382/289/722/382289722884d448383b9285c173d45a.png" alt="image"><br></td><td align="center"><img src="https://habrastorage.org/getpro/habr/post_images/d3d/810/87b/d3d81087bcfe4062f0a408d882078f2a.png" alt="image"><br></td></tr></tbody></table><br><br>  As you might have guessed, we will use <a href="">Vkontakte iOS SDK v2.0</a> . <br>  By the way, I ask you to forgive me for the fact that in the practical part not only XCode will be used, but also <a href="https://www.jetbrains.com/objc/">AppCode</a> (thanks to the guys from JB for the product!).  All that can be done in the AppCode will be done there. <br><br>  Go‚Ä¶ <br><br><h5>  Creating an empty project </h5><br>  Create an empty project without Core Data - Single View Application. <br><img src="https://habrastorage.org/getpro/habr/post_images/0d8/fd9/0f7/0d8fd90f757b7ac781491df6ee922f46.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/6e9/e9d/8f0/6e9e9d8f0562b12aa9c0043f4c8d0ddc.png" alt="image"><br><br>  The application successfully started: <br><img src="https://habrastorage.org/getpro/habr/post_images/dd5/f87/3e3/dd5f873e3a3f46b25400aa4abaec56a0.png" alt="image"><br><br><h5>  Add and configure UITableView </h5><br>  Open ASAViewController.h and add the following property: <br><pre><code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">UITableView</span></span> *tableView;</code> </pre> <br>  Full view of ASAViewController.h: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> @interface ASAViewController : UIViewController @property (nonatomic, strong) UITableView *tableView; @end</span></span></code> </pre><br>  Open ASAViewController.m and add the UITableView table creation lines to the viewDidLoad method: <br><pre> <code class="objectivec hljs"> <span class="hljs-built_in"><span class="hljs-built_in">CGRect</span></span> frame = [[<span class="hljs-built_in"><span class="hljs-built_in">UIScreen</span></span> mainScreen] bounds]; _tableView = [[<span class="hljs-built_in"><span class="hljs-built_in">UITableView</span></span> alloc] initWithFrame:frame style:<span class="hljs-built_in"><span class="hljs-built_in">UITableViewStylePlain</span></span>]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.view addSubview:_tableView];</code> </pre><br>  Full view of ASAViewController.m: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ASAViewController.h"</span></span></span><span class="hljs-meta"> @implementation ASAViewController - (void)viewDidLoad { CGRect frame = [[UIScreen mainScreen] bounds]; _tableView = [[UITableView alloc] initWithFrame:frame style:UITableViewStylePlain]; [_tableView setDelegate:self]; [_tableView setDataSource:self]; [self.view addSubview:_tableView]; } @end</span></span></code> </pre><br><br>  Run: <br><img src="https://habrastorage.org/getpro/habr/post_images/002/f99/ade/002f99ade47b610c0ebc32ec8f892ec2.png" alt="image"><br><br>  It remains to implement the delegate methods UITableViewDelegate and UITableViewDataSource. <br>  We add protocols in ASAViewController.h: <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASAViewController</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIViewController</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableViewDataSource</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableViewDelegate</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br>  We open ASAViewController.m and implement two methods (one to return the number of friends in the list, and the second to create a filled cell with user data): <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#pragma mark - UITableViewDelegate &amp; UITableViewDataSource - (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section { return [_userFriends count]; } - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath { static NSString *cellID = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"friendID"</span></span></span><span class="hljs-meta">; UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:cellID]; if(nil == cell){ cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleSubtitle reuseIdentifier:cellID]; } // setting default image while main photo is loading cell.imageView.image = [UIImage imageNamed:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"default.png"</span></span></span><span class="hljs-meta">]; dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, 0), ^{ NSString* imgPath = _userFriends[(NSUInteger)indexPath.row][@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"photo"</span></span></span><span class="hljs-meta">]; NSData* img = [NSData dataWithContentsOfURL:[NSURL URLWithString:imgPath]]; dispatch_async(dispatch_get_main_queue(), ^{ cell.imageView.image = [UIImage imageWithData:img]; }); }); NSString* firstName = _userFriends[(NSUInteger)indexPath.row][@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"first_name"</span></span></span><span class="hljs-meta">]; NSString* lastName = _userFriends[(NSUInteger)indexPath.row][@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"last_name"</span></span></span><span class="hljs-meta">]; NSString* fullName = [NSString stringWithFormat:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%@ %@"</span></span></span><span class="hljs-meta">, firstName, lastName]; cell.textLabel.text = fullName; NSString* status = _userFriends[(NSUInteger)indexPath.row][@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"status"</span></span></span><span class="hljs-meta">]; cell.detailTextLabel.text = status; return cell; }</span></span></code> </pre><br><br>  The _userFriends variable is a property of ASAViewController: <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> *userFriends;</code> </pre><br><br>  The final view of ASAViewController.h and ASAViewController.m: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> @interface ASAViewController : UIViewController </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UITableViewDataSource, UITableViewDelegate&gt;</span></span></span><span class="hljs-meta"> @property (nonatomic, strong) UITableView *tableView; @property (nonatomic, strong) NSMutableArray *userFriends; @end</span></span></code> </pre><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ASAViewController.h"</span></span></span><span class="hljs-meta"> @implementation ASAViewController - (void)viewDidLoad { _userFriends = [[NSMutableArray alloc] init]; CGRect frame = [[UIScreen mainScreen] bounds]; _tableView = [[UITableView alloc] initWithFrame:frame style:UITableViewStylePlain]; [_tableView setDelegate:self]; [_tableView setDataSource:self]; [self.view addSubview:_tableView]; } #pragma mark - UITableViewDelegate &amp; UITableViewDataSource - (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section { return [_userFriends count]; } - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath { static NSString *cellID = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"friendID"</span></span></span><span class="hljs-meta">; UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:cellID]; if(nil == cell){ cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleSubtitle reuseIdentifier:cellID]; } // setting default image while main photo is loading cell.imageView.image = [UIImage imageNamed:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"default.png"</span></span></span><span class="hljs-meta">]; dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, 0), ^{ NSString* imgPath = _userFriends[(NSUInteger)indexPath.row][@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"photo"</span></span></span><span class="hljs-meta">]; NSData* img = [NSData dataWithContentsOfURL:[NSURL URLWithString:imgPath]]; dispatch_async(dispatch_get_main_queue(), ^{ cell.imageView.image = [UIImage imageWithData:img]; }); }); NSString* firstName = _userFriends[(NSUInteger)indexPath.row][@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"first_name"</span></span></span><span class="hljs-meta">]; NSString* lastName = _userFriends[(NSUInteger)indexPath.row][@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"last_name"</span></span></span><span class="hljs-meta">]; NSString* fullName = [NSString stringWithFormat:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%@ %@"</span></span></span><span class="hljs-meta">, firstName, lastName]; cell.textLabel.text = fullName; NSString* status = _userFriends[(NSUInteger)indexPath.row][@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"status"</span></span></span><span class="hljs-meta">]; cell.detailTextLabel.text = status; return cell; } @end</span></span></code> </pre><br>  Everything should be started with a bang.  Go to the next step. <br><br><h5>  Integrating VKontakte iOS SDK v2.0 </h5><br>  Pick up the source for <a href="">this</a> link. <br><br>  Connecting QuartzCore.framework <br><img src="https://habrastorage.org/getpro/habr/post_images/ff9/8ee/7ca/ff98ee7cabd5bdd13739d2b32ec91f9c.png" alt="image"><br><br>  Adding Vkontakte iOS SDK <br><img src="https://habrastorage.org/getpro/habr/post_images/719/204/662/7192046625b09227f7cb06f1d7bc0a93.png" alt="image"><br><br>  We add two protocols to ASAAppDelegate.h: <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASAAppDelegate</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIResponder</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIApplicationDelegate</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKConnectorDelegate</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKRequestDelegate</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br><br>  Open the ASAAppDelegate.m implementation file and insert the following lines into the <code>- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions</code> method <code>- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions</code> : <br><pre> <code class="objectivec hljs"> [[VKConnector sharedInstance] setDelegate:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; [[VKConnector sharedInstance] startWithAppID:<span class="hljs-string"><span class="hljs-string">@"3541027"</span></span> permissons:@[<span class="hljs-string"><span class="hljs-string">@"friends"</span></span>]];</code> </pre><br>  This code when launching the application will show a pop-up window to the user for authorization in the social network VKontakte. <br><img src="https://habrastorage.org/getpro/habr/post_images/b6f/7e3/fb6/b6f7e3fb64addd438c7b98db3eb358d0.png" alt="image"><br><br>  In ASAAppDelegate.m, we implement two more methods: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#pragma mark - VKConnectorDelegate - (void) VKConnector:(VKConnector *)connector accessTokenRenewalSucceeded:(VKAccessToken *)accessToken { // now we can make request [[VKUser currentUser] setDelegate:self]; [[VKUser currentUser] friendsGet:@{ @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"uid"</span></span></span><span class="hljs-meta"> : @([VKUser currentUser].accessToken.userID), @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"fields"</span></span></span><span class="hljs-meta"> : @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"first_name,last_name,photo,status"</span></span></span><span class="hljs-meta"> }]; } #pragma mark - VKRequestDelegate - (void)VKRequest:(VKRequest *)request response:(id)response { ASAViewController *controller = (ASAViewController *)self.window.rootViewController; controller.userFriends = response[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"response"</span></span></span><span class="hljs-meta">]; [controller.tableView reloadData]; }</span></span></code> </pre><br>  The final view of ASAAppDelegate.h and ASAAppDelegate.m at this stage: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"VKConnector.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"VKRequest.h"</span></span></span><span class="hljs-meta"> @class ASAViewController; @interface ASAAppDelegate : UIResponder </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIApplicationDelegate, VKConnectorDelegate, VKRequestDelegate&gt;</span></span></span><span class="hljs-meta"> @property (strong, nonatomic) UIWindow *window; @property (strong, nonatomic) ASAViewController *viewController; @end</span></span></code> </pre><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ASAAppDelegate.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ASAViewController.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"VKUser.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"VKAccessToken.h"</span></span></span><span class="hljs-meta"> @implementation ASAAppDelegate - (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions { self.window = [[UIWindow alloc] initWithFrame:[[UIScreen mainScreen] bounds]]; // Override point for customization after application launch. self.viewController = [[ASAViewController alloc] initWithNibName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ASAViewController"</span></span></span><span class="hljs-meta"> bundle:nil]; self.window.rootViewController = self.viewController; [self.window makeKeyAndVisible]; [[VKConnector sharedInstance] setDelegate:self]; [[VKConnector sharedInstance] startWithAppID:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"3541027"</span></span></span><span class="hljs-meta"> permissons:@[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"friends"</span></span></span><span class="hljs-meta">]]; return YES; } #pragma mark - VKConnectorDelegate - (void) VKConnector:(VKConnector *)connector accessTokenRenewalSucceeded:(VKAccessToken *)accessToken { // now we can make request [[VKUser currentUser] setDelegate:self]; [[VKUser currentUser] friendsGet:@{ @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"uid"</span></span></span><span class="hljs-meta"> : @([VKUser currentUser].accessToken.userID), @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"fields"</span></span></span><span class="hljs-meta"> : @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"first_name,last_name,photo,status"</span></span></span><span class="hljs-meta"> }]; } #pragma mark - VKRequestDelegate - (void)VKRequest:(VKRequest *)request response:(id)response { ASAViewController *controller = (ASAViewController *)self.window.rootViewController; controller.userFriends = response[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"response"</span></span></span><span class="hljs-meta">]; [controller.tableView reloadData]; } @end</span></span></code> </pre><br>  We start the application and see something like the following (do not forget that in the example above, query caching is not used intentionally): <br><img src="https://habrastorage.org/getpro/habr/post_images/dcd/17e/36f/dcd17e36f5be17ce41c4f238702a90ca.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/b7f/73b/a88/b7f73ba889468850a3910013e3a73702.png" alt="image"><br><br><h5>  Dessert from Core Data </h5><br>  Here we come to the most interesting and exciting!  I hope you have not lost the desire to finish the practical part;) Take a break, drink tea with dryers, nibble candy, stretch yourself, pull yourself up. <br><br>  Why do we need Core Data here?  We will proceed as follows: at the first request to the VKontakte server, we will receive a list of friends and the requested fields (status, photo, name, last name), save this information in the local storage using Core Data, and then launch the application and disable the Internet during the request and display A list of friends that were saved locally during the first request.  Is it going  Then let's get started. <br><br>  To handle the fact that there is no Internet connection, we will use the following method from the VKRequestDelegate protocol: <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)VKRequest:(VKRequest *)request connectionErrorOccured:(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *)error { <span class="hljs-comment"><span class="hljs-comment">// TODO }</span></span></code> </pre><br>  We will write the body of the method a little later. <br><br>  Oh yeah, I completely forgot!  We connect <code>CoreData.framework</code> . <br><img src="https://habrastorage.org/getpro/habr/post_images/bc1/a14/4e9/bc1a144e923512561228efa1eed5fb1c.png" alt="image"><br>  Add three of our favorite properties to ASAAppDelegate.h: <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectModel</span></span> *managedObjectModel; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">NSPersistentStoreCoordinator</span></span> *coordinator; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectContext</span></span> *managedObjectContext;</code> </pre><br><br>  Now we are going to ASAAppDelegate.m in order to implement explicit getters for all three properties. <br>  Managed Object Model: <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectModel</span></span> *)managedObjectModel { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-literal"><span class="hljs-literal">nil</span></span> != _managedObjectModel) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _managedObjectModel; _managedObjectModel = [<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectModel</span></span> mergedModelFromBundles:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _managedObjectModel; }</code> </pre><br>  Persistent Store Coordinator: <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">NSPersistentStoreCoordinator</span></span> *)coordinator { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-literal"><span class="hljs-literal">nil</span></span> != _coordinator) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _coordinator; <span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *storeURL = [[[[<span class="hljs-built_in"><span class="hljs-built_in">NSFileManager</span></span> defaultManager] URLsForDirectory:<span class="hljs-built_in"><span class="hljs-built_in">NSDocumentDirectory</span></span> inDomains:<span class="hljs-built_in"><span class="hljs-built_in">NSUserDomainMask</span></span>] lastObject] URLByAppendingPathComponent:<span class="hljs-string"><span class="hljs-string">@"BasicApplication.sqlite"</span></span>]; _coordinator = [[<span class="hljs-built_in"><span class="hljs-built_in">NSPersistentStoreCoordinator</span></span> alloc] initWithManagedObjectModel:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.managedObjectModel]; <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(![_coordinator addPersistentStoreWithType:<span class="hljs-built_in"><span class="hljs-built_in">NSSQLiteStoreType</span></span> configuration:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> URL:storeURL options:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> error:&amp;error]){ <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"Unresolved error %@, %@"</span></span>, error, [error userInfo]); abort(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _coordinator; }</code> </pre><br>  Managed Object Context: <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectContext</span></span> *)managedObjectContext { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-literal"><span class="hljs-literal">nil</span></span> != _managedObjectContext) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _managedObjectContext; <span class="hljs-built_in"><span class="hljs-built_in">NSPersistentStoreCoordinator</span></span> *storeCoordinator = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.coordinator; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-literal"><span class="hljs-literal">nil</span></span> != storeCoordinator){ _managedObjectContext = [[<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectContext</span></span> alloc] init]; [_managedObjectContext setPersistentStoreCoordinator:storeCoordinator]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _managedObjectContext; }</code> </pre><br><br>  Build ... And ... and ... everything is fine. <br><br>  Now we are going to create a model.  By the way, I want to note that I do everything without insurance and, maybe at the end of something and do not dock, but we are brave programmers! <br>  To create a model, we need the same Xcode. <br>  Open our project in it, press Control + N and select Core Data -&gt; Data Model: <br><img src="https://habrastorage.org/getpro/habr/post_images/359/183/129/3591831299f9db9734653ab5958d1037.png" alt="image"><br><br>  Save the model called <b>Friend</b> : <br><img src="https://habrastorage.org/getpro/habr/post_images/4aa/6b8/05f/4aa6b805f28a8913fb078cf289f4dff1.png" alt="image"><br><br>  We see already quite familiar screen: <br><img src="https://habrastorage.org/getpro/habr/post_images/6e6/074/cd6/6e6074cd62eaf85641c23ce8b0920530.png" alt="image"><br><br>  Create a new entity called <b>Friend</b> and add 4 properties: last_name (String), first_name (String), status (String), photo (Binary Data). <br><img src="https://habrastorage.org/getpro/habr/post_images/145/311/778/1453117786ea7d3475a044645e01b7f0.png" alt="image"><br><br>  Finish and close Xcode. <br><br>  The next thing we need to do is save the user data after the request is made. <br>  Open ASAAppDelegate.m, go down to the VKRequest: response: method and change it as follows: <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)VKRequest:(VKRequest *)request response:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)response { ASAViewController *controller = (ASAViewController *)<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.window.rootViewController; controller.userFriends = response[<span class="hljs-string"><span class="hljs-string">@"response"</span></span>]; [controller.tableView reloadData]; <span class="hljs-comment"><span class="hljs-comment">//    ,     dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, 0), ^{ for(NSDictionary *user in controller.userFriends){ NSManagedObject *friend = [NSEntityDescription insertNewObjectForEntityForName:@"Friend" inManagedObjectContext:self.managedObjectContext]; [friend setValue:user[@"first_name"] forKey:@"first_name"]; [friend setValue:user[@"last_name"] forKey:@"last_name"]; [friend setValue:[NSData dataWithContentsOfURL:[NSURL URLWithString:user[@"photo"]]] forKey:@"photo"]; [friend setValue:user[@"status"] forKey:@"status"]; NSLog(@"friend: %@", friend); } if([self.managedObjectContext hasChanges] &amp;&amp; ![self.managedObjectContext save:nil]){ NSLog(@"Unresolved error!"); abort(); } }); }</span></span></code> </pre><br>  At each iteration we create a new object, set its fields and save.  In the console, you can watch the eye-pleasing lines <br><img src="https://habrastorage.org/getpro/habr/post_images/9d2/8cf/081/9d28cf08101f8b80c01dd7f6eeae29a2.png" alt="image"><br><br>  Tax, it remains to modify the display of the table when the Internet connection is broken.  All code will go to the method <code>- (void)VKRequest:(VKRequest *)request connectionErrorOccured:(NSError *)error</code> and will look like this: <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)VKRequest:(VKRequest *)request connectionErrorOccured:(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *)error { <span class="hljs-comment"><span class="hljs-comment">//         NSMutableArray *data = [[NSMutableArray alloc] init]; //      NSFetchRequest *fetchRequest = [[NSFetchRequest alloc] initWithEntityName:@"Friend"]; NSSortDescriptor *sortDescriptor = [NSSortDescriptor sortDescriptorWithKey:@"last_name" ascending:YES]; [fetchRequest setSortDescriptors:@[sortDescriptor]]; //   NSArray *tmpData = [self.managedObjectContext executeFetchRequest:fetchRequest error:nil]; //   for(NSManagedObject *object in tmpData){ //    ,         -  :) if([object valueForKey:@"status"] == nil) continue; NSDictionary *tmp = @{ @"last_name": [object valueForKey:@"first_name"], @"first_name": [object valueForKey:@"last_name"], @"photo": [object valueForKey:@"photo"], @"status": [object valueForKey:@"status"] }; [data addObject:tmp]; } //   ""    ASAViewController *controller = (ASAViewController *)self.window.rootViewController; controller.userFriends = data; [controller.tableView reloadData]; }</span></span></code> </pre><br><br>  And small adjustments should be made to the method <code>- (UITableViewCell *)tableView:(UITableView *)tableView <br> cellForRowAtIndexPath:(NSIndexPath *)indexPath</code> <code>- (UITableViewCell *)tableView:(UITableView *)tableView <br> cellForRowAtIndexPath:(NSIndexPath *)indexPath</code>  <code>- (UITableViewCell *)tableView:(UITableView *)tableView <br> cellForRowAtIndexPath:(NSIndexPath *)indexPath</code> : <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span> *)tableView:(<span class="hljs-built_in"><span class="hljs-built_in">UITableView</span></span> *)tableView cellForRowAtIndexPath:(<span class="hljs-built_in"><span class="hljs-built_in">NSIndexPath</span></span> *)indexPath { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *cellID = <span class="hljs-string"><span class="hljs-string">@"friendID"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span> *cell = [tableView dequeueReusableCellWithIdentifier:cellID]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-literal"><span class="hljs-literal">nil</span></span> == cell){ cell = [[<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span> alloc] initWithStyle:<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCellStyleSubtitle</span></span> reuseIdentifier:cellID]; } <span class="hljs-comment"><span class="hljs-comment">// setting default image while main photo is loading cell.imageView.image = [UIImage imageNamed:@"default.png"]; dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, 0), ^{ NSData *img; if([_userFriends[(NSUInteger) indexPath.row][@"photo"] isKindOfClass:[NSData class]]){ img = _userFriends[(NSUInteger) indexPath.row][@"photo"]; } else { NSString* imgPath = _userFriends[(NSUInteger)indexPath.row][@"photo"]; img = [NSData dataWithContentsOfURL:[NSURL URLWithString:imgPath]]; } dispatch_async(dispatch_get_main_queue(), ^{ cell.imageView.image = [UIImage imageWithData:img]; }); }); NSString* firstName = _userFriends[(NSUInteger)indexPath.row][@"first_name"]; NSString* lastName = _userFriends[(NSUInteger)indexPath.row][@"last_name"]; NSString* fullName = [NSString stringWithFormat:@"%@ %@", firstName, lastName]; cell.textLabel.text = fullName; NSString* status = _userFriends[(NSUInteger)indexPath.row][@"status"]; cell.detailTextLabel.text = status; return cell; }</span></span></code> </pre><br><br>  Hooray!  The application is complete and it displays friends from the local storage: <br><img src="https://habrastorage.org/getpro/habr/post_images/4c9/c6c/b1f/4c9c6cb1f01dafbb8b8d3763fd720628.png" alt="image"><br><br><h5>  Tears of happiness </h5><br>  Finally, we finished our first, but not the last practical part.  The entire project can be found at <a href="http://yadi.sk/d/RT0NyBzc8LXTw">this</a> link (it is in the archive). <br><br>  I hope that the back and fingers are not tired. <br>  I hope that you are pleased with the time spent in the company with Core Data. <br>  Hope you want to see the sequels. <br><br><h5>  Note </h5><br>  Nothing can please the author, as a comment left, even if it is a critic;) <br><br>  Thank you for attention! </div><p>Source: <a href="https://habr.com/ru/post/191472/">https://habr.com/ru/post/191472/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191462/index.html">Getting administrative privileges in Microsoft SQL Server</a></li>
<li><a href="../191464/index.html">Upload files to AngularJS</a></li>
<li><a href="../191466/index.html">Simple DWDM system. Run at the booth</a></li>
<li><a href="../191468/index.html">EmBlocks - IDE for STM32</a></li>
<li><a href="../191470/index.html">Yoobao YB-665 - Power Bank at 15600 mAh</a></li>
<li><a href="../191476/index.html">Capturing downloadable resources in QtWebKit or how I saddled a unicorn under dubstep</a></li>
<li><a href="../191478/index.html">Why study TDD is difficult and what to do about it. Part 2</a></li>
<li><a href="../191480/index.html">Javascript Strategy Pattern</a></li>
<li><a href="../191482/index.html">Servers in the USA, Data Center COPT DC-6-EvoSwitch / LeaseWeb (Manassas)</a></li>
<li><a href="../191486/index.html">10 fastest supercomputers in pictures</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>