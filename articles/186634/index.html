<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We study Storm Framework. Part III</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the second part of the article, the mechanisms of error detection during processing were described. 

 Processing ended with an error, what to do n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We study Storm Framework. Part III</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/post/186436/">second part of the</a> article, the mechanisms of error detection during processing were described. <br><br>  Processing ended with an error, what to do next?  It is possible that communication with one of the cluster nodes is lost or the database is temporarily unavailable.  In this case, it is impossible to say with certainty which operations were performed successfully and which were not.  If all operations in the chain are re-applicable ( <a href="http://ru.wikipedia.org/wiki/%25D0%2598%25D0%25B4%25D0%25B5%25D0%25BC%25D0%25BF%25D0%25BE%25D1%2582%25D0%25B5%25D0%25BD%25D1%2582%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">idempotent</a> ), for example, setting the flag, then you can simply restart the processing.  If not, then the Storm transaction mechanisms come to the rescue. <br><a name="habracut"></a><br>  When they talk about the characteristics of transactions, the term <a href="http://ru.wikipedia.org/wiki/ACID">ACID</a> immediately pops up: <br><ul><li>  <b>A</b> tomicity (atomicity).  All changes made in the system during the transaction are either fully applied or not applied at all. </li><li>  <b>C</b> onsistency (consistency).  A transaction shifts the system from one non-contradictory state to another. </li><li>  <b>I</b> solation (isolation).  Parallel transactions do not affect each other‚Äôs performance. </li><li>  <b>D</b> urability (reliability).  Changes committed by the transaction are guaranteed to remain in the system. </li></ul><br>  Consistency and Durability are more database related.  We will be interested in Atomicity and Isolation. <br><br>  In version 0.8.0, the <a href="https://github.com/nathanmarz/storm/wiki/Trident-tutorial">Trident</a> subsystem appeared in Storm, an analogue of <a href="http://pig.apache.org/">Apache Pig</a> .  It also migrated the functionality of <a href="https://github.com/nathanmarz/storm/wiki/Transactional-topologies">Transactional topology</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Transactions in Storm </h2><br><h4>  <b>A</b> tomicity </h4>  In Topology, an object is created that implements the <a href="http://nathanmarz.github.io/storm/doc/storm/trident/state/State.html">State</a> interface, which encapsulates work with the database.  The input to the spout is split into a Tuple and is collected into packets (batch).  Batch associates with a unique transaction id.  Tuple-forming batch can be processed in parallel. <br>  At the end of the processing chain, a set of Tuples related to a single transaction is passed to the <a href="http://nathanmarz.github.io/storm/doc/storm/trident/state/StateUpdater.html">updateState</a> method of the class that implements the <a href="http://nathanmarz.github.io/storm/doc/storm/trident/state/StateUpdater.html">StateUpdater</a> interface, which also modifies the State.  In case of successful completion, Spout is notified of the success of batch processing.  In case of an error, Spout must re-process the entire batch. <br>  Thus Storm guarantees that Batch will be recorded in the database completely and only once. <br><br><h4>  <b>I</b> solation </h4>  Storm ensures that Batch'i are transmitted to the StateUpdater strictly sequentially, in ascending order transaction id.  That is, Batch # 2 will be fixed only after successful fixing of Batch # 1. <br><br><h2>  Implementation </h2><br>  Transaction-enabled <a href="http://nathanmarz.github.io/storm/doc/storm/trident/spout/ICommitterTridentSpout.html">spout</a> must implement the <a href="http://nathanmarz.github.io/storm/doc/storm/trident/spout/ICommitterTridentSpout.html">ICommitterTridentSpout &lt;TransactionMetadata&gt;</a> interface.  TransactionMetadata - any class that contains data for generating batch and generating the following transaction: <a href="">TxMeta</a> . <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TxMeta</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> start; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TxMeta</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> start, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.start = start; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.count = count; } <span class="hljs-comment"><span class="hljs-comment">// Skipped getters }</span></span></code> </pre> <br></div></div><br>  The class that implements the <a href="http://nathanmarz.github.io/storm/doc/storm/trident/spout/ITridentSpout.BatchCoordinator.html">ITridentSpout.BatchCoordinator &lt;TransactionMetadata&gt;</a> interface initializes TransactionMetadata when creating a transaction and responds to a query if the data for the next transaction is <a href="">ready</a> : <a href="">TridentTxSpout</a> .  It is created in a single copy for each Topology. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BCoordinator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BatchCoordinator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TxMeta</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TRANSACTION_COUNT = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TRANSACTION_ELEMENT_COUNT = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-comment"><span class="hljs-comment">//TxMeta -    @Override public TxMeta initializeTransaction(long l, TxMeta txMeta) { if(txMeta != null) { System.out.println(String.format("Initializing transaction id: %08d, " + "start: %04d, count: %04d", l, txMeta.getStart() + txMeta.getCount(), txMeta.getCount())); return new TxMeta(txMeta.getStart() + txMeta.getCount(), TRANSACTION_ELEMENT_COUNT); } else { return new TxMeta(0, TRANSACTION_ELEMENT_COUNT); } } //       @Override public boolean isReady(long l) { if(l &lt;= TRANSACTION_COUNT) { System.out.println("ISREADY " + l); return true; } return false; } }</span></span></code> </pre><br></div></div><br>  The class that implements the <a href="http://nathanmarz.github.io/storm/doc/storm/trident/spout/ICommitterTridentSpout.Emitter.html">ICommitterTridentSpout.Emitter</a> interface forms the Batch.  In the event of an error in the processing of Batch'a, forms the Batch again. <br>  <i>Important - the reformed Batch must contain exactly the same Tuple set as the original.</i> <i><br></i> <div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BEmitter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Emitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  Batch    TransactionMetadata @Override public void emitBatch(TransactionAttempt transactionAttempt, Object coordinatorMeta, TridentCollector tridentCollector) { TxMeta txMeta = (TxMeta) coordinatorMeta; System.out.println("Emitting transaction id: " + transactionAttempt.getTransactionId() + " attempt:" + transactionAttempt.getAttemptId() ); for(int i = 0; i &lt; txMeta.getCount(); ++i) { tridentCollector.emit(new Values("TRANS [" + transactionAttempt.getAttemptId() + "] [" + (txMeta.getStart() + i) + "]") ); } } //     State @Override public void success(TransactionAttempt transactionAttempt) { System.out.println("BEmitter:Transaction success id:" + transactionAttempt.getTransactionId()); } //     State @Override public void commit(TransactionAttempt transactionAttempt) { System.out.println("BEmitter:Transaction commit id:" + transactionAttempt.getTransactionId()); } }</span></span></code> </pre><br></div></div><br>  The class that implements the <a href="http://nathanmarz.github.io/storm/doc/storm/trident/state/State.html">State</a> interface in our case is the database driver: <a href="">TxDatabase</a> . <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TxDatabase</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       @Override public void beginCommit(Long txId) { System.out.println("beginCommit [" + Thread.currentThread().getId() + "] " + txId); } //       @Override public void commit(Long txId) { System.out.println("commit [" + Thread.currentThread().getId() + "] " + txId); } }</span></span></code> </pre><br></div></div><br>  The class that inherits <a href="http://nathanmarz.github.io/storm/doc/storm/trident/state/BaseStateUpdater.html">BaseStateUpdater &lt;S extends State&gt;</a> , makes changes to the State (DB): <a href="">TxDatabaseUpdater</a> <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TxDatabaseUpdater</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseStateUpdater</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TxDatabase</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count; <span class="hljs-comment"><span class="hljs-comment">//     @Override public void updateState(TxDatabase txDatabase, List&lt;TridentTuple&gt; tridentTuples, TridentCollector tridentCollector) { //    if(++count == 2) throw new FailedException("YYYY"); for(TridentTuple t: tridentTuples) { System.out.println("Updating: " + t.getString(0)); } } }</span></span></code> </pre><br></div></div><br>  A class that implements the <a href="http://nathanmarz.github.io/storm/doc/storm/trident/state/StateFactory.html">StateFactory</a> interface, creates instances of State: <a href="">TxDatabaseFactory</a> . <br><br>  Putting it all together <a href="">TridentTransactionApp</a> : <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TridentTransactionApp</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( String[] args )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ Logger.getRootLogger().setLevel(Level.ERROR); <span class="hljs-comment"><span class="hljs-comment">//   TridentTopology tridentTopology = new TridentTopology(); //   Spout tridentTopology.newStream("TridentTxSpout", new TridentTxSpout()). //  Tuple   - OpPrintout    shuffle().each(new Fields("msg"), new OpPrintout()). parallelismHint(2). //        global(). //    State () partitionPersist(new TxDatabaseFactory(), new Fields("msg"), new TxDatabaseUpdater()); // Skipped LocalCluster cluster = new LocalCluster(); cluster.submitTopology("T2", config, tridentTopology.build()); Thread.sleep(1000*100); cluster.shutdown(); } }</span></span></code> </pre><br>  Storm's transactional capabilities are very useful for transferring data from one system to another when nontrivial processing is required.  For example, one system generates files, Storm splits them into records, processes them in parallel mode and adds them to a database.  In case of a processing error there is a guarantee that the file will not be deleted and will not be processed twice. <br><br>  <b>Ps.</b>  To reveal all the possibilities of Storm in the framework of the articles is impossible, the material is enough for the whole book.  I hope I managed to show the key capabilities of the framework and the possibilities of its use in real projects. <br>  Regarding the deployment of the cluster - I recently came across a great <a href="http://www.michael-noll.com/tutorials/running-multi-node-storm-cluster/">article</a> .  I see no reason to repeat.  Expand Storm in production is really easy. <br><br>  <b>Pps.</b>  In <a href="http://hadoop.apache.org/">Hadoop,</a> there is an analogue of Storm on-line processing - <a href="http://hadoop.apache.org/docs/stable/streaming.html">Hadoop Streaming</a> , but unlike Storm, it does not support transactions. <br></div><p>Source: <a href="https://habr.com/ru/post/186634/">https://habr.com/ru/post/186634/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186610/index.html">Brief history of space exploration</a></li>
<li><a href="../186616/index.html">Clickjacking from A to Z</a></li>
<li><a href="../186618/index.html">Auto Acceleration: windows marketplace, in-app billing and what else we learned over the year</a></li>
<li><a href="../186624/index.html">Improving the organization in the work of the installation department</a></li>
<li><a href="../186630/index.html">Closed the "last in the world" wired telegraph</a></li>
<li><a href="../186636/index.html">Pets Balls - funny animals</a></li>
<li><a href="../186638/index.html">Develop Java cloud applications in Eclipse</a></li>
<li><a href="../186640/index.html">VoIP Voice Quality Assessment Platform</a></li>
<li><a href="../186642/index.html">Malefactors more actively use Win32 / Bicololo</a></li>
<li><a href="../186644/index.html">Google Science Fair-2013 and the first finalists from Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>