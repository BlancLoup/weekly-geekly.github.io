<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Improving emacs jabber</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Start 
 On Habr√© was already an overview article on jabber.el - jabber-client for emacs. Having decided to try this client after pidgin, I came across...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Improving emacs jabber</h1><div class="post__text post__text-html js-mediator-article"><h2>  Start </h2><br>  On Habr√© was already an <a href="http://habrahabr.ru/post/28943/">overview article</a> on jabber.el - jabber-client for emacs.  Having decided to try this client after pidgin, I came across the lack of such familiar things as input history or formatted messages.  Unfortunately, emacs-jabber is not developing as fast as we would like.  Fortunately, the emacs configuration options are almost limitless, so adding the right one is easy.  In this article I will tell you how I implemented the input history.  If this topic is of interest to the public, in the future I will describe sending formatted messages (html) and some other goodies. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Reservation</b> <div class="spoiler_text">  Everything described was done for myself.  I use <a href="https://github.com/bbatsov/prelude">prelude</a> , so some functions may be from third-party libraries and absent in pure email.  Also, I only use chat rooms, for conferences the specified code will need to be corrected. </div></div><br><br><h2>  Input history </h2><br>  A very handy thing about pidgin is the input history.  By ctrl + up you can go back through the history of sent messages, and by ctrl + down forward.  Add this functionality to emacs-jabber.  We need three variables: the list of entered phrases, the current position in this list, and the last entered, but not yet sent text. <br><pre><code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defvar</span></span> my-jabber-input-history '() <span class="hljs-string"><span class="hljs-string">"Variable that holds input history"</span></span>) (<span class="hljs-name"><span class="hljs-name">make-variable-buffer-local</span></span> 'my-jabber-input-history) (<span class="hljs-name"><span class="hljs-name">defvar</span></span> my-jabber-input-history-position <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">"Current position in input history"</span></span>) (<span class="hljs-name"><span class="hljs-name">make-variable-buffer-local</span></span> 'my-jabber-input-history-position) (<span class="hljs-name"><span class="hljs-name">defvar</span></span> my-jabber-input-history-current <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-string"><span class="hljs-string">"Current input value"</span></span>) (<span class="hljs-name"><span class="hljs-name">make-variable-buffer-local</span></span> 'my-jabber-input-history-current)</code> </pre> <br>  When sending a message, add it to the list: <br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defun</span></span> my-jabber-input-history-hook (<span class="hljs-name"><span class="hljs-name">body</span></span> id) (<span class="hljs-name"><span class="hljs-name">add-to-list</span></span> 'my-jabber-input-history body <span class="hljs-literal"><span class="hljs-literal">t</span></span>) (<span class="hljs-name"><span class="hljs-name">setq</span></span> my-jabber-input-history-position (<span class="hljs-name"><span class="hljs-name">length</span></span> my-jabber-input-history))) (<span class="hljs-name"><span class="hljs-name">add-hook</span></span> 'jabber-chat-send-hooks 'my-jabber-input-history-hook)</code> </pre><br>  Important: my-jabber-input-history-position does not point to the last element of history, but behind it (numbering from zero).  This is logical, because we have not yet gone through the list. <br>  Function to go back through the list: <br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defun</span></span> my-jabber-previous-input () (<span class="hljs-name"><span class="hljs-name">interactive</span></span>) (<span class="hljs-name"><span class="hljs-name">let</span></span> (<span class="hljs-name"><span class="hljs-name">current-input</span></span> (<span class="hljs-name"><span class="hljs-name">pos</span></span> my-jabber-input-history-position) (<span class="hljs-name"><span class="hljs-name">len</span></span> (<span class="hljs-name"><span class="hljs-name">length</span></span> my-jabber-input-history))) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">=</span></span> pos <span class="hljs-number"><span class="hljs-number">0</span></span>) (<span class="hljs-name"><span class="hljs-name">message</span></span> <span class="hljs-string"><span class="hljs-string">"%s"</span></span> <span class="hljs-string"><span class="hljs-string">"No previous input"</span></span>) (<span class="hljs-name"><span class="hljs-name">setq</span></span> current-input (<span class="hljs-name"><span class="hljs-name">delete-and-extract-region</span></span> jabber-point-insert (<span class="hljs-name"><span class="hljs-name">point-max</span></span>))) (<span class="hljs-name"><span class="hljs-name">when</span></span> (<span class="hljs-name"><span class="hljs-name">=</span></span> pos len) <span class="hljs-comment"><span class="hljs-comment">; running first time, save current input (setq my-jabber-input-history-current current-input)) (decf my-jabber-input-history-position) (insert (nth my-jabber-input-history-position my-jabber-input-history)))))</span></span></code> </pre><br>  Everything is simple, the only thing worth paying attention to is to save the current text entered.  If the user changes his mind to use the story, we will be able to restore what he managed to enter. <br>  The function for going forward through the list is: <br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defun</span></span> my-jabber-next-input () (<span class="hljs-name"><span class="hljs-name">interactive</span></span>) (<span class="hljs-name"><span class="hljs-name">let</span></span> ((<span class="hljs-name"><span class="hljs-name">pos</span></span> my-jabber-input-history-position) (<span class="hljs-name"><span class="hljs-name">len</span></span> (<span class="hljs-name"><span class="hljs-name">length</span></span> my-jabber-input-history))) (<span class="hljs-name"><span class="hljs-name">cond</span></span> ((<span class="hljs-name"><span class="hljs-name">=</span></span> pos (<span class="hljs-number"><span class="hljs-number">1</span></span>- len)) <span class="hljs-comment"><span class="hljs-comment">; pointing at the last element, insert saved input (incf my-jabber-input-history-position) (delete-region jabber-point-insert (point-max)) (insert my-jabber-input-history-current) (setq my-jabber-input-history-current nil)) ((= pos len) ; pointing beyound last element, notify user (message "%s" "No next input")) (t ; insert next history item (incf my-jabber-input-history-position) (delete-region jabber-point-insert (point-max)) (insert (nth my-jabber-input-history-position my-jabber-input-history))))))</span></span></code> </pre><br>  Here the logic is smarter.  If we are on the last item in the list (len - 1), then we need to insert previously saved user input.  But the position is still increasing, so that next time the second condition worked. <br>  We hang these functions on convenient buttons: <br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">define-key</span></span> jabber-chat-mode-map (<span class="hljs-name"><span class="hljs-name">kbd</span></span> <span class="hljs-string"><span class="hljs-string">"Mp"</span></span>) 'my-jabber-previous-input) (<span class="hljs-name"><span class="hljs-name">define-key</span></span> jabber-chat-mode-map (<span class="hljs-name"><span class="hljs-name">kbd</span></span> <span class="hljs-string"><span class="hljs-string">"Mn"</span></span>) 'my-jabber-next-input)</code> </pre><br>  Is done.  Now we have the same functionality as in pidgin + notification of reaching the beginning and end of the list + history without duplicate messages (thanks to the add-to-list). <br>  Fans of ido-mode can come in handy with this feature: <br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defun</span></span> my-jabber-input-history-choose () (<span class="hljs-name"><span class="hljs-name">interactive</span></span>) (<span class="hljs-name"><span class="hljs-name">let</span></span> ((<span class="hljs-name"><span class="hljs-name">choice</span></span> (<span class="hljs-name"><span class="hljs-name">ido-completing-read</span></span> <span class="hljs-string"><span class="hljs-string">"Select history item: "</span></span> (<span class="hljs-name"><span class="hljs-name">reverse</span></span> my-jabber-input-history)))) (<span class="hljs-name"><span class="hljs-name">delete-region</span></span> jabber-point-insert (<span class="hljs-name"><span class="hljs-name">point-max</span></span>)) (<span class="hljs-name"><span class="hljs-name">insert</span></span> choice)))</code> </pre><br>  Since this is ido, then the search in the list works as you type the text (even fuzzy if the variable ido-enable-flex-matching is set) and search through the options for Cs / Cr. <br><br><h2>  the end </h2><br>  The text was prepared in emacs using org-mode and exporting to a docbook (C-c Ce D). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Links </h2><br>  <a href="">Lis code</a> <br><br>  <a href="">The source of this article</a> <br><br>  <a href="">XSLT for converting XML into a clear format.</a> </div><p>Source: <a href="https://habr.com/ru/post/164573/">https://habr.com/ru/post/164573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164561/index.html">We program on holidays in Windows 8</a></li>
<li><a href="../164563/index.html">Ways of moving computer characters (part 2)</a></li>
<li><a href="../164567/index.html">Results of the New Year Habr Programming Contest, Analysis and Discussion</a></li>
<li><a href="../164569/index.html">Avis buys car rental service ZipCar for $ 500 million</a></li>
<li><a href="../164571/index.html">Funny bugs and features in Visual Studio and .NET</a></li>
<li><a href="../164577/index.html">Annotated by Ubuntu for phones, the first devices will appear in early 2014</a></li>
<li><a href="../164581/index.html">Facebook has limited the number of comments displayed to unsubscribed readers.</a></li>
<li><a href="../164583/index.html">OneTesla: Tesla Coil as a Musical Instrument</a></li>
<li><a href="../164585/index.html">Google, HelloFax, Expensify and others want you to abandon paper in 2013</a></li>
<li><a href="../164587/index.html">The modern Internet has turned 30 years old</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>