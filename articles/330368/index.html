<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÄúBreak the vote on RHS ++‚Äù. Give us 1,000,000 RPS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The second day of RHS ++ passed, and without delay we want to talk about how the whole world tried to break our voting box . Under the cut - the code,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>‚ÄúBreak the vote on RHS ++‚Äù. Give us 1,000,000 RPS</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/96a/abb/c71/96aabbc717a0417084e940e7dd18e4b2.png"></p><br><p>  The second day of RHS ++ passed, and without delay we want to talk about how the whole world tried to <a href="https://habrahabr.ru/company/odin_ingram_micro/blog/330216/">break our voting box</a> .  Under the cut - the code, metrics, the names of the winners and the most active participants, and other dirty details. </p><a name="habracut"></a><br><p>  Shortly before the RHS ++, we thought about how to entertain people?  We decided to make a vote for the coolest programming language.  And so that the results in real time were displayed on dashboards.  The voting procedure was made simple: it was possible to go to the ODN.PW website from any device, specify your name and e-mail, and vote for any language.  With the list of languages, they were not wise - they took the nine most popular ones according to GitHub, the ‚ÄúOther‚Äù language was the tenth item.  Colors for the dice, too, took with GitHub. </p><br><p><img src="https://habrastorage.org/web/616/b76/af3/616b76af34d54e75a7d9c4f0d200090c.png"></p><br><p>  But we understood that cheating would be inevitable, and with the use of ‚Äúheavy artillery‚Äù - all of our own, an advanced audience, this is not a vote on the mommy forum.  Therefore, we decided to welcome cheating in all possible ways.  Moreover, they offered to try the community to put our voting station with a big load.  To make it even easier for participants, they put a <a href="http://odn.pw/api">link to the API</a> for cheating with bots.  And at the same time they decided to award with incentive prizes the first three participants with the highest number of RPS.  A separate nomination was prepared for the strongman who can break the ballot box alone. </p><br><h2>  The first day </h2><br><p>  Voting was launched almost from the very beginning of RIT ++, and it worked until 18 o'clock.  Visitors and speakers of RIT ++ liked our entertainment.  High-performance services professionals are actively involved in the race for RPS.  Booth guests vividly discussed ways to put a vote.  Teams of adepts of this or that language spontaneously emerged, which began to invent promotion strategies.  Someone immediately sat down and started writing microservices or bots to participate in voting. </p><br><p><img src="https://habrastorage.org/web/73a/b35/b4a/73ab35b4a7844d8a80652bb1d6fc80ea.jpg"></p><br><p>  Some companies participating in RIT ++ and providing secure hosting services have also joined our competition.  By the very end of the day, by joint efforts, the participants were able to put the system in for a short while.  Well, as they "put it" - the service worked, we just rested against the ceiling by the number of simultaneously registered votes.  Therefore, by 18 o'clock we suspended the voting, otherwise the results would have been unreliable. </p><br><p>  According to the results of the first day, we received 160 million votes, and the peak load reached 20,000 RPS.  It is curious that on this day the first and second places were taken by the active participant RIT ++ <br>  Nikolai Macievsky (Airi) and speaker Elena Grahovac from Openprovider. </p><br><p>  At night, we prepared for the next day to meet him fully armed: we optimized the communication with the base and set the nginx before the Node.js application on each worker. </p><br><h2>  Second day </h2><br><p>  Many were interested in our proposal to put a vote, because the race for RPS is a fascinating task.  In the morning we were already ‚Äúwaiting‚Äù: as soon as we switched the DNS, the number of RPS took off to 100,000. And in half an hour the load went up to 300,000 RPS. </p><br><p>  It's funny that when we started to develop voting ballots, we decided that ‚Äúit would be nice to support 100,000 RPS‚Äù.  And just in case, laid the maximum performance of 1 million RPS, but at the same time even seriously did not consider the possibility of approaching such an indicator.  And by the middle of the second day, they were practically betting on whether to break the ceiling into a million requests per second.  As a result, we have reached about 500,000 RPS. </p><br><h2>  Implementation </h2><br><p>  We wrote down the project in 1.5 days, right before RIT ++.  Voting is placed in the cloud service Google Cloud Platform.  Three-tier architecture: </p><br><p>  ‚Ä¢ Top level: a balancer acting as a front end, to which a flow of requests arrives.  It spreads the load on the servers. <br>  ‚Ä¢ Middle level: backend on Node.js 8.0.  The number of machines involved is scaled according to the current load.  This is done economically, and not with a margin, so as not to overpay for nothing.  By the way, the project cost $ 8,000. <br>  ‚Ä¢ Lower level: clustered MongoDB for storing votes, consisting of three servers (one master and two slaves). </p><br><p>  All voting components are open source, available on Github: </p><br><p>  ‚Ä¢ Backend: <a href="https://github.com/spukst3r/counter-store">https://github.com/spukst3r/counter-store</a> <br>  ‚Ä¢ Frontend: <a href="https://github.com/weglov/treechart">https://github.com/weglov/treechart</a> </p><br><p>  During the development of the backend in the air, the idea of ‚Äã‚Äãcaching each request for vote wrapping and periodically sending them to the database was vital.  But due to lack of time, uncertainty about the number of participants and the banal laziness, it was decided to postpone this idea and leave sending data to the database for each request.  At the same time, MongoDB's performance in this mode is checked. </p><br><p>  Well, as the first day showed, it was necessary to fasten the cache immediately.  Each Node.js worker did not issue more than 3000 RPS per each POST to / poll, and the MongoDB master coughed heavily with LA&gt; 100.  Even optimization of query aggregation to get statistics by changing <a href="">read preference</a> to use slaves for reading did not help much.  Well, nothing, it's time to implement the cache for cheating counters and for checking the validity of email (which was wrapped up in a simple <a href="">_.memoize</a> , because we never delete users).  We also used a new project in Google Compute Engine, with higher quotas. </p><br><p>  After enabling caching of votes, MongoDB felt excellent, showing LA &lt;1 even at the peak of the load.  And the productivity of each worker increased by 50% - up to 4500 RPS.  To periodically send data, we used <a href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/">bulkWrite</a> with the <a href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/">ordered</a> parameter disabled to leave the database on the side of the order of execution of requests to optimize speed. </p><br><p>  On the first day, a Node.js server worked on each worker, creating four child processes through the cluster module, each of which listened to port 3000. For the second day, we abandoned such a server and sent HTTP processing to the "professionals".  Experiments have shown that nginx, interacting with the application via a unix-socket, gives approximately +500 RPS.  The setting is fairly standard for a large number of connections: increased worker_rlimit_nofile, sufficient worker_connections, enabled tcp_nopush and tcp_nodelay.  By the way, disabling <a href="https://en.wikipedia.org/wiki/Nagle%27s_algorithm">the Nagle algorithm</a> helped raise the RPS in Node.js.  In each virtual, it was necessary to increase the limit on the number of open files and the maximum size of the backlog. </p><br><h2>  Results </h2><br><p>  For two days, no participant alone could not put our service.  But at the end of the first day, by common efforts, they ensured that the system did not have time to register all incoming requests.  On the second day, we set a record load of ~ 450,000 RPS.  The difference in the testimony of the RPS on the front (which calculated and averaged the RPS on the basis of the actual records in the database) and the testimony of Google monitoring remains for us so far secret. </p><br><p><img src="https://habrastorage.org/web/f95/766/534/f95766534c4d41e6aec3eb38035be95d.png"></p><br><p>  And we are pleased to announce the winners of our little competition: </p><br><p><img src="https://habrastorage.org/web/a06/cda/33b/a06cda33b3c446b899803c72e6d9ecbc.png"></p><br><p>  1st place - {"_id": "ivan@buymov.ru", "count": 2107126721} <br>  2nd place - {"_id": "burik666@gmail.com", "count": 1453014107} <br>  3rd place - {"_id": "256@flant.com", "count": 626160912} </p><br><p>  For prizes write <a href="https://habrahabr.ru/users/kosheleva_ingram_micro/" class="user_link">kosheleva_ingram_micro</a> ! </p><br><p>  UPD: <a href="http://odn.pw/">TOP50 Hall of Fame</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/330368/">https://habr.com/ru/post/330368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330358/index.html">Rapid STP</a></li>
<li><a href="../330360/index.html">Freeswitch Phonebook</a></li>
<li><a href="../330362/index.html">Mikrotik. QoS for home</a></li>
<li><a href="../330364/index.html">On the road with clouds. Relational databases in a new technological context</a></li>
<li><a href="../330366/index.html">We are building the development process and the CI pipeline, or How can a developer become DevOps for QA</a></li>
<li><a href="../330370/index.html">What is exclusive blockchains?</a></li>
<li><a href="../330372/index.html">Implementing Lean tools in the Service Desk command</a></li>
<li><a href="../330374/index.html">Working with peripherals from JavaScript: from theory to practice</a></li>
<li><a href="../330376/index.html">Smart Integration Plugs</a></li>
<li><a href="../330382/index.html">Huginn: a simple integration platform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>