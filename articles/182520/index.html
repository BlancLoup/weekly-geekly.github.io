<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Indexing nonatomic attributes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wikipedia Quotes ( 1NF ): 
 Each row and column intersection contains exactly one value from the corresponding domain (and nothing more). 

 The same ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Indexing nonatomic attributes</h1><div class="post__text post__text-html js-mediator-article">  Wikipedia Quotes ( <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B5%25D1%2580%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25BD%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0">1NF</a> ): <br><blockquote>  Each row and column intersection contains exactly one value from the corresponding domain (and nothing more). <br><br>  The same value can be atomic or non-atomic, depending on the meaning of this value.  For example, the value "4286" is <br><ul><li>  <b>atomic</b> , if its meaning is ‚Äúpin-code of a credit card‚Äù (when splitting or re-ordering, the meaning is lost) </li><li>  <b>non-atomic</b> if its meaning is ‚Äúa set of numbers‚Äù (no sense is lost when splitting or reordering) </li></ul></blockquote><br>  This article will discuss the standard methods for accelerating SQL queries for the following field types: string, date, simple list (in $ LB format), list collections and collection arrays. <br><a name="habracut"></a><br>  Table of contents: <br><br><ul><li>  <a href="https://habr.com/ru/company/intersystems/blog/182520/">Delimited string</a> </li><li>  <a href="https://habr.com/ru/company/intersystems/blog/182520/">Hiding sensitive data</a> </li><li>  <a href="https://habr.com/ru/company/intersystems/blog/182520/">Hiding sensitive data (continued)</a> </li><li>  <a href="https://habr.com/ru/company/intersystems/blog/182520/">Date (time, etc.)</a> </li><li>  <a href="https://habr.com/ru/company/intersystems/blog/182520/">Simple list</a> </li><li>  <a href="https://habr.com/ru/company/intersystems/blog/182520/">Collection list</a> </li><li>  <a href="https://habr.com/ru/company/intersystems/blog/182520/">Array collection</a> </li><li>  <a href="https://habr.com/ru/company/intersystems/blog/182520/">Finally</a> </li></ul><br><h4>  Introduction </h4><br>  Consider first the classic version of the example of the list of phones. <br>  Create test data: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cl_phones(tname varchar2(<span class="hljs-number"><span class="hljs-number">100</span></span>), phone varchar2(<span class="hljs-number"><span class="hljs-number">30</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cl_phones(tname,phone) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'867-843-25'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cl_phones(tname,phone) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'830-044-35'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cl_phones(tname,phone) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'530-055-35'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cl_phones(tname,phone) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'530-055-35'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cl_phones(tname,phone) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'555-011-35'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cl_phones(tname,phone) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'530-055-31'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cl_phones(tname,phone) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'531-051-32'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cl_phones(tname,phone) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'532-052-33'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cl_phones(tname,phone) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'533-053-35'</span></span>);</code> </pre> <br>  Now, we list the phones separated by a comma for each name: <br><blockquote>  <font color="#0000ff">SELECT</font> <font color="#0000ff"><br></font>  <font color="#000000">% exact (</font> <font color="#008000">tname</font> <font color="#000000">)</font> <font color="#008000">tname</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#808000">LIST</font> <font color="#000000">(</font> <font color="#008000">phone</font> <font color="#000000">)</font> <font color="#008000">phonestr</font> <font color="#008000"><br></font>  <font color="#000080">FROM</font> <font color="#008000">cl_phones</font> <font color="#008000"><br></font>  <font color="#000080">GROUP BY</font> <font color="#008000">tname</font> <br></blockquote><br>  or so: <br><blockquote>  <font color="#0000ff">SELECT</font> <font color="#0000ff"><br></font>  <font color="#000080">distinct</font> <font color="#000000">% exact (</font> <font color="#008000">tname</font> <font color="#000000">)</font> <font color="#008000">tname</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#808000">LIST</font> <font color="#000000">(</font> <font color="#008000">phone</font> <font color="#000080">% foreach</font> <font color="#000000">(</font> <font color="#008000">tname</font> <font color="#000000">))</font> <font color="#008000">phonestr</font> <font color="#008000"><br></font>  <font color="#000080">FROM</font> <font color="#008000">cl_phones</font> <br></blockquote><br>  Result: <br><table><tbody><tr><th>  tname </th><th>  phonestr </th></tr><tr><td>  Andrew </td><td>  867-843-25,830-044-35,530-055-35 </td></tr><tr><td>  Vania </td><td>  530-055-31,531-051-32,532-052-33,533-053-35 </td></tr><tr><td>  Maksim </td><td>  530-055-35,555-011-35 </td></tr></tbody></table>  By building an index on the <i>phone</i> , we can do a very quick search for a specific phone.  The only disadvantage of such a solution is in the duplication of names: the more elements in the list, the more our database will swell. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Therefore, sometimes it is useful to store multiple values ‚Äã‚Äãin one field at once - it can be a list of phones or its parts, passwords, etc., - as a string with a separator, and at the same time have the ability to do a quick search for individual values.  Of course, you can create an ordinary index on such a field and do a search for a substring in this large string, but, first, since there can be quite a few elements, the index length will be significant, and second, such an index will still will not help speed up our search. <br><br>  So how to be? <br><br>  Especially for such cases, a special kind of index was introduced for fields containing collections. <br>  Collections can be either "real" (built-in <i>list of &lt;...&gt;</i> and <i>array of &lt;...&gt;</i> ) or "virtual." <br>  In the case of built-in collections, the system is responsible for forming such an index on them, and the programmer cannot change this process; in the case of virtual ones, the responsibility for forming the index lies with the programmer. <br>  A simple delimited string, a date, a simple list ‚Äî these are examples of such ‚Äúvirtual‚Äù collections. <br><br>  So, the index syntax on the collection is as follows: <blockquote>  <font color="#000080">INDEX</font> <font color="#000000">idx1 ON (MyField (ELEMENTS));</font> </blockquote>  or <blockquote>  <font color="#000080">INDEX</font> <font color="#000000">idx1 ON (MyField (KEYS));</font> </blockquote><br>  The process of forming such an index is the responsibility of the method named <i><b>propertyname</b> BuildValueArray</i> , which the developer must implement independently. <br>  The general signature of the method is as follows: <blockquote>  <font color="#000080">ClassMethod</font> <font color="#000000">propertynameBuildValueArray (</font> <font color="#ff00ff">value</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">valueArray</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> </blockquote><br>  Where: <br><ul><li>  <i>value</i> - the value of the field for splitting into elements; </li><li>  <i>valueArray</i> is the resulting array containing individual elements. <br>  An array is a set of key / value of the form: <br>  array (key1) = value1 <br>  array (key2) = value2 <br>  etc. </li></ul><br>  As mentioned above, for embedded collections, this method is automatically generated by the system and has the <b>[Final]</b> attribute, which prevents the developer from overriding it. <br><br>  Let's build such indexes and see how to use them in our SQL queries. <blockquote>  Note: in order to avoid artifacts from the previous example, it is recommended to completely clean the globals and the storage scheme of the class before each new one. <br></blockquote><br><a name="ex1"></a><h4>  Delimited string </h4><br>  Create the following class: <blockquote>  <font color="#000080">Class demo.test Extends% Persistent</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">Index</font> <font color="#000000">iPhones On Phones (ELEMENTS);</font> <font color="#000000"><br><br></font>  <font color="#000080">Property</font> <font color="#000000">Phones</font> <font color="#000080">As% String</font> <font color="#000000">;</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">PhonesBuildValueArray (</font> <font color="#000000"><br></font>  <font color="#ff00ff">value</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#000080">ByRef</font> <font color="#ff00ff">array</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">If</font> <font color="#800000">value</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(0) =</font> <font color="#800000">value</font> <font color="#800000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">else</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">list</font> <font color="#000000">=</font> <font color="#0000ff">$ ListFromString</font> <font color="#000000">(</font> <font color="#800000">value</font> <font color="#000000">,</font> <font color="#008000">","</font> <font color="#000000">),</font> <font color="#800000">ptr</font> <font color="#000000">= 0</font> <font color="#000000"><br></font>  <font color="#0000ff">While $ ListNext</font> <font color="#000000">(</font> <font color="#800000">list</font> <font color="#000000">,</font> <font color="#800000">ptr</font> <font color="#000000">,</font> <font color="#800000">item</font> <font color="#000000">)</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(</font> <font color="#800000">ptr</font> <font color="#000000">) =</font> <font color="#800000">item</font> <font color="#800000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">Fill ()</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">truncate table</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#800080">)</font> <font color="#800080"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">insert</font> <font color="#000080">into</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#000000">(</font> <font color="#008000">phones</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">select</font> <font color="#000080">null union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'a'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'b, a'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'b, b'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'a, c, b'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">',,'</font> <font color="#008080"><br></font>  <font color="#800080">)</font> <font color="#800080"><br><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testD</font> <font color="#000000"><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testI</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> </blockquote><br>  Run the <b>Fill</b> () method in the terminal: <br><br> <code>USER&gt;do ##class(demo.test).Fill()</code> <br> <code>^demo.testD=6</code> <br> <code>^demo.testD(1)=$lb("","")</code> <br> <code>^demo.testD(2)=$lb("","a")</code> <br> <code>^demo.testD(3)=$lb("","b,a")</code> <br> <code>^demo.testD(4)=$lb("","b,b")</code> <br> <code>^demo.testD(5)=$lb("","a,c,b")</code> <br> <code>^demo.testD(6)=$lb("",",,")</code> <br> <code>^demo.testI("iPhones"," ",1)=""</code> <br> <code>^demo.testI("iPhones"," ",6)=""</code> <br> <code>^demo.testI("iPhones"," A",2)=""</code> <br> <code>^demo.testI("iPhones"," A",3)=""</code> <br> <code>^demo.testI("iPhones"," A",5)=""</code> <br> <code>^demo.testI("iPhones"," B",3)=""</code> <br> <code>^demo.testI("iPhones"," B",4)=""</code> <br> <code>^demo.testI("iPhones"," B",5)=""</code> <br> <code>^demo.testI("iPhones"," C",5)=""</code> <br> <br>  As you can see, the index got a string not entirely, but its separate parts.  Thus, you decide how to split one large string into substrings.  In addition to the delimited lines, this can be xml, json, or something else. <br><br>  The contents of our table will be as follows: <br><table><tbody><tr><th>  ID </th><th>  Phones </th></tr><tr><td>  one </td><td>  (null) </td></tr><tr><td>  2 </td><td>  a </td></tr><tr><td>  3 </td><td>  b, a </td></tr><tr><td>  four </td><td>  b, b </td></tr><tr><td>  five </td><td>  a, c, b </td></tr><tr><td>  6 </td><td>  ,, </td></tr></tbody></table>  Now we will try to find all the lines containing the value "a".  For this, predicates <b>like '% xxx%'</b> or <b>['xxx'</b> are usually used, for example: <blockquote>  <font color="#0000ff">select</font> <font color="#000080">* from</font> <font color="#008000">demo</font> <font color="#000000">.</font>  <font color="#008000">test</font> <font color="#000080">where</font> <font color="#008000">Phones</font> <font color="#000000">[</font> <font color="#008080">'a'</font> <br>  <font color="#0000ff">select</font> <font color="#000080">* from</font> <font color="#008000">demo</font> <font color="#000000">.</font>  <font color="#008000">test</font> <font color="#000080">where</font> <font color="#008000">Phones</font> <font color="#000000">like</font> <font color="#008080">'% a%'</font> </blockquote>  But in this case our <b>iPhones</b> index will not be used.  To use it, you need to use a special predicate. <br><br> <code>FOR SOME %ELEMENT() (%VALUE = )</code> <br> <br>  In view of the above, our request will look as follows: <blockquote>  <font color="#0000ff">select</font> <font color="#000080">* from</font> <font color="#008000">demo</font> <font color="#000000">.</font>  <font color="#008000">test</font> <font color="#000080">where</font> <font color="#000000">for some% element (</font> <font color="#008000">Phones</font> <font color="#000000">) (</font> <font color="#008000">% value</font> <font color="#000000">=</font> <font color="#008080">'a'</font> <font color="#000000">)</font> </blockquote>  As a result, due to the use of a specialized index, the speed of this query compared with the previous options will be much higher. <br>  Of course, more complicated conditions are permissible, for example: <br><br>  ( <font color="#008000">% Value</font> <font color="#000000">% STARTSWITH</font> <font color="#008080">'a'</font> <font color="#000000">)</font> <br>  ( <font color="#008000">% Value</font> <font color="#000000">[</font> <font color="#008080">'a'</font> <font color="#000000">and</font> <font color="#008000">% Value</font> <font color="#000000">[</font> <font color="#008080">'b'</font> <font color="#000000">)</font> <br>  ( <font color="#008000">% Value</font> <font color="#000000">in (</font> <font color="#008080">'c'</font> <font color="#000000">,</font> <font color="#008080">'d'</font> <font color="#000000">))</font> <br>  ( <font color="#008000">% Value</font> <font color="#000000">is</font> <font color="#000080">null</font> <font color="#000000">)</font> <br><br>  And now a little magic ... <br><br><a name="ex2"></a><h4>  Hiding sensitive data </h4><br>  In the <b>BuildValueArray</b> method <b>,</b> we usually fill in an <i>array</i> based on the value of <i>value</i> . <br><br>  But what happens if we do not follow this rule? <br><br>  Let's try this example: <blockquote>  <font color="#000080">Class demo.test Extends% Persistent</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">Index</font> <font color="#000000">iLogin On Login (ELEMENTS);</font> <font color="#000000"><br><br></font>  <font color="#000080">Property</font> <font color="#000000">Login</font> <font color="#000080">As% String</font> <font color="#000000">;</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">LoginBuildValueArray (</font> <font color="#000000"><br></font>  <font color="#ff00ff">value</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#000080">ByRef</font> <font color="#ff00ff">array</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">If</font> <font color="#800000">value</font> <font color="#000000">=</font> <font color="#008000">"Vasya"</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(0) =</font> <font color="#008000">"test1"</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(1) =</font> <font color="#008000">"test2"</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(2) =</font> <font color="#008000">"test3"</font> <font color="#008000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">ElseIf</font> <font color="#800000">value</font> <font color="#000000">=</font> <font color="#008000">"Peter"</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(</font> <font color="#008000">"-"</font> <font color="#000000">) =</font> <font color="#008000">"111"</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(</font> <font color="#008000">"5.4"</font> <font color="#000000">) =</font> <font color="#008000">"222"</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(</font> <font color="#008000">"fg"</font> <font color="#000000">) =</font> <font color="#008000">"333"</font> <font color="#008000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">else</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(</font> <font color="#008000">"key"</font> <font color="#000000">) =</font> <font color="#008000">"value"</font> <font color="#008000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">Fill ()</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">truncate table</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#800080">)</font> <font color="#800080"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">insert</font> <font color="#000080">into</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#000000">(</font> <font color="#008000">login</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'Vasya'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'Vasya'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'Peter'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'Peter'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'Ivan'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'Ivan'</font> <font color="#008080"><br></font>  <font color="#800080">)</font> <font color="#800080"><br><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testD</font> <font color="#000000"><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testI</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> </blockquote><br>  After filling, the table contents will be as follows: <br><table><tbody><tr><th>  ID </th><th>  Login </th></tr><tr><td>  one </td><td>  Vasya </td></tr><tr><td>  2 </td><td>  Vasya </td></tr><tr><td>  3 </td><td>  Petya </td></tr><tr><td>  four </td><td>  Petya </td></tr><tr><td>  five </td><td>  Ivan </td></tr><tr><td>  6 </td><td>  Ivan </td></tr></tbody></table>  And now - attention!  - try to execute the following query: <br><blockquote>  <font color="#0000ff">select</font> <font color="#000080">* from</font> <font color="#008000">demo</font> <font color="#000000">.</font>  <font color="#008000">test</font> <font color="#000080">where</font> <font color="#000000">for some% element (</font> <font color="#008000">Login</font> <font color="#000000">) (</font> <font color="#008000">% value</font> <font color="#000000">=</font> <font color="#008080">'111'</font> <font color="#000000">)</font> <br></blockquote><br>  We will return: <table><tbody><tr><th>  ID </th><th>  Login </th></tr><tr><td>  3 </td><td>  Petya </td></tr><tr><td>  four </td><td>  Petya </td></tr></tbody></table>  As a result, we see that part of the data is visible in the table, and part is hidden in the index, but by which we can nonetheless do a search. <br><br>  Where can it be useful to us? <br><br>  For example, in the index you can hide not one, as is customary, but a whole set of available passwords for a given user or any other sensitive information that is undesirable to open with SQL.  Of course, there are other options for this, for example <a href="">GRANT column-privilege</a> .  But in this case, you will have to use stored procedures to access protected fields. <br><br><a name="ex3"></a><h4>  Hiding sensitive data (continued) </h4><br>  If you look at the globals in which data and indexes are stored for our table, then we will not see the values ‚Äã‚Äãof our keys there: "5.4", "fg", etc .: <br><br> <code>^demo.testD=6</code> <br> <code>^demo.testD(1)=$lb("","")</code> <br> <code>^demo.testD(2)=$lb("","")</code> <br> <code>^demo.testD(3)=$lb("","")</code> <br> <code>^demo.testD(4)=$lb("","")</code> <br> <code>^demo.testD(5)=$lb("","")</code> <br> <code>^demo.testD(6)=$lb("","")</code> <br> <code>^demo.testI("iLogin"," 111",3)=""</code> <br> <code>^demo.testI("iLogin"," 111",4)=""</code> <br> <code>^demo.testI("iLogin"," 222",3)=""</code> <br> <code>^demo.testI("iLogin"," 222",4)=""</code> <br> <code>^demo.testI("iLogin"," 333",3)=""</code> <br> <code>^demo.testI("iLogin"," 333",4)=""</code> <br> <code>^demo.testI("iLogin"," TEST1",1)=""</code> <br> <code>^demo.testI("iLogin"," TEST1",2)=""</code> <br> <code>^demo.testI("iLogin"," TEST2",1)=""</code> <br> <code>^demo.testI("iLogin"," TEST2",2)=""</code> <br> <code>^demo.testI("iLogin"," TEST3",1)=""</code> <br> <code>^demo.testI("iLogin"," TEST3",2)=""</code> <br> <code>^demo.testI("iLogin"," VALUE",5)=""</code> <br> <code>^demo.testI("iLogin"," VALUE",6)=""</code> <br> <br>  Then why did we ask them? <br><br>  To answer this question, we slightly modify our index and reload the table. <br><blockquote>  <font color="#000080">Index</font> <font color="#000000">iLogin On (Login (KEYS), Login (ELEMENTS));</font> </blockquote><br>  Globals will take a different form (I will only give global with indexes): <br><br> <code>^demo.testI("iLogin"," -"," 111",3)=""</code> <br> <code>^demo.testI("iLogin"," -"," 111",4)=""</code> <br> <code>^demo.testI("iLogin"," 0"," TEST1",1)=""</code> <br> <code>^demo.testI("iLogin"," 0"," TEST1",2)=""</code> <br> <code>^demo.testI("iLogin"," 1"," TEST2",1)=""</code> <br> <code>^demo.testI("iLogin"," 1"," TEST2",2)=""</code> <br> <code>^demo.testI("iLogin"," 2"," TEST3",1)=""</code> <br> <code>^demo.testI("iLogin"," 2"," TEST3",2)=""</code> <br> <code>^demo.testI("iLogin"," 5.4"," 222",3)=""</code> <br> <code>^demo.testI("iLogin"," 5.4"," 222",4)=""</code> <br> <code>^demo.testI("iLogin"," FG"," 333",3)=""</code> <br> <code>^demo.testI("iLogin"," FG"," 333",4)=""</code> <br> <code>^demo.testI("iLogin"," KEY"," VALUE",5)=""</code> <br> <code>^demo.testI("iLogin"," KEY"," VALUE",6)=""</code> <br> <br>  Ok, now we have both the key values ‚Äã‚Äãand the element values ‚Äã‚Äãthemselves.  How can it help us in the future? <br><br>  For example, in the previously proposed option with passwords, besides the passwords themselves, you can store the date up to which the password will be valid, or something else.  And then in our request this fact can be used as follows: <blockquote>  <font color="#0000ff">select</font> <font color="#000080">* from</font> <font color="#008000">demo</font> <font color="#000000">.</font>  <font color="#008000">test</font> <font color="#000080">where</font> <font color="#000000">for some% element (</font> <font color="#008000">Login</font> <font color="#000000">) (</font> <font color="#008000">% key</font> <font color="#000000">=</font> <font color="#008080">'-'</font> <font color="#000000">and</font> <font color="#008000">% value</font> <font color="#000000">=</font> <font color="#008080">'111'</font> <font color="#000000">)</font> </blockquote><br>  Where and what to store - you decide, the only thing you need to remember is that the keys are unique, but the values ‚Äã‚Äãare not. <br>  In addition, in the "collection" index as well as in the standard index, you can store additional data: <br><blockquote>  <font color="#000080">Index</font> <font color="#000000">iLogin On (Login (KEYS), Login (ELEMENTS)) [</font> <font color="#000080">Data</font> <font color="#000000">= (</font> <font color="#000080">Login</font> <font color="#000000">,</font> <font color="#000080">Login</font> <font color="#000000">(ELEMENTS))];</font> </blockquote><br>  With this option, the above query will no longer access the data, but take everything from the index, which will also save time. <br><br><a name="ex4"></a><h4>  Date (time, etc.) </h4><br>  It would seem, but what do dates have to do with collections?  The most direct, because you often have to do a search only by day, month or year.  A regular index will not help us here, but the ‚Äúcollection‚Äù one will be very relevant. <br><br>  Let's consider the following example: <blockquote>  <font color="#000080">Class demo.test Extends% Persistent</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">Index</font> <font color="#000000">iBirthDay On (BirthDay (KEYS), BirthDay (ELEMENTS));</font> <font color="#000000"><br><br></font>  <font color="#000080">Property</font> <font color="#000000">BirthDay</font> <font color="#000080">As% Date</font> <font color="#000000">;</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod BirthDayBuildValueArray</font> <font color="#000000">(</font> <font color="#000000"><br></font>  <font color="#ff00ff">value</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#000080">ByRef</font> <font color="#ff00ff">array</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">If</font> <font color="#800000">value</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(0) =</font> <font color="#800000">value</font> <font color="#800000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">else</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">d</font> <font color="#000000">=</font> <font color="#0000ff">$ zd</font> <font color="#000000">(</font> <font color="#800000">value</font> <font color="#000000">, 3)</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(</font> <font color="#008000">"yy"</font> <font color="#000000">) = +</font> <font color="#0000ff">$ p</font> <font color="#000000">(</font> <font color="#800000">d</font> <font color="#000000">,</font> <font color="#008000">"-"</font> <font color="#000000">, 1)</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(</font> <font color="#008000">"mm"</font> <font color="#000000">) = +</font> <font color="#0000ff">$ p</font> <font color="#000000">(</font> <font color="#800000">d</font> <font color="#000000">,</font> <font color="#008000">"-"</font> <font color="#000000">, 2)</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(</font> <font color="#008000">"dd"</font> <font color="#000000">) = +</font> <font color="#0000ff">$ p</font> <font color="#000000">(</font> <font color="#800000">d</font> <font color="#000000">,</font> <font color="#008000">"-"</font> <font color="#000000">, 3)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">Fill ()</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">truncate table</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#800080">)</font> <font color="#800080"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">insert</font> <font color="#000080">into</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#000000">(</font> <font color="#008000">birthday</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">select</font> <font color="#000000">{</font> <font color="#000080">d</font> <font color="#008080">'2000-01-01'</font> <font color="#000000">}</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">{</font> <font color="#000080">d</font> <font color="#008080">'2000-01-02'</font> <font color="#000000">}</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">{</font> <font color="#000080">d</font> <font color="#008080">'2000-02-01'</font> <font color="#000000">}</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">{</font> <font color="#000080">d</font> <font color="#008080">'2001-01-01'</font> <font color="#000000">}</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">{</font> <font color="#000080">d</font> <font color="#008080">'2001-01-02'</font> <font color="#000000">}</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">{</font> <font color="#000080">d</font> <font color="#008080">'2001-02-01'</font> <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#800080">)</font> <font color="#800080"><br><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testD</font> <font color="#000000"><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testI</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> </blockquote><br>  The contents of our table after filling will take the following form: <br><table><tbody><tr><th>  ID </th><th>  Birthday </th></tr><tr><td>  one </td><td>  01/01/2000 </td></tr><tr><td>  2 </td><td>  01.02.2000 </td></tr><tr><td>  3 </td><td>  02/01/2000 </td></tr><tr><td>  four </td><td>  01.01.2001 </td></tr><tr><td>  five </td><td>  01.02.2001 </td></tr><tr><td>  6 </td><td>  01.02.2001 </td></tr></tbody></table>  Now it is very simple, and most importantly <b>very quickly</b> , you can do a search for specific parts of the date, for example, to output all February birthdays: <blockquote>  <font color="#0000ff">select</font> <font color="#000080">* from</font> <font color="#008000">demo</font> <font color="#000000">.</font>  <font color="#008000">test</font> <font color="#000080">where</font> <font color="#000000">for some% element (</font> <font color="#008000">BirthDay</font> <font color="#000000">) (</font> <font color="#008000">% key</font> <font color="#000000">=</font> <font color="#008080">'mm'</font> <font color="#000000">and</font> <font color="#008000">% value</font> <font color="#000000">= 2)</font> </blockquote><br>  Result: <br><table><tbody><tr><th>  ID </th><th>  Birthday </th></tr><tr><td>  3 </td><td>  02/01/2000 </td></tr><tr><td>  6 </td><td>  01.02.2001 </td></tr></tbody></table><br><a name="ex5"></a><h4>  Simple list </h4><br>  In Cach√©, there is a special data type for a simple list ( <b>% List</b> ), which can be used instead of a string, if there are difficulties with the choice of a separator. <br>  Using such a field is not much different from working with a string. <br><br>  Consider a small example: <blockquote>  <font color="#000080">Class demo.test Extends% Persistent</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">Index</font> <font color="#000000">iList On List (ELEMENTS);</font> <font color="#000000"><br><br></font>  <font color="#000080">Property</font> <font color="#000000">List</font> <font color="#000080">As% List</font> <font color="#000000">;</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">ListBuildValueArray (</font> <font color="#000000"><br></font>  <font color="#ff00ff">value</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#000080">ByRef</font> <font color="#ff00ff">array</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">If</font> <font color="#800000">value</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(0) =</font> <font color="#800000">value</font> <font color="#800000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">else</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">ptr</font> <font color="#000000">= 0</font> <font color="#000000"><br></font>  <font color="#0000ff">While $ ListNext</font> <font color="#000000">(</font> <font color="#800000">value</font> <font color="#000000">,</font> <font color="#800000">ptr</font> <font color="#000000">,</font> <font color="#800000">item</font> <font color="#000000">)</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">array</font> <font color="#000000">(</font> <font color="#800000">ptr</font> <font color="#000000">) =</font> <font color="#800000">item</font> <font color="#800000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">Fill ()</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">truncate table</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#800080">)</font> <font color="#800080"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">insert</font> <font color="#000080">into</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#000000">(</font> <font color="#008000">list</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">select</font> <font color="#000080">null union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#808000">$ LISTBUILD</font> <font color="#000000">(</font> <font color="#008080">'a'</font> <font color="#000000">)</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#808000">$ LISTBUILD</font> <font color="#000000">(</font> <font color="#008080">'b'</font> <font color="#000000">,</font> <font color="#008080">'a'</font> <font color="#000000">)</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#808000">$ LISTBUILD</font> <font color="#000000">(</font> <font color="#008080">'b'</font> <font color="#000000">,</font> <font color="#008080">'b'</font> <font color="#000000">)</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#808000">$ LISTBUILD</font> <font color="#000000">(</font> <font color="#008080">'a'</font> <font color="#000000">,</font> <font color="#008080">'c'</font> <font color="#000000">,</font> <font color="#008080">'b'</font> <font color="#000000">)</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#808000">$ LISTBUILD</font> <font color="#000000">(</font> <font color="#008080">'a ,,'</font> <font color="#000000">,</font> <font color="#000080">null</font> <font color="#000000">,</font> <font color="#000080">null</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">)</font> <font color="#800080"><br><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testD</font> <font color="#000000"><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testI</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> </blockquote><br>  The contents of the table in the ODBC display mode will look like this: <blockquote>  Note: Cach√© has three modes of data presentation: logical, ODBC and <a href="">data display options</a> . </blockquote><table><tbody><tr><th>  ID </th><th>  List </th></tr><tr><td>  one </td><td>  (null) </td></tr><tr><td>  2 </td><td>  a </td></tr><tr><td>  3 </td><td>  b, a </td></tr><tr><td>  four </td><td>  b, b </td></tr><tr><td>  five </td><td>  a, c, b </td></tr><tr><td>  6 </td><td>  "A ,," ,, </td></tr></tbody></table>  In this case, the element separator is not involved, so we can use any characters in the elements. <br><br>  When outputting a field of type <b>% List</b> in ODBC mode, the <a href="">ODBCDELIMITER</a> parameter is used as a delimiter, which by default is equal to ",". <br><br>  For example, with this field, our table will look like this: <blockquote>  <font color="#000080">Property</font> <font color="#000000">List</font> <font color="#000080">As% List</font> <font color="#000000">(</font> <font color="#000080">ODBCDELIMITER</font> <font color="#000000">=</font> <font color="#800080">"^"</font> <font color="#000000">);</font> </blockquote><table><tbody><tr><th>  ID </th><th>  List </th></tr><tr><td>  one </td><td>  (null) </td></tr><tr><td>  2 </td><td>  a </td></tr><tr><td>  3 </td><td>  b ^ a </td></tr><tr><td>  four </td><td>  b ^ b </td></tr><tr><td>  five </td><td>  a ^ c ^ b </td></tr><tr><td>  6 </td><td>  a ,, ^^ </td></tr></tbody></table>  Search for items is no different from the delimited string: <blockquote>  <font color="#0000ff">select</font> <font color="#000080">* from</font> <font color="#008000">demo</font> <font color="#000000">.</font>  <font color="#008000">test</font> <font color="#000080">where</font> <font color="#000000">for some% element (</font> <font color="#008000">List</font> <font color="#000000">) (</font> <font color="#008000">% value</font> <font color="#000000">=</font> <font color="#008080">'a ,,'</font> <font color="#000000">)</font> </blockquote><table><tbody><tr><th>  ID </th><th>  List </th></tr><tr><td>  6 </td><td>  "A ,," ,, </td></tr></tbody></table>  It is worth noting that the option with <a href="">% INLIST</a> does not yet use ‚Äúcollection‚Äù indexes, and therefore it will be slower than the above proposed: <blockquote>  <font color="#0000ff">select</font> <font color="#000080">* from</font> <font color="#008000">demo</font> <font color="#000000">.</font>  <font color="#008000">test</font> <font color="#000080">where</font> <font color="#008080">'a ,,'</font> <font color="#000000">% inlist</font> <font color="#008000">List</font> </blockquote><br><a name="ex6"></a><h4>  Collection list </h4><br>  Let's rewrite the example above, but instead of a simple list, we use the list collection: <br><blockquote>  <font color="#000080">Class demo.test Extends% Persistent</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">Index</font> <font color="#000000">iListStr On ListStr (ELEMENTS);</font> <font color="#000000"><br><br></font>  <font color="#000080">Property</font> <font color="#000000">ListStr</font> <font color="#000080">As a list of% String</font> <font color="#000000">;</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">Fill ()</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">truncate table</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#800080">)</font> <font color="#800080"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">insert</font> <font color="#000080">into</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#000000">(</font> <font color="#008000">liststr</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">select</font> <font color="#000080">null union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#808000">$ LISTBUILD</font> <font color="#000000">(</font> <font color="#008080">'a'</font> <font color="#000000">)</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#808000">$ LISTBUILD</font> <font color="#000000">(</font> <font color="#008080">'b'</font> <font color="#000000">,</font> <font color="#008080">'a'</font> <font color="#000000">)</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#808000">$ LISTBUILD</font> <font color="#000000">(</font> <font color="#008080">'b'</font> <font color="#000000">,</font> <font color="#008080">'b'</font> <font color="#000000">)</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#808000">$ LISTBUILD</font> <font color="#000000">(</font> <font color="#008080">'a'</font> <font color="#000000">,</font> <font color="#008080">'c'</font> <font color="#000000">,</font> <font color="#008080">'b'</font> <font color="#000000">)</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#808000">$ LISTBUILD</font> <font color="#000000">(</font> <font color="#008080">'a ,,'</font> <font color="#000000">,</font> <font color="#000080">null</font> <font color="#000000">,</font> <font color="#000080">null</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">)</font> <font color="#800080"><br><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testD</font> <font color="#000000"><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testI</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> </blockquote><br>  In this example, almost everything is the same, but not quite.  Special attention should be paid to the following things: <br><br><ul><li>  on the <a href="">COLLATION</a> values ‚Äã‚Äãof our fields, keys, and index elements in the <i>array</i> , which undergo appropriate transformations before saving to the global. <br>  Compare the values ‚Äã‚Äãin the global index in both examples, especially the representation of a <i>NULL</i> value; </li><li>  the <b>BuildValueArray</b> method <b>is</b> missing, so we cannot use keys, but only element values; </li><li>  the type of our field is a special collection class ( <b>% ListOfDataTypes</b> ). </li></ul><br><br><a name="ex7"></a><h4>  Array collection </h4><br>  As noted above, the collection list does not allow us to use keys.  The array collection corrects this flaw. <br><br>  Create the following class: <blockquote>  <font color="#000080">Class demo.test Extends% Persistent</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">Index</font> <font color="#000000">iArrayStr On (ArrayStr (KEYS), ArrayStr (ELEMENTS));</font> <font color="#000000"><br><br></font>  <font color="#000080">Property</font> <font color="#000000">str</font> <font color="#000080">As% String</font> <font color="#000000">;</font> <font color="#000000"><br><br></font>  <font color="#000080">Property</font> <font color="#000000">ArrayStr</font> <font color="#000080">As array Of% String</font> <font color="#000000">;</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">Fill ()</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">truncate table</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#800080">)</font> <font color="#800080"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">insert</font> <font color="#000080">into</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test</font> <font color="#000000">(</font> <font color="#008000">str</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">select</font> <font color="#000080">null union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'aaa'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'bbb'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'bbb'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#008080">'ccc'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000080">null</font> <font color="#000080"><br></font>  <font color="#800080">)</font> <font color="#800080"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">insert</font> <font color="#000080">into</font> <font color="#008000">demo</font> <font color="#000000">.</font> <font color="#008000">test_ArrayStr</font> <font color="#000000">(</font> <font color="#008000">test</font> <font color="#000000">,</font> <font color="#008000">element_key</font> <font color="#000000">,</font> <font color="#008000">arraystr</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">select</font> <font color="#000000">1,</font> <font color="#008080">'0'</font> <font color="#000000">,</font> <font color="#008080">'test1'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">1,</font> <font color="#008080">'1'</font> <font color="#000000">,</font> <font color="#008080">'test2'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">1,</font> <font color="#008080">'2'</font> <font color="#000000">,</font> <font color="#008080">'test3'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">2,</font> <font color="#008080">'0'</font> <font color="#000000">,</font> <font color="#008080">'test1'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">2,</font> <font color="#008080">'1'</font> <font color="#000000">,</font> <font color="#008080">'test2'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">2,</font> <font color="#008080">'2'</font> <font color="#000000">,</font> <font color="#008080">'test3'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">3,</font> <font color="#008080">'-'</font> <font color="#000000">,</font> <font color="#008080">'111'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">3,</font> <font color="#008080">'5.4'</font> <font color="#000000">,</font> <font color="#008080">'222'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">3,</font> <font color="#008080">'fg'</font> <font color="#000000">,</font> <font color="#008080">'333'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">4,</font> <font color="#008080">'-'</font> <font color="#000000">,</font> <font color="#008080">'111'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">4,</font> <font color="#008080">'5.4'</font> <font color="#000000">,</font> <font color="#008080">'222'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">4,</font> <font color="#008080">'fg'</font> <font color="#000000">,</font> <font color="#008080">'333'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">5,</font> <font color="#008080">'key'</font> <font color="#000000">,</font> <font color="#008080">'value'</font> <font color="#000080">union all</font> <font color="#000080"><br></font>  <font color="#0000ff">select</font> <font color="#000000">6,</font> <font color="#008080">'key'</font> <font color="#000000">,</font> <font color="#008080">'value'</font> <font color="#008080"><br></font>  <font color="#800080">)</font> <font color="#800080"><br><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testD</font> <font color="#000000"><br></font>  <font color="#0000ff">ZWrite</font> <font color="#000000">^ demo.testI</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> </blockquote><br>  Here you need to make a few explanations: <br><br><ul><li>  our data is still stored in two globals: ^ the <i>name of the class</i> <b>D</b> (the data itself) and ^ the <i>name of the class</i> <b>I</b> (the indices); </li><li>  having one class, however, we already have two tables: as usual <font color="green">demo.test</font> and one auxiliary <font color="green">demo.test_ArrayStr</font> ; </li><li>  The <font color="green">demo.test_ArrayStr</font> table provides convenient SQL access to the array data and has the following fields, some of which are predefined in advance: <br><ul><li>  <i>element_key</i> - key value (the field name is predefined); </li><li>  <i>ArrayStr</i> - element value; </li><li>  <i>test</i> - a link to the parent <font color="green">demo.test</font> table; </li><li>  <i>ID</i> - service primary key, which has the format <font color="green">test || element_key</font> (the field name is predefined); </li></ul></li><li>  the type of our field is a special collection class ( <b>% ArrayOfDataTypes</b> ). </li></ul><br>  So, the contents of our tables after the <b>Fill</b> () method will be as follows: <br><br>  <font color="green">Demo.test</font> table <table><tbody><tr><th>  ID </th><th>  str </th></tr><tr><td>  one </td><td>  (null) </td></tr><tr><td>  2 </td><td>  aaa </td></tr><tr><td>  3 </td><td>  bbb </td></tr><tr><td>  four </td><td>  bbb </td></tr><tr><td>  five </td><td>  ccc </td></tr><tr><td>  6 </td><td>  (null) </td></tr></tbody></table>  Table <font color="green">demo.test_ArrayStr</font> <table><tbody><tr><th>  ID </th><th>  test </th><th>  element_key </th><th>  ArrayStr </th></tr><tr><td>  1 || 0 </td><td>  one </td><td>  0 </td><td>  test1 </td></tr><tr><td>  1 || 1 </td><td>  one </td><td>  one </td><td>  test2 </td></tr><tr><td>  1 || 2 </td><td>  one </td><td>  2 </td><td>  test3 </td></tr><tr><td>  2 || 0 </td><td>  2 </td><td>  0 </td><td>  test1 </td></tr><tr><td>  2 || 1 </td><td>  2 </td><td>  one </td><td>  test2 </td></tr><tr><td>  2 || 2 </td><td>  2 </td><td>  2 </td><td>  test3 </td></tr><tr><td>  3 || 5.4 </td><td>  3 </td><td>  5.4 </td><td>  222 </td></tr><tr><td>  3 || - </td><td>  3 </td><td>  - </td><td>  111 </td></tr><tr><td>  3 || fg </td><td>  3 </td><td>  fg </td><td>  333 </td></tr><tr><td>  4 || 5.4 </td><td>  four </td><td>  5.4 </td><td>  222 </td></tr><tr><td>  4 || - </td><td>  four </td><td>  - </td><td>  111 </td></tr><tr><td>  4 || fg </td><td>  four </td><td>  fg </td><td>  333 </td></tr><tr><td>  5 || key </td><td>  five </td><td>  key </td><td>  value </td></tr><tr><td>  6 || key </td><td>  6 </td><td>  key </td><td>  value </td></tr></tbody></table>  It seems that having instead of one table two, we are now forced to do <a href="">JOIN</a> between them, but it is not. <br><br>  Given the object extensions for SQL provided by the Cach√© DBMS, our test query, which <font color="green">displays the</font> <b>str</b> field from <font color="green">demo.test</font> for strings with the "-" key and the value of the "111" element, will take the following form: <blockquote>  <font color="#0000ff">select</font> <font color="#008000">test ID</font> <font color="#000000">,</font> <font color="#008000">test</font> <font color="#000000">-&gt;</font> <font color="#008000">str</font> <font color="#000080">from</font> <font color="#008000">demo</font> <font color="#000000">.</font>  <font color="#008000">test_ArrayStr</font> <font color="#000080">where</font> <font color="#008000">element_key</font> <font color="#000000">=</font> <font color="#008080">'-'</font> <font color="#000000">and</font> <font color="#008000">arraystr</font> <font color="#000000">=</font> <font color="#008080">'111'</font> </blockquote>  or such <blockquote>  <font color="#0000ff">select</font> <font color="#008000">% ID</font> <font color="#000000">,</font> <font color="#008000">str</font> <font color="#000080">from</font> <font color="#008000">demo</font> <font color="#000000">.</font>  <font color="#008000">test</font> <font color="#000080">where</font> <font color="#008000">test_ArrayStr</font> <font color="#000000">-&gt;</font> <font color="#008000">element_key</font> <font color="#000000">=</font> <font color="#008080">'-'</font> <font color="#000000">and</font> <font color="#008000">test_ArrayStr</font> <font color="#000000">-&gt;</font> <font color="#008000">arraystr</font> <font color="#000000">=</font> <font color="#008080">'111'</font> </blockquote><br>  Result: <table><tbody><tr><th>  ID </th><th>  str </th></tr><tr><td>  3 </td><td>  bbb </td></tr><tr><td>  four </td><td>  bbb </td></tr></tbody></table>  As you can see, nothing complicated and no <b>JOIN</b> , since all our data is actually stored in one global and Cach√© knows about the ‚Äúrelatedness‚Äù of these tables.  Therefore, the fields can be referenced from both tables.  The <b>test_ArrayStr field</b> in the <font color="green">demo.test</font> table <font color="green">does</font> not actually exist, although we can access the related table through it. <br><br><a name="ex8"></a><h4>  Finally </h4><br>  The indexing mechanism described here is widely used in some system classes, such as, for example, <a href="">% Stream.GlobalCharacterSearchable</a> , which provides for the indexing of a text stream and searching it through SQL.  The article does not specifically cover examples of indexing collections into classes, because of their wide variety: embedded, stored, streams, custom, with collections of collections and others.  In addition, it is not always convenient and efficient to work with many of them through SQL, because the author does not see any particular need for such collections except for some very rare cases.  Also, full-text search is not covered here, since this is another area with its own indexes and approach to work through SQL.  In addition, examples of using properties such as <a href="">SqlListType</a> and <a href="">SqlListDelimiter were omitted</a> , but an inquisitive reader, I hope, can independently try them in action. <br><br><hr>  Useful links: <br><br><ul><li>  <a href="">Collection classes</a> </li><li>  <a href="">Indexing Collections</a> </li><li>  <a href="">Collection Indexing and Querying Collections through SQL</a> </li><li>  <a href="">FOR SOME% ELEMENT</a> </li><li>  <a href="">The Object / Relational Connection</a> </li><li>  <a href="">Extensions To SQL</a> </li><li>  <a href="">Special Features</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/182520/">https://habr.com/ru/post/182520/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../182506/index.html">Porting code to iOS / Android mobile devices</a></li>
<li><a href="../182508/index.html">Experiments with VMware</a></li>
<li><a href="../182512/index.html">Ekovozhdeniye with the new Cellocator IQ 50 terminal: a practical overview</a></li>
<li><a href="../182516/index.html">New chipsets from Texas Instruments will speed up charging time and increase battery life for smartphones and tablets</a></li>
<li><a href="../182518/index.html">How to make qmake always rebuild a project from scratch when changing macros</a></li>
<li><a href="../182522/index.html">Yandex's position on the new draft law on Internet regulation</a></li>
<li><a href="../182526/index.html">Bitbucket released a limited edition of branded T-shirts</a></li>
<li><a href="../182528/index.html">Ubuntu Phone already supports internet connection, social apps, calls and more</a></li>
<li><a href="../182540/index.html">Intel has introduced the fastest "Thunderbolt flash drive" in the world</a></li>
<li><a href="../182544/index.html">How to evaluate firmware testing tools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>