<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make toast and visualize IT systems at the same time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, dear readers! In this article I want to share the story of the preparation of toasts and tell you how we expanded the functionality of Zabb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make toast and visualize IT systems at the same time</h1><div class="post__text post__text-html js-mediator-article">  Greetings, dear readers!  In this article I want to share the story of the preparation of toasts and tell you how we expanded the functionality of Zabbix using a <s>coil of wire and an integrated chip of</s> Open Source solutions.  Everything in order, I ask under the cat. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/baa/1b6/322/baa1b6322a776d0560f77c65204ea69e.jpg" width="900" title="Image1.jpg" alt="Image1.jpg"><br><a name="habracut"></a><br>  Let's imagine the following: you work in an organization (it can be yours), which has a business process supported by one or more IT systems.  I know for sure that there is a monitoring system.  Then the vision blurs a little, and it is not clear: is it an industrial system or a free Open Source.  However, you have situations when all the sensors on it are green, but the business process itself gives inexplicable failures, showing a decrease in key indicators.  As a stun gun outbreak at a unauthorized rally, the thought that the situation is out of control and you need to act immediately rises in your head.  Only now it is not clear how.  I tell you, this is a fairly common case, from the manifestations of which it is desirable to quickly get rid of.  A systematic approach to solving this problem will provide a service model. <br><br>  <a href="http://tomwujec.com/">Tom Wudzek</a> , who provides services for the visualization of processes occurring in companies (not only IT), conducted a curious study.  He asked different people to draw a process of making toasts.  Below are some results of this work. <br><table><tbody><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/ca3/667/75a/ca366775aead09ab272753942b95646f.jpg" width="298"></td><td><img src="https://habrastorage.org/getpro/habr/post_images/2a6/a6f/b90/2a6a6fb90863017567dbce398423ebca.jpg" width="298"></td><td><img src="https://habrastorage.org/getpro/habr/post_images/e57/20d/484/e5720d48405139dd435772f46c7c910c.jpg" width="298"></td></tr></tbody></table><br>  What do we see in many pictures?  Right!  Objects and connections present in any system.  The more of them, the more systematic the approach will be.  The correct degree of granularity will allow you to more accurately track the "health" of the business system.  You can try to use Visio to build a scheme, but it is much more interesting to take a marker for drawing links, sticky note paper for objects and draw your system on a whiteboard.  The greater the number of yellow leaves, the more connections, the higher the chance to determine the maximum number of monitoring points to accurately determine the source of the problem. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And now it's time to talk about our developments in the field of expanding the standard Zabbix functionality and applying the systematic approach described above.  There are exactly two of them. <br><br>  The first is mapping systems and creating a heat map of services.  Considering our serious experience in monitoring banking business processes, we will give an example from this area.  Consider the three most typical banking systems.  If there are more typical systems in your bank, please excuse me - we will not consider them here. <br><br>  Remote Banking System (RB): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b7c/e50/923/b7ce5092386c37eda528df1f2b2bfafa.png" width="763"><br><br>  Corporate data transmission bus (ESB): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ed2/59a/aed/ed259aaed5b9250acb30c2e9dede5452.png" width="763"><br><br>  Decision Making System (DSS): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf4/4de/417/bf44de417a76e68190027b385d72090e.png" width="663"><br><br>  In our application, it will look like this (yes, the structure is somewhat disturbed, but the clarity remains): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0f1/04d/0ea/0f104d0ea2345ac571c655c3834084b6.jpg" width="900"><br><br>  If necessary, you can go to the level below.  And, last but not least, when you hover on an object, a pop-up window pops up with a description of the event and a link to the chart in Zabbix: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/767/723/602/7677236029344a1d94820737ac742fca.png" width="900"><br><br>  Thanks to this approach and a given degree of detail, the output we get a convenient dashboard, and at the same time a simple tool for localizing the problem.  A few words about the functionality of our system: <br><br>  - visualization of dependencies between corporate systems; <br>  - setting the degree of influence of components on each other (weight of connection); <br>  - integration with Zabbix (objects on the heat map are connected with triggers); <br>  - pop-up windows with the text of the event when you hover on the object; <br>  - visual interface for setting object links; <br>  - visual interface for setting connection of objects with Zabbix triggers. <br><br>  As an example, I will cite several already developed interfaces. <br><br>  Adding objects to the heatmap: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/380/38a/1f3/38038a1f311e9af3e772033128baec7a.png" width="900"><br><br>  Adding integration with Zabbix: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/498/02e/77d/49802e77d31669cedb72a38df4e9e700.png" width="900"><br><br>  Connecting Zabbix triggers to objects on a heat map: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/945/520/769/945520769b04ff2b66c9d6b904be7789.png" width="900"><br><br>  The system runs on <a href="https://developers.google.com/chart/interactive/docs/gallery/treemap">Google Charts</a> and <a href="http://getbootstrap.com/">Bootstrap</a> .  While this is an alpha version, we plan to develop it further, adding useful features from industrial systems with which we have been working successfully for many years.  I will try to keep you informed and publish posts as a pile of new features accumulates. <br><br>  The second development is integration with Zabbix and the thermal map of the functionality of synthetic transactions.  In fact, this is a continuation of the heat map, but a look from the other side.  Definitely, controlling the system only from the side of the application and infrastructure, you will not have the necessary information completeness.  Synthetic transactions will allow to look at this business from the user and localize the problem even before the first user visits to the Help Desk. <br><br>  Synthetic transactions are based on the phantom.js framework (but nothing prevents you from switching to casper.js, to pure selenium, or to something else to your taste).  In our test lab, the test script execution is configured via cron and then the resulting data is transferred to Zabbix via zabbix_trapper.  As an example of a test scenario, a login is taken to the MTS personal account and receiving the balance of the account and traffic in the Internet package.  Below is a listing script.  In banking, the most likely use of this tool may be, for example, RBS.  Nobody bothers you to make a login to the system and transfer 1 ruble from one account to another. <br><br><div class="spoiler">  <b class="spoiler_title">Test script for checking balance and traffic balance (Javascript)</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** *        * 1.0 * *  : * phantomjs --web-security=no getMtsBalance.js "&lt;   &gt;" "   (XXX) XXX-XX-XX" "&lt;&gt;" * : * phantomjs --web-security=no getMtsBalance.js "/tmp/getMtsBalance" "(916) 123-45-67" "P@ssw0rd" * * (c) Jet/ 2016 */</span></span> <span class="hljs-comment"><span class="hljs-comment">// PhantomJs stuff var fs = require('fs'); var system = require('system'); var webpage = require('webpage'); var args = system.args; var TRAFFIC_REGEX = /.{1,100}?([0-9.]+).{0,50}?(|).{0,50}? (\d+) /i; var DATE_REGEX = /  - ([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{2}) ([0-2][0-9]):([0-5][0-9])/; var SCRIPT_TIMEOUT = 40000; var config = { lkUrl : 'https://lk.ssl.mts.ru/', lkLogin: null, lkPass : null, outDir : null, debugDir: null, formattedStartTime: null }; var timer = { lastActionStartTime: null, lastActionTimeMs : null, currentTimeMillis: function() { return Date.now(); }, startAction: function() { this.lastActionStartTime = this.currentTimeMillis(); this.lastActionTimeMs = null; }, stopAction: function() { lastActionTimeMs = this.currentTimeMillis() - this.lastActionStartTime; }, getLastActionTimeMs: function() { return lastActionTimeMs; }, getLastActionTimeSec: function() { return lastActionTimeMs === null ? null : lastActionTimeMs/1000; } } var metrics = { trafLeftMb: null, daysLeft : null, balance : null, pages: { login: { availability : null, responseTimeSec: null }, lk: { availability : null, responseTimeSec: null } } }; ////////// HELPER FUNCTIONS ////////// var func = { log: function(s) { console.log(this.formatDateTimeForLog(new Date()) + " " + s); }, roundToTwo: function(num) { return +(Math.round(num + "e+2") + "e-2"); }, zero: function(i) { return i &lt; 10 ? '0' + i : i; }, formatDateTimeForLog: function(date) { var dd = date.getDate(); var mm = date.getMonth() + 1; var yy = date.getFullYear(); var hh = date.getHours(); var min = date.getMinutes(); var ss = date.getSeconds(); var ms = date.getMilliseconds(); ms = ('00' + ms).slice(-3); return yy + '-' + this.zero(mm) + '-' + this.zero(dd) + ' ' + this.zero(hh) + ':' + this.zero(min) + ':' + this.zero(ss) + '.' + ms; }, formatDateTimeForFileName: function(date) { return date.getFullYear() + this.zero(date.getMonth() + 1) + this.zero(date.getDate()) + '-' + this.zero(date.getHours()) + this.zero(date.getMinutes()) ; }, writeMetricToFileAndLog: function(filePrefix, metricName, metricValue) { if ( metricValue == null ) { metricValue = 0; } fs.write(config.outDir + filePrefix + config.formattedStartTime + '.log', this.roundToTwo(metricValue), 'w'); this.log(' ' + metricName + ' = ' + metricValue); } } //     config.outDir = args[1] + '/'; config.lkLogin = args[2]; config.lkPass = args[3]; config.debugDir = config.outDir + 'debug/'; fs.makeDirectory(config.debugDir); func.log("   : " + config.outDir); //  -      setTimeout(function() { func.log("   " + SCRIPT_TIMEOUT + " "); if ( metrics.pages.login.availability == null ) { metrics.pages.login.availability = 0; metrics.pages.login.responseTimeSec = 0; } if ( metrics.pages.lk.availability == null ) { metrics.pages.lk.availability = 0; metrics.pages.lk.responseTimeSec = 0; } outMetricsAndExit(); }, SCRIPT_TIMEOUT); //   "" var page = webpage.create(); page.settings.userAgent = 'Mozilla/4.0'; //       config.formattedStartTime = func.formatDateTimeForFileName(new Date()); //     func.log(" " + config.lkUrl); timer.startAction(); page.open(config.lkUrl, function (status) { timer.stopAction(); metrics.pages.login.responseTimeSec = timer.getLastActionTimeSec(); if (status !== "success" ) { func.log(" " + config.lkUrl + " "); metrics.pages.login.availability = 0; outMetricsAndExit(); } else { func.log(" " + config.lkUrl + "  "); metrics.pages.login.availability = 1; page.render(config.debugDir + 'login.png'); //    iframe',    var contentN = 0; page.onLoadFinished = function(status) { //  ,        //       (iframe'), //      , ..      , //   -.      - //     "",      //  . .         //      timer.stopAction(); contentN++; func.log('  N' + contentN + ':' + status); page.render(config.debugDir + contentN + '.png'); fs.write(config.debugDir + contentN + '.html', page.content, 'w'); if ( status === 'success') { getMtsMetrics(page, contentN); } }; func.log("  , : " + config.lkLogin); timer.startAction(); page.evaluate(function(config) { var form = document.forms[0]; form.phone.value = config.lkLogin; form.password.value = config.lkPass; form.elements[2].click(); }, config); } }); function getMtsMetrics(page, contentN) { if ( page.content.match(' ') ) { func.log("  :   .       "); metrics.pages.lk.availability = 0; metrics.pages.lk.responseTimeSec = 0; outMetricsAndExit(); } //      iFrame' findBalanceInPage(page, contentN); //     -    findTrafficInfoInPage(page); //    ,   if ( checkGotMetricsAlready() ) { outMetricsAndExit(); } } /** *        */ function findBalanceInPage(page, contentN) { //      iframe' if ( page.framesCount == 0 ) { return; } func.log("  iframe'"); var balanceResult = page.evaluate(function() { var result = { iframes: [], balance: null }; $("iframe").each(function(i, iframe) { var iframeBody = $(iframe).contents().find('body'); if ( iframeBody.size() &gt; 0 ) { result.iframes.push( iframeBody.html() ); //    1 -  DOM if ( result.balance === null ) { iframeBody.find(".b-header_balance").each(function() { var m = $(this).text().match(/([0-9.]+) /i); if ( m ) { result.balance = m[1]; } }); } //    2 -  regex if ( result.balance === null ) { var m = iframeBody.text().match(/\s*:\s*-?([0-9.]+)\s*/i); if ( m ) { result.balance = m[1]; } } } }); return result; }); var iframesAnalyzed = balanceResult.iframes.length; func.log(" iframe':" + iframesAnalyzed); if ( iframesAnalyzed &gt; 0 ) { //  iFrame'   for (var i = 0; i &lt; iframesAnalyzed; i++) { var iframeContent = balanceResult.iframes[i]; func.log("  iframe " + config.debugDir + contentN + '_iframe' + i + '.html'); fs.write(config.debugDir + contentN + '_iframe' + i + '.html', iframeContent, 'w'); } // ,       if ( balanceResult.balance !== null ) { if ( metrics.pages.lk.availability === null ) { //    ,       metrics.pages.lk.availability = 1; metrics.pages.lk.responseTimeSec = timer.getLastActionTimeSec(); } func.log("   : " + balanceResult.balance); metrics.balance = balanceResult.balance; } } } /** *    -   */ function findTrafficInfoInPage(page) { var traf = page.content.match(TRAFFIC_REGEX); if ( traf ) { func.log("  -  : " + traf); metrics.trafLeftMb = traf[1]; var trafUnits = traf[2]; if ( trafUnits.toLowerCase() == '' ) { metrics.trafLeftMb *= 1024; } metrics.daysLeft = traf[3]; } else if (page.content.match("  ") ) { func.log(" :   "); metrics.trafLeftMb = 0; if ( page.injectJs("jquery.min.js") ) { metrics.daysLeft = page.evaluate(function() { var p = $("p:contains('-  ')"); var pText = p.find("b").text(); console.log( " : " + pText); return pText.replace(/\D/g, ''); }); } } } /** * ,      */ function checkGotMetricsAlready() { if ( metrics.pages.login.availability == 0 || metrics.pages.lk.availability == 0 ) { //       (   ) //         ,    return true; } if ( metrics.balance != null &amp;&amp; metrics.daysLeft != null &amp;&amp; metrics.trafLeftMb != null ) { //   ,    return true; } return false; } /** *         , *    */ function outMetricsAndExit() { func.log(":"); func.writeMetricToFileAndLog('traffic', 'metrics.trafLeftMb', metrics.trafLeftMb); func.writeMetricToFileAndLog('money', 'metrics.balance', metrics.balance); func.writeMetricToFileAndLog('daysLeft', 'metrics.daysLeft', metrics.daysLeft); func.writeMetricToFileAndLog('status-initialpageload', 'metrics.pages.login.availability', metrics.pages.login.availability); func.writeMetricToFileAndLog('time-initialpageload', 'metrics.pages.login.responseTimeSec', metrics.pages.login.responseTimeSec); func.writeMetricToFileAndLog('status-lkpageload', 'metrics.pages.lk.availability', metrics.pages.lk.availability); func.writeMetricToFileAndLog('time-lkpageload', 'metrics.pages.lk.responseTimeSec', metrics.pages.lk.responseTimeSec); phantom.exit(); }</span></span></code> </pre> <br></div></div><br>  Assembled items are as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f66/618/e98/f66618e988155ec17367a10609cf9b63.png" width="900"><br><br>  Each has its own schedule. <br><br>  In no case do not want to say that the use of monitoring in Open Source solutions is a pill for all the trouble.  I will reveal the secret of Pusinel: as in physics, there is the law of saving money and labor.  The more money you pour into the finished product, the less labor costs for revision, and vice versa.  You should always be guided by common sense, the available budget and the human factor: will your team be ready to rush to the embrasure of business monitoring at the first call? <br><br>  Particularly interested in monitoring technologies, I suggest to get acquainted with our previous article on this topic, <a href="https://habrahabr.ru/company/jetinfosystems/blog/243991/">"Principles of monitoring business applications</a> . <a href="https://habrahabr.ru/company/jetinfosystems/blog/243991/">"</a> <br><br>  Article author: <b>Anton Kasimov</b> </div><p>Source: <a href="https://habr.com/ru/post/311640/">https://habr.com/ru/post/311640/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311626/index.html">Enable h264 video support on Firefox 49 on Windows XP</a></li>
<li><a href="../311628/index.html">The Ministry of Industry and Trade has published lists of manufacturers who will receive government subsidies for the development of electronics</a></li>
<li><a href="../311630/index.html">DBMS - Data Security</a></li>
<li><a href="../311632/index.html">How to teach students a course / diploma project or build a "tower" from the second floor</a></li>
<li><a href="../311636/index.html">Northern California court denied Oracle a petition for a new trial in a case against Google</a></li>
<li><a href="../311642/index.html">What you need to know, be able to and understand, so as not to have problems finding a job as a pythonist</a></li>
<li><a href="../311644/index.html">Three nannies for ProLiant</a></li>
<li><a href="../311646/index.html">Windows Server 2016 in Azure Pack Infrastructure: Virtual Jobs in 10 Minutes</a></li>
<li><a href="../311648/index.html">I was just obliged to check the project ICQ</a></li>
<li><a href="../311650/index.html">How we updated the contact center of a large bank in 2 months: migration without jambs (almost)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>