<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implement a custom UI element for timing. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part of the article, I recreated in detail the process of the implementation of the dial. Now we come to the most interesting and difficu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implement a custom UI element for timing. Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="https://habrahabr.ru/company/e-Legion/blog/326324/">first part of the</a> article, I recreated in detail the process of the implementation of the dial.  Now we come to the most interesting and difficult stage of creating our own custom control. <br><a name="habracut"></a><br><h4>  <b>Clock face rotation</b> </h4><br>  Here I describe the math of rotation, which I used on the advice of a report voiced on <a href="https://mbltdev.ru/ru">MBLTdev</a> . <br><br>  The main coordinate component here is the <code>contentOffset</code> the <code>scrollView</code> .  On this basis, we consider the angle of rotation. <br><br>  We introduce several properties that will store information about the current position of the twister. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">assign</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> currentAngle; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">assign</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> startPoint; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">assign</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> previousAngle;</code> </pre> <br>  We also need the value of the circumference. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">assign</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> circleLength;</code> </pre><br>  We make it when we set the radius of the circle.  Override the <code>setter</code> . <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)setCircleRadius:(<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)circleRadius { _circleRadius = circleRadius; _circleLength = <span class="hljs-number"><span class="hljs-number">2</span></span> * M_PI * circleRadius; }</code> </pre> <br>  We initialize <code>startPoint</code> in the method <code>- (void)commonInit</code> as the middle of <code>contentOffset</code> , so that we can rotate in both directions. <br><br><pre> <code class="objectivec hljs"> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.startPoint = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.scrollView.contentOffset;</code> </pre><br>  Preparations are made.  Now it's time to move on to math.  First we need to measure the distance between two points.  We use a simple formula - the root of the sum of squares of the differences of the corresponding coordinates. <br><br><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>d</mi><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>q</mi><mi>r</mi><mi>t</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>x</mi><mn>2</mn></msub></mrow><mo>&amp;#x2212;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>x</mi><mn>1</mn></msub></mrow><mo stretchy=&quot;false&quot;>)</mo></mrow><mn>2</mn></msup></mrow><mo>+</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>y</mi><mn>2</mn></msub></mrow><mo>&amp;#x2212;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>y</mi><mn>1</mn></msub></mrow><mo stretchy=&quot;false&quot;>)</mo></mrow><mn>2</mn></msup></mrow></mrow></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="32.346ex" height="3.142ex" viewBox="0 -1039.5 13926.8 1352.7" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-64" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-3D" x="801" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-73" x="2107" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-71" x="2577" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-72" x="3037" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-74" x="3489" y="0"></use><g transform="translate(3850,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-28" x="0" y="0"></use><g transform="translate(389,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-32" x="809" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-2212" x="1638" y="0"></use><g transform="translate(2638,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-31" x="809" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-29" x="3665" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-32" x="5734" y="675"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-2B" x="4730" y="0"></use><g transform="translate(5731,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-28" x="0" y="0"></use><g transform="translate(389,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-32" x="693" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-2212" x="1556" y="0"></use><g transform="translate(2556,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-31" x="693" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-29" x="3501" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-32" x="5502" y="675"></use></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>d</mi><mo>=</mo><mtext>&nbsp;</mtext><mi>s</mi><mi>q</mi><mi>r</mi><mi>t</mi><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><msup><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><msub><mi>x</mi><mn>2</mn></msub></mrow><mo>‚àí</mo><mrow class="MJX-TeXAtom-ORD"><msub><mi>x</mi><mn>1</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mn>2</mn></msup></mrow><mo>+</mo><mrow class="MJX-TeXAtom-ORD"><msup><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><msub><mi>y</mi><mn>2</mn></msub></mrow><mo>‚àí</mo><mrow class="MJX-TeXAtom-ORD"><msub><mi>y</mi><mn>1</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mn>2</mn></msup></mrow></mrow></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> d = \ sqrt {{{({x_2} - {x_1})} ^ 2} + {{({y_2} - {y_1})} ^ 2}} </script></p><br><br>  In code, it looks like this: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)deltaWithOffset:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)offset { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sqrt(pow(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.startPoint.x - offset.x, <span class="hljs-number"><span class="hljs-number">2</span></span>) + pow(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.startPoint.y - offset.y, <span class="hljs-number"><span class="hljs-number">2</span></span>)); }</code> </pre> <br>  Now we define the direction of motion, that is, the sign of the length.  To do this, determine where in the center of the circle is the touch point.  Why is it important?  Notice how the same gesture leads to a different direction of movement.  It is necessary to take into account this moment. <br><br><img src="https://habrastorage.org/files/63c/fc9/4df/63cfc94dfc20474c9e3664fd44db9c8b.png"><img src="https://habrastorage.org/files/11f/32a/df5/11f32adf589c434baa144d42d6fc36e6.png"><br><br>  We define a new type in which we describe the position of the point to the left and right of the center of the circle, <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NS_ENUM</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">NSUInteger</span></span>, AYNCircleViewHalf) { AYNCircleViewHalfLeft, AYNCircleViewHalfRight, };</code> </pre> <br>  and a method that calculates the position by a point: <br><br><pre> <code class="objectivec hljs">- (AYNCircleViewHalf)halfWithPoint:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)point { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> point.x &gt; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentView.center.x ? AYNCircleViewHalfRight : AYNCircleViewHalfLeft; }</code> </pre> <br>  Is done.  Now we know in which half of the circle is the point. <br><br>  Based on this information, we calculate the ‚Äúsign‚Äù of the rotation. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)signWithOffset:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)offset half:(AYNCircleViewHalf)half { <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> sign = offset.x &gt; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.startPoint.x ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> isYDominant = fabs(offset.y - <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.startPoint.y) &gt; fabs(offset.x - <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.startPoint.x); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isYDominant) { sign = offset.y &gt; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.startPoint.y ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; sign *= half == AYNCircleViewHalfLeft ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sign; }</code> </pre> <br>  Based on the sign and length, we now calculate the angle of rotation.  Let delta be the number of circle lengths in our offset.  Then the angle is the product of 2 <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>p</mi><mi>i</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.553ex" height="2.298ex" viewBox="0 -728.2 1099 989.6" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-70" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-69" x="753" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>p</mi><mi>i</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> \ pi </script>  radian on <code>delta</code> . <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)angleWithOffset:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)offset half:(AYNCircleViewHalf)half { <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> delta = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> deltaWithOffset:offset] / <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.circleLength; <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> sign = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> signWithOffset:offset half:half]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sign * delta * <span class="hljs-number"><span class="hljs-number">2</span></span> * M_PI; }</code> </pre> <br>  Now we define a method that will take away extra periods from corners.  For example, an angle of 3 <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>p</mi><mi>i</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.553ex" height="2.298ex" viewBox="0 -728.2 1099 989.6" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-70" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-69" x="753" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>p</mi><mi>i</mi></math></span></span><script type="math/tex" id="MathJax-Element-3"> \ pi </script>  before <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>p</mi><mi>i</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.553ex" height="2.298ex" viewBox="0 -728.2 1099 989.6" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-70" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-69" x="753" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>p</mi><mi>i</mi></math></span></span><script type="math/tex" id="MathJax-Element-4"> \ pi </script>  .  We need it to work with negative angles. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)floorAngle:(<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)angle { <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> times = floorf(fabs(angle) / (<span class="hljs-number"><span class="hljs-number">2</span></span> * M_PI)); <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> sign = angle &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> angle + sign * times * <span class="hljs-number"><span class="hljs-number">2</span></span> * M_PI; }</code> </pre> <br>  Done, we have a mathematical basis for turning our circle. <br><br>  Now we realize the turn of our entire hierarchy.  To do this, use the method over <code>UIView +</code> <code>- (void)animateWithDuration:animations:</code> <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)rotateWithAngle:(<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)angle { [<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> animateWithDuration:<span class="hljs-number"><span class="hljs-number">0.1</span></span> animations:^{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentView.transform = <span class="hljs-built_in"><span class="hljs-built_in">CGAffineTransformMakeRotation</span></span>(angle); }]; }</code> </pre> <br>  In this case, we do not weaken the link, because when the animation ends, the link to <code>self</code> disappear. <br><br>  We define the delegate method <code>- (void)scrollViewDidScroll:</code> in which we will perform all calculations and state changes: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)scrollViewDidScroll:(<span class="hljs-built_in"><span class="hljs-built_in">UIScrollView</span></span> *)scrollView { <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> point = [scrollView.panGestureRecognizer locationInView:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> tickOffset = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> angleWithOffset:scrollView.contentOffset half:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> halfWithPoint:point]]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentAngle = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> floorAngle:(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.previousAngle + tickOffset)]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> rotateWithAngle:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentAngle]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.previousAngle = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentAngle; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.startPoint = scrollView.contentOffset; }</code> </pre> <br>  Is done.  See how it looks. <br><br><img src="https://habrastorage.org/files/ad8/8ba/8c5/ad88ba8c5b744b30a415dae1582918b4.gif"><br><br>  Now we implement this control behavior, so that after a strong scroll, it later stops exactly on any number.  To do this, we need to calculate and change the <code>targetContentOffset</code> in the delegate method <code>- (void)scrollViewWillEndDragging:withVelocity:targetContentOffset:</code>  Let's add our mathematical apparatus. <br><br>  First of all, we normalize the angle to a multiple of the <code>angleStep</code> .  We define for this method. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)normalizeAngle:(<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)angle { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lroundf(angle / <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.angleStep) * <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.angleStep; }</code> </pre> <br>  Let us dwell on the description of the method for calculating the ‚Äúnormalized‚Äù <code>scrollView</code> stopping <code>scrollView</code> .  Method <code>- (void)scrollViewWillEndDragging:withVelocity:targetContentOffset:</code> returns the <code>contentOffset</code> that will <code>scrollView</code> when <code>scrollView</code> .  Our goal is to change this <code>CGPoint</code> .  We start from the normalized offset length value. <br><br><img src="https://habrastorage.org/files/0f7/f7e/ed7/0f7f7eed71a24112a4b4726026cc455c.png"><br><br>  Let <code>target</code> be <code>targetContentOffset</code> .  We calculate such a point <code>normalizedContentOffset</code> so that the resulting length translates into a multiple of a <code>angleStep</code> .  Then the control will stop the rotation exactly on the number. <br><br>  To do this, we calculate the ‚Äúnormalized‚Äù length and, knowing the angle of inclination of the initial displacement, we find the coordinates of the end of this displacement.  Changing the coordinates, change the stopping point. <br><br>  So, the algorithm for finding: <br><br>  - find the length of the current values ‚Äã‚Äãof <code>startPoint</code> , <code>targetPoint</code> , <br>  - find the angle of rotation along the length, <br>  - normalize the angle <br>  - find the normalized length, <br>  - find the end point on the new length. <br><br>  On the last point we will stop in addition.  To obtain the coordinates of the end point, it is necessary to find the projections of the normalized displacement on the Ox and Oy axes.  This can be done, knowing the angle of inclination of the displacement.  Calculate the slope tangent as the ratio <br><br><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>t</mi><mi>g</mi><mtext>&amp;#xA0;</mtext><mi>a</mi><mi>l</mi><mi>p</mi><mi>h</mi><mi>a</mi><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>y</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>x</mi></mrow></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="18.926ex" height="2.419ex" viewBox="0 -780.1 8148.6 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-74" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-67" x="361" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-61" x="1092" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-6C" x="1621" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-70" x="1920" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-68" x="2423" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-61" x="3000" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMAIN-3D" x="3807" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-66" x="5113" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-72" x="5664" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-61" x="6115" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-63" x="6645" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-79" x="7078" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/e-Legion/blog/326388/&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhSQaovfbV9PojltpjFMDMixykazw#MJMATHI-78" x="7576" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>t</mi><mi>g</mi><mtext>&nbsp;</mtext><mi>a</mi><mi>l</mi><mi>p</mi><mi>h</mi><mi>a</mi><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>y</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>x</mi></mrow></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-5"> tg \ alpha = \ frac {y} {x} </script></p><br><br>  Using this data, we can easily find the coordinates of the end of the ‚Äúnormalized‚Äù segment. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)endPointWithTargetPoint:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)targetPoint scrollView:(<span class="hljs-built_in"><span class="hljs-built_in">UIScrollView</span></span> *)scrollView { <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> point = [scrollView.panGestureRecognizer locationInView:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> tickOffset = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> angleWithOffset:targetPoint half:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> halfWithPoint:point]]; <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> rotationAngle = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.previousAngle + tickOffset; <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> delta = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> deltaWithAngle:rotationAngle]; <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> normalizedRotationAngle = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> normalizeAngle:rotationAngle]; <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> normalizedDelta = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> deltaWithAngle:normalizedRotationAngle]; <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> inclination = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> inclinationWithOffset:targetPoint startPoint:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.startPoint]; <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> sign = normalizedRotationAngle &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">CGPointMake</span></span>(targetPoint.x + sign * (normalizedDelta - delta) * cos(inclination), targetPoint.y + sign * (normalizedDelta - delta) * sin(inclination)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  Method for calculating the angle of our offset: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)inclinationWithOffset:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)offset startPoint:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)startPoint { <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> y = (offset.y - <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.startPoint.y); <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> x = (offset.x - <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.startPoint.x); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isnan(x) &amp;&amp; x != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> atan2(y, x); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  We use the function <a href="https://en.wikipedia.org/wiki/Atan2">atan2</a> , since  she correctly leads angles depending on the quarter. <br><br>  Is done.  Now we define the delegate method in which we perform the calculations: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)scrollViewWillEndDragging:(<span class="hljs-built_in"><span class="hljs-built_in">UIScrollView</span></span> *)scrollView withVelocity:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)velocity targetContentOffset:(<span class="hljs-keyword"><span class="hljs-keyword">inout</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> *)targetContentOffset { *targetContentOffset = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> endPointWithTargetPoint:*targetContentOffset scrollView:scrollView]; }</code> </pre> <br>  There are situations when the user scrolled so little that he did not reach the next or previous number.  Then the control should jump to the nearest one.  To do this, we implement the following delegate method: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)scrollViewDidEndDragging:(<span class="hljs-built_in"><span class="hljs-built_in">UIScrollView</span></span> *)scrollView willDecelerate:(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)decelerate { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!decelerate) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentAngle = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> normalizeAngle:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.previousAngle]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> rotateWithAngle:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentAngle]; } }</code> </pre> <br>  Result: <br><br><img src="https://habrastorage.org/files/afe/e83/9a0/afee839a03164dd3811a948bc399fb58.gif"><br><br><h4>  <b>Delegate methods</b> </h4><br>  We will create delegate methods for our coolizer so that class users can assign a controller to be its delegate and receive information from it.  But first we create a property that will return the value on the dial: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> value;</code> </pre><br>  We define a getter for it: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span>)value { <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> value = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentAngle &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? floorf(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentAngle / <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.angleStep) - <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.numberOfLabels : floorf(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentAngle / <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.angleStep); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> labs(value) % <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.numberOfLabels; }</code> </pre> <br>  Is done.  Now you can find out the current value on the dial. <br><br>  We are engaged in the delegate. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AYNCircleViewDelegate</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">&gt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">circleViewWillRotate</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AYNCircleView</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">circleView</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">circleView</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AYNCircleView</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">circleView</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">didRotateWithValue</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSUInteger</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  To start these two methods is enough.  We are more interested in the second method, in which we get the value of the spinner at the current moment. <br><br>  Create a delegate property on an <code>AYNCircleView</code> : <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;AYNCircleViewDelegate&gt; delegate;</code> </pre><br>  We define the places where these methods will be called. <br><br>  Since these methods are associated with rotation, we are interested in the method <code>- (void)rotateWithAngle:</code> <br><br>  How it looks with method calls: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)rotateWithAngle:(<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)angle { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delegate &amp;&amp; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delegate respondsToSelector:<span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(circleViewWillRotate:)]) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delegate circleViewWillRotate:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; } [<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> animateWithDuration:<span class="hljs-number"><span class="hljs-number">0.1</span></span> animations:^{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentView.transform = <span class="hljs-built_in"><span class="hljs-built_in">CGAffineTransformMakeRotation</span></span>(angle); } completion:^(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> finished) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delegate &amp;&amp; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delegate respondsToSelector:<span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(circleView:didRotateWithValue:)]) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delegate circleView:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> didRotateWithValue:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.value]; } }]; }</code> </pre> <br>  Is done.  Implement delegate methods in our <code>AYNViewController</code> . <br><br>  Do not forget to make yourself a delegate to this twist: <br><br><pre> <code class="objectivec hljs"> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.circleView.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>;</code> </pre><br>  Now we implement one of the methods.  First, in the <code>Interface Builder</code> <code>label</code> , which displays the value. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">IBOutlet</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span> *valueLabel;</code> </pre><br>  We proceed to the implementation. <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#pragma mark - Circle View Delegate - (void)circleView:(AYNCircleView *)circleView didRotateWithValue:(NSUInteger)value { self.valueLabel.text = [NSString stringWithFormat:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%ld"</span></span></span><span class="hljs-meta">, value]; }</span></span></code> </pre> <br>  The result is ready. <br><br><img src="https://habrastorage.org/files/604/632/269/6046322695ea4077b4d1725eaf2f2e81.gif"><br><br>  In such a simple way, I invented my custom control.  The whole project is available on the <a href="https://github.com/haron1020/CustomControl">gita</a> . </div><p>Source: <a href="https://habr.com/ru/post/326388/">https://habr.com/ru/post/326388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326376/index.html">Go digest Events, articles, interesting projects from the world of Go (March 30 - April 13, 2017)</a></li>
<li><a href="../326380/index.html">Vector models and Russian literature</a></li>
<li><a href="../326382/index.html">We forge letters from the largest Russian banks</a></li>
<li><a href="../326384/index.html">Static analysis ‚Üí vulnerability ‚Üí profit</a></li>
<li><a href="../326386/index.html">What can go wrong on a tour - and how does this relate to the search aggregator</a></li>
<li><a href="../326390/index.html">Why did it take 100 years to find the exact value of the Planck constant?</a></li>
<li><a href="../326392/index.html">VR development methodology</a></li>
<li><a href="../326394/index.html">Why use static types in javascript? (Advantages and disadvantages)</a></li>
<li><a href="../326396/index.html">Besides science: what else are our students interested in?</a></li>
<li><a href="../326398/index.html">How we build lean manufacturing (Lean) in our company</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>