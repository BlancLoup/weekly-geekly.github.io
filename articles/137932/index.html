<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Failure of the master in the PostgreSQL-cluster: how to be?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings. Today I would like to talk about such an unpleasant situation as the master's failure in the case of using native replication in PostgreSQL...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Failure of the master in the PostgreSQL-cluster: how to be?</h1><div class="post__text post__text-html js-mediator-article">  Greetings.  Today I would like to talk about such an unpleasant situation as the master's failure in the case of using native replication in PostgreSQL 9.x.  So, suppose you have a cluster of two or more PostgreSQL servers and a meteorite suddenly fell on the master.  It is logical to assume that you have to make one of the replicas master.  This can be done in two ways. <a name="habracut"></a><br><br><h4>  1. Application trigger file. </h4><br>  The <a href="http://wiki.postgresql.org/wiki/Streaming_Replication">manual for setting up replication</a> says that in recovery.conf, among other things, you can (and should) specify the parameter trigger_file.  Everything is simple here - as soon as you create the file specified in this parameter on the replica, PostgreSQL will interrupt the recovery process (in our case, replication) and open a new timeline. <br>  This means that after creating the trigger file, the position of the binary log counter will change, and not sequentially (say, from 000000010000000000000043 to 000000010000000000000044), but with an indication of a new era (by 0000000 <b>2</b> 00000000000043). <br><br>  The good news is that this method does not require a restart - everything will happen on the fly.  There will be no downtime (we do not take into account the time for changing configs on clients), all connections will be preserved - PostgreSQL will simply nail down the walreceiver process and give the record a go-ahead. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The bad news is that this method is good if you have only two servers - the master and one replica - because  if the cluster consists of 3 or more machines - it will not be possible to make this node a new master without remapping other replicas - when trying to tie another replica to a new master, PostgreSQL invariably says the following: <br><br> <code>FATAL: timeline 2 of the primary does not match recovery target timeline 1</code> <br> <br>  Any attempts to slip the replicas of the history file (which stores the transition point to the new timeline - this file is created every time after the recovery process is completed) also failed.  In general, the official <a href="http://archives.postgresql.org/pgsql-general/2011-06/msg00527.php">MailList</a> participants adhere to the same point of view - with this approach, other replicas will have to be modified (in the case of 9.0 - using pg_start_backup / pg_stop_backup and rsync, and in the case of 9.1 - using the pg_basebackup utility). <br><br><h4>  2. Uninstall recovery.conf </h4><br>  For some reason, the description of the second method in the manuals could not be found (perhaps it is there and I was not attentive enough - I will not argue).  I think you will agree that it is simple, logical and, apparently, reliable (at least - I did not manage to finally break something in the process of repeated experiments): <br><br>  1. From the entire cluster, you need to find the most recent replica.  This can be done from the console by doing something like: on each host: <br><br> <code># ps aux|grep postg|grep rec <br> postgres 143 0.0 13.2 8692004 6533448 ? Ss Feb06 3:58 postgres: startup process recovering 00000001000001E500000054 <br> postgres 2683 0.0 0.0 8699452 4044 ? Ss Feb09 0:33 postgres: wal receiver process streaming 1E5/542F9970 <br></code> <br><br>  If the meteorite has not yet fallen on your master, but you expect it from minute to minute - it is better to put out to the master node in advance so that the positions of the binary log will not change during your manipulations. <br><br>  2. On the selected replica, we change postgresql.conf so that the node can be a master (the parameters listed below are taken from the replication setup manual, in your case, the values, of course, may differ): <br> <code>wal_level = hot_standby <br> max_wal_senders = 5 <br> wal_keep_segments = 32 <br> archive_mode = on <br> archive_command = 'cp %p /path_to/archive/%f' <br></code> <br><br>  3. Rules pg_hba.conf: <br> <code>host replication postgres 192.168.100.3/32 trust</code> <br> <br>  4. Delete on new wizard recovery.conf <br>  5. Restart PostgreSQL on the new wizard. <br>  6. Rule recovery.conf on the other replicas (indicate the new wizard) and perform restarts. <br><br>  This simple way you can turn a replica into a master without losing the position of a binary log.  Of the obvious drawbacks, the entire cluster will have to be restarted (although if you have the opportunity to move the IP address from the old master to the new one, you will not need to restart the replicas). <br><br>  If for some reason you want to make a replica of a new master, the position of the bin-log, which is not the newest, you will first have to assign the newest replica of the master (it is desirable to close it from random connections for recording), synchronize it with the replica from which you want to do the wizard in the end and only after that do all the operations described above on it (that is, in fact, you will assign the wizard twice - first only for one replica, and then for all the others). <br><br>  In general, in the process of experiments, the only problem place that was managed to grope is a situation where some of the replicas have lagged behind so much that the new master does not have the XLOG files necessary for her.  I told you how to deal with this in my <a href="http://habrahabr.ru/blogs/postgresql/130704/">previous post</a> - I can only add that if you send binary logs to a backup server during archiving, this problem can hardly be called significant. </div><p>Source: <a href="https://habr.com/ru/post/137932/">https://habr.com/ru/post/137932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137927/index.html">How to make the site fly and save dozens of hours of system administration</a></li>
<li><a href="../137928/index.html">HomeLisp two years later</a></li>
<li><a href="../137929/index.html">The contents of The Pirate Bay fit in 90 megabytes</a></li>
<li><a href="../137930/index.html">Economic evaluation of the project (situational example to part number 1)</a></li>
<li><a href="../137931/index.html">Freezing Eclipse 3.7 for Mac</a></li>
<li><a href="../137933/index.html">Organize your audio library. Practical advice</a></li>
<li><a href="../137935/index.html">Cellular operators will notify subscribers about changes to the tariff plan via SMS</a></li>
<li><a href="../137936/index.html">For Nginx appeared commercial technical support</a></li>
<li><a href="../137937/index.html">Implementing Code Action with Roslyn</a></li>
<li><a href="../137938/index.html">Creating a reliable storage distributed to multiple servers on nfs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>