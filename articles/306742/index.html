<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Responsive Search for UITableView</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will share with you the approach to implementing a search in the DataSource UITableView when the user quickly types a query, when i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Responsive Search for UITableView</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/files/df0/e7c/a7c/df0e7ca7c32f4cdd8092b561569ba765.png"><br>  In this article, I will share with you the approach to implementing a search in the DataSource UITableView when the user quickly types a query, when it is necessary to dynamically form a search result based on the text entered in the search string, without waiting for the ‚ÄúFind‚Äù button. <br><a name="habracut"></a><br>  So, we have a table with UISearchBar to search.  In this example, the DataSource will be a SQLite database (but it can also be an external data source with API access, for example).  The database contains many records (several thousand), a search on it can take about 0.5 seconds. <br><br>  In order to dynamically form a search output as the user <i>enters a</i> query, you need to implement the method <i>- (void) searchBar: (UISearchBar *) searchBar textDidChange: (NSString *) searchText</i> delegate UISearchBar: <br><br><pre><code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)searchBar:(<span class="hljs-built_in"><span class="hljs-built_in">UISearchBar</span></span> *)searchBar textDidChange:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)searchText { __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> ProductPickerTableViewController *weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once_t</span></span> onceToken; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once</span></span>(&amp;onceToken, ^{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *label = <span class="hljs-string"><span class="hljs-string">"ru.example.unique.search"</span></span>; weakSelf.searchDispatchQueue = dispatch_queue_create(label, DISPATCH_QUEUE_SERIAL); }); <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.searchDispatchQueue, ^{ <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *searchProducts = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([searchText length]) { searchProducts = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.food productsBySearchPhrase:searchText]; } <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_main_queue(), ^{ weakSelf.searchProducts = searchProducts; [weakSelf.tableView reloadData]; }); }); }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We fill the DataSource of our controller not on the main thread, otherwise we will get a slowdown of the interface.  After the data is received, update the table view (always on the main thread). <br><br>  There is one drawback in this approach - each time the search string is changed, the database search method will be called up (or a network API request will be sent), which is completely optional when the user types the query fast enough or deletes it with the backspace key held down. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/mW1AF_mFW9w%3Ffeature%3Doembed&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjJ2GhYAnUW7ufYzrqEE0dExyEe_g" frameborder="0" allowfullscreen=""></iframe><br><br>  The first decision that occurred to me was to call the search methods (update DataSource) only if, for example, 0.1 seconds passes between character inputs.  In the githaba, a canceled block implementation was found: <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// // dispatch_cancelable_block.h // sebastienthiebaud.us // // Created by Sebastien Thiebaud on 4/9/14. // Copyright (c) 2014 Sebastien Thiebaud. All rights reserved. // typedef void(^dispatch_cancelable_block_t)(BOOL cancel); NS_INLINE dispatch_cancelable_block_t dispatch_after_delay(NSTimeInterval delay, dispatch_block_t block) { if (block == nil) { return nil; } // First we have to create a new dispatch_cancelable_block_t and we also need to copy the block given (if you want more explanations about the __block storage type, read this: https://developer.apple.com/library/ios/documentation/cocoa/conceptual/Blocks/Articles/bxVariables.html#//apple_ref/doc/uid/TP40007502-CH6-SW6 __block dispatch_cancelable_block_t cancelableBlock = nil; __block dispatch_block_t originalBlock = [block copy]; // This block will be executed in NOW() + delay dispatch_cancelable_block_t delayBlock = ^(BOOL cancel){ if (cancel == NO &amp;&amp; originalBlock) { originalBlock(); } // We don't want to hold any objects in the memory originalBlock = nil; }; cancelableBlock = [delayBlock copy]; dispatch_after(dispatch_time(DISPATCH_TIME_NOW, delay * NSEC_PER_SEC), dispatch_get_main_queue(), ^{ // We are now in the future (NOW() + delay). It means the block hasn't been canceled so we can execute it if (cancelableBlock) { cancelableBlock(NO); cancelableBlock = nil; } }); return cancelableBlock; } NS_INLINE void cancel_block(dispatch_cancelable_block_t block) { if (block == nil) { return; } block(YES); block = nil; }</span></span></code> </pre><br><br>  Using this implementation of the block to be canceled, you can rewrite the UISearchBar delegate method as follows: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)searchBar:(<span class="hljs-built_in"><span class="hljs-built_in">UISearchBar</span></span> *)searchBar textDidChange:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)searchText { __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> ProductPickerTableViewController *weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once_t</span></span> onceToken; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once</span></span>(&amp;onceToken, ^{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *label = <span class="hljs-string"><span class="hljs-string">"ru.example.unique.search"</span></span>; weakSelf.searchDispatchQueue = dispatch_queue_create(label, DISPATCH_QUEUE_SERIAL); }); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> searchDelay = <span class="hljs-number"><span class="hljs-number">0.1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.searchBlock != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//We cancel the currently scheduled block cancel_block(self.searchBlock); } self.searchBlock = dispatch_after_delay(searchDelay, ^{ //We "enqueue" this block with a certain delay. It will be canceled if the user types faster than the delay, otherwise it will be executed after the specified delay dispatch_async(self.searchDispatchQueue, ^{ NSArray *searchProducts = nil; if ([searchText length]) { searchProducts = [self.food productsBySearchPhrase:searchText]; } dispatch_async(dispatch_get_main_queue(), ^{ weakSelf.searchProducts = searchProducts; [weakSelf.tableView reloadData]; }); }); }); }</span></span></code> </pre><br><br>  The variable searchDelay corresponds to the time interval between entering (or deleting) two characters in the search string.  0.1 sec will be enough to not cause multiple search methods when deleting the search string with the backspace key, 0.2 ... 0.3 sec is enough to quickly enter a query. <br><br>  As a result, we get responsive in the user's opinion: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/9CfsOSnU47c%3Ffeature%3Doembed&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjAb0yy57m0vmBaIG0AqSzUBgL1HQ" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/306742/">https://habr.com/ru/post/306742/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306728/index.html">PostgreSQL. How to keep cats or the history of one migration</a></li>
<li><a href="../306732/index.html">Bottom navigation</a></li>
<li><a href="../306734/index.html">Migration to the cloud. Simple steps to improve business performance</a></li>
<li><a href="../306736/index.html">Graphic password does not allow the viewer to steal himself.</a></li>
<li><a href="../306738/index.html">AppCode 2016.2: new refactorings and inspections, live templates, improvements to code autocompletion, and all this is about Swift</a></li>
<li><a href="../306744/index.html">Personal ranking of deputies each using JavaScript and Chrome browser</a></li>
<li><a href="../306746/index.html">Basics of reactive programming for Android on a practical example</a></li>
<li><a href="../306748/index.html">Space error: $ 370 000 000 for Integer overflow</a></li>
<li><a href="../306754/index.html">Security Week 30: PHP-porn vulnerability, eavesdropping on keyboards, UAC bypass in Windows 10</a></li>
<li><a href="../306756/index.html">Review of physics in Sonic games. Parts 7 and 8: springs and gizmos, super speeds</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>