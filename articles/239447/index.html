<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We make a modular multichannel ADC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In various projects, it is often necessary to monitor a variety of parameters that are represented by analog values. Of course, the microcontroller is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We make a modular multichannel ADC</h1><div class="post__text post__text-html js-mediator-article">  In various projects, it is often necessary to monitor a variety of parameters that are represented by analog values.  Of course, the microcontroller is often enough, but sometimes the processing algorithm is too complicated for it and requires the use of a full-fledged computer.  In addition, it is much easier to organize the preservation of logs and beautiful visualization of data.  In this case, either a ready-made industrial solution is taken (which, of course, is expensive, but is often redundant), or something is self-made.  In the most banal case, this could be an Arduino board with an infinite loop from analogRead and serial.write.  If there is a lot of input data (more than analog inputs), then several boards will be needed, to figure out how to interrogate them correctly from a computer, etc. In many cases, the solution I developed will be suitable (perhaps I was not the first to come up with just such an implementation, I was not particularly interested this question), which will save time for debugging and make the relative simple and clear system architecture. <br><a name="habracut"></a><br><img src="https://habrastorage.org/files/584/c94/485/584c9448558f4851a09bb71c81f8ee42.jpg"><br><br>  To understand whether this solution is suitable for you, I propose to get acquainted with its characteristics: <br><br>  <b>Maximum number of channels:</b> 44; <br>  <b>Sample Rate:</b> 1000 Hertz; <br>  <b>Resolution:</b> 8 bits. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The characteristics are quite mediocre, but for many tasks they may be suitable.  This is not an oscilloscope, but a sensor polling system.  In addition, using her example, you can get acquainted with the use of USART not quite as intended. <br><br>  The system consists of separate ADC modules based on ATMEGA8 microcontroller (you can use another AVR family with ADC and USART hardware module, if you change the firmware a little).  There can be one or several modules, each provides 6 or 8 ADCs, depending on the microcontroller case (the output version has 6 ADCs, and for surface mounting 8), only the total number of channels should not exceed 44. The main feature is that regardless of the number of modules requires only one USART from the side of the computer (this can be a USB adapter or a hardware COM port).  This is achieved by the fact that the USARTs of all microcontrollers are connected in series (RX one to the TX of the other), and the RX and TX pins of the outermost ones in the chain are already connected to the computer. <br><br>  Here it should be noted that the bit width of my ADC is not quite 8 bits - only 255 gradations are possible instead of 256. The value 0xFF is reserved for a particular purpose.  If the microcontroller receives it, then it starts issuing each time the value from the next channel of its ADC, and when they end, retransmit 0xFF further along the chain.  If the USART input has a value other than 0xFF, then the microcircuit simply sends the byte further.  Thus, by transferring one arbitrary value and 44 0xFF, you can get values ‚Äã‚Äãfrom all channels of all ADCs (if the ADC is smaller, then the extra channels will be equal to 0xFF).  An arbitrary value is needed so that all modules reset the pointer to the current ADC channel, which must be transmitted when receiving 0xFF.  In reality, it is more convenient to transmit 45 0xFF, in order to reliably determine the end of the reception (if you received 0xFF, then the channels have ended). <br><br>  The schematic diagram contains not a lot of details: <br><img src="https://habrastorage.org/files/544/66e/e8a/54466ee8a4ef4e3fa5c1a279d8a912c4.png"><br><br>  The program for AVR looks extremely simple and takes slightly less than 300 bytes of memory: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/io.h&gt; #include &lt;avr/interrupt.h&gt; #include &lt;avr/wdt.h&gt; #include &lt;util/delay.h&gt; // Firmware options #define USART_BAUDRATE 460800 #define LED_PIN 1 #define ADC_COUNT 6 #define STARTUP_DELAY 1000 // Calculated UBRR value #define UBRR (F_CPU / (16 * (uint32_t)USART_BAUDRATE) - 1) // Global variables uint8_t adc[ADC_COUNT]; // Buffer uint8_t cur_in_adc; // Input byte index uint8_t cur_out_adc; // Output byte index // USART interrupt handler ISR(USART_RXC_vect) { // Read data from USART uint8_t buffer = UDR; if (buffer == 0xFF) { if (cur_out_adc &lt; ADC_COUNT) { // Return data byte from buffer UDR = adc[cur_out_adc]; cur_out_adc++; // Activate led PORTB |= _BV(LED_PIN); } else { // Chain 0xFF UDR = 0xFF; // Deactivate led PORTB &amp;= ~_BV(LED_PIN); } } else { // Chain data byte UDR = buffer; // Reset byte counter cur_out_adc = 0; // Deactivate led PORTB &amp;= ~_BV(LED_PIN); } } // Main function void main() { // Setup watchdog timer wdt_enable(WDTO_15MS); // Setup pin for led DDRB |= _BV(LED_PIN); // Blink led PORTB |= _BV(LED_PIN); for (uint8_t i = 0; i &lt; STARTUP_DELAY / 5; i++) { _delay_ms(5); wdt_reset(); } PORTB &amp;= ~_BV(LED_PIN); // Setup ADC ADMUX = _BV(REFS1) | _BV(REFS0) | _BV(ADLAR); ADCSRA = _BV(ADEN) | _BV(ADPS2) | _BV(ADPS1) | _BV(ADPS0); // Setup USART UBRRL = UBRR &amp; 0xFF; UBRRH = UBRR &gt;&gt; 8; UCSRA = 0; UCSRB = _BV(RXCIE) | _BV(RXEN) | _BV(TXEN); UCSRC = _BV(URSEL) | _BV(UCSZ1) | _BV(UCSZ0); // Enable interrupts sei(); // Main loop while (1) { // Reset watchdog timer wdt_reset(); // Select ADC channel ADMUX = _BV(REFS1) | _BV(REFS0) | _BV(ADLAR) | cur_in_adc; // Start conversion and wait until it performed ADCSRA |= _BV(ADIF) | _BV(ADSC); while (ADCSRA &amp; _BV(ADSC)); // Put value from ADC to buffer uint8_t value = ADCH; adc[cur_in_adc] = (value != 0xFF) ? value : 0xFE; // Switch to next channel cur_in_adc++; if (cur_in_adc &gt;= ADC_COUNT) { cur_in_adc = 0; } } }</span></span></span></span></code> </pre> <br><br>  In the <a href="https://github.com/KivApple/avr-adc">repository on GitHub,</a> you can find the KiCad schematic and printed circuit board files, as well as a sample program for a computer that reads data from this system and outputs them in CSV format. <br><br>  Conveniently, the serial port is used almost at the limit of its capabilities, so it doesn‚Äôt need to take care of data synchronization (I just send 1000 commands to read the ADC every second) - if we transfer 46 kilobytes of data every second at 460800 bits per second, then we can to be completely sure that blocks of 46 bytes of data (one measurement) will arrive every millisecond (although buffering by the OS kernel and USB adapter will, of course, delay, but measurements will always be made with the desired frequency). <br><br>  Printed circuit board was designed in KiCad: <br><br><img src="https://habrastorage.org/files/c7d/916/409/c7d916409e4f446b875fed69b4619e3a.png"><br><br>  All boards are connected in a chain, the last RX and TX boards are connected by a jumper. <br>  The quality of the ADC can be estimated from this image of a saw at 10 Hz: <br><br><img src="https://habrastorage.org/files/c69/d24/20a/c69d2420a39c40138839f8a6417db5a0.png"><br><br>  For comparison, the image from the DS203 oscilloscope (it also acts as a generator): <br><br><img src="https://habrastorage.org/files/b70/18f/d4f/b7018fd4f2a448e4b4bf78e2e4045394.png"><br><br>  Unfortunately, I do not have a better signal source, but my system should be suitable for low-frequency signals. <br><br>  It should be noted that not every USART-USB converter provides a speed of 460800 bps when the channel is fully loaded.  The converter based on CP2102 made me look for a long time error in my own code, until I tried the FT232.  A loss of about 0.17% of data is also observed (measures are taken in the computer program so that data synchronization is not lost).  Most likely this is caused by a bad USART line, or a flaw in the program.  In general, for 90% of applications it should not be critical, but you probably should not bet on nuclear power plants. <br><br>  And finally, I will say that the cost of one module is about 50-60 rubles, if you order all parts from China, so the solution should be quite attractive. </div><p>Source: <a href="https://habr.com/ru/post/239447/">https://habr.com/ru/post/239447/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../239433/index.html">Apache Cordova adds support for Windows 8.1 and Windows Phone 8.1</a></li>
<li><a href="../239435/index.html">Dangerous finally or waiting 5.6</a></li>
<li><a href="../239439/index.html">How an IT freelancer to become an entrepreneur. Part 2</a></li>
<li><a href="../239441/index.html">Mobile version of the site or responsive design?</a></li>
<li><a href="../239443/index.html">We receive information about the program and load it via CMD (man and apt-get for Windows?)</a></li>
<li><a href="../239449/index.html">Google Hangouts Guide for Debian / Ubuntu Linux (as well as Mac OS X and Windows)</a></li>
<li><a href="../239451/index.html">Phantom smartphone vibrations</a></li>
<li><a href="../239453/index.html">How to set the order of visiting new pages by a search robot based on the prediction of the popularity of a web page (Part II)</a></li>
<li><a href="../239455/index.html">Indexisto - a new generation mobile browser-reader</a></li>
<li><a href="../239459/index.html">Let's change unnecessary books.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>