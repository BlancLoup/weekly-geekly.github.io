<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Template magic, IsValidExpression metafunction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear Habrasoobschestvo. 

 Today I want to share one interesting trick that allows you to determine the compilability of any particular expr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Template magic, IsValidExpression metafunction</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear Habrasoobschestvo. <br><br>  Today I want to share one interesting trick that allows you to determine the compilability of any particular expression. <br><br>  Example: <br><blockquote>  <font color="#ff0000">/ * We define the HasF metafunction, which allows us to determine the presence of the f () function in any class.</font>  <font color="#ff0000">* /</font> <br>  DECLARE_IS_VALID_EXPRESSION <font color="#008000">(</font> <br>  HasF, <br>  <font color="#008000">(</font> <font color="#008000">(</font> U <font color="#000040">*</font> <font color="#008000">)</font> <font color="#0000ff">NULL</font> <font color="#008000">)</font> <font color="#000040">-</font> <font color="#000080">&gt;</font> f <font color="#008000">(</font> <font color="#008000">)</font> <font color="#ff0000">/ * This expression is compiled only if U :: f () * /</font> <font color="#008000">) is</font> <font color="#ff0000">present</font> <font color="#008080">;</font> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <font color="#0000ff">struct</font> Foo <font color="#008000">{</font> <font color="#0000ff">void</font> f <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#008000">}</font> <font color="#008080">;</font> <br>  <font color="#0000ff">struct</font> Bar <font color="#008000">{</font> <font color="#008000">}</font> <font color="#008080">;</font> <br><br>  BOOST_STATIC_ASSERT <font color="#008000">(</font> HasF &lt;A&gt; <font color="#008080">::</font> <font color="#007788">value</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#ff0000">/ * The HasF &lt;A&gt; :: value constant will be true * /</font> <br>  BOOST_STATIC_ASSERT <font color="#008000">(</font> <font color="#000040">!</font> HasF <font color="#000080">&lt;</font> B <font color="#000080">&gt;</font> <font color="#008080">::</font> <font color="#007788">value</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#ff0000">/ * Here the HasF constant &lt;A&gt; :: value will be false * /</font> </blockquote><br>  As you probably already guessed, we will think how to write the macro DECLARE_IS_VALID_EXPRESSION. <br><a name="habracut"></a><br>  So, our goal is to learn how to determine whether an expression will compile or not.  At the same time, the compiler, naturally, should not produce any errors: a constant should simply be generated, with a value of 0 if the expression is not compiled, and a value of 1 otherwise. <br><br><h4>  Release </h4><br>  For this we will use the principle of SFINAE (substitution failure is not an error).  In human language, this means that if the compiler encounters an ‚Äúerror‚Äù inside the template definition (not in the template body, but in the definition, that is, in those places where the compiler tries to ‚Äúmatch‚Äù the template parameters that are adequate to the code), then this ‚Äúerror "Does not lead to a compilation error, but to the termination of an attempt to instantiate a template function (or class) with those parameters that cause an" error ". <br><br>  This is how the following code works: <br><blockquote>  $ define DECLARE_IS_VALID_EXPRESSION <font color="#008000">(</font> NAME, U_BASED_RUNTIME_EXPRESSION <font color="#008000">)</font> \ <br>  <font color="#0000ff">template</font> <font color="#000080">&lt;</font> <font color="#0000ff">class</font> T <font color="#000080">&gt;</font> \ <br>  <font color="#0000ff">struct</font> NAME \ <br>  <font color="#008000">{</font> \ <br>  <font color="#ff0000">/ * We need some type that is not exactly T for comparison * /</font> \ <br>  <font color="#0000ff">struct</font> CDummy <font color="#008000">{</font> <font color="#008000">}</font> <font color="#008080">;</font>  \ <br>  \ <br>  <font color="#ff0000">/ * This overload will work only when U_BASED_RUNTIME_EXPRESSION does not contain "errors" \</font> <font color="#ff0000"><br></font>  <font color="#ff0000">** Otherwise, this overload will be ignored according to SFINAE.</font>  <font color="#ff0000">* /</font> \ <br>  <font color="#0000ff">template</font> <font color="#000080">&lt;</font> <font color="#0000ff">typename</font> U <font color="#000080">&gt;</font> \ <br>  <font color="#0000ff">static</font> decltype <font color="#008000">(</font> U_BASED_RUNTIME_EXPRESSION <font color="#008000">)</font> F <font color="#008000">(</font> <font color="#0000ff">void</font> <font color="#000040">*</font> <font color="#008000">)</font> <font color="#008080">;</font>  \ <br>  \ <br>  <font color="#ff0000">/ * But this overload is always present, but its priority is lower, because the ellipsis * /</font> \ <br>  <font color="#0000ff">template</font> <font color="#000080">&lt;</font> <font color="#0000ff">typename</font> U <font color="#000080">&gt;</font> \ <br>  <font color="#0000ff">static</font> CDummy F <font color="#008000">(</font> ... <font color="#008000">)</font> <font color="#008080">;</font>  \ <br>  \ <br>  <font color="#ff0000">/ * This typedef might not have been, but without it, this class does not work correctly :( \</font> <font color="#ff0000"><br></font>  <font color="#ff0000">** (I take this opportunity to say hello to testers from the Visual Studio command) * /</font> \ <br>  <font color="#0000ff">typedef</font> decltype <font color="#008000">(</font> F <font color="#000080">&lt;</font> T <font color="#000080">&gt;</font> <font color="#008000">(</font> nullptr <font color="#008000">)</font> <font color="#008000">)</font> \ <br>  TDummy <font color="#008080">;</font>  \ <br>  \ <br>  <font color="#0000ff">enum</font> \ <br>  <font color="#008000">{</font> \ <br>  <font color="#ff0000">/ * value will be 1 if U_BASED_RUNTIME_EXPRESSION does not contain "errors" and 0 otherwise \</font> <font color="#ff0000"><br></font>  <font color="#ff0000">** Why?</font>  <font color="#ff0000">\</font> <font color="#ff0000"><br></font>  <font color="#ff0000">** If there are no "errors", then both versions of F are present, and F &lt;T&gt; (nullptr) selects one, \</font> <font color="#ff0000"><br></font>  <font color="#ff0000">** in which there is no ellipsis, i.e.</font>  <font color="#ff0000">with our test expression, and its return type</font> <font color="#ff0000"><br></font>  <font color="#ff0000">** not CDummy, because</font>  <font color="#ff0000">CDummy is declared locally.</font>  <font color="#ff0000">\</font> <font color="#ff0000"><br></font>  <font color="#ff0000">** If there are "errors", then option F with the tested expression will be thrown out, and, \</font> <font color="#ff0000"><br></font>  <font color="#ff0000">** respectively, F &lt;T&gt; (nullptr) will select the second overload (which returns CDummy) * /</font> \ <br>  value <font color="#000080">=</font> <font color="#000040">!</font>  boost <font color="#008080">::</font> <font color="#007788">is_same</font> <font color="#000080">&lt;</font> CDummy, TDummy <font color="#000080">&gt;</font> <font color="#008080">::</font> <font color="#007788">value</font> \ <br>  <font color="#008000">}</font> <font color="#008080">;</font>  \ <br>  <font color="#008000">}</font> <font color="#008080">;</font> </blockquote><br>  This implementation, unfortunately, requires C ++ 0x (my compiler is VC10).  It is theoretically possible to do without a new standard (the idea is the same, but instead of decltype sizeof is used).  But!  Here again I want to say hello to testers from Microsoft, because  sizeof does not work correctly in the template definition area - it is ‚Äúnot expected‚Äù there (if I remember correctly).  In gcc, the sizeof solution works fine. <br><br><h4>  Application </h4><br>  An example of application is, for example, the following code: <br><blockquote>  <font color="#ff0000">/ * Specifies the IsStreamSerializationSupported metafunction, which returns</font> <font color="#ff0000"><br></font>  <font color="#ff0000">** true if the argument supports input / output through threads * /</font> <br>  DECLARE_IS_VALID_EXPRESSION <font color="#008000">(</font> <br>  IsStreamSerializationSupported, <br>  <font color="#008000">(</font> <font color="#008000">(</font> std <font color="#008080">::</font> <font color="#0000dd">cout</font> <font color="#000080">&lt;&lt;</font> <font color="#000040">*</font> <font color="#008000">(</font> U <font color="#000040">*</font> <font color="#008000">)</font> <font color="#0000ff">NULL</font> <font color="#008000">)</font> , <font color="#008000">(</font> std <font color="#008080">::</font> <font color="#0000dd">cin</font> <font color="#000080">&gt;&gt;</font> <font color="#000040">*</font> <font color="#008000">(</font> U <font color="#000040">*</font> <font color="#008000">)</font> <font color="#0000ff">NULL</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#ff0000">/ * double supports I / O through out-of-box * /</font> <br>  BOOST_STATIC_ASSERT <font color="#008000">(</font> IsStreamSerializationSupported <font color="#000080">&lt;</font> <font color="#0000ff">double</font> <font color="#000080">&gt;</font> <font color="#008080">::</font> <font color="#007788">value</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">struct</font> Foo <font color="#008000">{</font> <font color="#008000">}</font> <font color="#008080">;</font> <br><br>  <font color="#ff0000">/ * But Foo I / O through streams does not support :( * /</font> <br>  BOOST_STATIC_ASSERT <font color="#008000">(</font> <font color="#000040">!</font> IsStreamSerializationSupported <font color="#000080">&lt;</font> Foo <font color="#000080">&gt;</font> <font color="#008080">::</font> <font color="#007788">value</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">struct</font> Bar <font color="#008000">{</font> <font color="#008000">}</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">template</font> <font color="#000080">&lt;</font> <font color="#0000ff">class</font> TChar, <font color="#0000ff">class</font> Traits <font color="#000080">&gt;</font> <br>  std <font color="#008080">::</font> <font color="#007788">basic_ostream</font> <font color="#000080">&lt;</font> TChar, Traits <font color="#000080">&gt;</font> <font color="#000040">&amp;</font> operator <font color="#000080">&lt;&lt;</font> <font color="#008000">(</font> <br>  std <font color="#008080">::</font> <font color="#007788">basic_ostream</font> <font color="#000080">&lt;</font> TChar, Traits <font color="#000080">&gt;</font> <font color="#000040">&amp;</font> , <font color="#0000ff">const</font> Bar <font color="#000040">&amp;</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">template</font> <font color="#000080">&lt;</font> <font color="#0000ff">class</font> TChar, <font color="#0000ff">class</font> Traits <font color="#000080">&gt;</font> <br>  std <font color="#008080">::</font> <font color="#007788">basic_istream</font> <font color="#000080">&lt;</font> TChar, Traits <font color="#000080">&gt;</font> <font color="#000040">&amp;</font> operator <font color="#000080">&gt;&gt;</font> <font color="#008000">(</font> <br>  std <font color="#008080">::</font> <font color="#007788">basic_istream</font> <font color="#000080">&lt;</font> TChar, Traits <font color="#000080">&gt;</font> <font color="#000040">&amp;</font> , Bar <font color="#000040">&amp;</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#ff0000">/ * Bar supports in / out through streams, since</font>  <font color="#ff0000">The corresponding operators are defined.</font>  <font color="#ff0000">* /</font> <br>  BOOST_STATIC_ASSERT <font color="#008000">(</font> IsStreamSerializationSupported <font color="#000080">&lt;</font> Bar <font color="#000080">&gt;</font> <font color="#008080">::</font> <font color="#007788">value</font> <font color="#008000">)</font> <font color="#008080">;</font> </blockquote><br>  Such pieces help in verifying the compliance of the type transferred to a template with different concepts (in this case, to meet the concept, the type must support input / output through the streams). <br><br>  For this, I say goodbye, thank you all for your attention!  :) </div><p>Source: <a href="https://habr.com/ru/post/112239/">https://habr.com/ru/post/112239/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112232/index.html">Americans bought 15% of Kaspersky Lab shares</a></li>
<li><a href="../112233/index.html">If I lived in another country ...</a></li>
<li><a href="../112235/index.html">"Planet Pile of Iron" # 3: Assorted Iron</a></li>
<li><a href="../112236/index.html">Preparing for the Big Mobile Revolution</a></li>
<li><a href="../112237/index.html">Hole on free-lance.ru</a></li>
<li><a href="../112240/index.html">New YouTube homepage launched for all users</a></li>
<li><a href="../112241/index.html">Larry Page will become Google CEO</a></li>
<li><a href="../112242/index.html">Mozilla Skywriter (Bespin) joins Cloud9 IDE</a></li>
<li><a href="../112243/index.html">The President believes that Russia needs a national search engine because</a></li>
<li><a href="../112244/index.html">Android-smartphone turned into a fake USB-keyboard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>