<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Own temporary mail: telegram bot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often, with new tools and capabilities, there is a desire to experiment and realize something not quite ordinary, which I have never done before. The ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Own temporary mail: telegram bot</h1><div class="post__text post__text-html js-mediator-article">  Often, with new tools and capabilities, there is a desire to experiment and realize something not quite ordinary, which I have never done before.  The idea to create your temporary mail service in the form of telegrams bot seemed to me quite interesting. <a name="habracut"></a><br><br><div class="spoiler">  <b class="spoiler_title">A little background</b> <div class="spoiler_text">  Not so long ago, I moved from a regular hosting to a VPS and it so happened that a month later or a little more I had to move to another VPS again.  In both cases, I had the cheapest pricing plan and Ubuntu 16.04.  Since the last time at that time I came across a terminal at the university, which was tantamount to a complete lack of experience, I used excellent step-by-step instructions from DigitalOcean to configure my VPS (some of them were translated into Russian for those who, like me, are not enough knows english).  And yes, my first VPS was at DO, and I had to move again, mainly because some of its IP addresses fell under the distribution of the RKN.  Having repeated the LAMP setup procedure a couple of times, I was a little used to the VPS terminal and, as part of its further development, I decided to switch to unusual experiments - to create my own temporary mail service, for example. <br></div></div><br>  I already had experience in the backend, in particular in creating telegram bots in PHP MySQL, but receiving email ‚Äúby myself‚Äù seemed distant and incomprehensible.  Having opened several tabs with various articles on the topic, I realized that I did not understand anything.  Everywhere it was proposed to use a ton of various tools, which in my opinion was more suitable for a full-fledged mail service than for the task of receiving incoming email messages on a VPS. <br><br><h3>  Receive incoming mail </h3><br>  For the first step, the sandbox article helped me a lot: <a href="https://habr.com/ru/post/260429/">habr.com/ru/en/post/260429</a> .  I drew attention to her negative rating, but it described exactly what interested me.  I wanted to get a result as soon as possible that can be ‚Äúfelt‚Äù, and with the thoughts ‚ÄúI will do it in the future‚Äù, I went to set up sendmail. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then I set up the domain.  DNS records: <br><br> <code>example.com IN MX 5 mail.example.com</code> <br>  <code>mail.example.com IN A XXX.XX.XXX.XXX</code> (ip address of the VPS) <br><br>  On the server, in the <code>/etc/mail/virtusertable</code> added the line <code>@example.com vasya</code> , thereby determining that all mail destined for any addresses on ****@example.com is addressed to user Vasya. <br><br>  To process incoming mail with a php script, I added the line <code>vasya: "|php -q /home/vasya/mail.php"</code> <code>/etc/aliases</code> file <code>vasya: "|php -q /home/vasya/mail.php"</code> . <br><br>  After conducting several tests and making sure that incoming mail is sent to the php script, I could do it by processing. <br><br>  Receiving a raw incoming mail sent in php using the method described above is implemented in the code very simply: <br><br><pre> <code class="php hljs">$msg = file_get_contents(<span class="hljs-string"><span class="hljs-string">"php://stdin"</span></span>);</code> </pre> <br>  It is quite another thing to parse the mail format and present the data in a clear and accessible way.  Google offered me several options on how to parse the mail format using PHP.  All the libraries I found were installing additional components, but one of them seemed to me less cumbersome: <a href="https://github.com/zbateson/mail-mime-parser">github.com/zbateson/mail-mime-parser</a> .  The only thing I needed to install additionally is the popular PHP package manager, Composer.  Of course, I didn‚Äôt come across it on a regular hosting, but its installation and further connection of the library for parsing mail was not any difficult. <br><br>  The beginning of the php script for processing incoming mail using the zbateson / mail-mime-parser library looks like this: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">"vendor/autoload.php"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ZBateson</span></span>\<span class="hljs-title"><span class="hljs-title">MailMimeParser</span></span>\<span class="hljs-title"><span class="hljs-title">MailMimeParser</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ZBateson</span></span>\<span class="hljs-title"><span class="hljs-title">MailMimeParser</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>; $msg = file_get_contents(<span class="hljs-string"><span class="hljs-string">"php://stdin"</span></span>); $parser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MailMimeParser(); $message = Message::from($msg);</code> </pre><br>  Since the temporary mail in my opinion does not involve several recipients, it is enough to take only the first of the possible: <br><br><pre> <code class="php hljs">$to = $message-&gt;getHeader(<span class="hljs-string"><span class="hljs-string">'To'</span></span>); $email = $to-&gt;getAddresses()[<span class="hljs-number"><span class="hljs-number">0</span></span>]-&gt;getEmail();</code> </pre><br>  In the variable $ email we have the address of the recipient of the form vasyaorpetya@example.com. <br><br>  For receiving the content of incoming letters in the library there are corresponding methods: <br><br><pre> <code class="php hljs">$from = $message-&gt;getHeader(<span class="hljs-string"><span class="hljs-string">'From'</span></span>)-&gt;getEmail(); $subject = $message-&gt;getHeaderValue(<span class="hljs-string"><span class="hljs-string">'Subject'</span></span>); $msg_text = $message-&gt;getTextContent(); $msg_html = $message-&gt;getHtmlContent();</code> </pre> <br><h3>  Telegram bot </h3><br>  What should be able to telegram bot temporary mail in the first place? <br><br><ol><li>  Issue a new temporary email address upon request </li><li>  Send in a chat incoming email for this email, while the mailing address is valid </li><li>  Renew email addresses </li></ol><br>  Quite suitable in this and many other cases, the method of receiving updates from the Telegram is the use of Webhook.  All you need is the address of the script with https.  Using Certbot to configure an ssl domain certificate is described in detail in the DO instructions. <br><br>  To interact with the Telegram Bot API, I use my own work.  Someone prefers to use popular libraries.  Sending messages with buttons in telegrams has long become a familiar affair, as many articles have been written about. <br><br>  The generation of temporary email addresses is essentially the issue of the next address in order.  I created a table for email addresses in the database, where the int type id with auto increment uniquely identifies the recipient.  The transformation of a numeric id into a string address is carried out as a translation of a number into another number system, where the entire Latin alphabet is available as a ‚Äúnumber‚Äù.  26 letters in comparison with numbers give a good reduction in the length of the identifier.  Probably, I could also use large letters, numbers and some characters without problems to further reduce the length of the addresses given, but I left only small Latin letters. <br><br>  Functions for converting a numeric id to a string and back: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// $alphabet = explode(",", "a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z"); //   @grayfolk: $alphabet = range('a', 'z'); function num2str($n, $a) { // $a -  $b = count($a); $r = 0; $x = ""; while ($n) { $r = $n%$b; $n = ($n-$r)/$b; $x .= $a[$r]; } return strrev($x); } function str2num($s, $a) { $n = 0; $b = count($a); $s = strrev($s); for ($i = 0; $i &lt; strlen($s); $i++) { $n += array_search($s[$i], $a) * pow($b, $i); } return $n; }</span></span></code> </pre><br>  One of the key benefits of using a temporary email service is the lack of spam.  But if the addresses are in order, you can make a list of the nearest addresses that will be issued and successfully do the mailing.  To solve this problem, I added some random string to the recipient ID.  To distinguish between id and random component in the address, I decided to always start the random component with a digit. <br><br>  We write a random string of the e-mail address to the database along with the recipient's id, the user id in the telegraph and the time of the mailbox issuance. <br><br>  It would seem, you can not even store incoming mail - sent to telegrams and that's it.  But what about html letters?  They can not be displayed in the message in the chat.  It remains to record the incoming html messages in the database and show them on the site, and the user to send a link that includes the message id and the next generated password.  To clean the database with crown on schedule, a php script is launched that deletes incoming html messages that were received more than an hour ago. <br><br>  Later in the bot telegram, I added buttons that prolong the mailbox for 10 or 60 minutes, as well as a button that lets you know how much, nevertheless, it remains for him to live before receiving incoming messages is stopped. <br><br>  Since we are dealing with registered users in the telegraph, you can provide an opportunity to activate your old mailboxes, for example, in order to recover a forgotten password on a website or for any other operations that require confirmation using email.  A given mailbox "accepts" incoming messages only when it is necessary for the user; all the rest of the time, possible spam is ignored. <br><br><img src="https://habrastorage.org/webt/wg/lo/bj/wglobjdwkrbucatdge9zirxftxg.png"><br><br>  Wish for the future: <br><br><ul><li>  Create web version [done] </li><li>  Set up a quick change of mail domain in a couple of clicks / commands (how?) </li></ul><br><h3>  Links </h3><br>  Telegram bot: @tmpmailbot <br><br>  <a href="https://habr.com/ru/post/260429/">An article describing the sendmail configuration</a> <br><br>  <a href="https://github.com/zbateson/mail-mime-parser">PHP library for parsing email</a> </div><p>Source: <a href="https://habr.com/ru/post/445988/">https://habr.com/ru/post/445988/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445976/index.html">PhpStorm 2019.1: Debugging Twig and Blade templates, searching for dead code, improved autocompletion, and more</a></li>
<li><a href="../445978/index.html">We cross with the hedgehog: OpenJDK-11 + GraalVM</a></li>
<li><a href="../445980/index.html">We program voice control of a kopter with use of Node.js and ARDrone</a></li>
<li><a href="../445984/index.html">Pacsafe, thunderstorm pickpockets</a></li>
<li><a href="../445986/index.html">Customer Development as a life philosophy</a></li>
<li><a href="../445992/index.html">Nauchpop on minimum salary: optical illusions</a></li>
<li><a href="../445998/index.html">How to make friends Progress OpenEdge and Oracle DBMS</a></li>
<li><a href="../446000/index.html">What is wrong with Yandex.Music? UX / UI parsing</a></li>
<li><a href="../446006/index.html">Intel - we sound in a new way</a></li>
<li><a href="../446022/index.html">How I did NOT scan the Belarusian Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>