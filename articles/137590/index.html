<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to protect against unexpected commenting by Ctrl + Enter?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(The experience of successful struggle with windmills.) 

 With enviable regularity in the comments, there are ragged messages in the mid-sentence wit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to protect against unexpected commenting by Ctrl + Enter?</h1><div class="post__text post__text-html js-mediator-article">  <i>(The experience of successful struggle with windmills.)</i> <br><br>  With enviable regularity in the comments, there are ragged messages in the mid-sentence with postscript that ‚ÄúI am sorry, I <a href="http://www.google.ru/search%3Fq%3D%2522%25D1%2581%25D0%25B0%25D0%25BC%25D0%25BE%2520%25D0%25BE%25D1%2582%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25B8%25D0%25BB%25D0%25BE%25D1%2581%25D1%258C%2522%2Bsite%253Ahabrahabr.ru">myself went</a> ,‚Äù ‚Äú <a href="http://yandex.ru/yandsearch%3Ftext%3D%2522%25D1%2581%25D0%25BE%25D1%2580%25D0%25B2%25D0%25B0%25D0%25BB%25D0%25BE%25D1%2581%25D1%258C%2522%2Bsite%253Ahabrahabr.ru%26lr%3D213">broke,</a> ‚Äù and a continuation of the thought.  Sometimes they say that they have unraveled the reason for this site behavior.  Therefore, I want to inform you that I am not alone in my guess, and moreover, about six months ago I solved this problem with the help of user scripts.  Since then, the false submissions have stopped for me, but I could not be sure that the only reason for the false submissions was this, so the experience of using the script and the guesses of other users had to confirm this. <br><a name="habracut"></a><br>  And so, I noticed a note that someone else also sees the reason for the false sending in this: <br>  <a href="http://habrahabr.ru/blogs/client_side_optimization/137318/">habrahabr.ru/blogs/client_side_optimization/137318/#comment_4572800</a> (Jan 31, 2012) <br>  A Google search showed that the reason was solved before: <a href="http://habrahabr.ru/qa/9515/">habrahabr.ru/qa/9515/#answer_40702</a> (July 15, 2011) <br>  <a href="http://habrahabr.ru/qa/8447/">habrahabr.ru/qa/8447/#answer_35939</a> (June 12, 2011) <br>  <a href="http://habrahabr.ru/company/regru/blog/105763/">habrahabr.ru/company/regru/blog/105763/#comment_3318569</a> (Oct 8, 2010) <br>  <a href="http://habrahabr.ru/blogs/bsdelniki/118485/">habrahabr.ru/blogs/bsdelniki/118485/#comment_3863623</a> (May 1, 2011) <br>  <a href="http://habrahabr.ru/blogs/google/118622/">habrahabr.ru/blogs/google/118622/#comment_3873012</a> (May 9, 2011), etc., can be continued for a long time, these links are from the first 30 search results (the Sphinx search on the site is no good, it does not search for an exact phrase Google and Yandex search is built into the same script. It should be noted that search by search engine is incomplete, it does not show all cases guaranteed, and there will not be any time (hours, days, weeks) for new messages). <br><br>  The solution through technical support of the site has already shown its inefficiency.  For example, the script of the script for displaying the source code of programs when the &lt;BR&gt; tag appears is not fixed for more than six months.  In addition, the creators of the script may have the opposite opinion about the "usefulness" of this function.  Therefore, disabling auto sending with Ctrl + Enter is much faster to implement on your own (some worries, but immediately, reliably (until the scripts change on the site) and controlled). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Until October 2011, user scripts worked successfully: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> win = (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> unsafeWindow !=<span class="hljs-string"><span class="hljs-string">'undefined'</span></span>)? unsafeWindow: <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(win.commentForm) win.commentForm.sendOnEnter = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{};</code> </pre>  (except Chrome browser) <br><br>  Since that time, the scripts on the site have been updated, and it can be seen (experiments can be safely conducted in the browser mode ‚Äúoffline‚Äù), that other sections of the code are responsible for sending, here they are: <br><br>  (view.js file - for QA section) <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> answer_form = $(<span class="hljs-string"><span class="hljs-string">'#add_answer_form'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> answer_text = $(<span class="hljs-string"><span class="hljs-string">'#answer_text'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * CTRL + ENTER */</span></span> answer_text.keydown(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( (e.ctrlKey || e.metaKey ) &amp;&amp; e.keyCode == <span class="hljs-number"><span class="hljs-number">13</span></span>) { $(<span class="hljs-string"><span class="hljs-string">'input.submit'</span></span>,answer_form).click() } });</code> </pre><br>  And in another place (comments.js file, for other sections): <br><pre> <code class="javascript hljs">$(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> comments_form = $(<span class="hljs-string"><span class="hljs-string">'#comments_form'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> comment_text = $(<span class="hljs-string"><span class="hljs-string">'#comment_text'</span></span>); comment_text.keydown(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( (e.ctrlKey || e.metaKey ) &amp;&amp; e.keyCode == <span class="hljs-number"><span class="hljs-number">13</span></span>) { $(<span class="hljs-string"><span class="hljs-string">'input.submit'</span></span>,comments_form).click() } }); ...</code> </pre><br>  These scripts are funny.  If we had <s>root</s> access to the site or at least a proxomitron (a well-known tool for editing the flow on a proxy server), it would be a small matter.  Now it is necessary to make several times more additional movements in order to correct the <s>destructive</s> consequences of several lines.  On the other hand, for educational purposes, this is good.  We are complicated by the task, and we are getting stronger (in the knowledge of methods of solution).  And here we will show how to solve the problem by ‚Äúunleashing‚Äù the problem from the source. <br><br>  We see hanging an event with an anonymous function via jQuery.  As far as we know, an event can be removed if you write $ ('# comment_text'). Unbind ('keydown', the same function), and with a function is a problem, it is anonymous, and user scripts work altogether before creating a keydown handler.  ( <i>UPD 05.02, 22:00</i> - <a href="http://habrahabr.ru/users/taliban/" class="user_link">taliban</a> showed how using ‚ÄúDOMContentLoaded‚Äù to apply a simpler solution through the jQuery .unbind ('keydown') method. The code is in addition to the article below.) Repeating the text of the function, for example, does not resolve the issue .  Disable and redo the effect - $ ('input.submit', $ ('# comments_form')). Click ()?  It does not solve the question, because ‚Äúe‚Äù is not transmitted to it - an event object from which data on a pressed key would be taken.  So, we remake the ‚Äúkeydown‚Äù method of jQuery, which processes keystrokes in this form (text from compressed jQuery): <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, c</span></span></span><span class="hljs-function">) </span></span>{ c == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; (c = a, a = <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bind(b, a, c) : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.trigger(b); }</code> </pre> <br>  Here b is obviously the ‚Äúkeydown‚Äù constant, c - (according to the description in the documentation) - handler (eventObject) is the same user handler whose body we need to change, a is an optional hash data for the handler.  And this piece of code in the library is common to many events.  It is necessary not to violate this function for other applications in jQuery and make a check when this is $ ('textarea').  The method must be overridden, referring not to the function itself, but to its prototype. <br><br>  And, since actions take place in userscript, these operations will not be easy to force to execute in Chrome (environments for userscripts and scripts are separated), and in the rest - at the beginning you need to write an environment object - win, which (typeof unsafeWindow! = 'Undefined')?  unsafeWindow: window. <br><br>  Partial solution of the problem (Firefox, Opera, Safari) will look like this, and we‚Äôll stop on it now, because the overall solution is beyond the essence of the article. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> win = (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> unsafeWindow !=<span class="hljs-string"><span class="hljs-string">'undefined'</span></span>)? unsafeWindow: <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(win.$){ <span class="hljs-comment"><span class="hljs-comment">//   Ctrl+Enter ( Chrome) var comT = win.$('#comment_text, #answer_text'); if(comT){ //  Textarea   ... comT.constructor.prototype.keydown = function(ha, fKeyD){ fKeyD == null &amp;&amp; (fKeyD = ha, ha = null); //   var k ='keydown'; if(this[0].tagName=='TEXTAREA' &amp;&amp; /^(comment|answer)_text$/.test(this[0].id)){ fKeyD = function(ev){ if((ev.ctrlKey || ev.metaKey)&amp;&amp; ev.keyCode == 13) //  win.console.log('Ctrl-enter  '); }; } return arguments.length &gt; 0 ? this.bind(k, ha, fKeyD) : this.trigger(k); } } }</span></span></code> </pre><br>  What was received from the point of view of the beauty of the solution?  The jQuery library function had to be loaded with a special check, because there is no other possibility to cancel the triggering of the send action, and inside it we need to replace the function that makes the click on the button an empty function (we are not empty for demonstration purposes only).  The source code of the library, of course, does not patch, because we did not have access to it, as we have not. <br><br>  Based on this code, it is easy to make a small user script that solves only this task (just use the whole one).  But, since there is a common user script that solves 2-3 dozen tasks, called <a href="https://greasyfork.org/en/scripts/1970-habrajax">HabrAjax</a> , we will create this function for it.  It will take effect at the script with version 2.06 and higher. <br><br>  To check whether the message was not sent by Ctrl-Enter in the specified browsers, you need to install a user script (short, above, or HabrAjax), load the site page with a comment input field, switch the browser to offline mode and make sure that inside the input field by Ctrl- Enter form is not sent.  If you disable the script, this combination will lead to an animation of the ‚ÄúSend‚Äù button, accompanying the attempt to send via Ajax (visible in the Firebug console, for example). <br><br>  The problem is solved - now the accidental pressing of Ctrl + Enter, which sometimes happens during speed dialing, will not lead to an unexpected sending (uncorrectable!) Message to the server. <br><br>  For a common solution involving Chrome, the easiest way is to make a workaround.  Create a new send key.  Delete the old key with all events attached to it.  By clicking on the new - the form will be automatically sent in all browsers.  At the same time, in Firefox, it will be possible to correct the styles of the submit button, which were not amenable to user-style correction by other methods due to the special order of priorities for the use of styles. <br>  <b>UPD</b> : about the tab from the first comment.  You can intercept the tab and prevent it from being used by the default browser.  For writing code, this is even better - tabs create indents.  But someone can use tabs to switch between fields, and someone never does.  I think to include this setting in the general HabAjax script.  And, say, by default, prohibit the transition between fields.  There are opposing opinions? <br>  <b>UPD</b> 22:30: According to the discussion results in the comments, the <a href="https://greasyfork.org/en/scripts/1970-habrajax">HabrAjax</a> settings <a href="https://greasyfork.org/en/scripts/1970-habrajax">were</a> enriched with two new (disconnectable) ones: ‚Äúdo not send comments by Ctrl + Enter‚Äù and ‚Äúdo not leave textarea by Tab, but enter tabs‚Äù.  The latter, more precisely, applies only to comments and allows you to enter "&amp; nbsp;"  Ctrl + space.  In the meantime, made a selection of new settings in the list.  In Chrome, both settings are not shown (even in the list), because they are not supported, but after a while there is an opportunity to remake the script so that it becomes universal (which, by the way, was still true for all the capabilities of the script).  Laid out in version 0.808. <br>  <i>(On the way (to close the topic of character input) - control of indents by Tab - Chift + Tab.)</i> <br>  <b>UPD</b> Feb 5, 10:00 pm: On the initiative and with the help of <a href="http://habrahabr.ru/users/taliban/" class="user_link">taliban, a</a> script for Firefox / Opera was written, which uses disabling the event handler using jQuery: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ==UserScript== // @name noCtrlEnter // @version 1.1, 2012-02-05 // @description     Ctrl+Enter  textarea // @include http://habrahabr.ru/* document.addEventListener( 'DOMContentLoaded', function(){ var win = (typeof unsafeWindow !='undefined')? unsafeWindow: window; if(!win.$) return; var comT = win.$('#comment_text, #answer_text'); comT.length &amp;&amp; comT.unbind('keydown'); },!1);</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/137590/">https://habr.com/ru/post/137590/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137584/index.html">Create a datepicker similar to the standard in Harmattan</a></li>
<li><a href="../137585/index.html">IT in tourism is a myth</a></li>
<li><a href="../137587/index.html">DNS server BIND (theory)</a></li>
<li><a href="../137588/index.html">Weigh CSS selectors</a></li>
<li><a href="../137589/index.html">fbi.gov also uses nginx</a></li>
<li><a href="../137593/index.html">Another step to PyCon.RU - ekb.py</a></li>
<li><a href="../137594/index.html">One more video glasses from Nabes LLC</a></li>
<li><a href="../137595/index.html">The use of an inertial navigation system (INS) with several sensors on the example of the task of stabilizing the height of a quadrocopter</a></li>
<li><a href="../137596/index.html">How to make a controlled outlet from a Chinese router, or another project for a smart home and office</a></li>
<li><a href="../137597/index.html">Mint 4200 floor polisher is another smart mop. Now with gps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>