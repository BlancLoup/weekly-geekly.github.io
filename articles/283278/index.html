<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[PF] Print PDF under .NET, vector approach, theory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue the topic of printing PDF documents from under .NET. 

 In principle, printing a document is not difficult, there are even ready-made solut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[PF] Print PDF under .NET, vector approach, theory</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/c4a/93c/c8b/c4a93cc8bcb34cbb929d5b5f7787376e.jpg"></div><br><br>  I continue the topic of printing PDF documents from under .NET. <br><br>  In principle, printing a document is not difficult, there are even ready-made solutions.  Difficulties arise when you need to control certain print settings.  In my practice, I was faced with the task of implementing a mini-typography - when, when printing documents, you need to specify from which tray to take another sheet, i.e.  print documents by templates.  First of all, I tried to find ready-made solutions, but not finding anything suitable, I began to invent my own. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first thing that came to mind was to render the document pages in raster images and print them using standard .NET tools.  It‚Äôs good that the PrintDocument class allows you to change the printer tray on the fly.  I wrote about this approach in the <a href="https://habrahabr.ru/company/tcsbank/blog/279361/">previous article.</a> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e6a/0f8/d88/e6a0f8d887ab43999e46c7d81a4f6f17.jpg"></div><br><br>  As soon as the first application started working, a significant drawback to this solution was revealed.  After converting PDF into a picture, the file was swollen to enormous size, so printing went on for a very long time.  At the same time, print volumes continued to grow, and I decided to find another way to find it. <br><br>  I was helped by the PCL printer control language from Hewlett-Packard.  On the Internet, information on it turned out to be extremely small, not to mention runet.  The only intelligible description is the official specification.  No sooner said than done.  He launched the HEX editor + utility from HP JetAsm and began to study PCL.  The devil is not so terrible as he is painted.  The language, although binary, is fairly simple and logical.  As a result, after a couple of hours I assembled a test application.  And for the good of all to whom it can be useful and interesting, I will tell you a little about PCL. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/69c/f0d/ab5/69cf0dab5cee4025acdd3cc73ad0214f.jpg"></div><br><br>  Wikipedia says: <br><blockquote>  ‚ÄúPCL (from the English Printer Command Language) is a printer control language developed by Hewlett-Packard.  In the first version, it was just a set of commands for printing ASCII characters, now, in PCL6 and PCL-X versions, it became possible to print in color, as well as print images, but this language is rarely used outside of Microsoft Windows and HP-UX ‚Äù </blockquote><br>  From myself I‚Äôll add that this is a binary and stack language - incoming data is put onto the stack, and when an operator appears, data is taken from the stack as arguments of the operator. <br><br>  <a href="http://www.undocprint.org/_media/formats/page_description_languages/pcl_xl_2_0_technical_reference_rev2_2.pdf">The official description of PCL</a> is on the Internet.  The free utility from HP JetAsm will also help to understand and validate the contents of PCL files.  Her and other useful files can be obtained from the official site without registration.  To do this, click <a href="https://spp.itcs.hp.com/spp/">on the link</a> , click SDK-&gt; Public and find the files of interest. <br><br><h3>  Good old <a href="http://www.ghostscript.com/">GhostScript</a> </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/97a/6f6/c10/97a6f6c109c4473ab13b8e3d4a779432.jpg"></div><br><br>  First we need somewhere to get the pcl file.  Known from the <a href="https://habrahabr.ru/company/tcsbank/blog/279361/">previous article</a> utility GhostScript out of the box can convert PDF to PCL.  You can do this with the command: <br><br><pre><code class="dos hljs">gswin64c.exe -o example.pcl -sDEVICE=pxlmono example.pdf</code> </pre> <br><br>  Thus, without unnecessary movement, we received a PCL file that can be sent to the printer as RawData. <br><br>  However, if it is necessary not only to print the document, but also to distribute it among the trays of the printer (for example, according to some pattern), then you will have to modify the generated PCL file accordingly.  For this you need to deal with its device. <br><br>  So, open the PCL file in any HEX editor.  I used <a href="https://www.x-ways.net/winhex/">WinHex</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f48/1fe/254/f481fe254f434ad9a1e233b6982680ac.jpg"></div><br><br>  The language has a hierarchical structure.  But first, the device needs to understand that the PCL data stream will continue to be transmitted, for this is the initialization string. <br><br>  The hierarchy of PCL operators is as follows: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  In this case, there may be several sessions, and page elements may be nested in other elements. <br><br><h3>  Let's start in order </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ad5/b60/484/ad5b60484810450f804c05b29c172b3b.jpg"></div><br><br>  I have already said that at the beginning of the thread there is a standard line.  It is for her that the device determines that the data in the PCLXL format will be transmitted further.  The initial string length is 99 bytes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d74/9f8/db1/d749f8db1af84379aa544e4e513b0e66.jpg"></div><br><br>  Next comes the PCL data stream.  To start describing the elements of the document, the session must be opened, for this there is a <b>BeginSession</b> command with the code 0x41.  This and other command codes can be found in the manual.  In one file there can be one or several sessions, but more often one. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/13f/4e3/285/13f4e32858c14e0399a29296478bc4e9.jpg"></div><br><br>  We also look at the arguments that need to be passed to the BeginSession. <br><br>  The arguments have the following structure: [data type] [data] [attribute type] [attribute] <br><br>  <b>UnitsPerMeasure</b> is the resolution of the working area x and y, has the data type uint16_xy is a structure of two two-byte words. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/32d/34e/29c/32d34e29c2774eb28bbc2786cfb8256f.jpg"></div><br><br>  <b>Measure</b> - enumeration of units in which we will work {eInch |  eMillimeter |  eTenthsOfAMillimeter} <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ca1/f20/b54/ca1f20b5443f4e898a0dab6013b49c3f.jpg"></div><br><br>  <b>ErrorReport</b> is an enumeration that defines how the device will handle errors. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/bbf/46c/552/bbf46c552f304cd595e8cc862cceaf78.jpg"></div><br><br><h3>  BeginPage </h3><br><br>  The page is initialized in the same way.  It is the <b>BeginPage</b> operator <b>that</b> allows <b>you</b> to set the duplex mode and specify the tray from which the paper will be taken. <br><br>  Let us analyze the arguments of the operator BeginPage. <br><br>  <b>Orientation</b> - page orientation, can be {ePortraitOrientation |  eLandscapeOrientation |  eReversePortrait |  eReverseLandscape} <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3e4/30f/0e4/3e430f0e430f4aee929845e33cb74f9e.jpg"></div><br><br>  <b>MediaSize</b> - page size, listing, in our case eA4Paper.  Instead of the MediaSize type, there can be <b>CustomMediaSize</b> , <b>CustomMediaSizeUnits</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fb3/c99/8f3/fb3c998f35844be7ba46b422806bc77e.jpg"></div><br><br>  <b>MediaSource</b> - the source of the paper. <br>  0 - eDefaultSource <br>  1 - eAutoSelect <br>  2 - eManualFeed <br>  3 - eMultiPurposeTray <br>  4 - eUpperCassette <br>  5 - eLowerCassette <br>  6 - eEnvelopeTray <br>  7 - eThirdCassette <br>  1-248 - External Trays <br><br>  Instead MediaSource may be <b>MediaType</b> with the name of the source. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/01f/75a/0b4/01f75a0b4d914848b96fdafb083ef48a.jpg"></div><br><br>  <b>SimplexPageMode</b> - single page printing mode, the value must be eSimplexFrontSide = 0 <br><br>  Instead of SimplexPageMode can be <b>DuplexPageMode</b> or <b>DuplexPageSide</b> . <br><br>  <b>DuplexPageSide</b> - prints one page on one sheet, but you can set on which side of the sheet {eFrontMediaSide |  eBackMediaSide} <br><br>  <b>DuplexPageMode</b> - two consecutive pages are printed on two sides of one sheet, you can set the values ‚Äã‚ÄãeDuplexHorizontalBinding = 0 and eDuplexVerticalBinding = 1 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/8bd/a17/e06/8bda17e065ad4c8ba6e5e8368f9ec49d.jpg"></div><br><br>  And all this ends with the command BeginPage with code 0x43 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/510/164/61f/51016461f3de490e96bbe0dd26a46140.jpg"></div><br><br>  I hope the principle is clear.  This is enough to develop the application and modify the PCL file so that you can change the Duplex - Simplex mode and specify which tray to pick up the paper from.  To do this, you need to find the declaration of the next page in the file and change it as necessary. <br><br>  I will tell you about the implementation of the PDF printing application in the vector following the template in the next article. <br><br>  If there are inaccuracies or need more details, please write about it in the comments. <br><br>  Cycle of articles: <br>  <a href="https://habrahabr.ru/company/tcsbank/blog/279361/">Raster approach</a> <br>  <a href="https://habrahabr.ru/company/tcsbank/blog/283278/">Vector approach theory</a> <br>  <a href="https://habrahabr.ru/company/tcsbank/blog/302062/">Vector approach practice</a> </div><p>Source: <a href="https://habr.com/ru/post/283278/">https://habr.com/ru/post/283278/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283262/index.html">Paul Graham, ‚ÄúHackers and Artists,‚Äù Chapter 5: The Other Road Ahead, continued</a></li>
<li><a href="../283264/index.html">Search for the spine line in photos of book spreads</a></li>
<li><a href="../283270/index.html">Analysis of the tasks of the first qualifying round of the RCC 2016</a></li>
<li><a href="../283274/index.html">There are no hares under Android - the history of creation</a></li>
<li><a href="../283276/index.html">Veeam Backup & Replication: workaround for one problem with backup job metadata</a></li>
<li><a href="../283280/index.html">Product design digest, April 2016</a></li>
<li><a href="../283282/index.html">Drupal: ajax_facets and history API</a></li>
<li><a href="../283284/index.html">Natural animation in interfaces</a></li>
<li><a href="../283286/index.html">Happy Birthday, Edsger Vibe Dijkstra«É</a></li>
<li><a href="../283288/index.html">Kui releases while hot - pre-release testing version 0.4.1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>