<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a listening application for viewing mobile MMORPG traffic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the second part of a series of articles about the analysis of network traffic mobile MMORPG. Sample cycle topics: 



1. Parsing message forma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a listening application for viewing mobile MMORPG traffic</h1><div class="post__text post__text-html js-mediator-article">  This is the second part of a series of articles about the analysis of network traffic mobile MMORPG.  Sample cycle topics: <br><br><ol><li>  <a href="https://habr.com/ru/post/451512/">Parsing message format between server and client.</a> </li><li>  Writing a listening application to view game traffic in a convenient way. </li><li>  Interception of traffic and its modification using a non-HTTP proxy server. </li><li>  The first steps to your own ("pirated") server. </li></ol><br>  In this part, I will describe the creation of a listening application (sniffer), which will allow us to filter events by their type and source, display information about the message and save them for analysis, and also climb a little into the executable game file (‚Äúbinary‚Äù) to find supporting information and add <a href="https://developers.google.com/protocol-buffers/docs/encoding">Protocol Buffers</a> support to the application.  Interested please under the cat. <br><a name="habracut"></a><br><h3>  Required Tools </h3><br>  To be able to repeat the steps described below, you will need: <br><br><ul><li>  Wireshark for packet analysis; </li><li>  .NET; </li><li>  <a href="">PcapDotNet</a> library for working with WinPcap; </li><li>  <a href="https://github.com/mgravell/protobuf-net">protobuf-net</a> library for working with Protocol Buffers. </li></ul><br><h3>  Writing a listening application </h3><br>  As we remember from the <a href="https://habr.com/ru/post/451512/">previous article</a> , the game communicates via the TCP protocol, and within the session it does this with only one server and on one port.  To be able to analyze the game traffic, we need to perform the following tasks: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  intercept mobile device packets; </li><li>  filter game packages; </li><li>  add the data of the next packet to the buffer for further processing; </li><li>  get game events from buffers as it is filled. </li></ul><br>  These actions are implemented in the <code>Sniffer</code> class, which uses the PcapDotNet library to intercept packets.  In the <code>Sniff</code> method we transfer the IP address of the adapter (in fact, this is the address of the PC from which Wi-Fi for the mobile device is distributed within the same network), the IP address of the mobile device and the IP address of the server.  Due to the inconstancy of the last two (after many months of monitoring different platforms and servers, it turned out that the server is selected from a pool of ~ 50 servers, each of which still have 5-7 possible ports), I transmit only the first three octets.  The use of this filtering is seen in the <code>IsTargetPacket</code> method. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Sniffer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] _data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">4096</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Active { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _adapterIP; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _target; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _server; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; _serverBuffer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; _clientBuffer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LivePacketDevice _device = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PacketCommunicator _communicator = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action&lt;Event&gt; _eventCallback = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sniff</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ip, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> target, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> server</span></span></span><span class="hljs-function">)</span></span> { _adapterIP = ip; _target = target; _server = server; _serverBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(); _clientBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(); IList&lt;LivePacketDevice&gt; allDevices = LivePacketDevice.AllLocalMachine; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i != allDevices.Count; ++i) { LivePacketDevice device = allDevices[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> address = device.Addresses[<span class="hljs-number"><span class="hljs-number">1</span></span>].Address + <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (address == <span class="hljs-string"><span class="hljs-string">"Internet "</span></span> + _adapterIP) { _device = device; } } _communicator = _device.Open(<span class="hljs-number"><span class="hljs-number">65536</span></span>, PacketDeviceOpenAttributes.Promiscuous, <span class="hljs-number"><span class="hljs-number">1000</span></span>); _communicator.SetFilter(_communicator.CreateFilter(<span class="hljs-string"><span class="hljs-string">"ip and tcp"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(() =&gt; { Thread.CurrentThread.IsBackground = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; BeginReceive(); }).Start(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeginReceive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _communicator.ReceivePackets(<span class="hljs-number"><span class="hljs-number">0</span></span>, OnReceive); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { PacketCommunicatorReceiveResult result = _communicator.ReceivePacket(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Packet packet); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (result) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PacketCommunicatorReceiveResult.Timeout: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PacketCommunicatorReceiveResult.Ok: OnReceive(packet); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Active); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddEventCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action&lt;Event&gt; callback</span></span></span><span class="hljs-function">)</span></span> { _eventCallback = callback; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnReceive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Packet packet</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Active) { IpV4Datagram ip = packet.Ethernet.IpV4; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsTargetPacket(ip)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ParseData(ip); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ObjectDisposedException) { } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (EndOfStreamException e) { Console.WriteLine(e); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsTargetPacket</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IpV4Datagram ip</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sourceIp = ip.Source.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> destIp = ip.Destination.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (sourceIp != _adapterIP &amp;&amp; destIp != _adapterIP) &amp;&amp; ( (sourceIp.StartsWith(_target) &amp;&amp; destIp.StartsWith(_server)) || (sourceIp.StartsWith(_server) &amp;&amp; destIp.StartsWith(_target)) ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IpV4Datagram ip</span></span></span><span class="hljs-function">)</span></span> { TcpDatagram tcp = ip.Tcp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tcp.Payload != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; tcp.PayloadLength &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payload = ExtractPayload(tcp); AddToBuffer(ip, payload); ProcessBuffers(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExtractPayload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TcpDatagram tcp</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> payloadLength = tcp.PayloadLength; MemoryStream ms = tcp.Payload.ToMemoryStream(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] payload = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[payloadLength]; ms.Read(payload, <span class="hljs-number"><span class="hljs-number">0</span></span>, payloadLength); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> payload; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddToBuffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IpV4Datagram ip, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] payload</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ip.Destination.ToString().StartsWith(_target)) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> payload) _serverBuffer.Add(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> payload) _clientBuffer.Add(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessBuffers</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ProcessBuffer(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _serverBuffer); ProcessBuffer(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _clientBuffer); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessBuffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> List&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; buffer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// TODO } public void Suspend() { Active = false; } public void Resume() { Active = true; } }</span></span></code> </pre><br>  Great, now we have two buffers with packet data from the client and server.  We recall the format of events between the game and the server: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> {</span></span> uint payload_length &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0xFFFF00</span></span>, name=<span class="hljs-string"><span class="hljs-string">"Payload Length"</span></span>&gt;; ushort event_code &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0xFF9988</span></span>, name=<span class="hljs-string"><span class="hljs-string">"Event Code"</span></span>&gt;; byte payload[payload_length] &lt;name=<span class="hljs-string"><span class="hljs-string">"Event Payload"</span></span>&gt;; };</code> </pre><br>  Based on this, you can create a class of event <code>Event</code> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> EventSource { Client, Server } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> EventTypes : <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> { Movement = <span class="hljs-number"><span class="hljs-number">11</span></span>, Ping = <span class="hljs-number"><span class="hljs-number">30</span></span>, Pong = <span class="hljs-number"><span class="hljs-number">31</span></span>, Teleport = <span class="hljs-number"><span class="hljs-number">63</span></span>, EnterDungeon = <span class="hljs-number"><span class="hljs-number">217</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Event</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> ID; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Length { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> DataLength { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> EventType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> EventSource Direction { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] _data; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> BinaryReader _br = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Event</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data, EventSource direction</span></span></span><span class="hljs-function">)</span></span> { _data = data; _br = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BinaryReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream(_data)); Length = _br.ReadUInt32(); Type = _br.ReadUInt16(); DataLength = <span class="hljs-number"><span class="hljs-number">0</span></span>; EventType = <span class="hljs-string"><span class="hljs-string">$"Unknown (</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Type}</span></span></span><span class="hljs-string">)"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsKnown()) { EventType = ((EventTypes)Type).ToString(); } Direction = direction; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsKnown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Enum.IsDefined(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EventTypes), Type); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPayload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hasDatLength = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payloadLength = _data.Length - (hasDatLength ? <span class="hljs-number"><span class="hljs-number">10</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(_data).GetRange(hasDatLength ? <span class="hljs-number"><span class="hljs-number">10</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span>, payloadLength).ToArray(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, <span class="hljs-string"><span class="hljs-string">"Packets"</span></span>, EventType); Directory.CreateDirectory(path); File.WriteAllBytes(path + <span class="hljs-string"><span class="hljs-string">$"/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{ID}</span></span></span><span class="hljs-string">.dump"</span></span>, _data); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"Type </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Type}</span></span></span><span class="hljs-string">. Data length: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Length}</span></span></span><span class="hljs-string">."</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ulong</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadVLQ</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> readFlag = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (readFlag) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> flag = _br.ReadByte(); } <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> vlq = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; ; i += <span class="hljs-number"><span class="hljs-number">7</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = _br.ReadByte(); vlq |= (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>)(x &amp; <span class="hljs-number"><span class="hljs-number">0x7F</span></span>) &lt;&lt; i; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((x &amp; <span class="hljs-number"><span class="hljs-number">0x80</span></span>) != <span class="hljs-number"><span class="hljs-number">0x80</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vlq; } }</code> </pre><br>  The <code>Event</code> class will be used as the base class for all game events.  Here is an example class for the <code>Ping</code> event: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Ping</span></span> : <span class="hljs-title"><span class="hljs-title">Event</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> _pingTime; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ping</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data, EventSource.Client</span></span></span><span class="hljs-function">)</span></span> { EventType = <span class="hljs-string"><span class="hljs-string">"Ping"</span></span>; DataLength = <span class="hljs-number"><span class="hljs-number">4</span></span>; _pingTime = _br.ReadUInt32(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"Pinging server at </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_pingTime}</span></span></span><span class="hljs-string">ms."</span></span>; } }</code> </pre><br>  Now that we have an event class, we can add methods in <code>Sniffer</code> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessBuffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> List&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; buffer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Active) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer.Count &gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  4        ... { var eventLength = BitConverter.ToInt32(buffer.Take(4).ToArray(), 0) + 6; // ...    -   .. +  4  + 2    if (eventLength &gt;= 6 &amp;&amp; buffer.Count &gt;= eventLength) { var eventData = buffer.Take(eventLength).ToArray(); var ev = CreateEvent(eventData, direction); buffer.RemoveRange(0, eventLength); continue; } } break; } } } private Event CreateEvent(byte[] data, EventSource direction) { var ev = new Event(data, direction); var eventType = Enum.GetName(typeof(EventTypes), ev.Type); if (eventType != null) { try { //     (, &lt;code&gt;Ping&lt;/code&gt;). var className = "Events." + eventType; Type t = Type.GetType(className); ev = (Event)Activator.CreateInstance(t, data); } catch (Exception) { //     -   . ev = new Event(data, direction); } finally { } } _eventCallback?.Invoke(ev); return ev; }</span></span></code> </pre><br>  Create a form class that will trigger a wiretap: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainForm</span></span> : <span class="hljs-title"><span class="hljs-title">Form</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Sniffer _sniffer = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Event&gt; _events = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Event&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>&gt; _eventTypesFilter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _showClientEvents = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _showServerEvents = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _showUnknownEvents = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _clearLogsOnRestart = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> _eventId = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeSniffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _sniffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sniffer(); _sniffer.AddEventCallback(NewEventThreaded); _sniffer.Sniff(<span class="hljs-string"><span class="hljs-string">"192.168.137.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"192.168.137."</span></span>, <span class="hljs-string"><span class="hljs-string">"123.45.67."</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewEventThreaded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { events_table.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NewEventCallback(NewEvent), ev); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewEventCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { ev.ID = _eventId++; _events.Add(ev); LogEvent(ev); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FilterEvent(ev)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = ev.GetType(); events_table.Rows.Add(<span class="hljs-number"><span class="hljs-number">1</span></span>); events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">0</span></span>].Value = ev.ID; events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">1</span></span>].Value = ev.EventType; events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">2</span></span>].Value = Enum.GetName(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EventSource), ev.Direction); events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">3</span></span>].Value = ev.ToString(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReloadEvents</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { events_table.Rows.Clear(); events_table.Refresh(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ev <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _events) { LogEvent(ev); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( (ev.Direction == EventSource.Client &amp;&amp; _showClientEvents) || (ev.Direction == EventSource.Server &amp;&amp; _showServerEvents) ) &amp;&amp; (_eventTypesFilter.Contains(ev.Type) || (!ev.IsKnown() &amp;&amp; _showUnknownEvents)); } }</code> </pre><br>  Done!  Now you can add a pair of tables for managing the list of events (through it <code>_eventTypesFilter</code> filled) and for viewing in real time (the main table <code>events_table</code> ).  For example, I filtered by the following criteria ( <code>FilterEvent</code> method): <br><br><ul><li>  show events from the client; </li><li>  show events from the server; </li><li>  showing unknown events; </li><li>  showing selected known events. </li></ul><br><h3>  We study the executable file of the game </h3><br>  Although it is now possible to analyze game events without problems, there is a huge amount of manual work to determine not only the meaning of all event codes, but also the structure of the payload, which will be quite difficult, especially if it changes depending on some fields.  I decided to look for some information in the executable file of the game.  Since the game is cross-platform (available on Windows, iOS and Android), the following options are available for analysis: <br><br><ul><li>  The .exe file (I have the path C: / Program Files / WindowsApps /% appname% /; </li><li>  iOS binary file that is encrypted by Apple, but with JailBreak you can get the decrypted version using Crackulous or similar; </li><li>  dynamic library (shared object) Android.  Located along the path / data / data /% app-vendor-name% / lib /. </li></ul><br>  Having no idea which architecture to choose for Android and iOS, I started with an .exe file.  We load a binary in IDA, we see the choice of architectures. <br><br><img src="https://habrastorage.org/webt/jb/q6/vh/jbq6vhlp9nqovpae87uka5jrof0.png"><br><br>  The purpose of our search is some very useful lines, which means decompiling the assembler is not included in the plans, but just in case, select ‚Äúexecutable 80386‚Äù, since the options ‚ÄúBinary File‚Äù and ‚ÄúMS-DOS executable‚Äù are clearly not suitable.  Click "OK", wait until the file is loaded into the database, and it is desirable to wait until the end of the file analysis.  The end of the analysis can be recognized by the fact that in the status bar at the bottom left there will be the following state: <br><br><img src="https://habrastorage.org/webt/yk/__/fb/yk__fbdgrskjle8c5zf6ro0q_f8.png"><br><br>  Go to the Strings tab (View / Open subviews / Strings or <code>Shift + F12</code> ).  The process of generating strings may take some time.  In my case ~ 47k lines were found.  Line address addresses have a prefix of the form <code>.data</code> , <code>.rdata</code> and <a href="https://docs.microsoft.com/ru-ru/windows/desktop/Debug/pe-format">others</a> .  In my case, all the ‚Äúinteresting‚Äù lines were in the <code>.rdata</code> section, the size of which was ~ 44.5k records.  Looking through the table you can see: <br><br><ul><li>  error messages and query segments at the entry stage; </li><li>  error lines and initialization information of the game, game engine, interfaces; </li><li>  a lot of trash; </li><li>  list of game tables on the client side; </li><li>  used values ‚Äã‚Äãof the game engine in the game; </li><li>  list of effects; </li><li>  a huge list of interface localization keys; </li><li>  etc. </li></ul><br>  Finally, closer to the end of the table comes across what we were looking for. <br><br><img src="https://habrastorage.org/webt/ua/jr/sw/uajrsw8i71x33xuhyhmzonprqku.png"><br><br>  This is a list of event codes between the client and the server.  This can make life easier for us when parsing the network protocol of the game.  But we will not stop there!  It is necessary to check whether it is possible to somehow get the numerical value of the event code.  We see the ‚Äúfamiliar‚Äù from the previous article codes <code>CMSG_PING</code> and <code>SMSG_PONG</code> , having codes 30 ( <code>1E <sub>16</sub></code> ) and 31 ( <code>1F <sub>16</sub></code> ), respectively.  Double click on the line to go to this place in the code. <br><br><img src="https://habrastorage.org/webt/la/ro/wj/larowjnopxrmyc53htrzo_-_2zi.png"><br><br>  Indeed, immediately after the string values ‚Äã‚Äãof the codes comes the sequence <code>0x10 0x1E</code> and <code>0x10 0x1F</code> .  Well, that means you can parse the entire table and get a list of events and their numerical value, which will further simplify the analysis of the protocol. <br><br>  Unfortunately, the Windows version of the game lags behind the mobile versions by a lot of versions, and therefore the information from the .exe is not relevant, and although it can help, you should not rely on it completely.  Next, I decided to study the dynamic library with Android, since I saw on one forum that there, unlike iOS binaries, there is a lot of meta-information about classes.  But alas, searching the file for <code>CMSG_PING</code> values <code>CMSG_PING</code> not return any results. <br><br>  Without hope, I‚Äôm doing the same search in the iOS binary as incredible, but it turned out to have the same data as in .exe!  Upload the file to IDA. <br><br><img src="https://habrastorage.org/webt/la/ro/wj/larowjnopxrmyc53htrzo_-_2zi.png"><br><br>  I choose the first proposed option, because I'm not sure which one is needed.  Again we are waiting for the end of the file analysis (the binary is almost 4 times the size of the .exe, the analysis time, of course, has also increased).  Open the window with lines, which this time turned out to be 51k.  Through <code>Ctrl + F</code> we search for <code>CMSG_PING</code> and ... we do not find it.  By entering the code character by character, you can notice the following result: <br><br><img src="https://habrastorage.org/webt/jk/rz/be/jkrzbe0uvyj2vi2fxphnldc_vki.png"><br><br>  For some reason, IDA put the whole <code>Opcode.proto</code> object in one line.  Double click on this place in the code and see that the structure is described in the same way as in the .exe file, so you can cut it out and convert it to <code>Enum</code> . <br><br>  Finally, it is worth remembering how, in the comments to the last article, <a href="https://habr.com/ru/users/aml/" class="user_link">aml</a> suggested that the message structure of the game is an implementation of <a href="https://developers.google.com/protocol-buffers/docs/encoding">Protocol Buffers</a> .  If you look closely at the code in the binary file, you can see that the description of <code>Opcode</code> also in this format. <br><br><img src="https://habrastorage.org/webt/a6/pl/bk/a6plbk-pb8ldifrvha6qfqmh0oi.png"><br><br>  Let's write a parser template for 010Editor to get all the code values. <br><br><div class="spoiler">  <b class="spoiler_title">Updated Packed * type code for 010Editor</b> <div class="spoiler_text">  Small changes in types include checking field labels to skip missing ones. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">uint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PeekTag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FTell() == FileSize()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } Varint tag; FSkip(-tag.size); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tag._ &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-function"><span class="hljs-function">struct </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Packed</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint fieldNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PeekTag() != fieldNumber) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } Varint key &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0xFFBB00</span></span>&gt;; local uint wiredType = key._ &amp; <span class="hljs-number"><span class="hljs-number">0x7</span></span>; local uint field = key._ &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>; local uint size = key.size; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (wiredType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> value; size += <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value; size += <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: Varint value; size += value.size; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }; <span class="hljs-function"><span class="hljs-function">struct </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PackedString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint fieldNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PeekTag() != fieldNumber) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-function"><span class="hljs-function">Packed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fieldNumber)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> str[length.value._]; };</code> </pre><br></div></div><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Code</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-function">Packed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> &lt;bgcolor</span></span>=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; <span class="hljs-function"><span class="hljs-function">PackedString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">code_name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> &lt;bgcolor</span></span>=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; <span class="hljs-function"><span class="hljs-function">Packed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">code_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> &lt;bgcolor</span></span>=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; Printf(<span class="hljs-string"><span class="hljs-string">"%s = %d,\n"</span></span>, code_name.str, code_value.value._); <span class="hljs-comment"><span class="hljs-comment">//        Enum }; struct Property { Packed size(5) &lt;bgcolor=0x00FF00&gt;; PackedString prop_name(1) &lt;bgcolor=0x00FF00&gt;; while (FTell() - 0x176526B - prop_name.length.value._ &lt; size.value._) { Code codes &lt;name="Codes"&gt;; } }; struct { FSkip(0x176526B); PackedString object(1) &lt;bgcolor=0x00FF00&gt;; PackedString format(2) &lt;bgcolor=0x00FFFF&gt;; Property prop; } file;</span></span></code> </pre><br>  As a result, we get something like this: <br><br><img src="https://habrastorage.org/webt/n5/ge/1d/n5ge1dnylry0n2tdskxrvqg9zmy.png"><br><br>  More interesting!  Noticed <code>pb</code> in the description of the object?  It would be necessary to look for other lines, what if there are many more such objects? <br><br><img src="https://habrastorage.org/webt/wf/cp/fx/wfcpfxmh1c6vhwycv9jnp4k9wle.png"><br><br>  The results are extremely unexpected.  Apparently, many types of data are described in the executable game file, including enumerations and message formats between the server and the client.  Here is an example of a description of a type describing the position of an object in the world: <br><br><img src="https://habrastorage.org/webt/jl/br/ix/jlbrixdyltdfgfmzkdoxvl038eg.png"><br><br>  A quick search revealed two large places with descriptions of types, although with a more careful study, other small places will most likely come to light.  Cutting them out, I wrote a small C # script to separate the descriptions by files (this is similar in structure to the description of the event code list) - it is easier to analyze them in 010Editor. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> br = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BinaryReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileStream(<span class="hljs-string"><span class="hljs-string">"./BinaryFile.partX"</span></span>, FileMode.Open)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (br.BaseStream.Position &lt; br.BaseStream.Length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> startOffset = br.BaseStream.Position; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> length = ReadVLQ(br, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tag = br.ReadByte(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> eventName = br.ReadString(); br.BaseStream.Position = startOffset; File.WriteAllBytes(<span class="hljs-string"><span class="hljs-string">$"./parsed/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{eventName}</span></span></span><span class="hljs-string">"</span></span>, br.ReadBytes((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)length + size + <span class="hljs-number"><span class="hljs-number">1</span></span>)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ulong</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadVLQ</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BinaryReader br, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> flag = br.ReadByte(); <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> vlq = <span class="hljs-number"><span class="hljs-number">0</span></span>; size = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; ; i += <span class="hljs-number"><span class="hljs-number">7</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = br.ReadByte(); vlq |= (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>)(x &amp; <span class="hljs-number"><span class="hljs-number">0x7F</span></span>) &lt;&lt; i; size++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((x &amp; <span class="hljs-number"><span class="hljs-number">0x80</span></span>) != <span class="hljs-number"><span class="hljs-number">0x80</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vlq; } }</code> </pre><br>  I will not analyze the format of the description of structures in detail, because  either it is specific to the game in question, or it is a common format in <code>Protocol Buffers</code> (if anyone knows for sure, please indicate in the comments).  From what I could find: <br><br><ul><li>  the description also comes in the <code>Protocol Buffers</code> format; </li><li>  The description of each field contains its name, number and data type for which its own type table was used: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TypeToStr</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Float"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"UInt64"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"UInt32"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Boolean"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"String"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Struct"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Enum"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: local <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> s; SPrintf(s, <span class="hljs-string"><span class="hljs-string">"%Lu"</span></span>, type); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s; } };</code> </pre></li><li>  if the data type is an enumeration or structure, then there was a link to the desired object. </li></ul><br>  Well, the last thing left for us is to use the information received in our listening application: parse messages using the <a href="https://github.com/mgravell/protobuf-net"><code>protobuf-net</code></a> library.  Connect the library via NuGet, add <code>using ProtoBuf;</code>  and you can create classes to describe the messages.  Take one of the examples from the previous article: character movement.  The parsed format description when highlighting segments looks like this: <br><br><img src="https://habrastorage.org/webt/ce/qg/py/ceqgpyfbuxygvoqx4jnlp8slumy.png"><br><br>  Debug output allows you to create a brief description from this: <br><br><pre> <code class="plaintext hljs">Field 1 (Type 13): time Field 2 (Struct .pb.CxGS_Vec3): position Field 3 (UInt64): guid Field 4 (Struct .pb.CxGS_Vec3): direction Field 5 (Struct .pb.CxGS_Vec3): speed Field 6 (UInt32): state Field 10 (UInt32): flag Field 11 (Float): y_speed Field 12 (Boolean): is_flying Field 7 (UInt32): emote_id Field 9 (UInt32): emote_duration Field 8 (Boolean): emote_loop</code> </pre><br>  Now you can create the corresponding class using the <code>protobuf-net</code> library. <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ProtoContract</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MoveInfo</span></span> : <span class="hljs-title"><span class="hljs-title">ProtoBufEvent</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MoveInfo</span></span>&gt; { [ProtoMember(<span class="hljs-number"><span class="hljs-number">3</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> GUID; [ProtoMember(<span class="hljs-number"><span class="hljs-number">1</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> Time; [ProtoMember(<span class="hljs-number"><span class="hljs-number">2</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vec3 Position; [ProtoMember(<span class="hljs-number"><span class="hljs-number">4</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vec3 Direction; [ProtoMember(<span class="hljs-number"><span class="hljs-number">5</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vec3 Speed; [ProtoMember(<span class="hljs-number"><span class="hljs-number">6</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> State; [ProtoMember(<span class="hljs-number"><span class="hljs-number">7</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> EmoteID; [ProtoMember(<span class="hljs-number"><span class="hljs-number">8</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> EmoteLoop; [ProtoMember(<span class="hljs-number"><span class="hljs-number">9</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> EmoteDuration; [ProtoMember(<span class="hljs-number"><span class="hljs-number">10</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Flag; [ProtoMember(<span class="hljs-number"><span class="hljs-number">11</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> SpeedY; [ProtoMember(<span class="hljs-number"><span class="hljs-number">12</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsFlying; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{GUID}</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Position}</span></span></span><span class="hljs-string">"</span></span>; } }</code> </pre><br>  For comparison, here is a template of the same event from the previous article: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MoveEvent</span></span></span><span class="hljs-class"> {</span></span> uint data_length &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>, name=<span class="hljs-string"><span class="hljs-string">"Data Length"</span></span>&gt;; Packed move_time &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FFFF</span></span>&gt;; PackedVector3 position &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; PackedVector3 direction &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; PackedVector3 speed &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; Packed state &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; };</code> </pre><br>  When inheriting from the <code>Event</code> class, we can override the <code>ParseData</code> method, deserializing the package data: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CMSG_MOVE_INFO</span></span> : <span class="hljs-title"><span class="hljs-title">Event</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MoveInfo _message; [...] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _message = MoveInfo.Deserialize(GetPayload()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _message.ToString(); } }</code> </pre><br>  That's all.  The next step is to redirect game traffic to our proxy server for the purpose of injection, substitution, and package cutting. </div><p>Source: <a href="https://habr.com/ru/post/457480/">https://habr.com/ru/post/457480/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457464/index.html">Deduplication of ads on Yandex. Real Estate</a></li>
<li><a href="../457466/index.html">How we developed IT in Leroy Merlin: engine reassembly on the move</a></li>
<li><a href="../457468/index.html">Universal memory: SRAM, DRAM and flash memory in one bottle</a></li>
<li><a href="../457470/index.html">Leaf math: how one unusual bush changed the equation of a plant growth model</a></li>
<li><a href="../457476/index.html">Reducing the size of the docker image with the spring boot application</a></li>
<li><a href="../457490/index.html">Aysioshechka from Zuckerberg - briefly and in the Libra case</a></li>
<li><a href="../457494/index.html">‚ÄúAnd if I don‚Äôt know math, am I hopeless?‚Äù - experts answer frequently asked questions about the professions in Data Science</a></li>
<li><a href="../457496/index.html">"Find the five differences." Scalable Generation Difference - New Test Portion</a></li>
<li><a href="../4575/index.html">Monster.com told Runet the first "boo"</a></li>
<li><a href="../457500/index.html">How we did the autopilot for the service station</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>