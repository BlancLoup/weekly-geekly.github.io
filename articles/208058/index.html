<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Video surveillance on the Raspberry Pi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good time of day! 

 On the eve of New Year's Eve, I had an idea to build a kind of video surveillance. Everything I needed was in my hands: 


- Sing...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Video surveillance on the Raspberry Pi</h1><div class="post__text post__text-html js-mediator-article">  Good time of day! <br><br>  On the eve of New Year's Eve, I had an idea to build a kind of video surveillance.  Everything I needed was in my hands: <br><ul><li>  Single Board Computer <a href="http://ru.wikipedia.org/wiki/Raspberry_Pi">Raspberry Pi</a> Model B </li><li>  Webcam LOGITECH HD Webcam C270 </li></ul><br>  After reading the <a href="http://habrahabr.ru/post/196598/">article,</a> I decided to develop a little idea of ‚Äã‚Äãthe author. <br><br>  The main difference between my idea and the author‚Äôs idea is that I have the opportunity to view events in real time without losing the main function - video recording. <br><a name="habracut"></a><br><h5>  Acquaintance </h5><br>  So, for the beginning we will get acquainted with the main "component": <br>  <b>Appearance Raspberry Pi:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/eff/9bb/2f4/eff9bb2f44e29ce190ea74086dd5ff3b.jpg"><br>  <b>Specifications:</b> <br><ul><li>  Broadcom BCM2835 700MHz ARM1176JZFS processor with FPU and Videocore 4 GPU </li><li>  GPU provides Open GL ES 2.0, hardware-accelerated OpenVG, and 1080p30 H.264 high-profile decode </li><li>  GPU is capable of 1Gpixel / s, 1.5Gtexel / s or 24GFLOPs with texture filtering and DMA infrastructure </li><li>  512MB RAM </li><li>  Boots from SD card, running a version of the Linux operating system </li><li>  10/100 BaseT Ethernet socket </li><li>  HDMI video out socket </li><li>  2 x USB 2.0 sockets </li><li>  RCA composite video out socket </li><li>  SD card socket </li><li>  Powered from microUSB socket </li><li>  3.5mm audio out jack </li><li>  Raspberry Pi HD video camera connector </li><li>  Size: 85.6 x 53.98 x 17mm " </li></ul><br><pre><code class="bash hljs">pi@hall-pi ~ $ cat /proc/cpuinfo processor : 0 model name : ARMv6-compatible processor rev 7 (v6l) BogoMIPS : 2.00 Features : swp half thumb fastmult vfp edsp java tls CPU implementer : 0x41 CPU architecture: 7 CPU variant : 0x0 CPU part : 0xb76 CPU revision : 7 Hardware : BCM2708 Revision : 000e Serial : 000000005a82c372</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A list of officially supported distributions can be found <a href="http://www.raspberrypi.org/downloads">here</a> .  I opted for Raspbian without a graphical shell. <br><br>  The installation process is quite simple and does not need a detailed description, so I will list the main facts that you should pay attention to: <br><ol><li>  Time zone setting </li><li>  Computer name setting </li><li>  Enable SSH access </li><li>  System update </li></ol><br>  After completing all the necessary settings you can proceed. <br><br><h5>  Training </h5><br>  First, let's install all the necessary packages: <br><pre> <code class="bash hljs">sudo apt-get install imagemagick libav-tools libjpeg8-dev subversion</code> </pre><br>  After that we download and collect mjpg-streamer: <br><pre> <code class="bash hljs">sudo svn co https://svn.code.sf.net/p/mjpg-streamer/code/mjpg-streamer/ mjpg-streamer <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> mjpg-streamer make</code> </pre><br>  Since  All data will be stored in the cloud, we will configure work with a remote file system via WebDAV: <br><pre> <code class="bash hljs">sudo apt-get install davfs2 sudo mkdir /mnt/dav sudo mount -t davfs https://webdav.yandex.ru /mnt/dav -o uid=pi,gid=pi</code> </pre><br>  In order not to enter your username and password each time, you need to add them to the file <br>  / etc / davfs2 / secrets <br><pre> <code class="bash hljs">/mnt/dav user password</code> </pre><br><br><h5>  The working process </h5><br>  Add to /etc/rc.local the commands for mounting WebDAV and running the script for broadcasting to the network: <br><pre> <code class="bash hljs">mount -t davfs https://webdav.yandex.ru /mnt/dav -o uid=pi,gid=pi <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/pi/mjpg-streamer &amp;&amp; ./mjpg_streamer -i <span class="hljs-string"><span class="hljs-string">"./input_uvc.so"</span></span> -o <span class="hljs-string"><span class="hljs-string">"./output_http.so -w ./www"</span></span></code> </pre><br>  Now, by going to http: //: 8080 / we will get access to the camera.  It remains only to make port forwarding on the router and you can access the camera outside the local network. <br><br><h5>  Create timelapse video </h5><br>  The first thing we need to get the image from the camera.  Since  she is already busy (image is being transmitted by the web server), then we will use the opportunity to get the current image from the web server: <br><pre> <code class="bash hljs">curl http://localhost:8080/?action=snapshot &gt; out.jpg</code> </pre><br>  In case we want to draw the date of the image on the image, then we can use the convert command <br><pre> <code class="bash hljs">timestamp=`<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span> -c %y out.jpg` convert out.jpg -fill black -fill white -pointsize 15 -draw <span class="hljs-string"><span class="hljs-string">"text 5,15 '</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${timestamp:0:19}</span></span></span><span class="hljs-string">'"</span></span> out_.jpg</code> </pre><br>  <b>Full version of the script:</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash filename=$(perl -e "print time") foldername=$(date --rfc-3339=date) curl http://localhost:8080/?action=snapshot &gt; $filename timestamp=`stat -c %y $filename` mkdir /mnt/dav/out/$foldername convert $filename -fill black -fill white -pointsize 15 -draw "text 5,15 '${timestamp:0:19}'" /mnt/dav/out/$foldername/$filename.jpg rm $filename</span></span></code> </pre><br>  The video is compiled by the avconv command: <br><pre> <code class="bash hljs">avconv -r 10 -i %06d.jpg -r 10 -vcodec mjpeg -qscale 1 out.avi</code> </pre><br>  <strong>Full version of the video build script:</strong> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash filename=$(date --rfc-3339=date) i=0 for f in `ls -tr /mnt/dav/out/$filename/*.jpg 2&gt;/dev/null` do newf=`printf %06d $i`.jpg echo $f "--&gt;" $newf mv $f $newf i=$((i+1)) done rmdir -R /mnt/dav/out/$filename/ avconv -r 10 -i %06d.jpg -r 10 -vcodec mjpeg -qscale 1 /mnt/dav/$filename.avi rm *.jpg</span></span></code> </pre><br>  Now it remains only to register the execution of scripts in the Cron scheduler: <br><pre> <code class="bash hljs">* * * * * pi bash /home/pi/cam.sh 59 23 * * * pi bash /home/pi/build.sh</code> </pre><br><br><h5>  Video example </h5><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/czgNSoDY7gY%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700253&amp;usg=ALkJrhigAtdebeCUfadqMFSOby_n1RmFjg" frameborder="0" allowfullscreen=""></iframe><br><br><h5>  Conclusion </h5><br>  This approach helps to get rid of the need to spend a large amount of time watching videos, and also reduces the cost of the final product.  Due to the presence of a full-fledged OS, it is possible to expand the functionality in the right direction. <br><br>  PS Unfortunately to publish in the hubs ¬´DIY or DIY, Iron, Gadgets.  Devices for geeks "did not have enough karma, chose the most accessible. </div><p>Source: <a href="https://habr.com/ru/post/208058/">https://habr.com/ru/post/208058/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208044/index.html">Computer game "Noosphere" - suggestions for the scenario for the first levels</a></li>
<li><a href="../208048/index.html">Imperceptible difficulties of rocket technology</a></li>
<li><a href="../208050/index.html">COOLRF: recent history. Part one</a></li>
<li><a href="../208052/index.html">We collect the Shark under iOS and OSX</a></li>
<li><a href="../208056/index.html">Authentication in Rails applications using Devise. Part 1: Basic Setup</a></li>
<li><a href="../208060/index.html">The true causes of blocking sites. Open Data Survey</a></li>
<li><a href="../208066/index.html">Another Enums implementation for Python</a></li>
<li><a href="../208068/index.html">The device is minimalistic landing pages</a></li>
<li><a href="../208070/index.html">A brief conference guide for game developers</a></li>
<li><a href="../208072/index.html">Today is 5 years since the launch of Bitcoin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>