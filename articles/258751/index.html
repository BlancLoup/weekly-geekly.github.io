<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DevOps Zoo or like 500px serves more than 500TB images</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: I chose this article to be translated as a vivid example of a developing Western startup with features pronounced for this group:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DevOps Zoo or like 500px serves more than 500TB images</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  From the translator: I chose this article to be translated as a vivid example of a developing Western startup with features pronounced for this group: a lot of new technologies, the use of a large number of third-party services, experiments with architecture.  The article touched upon particularly interesting topics related to building a platform from microservices, DevOps and very little covered phenomenon on Habr√© called ChatOps.  Enjoy! </blockquote><br><br><h2>  About 500px </h2><br>  500px is an online community formed around a photo.  Millions of users from all over the world are browsing, sharing, selling and buying the most beautiful photos.  We appreciate the design, the simplicity of the code and responsibility. <br>  I am DevOps.  At 500px, I work on a platform: backend, monitoring, configuration management, automation, and of course, system deployment. <br><a name="habracut"></a><br><br><h2>  Development </h2><br>  In 500px, the development team is divided into 4 groups: Web, Mobile Applications, Quality and Testing, and of course our team is responsible for the platform and architecture, which deals with the design of the API and backend, including infrastructure management in general. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our teams are quite multifunctional and the boundaries between them are almost blurred, so that developers freely move from one team to another to work with different technologies that are interesting for them.  It is very helpful to easily spread knowledge inside the team and prevent stagnation.  Moreover, there is a very close connection between the development and design teams, which allows us to be flexible, honest and focus on the really important things. <br><br><img src="https://habrastorage.org/files/6f7/aad/28e/6f7aad28e8a24505b1633716fd8010f4.jpg"><br><br><h2>  Architecture </h2><br>  The 500px architecture can be represented as a huge <a href="http://stackshare.io/rails">Ruby on Rails</a> monolith surrounded by a whole constellation of microservices.  Rails is responsible for the web and the API, which in turn serves mobile applications and all of our client APIs. <br><br>  Microservices provide various functionalities for the main monolith application, and also process some API requests directly. <br><br>  Rails is a fairly standard monolith: the application and the API serve requests using <a href="http://stackshare.io/unicorn">Unicorn</a> , followed by <a href="http://stackshare.io/nginx">Nginx</a> .  We have whole clusters of these Rails servers, which stand for either <a href="http://stackshare.io/haproxy">HAProxy</a> or LVS balancers.  The main databases that the main Rails application works with are <a href="http://stackshare.io/mysql">MySQL</a> , <a href="http://stackshare.io/mongodb">MongoDB</a> , <a href="http://stackshare.io/redis">Redis,</a> and <a href="http://stackshare.io/memcached">Memcached</a> .  We also have a bunch of <a href="http://stackshare.io/sidekiq">Sidekiq</a> servers for heavy tasks running in the background.  At the moment, all this is hosted on its own hardware in the data center. <br><br>  Microservices are more interesting.  At the moment we have about 10 types of them, each of which is focused on providing a separate and independent business logic platform.  Some of the microservices are: <br><ul><li>  Search for similar content, powered by <a href="http://stackshare.io/elasticsearch">Elasticsearch</a> </li><li>  Service responsible for receiving / saving images, <a href="http://stackshare.io/amazon-s3">AWS S3</a> </li><li>  User activity feeds working on <a href="https://github.com/soundcloud/roshi">Roshi</a> and <a href="http://stackshare.io/amazon-kinesis">AWS Kinesis</a> </li><li>  Dynamic compression of images and adding watermark </li><li>  Specialized APIs for our web and mobile applications. </li></ul><br><br>  Microservices work both on <a href="http://stackshare.io/amazon-ec2">Amazon EC2</a> and on their hardware in the data center.  They are mostly written in <a href="http://stackshare.io/go">Go</a> , but there are exceptions to <a href="http://stackshare.io/node-js">NodeJS</a> or <a href="http://stackshare.io/sinatra">Sinatra</a> .  In fact, regardless of the language, we try to create our microservices with good <a href="http://habrahabr.ru/post/258739/">12-factor applications</a> that reduce the complexity of deployment and configuration management.  All these services work either for HAProxy or for AWS Elastic Load Balancers. <br><br><img src="https://habrastorage.org/files/379/3f9/5d9/3793f95d973c47fa830c369dabf82421.jpg"><br><br>  The use of microservices helps a lot, making it possible to avoid difficulties by taking the logic out of the main application.  All you need to know the front-end development team using these services is only an API.  And if something needs to be changed in one of the components, this is easy to do.  For example, it is very simple to use microservice search, not knowing anything about ElasticSearch.  This flexibility has proven its worth as we develop our platform because it allows us to try new technologies in a safe, isolated way.  If you are interested in using microservices, then a former 500px developer <a href="https://twitter.com/paulosman">Paul Osman</a> last year at QConSF <a href="http://www.infoq.com/presentations/500px-services">spoke about our experience of migrating from a large monolith to microservices</a> <i>(from a translator: very interesting, I advise you to look)</i> . <br><br><h2>  Image processing </h2><br>  Perhaps the most interesting of the microservices that we use at 500px is the processing and maintenance of images.  Every month we absorb millions of high quality photos from our community and give out terabytes of picture traffic from the main CDN, <a href="http://stackshare.io/edgecast">Edgecast</a> .  Last month, we gave about 569TB of traffic, and the 95th percentile of the bandwidth was about 2308Mbps.  People really like to watch beautiful pictures! <br><br><img src="https://habrastorage.org/files/2d5/d08/99b/2d5d0899b6564fdd8b8ae0e64f23fa51.jpg" alt="500px hometown, Toronto"><br><br>  To save and distribute graphic content, there are 3 groups of microservices in EC2, all built around S3 where we store all our pictures.  All of them are written in Go and we really liked using Go for such things, because it allows us to write small but very fast multi-threaded services.  And that means we can place them on a smaller number of machines, keeping the hosting account under control. <br><br>  Visitors encounter the first microservice when they upload photos - we call it Media Service.  The Media Service is quite simple: it takes the load, saves it to S3, and then simply adds the task to the <a href="http://stackshare.io/rabbitmq">RabbitMQ</a> queue for further processing. <br><br>  Next, accepting tasks from RabbitMQ is the second microservice, named Converter.  The Conversion service downloads the original image from S3, produces a certain number of treatments for generating thumbnails of various sizes and again saves them in S3.  We use these miniatures in different places: both on the site and in mobile applications. <br><br>  All this is probably not surprising for the photo-sharing service, and for some time these two microservices coped with all our tasks - we just made S3 storage with thumbnails the source for our CDN.  However, with the growth of the entire system, this solution was not only expensive and inefficient in terms of disk space usage, but also not flexible enough in cases when new products were added that require different image sizes. <br><br>  To solve this problem, we recently created the Image Generation Service (and yes, we tend to choose visual names for such things).  This new service works for CDN, dynamically generating an image of any size or format from the S3 original on the fly.  He also knows how to impose watermarks or symbolism of the photographer, which is especially pleasing to our community. <br><br>  The Image Generation Service is fairly high load, the cluster processes about 1000 requests / second during peak hours.  Dynamic regeneration and watermarking is a resource-intensive process; maintaining a reasonable response time under high load is not an easy task.  We worked hard on this problem, and at the peak of visits, we are able to maintain a 95-percentile return time of content below 180ms.  This was made possible with a cool and fast <a href="http://www.vips.ecs.soton.ac.uk/index.php%3Ftitle%3DVIPS">VIPS</a> image processing library, aggressive caching, and simply crazy optimizations.  Outside rush hours, the normal return time for images below 150ms. <br><br>  And we are not resting on our laurels!  Almost certainly, many more optimizations will be found, we hope to more and more reduce the time of return of pictures in the future. <br><br><h2>  The working process </h2><br>  We use <a href="http://stackshare.io/github">GitHub</a> and practice continuous integration ( <abbr title="Continuous integration">CI</abbr> ) for all of our main repositories. <br><br>  For monolith Rails, we use <a href="http://stackshare.io/semaphore">Semaphore</a> and <a href="http://stackshare.io/code-climate">Code Climate</a> , the standard rspec unit configuration for testing and a small number of Capybara / Selenium tests for integration testing.  Our 500px employee and just a cool guy <a href="http://devonoel.com/">Devon Noel de Tilly</a> <a href="https://semaphoreci.com/blog/2014/09/29/inside-development-at-500px.html">described in detail</a> how we use these tools, so I will not stop here. <br><br>  For our Go microservices we use <a href="http://stackshare.io/travisci">Travis CI</a> for tests and for building Debian packages.  Travis after the build loads the collected packages into the temporary S3 repository, after which another microservice downloads them, signs them and imports them into our own Apt repository.  To create packages, we use <a href="http://stackshare.io/fpm">FPM</a> , <a href="http://stackshare.io/aptly">Aptly</a> - to manage our repositories.  I recently tried <a href="http://stackshare.io/packagecloud-io">packagecloud.io</a> for these tasks and I really liked it, so maybe we will switch to it in the near future. <br><br>  For deployment, we use a whole group of tools.  At the lowest level, we use <a href="http://stackshare.io/ansible">Ansible</a> and <a href="http://stackshare.io/capistrano">Capistrano</a> , <a href="http://stackshare.io/chef">Chef</a> - for configuration management.  At a higher level, we at 500px really liked the <a href="https://speakerdeck.com/jnewland/chatops-at-github">ChatOps</a> practice, so we scripted all of our scripts to use these tools in the always-true <a href="http://stackshare.io/hubot">Hubot</a> bot, which was called <a href="http://adventuretime.wikia.com/wiki/BMO">BMO</a> . <br><img src="https://habrastorage.org/files/c23/cd2/75d/c23cd275def44e73a2522303a5d0f474.gif"><br><br>  Each 500px can easily expand a site or microservice with a chat message: <br><br><pre><code class="bash hljs">bmo deploy &lt;microservice name&gt;</code> </pre> <br>  BMO arrives, deploit / unfolds what they asked for and sends the log back to the chat!  This simple and easy mechanism simply worked wonders to improve the visibility of the process and reduce the complexity around application deployment.  We use <a href="http://stackshare.io/slack">Slack</a> chat where we communicate with BMO.  If you need to find a specific log or you have forgotten a command, just start a chat search.  Magic! <br><br><h2>  Other important tools </h2><br>  We monitor everything with the help of <a href="http://stackshare.io/new-relic">New Relic</a> , <a href="http://stackshare.io/datadog">Datadog</a> , ELK ( <a href="http://stackshare.io/elasticsearch">Elasticsearch</a> , <a href="http://stackshare.io/logstash">Logstash</a> , <a href="http://stackshare.io/kibana">Kibana</a> ), and good old <a href="http://stackshare.io/nagios">Nagios</a> .  We send all our mail using <a href="http://stackshare.io/mandrill">Mandrill</a> and <a href="http://stackshare.io/mailchimp">Mailchimp</a> , all payments are processed by <a href="http://stackshare.io/stripe">Stripe</a> and <a href="http://stackshare.io/paypal">Paypal</a> .  Help us make decisions <i>(note translator: BigData and analytics)</i> <a href="http://stackshare.io/amazon-emr">Amazon Elastic MapReduce</a> , <a href="http://stackshare.io/amazon-redshift">Amazon Redshift,</a> and <a href="http://stackshare.io/periscope">Periscope.io</a> .  We use <a href="http://stackshare.io/slack">Slack</a> , <a href="http://stackshare.io/asana">Asana</a> , <a href="http://stackshare.io/everhour">Everhour</a> and <a href="http://stackshare.io/google-apps">Google Apps</a> to communicate and synchronize teams.  And when something goes wrong, we have <a href="http://stackshare.io/pagerduty">Pagerduty</a> and <a href="http://stackshare.io/statuspage-io">Statuspage.io</a> to keep our users up to date. <br><br><h2>  What's next? </h2><br>  Right now I am experimenting with the launch of our microservice constellation in <a href="http://stackshare.io/docker">Docker</a> containers as a personal development environment (docker-compose up), with an eye to using them in production in the future.  We have a <abbr title="Continuous integration">CI</abbr> process established with Travis and Docker Hub, and I really love the potential of cloud container services such as Joyent Triton and <a href="http://stackshare.io/amazon-ec2-container-service">Amazon ECS</a> .  As we build more and more microservices and expand our architecture, we also look towards tools for distributed systems like <a href="http://stackshare.io/consul">Consul</a> and <a href="http://stackshare.io/mesos">Apache Mesos</a> - all this will allow us to grow better and faster! </div><p>Source: <a href="https://habr.com/ru/post/258751/">https://habr.com/ru/post/258751/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258729/index.html">Registration is now open for the third annual championship for developers of the Russian Developers Cup</a></li>
<li><a href="../258731/index.html">Google WebFonts and FontFaceObserver. Use third-party fonts on your website</a></li>
<li><a href="../258735/index.html">Secure SSL / TLS Russian Internet Banking</a></li>
<li><a href="../258739/index.html">Twelve Factor App - The Twelve-Factor App</a></li>
<li><a href="../258745/index.html">New data center Rackspace in the UK: photo tour and features of the new DC</a></li>
<li><a href="../258753/index.html">"Under the hood" Netflix: An analysis of world cinema</a></li>
<li><a href="../258755/index.html">China plans to invest $ 182 billion to modernize the Internet</a></li>
<li><a href="../258767/index.html">Why PHP is out of date</a></li>
<li><a href="../258769/index.html">Phalcon 2.0.2 release</a></li>
<li><a href="../258771/index.html">RuCTF 2015: tank battles "white hackers"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>