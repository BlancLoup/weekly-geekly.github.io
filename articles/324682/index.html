<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Go Web Application Profiling and Optimization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, my name is Pavel Murzakov, I am a developer on the Features team in Badoo. It is important for us that our services consume as little resources as...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Go Web Application Profiling and Optimization</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/219/b94/9f8/219b949f8a7e4b51a8a3b9c7734361e5.png" alt="enter image description here"></p><br><p>  <em>Hi, my name is Pavel Murzakov, I am a developer on the Features team in Badoo.</em>  <em>It is important for us that our services consume as little resources as possible, since each additional server costs money.</em>  <em>Therefore, we often profile and optimize the code.</em>  <em>Part of our demons is written in Go, with the optimization of the code on which I had to <a href="https://www.youtube.com/watch%3Fv%3DuO268voCGwA">work lately</a> .</em>  <em>Fortunately, the standard Go library has many ready-made tools for this.</em> </p><br><p>  <em>Recently I came across this article, which collected information about many tools and a specific example shows how to start using them.</em>  <em>In addition, it has some good recipes for writing effective code.</em>  <em>This information will be useful to any novice Go-developer (more advanced will also be able to find something for themselves), so I made a translation for you.</em>  <em>Enjoy!</em> </p><a name="habracut"></a><br><p>  Go has a powerful built-in profiler that supports profiling CPU, memory, gorutin and locks. </p><br><h3 id="podklyuchenie-profaylera">  Connecting profiler </h3><br><p> Go provides a low-level API for profiling <a href="https://golang.org/pkg/runtime/pprof/"><code>runtime/pprof</code></a> , but if you are developing a daemon, it‚Äôs more convenient to work with the high-level <a href="http/pprof/"><code>net/http/pprof</code></a> . </p><br><p>  All you need to connect the profiler is to import <code>net/http/pprof</code> ;  Required HTTP handlers will be registered automatically: </p><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> _ <span class="hljs-string"><span class="hljs-string">"net/http/pprof"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hiHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { w.Write([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">"hi"</span></span>)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, hiHandler) http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">":8080"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) }</code> </pre> <br><p>  If your web application uses its own URL router, you must manually register several pprof addresses: </p><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http/pprof"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hiHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { w.Write([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">"hi"</span></span>)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { r := http.NewServeMux() r.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, hiHandler) <span class="hljs-comment"><span class="hljs-comment">//  pprof- r.HandleFunc("/debug/pprof/", pprof.Index) r.HandleFunc("/debug/pprof/cmdline", pprof.Cmdline) r.HandleFunc("/debug/pprof/profile", pprof.Profile) r.HandleFunc("/debug/pprof/symbol", pprof.Symbol) r.HandleFunc("/debug/pprof/trace", pprof.Trace) http.ListenAndServe(":8080", r) }</span></span></code> </pre> <br><p>  That's all.  Run the application, and then use the pprof tool: </p><br><pre> <code class="hljs ruby">go tool pprof [binary] <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8080/debug</span></span><span class="hljs-regexp"><span class="hljs-regexp">/pprof/profile</span></span></code> </pre> <br><p>  One of the biggest advantages of <code>pprof</code> is that, due to its low overhead, it can be used in production without any noticeable performance loss. </p><br><p>  But before we go into the details of <code>pprof</code> , let's look at a real-world example of how you can identify and solve performance problems in Go. </p><br><h3 id="primer-mikroservis-left-pad">  Example: left-pad microservice </h3><br><p>  Suppose you are developing a completely new microservice, which with specified characters complements the specified string from the left edge to the specified length: </p><br><pre> <code class="hljs ruby">$ curl <span class="hljs-string"><span class="hljs-string">"http://127.0.0.1:8080/v1/leftpad/?str=test&amp;len=10&amp;chr=*"</span></span> {<span class="hljs-string"><span class="hljs-string">"str"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"******test"</span></span></span></span>}</code> </pre> <br><p>  The service should collect statistics: the number of incoming requests and the duration of each request.  It is assumed that all collected data is sent to a metric aggregator (for example, <a href="https://github.com/etsy/statsd">StatsD</a> ).  In addition, the service needs to log the request parameters: URL, IP address and User Agent. </p><br><p>  The initial implementation of our example can be <a href="https://github.com/akrylysov/goprofex/tree/v1">found on GitHub</a> . <br>  Compile and run the application: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">go</span></span> build &amp;&amp; ./goprofex</code> </pre> <br><h3 id="izmerenie-proizvoditelnosti">  performance measurement </h3><br><p>  We need to determine how many requests per second our microservice can handle.  This can be done using the ab - <a href="httpd.apache.org/docs/2.4/programs/ab.html">Apache benchmarking tool</a> : </p><br><pre> <code class="hljs swift">ab -k -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> -n <span class="hljs-number"><span class="hljs-number">100000</span></span> <span class="hljs-string"><span class="hljs-string">"http://127.0.0.1:8080/v1/leftpad/?str=test&amp;len=50&amp;chr=*"</span></span> # -k   <span class="hljs-type"><span class="hljs-type">HTTP</span></span>- (<span class="hljs-type"><span class="hljs-type">KeepAlive</span></span>) # -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>    # -n  ,    ab</code> </pre> <br><p>  Not bad, but maybe faster: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Requests</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">per</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">second</span></span>: 22810<span class="hljs-selector-class"><span class="hljs-selector-class">.15</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[#/sec]</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">mean</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">Time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">per</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">request</span></span>: 0<span class="hljs-selector-class"><span class="hljs-selector-class">.042</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ms]</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">mean</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">across</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">all</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">concurrent</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">requests</span></span>)</code> </pre> <br><p>  <em>Note: the measurement was carried out on MacBook Pro Late 2013 (2.6 GHz Intel Core i5, 8 GB, 1600 MHz DDR3, macOS 10.12.3) using Go 1.8.</em> </p><br><h3 id="profilirovanie-cpu">  CPU profiling </h3><br><p>  Run the <code>Apache benchmarking tool</code> again, but with a large number of requests (1 million should be enough).  And at the same time run pprof: </p><br><pre> <code class="hljs ruby">go tool pprof goprofex <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8080/debug</span></span><span class="hljs-regexp"><span class="hljs-regexp">/pprof/profile</span></span></code> </pre> <br><p>  The CPU Profiler runs by default for 30 seconds.  It uses sampling to determine which functions spend most of the CPU time.  Runtime Go stops execution every ten milliseconds and records the current call stack of all working gorutin. </p><br><p>  When <code>pprof</code> goes online, enter <code>top</code> to see the list of features that are most present in the sample as a percentage.  In our case, all these functions are from the standard library and the runtime library (runtime), which is not informative for us: </p><br><pre> <code class="hljs go">(pprof) top <span class="hljs-number"><span class="hljs-number">63.77s</span></span> of <span class="hljs-number"><span class="hljs-number">69.02s</span></span> total (<span class="hljs-number"><span class="hljs-number">92.39</span></span>%) Dropped <span class="hljs-number"><span class="hljs-number">331</span></span> nodes (cum &lt;= <span class="hljs-number"><span class="hljs-number">0.35s</span></span>) Showing top <span class="hljs-number"><span class="hljs-number">10</span></span> nodes out of <span class="hljs-number"><span class="hljs-number">78</span></span> (cum &gt;= <span class="hljs-number"><span class="hljs-number">0.64s</span></span>) flat flat% sum% cum cum% <span class="hljs-number"><span class="hljs-number">50.79s</span></span> <span class="hljs-number"><span class="hljs-number">73.59</span></span>% <span class="hljs-number"><span class="hljs-number">73.59</span></span>% <span class="hljs-number"><span class="hljs-number">50.92s</span></span> <span class="hljs-number"><span class="hljs-number">73.78</span></span>% syscall.Syscall <span class="hljs-number"><span class="hljs-number">4.66s</span></span> <span class="hljs-number"><span class="hljs-number">6.75</span></span>% <span class="hljs-number"><span class="hljs-number">80.34</span></span>% <span class="hljs-number"><span class="hljs-number">4.66s</span></span> <span class="hljs-number"><span class="hljs-number">6.75</span></span>% runtime.kevent <span class="hljs-number"><span class="hljs-number">2.65s</span></span> <span class="hljs-number"><span class="hljs-number">3.84</span></span>% <span class="hljs-number"><span class="hljs-number">84.18</span></span>% <span class="hljs-number"><span class="hljs-number">2.65s</span></span> <span class="hljs-number"><span class="hljs-number">3.84</span></span>% runtime.usleep <span class="hljs-number"><span class="hljs-number">1.88s</span></span> <span class="hljs-number"><span class="hljs-number">2.72</span></span>% <span class="hljs-number"><span class="hljs-number">86.90</span></span>% <span class="hljs-number"><span class="hljs-number">1.88s</span></span> <span class="hljs-number"><span class="hljs-number">2.72</span></span>% runtime.freedefer <span class="hljs-number"><span class="hljs-number">1.31s</span></span> <span class="hljs-number"><span class="hljs-number">1.90</span></span>% <span class="hljs-number"><span class="hljs-number">88.80</span></span>% <span class="hljs-number"><span class="hljs-number">1.31s</span></span> <span class="hljs-number"><span class="hljs-number">1.90</span></span>% runtime.mach_semaphore_signal <span class="hljs-number"><span class="hljs-number">1.10s</span></span> <span class="hljs-number"><span class="hljs-number">1.59</span></span>% <span class="hljs-number"><span class="hljs-number">90.39</span></span>% <span class="hljs-number"><span class="hljs-number">1.10s</span></span> <span class="hljs-number"><span class="hljs-number">1.59</span></span>% runtime.mach_semaphore_wait <span class="hljs-number"><span class="hljs-number">0.51s</span></span> <span class="hljs-number"><span class="hljs-number">0.74</span></span>% <span class="hljs-number"><span class="hljs-number">91.13</span></span>% <span class="hljs-number"><span class="hljs-number">0.61s</span></span> <span class="hljs-number"><span class="hljs-number">0.88</span></span>% log.(*Logger).formatHeader <span class="hljs-number"><span class="hljs-number">0.49s</span></span> <span class="hljs-number"><span class="hljs-number">0.71</span></span>% <span class="hljs-number"><span class="hljs-number">91.84</span></span>% <span class="hljs-number"><span class="hljs-number">1.06s</span></span> <span class="hljs-number"><span class="hljs-number">1.54</span></span>% runtime.mallocgc <span class="hljs-number"><span class="hljs-number">0.21s</span></span> <span class="hljs-number"><span class="hljs-number">0.3</span></span>% <span class="hljs-number"><span class="hljs-number">92.15</span></span>% <span class="hljs-number"><span class="hljs-number">0.56s</span></span> <span class="hljs-number"><span class="hljs-number">0.81</span></span>% runtime.concatstrings <span class="hljs-number"><span class="hljs-number">0.17s</span></span> <span class="hljs-number"><span class="hljs-number">0.25</span></span>% <span class="hljs-number"><span class="hljs-number">92.39</span></span>% <span class="hljs-number"><span class="hljs-number">0.64s</span></span> <span class="hljs-number"><span class="hljs-number">0.93</span></span>% fmt.(*pp).doPrintf</code> </pre> <br><p>  There is a more visual way to solve this problem - the <code>web</code> command.  It generates a call graph in SVG format and opens it in a web browser: </p><br><p><img src="https://habrastorage.org/files/e9d/cbe/bd4/e9dcbebd405d4fb5b3592e087638615d.png" alt="enter image description here"></p><br><p>  From this graph, it is clear that the application spends a significant part of the CPU time on logging and collecting metrics.  Some time is spent on garbage collection. </p><br><p>  Using the <code>list</code> command, you can examine each function in detail, for example, <code>list leftpad</code> : </p><br><pre> <code class="hljs go">(pprof) list leftpad ROUTINE ================= main.leftpad in /Users/artem/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/github.com/akrylysov/goprofex/leftpad.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>ms <span class="hljs-number"><span class="hljs-number">490</span></span>ms (flat, cum) <span class="hljs-number"><span class="hljs-number">0.71</span></span>% of Total . . <span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leftpad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, length </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, char </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">rune</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { . . <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(s) &lt; length { <span class="hljs-number"><span class="hljs-number">20</span></span>ms <span class="hljs-number"><span class="hljs-number">490</span></span>ms <span class="hljs-number"><span class="hljs-number">5</span></span>: s = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(char) + s . . <span class="hljs-number"><span class="hljs-number">6</span></span>: } . . <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s . . <span class="hljs-number"><span class="hljs-number">8</span></span>:}</code> </pre> <br><p>  For those who are not afraid to look at the disassembled code, pprof includes the disasm command, which displays the actual processor instructions: </p><br><pre> <code class="hljs objectivec">(pprof) disasm leftpad ROUTINE ======================== main.leftpad <span class="hljs-number"><span class="hljs-number">20</span></span>ms <span class="hljs-number"><span class="hljs-number">490</span></span>ms (flat, cum) <span class="hljs-number"><span class="hljs-number">0.71</span></span>% of Total . . <span class="hljs-number"><span class="hljs-number">1312</span></span>ab0: GS MOVQ GS:<span class="hljs-number"><span class="hljs-number">0x8a0</span></span>, CX . . <span class="hljs-number"><span class="hljs-number">1312</span></span>ab9: <span class="hljs-built_in"><span class="hljs-built_in">CMPQ</span></span> <span class="hljs-number"><span class="hljs-number">0x10</span></span>(CX), SP . . <span class="hljs-number"><span class="hljs-number">1312</span></span>abd: JBE <span class="hljs-number"><span class="hljs-number">0x1312b5e</span></span> . . <span class="hljs-number"><span class="hljs-number">1312</span></span>ac3: SUBQ $<span class="hljs-number"><span class="hljs-number">0x48</span></span>, SP . . <span class="hljs-number"><span class="hljs-number">1312</span></span>ac7: MOVQ BP, <span class="hljs-number"><span class="hljs-number">0x40</span></span>(SP) . . <span class="hljs-number"><span class="hljs-number">1312</span></span>acc: LEAQ <span class="hljs-number"><span class="hljs-number">0x40</span></span>(SP), BP . . <span class="hljs-number"><span class="hljs-number">1312</span></span>ad1: MOVQ <span class="hljs-number"><span class="hljs-number">0x50</span></span>(SP), AX . . <span class="hljs-number"><span class="hljs-number">1312</span></span>ad6: MOVQ <span class="hljs-number"><span class="hljs-number">0x58</span></span>(SP), CX ...</code> </pre> <br><h3 id="profilirovanie-kuchi">  Heap profiling </h3><br><p>  Run the heap profiler: </p><br><pre> <code class="hljs ruby">go tool pprof goprofex <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8080/debug</span></span><span class="hljs-regexp"><span class="hljs-regexp">/pprof/heap</span></span></code> </pre> <br><p>  By default, it shows the amount of memory used: </p><br><pre> <code class="hljs dos">(pprof) top <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB of <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB total ( <span class="hljs-number"><span class="hljs-number">100</span></span>%) Dropped <span class="hljs-number"><span class="hljs-number">85</span></span> nodes (cum &lt;= <span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">56</span></span>kB) Showing top <span class="hljs-number"><span class="hljs-number">10</span></span> nodes out of <span class="hljs-number"><span class="hljs-number">13</span></span> (cum &gt;= <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB) flat flat% sum% cum cum% <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB <span class="hljs-number"><span class="hljs-number">100</span></span>% runtime.mapassign <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB <span class="hljs-number"><span class="hljs-number">100</span></span>% main.leftpadHandler <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB <span class="hljs-number"><span class="hljs-number">100</span></span>% main.timedHandler.func1 <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/http.(*Request).FormValue <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/http.(*Request).ParseForm <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/http.(*Request).ParseMultipartForm <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/http.(*ServeMux).ServeHTTP <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/http.(*conn).serve <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/http.HandlerFunc.ServeHTTP <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">512</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>kB <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/http.serverHandler.ServeHTTP</code> </pre> <br><p>  But we are more interested in the number of objects placed in a pile.  Run <code>pprof</code> with the <code>-alloc_objects</code> option: </p><br><pre> <code class="hljs ruby">go tool pprof -alloc_objects goprofex <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8080/debug</span></span><span class="hljs-regexp"><span class="hljs-regexp">/pprof/heap</span></span></code> </pre> <br><p>  Almost 70% of all objects were created by two functions - <code>leftpad</code> and <code>StatsD.Send</code> .  We study them in more detail: </p><br><pre> <code class="hljs dos">(pprof) top <span class="hljs-number"><span class="hljs-number">559346486</span></span> of <span class="hljs-number"><span class="hljs-number">633887751</span></span> total (<span class="hljs-number"><span class="hljs-number">88</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>%) Dropped <span class="hljs-number"><span class="hljs-number">32</span></span> nodes (cum &lt;= <span class="hljs-number"><span class="hljs-number">3169438</span></span>) Showing top <span class="hljs-number"><span class="hljs-number">10</span></span> nodes out of <span class="hljs-number"><span class="hljs-number">46</span></span> (cum &gt;= <span class="hljs-number"><span class="hljs-number">14866706</span></span>) flat flat% sum% cum cum% <span class="hljs-number"><span class="hljs-number">218124937</span></span> <span class="hljs-number"><span class="hljs-number">34</span></span>.<span class="hljs-number"><span class="hljs-number">41</span></span>% <span class="hljs-number"><span class="hljs-number">34</span></span>.<span class="hljs-number"><span class="hljs-number">41</span></span>% <span class="hljs-number"><span class="hljs-number">218124937</span></span> <span class="hljs-number"><span class="hljs-number">34</span></span>.<span class="hljs-number"><span class="hljs-number">41</span></span>% main.leftpad <span class="hljs-number"><span class="hljs-number">116692715</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>.<span class="hljs-number"><span class="hljs-number">41</span></span>% <span class="hljs-number"><span class="hljs-number">52</span></span>.<span class="hljs-number"><span class="hljs-number">82</span></span>% <span class="hljs-number"><span class="hljs-number">218702222</span></span> <span class="hljs-number"><span class="hljs-number">34</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>% main.(*StatsD).Send <span class="hljs-number"><span class="hljs-number">52326692</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">25</span></span>% <span class="hljs-number"><span class="hljs-number">61</span></span>.<span class="hljs-number"><span class="hljs-number">07</span></span>% <span class="hljs-number"><span class="hljs-number">57278218</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>.<span class="hljs-number"><span class="hljs-number">04</span></span>% fmt.Sprintf <span class="hljs-number"><span class="hljs-number">39437390</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>.<span class="hljs-number"><span class="hljs-number">22</span></span>% <span class="hljs-number"><span class="hljs-number">67</span></span>.<span class="hljs-number"><span class="hljs-number">30</span></span>% <span class="hljs-number"><span class="hljs-number">39437390</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>.<span class="hljs-number"><span class="hljs-number">22</span></span>% strconv.FormatFloat <span class="hljs-number"><span class="hljs-number">30689052</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>.<span class="hljs-number"><span class="hljs-number">84</span></span>% <span class="hljs-number"><span class="hljs-number">72</span></span>.<span class="hljs-number"><span class="hljs-number">14</span></span>% <span class="hljs-number"><span class="hljs-number">30689052</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>.<span class="hljs-number"><span class="hljs-number">84</span></span>% strings.NewReplacer <span class="hljs-number"><span class="hljs-number">29869965</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>.<span class="hljs-number"><span class="hljs-number">71</span></span>% <span class="hljs-number"><span class="hljs-number">76</span></span>.<span class="hljs-number"><span class="hljs-number">85</span></span>% <span class="hljs-number"><span class="hljs-number">29968270</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>.<span class="hljs-number"><span class="hljs-number">73</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/textproto.(*Reader).ReadMIMEHeader <span class="hljs-number"><span class="hljs-number">20441700</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">22</span></span>% <span class="hljs-number"><span class="hljs-number">80</span></span>.<span class="hljs-number"><span class="hljs-number">07</span></span>% <span class="hljs-number"><span class="hljs-number">20441700</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">22</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/url.parseQuery <span class="hljs-number"><span class="hljs-number">19071266</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span>% <span class="hljs-number"><span class="hljs-number">83</span></span>.<span class="hljs-number"><span class="hljs-number">08</span></span>% <span class="hljs-number"><span class="hljs-number">374683692</span></span> <span class="hljs-number"><span class="hljs-number">59</span></span>.<span class="hljs-number"><span class="hljs-number">11</span></span>% main.leftpadHandler <span class="hljs-number"><span class="hljs-number">17826063</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">81</span></span>% <span class="hljs-number"><span class="hljs-number">85</span></span>.<span class="hljs-number"><span class="hljs-number">90</span></span>% <span class="hljs-number"><span class="hljs-number">558753994</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span>.<span class="hljs-number"><span class="hljs-number">15</span></span>% main.timedHandler.func1 <span class="hljs-number"><span class="hljs-number">14866706</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">35</span></span>% <span class="hljs-number"><span class="hljs-number">88</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>% <span class="hljs-number"><span class="hljs-number">14866706</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">35</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/http.Header.clone</code> </pre> <br><p>  Other useful options for solving memory problems are: </p><br><p>  ‚Ä¢ <code>-inuse_objects</code> , showing the number of objects in memory; <br>  ‚Ä¢ <code>-alloc_space</code> , showing how much memory has been allocated since the program started. </p><br><p>  Automatic memory management is convenient, but alas, there is nothing free in the world.  Allocating memory on the heap is not only much slower than the allocation on the stack, but also indirectly affects performance.  Each piece of memory that you allocate in the heap adds work to the garbage collector and forces you to use more processor resources.  The only way to make an application spend less time collecting garbage is to reduce the number of allocations. </p><br><h3 id="escape-analiz">  Escape analysis </h3><br><p>  Whenever you use the <code>&amp;</code> operator to get a pointer to a variable or allocate memory for a new value with <code>make</code> or <code>new</code> , they are not necessarily placed on the heap: </p><br><pre> <code class="hljs go"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { fmt.Println(<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(a)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { foo(<span class="hljs-built_in"><span class="hljs-built_in">make</span></span>([]<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>)) }</code> </pre> <br><p>  In the example above, <code>make([]string, 8)</code> allocates memory on the stack.  Go uses escape analysis to determine if it is safe to allocate memory on the stack instead of a heap.  You can add the <code>-gcflags=-m</code> option to see the results of the escape analysis: </p><br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> X <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> {v <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>} <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x *X)</span></span></span></span> { <span class="hljs-number"><span class="hljs-number">8</span></span> fmt.Println(xv) <span class="hljs-number"><span class="hljs-number">9</span></span> } <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-number"><span class="hljs-number">12</span></span> x := &amp;X{<span class="hljs-number"><span class="hljs-number">1</span></span>} <span class="hljs-number"><span class="hljs-number">13</span></span> foo(x) <span class="hljs-number"><span class="hljs-number">14</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> build -gcflags=-m ./main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">7</span></span>: foo x does not escape ./main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span>: main &amp;X literal does not escape</code> </pre> <br><p>  The Go compiler is smart enough to use the stack instead of allocating memory on the heap in some cases.  But the situation worsens when you start working, for example, with interfaces: </p><br><pre> <code class="hljs haskell">//  <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Fooer</span></span></span><span class="hljs-class"> interface { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foo</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> []</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">) } </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FooerX</span></span></span><span class="hljs-class"> struct{} func (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FooerX</span></span></span><span class="hljs-class">) foo(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> []</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fmt</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Println</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">len</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">)) } func main() { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> := </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">make</span></span></span><span class="hljs-class">([]</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">, 8) // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">make</span></span></span><span class="hljs-class">([]</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">, 8) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">escapes</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">heap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">var</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fooer</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Fooer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fooer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FooerX</span></span></span><span class="hljs-class">{} fooer.foo(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">) } //  2 func foo(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class">{}) string { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">.(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fmt</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stringer</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">() } func main() { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foo</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">make</span></span></span><span class="hljs-class">([]</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">, 8)) // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">make</span></span></span><span class="hljs-class">([]</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">, 8) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">escapes</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">heap</span></span></span><span class="hljs-class"> }</span></span></code> </pre> <br><p>  Dmitry Vyukov‚Äôs article <a href="https://docs.google.com/document/d/1CxgUBPlx9iJzkz9JWkb6tIpTe5q32QDmz8l0BouG0Cw/view">Go Escape Analysis Flaws</a> describes other cases where escape analysis is not good enough to understand whether it is safe to allocate memory on the stack. <br>  In general, for small structures that you do not need to change, it is preferable to use the transfer by value, not by reference. <br>  <em>Note: for large structures it is cheaper to pass the pointer than to copy the entire structure and pass it by value.</em> </p><br><h3 id="profilirovanie-gorutin">  Profiling gorutin </h3><br><p>  When the profiler runs gorutin, we get their call stack and the number of running gorutins: </p><br><pre> <code class="hljs ruby">go tool pprof goprofex <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8080/debug</span></span><span class="hljs-regexp"><span class="hljs-regexp">/pprof/goroutine</span></span></code> </pre> <br><p><img src="https://habrastorage.org/files/be7/a64/39b/be7a6439b8e94e82b032802d055a4e02.png" alt="enter image description here"></p><br><p>  The graph shows only 18 active gorutin, which is very small.  Often you can find thousands of running gorutin without significant performance degradation. </p><br><h3 id="profilirovanie-blokirovok">  Locking Profiling </h3><br><p>  The lock profiler shows where delays occur in the program due to locks caused by synchronization objects such as mutexes and channels. </p><br><p>  Before starting the lock profiler, you need to set the level of profiling using the <a href="https://golang.org/pkg/runtime/">runtime.SetBlockProfileRate</a> function.  You can add its call to your <code>main</code> or <code>init</code> function. </p><br><pre> <code class="hljs ruby">go tool pprof goprofex <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8080/debug</span></span><span class="hljs-regexp"><span class="hljs-regexp">/pprof/block</span></span></code> </pre> <br><p><img src="https://habrastorage.org/files/8f9/c46/e14/8f9c46e14be84c66853d57c01647cf83.png" alt="enter image description here"></p><br><p>  <code>timedHandler</code> and <code>leftpadHandler</code> spend a lot of time on mutexes inside <code>log.Printf</code> .  The reason is that the implementation of the log package uses a mutex to synchronize access to a file shared by several Gortuins. </p><br><h3 id="benchmarking">  Benchmarking </h3><br><p>  As noted above, the biggest offenders in terms of performance are the functions of the <code>log</code> , <code>leftpad</code> and <code>StatsD.Send</code> .  We found a bottleneck.  But before embarking on optimization, it is necessary to develop a reproducible way of measuring the performance of the code of interest.  Such a mechanism is included in the <a href="https://golang.org/pkg/testing/">testing</a> package.  You need to create a function like <code>func BenchmarkXxx(*testing.B</code> ) in the test file: </p><br><pre> <code class="hljs go"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkStatsD</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { statsd := StatsD{ Namespace: <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>, SampleRate: <span class="hljs-number"><span class="hljs-number">0.5</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bN; i++ { statsd.Incr(<span class="hljs-string"><span class="hljs-string">"test"</span></span>) } }</code> </pre> <br><p>  You can also use the <a href="httptest/"><code>net/http/httptest</code></a> to benchmark the entire HTTP handler: </p><br><pre> <code class="hljs go"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkLeftpadHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { r := httptest.NewRequest(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-string"><span class="hljs-string">"/v1/leftpad/?str=test&amp;len=50&amp;chr=*"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bN; i++ { w := httptest.NewRecorder() leftpadHandler(w, r) } }</code> </pre> <br><p>  We start the benchmark: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">go</span></span> test -bench=. -benchmem</code> </pre> <br><p>  It shows the time taken for each iteration, as well as the volume and number of memory allocations: </p><br><pre> <code class="hljs">BenchmarkTimedHandler-4 200000 6511 ns/op 1621 B/op 41 allocs/op BenchmarkLeftpadHandler-4 200000 10546 ns/op 3297 B/op 75 allocs/op BenchmarkLeftpad10-4 5000000 339 ns/op 64 B/op 6 allocs/op BenchmarkLeftpad50-4 500000 3079 ns/op 1568 B/op 46 allocs/op BenchmarkStatsD-4 1000000 1516 ns/op 560 B/op 15 allocs/op</code> </pre> <br><h3 id="povyshenie-proizvoditelnosti">  Productivity increase </h3><br><h4 id="logirovanie">  <em>Logging</em> </h4><br><p>  A good but not always obvious way to make an application faster is to make it work less.  Except for debugging cases, the line <code>log.Printf("%s request took %v", name, elapsed)</code> does not have to be present in our service.  Before deploying the application in production, all unnecessary logs should be removed from the code or disabled.  This problem can be solved using one of the many <a href="https://github.com/avelino/awesome-go">logging libraries</a> . </p><br><p>  Another important thing related to logging (and, in general, with all I / O operations) is the use of possibly buffered I / O, which reduces the number of system calls.  Usually there is no need to write every logger call to the file ‚Äî use <a href="https://golang.org/pkg/bufio/">bufio</a> to implement buffered I / O.  We can simply wrap the io.Writer object <code>io.Writer</code> to the <code>bufio.NewWriter</code> in <code>bufio.NewWriter</code> or <code>bufio.NewWriterSize</code> : </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.SetOutput</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bufio</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.NewWriterSize</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">f</span></span>, 1024*16))</code> </pre> <br><h4 id="leftpad">  <em>leftpad</em> </h4><br><p>  <code>leftpad</code> again to the <code>leftpad</code> function: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">func </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leftpad</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">s </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, length </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rune</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">for</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">len</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">s</span></span></span><span class="hljs-function">) &lt; length</span></span> { s = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) + s } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s }</code> </pre> <br><p>  Concatenation of strings in a loop is not the smartest thing, because each iteration of the loop results in the placement of a new string in memory.  The best way to build a string is to use <a href="https://golang.org/pkg/bytes/"><code>bytes.Buffer</code></a> : </p><br><pre> <code class="hljs go"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leftpad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, length </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, char </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">rune</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { buf := bytes.Buffer{} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; length-<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(s); i++ { buf.WriteRune(char) } buf.WriteString(s) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf.String() }</code> </pre> <br><p>  Alternatively, we can use <a href="https://golang.org/pkg/strings/"><code>string.Repeat</code></a> , which allows us to slightly reduce the code: </p><br><pre> <code class="hljs go"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leftpad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, length </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, char </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">rune</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(s) &lt; length { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> strings.Repeat(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(char), length-<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(s)) + s } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s }</code> </pre> <br><h4 id="statsd">  <em>StatsD</em> </h4><br><p>  The following code snippet that we need to change is the <code>StatsD.Send</code> function: </p><br><pre> <code class="hljs go"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *StatsD)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stat </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, kind </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, delta </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { buf := fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"%s."</span></span>, s.Namespace) trimmedStat := strings.NewReplacer(<span class="hljs-string"><span class="hljs-string">":"</span></span>, <span class="hljs-string"><span class="hljs-string">"_"</span></span>, <span class="hljs-string"><span class="hljs-string">"|"</span></span>, <span class="hljs-string"><span class="hljs-string">"_"</span></span>, <span class="hljs-string"><span class="hljs-string">"@"</span></span>, <span class="hljs-string"><span class="hljs-string">"_"</span></span>).Replace(stat) buf += fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"%s:%s|%s"</span></span>, trimmedStat, delta, kind) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> s.SampleRate != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; s.SampleRate &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> { buf += fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"|@%s"</span></span>, strconv.FormatFloat(s.SampleRate, <span class="hljs-string"><span class="hljs-string">'f'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>)) } ioutil.Discard.Write([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(buf)) <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Write to a socket }</span></span></code> </pre> <br><p>  Here are some possible improvements: </p><br><ol><li><p>  The <code>sprintf</code> function is convenient for formatting strings.  And that's fine if you don't call it thousands of times a second.  It spends CPU time parsing the incoming formatted string and places a new line in memory on each call.  We can replace it with <code>bytes.Buffer</code> + <code>Buffer.WriteString/Buffer.WriteByte</code> . </p><br></li><li><p>  The function does not have to create a new <code>Replacer</code> instance every time; it can be declared as a global variable or as part of the <code>StatsD</code> structure. </p><br></li><li>  Replace <code>strconv.FormatFloat</code> with <code>strconv.AppendFloat</code> and pass it the buffer allocated on the stack.  This prevents additional heap memory allocation. </li></ol><br><pre> <code class="go hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *StatsD)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stat </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, kind </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, delta </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { buf := bytes.Buffer{} buf.WriteString(s.Namespace) buf.WriteByte(<span class="hljs-string"><span class="hljs-string">'.'</span></span>) buf.WriteString(reservedReplacer.Replace(stat)) buf.WriteByte(<span class="hljs-string"><span class="hljs-string">':'</span></span>) buf.Write(strconv.AppendFloat(<span class="hljs-built_in"><span class="hljs-built_in">make</span></span>([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>), delta, <span class="hljs-string"><span class="hljs-string">'f'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>)) buf.WriteByte(<span class="hljs-string"><span class="hljs-string">'|'</span></span>) buf.WriteString(kind) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> s.SampleRate != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; s.SampleRate &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> { buf.WriteString(<span class="hljs-string"><span class="hljs-string">"|@"</span></span>) buf.Write(strconv.AppendFloat(<span class="hljs-built_in"><span class="hljs-built_in">make</span></span>([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>), s.SampleRate, <span class="hljs-string"><span class="hljs-string">'f'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>)) } buf.WriteTo(ioutil.Discard) <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Write to a socket }</span></span></code> </pre><br><p>  This reduces the amount of memory allocation from 14 to one and speeds up the <code>Send</code> call by about four times: </p><br><pre> <code class="hljs">BenchmarkStatsD-4 5000000 381 ns/op 112 B/op 1 allocs/op</code> </pre> <br><h3 id="izmerenie-rezultata">  Result measurement </h3><br><p>  After all the optimizations, the benchmarks show a very good performance increase: </p><br><pre> <code class="hljs pgsql">benchmark <span class="hljs-built_in"><span class="hljs-built_in">old</span></span> ns/op <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ns/op delta BenchmarkTimedHandler<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">6511</span></span> <span class="hljs-number"><span class="hljs-number">1181</span></span> <span class="hljs-number"><span class="hljs-number">-81.86</span></span>% BenchmarkLeftpadHandler<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">10546</span></span> <span class="hljs-number"><span class="hljs-number">3337</span></span> <span class="hljs-number"><span class="hljs-number">-68.36</span></span>% BenchmarkLeftpad10<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">339</span></span> <span class="hljs-number"><span class="hljs-number">136</span></span> <span class="hljs-number"><span class="hljs-number">-59.88</span></span>% BenchmarkLeftpad50<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">3079</span></span> <span class="hljs-number"><span class="hljs-number">201</span></span> <span class="hljs-number"><span class="hljs-number">-93.47</span></span>% BenchmarkStatsD<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">1516</span></span> <span class="hljs-number"><span class="hljs-number">381</span></span> <span class="hljs-number"><span class="hljs-number">-74.87</span></span>% benchmark <span class="hljs-built_in"><span class="hljs-built_in">old</span></span> allocs <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> allocs delta BenchmarkTimedHandler<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">-87.80</span></span>% BenchmarkLeftpadHandler<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">-76.00</span></span>% BenchmarkLeftpad10<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">-50.00</span></span>% BenchmarkLeftpad50<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">-93.48</span></span>% BenchmarkStatsD<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">-93.33</span></span>% benchmark <span class="hljs-built_in"><span class="hljs-built_in">old</span></span> bytes <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> bytes delta BenchmarkTimedHandler<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">1621</span></span> <span class="hljs-number"><span class="hljs-number">448</span></span> <span class="hljs-number"><span class="hljs-number">-72.36</span></span>% BenchmarkLeftpadHandler<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">3297</span></span> <span class="hljs-number"><span class="hljs-number">1416</span></span> <span class="hljs-number"><span class="hljs-number">-57.05</span></span>% BenchmarkLeftpad10<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">-62.50</span></span>% BenchmarkLeftpad50<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">1568</span></span> <span class="hljs-number"><span class="hljs-number">160</span></span> <span class="hljs-number"><span class="hljs-number">-89.80</span></span>% BenchmarkStatsD<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">560</span></span> <span class="hljs-number"><span class="hljs-number">112</span></span> <span class="hljs-number"><span class="hljs-number">-80.00</span></span>%</code> </pre> <br><p>  Note: I used <a href="https://godoc.org/golang.org/x/tools/cmd/benchcmp">benchcmp</a> to compare the results. </p><br><p>  Run <code>ab</code> again: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Requests</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">per</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">second</span></span>: 32619<span class="hljs-selector-class"><span class="hljs-selector-class">.54</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[#/sec]</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">mean</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">Time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">per</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">request</span></span>: 0<span class="hljs-selector-class"><span class="hljs-selector-class">.030</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ms]</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">mean</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">across</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">all</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">concurrent</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">requests</span></span>)</code> </pre> <br><p>  Now the web service can handle about 10,000 additional requests per second! </p><br><h3 id="sovety-po-optimizacii">  Optimization Tips </h3><br><ul><li>  Avoid unnecessary heap allocation. </li><li>  For smaller structures, use parameter passing by value, not by reference. </li><li>  Pre-allocate memory for maps and slices, if you know the size. </li><li>  Do not log needlessly. </li><li>  Use buffered I / O if you perform many consecutive reads or writes. </li><li>  If your application makes extensive use of JSON, then consider using parsers / serializers (I personally prefer easyjson). </li><li>  In hot places, any operation can lead to a significant decrease in performance. </li></ul><br><h3 id="vyvod">  Conclusion </h3><br><p>  Sometimes a bottleneck may not be what you expect.  Therefore, profiling is the best (and sometimes the only) way to find out the real performance of your application. </p><br><p>  You can find the complete source for our example on <a href="https://github.com/akrylysov/goprofex">GitHub</a> .  The initial version is marked as <a href="https://github.com/akrylysov/goprofex/tree/v1">v1</a> , and the optimized version as <a href="https://github.com/akrylysov/goprofex/tree/v2">v2</a> .  Here is a <a href="">link</a> to compare the two versions. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/324682/">https://habr.com/ru/post/324682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324666/index.html">How to develop a product, if there is one developer and two customers in a team?</a></li>
<li><a href="../324668/index.html">JBreak 2017 Java Conference, or Why Charles Nutter Goes to Novosibirsk from Minneapolis</a></li>
<li><a href="../324670/index.html">TOP 10 mistakes in organizing blockchain projects from Gartner Inc</a></li>
<li><a href="../324674/index.html">Intel SGX Extensions Tutorial. Preface and full course content</a></li>
<li><a href="../324680/index.html">Features of the choice of data center for the cloud provider. Regional bias</a></li>
<li><a href="../324684/index.html">How to part with the traditional telephony operator and not lose calls</a></li>
<li><a href="../324686/index.html">Technological stack for classifying natural language texts</a></li>
<li><a href="../324688/index.html">How does imperative programming differ from declarative</a></li>
<li><a href="../324692/index.html">Maintainer's notes: resurrection</a></li>
<li><a href="../324694/index.html">40+ Business Learning Technology Applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>