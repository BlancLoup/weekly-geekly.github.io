<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Embed JSON in Embedded? Easy peasy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, I had the need to load the application configuration with very limited resources. There was practically no access to any standard C f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Embed JSON in Embedded? Easy peasy</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f9a/9e3/f1b/f9a9e3f1bdd12f46d73332a92e22dfc5.png" alt="image"><br><br>  Not so long ago, I had the need to load the application configuration with very limited resources.  There was practically no access to any standard C functions. It was lucky that there were standard <i>malloc () / free ()</i> functions for working with memory. <br><br>  The following situation has developed: the configuration is read from the file when the application is loaded on a system with limited resources.  The configuration itself should be easily edited on a regular computer, to the extent that it will be necessary to quickly correct several values ‚Äã‚Äãdirectly on the object when shown to the customer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      From this we can conclude that it is necessary either: <br><ol><li>  Write your own binary format editor. </li><li>  Use text format. </li></ol><br><a name="habracut"></a><br>  The first option does not suit us due to its limitations and problematic scalability.  If we add several new fields to the structure of a binary file, we need to recompile (at best) and the file editor.  Therefore, we will use the second option. <br><br>  But I didn't want to fence my text format, especially since everything was invented before us.  We are not the first to have a similar problem.  Therefore, we take one of the more or less standard text formats for data storage. <br><br>  There are some to choose from: <br><br><ul><li>  XML </li><li>  Json </li><li>  Yaml </li><li>  INI </li><li>  Lua files (something more advanced than just a config) </li><li>  Files like `key = value` </li></ul><br>  I will say right away that XML disappeared immediately, because for our task it was too redundant.  YAML is an interesting format, but it is still widespread in fairly narrow circles.  Files like `key = value` are too simple.  They are hard enough to store any complex values.  Try to save the exact time with the date in this format, here or write your key (year = ..., month = ..., ..., second = ...) for each value, which is just a parsit, but it looks awful, or write your date parser to the value `date = 2005-08-09T18: 31: 42`.  And if you need to preserve the entity that represents the employee, in which the fields, so, fifty?  For the same reason, INI files are no longer available.  Lua-configs are very interesting and are integrated quite simply, while adding a sea of ‚Äã‚Äãpossibilities.  But, again, I did not want to start a virtual machine for parsing a text file. <br><br>  Therefore, in the end, the choice fell on JSON.  Common enough.  Enough scalable.  Easy to edit and learn (in case you have to edit it for a near specialist). <br><br>  So, we decided on the format, it remains to find the parser of this format absolutely without any dependencies ... so, stop.  The only thing that was found with such a ‚Äúfilter‚Äù is the <a href="https://github.com/zserge/jsmn">jsmn</a> parser.  But the problem is that this is the parser.  It does not form json objects, but only parses the string into tokens.  And if the format of the loaded * .json file is known in advance, then you can simply get all the values.  But stop, if the format of the downloadable file is known in advance, why not use the binary format?  Therefore, imagine that the file format we do not know.  Therefore, quickly write your wrapper over jsmn. <br><br>  This is how the <a href="https://github.com/NeonMercury/jfes">Json For Embedded Systems</a> (JFES) project was born. <br><br><h2>  Main features </h2><br><ul><li>  Compatible with C99 </li><li>  Absolutely no dependencies. </li><li>  Easy to port. </li><li>  Can only be used as a parser. </li></ul><br>  The JFES library is based on two files: jfes.h and jfes.c, and the object around which everything is spinning is jfes_value_t. <br><br><pre><code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/** JSON value structure. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">jfes_value</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">jfes_value_type_t</span></span> type; <span class="hljs-comment"><span class="hljs-comment">/**&lt; JSON value type. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">jfes_value_data_t</span></span> data; <span class="hljs-comment"><span class="hljs-comment">/**&lt; Value data. */</span></span> };</code> </pre> <br>  In turn, the type field can take values: <br><br><pre> <code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/** JFES token types */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> jfes_token_type { jfes_undefined = <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-comment"><span class="hljs-comment">/**&lt; Undefined token type. */</span></span> jfes_null = <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-comment"><span class="hljs-comment">/**&lt; Null token type. */</span></span> jfes_boolean = <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-comment"><span class="hljs-comment">/**&lt; Boolean token type. */</span></span> jfes_integer = <span class="hljs-number"><span class="hljs-number">0x03</span></span>, <span class="hljs-comment"><span class="hljs-comment">/**&lt; Integer token type. */</span></span> jfes_double = <span class="hljs-number"><span class="hljs-number">0x04</span></span>, <span class="hljs-comment"><span class="hljs-comment">/**&lt; Double token type. */</span></span> jfes_string = <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-comment"><span class="hljs-comment">/**&lt; String token type. */</span></span> jfes_array = <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-comment"><span class="hljs-comment">/**&lt; Array token type. */</span></span> jfes_object = <span class="hljs-number"><span class="hljs-number">0x07</span></span>, <span class="hljs-comment"><span class="hljs-comment">/**&lt; Object token type. */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">jfes_token_type_t</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** Json value type is the same as token type. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">jfes_token_type_t</span></span> <span class="hljs-keyword"><span class="hljs-keyword">jfes_value_type_t</span></span>;</code> </pre><br>  And the data field is a union: <br><br><pre> <code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/** JFES value data union. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> jfes_value_data { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bool_val; <span class="hljs-comment"><span class="hljs-comment">/**&lt; Boolean JSON value. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> int_val; <span class="hljs-comment"><span class="hljs-comment">/**&lt; Integer JSON value. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> double_val; <span class="hljs-comment"><span class="hljs-comment">/**&lt; Double JSON value. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">jfes_string_t</span></span> string_val; <span class="hljs-comment"><span class="hljs-comment">/**&lt; String JSON value. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">jfes_array_t</span></span> *array_val; <span class="hljs-comment"><span class="hljs-comment">/**&lt; Array JSON value. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">jfes_object_t</span></span> *object_val; <span class="hljs-comment"><span class="hljs-comment">/**&lt; Object JSON value. */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">jfes_value_data_t</span></span>;</code> </pre><br><h3>  Initialization </h3><br>  To initialize the library, you need to initialize the jfes_config_t object. <br><br><pre> <code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/** JFES config structure. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">jfes_config</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">jfes_malloc_t</span></span> jfes_malloc; <span class="hljs-comment"><span class="hljs-comment">/**&lt; Memory allocation function. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">jfes_free_t</span></span> jfes_free; <span class="hljs-comment"><span class="hljs-comment">/**&lt; Memory deallocation function. */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">jfes_config_t</span></span>;</code> </pre><br>  Remember I said that JFES is completely free of dependencies?  Indeed, she herself cannot even allocate memory, and you will not find a single #include in its source code.  You can specify your memory allocation functions, if you want, for debugging purposes, to check the allocated memory, or because you only have your memory management functions. <br><br><pre> <code class="hljs lua">jfes_config_t <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.jfes_malloc = malloc; <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.jfes_free = free;</code> </pre><br>  Everything!  After that, you can parse the json string as you like.  Any value you can edit, and then save again to the line.  A small example of working with JFES. <br><br>  We will parse this JSON: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"first_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"John"</span></span>, <span class="hljs-string"><span class="hljs-string">"last_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Black"</span></span>, <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">35</span></span>, <span class="hljs-string"><span class="hljs-string">"children"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"first_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Alice"</span></span>, <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> }, { <span class="hljs-string"><span class="hljs-string">"first_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Robert"</span></span>, <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span> }, ], <span class="hljs-string"><span class="hljs-string">"wife"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"simple"</span></span> : [ <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">76</span></span>, <span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">75</span></span>, <span class="hljs-string"><span class="hljs-string">"Test"</span></span>, <span class="hljs-number"><span class="hljs-number">23.1</span></span>, <span class="hljs-number"><span class="hljs-number">65.3</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span> ] }</code> </pre><br>  Parse it using this code: <br><br><pre> <code class="hljs lua">jfes_config_t <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.jfes_malloc = malloc; <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.jfes_free = free; jfes_value_t value; jfes_parse_to_value(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, json_data, json_size, &amp;value); /*     children.    ,  children  JFES_NULL. */ jfes_value_t *children = jfes_get_child(&amp;value, <span class="hljs-string"><span class="hljs-string">"children"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); /*          .  : <span class="hljs-number"><span class="hljs-number">1.</span></span>  . <span class="hljs-number"><span class="hljs-number">2.</span></span>   . <span class="hljs-number"><span class="hljs-number">3.</span></span>    . */ jfes_value_t *child = jfes_create_object_value(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>); /*     <span class="hljs-string"><span class="hljs-string">"Paul"</span></span>      <span class="hljs-string"><span class="hljs-string">"first_name"</span></span>. */ jfes_set_object_property(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, child, jfes_create_string_value(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, <span class="hljs-string"><span class="hljs-string">"Paul"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-string"><span class="hljs-string">"first_name"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); /*      <span class="hljs-string"><span class="hljs-string">"middle_name"</span></span>  <span class="hljs-string"><span class="hljs-string">"age"</span></span>. */ jfes_set_object_property(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, child, jfes_create_string_value(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, <span class="hljs-string"><span class="hljs-string">"Smith"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-string"><span class="hljs-string">"middle_name"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); jfes_set_object_property(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, child, jfes_create_integer_value(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">"age"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); /*    <span class="hljs-number"><span class="hljs-number">2.</span></span>  :       ,    .    ,   . */ jfes_set_object_property(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, child, jfes_create_integer_value(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-string"><span class="hljs-string">"age"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); /*    child  <span class="hljs-string"><span class="hljs-string">"middle_name"</span></span> */ jfes_remove_object_property(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, child, <span class="hljs-string"><span class="hljs-string">"middle_name"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); /*   `child`   `children`   <span class="hljs-number"><span class="hljs-number">1.</span></span> */ <span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = jfes_place_to_array_at(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, children, child, <span class="hljs-number"><span class="hljs-number">1</span></span>); jfes_set_object_property(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, &amp;value, jfes_create_null_value(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>), <span class="hljs-string"><span class="hljs-string">"null_property"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); /*       .  dump_size,  ,     .    -.      <span class="hljs-number"><span class="hljs-number">1</span></span>,  <span class="hljs-number"><span class="hljs-number">0</span></span>,       ,  ,   .. (ugly). */ jfes_size_t dump_size = <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *beauty_dump = malloc(dump_size * sizeof(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>)); jfes_value_to_string(&amp;value, &amp;beauty_dump[<span class="hljs-number"><span class="hljs-number">0</span></span>], &amp;dump_size, <span class="hljs-number"><span class="hljs-number">1</span></span>); beauty_dump[dump_size] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; free(beauty_dump); /*         . */ jfes_free_value(&amp;<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, &amp;value);</code> </pre><br><h2>  Afterword </h2><br>  The library is not perfect, like any other code.  It has errors, shortcomings, typos.  But this is the power of open source.  I will be glad to any pull-request, comments, tickets and wishes. <br><br>  Link to my github: <a href="https://github.com/NeonMercury/jfes">JFES</a> <br><br>  I hope that at least someone it will be useful and save a week of cycling.  As far as my strength and capabilities are concerned, I will refine it.  All nightly commits will be in the experimental branch, the master will be more or less stable and tested code.  The exception will be only for the alpha-stage - as long as the product is alpha, there may be breakdowns of the master branch, but I will try not to break anything and still use experimental as much as possible. <br><br>  Up to version 1.0.0 API may change, be careful.  But the API changes will be written in the commit  ªa description. <br><br>  Thank you so much <a href="https://github.com/zserge">zserge</a> for the <a href="https://github.com/zserge/jsmn">jsmn</a> library. <br><br>  Successes! </div><p>Source: <a href="https://habr.com/ru/post/269383/">https://habr.com/ru/post/269383/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269373/index.html">Zombie code Code that lives its own life</a></li>
<li><a href="../269375/index.html">My cat is about "perfect code"</a></li>
<li><a href="../269377/index.html">Api-platform</a></li>
<li><a href="../269379/index.html">Analysis of options for building telephony based on Microsoft Skype For Business</a></li>
<li><a href="../269381/index.html">Pirate metrics: how to create an AARRR email campaign from Dave McClure. Part 1</a></li>
<li><a href="../269385/index.html">Cache in Drupal from A to Z</a></li>
<li><a href="../269387/index.html">Oracle regular expressions. Dangerous range</a></li>
<li><a href="../269389/index.html">Xamarin.UITest</a></li>
<li><a href="../269391/index.html">ShishNashKi</a></li>
<li><a href="../269393/index.html">Security Week 43: hard prime numbers, cryptography in HDD, Adobe and Oracle patches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>