<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring Jail on FreeBSD 11.1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 I was pushed to write this publication by the fact that there is very little information on Jail administration in FreBSD on the Intern...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring Jail on FreeBSD 11.1</h1><div class="post__text post__text-html js-mediator-article"><h2>  <b>Introduction</b> </h2><br>  I was pushed to write this publication by the fact that there is very little information on Jail administration in FreBSD on the Internet.  You can certainly find excellent publications on this topic, but they are mostly mostly written many years ago, and do not affect the new features of Jail and the FreeBSD operating system itself. <br>  The publication is divided into two parts.  The first part will cover the preparation and configuration of FreeBSD, and the second part will deal directly with the creation of Jail. <br><a name="habracut"></a><br><h2>  <b>Part 1. Preparation and configuration of FreeBSD.</b> </h2><br>  In order for everything that is written here to work correctly, you must use FreeBSD version 11.1, since starting with this version, support for limiting disk I / O, etc., has been included in the system.  If this is not necessary, then version 10.X will do. <br>  Add several parameters to rc.conf: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sysrc</span></span> jail_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> sysrc rctl_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> sysrc rctl_rules=<span class="hljs-string"><span class="hljs-string">"/etc/rctl.conf"</span></span> sysrc zfs_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> sysrc ifconfig_em0_alias=<span class="hljs-string"><span class="hljs-string">"192.168.1.105/24"</span></span></code> </pre> <br>  The first line indicates Jail to start automatically with the system, the second line indicates the inclusion of restrictions for Jail, the third line indicates the rule file with restrictions.  The fourth line activates the ability to use the ZFS file system (all Jail will be saved on ZFS partitions), this parameter is necessary if the system uses the native UFS file system.  You can start ZFS with the command: <br><br><pre> <code class="hljs pgsql">/etc/rc.d/zfs <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre><br>  The fifth line creates an alias for Jail, if several Jails are necessary, then add the necessary number of ip aliases in that case (since I use VMware ESXI the name of the network card is em0 in me, you need to use the name of your card). <br>  In FreeBSD, the kernel is compiled with the ability to limit resources disabled by default, but fortunately this restriction is easy to eliminate, just add one line to the loader.conf file with the command: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs ruby">echo <span class="hljs-string"><span class="hljs-string">'kern.racct.enable="1"'</span></span> <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>/boot/loader.conf</code> </pre><br>  Changes will take effect after the system is rebooted.  It is also necessary to enable support for the iscsi protocol, since the backup will be done through this protocol, you can add support by the following command: <br><br><pre> <code class="hljs ruby">echo <span class="hljs-string"><span class="hljs-string">'iscsi_initiator_load="YES"'</span></span> <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>/boot/loader.conf</code> </pre><br>  Changes will take effect after the system is rebooted. <br>  The last thing you need to configure on the system (except for Jail itself) is the firewall on ipfw.  The following command will create a file with ipfw rules: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ee</span></span> /etc/firewall.sc</code> </pre><br>  The following lines must be entered into this file: <br><br><pre> <code class="hljs sql">ipfw -q -f <span class="hljs-keyword"><span class="hljs-keyword">flush</span></span> c=<span class="hljs-string"><span class="hljs-string">"ipfw -q add "</span></span> $c <span class="hljs-number"><span class="hljs-number">00105</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.105</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> setup <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span>-state $c <span class="hljs-number"><span class="hljs-number">00110</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> me <span class="hljs-number"><span class="hljs-number">22</span></span> setup <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span>-state $c <span class="hljs-number"><span class="hljs-number">00140</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> me <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span>,<span class="hljs-number"><span class="hljs-number">80</span></span>,<span class="hljs-number"><span class="hljs-number">21</span></span>,<span class="hljs-number"><span class="hljs-number">53</span></span>,<span class="hljs-number"><span class="hljs-number">3260</span></span> setup <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span>-state $c <span class="hljs-number"><span class="hljs-number">00143</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> icmp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> me <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span>-state $c <span class="hljs-number"><span class="hljs-number">00144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> udp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> me <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span>-state $c <span class="hljs-number"><span class="hljs-number">40533</span></span> deny all <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> frag $c <span class="hljs-number"><span class="hljs-number">40534</span></span> deny all <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> established $c <span class="hljs-number"><span class="hljs-number">40535</span></span> deny all <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span></code> </pre><br>  These rules will allow all Jail to make outgoing connections through ports 443, 80, 21, 53, 3260 (iscsi), and it will also be possible to connect to all Jail via SSH.  Line: <br><br><pre> <code class="hljs perl">$c <span class="hljs-number"><span class="hljs-number">00105</span></span> allow tcp from any to <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">1.105</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> setup keep-<span class="hljs-keyword"><span class="hljs-keyword">state</span></span></code> </pre><br>  Zack is responsible for connecting to the future Jail, and in particular for the web server, if you need to add other ports, enter them separated by commas (80,21,443,68, etc.).  If you need a udp connection, then you need to copy the line and replace tcp with udp, and change the line number, and remove the setup, since the udp protocol does not have the SYN flag: <br><br><pre> <code class="hljs perl">$c <span class="hljs-number"><span class="hljs-number">00105</span></span> allow tcp from any to <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">1.105</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>,<span class="hljs-number"><span class="hljs-number">21</span></span>,<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">443</span></span> setup keep-<span class="hljs-keyword"><span class="hljs-keyword">state</span></span> $c <span class="hljs-number"><span class="hljs-number">00106</span></span> allow udp from any to <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">1.105</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> keep-<span class="hljs-keyword"><span class="hljs-keyword">state</span></span></code> </pre><br>  Execute the following commands in sequence: <br><br><pre> <code class="hljs pgsql">sysrc firewall_enable="YES" sysrc firewall_script="/etc/firewall.sc" service ipfw <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre><br>  After executing these commands, you will most likely need to reconnect over SSH.  This completes the initial setup, let's move on to the settings of the iscsi target server. <br><br>  <b>Iscsi target setup</b> <br>  To configure, you need another server on the network, or a virtual machine (as in my case). <br>  To configure the iscsi target, we will use ctld (included in FreeBSD), we will add an entry in rc.conf: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sysrc</span></span> ctld_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre><br>  In the next step, you need to create a configuration file for ctld: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ee</span></span> /etc/ctl.conf</code> </pre><br>  Add lines to the created file: <br><br><pre> <code class="hljs pgsql">auth-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> group1 { chap "user" "password1234" } portal-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> pg0 { discovery-auth-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> group1 <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.106</span></span>:<span class="hljs-number"><span class="hljs-number">3260</span></span> } target iqn.iscsi:target1 { <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> "Example target" auth-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> group1 portal-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> pg0 lun <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-type"><span class="hljs-type">path</span></span> /dev/md0 size <span class="hljs-number"><span class="hljs-number">10</span></span>G } }</code> </pre><br>  In the chap line, specify the required name and password (minimum 12 characters).  Title <br>  in the target string must start at iqn.  In the listen line, specify the ip address of the current server.  In the path, specify the path to the disk. <br>  Here is a virtual hard disk, if you use a physical one, then indicate it, and if you want to use a virtual one, then read on.  Navigate to the directory in which you want to create the file for the virtual hard disk and execute the command: <br><br><pre> <code class="hljs javascript">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=<span class="hljs-regexp"><span class="hljs-regexp">/dev/</span></span>zero <span class="hljs-keyword"><span class="hljs-keyword">of</span></span>=disk bs=<span class="hljs-number"><span class="hljs-number">1</span></span>k count=<span class="hljs-number"><span class="hljs-number">10</span></span>m</code> </pre><br>  The count parameter is responsible for the number of gigabytes, in this case a file of 10 gigabytes in size will be created, if you specify a different number, in this case you need to change the LUN 0 parameter in ctl.conf.  Data process takes relatively little time.  After the process is completed, a disk file will be created in the current folder, all that remains is to create a virtual hard disk with the command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mdconfig</span></span> -a -t vnode -f disk</code> </pre><br>  After executing this command, the name of the virtual disk is displayed (in my case - md0), if the name is different, then you also need to change the LUN 0 parameter in ctl.conf.  In order for this disk to not disappear after a reboot, you must run the command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sysrc</span></span> mdconfig_md0=<span class="hljs-string"><span class="hljs-string">"-a -t vnode -f disk"</span></span></code> </pre><br>  Or specify the path to the file: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sysrc</span></span> mdconfig_md0=<span class="hljs-string"><span class="hljs-string">"-a -t vnode -f /home/user/disk"</span></span></code> </pre><br>  There is only one touch left - the firewall.  As on the main system, create the file: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ee</span></span> /etc/firewall.sc</code> </pre><br>  Add lines: <br><br><pre> <code class="hljs sql">ipfw -q -f <span class="hljs-keyword"><span class="hljs-keyword">flush</span></span> c=<span class="hljs-string"><span class="hljs-string">"ipfw -q add "</span></span> $c <span class="hljs-number"><span class="hljs-number">00110</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> me <span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">3260</span></span> setup <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span>-state $c <span class="hljs-number"><span class="hljs-number">00140</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> me <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span>,<span class="hljs-number"><span class="hljs-number">80</span></span>,<span class="hljs-number"><span class="hljs-number">21</span></span>,<span class="hljs-number"><span class="hljs-number">53</span></span>,<span class="hljs-number"><span class="hljs-number">3260</span></span> setup <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span>-state $c <span class="hljs-number"><span class="hljs-number">00143</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> icmp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> me <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span>-state $c <span class="hljs-number"><span class="hljs-number">00144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> udp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> me <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span>-state $c <span class="hljs-number"><span class="hljs-number">40533</span></span> deny all <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> frag $c <span class="hljs-number"><span class="hljs-number">40534</span></span> deny all <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> established $c <span class="hljs-number"><span class="hljs-number">40535</span></span> deny all <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span></code> </pre><br>  After saving the changes, enter: <br><br><pre> <code class="hljs pgsql">sysrc firewall_enable="YES" sysrc firewall_script="/etc/firewall.sc" service ipfw <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre><br>  This completes the iscsi server setup, now proceed to configure it directly Jail. <br><br><h2>  <b>Part 2. Configuring Jail</b> </h2><br>  Beginning with FreeBSD 9, the Jail configuration is moved to a separate file, /etc/jail.conf.  Let's create this file and make the necessary changes, enter the command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ee</span></span> /etc/jail.conf</code> </pre><br>  The following lines must be entered into this file: <br><br><pre> <code class="hljs mel"> allow.raw_sockets = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span>.clean; <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span>.start = <span class="hljs-string"><span class="hljs-string">"/bin/sh /etc/rc"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span>.stop = <span class="hljs-string"><span class="hljs-string">"/bin/sh /etc/rc.shutdown"</span></span>; mount.devfs; allow.set_hostname = <span class="hljs-number"><span class="hljs-number">1</span></span>; allow.sysvipc = <span class="hljs-number"><span class="hljs-number">1</span></span>; jail1 { host.hostname = <span class="hljs-string"><span class="hljs-string">"jail"</span></span>; path = <span class="hljs-string"><span class="hljs-string">"/jails/1/"</span></span>; interface = <span class="hljs-string"><span class="hljs-string">"em0"</span></span>; ip4.addr = <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.105</span></span>; }</code> </pre><br>  After you save the changes, you can start building the Jail environment.  According to this file, one Jail will be used with the name jail1; if it is necessary to use additional Jail, it is enough to change the file view as follows: <br><br><pre> <code class="hljs cs">allow.raw_sockets = <span class="hljs-number"><span class="hljs-number">1</span></span>; exec.clean; exec.start = <span class="hljs-string"><span class="hljs-string">"/bin/sh /etc/rc"</span></span>; exec.stop = <span class="hljs-string"><span class="hljs-string">"/bin/sh /etc/rc.shutdown"</span></span>; mount.devfs; allow.set_hostname = <span class="hljs-number"><span class="hljs-number">1</span></span>; allow.sysvipc = <span class="hljs-number"><span class="hljs-number">1</span></span>; jail1 { host.hostname = <span class="hljs-string"><span class="hljs-string">"jail"</span></span>; path = <span class="hljs-string"><span class="hljs-string">"/jails/1/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> = <span class="hljs-string"><span class="hljs-string">"em0"</span></span>; ip4.addr = <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.105</span></span>; } jail2 { host.hostname = <span class="hljs-string"><span class="hljs-string">"jail"</span></span>; path = <span class="hljs-string"><span class="hljs-string">"/jails/2/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> = <span class="hljs-string"><span class="hljs-string">"em0"</span></span>; ip4.addr = <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.107</span></span>; }</code> </pre><br>  In this publication will be considered the creation of a single Jail.  Create a directory for the future Jail team: <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> -p /jails/<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  To create the environment, you need the ‚Äúsources‚Äù, the easiest way is to install them during the installation process, or use subversion (a rather unpleasant process).  To create an environment, go to the / usr / src directory, with the command: <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src</code> </pre><br>  To create an environment, enter the command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">make</span></span> -j4 world DESTDIR=/jails/<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  The process is quite long, on my system an Intel Core i5 3550 processor is installed, the creation of the environment took about an hour.  In the environment creation command, the -j4 parameter is used, the number indicates the number of cores in the processor; the larger, the faster.  After the environment is created, you need to add configuration files to jail with the command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">make</span></span> distribution DESTDIR=/jails/<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  At the creation of the environment is complete.  Enter the command: <br><br><pre> <code class="hljs pgsql">/etc/rc.d/jail <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre><br>  There is no possibility to connect to the newly created Jail via ssh, since ssh is disabled.  In order to enter jail, run the command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">jexec</span></span> jail1</code> </pre><br>  The first thing to do is add a DNS server, run: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ee</span></span> /etc/resolv.conf</code> </pre><br>  Add a line to the created file: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">nameserver</span></span> 8<span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span></code> </pre><br>  It remains to add an account (add it to the wheel group), create a password for root and run ssh, all this can be done with the commands: <br><br><pre> <code class="hljs pgsql">adduser sysrc sshd_enable="YES" service sshd <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> passwd root</code> </pre><br>  I can recommend installing midnight commander: <br><br><pre> <code class="hljs sql">pkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> mc</code> </pre><br>  During the mc installation, many common dependencies will catch up, such as python, perl.  After performing these manipulations, you must exit this jail with the exit command.  Next, it stops jail: <br><br><pre> <code class="hljs sql">/etc/rc.d/jail <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span></code> </pre><br>  Imagine the situation when you need to create 5 jails, such a task will take a lot of time, but fortunately you can create an archive with the contents of this jail, as well as retain all rights for the files.  The tar archiver will help in this situation.  Go to the directory with jail: <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /jails/<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Run the command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">tar</span></span> -zcvpf jail.tar *</code> </pre><br>  After the archive is created, it must be moved to another directory (this directory will be deleted): <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mv</span></span> jail.tar /jail.tar</code> </pre><br>  Removing the directory / jails will not succeed until the ‚Äúflag‚Äù of ‚Äúimmutability‚Äù is removed from all files: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">chflags</span></span> -R noschg /jails rm -rf /jails/</code> </pre><br>  If something does not go away, then you just need to reboot the system and execute the rm -rf command again.  Let's start creating a virtual hard disk, create a file for the disk: <br><br><pre> <code class="hljs javascript">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=<span class="hljs-regexp"><span class="hljs-regexp">/dev/</span></span>zero <span class="hljs-keyword"><span class="hljs-keyword">of</span></span>=disk bs=<span class="hljs-number"><span class="hljs-number">1</span></span>k count=<span class="hljs-number"><span class="hljs-number">10</span></span>m</code> </pre><br>  And the virtual disk itself: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mdconfig</span></span> -a -t vnode -f disk</code> </pre><br>  Add automatic disk creation: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sysrc</span></span> mdconfig_md0=<span class="hljs-string"><span class="hljs-string">"-a -t vnode -f disk"</span></span></code> </pre><br>  Specify the name of the disk you created (if the name is different), as well as the file path for the virtual disk.  The next step is to automatically connect the drive through iscsi.  For a correct connection to the disk, you must create a configuration file: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ee</span></span> /etc/iscsi.conf</code> </pre><br>  Make the following changes to this file: <br><br><pre> <code class="hljs">iscsi_disk{ authmethod=CHAP chapIName=user1 chapSecret=password1234 initiatorname=nxl TargetName=iqn.iscsi:target1 TargetAddress=192.168.1.106:3260,1 LoginTimeout=10 AuthTimeout=10 IdleTimeout=10 ConnFailTimeout=10 AbortTimeout=10 ResetTimeout=10 }</code> </pre><br>  If the settings in the ctl.conf file are set in accordance with this publication, then the connection will occur correctly.  The only way to automatically connect the drive through iscsi I found only the way the script is placed in rc.d.  Create this script: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ee</span></span> /etc/rc.d/iscsi.sc</code> </pre><br>  Add the following lines: <br><br><pre> <code class="hljs swift">iscontrol -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> /etc/iscsi.conf -n iscsi_disk zfs mount jails/<span class="hljs-number"><span class="hljs-number">1</span></span> /etc/rc.d/jail start</code> </pre><br>  It is necessary to take into account the fact that if you have created another jail, then it must be added to this script (zfs mount jails / 2 for example).  The first line connects the disk via iscsi, the second line mounts the file system (if the local hard disk ‚Äúfalls off‚Äù), the third line starts jail.  It remains only to make the file executable: <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">chmod</span></span> +<span class="hljs-keyword"><span class="hljs-keyword">x</span></span> /etc/rc.d/iscsi.sc</code> </pre><br>  After executing this script, or restarting the system, the remote hard disk will be available for manipulation.  In my cases, the name of the disk is da1, you also need to use the name that you use.  Create a zfs pool of these two disks: <br><br><pre> <code class="hljs pgsql">zpool <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> jails mirror md0 da1</code> </pre><br>  zfs pool will be a mirror, as you might guess from the team. <br>  Create a section for jail: <br><br><pre> <code class="hljs pgsql">zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> jails/<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Let's set a limit for this directory to 5 gigabytes: <br><br><pre> <code class="hljs sql">zfs <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">quota</span></span>=<span class="hljs-number"><span class="hljs-number">5</span></span>g jails/<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Copy the archive from jail to the directory / jails / 1 and move to this directory: <br><br><pre> <code class="hljs dos">cp /jail.tar /jails/<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /jails/<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Unpack this archive and delete it: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-zxvpf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jail</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.tar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jail</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.tar</span></span></code> </pre><br>  Run jail: <br><br><pre> <code class="hljs pgsql">/etc/rc.d/jail <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre><br>  After these manipulations, you can connect to the jail via SSH, as well as install the necessary roles for the server.  It remains only to configure the restrictions for Jail.  In order to configure rctl, you only need to add a configuration file: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ee</span></span> /etc/rctl.conf</code> </pre><br>  Add the following lines to this file: <br><br><pre> <code class="hljs">jail:jail1:memoryuse:deny=1073741824 jail:jail1:readbps:throttle=4097152 jail:jail1:writebps:throttle=4097152 jail:jail1:pcpu:deny=50</code> </pre><br>  The 1st line will limit the use of 1 gigabyte of memory, the 2nd and 3rd lines will limit the use of reading and writing to 4 megabytes of disk, the 4th line will limit the use of each core to 50 percent.  This is not the entire list of restrictions; in the list of sources I will indicate a link to the FreeBSD website where this is described in detail.  After saving this file, you must restart rctl: <br><br><pre> <code class="hljs pgsql">service rctl <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span></code> </pre><br>  The restrictions will take effect in just a few seconds. <br><br><h2>  <b>Additionally</b> </h2><br>  It would be possible to finish this, but a situation may arise such that not the hard disk will fail, but the server itself (for example, it will burn).  In such cases, you can use a disk that is located on a remote server, but you just won't be able to use it, first of all you need to stop the ctld service and enable zfs: <br><br><pre> <code class="hljs sql">service ctld <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> sysrc zfs_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> /etc/rc.d/zfs <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre><br>  After that, enter the command: <br><br><pre> <code class="hljs swift">zpool <span class="hljs-keyword"><span class="hljs-keyword">import</span></span></code> </pre><br>  After executing this command, all possible pools that can be imported are displayed on the screen, in this case the jails pool, and the drive name will be displayed as md0.  In order to mount this pool, you must run the command: <br><br><pre> <code class="hljs swift">zpool <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> -f jails jails</code> </pre><br>  Be sure to specify -f, otherwise zpool will swear that the pool belongs to another server.  If necessary, you can also configure jail on this server using this pool, which in turn will keep idle time to a minimum.  In order to use this disk for iscsi again, you need to disable this pool: <br><br><pre> <code class="hljs objectivec">zpool <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> jails</code> </pre><br>  And also run ctld: <br><br><pre> <code class="hljs pgsql">service ctld <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre><br>  At this point you can finish. <br><br>  The list of sources that have greatly helped in writing this publication: <br>  Michael Lucas FreeBSD.  Detailed guide. <br>  <a href="https://www.freebsd.org/cgi/man.cgi%3Fquery%3Drctl%26sektion%3D8">www.freebsd.org/cgi/man.cgi?query=rctl&amp;sektion=8</a> <br>  <a href="https://www.freebsd.org/doc/ru_RU.KOI8-R/books/handbook/disks-adding.html">www.freebsd.org/doc/ru_RU.KOI8-R/books/handbook/disks-adding.html</a> <br>  <a href="https://docs.oracle.com/cd/E19253-01/820-0836/gavwn/index.html">docs.oracle.com/cd/E19253-01/820-0836/gavwn/index.html</a> <br>  <a href="https://www.freebsd.org/cgi/man.cgi%3Fquery%3Dctl.conf%26sektion%3D5%26apropos%3D0%26manpath%3DFreeBSD%2B11.1-RELEASE%2Band%2BPorts">www.freebsd.org/cgi/man.cgi?query=ctl.conf&amp;sektion=5&amp;apropos=0&amp;manpath=FreeBSD+11.1-RELEASE+and+Ports</a> </div><p>Source: <a href="https://habr.com/ru/post/342312/">https://habr.com/ru/post/342312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342302/index.html">Design Template ‚ÄúMini Scenario with Contradiction Check‚Äù</a></li>
<li><a href="../342304/index.html">Interesting logical puzzles for interviews</a></li>
<li><a href="../342306/index.html">How we played with neural networks</a></li>
<li><a href="../342308/index.html">Future of wikipedia</a></li>
<li><a href="../342310/index.html">Installing Proxmox VE on Debian Stretch using Ansible</a></li>
<li><a href="../342314/index.html">Playing with Nextgen-antivirus from Palo Alto Networks: it injects its dll into executable processes like * .exe</a></li>
<li><a href="../342316/index.html">Actors for fun and profit</a></li>
<li><a href="../342318/index.html">PouchDB or what to do when the ‚Äúinternet is stable‚Äù</a></li>
<li><a href="../342324/index.html">Errors in smart contracts or Parity's new Security Alert</a></li>
<li><a href="../342326/index.html">PVS-Studio report is now in Html format</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>