<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hello android from qt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is about how to make friends languages ‚Äã‚ÄãJava and C ++ in one application for the Android operating system. 

 A huge amount of code is w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hello android from qt</h1><div class="post__text post__text-html js-mediator-article">  This article is about how to make friends languages ‚Äã‚ÄãJava and C ++ in one application for the Android operating system. <br><br>  A huge amount of code is written in C ++.  I would like to somehow use this code in my applications, but for some reason the process of using me caused some discomfort.  Most likely, this was trivially related to the fact that the basis of my working environment is Android Studio, in which working with native code is, let's say, not the best.  But the thought of developing the application comfortably with the native part never left me.  Therefore, I decided to try to cross all the power of the Qt library and an application written in the native Android language - Java. <br><a name="habracut"></a><br>  At the moment, the Qt ecosystem allows you to write an application completely with the tools of this framework, even more - to compile it for a whole set of operating systems, among which is Android.  But moving this way it is very difficult to develop an interface that will look and behave accordingly to the platform guides.  And it becomes impossible to use libraries written in Java for the appearance and behavior of the application.  That is why I would like to try a development model, in which all business logic was written in C ++, and the user interface - using the target platform.  In the future, this will provide a simple transfer of the application to other platforms with an appearance typical of the target system and functionality that has already been tested and deferred. <br><br>  So, further you will find instructions on how to write an application that will have a part written in Qt and a part in Java. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To work, we need the Qt library and ide Qt Creator, configured to work with Android projects (this is quite simple, you can read about it in detail <a href="http://doc.qt.io/qt-5/androidgs.html">here</a> ), <a href="https://developer.android.com/sdk/index.html">Android Studio</a> , as well as <a href="https://developer.android.com/tools/sdk/ndk/index.html">Android ndk</a> . <br><br>  1. First you need to create an android project (let's call it QTtests) and set ‚Äúpenguin.in.flight.qttests‚Äù as the package name.  In the next steps of the project creation wizard, you can choose any settings that are convenient for work.  The main condition for following the instructions is to follow the package name. <br><br><div class="spoiler">  <b class="spoiler_title">Creating a new project in Android Studio</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/4f6/0f2/bc1/4f60f2bc14dd41faa635f9d190b48aa0.png" alt="image"><br></div></div><br>  2. When the Android project is already there, you can forget about it for a while and go on to create the Qt part.  The first step is to create (preferably at the root of the main project) a standard project of the type library.  Give it the name cpp_lib.  When creating a project, you need to select armeabi-v7 as the target platform. <br><br><div class="spoiler">  <b class="spoiler_title">Creating a library</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/d6a/883/88d/d6a88388d52740f2a9b9a37803db58d6.png"><br><img src="https://habrastorage.org/files/5bc/c5f/908/5bcc5f90841f490c8e8a07e983bf793d.png"><br><img src="https://habrastorage.org/files/8ef/d46/305/8efd463055d84fae802f866f881914fb.png"><br></div></div><br>  3. We have a project template, now is the time to write our Hello Word on Qt. <br>  <b>cpp_lib.h</b> <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> CPP_LIB_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CPP_LIB_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cpp_lib_global.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;jni.h&gt; #include &lt;QString&gt; class CPP_LIBSHARED_EXPORT Cpp_lib { public: Cpp_lib(); QString say(QString subject); }; #ifdef __cplusplus extern "C" { #endif JNIEXPORT jstring JNICALL Java_penguin_in_flight_qttests_utils_JavaNatives_sayHello(JNIEnv *env, jobject obj); #ifdef __cplusplus } #endif #endif // CPP_LIB_H</span></span></span></span></code> </pre> <br>  <b>cpp_lib.cpp</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cpp_lib.h"</span></span></span><span class="hljs-meta"> Cpp_lib::Cpp_lib() { } QString Cpp_lib::say(QString subject) { QString result = QString(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Qt say \" %1 \""</span></span></span><span class="hljs-meta">).arg(subject); return result; } JNIEXPORT jstring JNICALL Java_penguin_in_flight_qttests_utils_JavaNatives_sayHello(JNIEnv *env, jobject obj){ Cpp_lib *lib = new Cpp_lib(); return env-&gt;NewStringUTF(lib-&gt;say(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Hello android!!!"</span></span></span><span class="hljs-meta">).toLatin1().data()); }</span></span></code> </pre><br>  As you can see by the code, the application will be very simple.  It contains two functions - say and Java_penguin_in_flight_qttests_utils_JavaNatives_sayHello.  The first is simple and straightforward.  They take an object as input, which is a text string in the framework, and returns a new string.  Much more interesting is the following function.  In it, JNIEXPORT and JNICALL mean that it can be called from code written in Java.  As a return type, it has a jstring (which is available to us thanks to this #include &lt;jni.h&gt;).  This type is a String type in Java. <br><br>  In conclusion, analyze the method arguments.  * env is a reference to the structure that contains the methods necessary for working with java entities, and obj is the object that called the method. <br><br>  3. After the code is written, you need to make sure that our library is correctly assembled and we can use it in our projects.  To do this, we need to remove this line TEMPLATE = lib in the project settings file (in our case, it is cpp_lib.pro).  If this is not done then during assembly we will get an error like this: <br><br>  Internal Error: Could not find .pro file. <br>  Error while building / deploying project cpp_lib (kit: Android for armeabi-v7a (GCC 4.9, Qt 5.4.1)) <br>  When executing step "Build Android APK" <br><br>  4. Next, you need to make Qt Creator compile the library at the following address: {path_to_project} / QTtests / app / src / main / qt_output: <br><br><div class="spoiler">  <b class="spoiler_title">Setting the build folder</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a37/b8a/21c/a37b8a21cef24105b69517abc56858af.png"><br></div></div><br><br>  5. In the same place where we indicated the place of assembly, you need to check the application‚Äôs build settings.  Namely - the target assembly platform.  You need to choose the latter (I have this android 22).  Next, tick the Build Qt libraries in APK.  This is necessary for the build system to generate all the necessary libraries.  You also need to tick the Use Gradle box in order for the build system to generate the project of the type you need. <br><br><div class="spoiler">  <b class="spoiler_title">Screenshot of settings</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/de7/023/b5b/de7023b5b33f4e55ae472a51d0cc5031.png"><br></div></div><br><br>  6. Now we can build the library and get all the necessary files. <br><br><div class="spoiler">  <b class="spoiler_title">Build a project</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/3b1/92f/1ac/3b192f1acbfc4be593a4746e4f5ae59c.png"><br></div></div><br><br>  7. On this work with the native library ends.  We are coming back to Android studio.  The first thing to do is edit the assembly file to include the Qt library.  To do this, add the following lines in the /QT_tests/app/build.gradle file: <br><br><pre> <code class="java hljs"> sourceSets { main { java.srcDirs += [<span class="hljs-string"><span class="hljs-string">'/src/main/java'</span></span>] res.srcDirs += [<span class="hljs-string"><span class="hljs-string">'src/main/res'</span></span>,<span class="hljs-string"><span class="hljs-string">'src/main/qt_output/android-build/res'</span></span>] jniLibs.srcDirs += <span class="hljs-string"><span class="hljs-string">'src/main/qt_output/android-build/libs'</span></span> } }</code> </pre><br>  src / main / qt_output / android-build / res is needed in order to have access to the resources in which the build system has registered the names of the libraries on which the main Qt project depends.  The src / main / qt_output / android-build / libs path points to the location of the library files themselves. <br><br>  We also modify the dependency block as follows: <br><br><pre> <code class="java hljs">dependencies { <span class="hljs-function"><span class="hljs-function">compile </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fileTree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dir: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'libs'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, include: [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'*.jar'</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> compile </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">files</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'src/main/qt_output/android-build/libs/QtAndroid-bundled.jar'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> compile </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">files</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'src/main/qt_output/android-build/libs/QtAndroidAccessibility-bundled.jar'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//  }</span></span></span></span></code> </pre><br><br>  8. Now we have a library meeting and they are even connected to the project.  Next you need to connect them during the start of the program itself.  For this we will use the following class: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> penguin.in.flight.qttests.utils; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Context; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.util.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> penguin.in.flight.qttests.R; <span class="hljs-comment"><span class="hljs-comment">/** * Created on 11.04.15. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JavaNatives</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sayHello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ load(context, R.array.bundled_in_assets); load(context, R.array.qt_libs); System.loadLibrary(<span class="hljs-string"><span class="hljs-string">"cpp_lib"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arrayResourceId)</span></span></span><span class="hljs-function"> </span></span>{ String[] libsToLoad = context.getResources().getStringArray(arrayResourceId); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String lib : libsToLoad) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lib.indexOf(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) &gt; -<span class="hljs-number"><span class="hljs-number">1</span></span>) { lib = lib.substring(lib.indexOf(<span class="hljs-string"><span class="hljs-string">'/'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lib.indexOf(<span class="hljs-string"><span class="hljs-string">"lib"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { lib = lib.substring(<span class="hljs-number"><span class="hljs-number">3</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lib.endsWith(<span class="hljs-string"><span class="hljs-string">".so"</span></span>)) { lib = lib.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, lib.length() - <span class="hljs-number"><span class="hljs-number">3</span></span>); } Log.i(JavaNatives.class.getSimpleName(), <span class="hljs-string"><span class="hljs-string">"loading "</span></span> + lib); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { System.loadLibrary(lib); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable e) { Log.i(JavaNatives.class.getSimpleName(), <span class="hljs-string"><span class="hljs-string">"failed to load "</span></span> + lib + <span class="hljs-string"><span class="hljs-string">" "</span></span> + e); e.printStackTrace(); } Log.i(JavaNatives.class.getSimpleName(), <span class="hljs-string"><span class="hljs-string">"Successfully loaded "</span></span> + lib); } } }</code> </pre><br>  As you can see from the code, the class is in the package penguin.in.flight.qttests.utils and is called JavaNatives.  This is important in order to provide a connection between the code that we wrote in the native part.  To understand how, let's recall a method called Java_penguin_in_flight_qttests_utils_JavaNatives_sayHello.  Its name consists of the prefix Java_, then comes the name of the package, where the names of sub packets are separated by the symbol "_" (penguin_in_flight_qttests_utils).  Next comes the class name and, finally, the name of the method.  More information about the naming of methods in native code can be found <a href="https://en.wikipedia.org/wiki/Java_Native_Interface">here</a> . <br><br>  9. To use the class we wrote in onCreate in the start-up, you need to insert this line: <br><br><pre> <code class="java hljs">JavaNatives.init(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre><br>  10. Now it remains only to use what we have written.  To do this, add a button and in the processing of clicking on it we insert the following code: <br><br><pre> <code class="java hljs">AlertDialog.Builder dialog = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AlertDialog.Builder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); dialog.setMessage(JavaNatives.sayHello()); dialog.setPositiveButton(<span class="hljs-string"><span class="hljs-string">"Ok"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); dialog.show();</code> </pre><br>  On this, instructions for using the native part, written in Qt in Android applications, are over. <br><br>  Thank you all for your attention, the entire sample code is available on <a href="https://github.com/Braiko/Qt_Android">github.com</a> . </div><p>Source: <a href="https://habr.com/ru/post/255597/">https://habr.com/ru/post/255597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255585/index.html">Daniil Dubrovkin: ‚ÄúBecause they don‚Äôt write open source, they didn‚Äôt become bad engineers‚Äù</a></li>
<li><a href="../255587/index.html">Attention! Phishing of registration data NIC.ru</a></li>
<li><a href="../255591/index.html">Android security report, a contest from Microsoft, a little more about mobile advertising - and other news of the week for a mobile developer</a></li>
<li><a href="../255593/index.html">New data storage technologies: there is enough space for everyone</a></li>
<li><a href="../255595/index.html">How to catch what is not. Part Four: Personal data without an umbrella</a></li>
<li><a href="../255599/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 155 (April 6 - 12, 2015)</a></li>
<li><a href="../255601/index.html">Meet Santoku Linux</a></li>
<li><a href="../255603/index.html">We invite you to the Security Olympiad at MEPhI</a></li>
<li><a href="../255609/index.html">Cloud or VPS? What to choose? Quick Start Guide</a></li>
<li><a href="../255611/index.html">Post Hawk. Reboot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>