<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of its first USB device. A small step forward</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A long time ago, I had a dream to assemble some device, albeit a simple one, but which would perform certain actions under computer control. I am a we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of its first USB device. A small step forward</h1><div class="post__text post__text-html js-mediator-article">  A long time ago, I had a dream to assemble some device, albeit a simple one, but which would perform certain actions under computer control.  I am a web developer by profession, I have no experience in programming microcontrollers, but the topic is interesting.  Soldering skills are also not enough (I don‚Äôt solder different headphones or wiring, of course, but I didn‚Äôt try to solder chips).  Therefore, I decided that it was necessary to start with something simple - for example, on the basis of a ready-made breadboard with a microcontroller. <br><br><h5>  What will be in the post? </h5><br>  In the post I will tell you about my experience in developing my first craft, which controls the LEDs on the board using a program on a computer, and more specifically some kind of volume indicator with a single visualization band. <a name="habracut"></a>  Here is the device: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/c898dc4c/2afca3af/625c9257/705ab138.jpg"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Perhaps it will not be interesting for experienced radio amateurs, but there will probably be those who do not know where to start.  This post I address primarily to people who first want to assemble any device to control it from a computer, without specific tools and necessary materials (such as solder paste, hair dryer) and without the need to draw and etch a printed circuit board.  A design like the one described here can provide a person with a ‚Äúquick start‚Äù so that he can understand what it is and also decide for himself whether he wants to do this business in the future. <br><br><h4>  Search for information </h4><br>  The search for information was supported by an article on Habr√©, <a href="http://habrahabr.ru/blogs/DIY/85892/">Management of a homemade USB-HID LED, using the GUI shell on .NET</a> .  In this post, the author talks about buying a small debugging board AVR-USB-TINY45.  I went through the author's links and found several ready-made debug boards there.  AVR-USB-TINY45, which the author of the above post used, was not enough for my experiences, and AVR-USB162 was too cool for me (the LUFA library is complicated, and I couldn‚Äôt find any examples of host software), so my choice was on the board <a href="http://microsin.ru/content/view/605/44/">AVR-USB-MEGA16</a> with an ATmega32 microcontroller on board. <br><br><h4>  More about buying </h4><br>  The purchase of the AVR-USB-MEGA16 debug board together with the delivery and all the percentages for transferring funds via Webmoney (it turned out that it‚Äôs not so easy to replenish Yandex-Money in Kharkov) cost me ~ 26 USD.  Delivery from Moscow to Kharkov was a bit tight (the parcel was stuck somewhere near Kharkov), but everything soon arrived.  I would like to say a special thank you to microsin.ru - the board was securely packed and protected from impacts. <br><br><h5>  AVR-USB-MEGA16 debug card </h5><br><div style="text-align:center;"><img src="https://habrastorage.org/storage/habraeffect/dc/8c/dc8c3f6f30233baf73a9341791d0a8e0.jpg" alt="AVR-USB-MEGA16 debug card"></div><br>  A detailed description of the board will not be here (who cares, see links).  I can only say that the board already has all the necessary strapping for the microcontroller and USB - that is, you can plug the board into USB, it will be powered from it and the ATmega32 microcontroller will work.  All you need to do is write a program for it (more on that later), and solder some construction to the board‚Äôs mock-up field (8x11 with 2.54 mm pitch).  The board has 22 free I / O ports (mapped to two rows of holes), on which we can hang LEDs. <br><br>  The possibility of flashing a microcontroller on the board using USB was also <b>very important</b> .  Yes, no programmers are needed, only USB, since the ATmega32 already has a USB program loader (how to work with it, written on Habr√©, see links).  For programming and debugging, you can also use the ISP and JTAG interfaces, but I didn‚Äôt need it, since so far I don‚Äôt have a programmer or an in-circuit debugger. <br><br><h4>  Formulation of the problem </h4><br>  In my first experience on this topic, I decided to make a volume indicator in the system.  On the board, I wanted to place several LEDs and write a program to control their power and visualize the sound on the computer. <br><br><h4>  Assembly </h4><br>  First of all, I didn‚Äôt want to solder everything on the purchased debug board, and using it as a ‚Äúbase‚Äù for separate ‚Äúmodules‚Äù designed for it would be separate small boards.  That's exactly what I did.  First of all, I soldered the lattice to the derived free ports of the microcontroller: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/87d57732/f7d5af5b/0996187e/497f70c0.jpg"></div><br><br>  I also needed an additional cheap prototyping board (which it is not a pity to spoil with a soldering iron at my first soldering experiments), which I, along with all the necessary small things, bought on the radio market: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/42f53393/6fc15160/f6166b33/cc518722.jpg"></div><br><br>  Further, it was not tricky - to solder the LEDs and resistors to them.  The first time faced with the need to work with LEDs, I shoveled a lot of information to understand how it all works.  I found all the necessary information on <a href="http://www.easyelectronics.ru/">easyelectronics.ru</a> , where it was described in detail ‚Äúhow and what‚Äù.  Thank you so much. <br><br>  As a result, I got something like that (a connector and an uncomplicated circuit for connecting LEDs with a grid and a common minus) soldered onto the board: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/b84c7f98/f3526ec8/13ebfdb2/70834003.jpg"></div><br><br>  Two boards with each other decided to connect using a loop from the old computer: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage/habraeffect/be/6c/be6c9b96258e4376f250f7994f27e185.jpg"></div><br><br>  Thus, I have a modular system.  I can quickly assemble new modules and use them with the same microcontroller simply by rearranging the cable. <br><br><h4>  Software part </h4><br><h5>  Communication </h5><br>  It is worth noting that the board itself, unfortunately, and perhaps to the joy, does not have a built-in USB interface, so all communication between the computer and the board is done using the V-USB library developed by Objective Development Software, which is distributed under the GPL license. <br>  The computer uses the libusb-win32 library for the Windows operating system (2000, 2003, XP) and libusb for the * nix family of operating systems (Mac OS, Linux, etc.). <br><br><h5>  Firmware </h5><br>  Such an important part of the project as firmware ... I wanted to do it again, something simple but effective. <br>  For some reason, I was very lucky at that time with searching for information and therefore everything was there on the above site, I found a great solution: firmware for MK, as well as a wrapper class written in C # (the most friendly programming language for Windows for me). <br><br>  The firmware itself is written in such a way that its main task is to set the bit in a specific register, using data received via USB.  The rest is handled by the desktop program. <br><br><h5>  Program </h5><br>  All you had to do next was to write a program that would send the necessary bits to the correct registers, using the aforementioned wrapper for C #.  It should not be any work any more, all that is needed from the program is to get the current volume level in the system and change the necessary bit. <br><br>  Having a little searching in the old folders, I found some unnecessary suitable workpiece, hidden for future needs earlier, written on the basis of AudioCoreApi (C #). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/65c7791a/6659ac7a/c54acc55/07538ef4.png"></div><br><br>  Well, it remains to arrange the necessary commands in the right events. <br><br>  Since I connected the LEDs on the board to all the legs of the port A of the microcontroller, I accordingly need to ‚Äúpull‚Äù the legs of the MK according to the LEDs.  The state of each LED corresponds to the state of each bit in the PORTA byte (the byte that is responsible for the state of the microns on port A). <br><br>  We find the main timer in the program and write the following code: <br><pre><code class="hljs matlab">byte PortState = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">8</span></span>; ++<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (leftVolumeLevelPercent &gt; <span class="hljs-number"><span class="hljs-number">12</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) { PortState &lt;&lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>; PortState |= <span class="hljs-number"><span class="hljs-number">0x01</span></span>; } } hundler.PORTA = PortState;</code> </pre> <br>  Here, depending on the volume level in the system, we use shift operations, set or reset a certain bit in hundler.PORTA, where hundler is the object to work with the device, and PORTA is an input / output port byte, implemented as follows: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> PORTA { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { usb_control_msg(handle, USB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_ENDPOINT_OUT, RQ_IO_WRITE, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, aPORTA, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { usb_control_msg(handle, USB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_ENDPOINT_IN, RQ_IO_READ, <span class="hljs-number"><span class="hljs-number">0</span></span>, aPORTA, buffer, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buffer[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } }</code> </pre><br>  The usb_control_msg () function is a function from the V-USB library. <br><br>  Also, the important point is that before using port A, all its legs should be installed on the output, not on input (Speaking honestly, inadvertently skipping this moment in some articles, it knocked me up a bit when the LEDs were lit by a third power) in the following way: <br><br><pre> <code class="hljs objectivec">hundler.DDRA = <span class="hljs-number"><span class="hljs-number">0xFF</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   -  255,        </span></span></code> </pre><br><br>  Well, that's all!  Thank you for reading up to this point.  I hope the comments will not talk about the picture "how to draw an owl," everything seems to be clear and not very difficult as it seemed to me earlier.  Also, I did not want to say this, but this is already half the way to the mood lamp :) <br><br><h4>  Video </h4><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/weJ73FeEE6E%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhjRLLCsePaOPPN8ZJliWJk2F7DdDg" frameborder="0" allowfullscreen=""></iframe><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/iCeEOmbBIZM%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhic9GAzx5C5Y2XmWnX5SIxbRS0CHg" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Links </h4><ol><li>  <a href="http://habrahabr.ru/blogs/DIY/85892/">Manage a homemade USB-HID LED using a .NET GUI shell</a> </li><li>  <a href="http://microsin.ru/content/view/605/44/">Description of AVR-USB-MEGA16 debug card</a> </li><li>  <a href="http://microsin.ru/content/view/812/44/">Firmware and class wrapper in C #</a> </li><li>  <a href="http://narod.ru/disk/20324205001/New%2520folder.rar.html">C # program from the post</a> </li></ol><br>  Ps I apologize for the poor quality photos and videos.  Unfortunately, there was nothing at hand except a google phone. </div><p>Source: <a href="https://habr.com/ru/post/125218/">https://habr.com/ru/post/125218/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125210/index.html">Working with Java on the command line</a></li>
<li><a href="../125212/index.html">Isostick: a flash drive that impersonates an optical drive</a></li>
<li><a href="../125214/index.html">Bluetooth module HC-04 on CSR chip BC417143B</a></li>
<li><a href="../125216/index.html">Create a video surveillance system using motion</a></li>
<li><a href="../125217/index.html">IT Operations: the beginning</a></li>
<li><a href="../125219/index.html">Apple's financial reserves exceeded US government operating reserves</a></li>
<li><a href="../125220/index.html">Startup Poster Updated</a></li>
<li><a href="../125222/index.html">Secure password storage</a></li>
<li><a href="../125223/index.html">Job Digest: Web Studios</a></li>
<li><a href="../125224/index.html">Canobuvosti, 102nd edition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>