<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Space Snake in the Store or How We Put the ‚ÄúCheeseShop‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good time of day, dear readers! 

 Below is a fascinating (?) Story about how our organization solved the so-called problem. "Deployment as in humans....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Space Snake in the Store or How We Put the ‚ÄúCheeseShop‚Äù</h1><div class="post__text post__text-html js-mediator-article">  Good time of day, dear readers! <br><br>  Below is a fascinating (?) Story about how our organization solved the so-called problem.  "Deployment as in humans."  Our main language is Python, with a mix of different interesting (and not so) packages (Django, Bottle, Flask, PIL, ZMQ, etc.). <br><br>  Let's start with a brief description of one of our applications: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Django 1.4 </li><li>  Mysql </li><li>  Celery for cron-imitation and support of auxiliary functions in the background </li><li>  Daemon process based on Django management command </li></ul><br><br>  The whole thing works under a bunch of gUnicorn and nginx, on CentOS 5.8 OS. <br><br>  Details, as is customary, below. <br><br><a name="habracut"></a><br><br><h4>  The essence of the problem </h4><br>  In one of the final phases of the project, we got the idea that, in principle, ‚Äúsvn up &amp;&amp; python manage.py syncdb &amp;&amp; python manage.py migrate‚Äù is crooked;  began the search for a "more optimal" approach. <br><br><h4>  Option One - "Snake in Space" </h4><br>  So, as we use <a href="http://spacewalk.redhat.com/">Spacewalk</a> for server management, the idea was to pack our application into an RPM package;  the ability to install "one click" manila and option was adopted in the development. <br><br>  About 8 hours later, when the WTF / hr indicator was stuck in the red zone, we decided to look for something simpler.  Main reasons: <br><br><ul><li>  All dependencies must be packaged in RPM </li><li>  Not all packages / distributions like this. </li><li>  The packaging process leads to the fork of the package, since  Often you need to edit setup.py for proper conversion to a .spec file. </li><li>  The packaging environment itself requires relatively much experience. </li></ul><br><br><h4>  Option Two - "Snake in the Shop" </h4><br>  The second option arose after the words ‚Äúhow are we putting other people's packages?‚Äù And the search for a local copy of PyPi began.  Of the many abandoned and hopeless packages, the localshop was chosen, which pleased us with its simplicity of installation and did not even ask for the strange packages of <i>THIS</i> version. <br><br>  It took us a relatively short amount of time to fit our application - all we needed was to add setup.py and specify the ‚Äúleft‚Äù packages right there, although we still did a rake: <br><br>  It was necessary to explicitly specify <b>zip_safe = False</b> and <b>include_package_data = True</b> , since  Some files were not unpacked during installation. <br><br>  Apache (which will be replaced soon) had to specify <b>KeepAliveTimeout 300</b> , <b>SetEnv proxy-sendcl</b> and <b>ProxyTimeout 1800</b> to download large packages. <br><br>  In addition, the process of configuring the localshop went well, it was enough to run (under the ‚Äúclean‚Äù account): <br><br> <code>cd &amp;&amp; virtualenv venv &amp;&amp; . venv/bin/activate &amp;&amp; pip install localshop <br> ~/venv/bin/localshop init &amp;&amp; ~/venv/bin/localshop upgrade <br></code> <br><br>  After that, we only need to fit ~ / .pipyrc under our "store": <br><br><pre> [distutils]
 index-servers = local

 [local]
 username: developer
 password: parolcheg123
 repository: http://cheese.example.com/simple/
</pre><br><br>  After that, the release process is reduced to <code>python setup.py upload -r local</code> , after changing the version number in <b>setup.py</b> . <br><br><h4>  Final Approach </h4><br>  At the first attempt to install our application on the ‚Äúcombat‚Äù server, we suffered a sad fate - we needed the PIL package, and GCC and various things like libpng-devel were not available as a class.  I still had to ‚Äúassemble the RPM-package of Python and various interesting pieces (MySQL-python, setuptools, PIL, ZMQ) with handles‚Äù and fill it with <i>Spacewalk</i> . <br><br>  After this cognitive operation (which, in fact, relies on its own post), the installation of the application itself is over and we began to ‚Äúfinish off‚Äù the process, modifying minor problems: <br><ul><li>  Auto-launch gUnicorn (for localshop in general and our applications specifically): there was enough fine file handling of the <a href="https://gist.github.com/1511911">dug-out script</a> . </li><li>  ‚ÄúCorrect‚Äù pip setup on ‚Äúcombat‚Äù servers: add [index] url = <a href="https://cheese.example.com/simple/">cheese.example.com/simple</a> to the [global] section of the (new) ~ produser / .pip / pip.conf <a href="https://cheese.example.com/simple/">file</a> </li><li>  Adding all this stuff to the monitoring system (OpsView): adding a new service check to the process with ‚Äúrun_gunicorn‚Äù or ‚Äúgunicorn‚Äù arguments and linking to the server. </li></ul><br><br>  In addition, we needed to launch a ‚Äúlong-playing‚Äù process, as well as <b>Celery</b> .  For our application, it was decided to use ZDaemon, for which init-script and the configuration file were written: <br><br><pre> #! / bin / bash
 ### BEGIN INIT INFO
 # Provides: our_app
 # Required-Start: $ all

 # Required-Stop: $ all
 # Default-Start: 2 3 4 5
 # Default-Stop: 0 1 6
 # Short-Description: controls our_app via zdaemon
 # Description: controls our_app via zdaemon

 ### END INIT INFO

 .  /etc/rc.d/init.d/functions

 .  / etc / sysconfig / network

 .  ~ produser / venv / bin / activate

 # Check that networking is up.
 ["$ NETWORKING" = "no"] &amp;&amp; exit 0


 RETVAL = 0
 APP_PATH = ~ / produser / app /
 PYTHON = ~ produser / venv / bin / python
 USER = produser



 start () {
         cd $ APP_PATH
         zdaemon -C our_app.zdconf start
         zdaemon -C our_app_celery.zdconf start

 }

 stop () {
         cd $ APP_PATH
         zdaemon -C our_app.zdconf stop
         zdaemon -C our_app_celery.zdconf stop

 }

 check_status () {
         cd $ APP_PATH
         zdaemon -C our_app.zdconf status
         zdaemon -C our_app_celery.zdconf status

 }

 case "$ 1" in
   start)
         start
         ;;
   stop)
         stop
         ;;
   status)
         check_status
         ;;
   restart)
         stop
         start
         ;;
   *)
 esac
 exit 0

</pre><br><br><pre> # our_app [_celery] .zdconf
 &lt;runner&gt;
         daemon true
         directory / opt / produser / app /
         forever false

         backoff-limit 10
         user produser
 # run_command -&gt; actual command or celeryd
         program / opt / produser / venv / bin / python /opt/produser/app/manage.py run_command --settings = prod_settings
         socket-name /tmp/our_app.zdsock
 &lt;/ runner&gt;

</pre><br><br><h4>  Final result </h4><br><br>  Running ~ / venv / bin / activate &amp;&amp; pip install -U our_app under the produser account installs the latest version of our application almost without any problems + all the ‚Äúleft‚Äù packages specified in setup.py. <br><br>  The syncdb and migrate process is still done by handles, but: <br><br><ul><li>  The "combat" version is always known. </li><li>  No need to install GCC, etc.  on the "combat" server </li><li>  Rollback is simple </li></ul><br><br>  I hope that this description of the process enlightened some of the readers. </div><p>Source: <a href="https://habr.com/ru/post/147492/">https://habr.com/ru/post/147492/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147487/index.html">Facebook App Center becomes global (in Russia - in a few weeks)</a></li>
<li><a href="../147488/index.html">Eviterra.com: Where to fly cheap or Price Map</a></li>
<li><a href="../147489/index.html">Last.fm lies due to an accident in a datacenter</a></li>
<li><a href="../147490/index.html">Negotiating Instructions</a></li>
<li><a href="../147491/index.html">Unit testing of models in Yii</a></li>
<li><a href="../147493/index.html">Fulfillment - a catalyst for the growth of regional online sales</a></li>
<li><a href="../147494/index.html">Radio project about SaaS-services (20 gears) + Megaplan mini-series</a></li>
<li><a href="../147495/index.html">We send Nagios notifications to Skype chat</a></li>
<li><a href="../147496/index.html">We invite to August 2 in Kiev for a free seminar on ITIL</a></li>
<li><a href="../147500/index.html">Intel Pair & Share: the communicator is turning ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>