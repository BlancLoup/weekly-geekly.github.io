<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk. This time, as a background music broadcasting system with the possibility of emergency notification</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear residents of the Asterisk hub. 

 I don‚Äôt know about you, but lately I‚Äôm not interested in using Asterisk as a standard PBX. 

 I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk. This time, as a background music broadcasting system with the possibility of emergency notification</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/4d1/3da/359/4d13da35923141249009a07e6083c358.jpg" alt="image"><br><br>  Good afternoon, dear residents of the Asterisk hub. <br><br>  I don‚Äôt know about you, but lately I‚Äôm not interested in using Asterisk as a standard PBX. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In a previous <a href="http://habrahabr.ru/post/261391/">post,</a> Asterisk performed the duties of a security guard in a parking lot.  This time, Asterisk, in my configuration, played the background music in the shopping pavilion and in the event of an emergency situation (or, if necessary, to make some kind of announcement) acted as a warning system. <br><br>  Details under the cut. <br><a name="habracut"></a><br>  A couple of weeks ago, I had one interesting task, namely to deploy a system for playing background music, one of the functions of which should be able to ‚Äúwedge in‚Äù to play a sound file, make an announcement, and then continue playing music from the same place. <br><br>  Having quickly looked at the existing ‚Äúbox‚Äù solutions in Google, I realized that this is not exactly what I want.  I was offered either professional warning systems (for example, for stadiums), or analog devices, which are certainly reliable, but absolutely not customizable. <br><br>  Were also reviewed existing devices SIP-alert.  Here it is already more interesting: they register on Asterisk as extensions, know how to broadcast multicast, know how to prioritize different sound streams.  In Russia, you can find the <a href="http://www.cyberdata.net/voip/011393/">IP-SIP dynamics of Cyberdata</a> , which were discussed in great detail in <a href="https://habrahabr.ru/post/228921/">this</a> topic.  The speakers have a new firmware, the interface is a little refreshed.  Having the opportunity to "play around" with this device, it was a sin not to use it :) <br><br>  So let's get started. <br><br>  Of course, we will not describe the installation of Asterisk: the network is full of quality manuals.  The only thing I‚Äôll add is: docker-compose with asterisk, mysql, php-apache, cdr-viewer has already done for a long time, which makes asterisk almost instantaneous.  I plan to describe it in the next topic). <br><br>  Create a couple of extensions on Asterisk (by default /etc/asterisk/sip.conf): <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="bash hljs">[tmpl](!) <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = peer host = dynamic canreinvite=no dtmfmode = rfc2833 insecure = invite nat = force_rport,comedia call-limit=2 qualify = yes context = from-internal disallow=all allow=alaw allow=ulaw directmedia=no [780](tmpl) defaultuser=780 secret=780 callerid=<span class="hljs-string"><span class="hljs-string">"Dispatcher"</span></span> &lt;780&gt; [790](tmpl) defaultuser=790 secret=790 callerid=<span class="hljs-string"><span class="hljs-string">"Speaker1"</span></span> &lt;790&gt; [800](tmpl) defaultuser=800 secret=800 callerid=<span class="hljs-string"><span class="hljs-string">"Speaker2"</span></span> &lt;800&gt;</code> </pre> <br></div></div><br>  We write the simplest Asterisk dialplan for tests (by default /etc/asterisk/extensions.conf): <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">exten =&gt; _XXX,1,NoOp(Testing calls to speakers. Dialing <span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span> from <span class="hljs-variable"><span class="hljs-variable">${CALLERID}</span></span>) same =&gt; n,Page(SIP/<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>,qA(hello-world)) same =&gt; n,Hangup()</code> </pre><br></div></div><br>  Go to the speaker setup. <br><br>  We find it in our local network (by default, the device is configured for dhcp): <br><br><img src="https://habrastorage.org/web/321/5a9/d7d/3215a9d7d7284777896641a98d5c911b.png"><br><br>  Configure sip extension (to login to the speaker login / default password admin / admin): <br><br><img src="https://habrastorage.org/web/f18/6c1/e85/f186c1e853c2402aa7c7a15bf45936c7.png"><br><br>  The only inconvenience is that after each operation the speaker must be sent to a reboot, which takes as much as a full minute. <br><br>  And set up a multicast: <br><br><img src="https://habrastorage.org/web/19b/70b/1aa/19b70b1aa60344ceae86e09d4703a112.png"><br><br>  Notice the caption: ‚ÄúSIP calls are considered priority 4.5.  Priority 9 is the highest and 0 is the lowest.  ¬ªIn order for a multicast to be interrupted when a call is made to a speaker, multicast settings must take priority 4 and below. <br><br>  Now we set up a multicast broadcast on the asterisk server.  I used the ffmpeg utility. <br><br><div class="spoiler">  <b class="spoiler_title">Install:</b> <div class="spoiler_text">  sudo apt-get install ffmpeg <br></div></div><br><div class="spoiler">  <b class="spoiler_title">We start broadcasting (I took a playlist from vocaltrance.fm (not an ad), of course, you can choose any):</b> <div class="spoiler_text">  ffmpeg -re -i <a href="http://176.9.36.203/">176.9.36.203</a> : 8000 / vocaltrance_128 -filter_complex 'aresample = 8000, asetnsamples = n = 160' -acodec pcm_alaw -ac 1 -vn -f rtp udp: //236.0.0.1: 2000? buffer_size = 10000000? fifo_size = 1000000 <br></div></div><br>  And listen :) <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/8m5beBGRw2g" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  In addition to the obvious advantages, this implementation variant has one big disadvantage, namely the price, which for this dynamics is about $ 400 dollars per piece. <br><br>  To lower the cost of the system, I decided to use regular speakers (I had <div class="spoiler">  <b class="spoiler_title">like these ones</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/320/87c/6d4/32087c6d4c8248e4858fba12afee49c4.jpg"></div></div>  and <a href="https://ru.wikipedia.org/wiki/Raspberry_Pi">raspberry pi</a> .  (The cost of the dynamics and raspberry was ~ $ 50). <br><br>  So let's get started. <br><br>  Install on raspberry <a href="http://www.raspberry-asterisk.org/downloads/">raspbx</a> distribution, which is a ready-made freepbx image for ARM architecture.  (You will need a 4Gb flash drive for installation.) <br><br>  Installation is trivial: download, take a suitable flash drive, unmount the partition, write the image in dd: <br><br><pre> <code class="bash hljs">sudo dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=path_of_your_image.img of=/dev/diskn bs=1M</code> </pre> <br><img src="https://habrastorage.org/web/2a7/4f9/3bd/2a74f93bdb344d76b3fa846944498d0c.png"><br><br>  We find in the network login / password for ssh root / raspberry, for web - admin / admin. <br><br>  Create a trunk to our ‚Äúhead‚Äù Asterisk: <br><br><div class="spoiler">  <b class="spoiler_title">[rasp]</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=peer host=192.168.1.254 ;;ip <span class="hljs-string"><span class="hljs-string">""</span></span> Asterisk qualify=yes insecure = port,invite directmedia=no context=speakers canreinvite=no disallow=all allow=alaw allow=ulaw</code> </pre> <br></div></div><br><img src="https://habrastorage.org/web/627/8ee/f8c/6278eef8cb3343799a740ece149376d7.png"><br><br>  On the "main" Asterisk we create the same trunk, just point it to ip raspberry. <br><br>  Calls to raspberry will be sent to chan_alsa (module load chan_alsa.so, if not loaded by default). <br><br>  To play music, use omxplayer (sudo apt-get -y install omxplayer). <br><br>  To make calls interrupt music playback, let's write a simple dialplan: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">[speakers] exten =&gt; s,1,System(killall /usr/bin/omxplayer.bin) same =&gt; n,Wait(2) same =&gt; n,Dial(console/sdp) same =&gt; n,Hangup() exten =&gt; h,1,System(omxplayer -o <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> rtp://@236.0.0.1:2000)</code> </pre> <br></div></div><br>  To call from the ‚Äúhead‚Äù Asterisk, add to the initial dialplan: <br><br>  exten =&gt; 1000.1, Dial (SIP / rasp / s, 60, Tt) <br>  same =&gt; n, hangup () <br><br>  And enjoy the result :) <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/GJ0dBgsXmH4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <b>Conclusion</b> <br><br>  As a result, we have a completely working background music / broadcasting system, controlled by Asterisk, with several options for terminal devices.  Options for the use of other devices are welcome in the comments.  Thanks for attention. <br><br>  Russian version: <a href="https://medium.com/southbridge-io/asterisk-broadcasting-background-music-22663ca1f2b7">Asterisk.</a>  <a href="https://medium.com/southbridge-io/asterisk-broadcasting-background-music-22663ca1f2b7">The concept of emergency notification</a> . </div><p>Source: <a href="https://habr.com/ru/post/268047/">https://habr.com/ru/post/268047/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268031/index.html">Apiway - a new way of client-server data transport</a></li>
<li><a href="../268033/index.html">We balance the mechanics in games</a></li>
<li><a href="../268035/index.html">Bad "Spring" or as the reasons for the delays were looking for</a></li>
<li><a href="../268037/index.html">Preparing ASP.NET5, issue number 4 - details about routing</a></li>
<li><a href="../268039/index.html">Predicting Titanic Passenger Survival with Azure Machine Learning</a></li>
<li><a href="../268055/index.html">Support for geolocation and corrected sketches of the express panel in the assembly Vivaldi 1.0.288.3</a></li>
<li><a href="../268057/index.html">CUSTIS Open Seminars: Graduation Season</a></li>
<li><a href="../268061/index.html">Democracy and Program Committee</a></li>
<li><a href="../268063/index.html">Friday format: How to write code that no one can accompany</a></li>
<li><a href="../268067/index.html">Security Week 40: Invincibility in WinRAR, bug veteran in Firefox, Microsoft update-oops</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>