<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backup Mikrotik with SSH and SCP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you look back into the past when there was no Ansible or other remote linux administration systems, we used only our own scripts, allowed them to c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backup Mikrotik with SSH and SCP</h1><div class="post__text post__text-html js-mediator-article">  If you look back into the past when there was no Ansible or other remote linux administration systems, we used only our own scripts, allowed them to connect to ssh systems using keys.  I think many people still use my scripts to replace centralized management systems. <br><br>  I decided to share my experience. <br>  It was necessary to write a script that can go to a specified number of hosts and backup some configuration files. <br><a name="habracut"></a><br>  The logic of work lined up immediately.  Log in to the host via ssh, execute some commands to prepare backups and pick up the finished files using scp <br><br>  The first step is to create a user who will have access to the necessary data with the necessary rights.  Here I think everyone can figure out which group to identify the user.  The main thing to remember: <br><ol><li>  The user name for a login without a password should be the same on all hosts, or you will have to specify your login for each host, which is not convenient; </li><li>  The user must have access to the host without a password (ssh-keygen to help); </li><li>  The user must have access to the files that must be collected. </li></ol><br>  <i>here you can go several ways 1) execute the command in the remote shell to collect the necessary data to be backed up and then pick them up 2) set up cron on the host and execute the data collection command and then, someday, go to the host and pick up the ready <s>backup cakes</s> .</i>  <i>Of course we will go the first way.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We have this configuration - <br>  10 hosts (Mikrotik) from which you need to get two types of backups - binary (for restoring from scratch) and a configuration without passwords and certificates for uploading to a working config.  We also have a machine with debian 8 on board, we‚Äôll call it a server (and it‚Äôs not important that it is a container, it‚Äôs important that it is debian) and of course where it‚Äôs without it is a zabbix-server. <br><br><ul><li>  IP Microtik - 10.10.0.1, 10.10.1.1, 10.10.2.1, 10.10.3.1, 10.10.4.1, 10.10.5.1, 10.10.6.1, 10.10.7.1, 10.10.8.1, 10.10.9.1; </li><li>  IP Zabbix-server - 10.10.10.10; </li></ul><br><br>  To simplify the task, the zabbix-hostname will be in the mik format (the third octet in the decimal format) .host thus we get - <br><ul><li>  Zabbix hostnames - mik0.host, mik1.host, mik2.host, mik3.host, mik4.host, mik5.host, mik6.host, mik7.host, mik8.host, mik9.host </li></ul><br><br>  <i>If someone does not remember - we specify the zabbix hostname in the zabbix-agent configuration file (the agent is not needed here, but still) on the zabbix server in the web-ui.</i> <i><br></i> <br><br>  First we create an RSA key on our server.  Why RSA - yes, out of habit, by the <i>way, old RB versions support only DSA, and everything that is newer 6.35 is already working with RSA and DSA, so look at the situation, you can upgrade as I did :)</i> if you already have ready key - skip this step. <br><br> <code>ssh-keygen -t RSA</code> <br> <br>  We transfer the contents of the $ HOME / .ssh / id_rsa.pub file from the server to our hosts.  I am lazy and for Mikrotik I used winbox. <br><br>  For Linux, you can make it easier to create a sh script and run it on behalf of the user that we will go to the host for backups ( <i>on the hosts the user should already be</i> ) of such content - <br>  <i>If you have a DSA key then change id_rsa.pub to id_dsa.pub</i> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash hosts=(10.10.0.1 10.10.1.1 10.10.2.1 10.10.3.1 10.10.4.1 10.10.5.1 10.10.6.1 10.10.7.1 10.10.8.1 10.10.9.1) username='user' for host in ${hosts[*]} do cat $HOME/.ssh/id_rsa.pub | ssh -o "StrictHostKeyChecking no" ${user}@${host} 'cat &gt;&gt; ~/.ssh/authorized_keys' done</span></span></code> </pre><br>  We start it and enter in turn passwords for all 10 servers in turn. <br><br>  <i>There is a catch in the script - I didn‚Äôt specifically add a check, otherwise I‚Äôll completely forget how to press the keys -) if you all read it, the catch will not work.</i> <br><br>  Soooo, what's next, but, for sure, we already know how to walk without a password to all hosts under a user, say user. <br>  <b>We want to get Mikrotik configs.</b>  Actually proceed. <br><br>  Create a script on the server <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash hosts=(10.10.0.1_mik0.host_22 \ 10.10.1.1_mik1.host_22 \ 10.10.2.1_mik2.host_22 \ 10.10.3.1_mik3.host_22 \ 10.10.4.1_mik4.host_22 \ 10.10.5.1_mik5.host_22 \ 10.10.6.1_mik6.host_22 \ 10.10.7.1_mik7.host_22 \ 10.10.8.1_mik8.host_22 \ 10.10.9.1_mik9.host_22 ) # bash array of values. All values are arrays too, after remove splitter "_". # Sub array content IP_ZABBIX-HOSTNAME_SSH-DAEMON-PORT cdate=`date +%d-%m-%Y` # System date =) Hi Max dir="/mik_backup/" # Storage for backups cmd="/system backup save name=backup; export file=backup.rsc hide-sensitive" # command that do the preparation of backup username="user" # SSH user zabbix_hp=(10.10.10.10 10051) # IP then PORT age="30" # remove all backups older then 30 days itemname="backup" # zabbix item error_value="1" # error value for trigger value="0" # good value =) for host in ${hosts[*]} # Get values from main list do hostname=($(echo ${host} | tr "_" " ")) # Get values from sub list ssh ${username}@${hostname[0]} -o "StrictHostKeyChecking no" -p${hostname[2]} "${cmd}" new_dir="${HOME}${dir}${hostname[1]}/${cdate}" mkdir -p ${new_dir} scp -P${hostname[2]} ${username}@${hostname[0]}:backup.backup ${new_dir} scp -P${hostname[2]} ${username}@${hostname[0]}:backup.rsc ${new_dir} check=`find ${new_dir} -type f -name backup.*` if [ "${check}" == "" ] then zabbix_sender -z ${zabbix_hp[0]} -p ${zabbix_hp[1]} -s ${hostname[1]} -k ${itemname} -o ${error_value} else zabbix_sender -z ${zabbix_hp[0]} -p ${zabbix_hp[1]} -s ${hostname[1]} -k ${itemname} -o ${value} fi done find ${HOME}${dir} -mindepth 2 -mtime ${age} -type d -exec rm -rf {} \; #clear dirs</span></span></code> </pre><br><br>  I tried as much as possible to comment on everything that happens in the script.  Let's look at what is being done here. <br><br>  <i>Here we say which interpreter will execute the code.</i> <br><pre> <code class="bash hljs"><span class="hljs-meta"><span class="hljs-meta">#!/usr/bin/env bash</span></span></code> </pre><br>  <i>Here we create an array with the data we need to connect to the hosts and send the data to zabbix</i> <br><pre> <code class="bash hljs">hosts=(10.10.0.1_mik0.host_22 \ 10.10.1.1_mik1.host_22 \ 10.10.2.1_mik2.host_22 \ 10.10.3.1_mik3.host_22 \ 10.10.4.1_mik4.host_22 \ 10.10.5.1_mik5.host_22 \ 10.10.6.1_mik6.host_22 \ 10.10.7.1_mik7.host_22 \ 10.10.8.1_mik8.host_22 \ 10.10.9.1_mik9.host_22 )</code> </pre><br>  <i>Here I think only one variable needs to be explained - $ cmd.</i>  <i>These are two commands that are executed on Mikrotik consistently.</i>  <i>The first creates a binary backup</i> <i><br></i>  <i>the second creates a script with settings without uploading passwords and encryption keys.</i> <br><pre> <code class="bash hljs">cdate=`date +%d-%m-%Y` <span class="hljs-comment"><span class="hljs-comment"># System date =) Hi Max dir="/mik_backup/" # Storage for backups cmd="/system backup save name=backup; export file=backup.rsc hide-sensitive" # command to do the preparation of backup username="user" # SSH user zabbix_hp=(10.10.10.10 10051) # IP then PORT age="30" # remove all backups older then 30 days itemname="backup" # zabbix item error_value="1" # error value for trigger value="0" # good value =)</span></span></code> </pre><br>  <i>The main body of the program.</i>  <i>At the entrance to the loop, we have an array contained in the $ hosts variable.</i>  <i>The cycle works like this - we take the first element of the array, we have it equal to 10.10.0.1_mik0.host_22 and start working with it.</i>  <i>The first action we add to the $ hostname variable array created from the first element of the $ hosts array.</i>  <i>We do this with the help of the tr command. As a matter of fact, in python we emit the action of the string method .split ().</i>  <i>It turns out quite tolerable.</i>  <i>We get 3 items in the $ hostname array.</i>  <i>The first item is the host ip.</i>  <i>The second element is zabbix-hostname.</i>  <i>The third element is ssh-port.</i> <i><br></i>  <i>Next we access these elements using an index, again python.</i> <i><br></i>  <i>Next, create a directory tree for storing files and specify scp which files to take.</i>  <i>Please do not kick - if someone tells you how to use scp in this design to access files by mask + in karma.</i> <i><br></i>  <i>After we receive the files, we send a success message to zabbix.</i> <i><br></i>  <i>Checking the creation of a config is made by simply searching the file in the destination directory.</i>  <i>It was possible to make a comparison of md5 on Mikrotik and in the destination directory, but that's another story, although I did it.</i> <i><br></i> <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> host <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">${hosts[*]}</span></span> <span class="hljs-comment"><span class="hljs-comment"># Get values from main list do hostname=($(echo ${host} | tr "_" " ")) # Get values from sub list ssh ${username}@${hostname[0]} -o "StrictHostKeyChecking no" -p${hostname[2]} "${cmd}" new_dir="${HOME}${dir}${hostname[1]}/${cdate}" mkdir -p ${new_dir} scp -P${hostname[2]} ${username}@${hostname[0]}:backup.backup ${new_dir} scp -P${hostname[2]} ${username}@${hostname[0]}:backup.rsc ${new_dir} check=`find ${new_dir} -type f -name backup.*` if [ "${check}" == "" ] then zabbix_sender -z ${zabbix_hp[0]} -p ${zabbix_hp[1]} -s ${hostname[1]} -k ${itemname} -o ${error_value} else zabbix_sender -z ${zabbix_hp[0]} -p ${zabbix_hp[1]} -s ${hostname[1]} -k ${itemname} -o ${value} fi done</span></span></code> </pre><br>  <i>Here we clean the place.</i>  <i>The $ age variable will help us save backups as much as we need.</i> <br><pre> <code class="bash hljs">find <span class="hljs-variable"><span class="hljs-variable">${HOME}</span></span><span class="hljs-variable"><span class="hljs-variable">${dir}</span></span> -mindepth 2 -mtime <span class="hljs-variable"><span class="hljs-variable">${age}</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> d -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; <span class="hljs-comment"><span class="hljs-comment">#clear dirs</span></span></code> </pre><br><br>  Now the most trivial. <br>  Create a template on the zabbix server or just a data item of the zabbix_trapper type on our nodes which we added in advance to monitoring in zabbix. <br>  I will not post a template from one data element and one trigger.  I think everyone can do it.  The main thing to remember, if the hosts are monitored via zabbix-proxy, you should send the data to zabbix-proxy.  Otherwise, send everything to the zabbix-server. <br>  It does not even matter what the IP of these hosts will be in the zabbix web ui.  It is important that the hostname matches the data in the script. <br><br>  Ps.  All scripts need to throw <i>chmod + x</i> so they can be run without calling the interpreter. <br>  PSS To transfer the scp file list for backup to linux, you can create another array and nest it in a for loop.  You can do everything in the form of received parameters.  Well, in general, you can have fun. </div><p>Source: <a href="https://habr.com/ru/post/345820/">https://habr.com/ru/post/345820/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345804/index.html">How to enable the dark theme of the Unity editor</a></li>
<li><a href="../345808/index.html">Condition Management in Polymer 2.0. Outside of parent / child bindings</a></li>
<li><a href="../345814/index.html">Dynamic loading of the template Vue component</a></li>
<li><a href="../345816/index.html">WD Red drives - a balanced solution for use in small and medium NAS</a></li>
<li><a href="../345818/index.html">Visualization of the development of SEMrush.com 2017</a></li>
<li><a href="../345822/index.html">Defining a file format with Python</a></li>
<li><a href="../345824/index.html">Parallel data sorting in GPU</a></li>
<li><a href="../345826/index.html">ThreeFlow branch strategy</a></li>
<li><a href="../345830/index.html"># Acceleration4X. Principle number 0/1. Variable environment</a></li>
<li><a href="../345832/index.html">Issue # 5: IT training - current issues and challenges from leading companies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>