<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic backup of virtual machines in XenServer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, it was necessary to automate the creation and saving of snapshots of virtual machines from XenServer. Having found nothing on this topic in ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic backup of virtual machines in XenServer</h1><div class="post__text post__text-html js-mediator-article">  <i>Recently, it was necessary to automate the creation and saving of snapshots of virtual machines from XenServer.</i>  <i>Having found nothing on this topic in the Russian-speaking segment, I went to the global Internet and found an article on the resource tecadmin.net, which helped me a lot, so I decided to post its translation on Habr√©.</i>  <i>Further, the author (with adaptation for our speech) translation of the original article:</i> <br><img src="https://habrastorage.org/files/3fa/9be/fd0/3fa9befd08874f88a622643bff4a825d.png"><a name="habracut"></a><br>  I have been working with Citrix XenServer for many years, and managing all the virtualization servers through the XenCenter application, which is installed on my Windows computer.  Until today, we regularly backed up virtual machines manually, just had to stop the servers to copy them.  Most server owners cannot afford to shut them down for a long time.  Therefore, I found a way to copy virtual machines without shutting them down and, accordingly, idle. <br><br>  In this article, we will step by step learn how to make backup copies of a running virtual machine, as well as a ready script that can make backup copies of all servers via cron. <br><br>  <b>Manual backup running machine</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  <b>Search for UUID virtual machine</b> <br><br><pre><code class="bash hljs">xe vm-list is-control-domain=<span class="hljs-literal"><span class="hljs-literal">false</span></span> is<span class="hljs-_"><span class="hljs-_">-a</span></span>-snapshot=<span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br>  This command will show the list of virtual machines and their UUIDs that we need for the next step. <br><br></li><li>  <b>Making snapshots</b> <br><br>  The uuid parameter must be replaced with your own, obtained in the first step, make sure that it is correct. <br><br><pre> <code class="bash hljs">xe vm-snapshot uuid=8ac95696-94f3-83c1-bc89-8bb2603f832b new-name-label=testvmsnapshot</code> </pre> <br>  And this command will return the uuid snapshot, according to which it can be saved to a file. <br><br><pre> <code class="bash hljs">xe template-param-set is<span class="hljs-_"><span class="hljs-_">-a</span></span>-template=<span class="hljs-literal"><span class="hljs-literal">false</span></span> ha-always-run=<span class="hljs-literal"><span class="hljs-literal">false</span></span> uuid=b15c0531-88a5-98a4-e484-01bc89131561</code> </pre><br></li><li>  <b>Saving snapshot to file</b> <br><br>  Now you can save the snapshot to an .xva file, which can be used to restore the server from the command line as well as from XenCenter <br><br><pre> <code class="bash hljs">xe vm-export vm=b15c0531-88a5-98a4-e484-01bc89131561 filename=vm-backup.xva</code> </pre> <br></li><li>  <b>Snapshot removal</b> <br><br>  After saving the .xva file, you can remove the snapshot from the XenServer itself <br><br><pre> <code class="bash hljs">xe vm-uninstall uuid=b15c0531-88a5-98a4-e484-01bc89131561 force=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> </li></ol><br>  <b>The script automatically backup running virtual machines</b> <br><br>  You can use the following bash script to back up all virtual machines running on the xenserver database.  This script creates snapshots and exports them to an NFS disk.  This script works fine for me, which you may not have, so <b>use it at your own peril and risk</b> . <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # # Written By: Mr Rahul Kumar # Created date: Jun 14, 2014 # Last Updated: Jan 22, 2016 # Version: 1.2 # Visit: http://tecadmin.net # DATE=`date +%d%b%Y` XSNAME=`echo $HOSTNAME` MOUNTPOINT=/xenmnt UUIDFILE=/tmp/xen-uuids.txt NFS_SERVER_IP="192.168.10.100" ### Create mount point mkdir -p ${MOUNTPOINT} ### Mounting remote nfs share backup drive [ ! -d ${MOUNTPOINT} ] &amp;&amp; echo "No mount point found, kindly check"; exit 0 mount -F nfs ${NFS_SERVER_IP}:/backup/citrix/vms ${MOUNTPOINT} BACKUPPATH=${MOUNTPOINT}/${XSNAME}/${DATE} mkdir -p ${BACKUPPATH} [ ! -d ${BACKUPPATH} ] &amp;&amp; echo "No backup directory found"; exit 0 # Fetching list UUIDs of all VMs running on XenServer xe vm-list is-control-domain=false is-a-snapshot=false | grep uuid | cut -d":" -f2 &gt; ${UUIDFILE} [ ! -f ${UUIDFILE} ] &amp;&amp; echo "No UUID list file found"; exit 0 while read VMUUID do VMNAME=`xe vm-list uuid=$VMUUID | grep name-label | cut -d":" -f2 | sed 's/^ *//g'` SNAPUUID=`xe vm-snapshot uuid=$VMUUID new-name-label="SNAPSHOT-$VMUUID-$DATE"` xe template-param-set is-a-template=false ha-always-run=false uuid=${SNAPUUID} xe vm-export vm=${SNAPUUID} filename="$BACKUPPATH/$VMNAME-$DATE.xva" xe vm-uninstall uuid=${SNAPUUID} force=true done &lt; ${UUIDFILE} umount ${MOUNTPOINT}</span></span></code> </pre><br>  <i>PS I don‚Äôt know why the author had problems with backup of running machines - XenCenter allows you to create snapshots and save them to a file without shutting down the machine (of course, if XenTools is installed on it. But its automation script helped me a lot, but you can change it under various conditions, for example, to mount not NFS, but SMB or just an external drive</i> </div><p>Source: <a href="https://habr.com/ru/post/317356/">https://habr.com/ru/post/317356/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317344/index.html">Adizes PAEI Management Styles and Scrum Roles</a></li>
<li><a href="../317346/index.html">VulnHub 64Base Simple Solution: Boot2Root</a></li>
<li><a href="../317348/index.html">Parallel fast sorting on Haskell and how hard it turned out to write</a></li>
<li><a href="../317350/index.html">Presentations and video presentations from the VR-Today virtual reality meeting</a></li>
<li><a href="../317354/index.html">OpenWRT + OpenVPN: point bypass blocking</a></li>
<li><a href="../317360/index.html">$ mol_atom: theory and practice of reactivity</a></li>
<li><a href="../317362/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ240 (December 5 - 11, 2016)</a></li>
<li><a href="../317364/index.html">Linux kernel 4.9 introduced</a></li>
<li><a href="../317366/index.html">PHP Digest number 98 - interesting news, materials and tools (November 28 - December 11, 2016)</a></li>
<li><a href="../317368/index.html">Firsthand about software lifecycle management products</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>