<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Oracle join elimination</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The optimizer in Oracle can use various ways to transform queries to improve their performance. One such way is join elimination . The official Oracle...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Oracle join elimination</h1><div class="post__text post__text-html js-mediator-article">  The optimizer in Oracle can use various ways to transform queries to improve their performance.  One such way is <b>join elimination</b> .  The official <a href="https://docs.oracle.com/apps/search/search.jsp%3Fword%3D%2Bjoin%2Belimination%26product%3De50529-01%26book%3Dtgsql">Oracle Database SQL Tuning Guide</a> documentation says quite a bit about this method, unlike the others. <br>  I invite readers under the cat to talk about this method in more detail. <br><a name="habracut"></a><br>  <b>Content:</b> <br><ul><li>  <a href="https://habr.com/ru/post/248817/">Inner join transformation</a> </li><li>  <a href="https://habr.com/ru/post/248817/">Transformation outer join</a> </li><li>  <a href="https://habr.com/ru/post/248817/">Transformation semi join and anti join</a> </li><li>  <a href="https://habr.com/ru/post/248817/">Self join transformation</a> </li><li>  <a href="https://habr.com/ru/post/248817/">Rely disable and join elimination</a> </li><li>  <a href="https://habr.com/ru/post/248817/">Parameter _optimizer_join_elimination_enabled</a> </li><li>  <a href="https://habr.com/ru/post/248817/">ELIMINATE_JOIN and NO_ELIMINATE_JOIN Tips</a> </li><li>  <a href="https://habr.com/ru/post/248817/">When join elimination is bad</a> </li><li>  <a href="https://habr.com/ru/post/248817/">Transformation of the same compounds</a> </li><li>  <a href="https://habr.com/ru/post/248817/">Total</a> </li></ul><br>  This method of query transformation first appeared in Oracle 10.2, but in a rather limited form ‚Äî it supported only the inner join.  In version 11.1 and 11.2, join elimination has been greatly enhanced. <br>  In the documentation, join elimination is defined as: <i>Removing unnecessary tables from the request.</i>  <i>A table is considered redundant if its columns are used only in the connection condition, and such a connection is guaranteed not to filter data and add new rows.</i> <br><br>  At first glance, this may seem strange - why would someone write such a meaningless query?  But this can happen if we use the generated query or access views. <br><br><a name="InnerJoin"></a><h4>  <b>Inner join transformation</b> </h4><br>  Let's look at a small example (the scripts were run on Oracle 11.2). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">To begin with, we will create several tables, one parent and one child (master-detail):</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, description varchar2(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> parent_pk primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, parent_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, description varchar2(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>;</code> </pre> <br></div></div><br>  Now we will try to execute a simple query and look at its plan: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p.id; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">-------------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | -------------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 36 | 2 (0)| 00:00:01 | | 1 | NESTED LOOPS | | 4 | 36 | 2 (0)| 00:00:01 | | 2 | TABLE ACCESS FULL| CHILD | 4 | 24 | 2 (0)| 00:00:01 | |* 3 | INDEX UNIQUE SCAN| PARENT_PK | 1 | 3 | 0 (0)| 00:00:01 | -------------------------------------------------------------------------------- 3 - access("C"."PARENT_ID"="P"."ID")</span></span></code> </pre><br>  Despite the fact that we request a column only from the <i>child</i> table, Oracle nevertheless performs an honest inner join and in vain makes a call to the <i>parent</i> table. <br><br>  It turns out that the optimizer does not understand that in this query the join of these two tables does not lead to any filtering or multiplication of rows.  So you need to help him understand it. <br><br>  Let's link these tables with the help of the foreign key from the <i>child</i> to the <i>parent</i> and see how the query plan changes: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> child_parent_fk <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (parent_id) <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p.id; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">--------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | --------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 104 | 3 (0)| 00:00:01 | |* 1 | TABLE ACCESS FULL| CHILD | 4 | 104 | 3 (0)| 00:00:01 | --------------------------------------------------------------------------- 1 - filter("C"."PARENT_ID" IS NOT NULL)</span></span></code> </pre><br>  Apparently from the request plan - it appeared enough. <br>  In order for Oracle to be able to remove extra tables from a query connected via an inner join, it is necessary for the foreign key - primary key (or unique constraint) relationship to exist between them. <br><br><a name="OuterJoin"></a><h4>  <b>Transformation outer join</b> </h4><br>  In order for Oracle to remove unnecessary tables from a query in the case of an outer join - it suffices to have a primary key (primary key) or unique constraint on the column of the outer table involved in the join. <br><br><div class="spoiler">  <b class="spoiler_title">Add some more parent tables.</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> parent2 ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, description varchar2(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> parent2_pk primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> parent2 <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> parent2 <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> parent3 ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, description varchar2(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> parent3_pk primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> parent3 <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> parent3 <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> (parent2_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, parent3_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> child_parent2_fk <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (parent2_id) <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> parent2(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">merge</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> parent2_id, <span class="hljs-literal"><span class="hljs-literal">null</span></span> parent3_id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span> parent2_id, <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> parent2_id, <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span> parent2_id, <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual ) s <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (c.id = s.id) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">matched</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> c.parent2_id = s.parent2_id, c.parent3_id = s.parent3_id; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>;</code> </pre><br></div></div><br>  And try the following query: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id, c.description <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> parent3 p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent3_id = p.id; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">--------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | --------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 100 | 3 (0)| 00:00:01 | | 1 | TABLE ACCESS FULL| CHILD | 4 | 100 | 3 (0)| 00:00:01 | ---------------------------------------------------------------------------</span></span></code> </pre><br>  As can be seen from the query plan, in this case, Oracle also guessed that the <i>parent_3</i> table <i>is</i> redundant and can be deleted. <br><br>  The number of tables that can be removed from a query is unlimited.  Join elimination is convenient to use if there is a child table, several parent tables and the result of their connection is exposed in the form of a view. <br><br>  Create a view that combines all our tables and try to use it in the query: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> child_parents_v <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id, c.parent_id, c.parent2_id, c.parent3_id, c.description, p1.description p1_desc, p2.description p2_desc, p3.description p3_desc <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p1.id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> parent2 p2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent2_id = p2.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> parent3 p3 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent3_id = p3.id; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> child_parents_v; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">--------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | --------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 156 | 3 (0)| 00:00:01 | |* 1 | TABLE ACCESS FULL| CHILD | 4 | 156 | 3 (0)| 00:00:01 | --------------------------------------------------------------------------- 1 - filter("C"."PARENT2_ID" IS NOT NULL AND "C"."PARENT_ID" IS NOT NULL)</span></span></code> </pre><br>  As can be seen from the plan, Oracle did an excellent job with such a request too. <br><br><a name="SemiAndAntiJoin"></a><h4>  <b>Transformation semi join and anti join</b> </h4><br>  In order to have the possibility of such transformations: there must be a foreign key - primary key relationship between the tables, as in the case of inner join. <br>  First, consider an example semi join: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> parent2 p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.parent2_id = p.id); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">--------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | --------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 256 | 3 (0)| 00:00:01 | |* 1 | TABLE ACCESS FULL| CHILD | 4 | 256 | 3 (0)| 00:00:01 | --------------------------------------------------------------------------- 1 - filter("C"."PARENT2_ID" IS NOT NULL)</span></span></code> </pre><br>  And now an example of anti join: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">----------------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | ----------------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 308 | 5 (0)| 00:00:01 | |* 1 | HASH JOIN ANTI SNA | | 4 | 308 | 5 (0)| 00:00:01 | | 2 | TABLE ACCESS FULL | CHILD | 4 | 256 | 3 (0)| 00:00:01 | | 3 | INDEX FAST FULL SCAN| PARENT_PK | 2 | 26 | 2 (0)| 00:00:01 | ----------------------------------------------------------------------------------- 1 - access("C"."PARENT_ID"="P"."ID")</span></span></code> </pre><br>  As you can see, Oracle also learned how to work with these types of queries. <br><br><a name="SelfJoin"></a><h4>  <b>Self join transformation</b> </h4><br>  Much less often, but there are queries with the connection of the same table.  Fortunately, join elimination extends to them, but with a small condition - it is necessary that the connection condition uses a column with a primary key (primary key) or a unique constraint (unique constraint). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> child_child_v <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id, c.description c_desc, c2.description c2_desc <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.id = c2.id; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, c2_desc <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> child_child_v; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">--------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | --------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 100 | 2 (0)| 00:00:01 | | 1 | TABLE ACCESS FULL| CHILD | 4 | 100 | 2 (0)| 00:00:01 | ---------------------------------------------------------------------------</span></span></code> </pre><br>  Such a request is also successfully transformed: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id, c.description <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.parent3_id <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> c.id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c2.id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c2 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c2.id &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">----------------------------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | ----------------------------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 1 | 38 | 2 (0)| 00:00:01 | |* 1 | TABLE ACCESS BY INDEX ROWID| CHILD | 1 | 38 | 2 (0)| 00:00:01 | |* 2 | INDEX RANGE SCAN | SYS_C0013028957 | 3 | | 1 (0)| 00:00:01 | ----------------------------------------------------------------------------------------------- 1 - filter("PARENT3_ID" IS NULL) 2 - access("C2"."ID"&gt;1)</span></span></code> </pre><br><br><a name="RelyDisable"></a><h4>  <b>Rely disable and join elimination</b> </h4><br>  There is another interesting feature of join elimination - it continues to work even when the restrictions (foreign key and primary key) are disabled (disable), but marked as trustworthy (rely). <br><br>  To begin, just try to disable the restrictions and look at the query plan: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> <span class="hljs-keyword"><span class="hljs-keyword">modify</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> child_parent_fk <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> <span class="hljs-keyword"><span class="hljs-keyword">modify</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> parent_pk <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id, c.description <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p.id; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">----------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | ----------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 204 | 6 (0)| 00:00:01 | |* 1 | HASH JOIN | | 4 | 204 | 6 (0)| 00:00:01 | | 2 | TABLE ACCESS FULL| PARENT | 2 | 26 | 3 (0)| 00:00:01 | | 3 | TABLE ACCESS FULL| CHILD | 4 | 152 | 3 (0)| 00:00:01 | ----------------------------------------------------------------------------- 1 - access("C"."PARENT_ID"="P"."ID")</span></span></code> </pre><br>  It is expected that join elimination has stopped working.  And now we will try to specify rely disable for both constraints: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> <span class="hljs-keyword"><span class="hljs-keyword">modify</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> child_parent_fk <span class="hljs-keyword"><span class="hljs-keyword">rely</span></span> <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> <span class="hljs-keyword"><span class="hljs-keyword">modify</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> parent_pk <span class="hljs-keyword"><span class="hljs-keyword">rely</span></span> <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id, c.description <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p.id; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">--------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | --------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 152 | 3 (0)| 00:00:01 | |* 1 | TABLE ACCESS FULL| CHILD | 4 | 152 | 3 (0)| 00:00:01 | --------------------------------------------------------------------------- 1 - filter("C"."PARENT_ID" IS NOT NULL)</span></span></code> </pre><br>  As you can see, join elimination earned again. <br>  Actually, rely is intended for a slightly <a href="http://docs.oracle.com/cd/B19306_01/server.102/b14223/constra.htm">different query transformation</a> .  In such cases, it is required that the query_rewrite_integrity parameter be set to ‚Äútrusted‚Äù instead of the standard ‚Äúenforced‚Äù, but, in our case, it does not affect anything and everything works fine with the value ‚Äúenforced‚Äù. <br><br>  Unfortunately, the rely disable restrictions cause join elimination only with an inner join.  It is also worth noting that, despite the fact that we can specify rely disable primary key or rely disable foreign key for views, unfortunately, this will not work for join elimination. <br><br><a name="Param"></a><h4>  <b>Parameter _optimizer_join_elimination_enabled</b> </h4><br>  Together with such a wonderful way of transforming the query, the hidden parameter _optimizer_join_elimination_enabled was added, which is enabled by default (true) and is responsible for using this transformation. <br>  If she bothers you, you can always turn it off: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-string"><span class="hljs-string">"_optimizer_join_elimination_enabled"</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id, c.description <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p.id; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">----------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | ----------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 204 | 6 (0)| 00:00:01 | |* 1 | HASH JOIN | | 4 | 204 | 6 (0)| 00:00:01 | | 2 | TABLE ACCESS FULL| PARENT | 2 | 26 | 3 (0)| 00:00:01 | | 3 | TABLE ACCESS FULL| CHILD | 4 | 152 | 3 (0)| 00:00:01 | ----------------------------------------------------------------------------- 1 - access("C"."PARENT_ID"="P"."ID")</span></span></code> </pre><br><a name="Hints"></a><h4>  <b>ELIMINATE_JOIN and NO_ELIMINATE_JOIN Tips</b> </h4><br>  <i>Added after</i> <a href="http://habrahabr.ru/users/xtender/" class="user_link">xtender</a> <i>comment</i> . <br>  You can also use optimizer hints to control this transformation. <br>  To enable the transformation, use the ELIMINATE_JOIN hint: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-string"><span class="hljs-string">"_optimizer_join_elimination_enabled"</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-comment"><span class="hljs-comment">/*+ ELIMINATE_JOIN(p) */</span></span> c.id, c.description <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p.id; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">--------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | --------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 84 | 3 (0)| 00:00:01 | |* 1 | TABLE ACCESS FULL| CHILD | 4 | 84 | 3 (0)| 00:00:01 | --------------------------------------------------------------------------- 1 - filter("C"."PARENT_ID" IS NOT NULL)</span></span></code> </pre><br>  In order to turn the transformation off, use the NO_ELIMINATE_JOIN hint: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-string"><span class="hljs-string">"_optimizer_join_elimination_enabled"</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> plan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-comment"><span class="hljs-comment">/*+ NO_ELIMINATE_JOIN(p) */</span></span> c.id, c.description <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p.id; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display); <span class="hljs-comment"><span class="hljs-comment">-------------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | -------------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | 4 | 96 | 3 (0)| 00:00:01 | | 1 | NESTED LOOPS | | 4 | 96 | 3 (0)| 00:00:01 | | 2 | TABLE ACCESS FULL| CHILD | 4 | 84 | 3 (0)| 00:00:01 | |* 3 | INDEX UNIQUE SCAN| PARENT_PK | 1 | 3 | 0 (0)| 00:00:01 | -------------------------------------------------------------------------------- 3 - access("C"."PARENT_ID"="P"."ID")</span></span></code> </pre><br><br><a name="BadPractice"></a><h4>  <b>When join elimination is bad</b> </h4><br>  In the <a href="https://habr.com/ru/post/248817/">comments below,</a> <a href="http://habrahabr.ru/users/xtender/" class="user_link">xtender</a> gave a link to his interesting example, which shows that join elimination can worsen the query execution plan.  And also gave some explanations in the further comments. <br><br><a name="DupJoin"></a><h4>  <b>Transformation of the same compounds</b> </h4><br>  There is another transformation option - removing identical connections from a query: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p2.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p3 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p3.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.description = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p2.description = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p3.description = <span class="hljs-string"><span class="hljs-string">''</span></span> / <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display_cursor(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">'outline'</span></span>)) / <span class="hljs-comment"><span class="hljs-comment">----------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | ----------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | | | 6 (100)| | |* 1 | HASH JOIN | | 2 | 102 | 6 (0)| 00:00:01 | |* 2 | TABLE ACCESS FULL| PARENT | 1 | 25 | 3 (0)| 00:00:01 | | 3 | TABLE ACCESS FULL| CHILD | 4 | 104 | 3 (0)| 00:00:01 | ----------------------------------------------------------------------------- 1 - access("P3"."ID"="C"."PARENT_ID") 2 - filter("P3"."DESCRIPTION"='') Outline Data ------------- ... ELIMINATE_JOIN(@"SEL$EE94F965" "P"@"SEL$1") ELIMINATE_JOIN(@"SEL$EE94F965" "P2"@"SEL$2") ...</span></span></code> </pre><br>  This transformation works just as well with subqueries that turn into <a href="http://docs.oracle.com/cd/B19306_01/server.102/b14200/queries008.htm">subquery unnesting</a> : <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> parent_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-comment"><span class="hljs-comment">/*+ qb_name(query_1) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> description = <span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> parent_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-comment"><span class="hljs-comment">/*+ qb_name(query_2) */</span></span><span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> description = <span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> parent_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-comment"><span class="hljs-comment">/*+ qb_name(query_3) */</span></span><span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> description = <span class="hljs-string"><span class="hljs-string">''</span></span>) / <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display_cursor(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">'outline'</span></span>)) / <span class="hljs-comment"><span class="hljs-comment">----------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | ----------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | | | 6 (100)| | |* 1 | HASH JOIN | | 2 | 102 | 6 (0)| 00:00:01 | |* 2 | TABLE ACCESS FULL| PARENT | 1 | 25 | 3 (0)| 00:00:01 | | 3 | TABLE ACCESS FULL| CHILD | 4 | 104 | 3 (0)| 00:00:01 | ----------------------------------------------------------------------------- 1 - access("PARENT_ID"="ID") 2 - filter("DESCRIPTION"='') Outline Data ------------- ... ELIMINATE_JOIN(@"SEL$45781D08" "PARENT"@"QUERY_3") ELIMINATE_JOIN(@"SEL$45781D08" "PARENT"@"QUERY_2") ... UNNEST(@"QUERY_3") UNNEST(@"QUERY_2") UNNEST(@"QUERY_1") ...</span></span></code> </pre><br>  But, this transformation option has some differences. <br>  1) It is not necessary for it to have a foreign key relationship ‚Äî the primary key (or unique constraint): <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> child_parent_fk / <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p2.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p3 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p3.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.description = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p2.description = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p3.description = <span class="hljs-string"><span class="hljs-string">''</span></span> / <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display_cursor(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">'LAST OUTLINE'</span></span>)) / <span class="hljs-comment"><span class="hljs-comment">----------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | ----------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | | | 6 (100)| | |* 1 | HASH JOIN | | 2 | 102 | 6 (0)| 00:00:01 | |* 2 | TABLE ACCESS FULL| PARENT | 1 | 25 | 3 (0)| 00:00:01 | | 3 | TABLE ACCESS FULL| CHILD | 4 | 104 | 3 (0)| 00:00:01 | ----------------------------------------------------------------------------- 1 - access("P3"."ID"="C"."PARENT_ID") 2 - filter("P3"."DESCRIPTION"='') Outline Data ------------- ... ELIMINATE_JOIN(@"SEL$EE94F965" "P"@"SEL$1") ELIMINATE_JOIN(@"SEL$EE94F965" "P2"@"SEL$2") ...</span></span></code> </pre><br>  2) It is not affected by disabling the <a href="https://habr.com/ru/post/248817/">_optimizer_join_elimination_enabled</a> parameter: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-string"><span class="hljs-string">"_optimizer_join_elimination_enabled"</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span> / <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p2.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p3 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p3.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.description = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p2.description = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p3.description = <span class="hljs-string"><span class="hljs-string">''</span></span> / <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display_cursor(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">'OUTLINE'</span></span>)) / <span class="hljs-comment"><span class="hljs-comment">----------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | ----------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | | | 6 (100)| | |* 1 | HASH JOIN | | 2 | 102 | 6 (0)| 00:00:01 | |* 2 | TABLE ACCESS FULL| PARENT | 1 | 25 | 3 (0)| 00:00:01 | | 3 | TABLE ACCESS FULL| CHILD | 4 | 104 | 3 (0)| 00:00:01 | ----------------------------------------------------------------------------- 1 - access("P3"."ID"="C"."PARENT_ID") 2 - filter("P3"."DESCRIPTION"='') Outline Data ------------- ... ELIMINATE_JOIN(@"SEL$EE94F965" "P"@"SEL$1") ELIMINATE_JOIN(@"SEL$EE94F965" "P2"@"SEL$2") ...</span></span></code> </pre><br>  But at least there are tips: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-comment"><span class="hljs-comment">/*+ no_eliminate_join(p) no_eliminate_join(p2) no_eliminate_join(p3) */</span></span> c.id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p2.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p3 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p3.id = c.parent_id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.description = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p2.description = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p3.description = <span class="hljs-string"><span class="hljs-string">''</span></span> / <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(dbms_xplan.display_cursor()) / <span class="hljs-comment"><span class="hljs-comment">-------------------------------------------------------------------------------------------- | Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | -------------------------------------------------------------------------------------------- | 0 | SELECT STATEMENT | | | | 8 (100)| | | 1 | NESTED LOOPS | | 1 | 101 | 8 (0)| 00:00:01 | | 2 | NESTED LOOPS | | 1 | 101 | 8 (0)| 00:00:01 | | 3 | NESTED LOOPS | | 1 | 76 | 8 (0)| 00:00:01 | |* 4 | HASH JOIN | | 2 | 102 | 6 (0)| 00:00:01 | |* 5 | TABLE ACCESS FULL | PARENT | 1 | 25 | 3 (0)| 00:00:01 | | 6 | TABLE ACCESS FULL | CHILD | 4 | 104 | 3 (0)| 00:00:01 | |* 7 | TABLE ACCESS BY INDEX ROWID| PARENT | 1 | 25 | 1 (0)| 00:00:01 | |* 8 | INDEX UNIQUE SCAN | PARENT_PK | 1 | | 0 (0)| | |* 9 | INDEX UNIQUE SCAN | PARENT_PK | 1 | | 0 (0)| | |* 10 | TABLE ACCESS BY INDEX ROWID | PARENT | 1 | 25 | 0 (0)| | -------------------------------------------------------------------------------------------- 4 - access("P"."ID"="C"."PARENT_ID") 5 - filter("P"."DESCRIPTION"='') 7 - filter("P2"."DESCRIPTION"='') 8 - access("P2"."ID"="C"."PARENT_ID") 9 - access("P3"."ID"="C"."PARENT_ID") 10 - filter("P3"."DESCRIPTION"='')</span></span></code> </pre><br><a name="Summary"></a><h4>  <b>Total</b> </h4><br>  To summarize, I would like to say that this method of transformation can be really useful in some cases.  But rely on it must also be wisely.  If something changes inside your view and Oracle can no longer guarantee that the connection to this view does not filter or multiply the rows, you will get an unexpected loss in query execution speed. <br><br><div class="spoiler">  <b class="spoiler_title">And finally, a script to delete all created objects.</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> child_parents_v; <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> child_child_v; <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> parent2; <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> parent3;</code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/248817/">https://habr.com/ru/post/248817/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248803/index.html">Do you still have SSL3 enabled? Check server and browser for POODLE vulnerability</a></li>
<li><a href="../248807/index.html">We deliver voice to the mobile network: step 1 - how the voice turns into an electrical signal</a></li>
<li><a href="../248809/index.html">Age rating of Windows Store games in plain language</a></li>
<li><a href="../248813/index.html">Getting rid of StandardStyles.xaml in Windows 8.1</a></li>
<li><a href="../248815/index.html">C # for AS3 developers. Part 3: get, set, sealed, using, const, readonly</a></li>
<li><a href="../248821/index.html">Dagaz: Kicks to common sense (part 2)</a></li>
<li><a href="../248823/index.html">How to "tie" CLIPS to an application for Linux</a></li>
<li><a href="../248827/index.html">We get a list of members of the VKontakte community of a certain gender and age</a></li>
<li><a href="../248829/index.html">Modern Business Intelligence (BI) systems by the example of IBM Cognos BI</a></li>
<li><a href="../248831/index.html">Features of the Intel x86 Hi-End Server - HP Superdome X System</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>