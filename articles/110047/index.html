<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Module ustats: statistics of requests to backends</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings 

 This article will discuss a new module for nginx, the purpose of which is to collect and provide the user with statistics on server backe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Module ustats: statistics of requests to backends</h1><div class="post__text post__text-html js-mediator-article">  Greetings <br><br>  This article will discuss a new module for nginx, the purpose of which is to collect and provide the user with statistics on server backend server access.  Under the cut - details, examples of use, screenshots, links, as well as the history of creation. <br><br><a name="habracut"></a><br><h4>  Story </h4><br>  Not so long ago, in the server support department of our company, we came to the conclusion that it was time to change something.  More precisely, it was necessary to solve problems with the distribution of the increased load - our fronts began to cope with their task with difficulty. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      With the help of JMeter, we drove to the stand of nginx, HAProxy, Brocade Server Iron ADX 1000 and a number of other balancers.  The main selection criterion was the possibility of termination of about 50 thousand simultaneous ssl-sessions during peak periods.  After long testing, for various reasons, all options except nginx and its iron competitor Brocade Server have disappeared, and only the first of them has remained.  All other things being equal, probably decisive factors in favor of nginx were the flexibility of its configuration and lightness. <br><br><h4>  Problem </h4><br>  Earlier, HAProxy was used as a balancer on some fronts.  After switching to nginx, it became clear that we lack in it some informative statistics of work with backends.  The fact is that the same HAProxy had such statistics, and with its help we tracked the problems arising on the backends and promptly reacted to them.  With the new balancer, we were left without these statistics, like without hands.  stub_status and similar modules did not suit us, since  Their function is to show statistics not in the context of a separate Upstream, but of the server as a whole.  We also wanted for each upstream / backend to have data on such parameters as the <i>number of calls</i> to each backend and the number <i>of HTTP errors 499/500/503 and TCP</i> , and this list later expanded. <br><br><h4>  Decision </h4><br>  Since we did not find any ready-made solutions to our problem, an attempt was made to write a module that would provide the necessary information in a visual form.  The attempt, I think, was a success, and the result was the module <b>ustats</b> ( <i>upstream statistics</i> ). <br><br><h5>  What statistics? </h5><br>  With ustats, you can keep statistics on such backend indicators as <br><ul><li>  <i>Number of requests</i> . </li><li>  <i>The number of errors 499/500/503</i> . </li><li>  <i>The number of HTTP timeouts read and write</i> . </li><li>  <i>The number of TCP connection errors</i> . </li><li>  <i>Failure timer (fail_timeout)</i> .  In nginx, this parameter is configured by the directive of the same name and determines the period of time during which several unsuccessful backend calls should occur in succession (the exact number is indicated by the max_fails directive), after which the backend is placed on the black list, and there are no calls to it yet time fail_timeout.  Usually, the administrator and himself know what timeouts are registered in his server config, but still it seemed like a good idea to have them in front of them. </li><li>  <i>The number of failed attempts to work with the backend (fails count)</i> .  Inside nginx for each backend there is a counter of unsuccessful attempts to work.  This number shows how many times during the fail timeout time nginx tried to knock on the backend and failed (for what is considered a failure, see the description of the proxy_pass directive).  The principle of operation of the counter is quite simple.  When nginx is going to redirect the request, it first looks at which backend is next in line (if it‚Äôs about round robin balancing), checks its status (on the black list or not), and if the backend is ‚Äúignored‚Äù, the server looks at the time of its last failure .  If the fail_timeout time has already passed since then, the counter of failed attempts for the backend is reset and the request is sent.  If the backend was not on the black list, then the request is sent immediately, and the counter may be reset, depending on the time that has passed since the first unsuccessful call. </li><li>  <i>Maximum number of failed calls (max_fails)</i> .  Defines the threshold for the number of unsuccessful attempts to work with the backend, at which it is placed on the blacklist for the period of time fail_timeout.  This parameter is also written in the nginx config, and we added its mapping to the statistics for clarity. </li><li>  <i>Last unsuccessful call</i> to backend.  His appointment should be clear from the previous paragraphs :) </li></ul><br><h5>  Additional functions </h5><br>  Also ustats can show which backends are currently on the black list.  I will note that a backend is understood not as what is indicated in the nginx configuration by the server directive, but directly at the address where the name specified in the directive is located.  If there are several addresses behind one name in the DNS, then the module shows them as separate backends (not forgetting to indicate what name they came from). <br><br>  In addition to highlighting backends from the blacklist, ustats highlights off the server, i.e.  described in the nginx config as <br><pre> ...
 server some.server.name down;
 ...
</pre><br>  And finally, using the module, you can turn on and off the servers from the nginx topology while it is running, via the web interface.  Changes are not saved in the config and are designed to facilitate the conduct of those.  works involving the temporary disconnection of backends.  I want to warn: ustats does not provide any protection against unauthorized execution of this action, so you have to independently ensure that a random person does not exclude half of the backends on your site from work :) <br><br><h5>  Usage scenarios </h5><br>  There are two of them.  Firstly, the module provides all the statistics in the form of a web page with a table, the display of which can be hung on any location, like stub_status: <br><pre> location / ustats {
	 ustats on;
	 ...
 }
</pre><br>  The page is automatically updated, and the update interval (in milliseconds) can be configured in the config: <br><pre> ...
 ustats_refresh_interval 7000
 ...
</pre><br>  The second scenario assumes that the module is used as a data source for other monitoring utilities.  In this case, corresponding requests are made to it, in response to which it returns an ordinary xml with the necessary information.  You can request data on one upstream or one backend.  For example, the query <br><br><pre> / ustats? u = offline
</pre><br>  returns data on all backends in upstream <i>offline</i> , and on request <br><br><pre> / ustats? u = break &amp; b = the_mold
</pre><br>  back data from the_mold <i>backend</i> in upstream <i>break</i> .  If an upstream or backend is not found, the response xml will say this. <br><br><h4>  Some pictures </h4><br>  Not to be unfounded, here are some screenshots of the page, the result of the module.  In nginx, from the first snapshot, there are 2 upstream configured, in which all servers are local, raised on the same nginx, except for the www server ‚Äî it resolves to Yandex addresses: <br><img src="https://habrastorage.org/storage/habraeffect/b0/56/b056c6f190565be9b5010d7eaca1bade.png"><br>  In the photo you can see the gray lines - these are backends marked as ‚Äúdown‚Äù in the nginx config, or turned off via the module page.  No figures yet. <br><br>  In the second screenshot, the red lines highlight three backends from the first upstream that were on the black list, which prevented sending requests to them. <br><img src="https://habrastorage.org/storage/habraeffect/36/6c/366c21a14d5a46c4dcfd755c0d2e6bb2.png"><br>  Coupled with the fact that three more backends were turned off, the only remaining one took over the entire load. <br><br>  Finally, the last picture was taken on the working front-end from our site: <br><img src="https://habrastorage.org/storage/habraeffect/87/0a/870a8c189ccbcac802c540ac22701181.png"><br>  The picture shows another feature, which I have not mentioned.  Upstream lights are lit a little lighter below - this is a sign that they are defined in the config file implicitly, i.e.  not this way <br><pre> upstream give_me_a_name {
   ...
 }
</pre><br>  and so <br><pre> location / whereami {
 ...
 proxy_pass http://192.168.0.75:8080
 ...
 }
</pre><br><br><h4>  Total </h4><br>  We <a href="http://ustats.googlecode.com/">posted the</a> source code module on the page Google Code.  The repository contains the patch file for nginx, the source file + the configuration file.  On the module page there are installation instructions, and additional configuration directives are also described there.  The current version of the module was tested with nginx version 0.8.53 in Chrome, Firefox and Opera browsers.  Finally, I must say that ustats is just an attempt to add the most basic mechanism for displaying data on working with backends to nginx.  In the future, I would like to see such useful modules in the main branch of the server as, for example, advanced health check backends. </div><p>Source: <a href="https://habr.com/ru/post/110047/">https://habr.com/ru/post/110047/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110037/index.html">Opera 11.00 Release Candidate 1</a></li>
<li><a href="../110039/index.html">Yahoo reduced staff by 4%, laying off more than 500 employees</a></li>
<li><a href="../110040/index.html">PHPLego: Hotkeys - hotkey attribute</a></li>
<li><a href="../110043/index.html">PR, fraud and bullshit in the service of science. Part I. PR</a></li>
<li><a href="../110044/index.html">Not only phones</a></li>
<li><a href="../110049/index.html">AnyChart Stock - flexible, fast and interactive datetime-based graphics</a></li>
<li><a href="../110050/index.html">Data encryption in ORACLE DB according to GOST</a></li>
<li><a href="../110051/index.html">MyTaskHelper - online database creation system (demo video)</a></li>
<li><a href="../110052/index.html">Testing the monitoring system of virtual servers</a></li>
<li><a href="../110055/index.html">Video from HighLoad ++ in Mail.Ru: James Golick - Scaling to the Hundreds of Millions of Requests: What Worked and What Didn't</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>