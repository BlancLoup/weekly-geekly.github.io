<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development and testing of chef dolls with Sparrowdo v2 tool</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I have already written about the sparrowdo tool and its use in developing chef configuration scripts. 


 Well, during this time a lot of water...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development and testing of chef dolls with Sparrowdo v2 tool</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello!  I have already <a href="https://habrahabr.ru/post/313034/">written</a> about the <a href="https://github.com/melezhik/sparrowdo">sparrowdo</a> tool and its use in developing <a href="https://www.chef.io/">chef</a> configuration scripts. </p><br><p>  Well, during this time a lot of water has flowed under the bridge and I wanted to reveal this topic a little bit again, which is why the title of the article contains version two. </p><br><p>  So - sparrowdo is a configuration management system written in the wonderful language <a href="http://perl6.org/">Perl6</a> , which has been actively developing lately.  In my personal work, I find sparrowdo very convenient and organically coexisting with a more powerful configuration management platform - <a href="https://www.chef.io/">opscode chef</a> .  In a few specific examples, I will show how I use chef with sparrowdo.  This post will not be very long, but I hope will give an understanding of what is at stake. </p><a name="habracut"></a><br><p>  What we have?  By virtue of my main professional activity, I have to write a lot of chef <a href="https://docs.chef.io/cookbooks.html">kukbukov</a> .  In our project, <a href="https://aws.amazon.com/">aws</a> services are actively used, so creating a server and installing a chef client on it is quite cheap and resource-intensive, so I can easily debug chef recipes by running the chef client on a remote ssh server instead of using more traditional <a href="https://www.vagrantup.com/">vagrant</a> cases </p><br><p> Well, in this way, the development and debugging process of the cookbooks comes down to the fact that while developing the next version of recipes, I update the cookbook on the chef server using the <a href="https://docs.chef.io/knife_upload.html">knife upload</a> command and run the test cookbook further on the remote server using the <code>chef-client</code> command (with the specified wound list).  Actually, while catching various errors and falls arising during the deployment (if expressed in the language of the documentation chef - convergence node) </p><br><p>  In this situation, sparrowdo is very convenient for me - which, unlike chef, is a push based configuration management tool or, quite simply, it can execute its scripts on a remote ssh host. </p><br><p>  As you can already begin to guess - the scenario in this case will be like this - run the chef client on the remote machine. </p><br><p>  Sparrowdo supports modularity - you can extend its basic functionality through modules written in Perl6, so I specifically wrote a module for this task called <a href="https://github.com/melezhik/sparrowdo-chef-client">Sparrowdo :: Chef :: Client</a> </p><br><p>  The interface of the module is quite simple - it provides the necessary minimum for running the client chef - namely, specifying the <a href="https://docs.chef.io/run_lists.html">wounds of the sheet</a> and optionally setting the <a href="https://docs.chef.io/attributes.html">attributes</a> </p><br><p>  Here is how the script for launching the <a href="https://supermarket.chef.io/cookbooks/java">java java</a> with the installation of the attribute specifying the version of the jdk being installed will look like: </p><br><pre> <code class="hljs javascript">$ cat sparrowfile module_run <span class="hljs-string"><span class="hljs-string">'Chef::Client'</span></span>, %( run-<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">list</span></span></span><span class="hljs-function"> =&gt;</span></span> [ <span class="hljs-string"><span class="hljs-string">"recipe[java]"</span></span> ], attributes =&gt; %( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">java</span></span></span><span class="hljs-function"> =&gt;</span></span> %( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">jdk_version</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> ), ), log-<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">level</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'info'</span></span>, force-<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">formatter</span></span></span><span class="hljs-function"> =&gt;</span></span> True );</code> </pre> <br><p>  In our projects, we mainly use jdk version 7, so I expose it through the corresponding chef attribute, which overrides the default value. </p><br><p>  Here is what the sparrowdo report will look like when running on a remote server: </p><br><pre> <code class="hljs cmake">$ sparrowdo --host=remote.server --ssh_user=centos --ssh_private_key=/home/melezhik/.ssh/foo.pem running sparrow tasks <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> remote.server ... <span class="hljs-keyword"><span class="hljs-keyword">target</span></span> OS is - centos7 enter module &lt;Chef::Client&gt; ... push task &lt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> up chef run <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> attributes&gt; plg &lt;<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>&gt; OK push task &lt;run chef-client&gt; plg &lt;bash&gt; OK <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> up task box <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> - /tmp/sparrowdo/task-box8938.json - OK get index updates from SparrowHub ... OK public@<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> is uptodate (<span class="hljs-number"><span class="hljs-number">0.0</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span>) public@bash is uptodate (<span class="hljs-number"><span class="hljs-number">0.1</span></span>.<span class="hljs-number"><span class="hljs-number">4</span></span>) running task box from /tmp/sparrow-cache/task-box8938.json ... [t] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> up chef run <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> attributes at <span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">target</span></span> content touch <span class="hljs-keyword"><span class="hljs-keyword">target</span></span> <span class="hljs-keyword"><span class="hljs-keyword">target</span></span> created <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">target</span></span> mode to <span class="hljs-number"><span class="hljs-number">644</span></span> ok scenario succeeded ok text match /<span class="hljs-keyword"><span class="hljs-keyword">target</span></span> (created|deleted)/ ok text has '<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">target</span></span> content' STATUS SUCCEED [t] run chef-client @ runs bash <span class="hljs-keyword"><span class="hljs-keyword">command</span></span> [t] run chef-client modules/bash-<span class="hljs-keyword"><span class="hljs-keyword">command</span></span>/ params: envvars: at <span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span> [<span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>T13:<span class="hljs-number"><span class="hljs-number">35</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Forking chef instance to converge... Starting Chef Client, version <span class="hljs-number"><span class="hljs-number">12.19</span></span>.<span class="hljs-number"><span class="hljs-number">36</span></span> <span class="hljs-comment"><span class="hljs-comment"># #   # Chef Client finished, 7/9 resources updated in 38 seconds ok scenario succeeded STATUS SUCCEED</span></span></code> </pre> <br><p>  Well, this is a simple example of how we can manage the settings of the cookbooks that are run, exposing the wound list and various attributes.  I will cite below some more interesting cases. </p><br><h1 id="testirovanie-prohozhdeniya-granichnyh-usloviy">  boundary condition testing </h1><br><p>  It is no secret that a large number of tasks on configuration management and automation is associated with the launch of network services.  For example, we have a cookiebook that configures and restarts the nginx server according to some nontrivial rule set.  I think those who wrote these kinds of recipes often came up against the fact that their scripts could behave differently with respect to different states of the service at the beginning.  Here, for example, I want to see what will happen, and whether my deployment will not fall down if nginx is not started before the chef recipe is executed, using sparrowdo, which itself is also a configuration management tool, is easy to do: </p><br><pre> <code class="hljs sql">$ cat sparrowfile service-<span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> <span class="hljs-string"><span class="hljs-string">'nginx'</span></span> module_run <span class="hljs-string"><span class="hljs-string">'Chef::Client'</span></span>, %( run-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"recipe[nginx-app::configure]"</span></span> ] );</code> </pre> <br><p>  You must agree that it would not be good to embed nginx into the chef of recipes, just to test the behavior of our main cookbook.  And here with the help of sparrowdo we do it easily and naturally, without changing anything in the code of the chef cookbook itself </p><br><h1 id="vstroennye-post-deployment--audit-testy">  embedded post deployment / audit tests </h1><br><p>  Often it is required to check the work of the client‚Äôs chief after he has worked.  There are various options for solving this problem - <a href="https://github.com/test-kitchen/test-kitchen">test-kitchen</a> / <a href="http://serverspec.org/">serverspec</a> , <a href="https://github.com/aelsabbahy/goss">goss</a> , <a href="https://github.com/chef/minitest-chef-handler">chef minitest-handler</a> , <a href="https://github.com/chef/inspec">inspec</a> they all have their pros and cons.  But here you have another alternative - sparrowdo - the basic meaning is the same - we do checks side by side, or rather inside the sparrowdo script, here‚Äôs one of my favorite checks that the tomcat server is running and ‚Äúvisible‚Äù in the list of processes - practice shows that Sometimes chef does not catch the situation with the fall of the restarted service and we need to do it ourselves: </p><br><pre> <code class="hljs sql">$ cat sparrowfile service-<span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> <span class="hljs-string"><span class="hljs-string">'nginx'</span></span> module_run <span class="hljs-string"><span class="hljs-string">'Chef::Client'</span></span>, %( run-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"recipe[tomcat-app::configure]"</span></span> ] ); task-run '<span class="hljs-keyword"><span class="hljs-keyword">check</span></span> tomcat<span class="hljs-string"><span class="hljs-string">', '</span></span>proc-<span class="hljs-keyword"><span class="hljs-keyword">validate</span></span><span class="hljs-string"><span class="hljs-string">', %( pid_file =&gt; '</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/tomcat7.pid<span class="hljs-string"><span class="hljs-string">', footprint =&gt; '</span></span><span class="hljs-keyword"><span class="hljs-keyword">java</span></span><span class="hljs-string"><span class="hljs-string">' );</span></span></code> </pre><br><h1 id="neobyazatelnye-zavisimosti">  optional dependencies </h1><br><p>  And finally, the last is the simplest and most obvious case (but this does not lose its relevance) - you need to <em>temporarily</em> install additional packages and utilities on the server being tested.  You do not want to include this in your chef recipes, because these dependencies do not have a relationship to installing applications, but you need them to debug installed applications, well, just add them through sparrowdo without changing the code of the chef recipes you wrote. </p><br><p>  Here, for example, a specialized package, which we hardly need in production, but <br>  It will be necessary if we want to do debugging java code: </p><br><pre> <code class="hljs sql">package-<span class="hljs-keyword"><span class="hljs-keyword">install</span></span> <span class="hljs-string"><span class="hljs-string">'java-1.7.0-openjdk-debuginfo'</span></span> module_run <span class="hljs-string"><span class="hljs-string">'Chef::Client'</span></span>, %( run-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"recipe[java]"</span></span> ] );</code> </pre> <br><p>  On this I finish.  In conclusion, I would like to say that in my personal work related to the daily development of dozens of dollies for hundreds of different projects, sparrowdo has established itself as an excellent companion tool that significantly speeds up and simplifies the development and testing of chef scripts. </p><br><p>  As usual, I will be glad to questions and constructive criticism. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/325848/">https://habr.com/ru/post/325848/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325838/index.html">Organization of adaptive layout in BEM with SCSS</a></li>
<li><a href="../325840/index.html">Ways of de-anonymization of community leaders and Vkontakte applications</a></li>
<li><a href="../325842/index.html">Analysis of level schemes for improving multiplayer shooters</a></li>
<li><a href="../325844/index.html">The updated Mirai botnet is back, becoming even more powerful.</a></li>
<li><a href="../325846/index.html">Writing "Hello, World" Telegram bot on C</a></li>
<li><a href="../325850/index.html">Examples of real patches in PostgreSQL: part 3 of N</a></li>
<li><a href="../325852/index.html">Enough design in the sketch. Do design in the browser</a></li>
<li><a href="../325856/index.html">Facebook API: fixing a broken Like button on a site</a></li>
<li><a href="../325858/index.html">The world of payment mediation: a workshop in magic</a></li>
<li><a href="../325860/index.html">Openfire + Miranda NG. One-click remote help and a couple of features.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>