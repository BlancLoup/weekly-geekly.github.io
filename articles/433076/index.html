<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we made our Android Gallery library to view media content</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! Not so long ago, in search of adventure, new projects and technologies, I  became a robot  settled in redmadrobot. I received a chair, a mon...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we made our Android Gallery library to view media content</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/fl/a3/rh/fla3rh2hkzl_guxybjkro7f8hua.png"><br><br>  Hi, Habr!  Not so long ago, in search of adventure, new projects and technologies, I <del>  became a robot </del>  settled in redmadrobot.  I received a chair, a monitor, and a MacBook, and for warming up, a small internal project.  It was necessary to finish and publish a samopisny library for viewing media content that we use in our projects.  In the article I will tell you how to get into touch events in a week, to become an open source, find a bug in Android sdk and publish a library. </p><a name="habracut"></a><br><h2 id="nachalo">  Start </h2><br><p>  One of the important features of our application stores is the ability to view videos and photos of goods and services in close proximity and on all sides.  We did not want to reinvent the wheel and went in search of a ready-made library that would suit us. </p><br><p>  They planned to find such a solution so that the user could: </p><br><ul><li>  view photos; </li><li>  Scale photos with pinch to zoom and double tap; </li><li>  view video; </li><li>  flipping media content; </li><li>  close the photo card with a vertical swipe (swipe to dismiss). </li></ul><br><p>  Here is what we found: </p><br><ul><li>  <a href="https://github.com/stfalcon-studio/FrescoImageViewer">FrescoImageViewer</a> - supports viewing and scrolling photos and basic gestures, but does not support video viewing and is intended for the <a href="https://github.com/facebook/fresco">Fresco</a> library. </li><li>  <a href="https://github.com/chrisbanes/PhotoView">PhotoView</a> - supports photo viewing, most of the basic control gestures, except for scrolling, swipe to dismiss, does not support video viewing. </li><li>  <a href="https://github.com/ongakuer/PhotoDraweeView">PhotoDraweeView</a> is similar in PhotoView functionality, but designed for Fresco. </li></ul><br><p>  Since none of the found libraries fully met the requirements, we had to write our own. </p><br><h2 id="realizuem-biblioteku">  We implement the library </h2><br><p>  To get the desired functionality, we have refined existing solutions from other libraries.  What turned out, they decided to give the modest name of the <a href="https://github.com/redmadrobot-spb/android-gallery">Android Gallery</a> . </p><br><h3 id="realizuem-funkcionalnost">  We implement functionality </h3><br><p>  <strong>View and zoom photos</strong> <br>  To view the photos, they took the PhotoView library, which supports scaling out of the box. </p><br><p>  <strong>View video</strong> <br>  To view the video, they took <a href="https://github.com/google/ExoPlayer">ExoPlayer</a> , which is reused in the <a href="">MediaPagerAdapter</a> .  When a user opens a video for the first time, ExoPlayer is created.  When you move to another item, it is queued, so the next time you start the video, the already created instance of ExoPlayer will be used.  This makes the transition between elements smoother. </p><br><p>  <strong>Flipping media content</strong> <br>  Here we used <a href="">MultiTouchViewPager</a> from FrescoImageViewer, which does not intercept multi touch events, so we could add gestures to it to scale the image. </p><br><p>  <strong>Swipe to dismiss</strong> <br>  In PhotoView, there was no support for swipe to dismiss and debowns (restoring the original size of the picture when the picture is scaled up or down). <br>  That's how we managed to handle it. </p><br><h3 id="izuchaem-touch-events-dlya-realizacii-swipe-to-dismiss">  We study touch events to implement swipe to dismiss </h3><br><p> Before moving on to support swipe to dismiss, you need to figure out how touch events work.  When the user touches the screen, in the current Activity, the <code>dispatchTouchEvent(motionEvent: MotionEvent)</code> method is called, to which <code>MotionEvent.ACTION_DOWN</code> falls.  This method decides the further fate of the event.  You can pass a <code>motionEvent</code> to <code>onTouchEvent(motionEvent: MotionEvent)</code> to handle the touch or move it further up the hierarchy of the View.  A view that is interested in the event and / or in subsequent events prior to <code>ACTION_UP</code> returns true. </p><br><p>  After all the events of the current gesture (gesture) will fall into this View, until the gesture ends with an <code>ACTION_UP</code> event or the parent ViewGroup takes control (then the <code>ACTION_CANCELED</code> event comes to the View).  If an event has bypassed the entire hierarchy of View and no one is interested, it returns back to the Activity in <code>onTouchEvent(motionEvent: MotionEvent)</code> . <br><br><img src="https://habrastorage.org/webt/yz/np/jd/yznpjdfaodnwmd3tzy_wldagyak.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In our Android Gallery library, the first <code>ACTION_DOWN</code> event comes to <code>dispatchTouchEvent()</code> in PhotoView, where <code>motionEvent</code> passed to the <code>onTouch()</code> implementation, which returns true.  Then all the events go through the same chain, until one of the following happens: </p><br><ul><li>  <code>ACTION_UP</code> ; </li><li>  The ViewPager will attempt to intercept the event for scrolling; </li><li>  <a href="">VerticalDragLayout</a> will attempt to intercept the event for the swipe to dismiss. </li></ul><br><p>  Event capture can only be performed by the ViewGroup in the <code>onInterceptTouchEvent(motionEvent: MotionEvent)</code> .  Even if View is interested in any MotionEvent, the event itself will pass through the <code>dispatchTouchEvent(motionEvent: MotionEvent)</code> entire previous ViewGroup chain.  Accordingly, parents always ‚Äúwatch‚Äù their children.  Any parent ViewGroup can intercept the event and return true in the <code>onInterceptTouchEvent(motionEvent: MotionEvent)</code> method <code>onInterceptTouchEvent(motionEvent: MotionEvent)</code> , then all child View will receive <code>MotionEvent.ACTION_CANCEL</code> in <code>onTouchEvent(motionEvent: MotionEvent)</code> . </p><br><p>  Example: a user holds a finger on a certain element in RecyclerView, then the events are processed in the same element.  But as soon as he starts moving his finger up / down, RecyclerView intercepts the events and starts scrolling, and View receives the <code>ACTION_CANCEL</code> event. <br><br><img src="https://habrastorage.org/webt/yp/x9/kf/ypx9kf8alvwtag0jfihj-jrzjmo.png"><br><br>  In Android, Gallery VerticalDragLayout can intercept events for swipe to dismiss or ViewPager for browsing.  But View can forbid a parent to intercept events by calling the <code>requestDisallowInterceptTouchEvent(true)</code> method.  This may be necessary if View needs to perform such actions, the interception of which by its parent is not desirable for us. </p><br><p>  For example, when a user in a player scrolls a track to a specific time.  If the parent ViewPager intercepted the horizontal scroll, there would be a transition to the next track. </p><br><p>  We wrote VerticalDragLayout to handle the swipe to dismiss, but he didn‚Äôt receive a touch of events from PhotoView.  To understand why this is happening, I had to figure out how touch events are handled in PhotoView. </p><br><p>  Processing order: </p><br><ol><li>  When MotionEvent.ACTION_DOWN in VerticalDragLayout, <code>interceptTouchEvent()</code> fired, which returns false, since  This ViewGroup is only interested in vertical ACTION_MOVE.  The direction of ACTION_MOVE is defined in <code>dispatchTouchEvent()</code> , after which the event is passed to the <code>super.dispatchTouchEvent()</code> method in ViewGroup, where the event is passed to the implementation of <code>interceptTouchEvent()</code> in VerticalDragLayout. <br><br><img src="https://habrastorage.org/webt/le/zg/xb/lezgxbf8n-_tnhdpqc96drpjqvm.png"><br><br></li><li>  When the <code>ACTION_DOWN</code> event reaches the <code>onTouch()</code> method in PhotoView, the view selects the ability to intercept event management.  All subsequent gesture events do not fall into the <code>interceptTouchEvent()</code> method.  The ability to intercept control is given to the parent only if the gesture is completed or if the horizontal <code>ACTION_MOVE</code> at the right / left border of the image. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mAllowParentInterceptOnEdge &amp;&amp; !mScaleDragDetector.isScaling() &amp;&amp; !mBlockParentIntercept) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mScrollEdge == EDGE_BOTH || (mScrollEdge == EDGE_LEFT &amp;&amp; dx &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mScrollEdge == EDGE_RIGHT &amp;&amp; dx &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }</code> </pre> <br><p><img src="https://habrastorage.org/webt/kk/s3/pj/kks3pjkovqsyiyiaif64bc_qh3e.png"><br><br>  Since PhotoView allows the parent to intercept control only in the case of horizontal <code>ACTION_MOVE</code> , and swipe to dismiss is vertical <code>ACTION_MOVE</code> , VerticalDragLayout cannot intercept event management for the gesture.  To fix, you need to add the ability to intercept controls in the case of vertical <code>ACTION_MOVE</code> . <br></p><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mAllowParentInterceptOnEdge &amp;&amp; !mScaleDragDetector.isScaling() &amp;&amp; !mBlockParentIntercept) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mHorizontalScrollEdge == HORIZONTAL_EDGE_BOTH || (mHorizontalScrollEdge == HORIZONTAL_EDGE_LEFT &amp;&amp; dx &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mHorizontalScrollEdge == HORIZONTAL_EDGE_RIGHT &amp;&amp; dx &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>) || mVerticalScrollEdge == VERTICAL_EDGE_BOTH || (mVerticalScrollEdge == VERTICAL_EDGE_TOP &amp;&amp; dy &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mVerticalScrollEdge == VERTICAL_EDGE_BOTTOM &amp;&amp; dy &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }</code> </pre> <br><p>  Now, in the case of the first vertical <code>ACTION_MOVE</code> PhotoView will allow the parent to intercept <br><br><img src="https://habrastorage.org/webt/j7/ea/_z/j7ea_zwmamtooghpppzcyxl-bne.png"><br><br>  The following <code>ACTION_MOVE</code> will be intercepted in VerticalDragLyout, while the <code>ACTION_CANCEL</code> event will arrive in the children View: <br><br><img src="https://habrastorage.org/webt/jb/ag/tz/jbagtzmul81dakmf0nujxzumw6u.png"><br><br>  All other <code>ACTION_MOVE</code> will arrive in VerticalDragLayout on a standard chain.  It is important that after the ViewGroup intercepts event management from the child View, the child View can not regain control. <br><br><img src="https://habrastorage.org/webt/ud/ql/yv/udqlyv7d4-aigffi5hdwypwfy5u.png"><br><br>  So we implemented swipe to dismiss support for the PhotoView library.  In our library, we used the modified SourceView source codes, which were moved to a separate module, and <a href="https://github.com/chrisbanes/PhotoView/pull/640">merge request was</a> created in the original PhotoView repository. <br><br></p><h3 id="realizuem-debauns-v-photoview">  Implement debowns in PhotoView </h3><br><p>  Recall that debounce is an animation of restoring an acceptable scale when an image is scaled beyond its limits. <br><br><img src="https://habrastorage.org/webt/op/rv/wb/oprvwbemhg9ikmrm1zfv45w6fvo.gif"><br><br>  In PhotoView, this was not possible.  But since we began to dig someone else's open source, why stop there?  In PhotoView, you can set a zoom limit.  Initially, this is the minimum - x1 and maximum - x3.  The image cannot go beyond these limits. </p><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> scaleFactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> focusX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> focusY)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((getScale() &lt; mMaxScale || scaleFactor &lt; <span class="hljs-number"><span class="hljs-number">1f</span></span>) &amp;&amp; (getScale() &gt; mMinScale || scaleFactor &gt; <span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mScaleChangeListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mScaleChangeListener.onScaleChange(scaleFactor, focusX, focusY); } mSuppMatrix.postScale(scaleFactor, scaleFactor, focusX, focusY); <span class="hljs-comment"><span class="hljs-comment">//      checkAndDisplayMatrix(); } }</span></span></code> </pre> <br><p>  To begin with, we decided to remove the ‚Äúno scaling on reaching the minimum‚Äù condition: we simply threw out the <code>getScale() &gt; mMinScale || scaleFactor &gt; 1f</code>  <code>getScale() &gt; mMinScale || scaleFactor &gt; 1f</code> .  And then suddenly ... <br><br><img src="https://habrastorage.org/webt/z_/ra/xg/z_raxgeezaf7o0h0zprufgrtggq.jpeg"><br><br>  Debown earned!  Apparently, this happened due to the fact that the creators of the library decided to double insure themselves by doing both the debounce and the scaling restriction.  In the implementation of the onTouch event, namely in the case of <code>MotionEvent.ACTION_UP</code> , if the user has scaled more / less than the maximum / minimum, <a href="">AnimatedZoomRunnable is</a> launched, which returns the image to its original size. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v, MotionEvent ev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> handled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (ev.getAction()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MotionEvent.ACTION_UP: <span class="hljs-comment"><span class="hljs-comment">// If the user has zoomed less than min scale, zoom back // to min scale if (getScale() &lt; mMinScale) { RectF rect = getDisplayRect(); if (rect != null) { v.post(new AnimatedZoomRunnable(getScale(), mMinScale, rect.centerX(), rect.centerY())); handled = true; } } else if (getScale() &gt; mMaxScale) { RectF rect = getDisplayRect(); if (rect != null) { v.post(new AnimatedZoomRunnable(getScale(), mMaxScale, rect.centerX(), rect.centerY())); handled = true; } } break; } }</span></span></code> </pre> <br><p>  Just like with the swipe to dismiss, we finalized the PhotoView in the source code of our library and created a <a href="https://github.com/chrisbanes/PhotoView/pull/666">pull request</a> with the addition of a debown to the original PhotoView. </p><br><h3 id="ispravlyaem-vnezapnyy-bag-v-photoview">  Fix a sudden bug in PhotoView </h3><br><p>  There is a very nasty bug in PhotoView.  When the user wants to enlarge the image by double tap and <del>  he has an epileptic seizure </del>  the image starts to scale, it can roll 180 degrees vertically.  This bug can be found even in popular applications from Google Play, for example, in CIAN. <br><br><img src="https://habrastorage.org/webt/m7/y1/hm/m7y1hmgkwqachpwst660vkrilwa.gif"><br><br>  After a long search, we still localized this bug: sometimes a negative scaleFactor is fed into the matrix image transformation for scaling, this is what causes the image to be flipped. </p><br><p>  <a href="">CustomGestureDetector</a> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ScaleGestureDetector detector)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -   scaleFactor &lt; 0 //      float scaleFactor = detector.getScaleFactor(); if (Float.isNaN(scaleFactor) || Float.isInfinite(scaleFactor)) return false; //    scaleFactor   callback //      mListener.onScale(scaleFactor, detector.getFocusX(), detector.getFocusY()); return true; }</span></span></code> </pre> <br><p>  To scale from the Androids <a href="">ScaleGestureDetector, we</a> need scaleFactor, which is calculated as follows: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getScaleFactor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inAnchoredScaleMode()) { <span class="hljs-comment"><span class="hljs-comment">// Drag is moving up; the further away from the gesture // start, the smaller the span should be, the closer, // the larger the span, and therefore the larger the scale final boolean scaleUp = (mEventBeforeOrAboveStartingGestureEvent &amp;&amp; (mCurrSpan &lt; mPrevSpan)) || (!mEventBeforeOrAboveStartingGestureEvent &amp;&amp; (mCurrSpan &gt; mPrevSpan)); final float spanDiff = (Math.abs(1 - (mCurrSpan / mPrevSpan)) * SCALE_FACTOR); return mPrevSpan &lt;= 0 ? 1 : scaleUp ? (1 + spanDiff) : (1 - spanDiff); } return mPrevSpan &gt; 0 ? mCurrSpan / mPrevSpan : 1; }</span></span></code> </pre> <br><p>  If you impose debag logs on this method, you can track exactly what variable values ‚Äã‚Äãresult in a negative scaleFactor: </p><br><pre> <code class="plaintext hljs">mEventBeforeOrAboveStartingGestureEvent is true; SCALE_FACTOR is 0.5; mCurrSpan: 1075.4398; mPrevSpan 38.867798; scaleUp: false; spanDiff: 13.334586; eval result is -12.334586</code> </pre> <br><p>  There is a suspicion that this problem was tried to be solved by multiplying the spanDiff by SCALE_FACTOR == 0.5.  But this solution will not help if the difference between mCurrSpan and mPrevSpan is more than three times.  This bug has even got a <a href="https://issuetracker.google.com/issues/37129701">ticket</a> , but it has not been fixed yet. <br><del>  Kostylny </del>  The simplest solution to this problem is to simply skip the negative values ‚Äã‚Äãof scaleFactor.  In practice, the user will not notice that the image is sometimes zoomed slightly less smoothly than usual. </p><br><h1 id="vmesto-zaklyucheniya">  Instead of conclusion </h1><br><h3 id="sudba-pull-rekvestov">  The fate of pull requests </h3><br><p>  We made a local fix and created the last <a href="https://github.com/chrisbanes/PhotoView/pull/667">pull request</a> in PhotoView.  Despite the fact that some PRs have been hanging there for a year, our PRs have been added to the master branch and even a new release of PhotoView has been released.  After that, we decided to cut the local module from the Android Gallery and pull up the official PhotoView sources.  For this, we had to add support for AndroidX, which was added to PhotoView in version <a href="">2.1.3</a> . </p><br><h3 id="gde-nayti-biblioteku">  Where to find a library </h3><br><p>  The source code of the Android Gallery library is here - <a href="https://github.com/redmadrobot-spb/android-gallery">https://github.com/redmadrobot-spb/android-gallery</a> , along with instructions for use.  And to support projects that still use the Support Library, we have created a separate version of <a href="https://github.com/redmadrobot-spb/android-gallery-deprecated">android-gallery-deprecated</a> .  But be careful, because after a year the Support Library will turn into a pumpkin! </p><br><h3 id="chto-dalshe">  What's next </h3><br><p>  Now the library completely suits us, but in the process of developing new ideas have arisen.  Here are some of them: </p><br><ul><li>  the ability to use the library in any layout, not just a separate FragmentDialog; </li><li>  ability to customize the UI; </li><li>  the possibility of replacing Gilde and ExoPlayer; </li><li>  the ability to use something instead of the ViewPager. </li></ul><br><h3 id="ssylki">  Links </h3><br><ul><li>  <a href="https://android.jlelse.eu/the-android-touch-system-from-a-slightly-different-perspective-71f29c86369a">A</a> very nice article on the topic with links to other excellent articles and videos, which describes in detail the principle of the Android Touch System. </li><li>  <a href="https://stfalcon.com/ru/blog/post/learning-android-gestures">Mastering gestures in Android</a> - an article about the Android Touch System in Russian. </li></ul><br><h3 id="upd">  UPD </h3><br><p>  While writing the article, a similar <a href="https://github.com/stfalcon-studio/StfalconImageViewer">library</a> from the <a href="https://github.com/stfalcon-studio/FrescoImageViewer">FrescoImageViewer</a> developers was <a href="https://github.com/stfalcon-studio/FrescoImageViewer">released</a> .  They added support for the <a href="https://github.com/stfalcon-studio/StfalconImageViewer">transition animation</a> , but we only have support for the video so far.  :) </p></li></ol></div><p>Source: <a href="https://habr.com/ru/post/433076/">https://habr.com/ru/post/433076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433064/index.html">Incident management: ‚Äúgive away cannot be left‚Äù or the art of placing commas</a></li>
<li><a href="../433066/index.html">HighLoad Cup # 2. Championship for backend-developers back in the ranks</a></li>
<li><a href="../433070/index.html">How to distinguish shampoo from champignons, and skewers from champagne ... Elasticsearch - search for goods in store databases</a></li>
<li><a href="../433072/index.html">How to hacked the copy protection console Sega Dreamcast</a></li>
<li><a href="../433074/index.html">Switching to Kotlin in the Android project: Tips and Tricks</a></li>
<li><a href="../433078/index.html">We write trading robots using the StockSharp graphic framework. Part 2</a></li>
<li><a href="../433080/index.html">Pocket OLAP in Javascript and IndexedDB Performance</a></li>
<li><a href="../433082/index.html">Bleeding someone else's accounts has become a criminal offense in South Korea</a></li>
<li><a href="../433084/index.html">Open lesson "Feature Engineering on the example of the classic dataset of the Titanic"</a></li>
<li><a href="../433086/index.html">Tinkoff and everything, everything, everything: IoT, analytics and observation for banks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>