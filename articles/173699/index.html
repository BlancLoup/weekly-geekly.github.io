<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>High Availability FTP Server with AWS S3 Data Storage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear readers. 
 Again, I want to share with you the experience gained. On one of the projects, the goal was set up to organize an FTP-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>High Availability FTP Server with AWS S3 Data Storage</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear readers. <br>  Again, I want to share with you the experience gained. On one of the projects, the goal was set up to organize an FTP-server of increased reliability.  By increased reliability was meant the following: <ul><li>  Data is stored in AWS S3 </li><li>  The FTP server itself (Pure-ftpd was selected) should be as accessible as possible. </li><li>  Organize load balancing (optional) </li></ul><a name="habracut"></a><br>  <b>Step one</b> : Install s3fs and mount the S3 bucket as a disk partition. <br>  There are not many options, or rather one (if I am mistaken, correct it) - <a href="https://code.google.com/p/s3fs/wiki/FuseOverAmazon">s3fs</a> .  The developers of s3fs on their page claim that <i>"s3fs is stable and is being used in a number of production environment"</i> .  The installation process for s3fs does not make sense to paint, it is <a href="https://code.google.com/p/s3fs/wiki/InstallationNotes">here. I</a> ‚Äôll dwell only on the really important points. First, the latest version of s3fs has problems with data synchronization.  When you upload a new file on S3, it immediately appears on your server, but if later you make changes to this file on S3, then the old version is still on the server.  There is a problem with caching.  Attempts to mount an S3 bucket with various options to enable and disable caching did not work.  After testing various releases of s3fs, a <a href="https://code.google.com/p/s3fs/downloads/detail%3Fname%3Ds3fs-r177-source.tar.gz%26can%3D2%26q%3D">version</a> was found where this bug did not manifest itself.  Download the package, unpack and install as written in the Makefile.  In order for s3fs to work properly, make sure that the following packages are already installed on the system: <ul><li>  fuse </li><li>  fuse-devel </li><li>  fuse-libs </li></ul>  To check, you can try to mount the bake with the command: <pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#/usr/bin/s3fs mybucket /mnt/mybucket/ -o accessKeyId=XXXXXXXXXXXXX -o secretAccessKey=YYYYYYYYYYYYYYYYY -o allow_other,rw -o readwrite_timeout=120;</span></span></code> </pre> <br>  <b>Step Two</b> : Install pure-ftpd. <br>  It would seem nothing interesting.  Simply install using any package manager.  However, pure-ftpd is notable for its paranoia, and before deleting a file, it first copies it to a new temporary file.  And when the file size is several gigabytes, this procedure takes extra time.  And in our case, when the data is not stored locally, but on S3, it is not a short time at all. <br>  To disable the creation of temporary files before deleting, I rebuilt pure-ftpd with the option <i>--without-sendfile</i> .  Of course, it would be better to assemble your package and install it into the system, but I did it on a fast hand and did not get distracted by it. <br><br>  <b>Step three</b> : Setting user rights. <br>  One of the most interesting nuances.  According to customer requirements, each user's home folder should contain directories that the user cannot or cannot write to them.  If we dealt with regular disk partitions, we could simply change the owner of the folder.  But in our case it will not work as the rights will be inherited from the option with which the partition is mounted (ro or rw).  That is, the user can either everything or just read.  But pure-ftpd has one useful feature, it can ‚Äúfollow‚Äù links.  To do this, at build time, add another option <i>--with-virtualchroot.</i>  Thus, we can mount the batch twice, in <i>read-only</i> and <i>read-write</i> modes and make links to them in the users home directories. <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#/usr/bin/s3fs mybucket /mnt/mybucketrw/ -o accessKeyId=XXXXXXXXXXXXX -o secretAccessKey=YYYYYYYYYYYYYYYYY -o allow_other,rw -o readwrite_timeout=120; #/usr/bin/s3fs mybucket /mnt/mybucketro/ -o accessKeyId=XXXXXXXXXXXXX -o secretAccessKey=YYYYYYYYYYYYYYYYY -o allow_other,ro -o readwrite_timeout=120; #mount | grep s3fs s3fs on /mnt/mybucketro type fuse.s3fs (ro,nosuid,nodev,allow_other) s3fs on /mnt/mybucketrw type fuse.s3fs (rw,nosuid,nodev,allow_other)</span></span></code> </pre><br>  The user directory will look like this: <pre> <code class="bash hljs">ls -la /mnt/Users/User1/ . lrwxrwxrwx 1 root root 15 Mar 25 09:10 mybucketro/folder1 -&gt; /mnt/mybucketro/folder1 lrwxrwxrwx 1 root root 15 Mar 25 09:10 mybucketrw/folder2 -&gt; /mnt/mybucketrw/folder2</code> </pre><br>  Now we have given the user read access to the <i>/ mnt / mybucketro / folder</i> 1 <i>folder</i> and write access to the <i>/ mnt / mybucketrw / folder2 folder</i> . At this stage, we can assume that the first TK item (Data stored in AWS S3) has been completed. <br><br>  <b>Step Four</b> : Set up high availability. <br>  Then it was decided to use the good old AWS LoadBalancer and its wonderful HealthCheck. <br>  We open the AWS Console and create a new balancer (I am sure that there is no need to repeat the process of creating a balancer. If anything, here‚Äôs a <a href="http://habrahabr.ru/company/epam_systems/blog/138732/">reminder</a> ). <br>  In Ping Protocol, select TCP, Ping Port - 21. <br>  Everything, now the viability of the server will be checked for availability of 21 ports, that is, our FTP server. <br>  We create AMI from our server (on which FTP is already configured and partitions are mounted).  Further, as always, we do launch-config with the created AMI and create the auto-scaling-group. <br>  When creating an auto-scaling-group, we specify our new Load Balancer and the option - health-check-type ELB. In this configuration, if our FTP server ‚Äúcrashes‚Äù, the Load Balancer will remove it and ‚Äúpick up‚Äù a new working server. that we store all the data on S3, then this procedure will not harm us. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Fifth step (optional) Your work is highly appreciated</b> : Configure load balancing and autoscaling. <br>  The issue of load balancing on FTP is far from being solved as easily as, say, the load on the web.  I came across this for the first time and, not finding a ready-made free solution, suggested that the customer balance the load with the help of DNS. <br>  In AWS Route53 there is an option for A-type records - weight.  The higher the value of the record, the higher its priority at the time of the response to the client. <br>  That is, theoretically, we can create 5 records with the same weight and thus evenly distribute client requests across 5 servers. To automate adding records to AWS Route53, I made two scripts.  One to add entry: <div class="spoiler">  <b class="spoiler_title">instance_up.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash zone_id="Z3KU6XBKO52XV4" dns_record="example.com." instance_dns=$(/usr/bin/curl -s http://169.254.169.254/latest/meta-data/public-hostname) instance_ip=$(/usr/bin/curl -s http://169.254.169.254/latest/meta-data/public-ipv4) let number_nodes=$(route53 get $zone_id | grep $dns_record | wc -l)+1 weight="50" id=$(date "+%Y_%m_%d_%H:%M") route53 get $zone_id | grep $instance_ip &gt; /dev/null if [ $? -ne 0 ]; then route53 get $zone_id | grep $dns_record | awk '{print $4" "$3" "$6" "$7}' | sed 's/id=//' | sed 's/\,//' | sed 's/w=//' | sed 's/)//' | while read i; do route53 del_record $zone_id $dns_record A $i route53 add_record $zone_id $dns_record A $(echo $i | awk '{print $1" "$2" "$3}') $weight done route53 add_record $zone_id $dns_record A $instance_ip 60 $id $weight fi</span></span></code> </pre></div></div>  Another to remove: <div class="spoiler">  <b class="spoiler_title">instance_down.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash zone_id="Z3KU6XBKO52XV4" dns_record="example.com." instance_dns=$(/usr/bin/curl -s http://169.254.169.254/latest/meta-data/public-hostname) instance_ip=$(/usr/bin/curl -s http://169.254.169.254/latest/meta-data/public-ipv4) let number_nodes=$(route53 get $zone_id | grep $dns_record | wc -l)+1 weight="50" id=$(date "+%Y_%m_%d_%H:%M") route53 get $zone_id | grep $instance_ip &gt; /dev/null if [ $? -eq 0 ]; then route53 del_record $zone_id $(route53 get $zone_id | grep $instance_ip | awk '{print $1" "$2" "$4" "$3" "$6" "$7}' | sed 's/id=//' | sed 's/\,//' | sed 's/w=//' | sed 's/)//') fi</span></span></code> </pre></div></div>  The scripts use the <i>route53</i> utility, which comes with the python-boto package. <br>  Both scripts are placed on the server from which we are doing AMI and add their call to the Pure-Ftpd start script <br>  Now, when Pure-Ftpd is launched, it will add a new ‚ÄúA‚Äù entry with its own IP address to AWS Route53, and, upon shutdown, delete it. <br>  It remains only to add policies for ScaleUP and ScaleDown for our auto-scaling-group. <br><br>  That's the whole setup.  This configuration has been successfully working on the project for six months already. <br>  If you have any questions - write comments, if possible answer.  I would also be happy if someone shares their experience in organizing such systems. </div><p>Source: <a href="https://habr.com/ru/post/173699/">https://habr.com/ru/post/173699/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173687/index.html">Manage hosting cPanel with iPhone (or iPad)</a></li>
<li><a href="../173689/index.html">N-back exercise</a></li>
<li><a href="../173691/index.html">Hacking a 100 character tag</a></li>
<li><a href="../173693/index.html">Dater - determines the time zone, localizes and formats the time in PHP</a></li>
<li><a href="../173697/index.html">New vulnerability allows you to bypass the lock screen in iOS 6.1.3</a></li>
<li><a href="../173701/index.html">Checking PHP engine for durability</a></li>
<li><a href="../173703/index.html">Ultra-hard sapphire glass for smartphones</a></li>
<li><a href="../173705/index.html">Writing your bootloader</a></li>
<li><a href="../173707/index.html">Internet project managers</a></li>
<li><a href="../173709/index.html">Working with the LCD indicator on the debug board STM32L-Discovery</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>