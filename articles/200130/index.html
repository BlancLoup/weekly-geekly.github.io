<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AngularJS Filter Cache with Lo-Dash</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am writing a diploma where I solve one of the tasks - the implementation of an anonymous fast web chat. Fast in every sense - loading, application w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AngularJS Filter Cache with Lo-Dash</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/4e6/941/4cf/4e69414cfaca602a9a03cb48f3b3aa20.jpg" alt="AngularJS as a fast tiger ^. ^"><br><br>  I am writing a diploma where I solve one of the tasks - the implementation of an anonymous fast web chat.  Fast in every sense - loading, application work, use (authorization off).  Choice stopped on a bunch: <a href="http://github.com/socketstream/socketstream">Node.js framework SocketStream</a> and <a href="http://angularjs.org/">AngularJS</a> on the client side.  In the process, I ran into a problem - repeated calculations made by filters on the same model.  Details of the problem and the solution under the cut. <br><a name="habracut"></a><br><hr><br>  <b>Reader Level:</b> <br>  <b>AngularJS:</b> medium (creating filters) <br>  <b>Lo-Dash:</b> "saw-felt" <br><br>  <a href="https://habr.com/ru/post/200130/">Go directly to the solution</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="problem"></a><br><h4>  Problem in details </h4><br>  We have a large array, with which our application constantly works by manipulating its elements.  You must apply a complex filter to the array, for example, sorting by date and selecting elements with a certain property.  Let's transfer this problem to the application area - a simplified version of my chat.  The elements of the array are chats (rooms / circles) that contain messages.  Chat has the following structure: <br><br><pre><code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">'rE4aA'</span></span>, <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-attr"><span class="hljs-attr">online</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">recent</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">//    messages: [] //  }</span></span></code> </pre> <br>  I want to display on the page using the <code>ngRepeat</code> {N} directive the number of chats (depending on the screen size).  And I want to display a context menu that appears when you click the right mouse button on the title of any of the chats and allows you to move the selected chat to the place of another.  This is how it looks like: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a7c/755/5fc/a7c7555fc08b70d1e4e4234189bb7b3b.png" alt="Right click on the chat header"><br>  <i>Right click on the chat header</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f5e/bd1/2d0/f5ebd12d0453ae100555212d526a9579.png" alt="Backlight chat, in place of which we move"><br>  <i>Backlight chat, in place of which we move</i> <br><br>  Such functionality can be implemented by creating two lists with the <code>ngRepeat</code> directive and applying a filter.  For chats, the filter should be able to sort by the number of new messages (the recent property) and reduce the number of elements (chats) to the number {N} which is calculated from the size of the browser window.  For the context menu, the same filter excludes the current element (the chat on which header was clicked). <br><br>  Filter Code: <br><pre> <code class="javascript hljs">angular.module(<span class="hljs-string"><span class="hljs-string">'app'</span></span>) .filter(<span class="hljs-string"><span class="hljs-string">'opened'</span></span>, [<span class="hljs-string"><span class="hljs-string">'$rootScope'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$s</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">o</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'  ¬´opened¬ª'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> count = $s.count; <span class="hljs-comment"><span class="hljs-comment">//  ,  {N} return _(o) //    Lo-Dash .sortBy('recent') //      .reverse() //  (   ) .first(count) //   {N}  .value() //   } }]);</span></span></code> </pre><br>  By applying this filter to the array argument passed to each <code>ngRepeat</code> directive, <code>ngRepeat</code> see that in the console the message ‚ÄúThe‚Äú opened filter ‚Äùhas been shown is shown twice.  This means that half of the resources were wasted by the filter.  Such convenience as the context menu doubled the rendering time of the actual state of the application.  And if I continue to add functionality using the same data with filters, the situation will get even worse. <br><br><a name="solution"></a><br><h4>  Solution to the problem </h4><br>  The solution is to create a function that returns a filtered array.  This function is used instead of the original array without using the native filter provider.  The function is wrapped in the <a href="http://lodash.com/">Lo-Dash</a> <a href="http://lodash.com/docs">memoize</a> property, which implements the caching functionality.  Below I will explain how memoize works and give an example implementation. <br><br><a name="memoize"></a><br><h4>  Lo-Dash memoize property </h4><br>  <b>Arguments:</b> <br><ol><li>  <code>-</code> <i>(required)</i> - the cached result of this function returns the memoize </li><li>  <code>-</code> <i>(optional)</i> - the result of the function is the cache key (checks for uniqueness) </li></ol><br>  _.memoize (fn, [fn]) returns the function that, when first called, performs the calculation, remembers the result (creates the cache) and returns it.  On subsequent calls, returns a cache.  All this is true for a single cache key. <br><br>  The cache key is determined by the result of the function, which is passed to the second argument.  By default (if the second argument is not specified), memoize uses the first argument as the cache key. <br><br><a name="example"></a><br><h4>  In a vivid example </h4><br>  At the end of the short listing there will be a link to the demonstration, but I suggest paying attention to the comments in the code. <br><br>  Create a simple controller with one ‚Äúform‚Äù glued together object: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$scope</span></span></span><span class="hljs-function">)</span></span>{ $scope.form = { <span class="hljs-attr"><span class="hljs-attr">input</span></span>: {<span class="hljs-attr"><span class="hljs-attr">key</span></span>:<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">val</span></span>:<span class="hljs-string"><span class="hljs-string">''</span></span>}, <span class="hljs-comment"><span class="hljs-comment">//       array: [ {key:'pear', val:''}, //  {key:'melon', val:''}, {key:'ananas', val:''}, {key:'cherry', val:''} ], order: 'key', //      key (2  key/val) check: false, //      .   (2  ‚Äî true/false) add: function(){ //          this.array.push(angular.copy(this.input)); this.filtered.cache = {} //    }, filtered: _.memoize( //   function(){ console.log('  : ' + this.order + '  ' + this.check); return _.sortBy(this.array, this.order) }, function(){ //  - //      return [this.order, this.check] } ) } }</span></span></code> </pre><br>  Some HTML: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myform"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-app</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-controller</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MyController"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">required</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form.input.key"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"key"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">required</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form.input.val"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"val"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!myform.$valid"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form.add()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fieldset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">legend</span></span></span><span class="hljs-tag">&gt;</span></span>   : <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form.order"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-options</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"p for p in ['key', 'val']"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">legend</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-repeat</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"el in form.filtered()"</span></span></span><span class="hljs-tag">&gt;</span></span> {{el.key}} ‚Äî "{{el.val}}" <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"checkbox"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form.check"</span></span></span><span class="hljs-tag">&gt;</span></span>   -   <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span>{{form.filtered()|json}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fieldset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  We go to watch <a href="http://jsfiddle.net/sukazavr/3vraZ/2/">result on jsFiddle</a> .  Open the console with the combination of <code>Ctrl</code> + <code>Shift</code> + <code>J</code> (relevant for the Chrome browser).  We try to switch sorting and pull the flag.  In the console, we see a maximum of 4 starts of the filter function (for each of the states).  Adding a new element to the array - reset the cache and again verify the correct operation of this solution. <br><br>  Thanks to the wonderful <a href="http://lodash.com/">Lo-Dash</a> library, and specifically the memoize property, I was seriously able to increase the speed of the AngularJS application.  If I applied the native filter, since the moment the application was launched, the filter worked 8 times against 1 (solution with memoize). <br><br>  From the community I look forward to constructive criticism and thoughts about the methods of "pumping" the native filter. <br><br>  <b>PS: I</b> thank UFO for the invitation to Habr. </div><p>Source: <a href="https://habr.com/ru/post/200130/">https://habr.com/ru/post/200130/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../200114/index.html">Where jQuery stores event handlers</a></li>
<li><a href="../200116/index.html">Labor market research of Internet developers</a></li>
<li><a href="../200120/index.html">String aggregation in the SQL Server world</a></li>
<li><a href="../200122/index.html">Participate in the study of Innopolis University</a></li>
<li><a href="../200128/index.html">Monitoring Django project statistics with Pinba on Debian GNU / Linux</a></li>
<li><a href="../200132/index.html">Play planning poker online!</a></li>
<li><a href="../200140/index.html">Sun Hub Sun Simba</a></li>
<li><a href="../200142/index.html">Nextivity Cel-Fi RS2 black - intelligent 3G signal amplifier</a></li>
<li><a href="../200144/index.html">Financial book - what have I spent so much?</a></li>
<li><a href="../200152/index.html">Runetology (211): Vladimir Malyugin, Head of PayPal Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>