<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Radical caching in Joomla 1.5</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A free CMS is always a compromise, a compromise between a number of obvious factors, which, it seems, it makes no sense to list which within this reso...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Radical caching in Joomla 1.5</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/96e/f26/8e5/96ef268e5cb30b807dce4adf00c1080b.gif" alt="image"><br><br>  A free CMS is always a compromise, a compromise between a number of obvious factors, which, it seems, it makes no sense to list which within this resource.  they are all known for a long time.  Of course, among the whole variety of free CMS, some can be distinguished that will be better or worse in some separate nominations, such as work speed, ease of mastering by a beginner, etc.  But this article is not about that.  I just want to share the experience of successfully solving the problem of page generation speed in Joomla using caching.  And caching is very radical, at the ‚Äúlevel‚Äù index.php. <br><br>  I want to immediately note that this story is not some fundamental innovation, and I do not claim any laurels.  I hope my decision will help at least someone to extend the ‚Äúlittle blood‚Äù life of the old project on Joomla. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I just want to preempt the criticism and ask for some indulgence.  The fact is that I am not a professional programmer in any way.  I am the technical director of a small printing house.  All my programming efforts are just efforts to reduce IT costs in a company. <br><br>  As it seems to me, quite typical (in any case, among amateur programmers, whom I consider myself to be) is the following situation.  At one time, when I started writing a website for myself, I chose Joomla, because  it was an obvious, though not very far-sighted, decision.  Over time, I encountered some limitations of Joomla, one of which was the time of page generation. <br><br>  For those who are in the subject, it's probably not a secret that due to the load of a heavyweight framework, plug-ins and modules, well, as a payment for the versatility of CMS as a whole, the typical page generation time can be about 1-2 seconds.  The use of more powerful hardware does not solve the problem, because  if a CMS makes several dozen (or even a hundred) requests to the database for one request, an increase in the productivity of iron (and all its components) will be required by an order of magnitude, which is very expensive, to say the least. <br><br>  I must say that joomla 1.5 itself also knows something in terms of caching.  To my shame, I do not remember exactly what, because  a long time to delve into it.  But I do remember exactly that there is almost no sense in this caching. <br><br>  The first attempt to optimize and accelerate was writing a crutch for caching the Joomla component Virtuemart.  Virtuemart is a well-known (we can say "classics of the genre") component of the online store for Joomla.  Of course, you can say a lot of unflattering words about him and read, because  it has a lot of flaws dictated by a number of reasons, ranging from respectable age, the absence of any refactorings there, ending with openness and versatility, which, as a rule, go alongside cumbersome.  Nevertheless, it (Virtuemart) is there, it works, and for many it is a simple entry point into the ‚Äúworld of electronic business‚Äù, so to speak.  And in general, I would like to focus not on how to ‚Äúproperly cook‚Äù Joomla, which components and how to use.  On the contrary, I would like to share a recipe for what to do if it is already cooked incorrectly.  A solution that can be briefly described as ‚ÄúDon't touch anything, don't change anything, just make it faster so that it works faster!‚Äù <br><br>  In my case, Virtuemart is used in directory mode, which somewhat simplified the task of writing a caching crutch.  Describe how I did it makes no sense, because  the resulting increase did not significantly affect the download speed.  After all, in my Joomla there are more components that love resources, for example JoomFish.  In addition, in order for Virtuemart to give up its cache, you need to load the entire Joomla framework all the time, which in itself takes time. <br><br>  I started looking for a solution to speed up the download.  The situation was aggravated by problems on the virtual hosting, where my neighbors had archineoptimal websites, and therefore the server was very loaded and the generation time sometimes reached 10-20 seconds. <br>  Upon reflection, I came to the conclusion that no joomla optimization, at least within reasonable aisles ‚Äî after which joomla will remain a joomla, will not accelerate at times, and this is the goal that stood before me.  Therefore, it was decided to consider the writing of the frontend.  I immediately dropped it and did not consider options with ready-made solutions (I don‚Äôt even know if there are any), since  He had neither desire nor time.  In addition, my copy of joomla is decently finished in places and typical (typical for Joomla) solutions are not the fact that they would work out of the box. <br><br>  What happened as a result: <br><ul><li>  caching almost all pages of the site in the mode of an unauthorized user </li><li>  generation speed of the order of 100-200 ms </li><li>  The minimum number of database accesses when returning a page from the cache is 1-2 pieces, more if there are dynamic (or periodically updated, with less than the page itself, TTL modules) on the pages </li><li>  integration into the mechanism of joomla sessions without launching the joomla framework itself, thanks to which all asynchronous bells and whistles work correctly within the cached pages, since  when receiving a POST or GET from a user walking (without a single framework load) on the site's cache, joomla sees his session in his database and everything works as it should.  At least, the standard AJAX components JComments and ProofReader have wonderfully earned me, and I also made a couple of self-written AJAX components. </li></ul><br><br>  Consider the implementation <br><br><ul><li>  In my case, I placed all the frontend in the index.php file, because it is in it that the generation begins and ends. </li><li> First of all, we analyze the URL to determine if it is allowed to cache this page.  In my case, joomla uses the SEF link generation module, which replaces links on almost all pages of the site with cyrillic ones.  So in my case, all links in which are /index.php are forbidden for caching. <br><br> <code>$fe_disalolwed_urls_array = array( <br> "/index" <br> ); <br> ......................... <br> <br> if (fe_check_url($fe_disalolwed_urls_array,$fe_uri_cp1251)) {} <br> <br> ......................... <br> <br> function fe_check_url($a, $i) <br> { <br> foreach ($a as $aa) <br> { <br> if (substr($i,0,strlen($aa)) == $aa) <br> { <br> return false; <br> } <br> } <br> return true; <br> }</code> <br> <br>  This operation does not require access to the database, everything happens in the index.php file. <br>  If page caching is forbidden, we leave for the regular generation of the page with loading the framework, etc.  etc. <br><br></li><li>  We also check the presence in the request of a special cookie that joomla puts users who have passed authorization with a bird to ‚Äúremember me‚Äù.  This cookie has a name that is defined as md5 ('_ secret_JLOGIN_REMEMBER'), where _secret_ is a random string generated when installing an instance of joomla, you can find this string in the admin panel. <br><br>  If we find such a cookie, we also transfer the control to the ‚Äúgreat and terrible‚Äù - let it try to determine for the rest of the encrypted cookies who it should ‚Äúremember‚Äù. <br>  This operation also does not require access to the database and the file system, we are still in index.php. <br><br></li><li>  If we're still here, move on.  Create a dummy session with the same name as joomla does, namely md5 (md5 ('_ secret_site')) and check if there is such a session with such an id in the josly jumla table, and if there is - whether this session is a session of an authorized user .  Also in this place it is necessary to remove outdated sessions from the database, although this is not necessary - joomla itself can take care of this when some of the queries launch it. <br><br>  Please note that this is the first call to the database. <br><br>  Based on the results of the check, we decide what to do next.  If there is no such session (and also if there is such a session and it does not belong to the registered user), we proceed to the next item, where we will determine the ability to read the page from the cache.  If the session belongs to a registered user, we ‚Äúleave‚Äù for the standard generation.  In principle, in this place it would be possible to ‚Äúdig‚Äù further - to cache pages for authorized users, but I didn‚Äôt go into this, because  The specifics of my site are such that unregistered users constitute a heavy proportion of visits, despite the fact that the size of the frontend that would cache pages of registered users would increase significantly.  In addition, at the moment, we have moved to new hosting, where the generation time, even without a cache, is quite stable. <br><br></li><li>  Now you need to determine if there is a cached version of this page.  If it is, then we give the cache, if it is not there, then we do the generation, save the result to the cache and give it to the client.  In the case of generation, you need to remember to delete the session, since  joomla herself will create it! <br><br>  Also, if there is no ‚Äúgiving up the cache‚Äù and there is no session with that name in joomla, it is important to add the session to the joomla session table.  This is necessary to ensure the correct operation of joomla itself, if the user goes from cached to non-cached, for work of AJAX modules, etc.  In addition, you need to perform cache processing for dynamic modules before sending to the client, see below. <br><br>  In this place there are a number of nuances associated with dynamic modules. <br>  In my case these are the following modules: <br><ul><li>  number of users on the site in the last hour </li><li>  latest site news </li><li>  production news (this module displays the latest developments in office ERP) </li><li>  a module that displays a random user joomla (in this case, a photo of a random employee of the company is displayed) </li><li>  joomla authorization, which is static in itself, but has Spoof-protection (in the case of using the Community Builder component, the fe_cbSpoofString function is responsible for this - we are looking for the source code in joomla) </li></ul><br>  To ensure their correct operation, the following was done: <br><ul><li>  when starting the generation of joomla, which is to be placed in the cache, we do some define </li><li>  in the generation code of the mentioned modules, if we see this define, instead of the module body, we output some magic word in the response body </li><li>  in the frontend we write (using Ctrl-C, Ctrl-V and a small file) functions that generate the text of the modules without loading the framework </li><li>  the result of the generation (in which instead of the modules there are magic words) we put in the cache </li><li>  when returning content from the cache, we change with the banal str_replace () our magic words to the results of the functions we have defined </li></ul><br></li></ul><br><br>  Actually that's all.  As a result, I received an acceleration of almost an order of magnitude (almost ten times). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc9/1ff/5dc/dc91ff5dc9c453db16284119f4bece72.gif" alt="image"><br><br>  <a href="http://host-tracker.com/check_res_ajx/9898030-0/">Results tracker</a> <br>  Physically hosting is in Kiev, 99% of the target audience there. <br>  You can estimate the speed of the site on it: <a href="http://www.fastprint.ua/">link</a> <br><br>  In the picture below - a screen from Google Webmasters Tools <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9e4/0cc/82c/9e40cc82c16fd4ce1b60f601b01ced67.gif" alt="image"><br><br>  The February spike was caused by one problem, for which I had to delete the entire cache of the frontend every 2-3 days during the whole month.  But this problem itself had no relation to the frontend. <br><br>  The front end cache is cleared from the joomla admin panel; to do this, I didn‚Äôt have to do anything, except to add the cache itself to the daddy / cache / FrontEnd - joomla saw it itself and provided an opportunity to clear it ... <br><br>  PS: I am sure that this approach can be applied not only within Joomla 1.5 and not only within Joomla.  Of course, this will require some skills, but, at the same time, it can expand the scope of easy-to-learn free CMS. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/139177/">https://habr.com/ru/post/139177/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139170/index.html">Laptop Batteries - Fantasy and Reality</a></li>
<li><a href="../139172/index.html">Microsoft pushes the Secure Boot equivalent on the ARM architecture</a></li>
<li><a href="../139173/index.html">Because I am an independent child</a></li>
<li><a href="../139175/index.html">Production of MTS 945 GLONASS is suspended</a></li>
<li><a href="../139176/index.html">Interception sessions in wireless networks</a></li>
<li><a href="../139178/index.html">Redirection for Asterisk</a></li>
<li><a href="../139180/index.html">Programming Siemens PLC on Simatic Step7</a></li>
<li><a href="../139181/index.html">Demonstration of Boot to Gecko</a></li>
<li><a href="../139183/index.html">Rutoken EDS and Open Source</a></li>
<li><a href="../139184/index.html">Datacenter in Yaroslavl: engineering solutions for smooth operation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>