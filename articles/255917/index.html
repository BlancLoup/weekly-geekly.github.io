<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Build Embedded Linux from Yocto for QEMU x86 and the first application to it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a quick start with pictures for those who need to build Embedded Linux using Yocto. 
 If you are going to build Embedded Linux for spe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Build Embedded Linux from Yocto for QEMU x86 and the first application to it</h1><div class="post__text post__text-html js-mediator-article">  This article is a quick start with pictures for those who need to build Embedded Linux using Yocto. <br>  If you are going to build Embedded Linux for specific hardware, for example, for SoC on FPGA, then, probably, as I come across the Yocto project. <br><br>  Yocto is a unifying project <br><ul><li>  developer tools; </li><li>  assembly system; </li><li>  a set of software interfaces; </li><li>  a collection of meta-packages that extend the capabilities of the platform; </li><li>  plugins for Eclipse and Anjuta. </li></ul><br>  I tried to describe the process so that you could spend less time on problems with setting up and preparing and get down to work as soon as possible. <br><a name="habracut"></a><br><h3>  Build a Linux image </h3><br>  Basis for assembly - article <br>  <a href="http://www.yoctoproject.org/docs/1.7.1/yocto-project-qs/yocto-project-qs.html">"Yocto Project Quick Start"</a> . <br>  I will collect in a folder <br><pre><code class="bash hljs">~/My_Designs/Poky</code> </pre> <br>  A small digression: <br>  Having launched the terminal, execute all commands in it, because in the course of the work, environment variables are created and used.  If you closed the terminal and opened a new one, then go to <br><pre> <code class="bash hljs">~.../poky</code> </pre> <br>  and have to repeat some commands.  For example, <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">source</span></span> oe-init-build-env</code> </pre> <br>  I create a git repository <br><pre> <code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git://git.yoctoproject.org/poky $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> poky $ git checkout -b dizzy origin/dizzy</code> </pre> <br>  now the current directory <br><pre> <code class="bash hljs">~/My_Designs/Poky/poky</code> </pre> <br>  now, according to Yocto terms, it came out <br>  Source Directory - "poky" <br>  local working area (local branch) - dizzy <br>  First done <br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> oe-init-build-env</code> </pre> <br>  This command sets up the shell environment, creates an initial modifiable set of configuration files, and interacts with the BitBake system execution environment by using a script file that allows Poky to determine whether the minimum system requirements are met.  The result of executing the command will either report problems, for example, missing packages, or the possibility to continue editing the conf / local.conf file. <br><br>  Edit conf / local.conf: <br><pre> <code class="bash hljs">$ nano conf/local.conf</code> </pre> <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">BB_NUMBER_THREADS</span></span> ?= <span class="hljs-string"><span class="hljs-string">"3"</span></span> PARALLEL_MAKE ?= <span class="hljs-string"><span class="hljs-string">"-j 3"</span></span> EXTRA_IMAGE_FEATURES = <span class="hljs-string"><span class="hljs-string">"debug-tweaks eclipse-debug tools-debug debug-tweaks"</span></span></code> </pre> <br>  Here you should specify the number of threads that will run the bitbake build tool.  To make the most of the computational capabilities, the number of threads must match the number of processor cores.  I pointed to 1 less, so that the computer during the assembly is more convenient to use. <br>  I also added additional features useful for development. <br>  Since we collect for the standard QEMU x86, the rest can not be changed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then you can choose a ‚Äúrecipe‚Äù - an assembly version with its own set of libraries, utilities, created files, images, etc. <br>  A list of recipes with their brief descriptions can be found here: <br>  <a href="http://layers.openembedded.org/layerindex/branch/master/layer/openembedded-core/">openembedded-core recipes</a> <br>  Scroll down to recipes starting with core- ... <br>  I do not advise to collect core-image-minimal for review.  There are no ssh and other tools for debugging. <br>  I chose core-image-sato.  This is a SATO GUI build. <br><br>  Actually, the assembly: <br><pre> <code class="bash hljs">$ bitbake core-image-sato</code> </pre> <br>  Be prepared to wait for the completion of the assembly, perhaps from 3 hours to 3 or more days.  Fortunately, the process can be paused and resumed. <br>  To pause, press + one (!) Times and wait until all the started operations are completed.  Otherwise, perhaps, errors will appear and you will have to redo it.  To resume, repeat <br><pre> <code class="bash hljs">$ bitbake core-image-sato</code> </pre> <br>  If the terminal is closed, then in the new terminal, before building, you will have to repeat the setting of the environment variables: <br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> oe-init-build-env</code> </pre> <br>  Upon completion of the assembly, you can check what happened by running the QEMU emulator <br><pre> <code class="bash hljs">$ runqemu qemux86</code> </pre> <br>  The xterm terminal window will appear, there you will need to enter the root password of the host to create the tap interface.  There you can also see the IP host-machine on the tap interface and the IP of the emulated machine.  I have 192.168.7.1 and 192.168.7.2, respectively. <br>  Then, if the SATO is built, the graphical interface window should appear: <br><br><img src="https://habrastorage.org/files/abb/545/300/abb5453007ce456baf57efd03b85968a" alt="GUI SATO in QEMU"><br><br>  If the running emulator interferes, as long as it can be closed.  Look through the arrows at the top of the GUI until the corresponding shutdown icon appears or enter poweroff via the SATO terminal or via ssh.  Pro ssh will be later. <br>  Do not close QEMU with a cross on the emulator main window.  Close the regular means of the emulated machine.  Otherwise, you will have ethX, tapX, virbrX interfaces on the QEMU system, which will have to be ifconfig ... ifdown, or how it is done on your OS.  Or every time you start QEMU, there will be a new host IP and QEMU, which is inconvenient. <br><br><h3>  Development tools </h3><br>  Used by Eclipse IDE for C / C ++ Developers, Luna version.  This build contains plug-ins CDT, GNU ARM and some other plug-ins useful for cross-compiling and firmware development. <br>  You can download from here: <br>  <a href="https://www.eclipse.org/downloads/packages/eclipse-ide-cc-developers/lunasr2">Eclipse Luna SR2</a> . <br><br>  We will build applications Hello, world! <br><br><h4>  Eclipse Cross GCC </h4><br>  First, the simple way, we collect the usual means of Eclipse: CDT + GNU ARM <br>  If these plug-ins are not yet in your Eclipse, then add the CDT plugin from the standard Eclipse repository and hence the <a href="http://gnuarmeclipse.sourceforge.net/updates">GNU ARM Plugin for Eclipse</a> GNU ARM C / C ++ Cross Compiler and whatever else you want. <br><br>  Create a new C ++ project: <br>  Menu Eclipse File-&gt; New-&gt; Project ... -&gt; C / C ++ -&gt; C ++ Project <br>  Need to choose <br>  Project type: Executable-&gt; Hello World C ++ Project <br>  Toolchains: Cross GCC <br><img src="https://habrastorage.org/files/d3f/e49/62a/d3fe4962abf34c26a8b887a2ea1332cd.png" alt="New C ++ Cross GCC Project"><br>  fill in the Author field <br>  Now the most important thing about the build system: <br>  Cross compiller prefix: i586-poky-linux- <br>  Cross compiler path: /home/.../My_Designs/Poky/poky/build/tmp/sysroots/x86_64-linux/usr/bin/i586-poky-linux <br>  We compile the project <br>  Project-&gt; Build Project <br>  The executable file should appear. <br>  Since you compiled it for QEMU x86 Linux, it should also run on your host machine, if, of course, you are working on x86 Linux or compatible with it.  I have run on IA64 Ubuntu. <br>  Now, if you managed to close QEMU, then run again. <br><pre> <code class="bash hljs">$ runqemu qemux86</code> </pre> <br>  The xterm terminal window will appear, you will need to enter the root password to create the tap interface. <br><br><img src="https://habrastorage.org/files/b55/ef2/bc1/b55ef2bc16dd4a49b958a97eb7ef83a3.png" alt="QEMU bash"><br><br>  As you can see, I have a host IP of 192.168.7.1, IP qemu 192.168.7.2 <br>  A QEMU window with a graphical interface will then appear. <br>  You can connect to QEMU via ssh and sftp.  The first one is useful for running the program, the second one is for sending this program to the emulated machine. <br>  I sent the file using the Krusader file manager.  In Windows, you can use FileZilla or others. <br>  In Krusader, I selected Tools-&gt; New Net Connection ..., in the dialog you need to select sftp: //, enter IP and Username: root <br><br><img src="https://habrastorage.org/files/0ee/b60/88b/0eeb6088bfb440408d11527e5b3a821b.png" alt="Krusader New Network Connection"><br><br>  I copied the executable file hello_cross_gcc_02 from the Debug folder of the project to the QEMU home folder. <br>  Then you can open the terminal in the QEMU graphical interface and start the program for execution from there.  It seemed to me more convenient to connect via ssh.  In the terminal window of the host machine, run ssh <br><pre> <code class="bash hljs">$ ssh root@192.168.7.2</code> </pre> <br>  and run the newly copied executable: <br><pre> <code class="bash hljs">$ ./hello_cross_gcc_02</code> </pre> <br>  It should work <br>  Hello World! <br><br><h4>  Build in ADT </h4><br>  Yocto provides the Application Development Toolkit (ADT), which contains: <br><ul><li>  architecture-oriented and sysroot cross-toolchain compiled by OpenEmbedded using Poky </li><li>  Yocto plugin for Eclipse IDE </li><li>  QEMU to emulate target equipment </li><li>  various development tools working in user-space </li></ul><br><h5>  Eclipse preparation </h5><br>  Made on the basis of this: <a href="http://www.yoctoproject.org/docs/1.3/dev-manual/dev-manual.html">Yocto - Customize Eclipse</a> <br>  In Eclipse, you need plug-ins from the standard configuration: <br>  Linux Tools <br><ul><li>  LTTng - Linux Tracing Toolkit </li></ul><br>  Mobile and Device Development <br><ul><li>  C / C ++ Remote Launch </li><li>  Remote System Explorer End-user Runtime </li><li>  Remote System Explorer User Actions </li><li>  Target Management Terminal </li><li>  TCF Remote System Explorer add-in </li><li>  TCF Target Explorer </li></ul><br>  Programming languages <br><ul><li>  Autotools Support for CDT </li><li>  C / C ++ Development Tools </li></ul><br>  And you need to add a plugin from Yocto.  Download from here: <a href="https://www.yoctoproject.org/downloads/tools/dizzy17/eclipse-juno-plugin-dizzy-17">Yocto Plugin for Eclipse</a> <br><br><h4>  Assembly preparation </h4><br>  For the organization of interaction with IDE and development tools, scripts are provided: <br><pre> <code class="bash hljs">$ bitbake adt-installer $ bitbake meta-ide-support</code> </pre> <br>  to run QEMU, the Yocto plugin needs rpcbind <br><pre> <code class="bash hljs">$ sudo apt-get install rpcbind</code> </pre> <br>  need to edit the file / etc / default / rpcbind <br><pre> <code class="bash hljs">$ sudo nano /etc/default/rpcbind &gt; OPTIONS=<span class="hljs-string"><span class="hljs-string">"-i -w"</span></span></code> </pre> <br><br>  unpack the root filesystem in the folder in sysroots, where the file system of the emulated machine is located.  In our case, qemux86: <br><pre> <code class="bash hljs">$ runqemu-extract-sdk ./tmp/deploy/images/qemux86/core-image-sato-qemux86.tar.bz2 ./tmp/sysroots/qemux86</code> </pre> <br><br><h4>  Set up Yocto ADT in Eclipse </h4><br>  In Eclipse, the Windows menu-&gt; Preferences, Yocto Project ADT <br>  Cross Compiler Options <br>  Build system derived toolchain <br>  Toolchain Root Location: <br>  /home/.../Poky/poky/build/ <br>  Sysroot Location: <br>  /home/.../Poky/poky/build/tmp/sysroots/qemux86 <br>  Target Architecture: i586-poky-linux <br>  Target Options: <br>  QEMU <br>  Kernel: /home/.../Poky/poky/build/tmp/deploy/images/qemux86/bzImage-qemux86.bin <br><br><img src="https://habrastorage.org/files/a53/5e6/139/a535e6139d5a45eb9816e7f725e947f5.png" alt="Yocto Project ADT Preferences"><br><br><h4>  Project Hello, World!  in Eclipse with Yocto ADT </h4><br>  Create a new project <br>  New Project-&gt; C ++ Project <br>  Project name: hello_qemu_cmake_04 <br>  Project type: Yocto Project ADT CMake Project-&gt; Hello World C ++ CMake Project <br><img src="https://habrastorage.org/files/2a1/9d5/c32/2a19d5c3232b4c548cb98e34d38cf284.png" alt="New Yocto ADT CMake Project"><br><br>  Next, Next, Finish <br>  Build project <br>  In the project -&gt; Debug folder should be hello_qemu_cmake_04 <br>  Now you can run the application in the same way as it was with the project created via Cross GCC, except that QEMU is now launched in Eclipse via the menu <br>  Run-&gt; External Tools-&gt; qemu_i586-poky-linux <br><br><h4>  Running and debugging from the Eclipse IDE </h4><br>  Now configure Eclipse so that you can start and debug the application directly from the IDE. <br>  The instruction is taken from here: <br>  <a href="http://www.yoctoproject.org/docs/1.3/dev-manual/dev-manual.html">Downloading and debugging an application using ADT in Eclipse</a> <br>  For convenience, before configuring the remote machine must be running (Run-&gt; External Tools-&gt; qemu_i586-poky-linux, as in the previous section). <br>  To set up debugging, select Eclipse from the menu. <br>  Run -&gt; Debug Configurations ... <br>  In the list on the left you need to find ‚ÄúC / C ++ Remote Application‚Äù, there should be an item with the name of our project and virtual machine.  I have this ‚Äúhello_qemu_cmake_04_gdb_i586-poky-linux‚Äù.  We must choose it. <br>  The guide from Yocto suggests specifying the Remote Absolute File Path for C / C ++ Application.  But now is not the best time for this.  It will be more convenient to first set up communication with the remote machine. <br>  In the meantime, in the right pane, select the Debugger tab, here you need to select remote gdb / mi from the Debugger drop-down list.  This is my only list item, but you still need to select it.  At the same time fill in some other form fields. <br><img src="https://habrastorage.org/files/578/799/303/5787993038a54954bb16b360004daac3.png" alt="Eclipse-> Debug Configurations - Debugger"><br>  Go back to the Main tab and create a connection. <br>  In the Connection section, select New ....  In the New Connection window, select TCF.  I have two of them.  I do not know why the second, but the choice of the first exactly leads to a positive result. <br><br><img src="https://habrastorage.org/files/28f/05c/dea/28f05cdeade343ae876ee4beaede83be.png" alt="Eclipse-> Debug Configurations - Main-> New Connection"><br><br>  In the Host name field, enter the IP of the machine in QEMU.  The Connection name field can be left filled with IP.  , ... In order to have less fuss later, you can also specify login when connecting.  In the Connection section, click Edit ... and fill in the Default User ID.  Root login <br><br><img src="https://habrastorage.org/files/334/24c/4e6/33424c4e612d48fc95439282cf009346.png" alt="Eclipse-> Debug Configurations - Main-> Edit - Properties"><br>  On the Main tab, select the connection you just created. <br>  Now we specify the path to the file and the name of the file with which Eclipse will download the application being debugged to the remote machine. <br>  If QEMU is running, you can click Browse ... and, if the connection is OK, you can see the file system of the remote machine and select the place where to download the application.  You will not necessarily have the same picture as in the screenshot below.  But what is important: you need to specify the file.  If you are going to specify a folder in which there is no file with the name with which you want to download the executable file, then you will not be limited to this window.  Click and add the file name in the Debug Configurations window. <br><br><img src="https://habrastorage.org/files/ffc/9c1/3cd/ffc9c13cd54a4f2aaa4a64c05469848e.png" alt="Eclipse-> Debug Configurations - Main-> Select remote application file"><br><br>  The result should be something like this: <br><br><img src="https://habrastorage.org/files/5bb/ee6/a91/5bbee6a91d3849d7b2e250735bcd4bec.png" alt="Eclipse-> Debug Configurations - Main"><br><br>  Now you can click. <br><br>  In my Eclipse console window, ‚ÄúRemote Shell‚Äù was like this: <br><br><pre> <code class="hljs ruby">root@qemux86<span class="hljs-symbol"><span class="hljs-symbol">:/</span></span><span class="hljs-comment"><span class="hljs-comment"># e c h o $ P WD'&gt;' /&gt; ‚Ä¶</span></span></code> </pre><br>  Then an invitation to switch to the Debug perspective.  It makes sense to agree. <br>  The debugger stopped at the string <br><pre> <code class="hljs lisp">printf(<span class="hljs-string"><span class="hljs-string">"Hello World!\n"</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  Click Step Over (F6) <br>  In the terminal <br><pre> <code class="hljs css">... <span class="hljs-selector-tag"><span class="hljs-selector-tag">Remote</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">debugging</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Hello</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">World</span></span>!</code> </pre><br>  Now you can write a program.  Bye for QEMU x86. </div><p>Source: <a href="https://habr.com/ru/post/255917/">https://habr.com/ru/post/255917/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255897/index.html">Why I could not switch from Firefox to Chrome and how I managed to do it</a></li>
<li><a href="../255899/index.html">Where to look if the site is constantly hacked, or how I caught the malware on the site of one of the clients</a></li>
<li><a href="../255903/index.html">Logiblocs Spytech kit overview</a></li>
<li><a href="../255913/index.html">Managing server disk space on the fly: 1cloud experience</a></li>
<li><a href="../255915/index.html">HP OpenStack Helion First Meet</a></li>
<li><a href="../255921/index.html">Eco Driving: an overview of the driver behavior assessment tool.</a></li>
<li><a href="../255925/index.html">Data carriers. What we have year 2015 and what should we expect beyond its horizon?</a></li>
<li><a href="../255927/index.html">Intel Edison officially in Russia: pre-order and project competition</a></li>
<li><a href="../255929/index.html">Schneider Electric thanked the winner of the PHDays hacker contest</a></li>
<li><a href="../255931/index.html">IPP functions with border support for multi-stream image processing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>