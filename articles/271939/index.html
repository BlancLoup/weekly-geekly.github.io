<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk + LUA: quick start</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Over the last year several articles about using lua dialplan in asterisk ( one , two , three , four ) appeared on Habr√©. This is quite an interesting ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk + LUA: quick start</h1><div class="post__text post__text-html js-mediator-article">  Over the last year several articles about using lua dialplan in asterisk ( <a href="http://habrahabr.ru/post/243125/">one</a> , <a href="http://habrahabr.ru/post/264819/">two</a> , <a href="http://habrahabr.ru/post/243213/">three</a> , <a href="http://habrahabr.ru/post/243251/">four</a> ) appeared on Habr√©.  This is quite an interesting way of writing flexible and powerful dialplans.  But to try this way of writing dialplans, you need to spend some amount of time: install the necessary libraries, rebuild the asterisk with the necessary options. <br><br>  In addition, many asterisk users have a different level of training: someone is closer to system administration or even to traditional telephony than to programming.  Plus, the specificity of telephony - it is better once again with unfamiliar experiments not to load working systems, but to carry out tests and experiments on your laptop - you have to clutter up the system.  In general, there are many reasons to "postpone until later." <br><br>  In this article I want to show everyone and those who work with asterisks how, using the docker, you can quickly feel the taste of flexible lua scripts.  And then decide whether to use it further in practice or not.  (Who is not interested in reading, and it is interesting to watch and listen - at the end of the text is a 6-minute video with the main points and results.) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/2ca/668/2ea/2ca6682ead5b4f3cbd0a5eca2990e112.png" title="Asterisk Lua Docker"><br><a name="habracut"></a><br><h4>  Introductory word </h4><br>  As part of working on several of my projects, following the current trend of packing everything into containers, I prepared the image of <a href="https://hub.docker.com/r/antirek/astolua/">astolua</a> (asterisk + lua).  The Dockerfile contains commands for installing asterisk 11, lua 5.1, luarocks (package manager for lua), luamongo (driver for accessing mongodb), some packages of lua rocks.  You can later on in the <a href="https://github.com/antirek/docker-astolua">docker-astolua repository</a> take only <a href="https://github.com/antirek/docker-astolua">what is</a> useful for you and collect your workhorse. <br><br>  Of course, the advantage of the docker is the ability to download an image, perform tests, experiment tests, and then delete images, leaving your operating system clean and in a familiar manner. <br><br>  Based on the astolua image, we will create our working image in which we will use the asterisk configuration test files and the dialplan on lua. <br><br><h4>  Training </h4><br>  We need a docker.  If you do not have it installed, then please install the docker first ( <a href="https://docs.docker.com/engine/installation/">official documentation</a> , <a href="http://habrahabr.ru/company/infobox/blog/240623/">article on Habr√©</a> ). <br><br>  We also need git ( <a href="https://git-scm.com/book/ru/v1/%25D0%2592%25D0%25B2%25D0%25B5%25D0%25B4%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5-%25D0%25A3%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0-Git">install git</a> ) <br><br>  Also immediately note that my working system is Ubuntu 14.04.  If you are using a different Linux, then there should be no differences in the teams, but the nuances are not excluded. <br><br><h4>  Download astolua image </h4><br>  Tighten the image (attention, the image will be downloaded from the <a href="https://hub.docker.com/">hub.docker.com</a> repository ~ 600MB in size). <br><br><pre><code class="bash hljs">docker pull antirek/astolua</code> </pre> <br><br><h4>  Sample </h4><br>  Cloning <a href="https://github.com/antirek/docker-astolua-sample">docker-astolua-sample</a> is a pre-prepared set of files for this article. <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/antirek/docker-astolua-sample.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> docker-astolua-sample</code> </pre><br><br>  Now let's look at sample and look at the contents of the directory. <br><br>  <b>Dockerfile file</b> <br><br>  The file to build our working image.  In it we indicate that we take astolua as a basis.  Then we add the startup script after_start.sh, which will be executed when the container is started.  In the console, where we run the container, the asterisk console log will be displayed. <br><br>  <b>Build file</b> <br><br>  Inside the file, the docker team is building a sample image from our Dockerfile. <br><pre> <code class="bash hljs">docker build -t <span class="hljs-string"><span class="hljs-string">"astolua:sample"</span></span> .</code> </pre><br><br>  <b>Run file</b> <br>  Inside the file is the docker's command to launch the container based on the sample image with the configuration of the resources it needs. <br><br><pre> <code class="bash hljs">docker run \ -v /etc/localtime:/etc/localtime:ro \ -v $(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>)/store/etc/asterisk:/etc/asterisk \ -v $(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>)/store/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/asterisk:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/asterisk \ -v $(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>)/store/var/menu:/var/menu/ \ --net=host \ -i -t <span class="hljs-string"><span class="hljs-string">"astolua:sample"</span></span></code> </pre><br><br>  <b>Folder store</b> <br>  The store folder contains the asterisk configuration files (such as those usually found in / etc / asterisk) and folders for logs and voice menus. <br><br>  The run command is the most interesting, because  the required resources for the container are indicated here.  For example, with the -v $ (pwd) / store / etc / asterisk: / etc / asterisk option, we specify that the configuration files from our store folder should appear inside the container in its place in / etc / asterisk. <br><br>  Why are the commands in the files?  It is convenient to edit the commands in the files, because  this speeds up time to test changes in teams with different options, and all changes will fall under version control.  And it is also convenient to transfer the options to docker-compose later, if the image will be shared with others. <br><br>  Let's go back to the console. <br><br>  Make an image of astolua: sample (in the directory where we have cloned docker-astolua-sample) <br><pre> <code class="bash hljs">./build</code> </pre><br><br>  Run asterisk (if you have an asterisk or another service that occupies port 5060 already running on the machine, then it is better to stop it) <br><pre> <code class="bash hljs">./run</code> </pre><br><br>  The asterisk download log should crash into the console.  You can test the connection. <br><br>  In the asterisk configuration file sip.conf there are two subscribers 101 and 102 (password 1234), and in the queues.conf file the queue 1234, to which these two subscribers are added.  Set up your softphone or hardphone for 101 subscribers and try to make a call to subscriber 102. (There are no trunks to connect to external voip services or settings of any hardware, so we will test dialplan on local calls).  Information about the call between subscribers should appear in the console of the asterisk. <br><br>  Do subscribers work, pass calls?  Ok, so the asterisk in the docker is working as it should. <br><br><h4>  Dialplan lua </h4><br>  Dialplan lua is in the file extensions.lua.  In the asterisk configuration files in the store / etc / asterisk folder there is an example of a working lua dialplan. <br><br>  In this file, variable extensions and hints must be correctly described (in lua terminology, these are ‚Äútables‚Äù). <br><br>  The extensions table contains contexts and corresponding extensions.  Just like in a traditional dialplan.  But each extension is processed by its own function, in which you can already do anything on lua, while interacting with the asterisk through the app and channel tables. <br><br>  The simplest example <br><br><pre> <code class="lua hljs">extensions = { [<span class="hljs-string"><span class="hljs-string">"internal"</span></span>] = { [<span class="hljs-string"><span class="hljs-string">"_1XX"</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context, extension)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">-- do something -- app.dial('SIP/'..extension); -- do something again end; } }</span></span></code> </pre><br><br>  It can be seen that the dialplan application Dial is available through the app, it takes all the same parameters as in the traditional dialplan.  Through the app, <a href="https://wiki.asterisk.org/wiki/display/AST/Asterisk%2B11%2BDialplan%2BApplications">all dialplan applications</a> are available. <br><br>  The channel variable gives access to channel variables.  So, for example, we get dialstatus. <br><br><pre> <code class="lua hljs">extensions = { [<span class="hljs-string"><span class="hljs-string">"internal"</span></span>] = { [<span class="hljs-string"><span class="hljs-string">"_1XX"</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context, extension)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">-- do something -- app.dial('SIP/'..extension); local dialstatus = channel["DIALSTATUS"]:get(); app.noop('dialstatus: '..dialstatus); end; } }</span></span></code> </pre><br><br>  You can change extensions.lua and then the command in the asterisk CLI <b>module reload pbx_lua.so to</b> reread extensions.lua.  Asterisk will check the lua syntax, and if everything is ok, then it will be loaded for execution - you can test the changes. <br><br>  What else can you do in the lua dialplan? <br><br>  For example, flexibly handle dialstatus, which will be returned by the Dial Dialplan function.  No more reinventing these <a href="http://www.voip-info.org/wiki/view/Asterisk%2Bvariable%2BDIALSTATUS">Goto (s - $ {DIALSTATUS}, 1)</a> , now you can write a status check <br><br><pre> <code class="lua hljs">extensions = { [<span class="hljs-string"><span class="hljs-string">"internal"</span></span>] = { [<span class="hljs-string"><span class="hljs-string">"_1XX"</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context, extension)</span></span></span></span> app.dial(<span class="hljs-string"><span class="hljs-string">'SIP/'</span></span>..extension); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> dialstatus = channel[<span class="hljs-string"><span class="hljs-string">"DIALSTATUS"</span></span>]:get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> dialstatus == <span class="hljs-string"><span class="hljs-string">'BUSY'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">-- do something elseif dialstatus == 'CHANUNAVAIL' then -- do another thing end; end; } }</span></span></code> </pre><br><br>  In the example of extensions.lua there is an example of a simple ivr: by calling 200, you will hear an entry from the file / var / menu / demo and you can move on by pressing 1 or 2. <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ivr = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context, extension)</span></span></span></span> app.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(<span class="hljs-string"><span class="hljs-string">"IVR_CHOOSE"</span></span>, <span class="hljs-string"><span class="hljs-string">"/var/menu/demo"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> choose = channel[<span class="hljs-string"><span class="hljs-string">"IVR_CHOOSE"</span></span>]:get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> choose == <span class="hljs-string"><span class="hljs-string">'1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> app.queue(<span class="hljs-string"><span class="hljs-string">'1234'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> choose == <span class="hljs-string"><span class="hljs-string">'2'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> dial(<span class="hljs-string"><span class="hljs-string">'internal'</span></span>, <span class="hljs-string"><span class="hljs-string">'101'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> app.hangup(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  For a person who has written a couple of dozen lines of a traditional dialplan, everything should be familiar here.  Plus, the full power of lua and luarocks packages appears.  I hope it is obvious that here in the dialplan you can send SMS, email, put data in DB, take data from DB, and DB can be any: mysql, mongodb, redis, etc., make a command call, initiate another call , to make a cool routing of a call on trunks, etc., not forgetting, of course, that this all works as part of an asterisk, and it is better to solve all the ‚Äúhard‚Äù tasks separately. <br><br><h4>  What's next? </h4><br>  I suggest: <br><ul><li>  see the <a href="https://wiki.asterisk.org/wiki/display/AST/Lua%2BDialplan%2BConfiguration">official documentation of Asterisk and LUA</a> - enough examples and comparisons to understand the basics </li><li>  read once again articles on Habr√© from <a href="http://habrahabr.ru/users/sayman_nsk/" class="user_link">Sayman_Nsk</a> and <a href="http://habrahabr.ru/users/ovoshlook/" class="user_link">ovoshlook</a> : <a href="http://habrahabr.ru/users/ovoshlook/" class="user_link">dialplan</a> <a href="http://habrahabr.ru/post/243125/">on lua</a> , <a href="http://habrahabr.ru/post/264819/">AMI in dialplan</a> , <a href="http://habrahabr.ru/post/243213/">updating DEF codes</a> , <a href="http://habrahabr.ru/post/243251/">creating IVR</a> </li><li>  see <a href="https://gist.github.com/igmar/4066527">an example of dialplan for lua from Igmara</a> , where most of the PBX functionality is implemented: calls to subscribers, registration / registration of queue operators, webhook'i for incoming calls, routing depending on the day of the week and time of day. </li><li>  "Gash" something of their own :) </li></ul><br><br>  I hope this article will be useful for a quick start, and you will find one free winter evening and try this way of writing dialplans. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/qRzgJDpHhZQ%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhg6GgD7GEbO7pjTwUVLTO6c3se5rA" frameborder="0" allowfullscreen=""></iframe><br><br>  Errors?  Patches?  Questions?  Please write. </div><p>Source: <a href="https://habr.com/ru/post/271939/">https://habr.com/ru/post/271939/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271927/index.html">Works and Copies</a></li>
<li><a href="../271929/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ187 (November 23 - 29, 2015)</a></li>
<li><a href="../271931/index.html">How is the rendering frame in GTA V</a></li>
<li><a href="../271935/index.html">What is under the hood of travel startups or why does a programmer need to go to Hack`n`Roll</a></li>
<li><a href="../271937/index.html">5 major risks in custom software development</a></li>
<li><a href="../271941/index.html">Getting Started with Java 9 and the Jigsaw Project - Part One</a></li>
<li><a href="../271943/index.html">Change desktop background and lock screen from CW / XAML UWP application</a></li>
<li><a href="../271945/index.html">Development of a parser, code generator and SQL editor using EMFText</a></li>
<li><a href="../271947/index.html">Opera Link closes in December</a></li>
<li><a href="../271951/index.html">Application implementation - device owner for Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>