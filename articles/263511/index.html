<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Improving Fody MethodDecoratorEx for asynchronous methods</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article focuses on a tiny improvement on the Fody.MethodDecorator project with the addition of the ability to decorate asynchronous methods. 

 Sm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Improving Fody MethodDecoratorEx for asynchronous methods</h1><div class="post__text post__text-html js-mediator-article">  The article focuses on a tiny improvement on the Fody.MethodDecorator project with the addition of the ability to decorate asynchronous methods. <br><a name="habracut"></a><br><h4>  Small preface </h4><br>  In narrow circles, <a href="http://habrahabr.ru/post/111130/">aspect-oriented programming</a> tools such as PostSharp and Fody are widely known. <br><br>  The first is a shareware utility and, in my opinion, is extremely <a href="https://www.postsharp.net/purchase">limited in its free version</a> , in particular, it cannot be applied to Windows Store projects, use automatic INotifyPropertyChanged in more than 10 classes, and so on.  Many of these restrictions and the relatively high price make you look towards alternatives. <br><br>  Fody, in turn, is free, based on Mono.Cecil and equipped with many plug-ins.  More details about them can be found in <a href="http://habrahabr.ru/post/220701/">this article</a> by <a href="http://habrahabr.ru/users/alexeysuvorov/" class="user_link">AlexeySuvorov</a> .  I encountered MethodDecorator with one of these plugins, which was also slightly improved by the previous article I encountered during the implementation of logging. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  So, decorating methods </h4><br>  After loading the MethodDecoratorEx package, to simplify logging (or some other processing), the necessary attribute is created, which inherits the IMethodDecorator interface with input methods, output methods, and exception handling and is hooked to the necessary methods. <br><br><pre><code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">AttributeUsage(AttributeTargets.Method | AttributeTargets.Constructor | AttributeTargets.Assembly | AttributeTargets.Module)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AsyncInterceptorAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span>, <span class="hljs-title"><span class="hljs-title">IMethodDecorator</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> instance, MethodBase methodBase, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnEntry</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnExit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnException</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Exception exception</span></span></span><span class="hljs-function">)</span></span> { ... } }</code> </pre> <br>  The method decorated with such an attribute after compilation contains the code for processing the input to the method, exiting it and catching exceptions. <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">AsyncInterceptor</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Bar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Hi"</span></span>; }</code> </pre><br><img src="https://habrastorage.org/files/f52/508/ed9/f52508ed916c4b668b3cb95c5ac43420.PNG"><br><br>  But if the method is asynchronous, a problem arises.  The input to the method and the output from the method are intercepted without problems, but exceptions, if they arise, are not logged at all.  This happens because even an asynchronous method decorated with an attribute is translated into special, finite automaton magic, which does not allow to catch the exception in our method. <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">AsyncInterceptor</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Bar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(); }</code> </pre><br><img src="https://habrastorage.org/files/31e/986/fbf/31e986fbff2a4af3ac002572cd51b099.PNG"><br><br>  To solve this problem, the following workaround was used - modify MethodDecoratorEx so that you can intercept the returned Task, and process it with the TaskContinuation method as follows: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TaskContinuation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task task</span></span></span><span class="hljs-function">)</span></span> { task.ContinueWith(OnTaskFaulted, TaskContinuationOptions.OnlyOnFaulted); task.ContinueWith(OnTaskCancelled, TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith(OnTaskCompleted, TaskContinuationOptions.OnlyOnRanToCompletion); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnTaskFaulted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task t</span></span></span><span class="hljs-function">)</span></span> { ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnTaskCancelled</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task t</span></span></span><span class="hljs-function">)</span></span> { ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnTaskCompleted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task t</span></span></span><span class="hljs-function">)</span></span> { ... }</code> </pre><br><img src="https://habrastorage.org/files/13f/fd9/ac8/13ffd9ac8518445b86f4c70e2bc6e131.PNG"><br><br><h4>  What has changed in the MethodDecoratorEx project? </h4><br>  Very little.  The receipt of the TaskContinuation method has been added, checking that the return value contains the name of the Task type.  And depending on this, the execution of three IL instructions has been added. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IEnumerable&lt;Instruction&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTaskContinuationInstructions</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> ILProcessor processor, VariableDefinition retvalVariableDefinition, VariableDefinition attributeVariableDefinition, MethodReference taskContinuationMethodReference</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (retvalVariableDefinition == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Instruction[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tr = retvalVariableDefinition.VariableType; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tr.FullName.Contains(<span class="hljs-string"><span class="hljs-string">"Task"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { processor.Create(OpCodes.Ldloc_S, attributeVariableDefinition), processor.Create(OpCodes.Ldloc_S, retvalVariableDefinition), processor.Create(OpCodes.Callvirt, taskContinuationMethodReference), }; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Instruction[<span class="hljs-number"><span class="hljs-number">0</span></span>]; }</code> </pre><br><br>  This implementation works correctly on my tasks, but it has a couple of flaws.  Still, the project, modified on the knee, a little more damp. <br><br>  In particular, all xUnit tests that were written for MethodDecoratorEx are now suddenly falling.  There is no time to deal with this, so if someone has a desire to rewrite the tests correctly, or to help, I will be glad. <br><br>  You can also slightly improve the check on Task. <br><br>  Project <a href="https://github.com/KonstantinFinagin/MethodDecorator">here</a> <br>  NuGet package <a href="https://www.nuget.org/packages/MethodDecoratorExAsync.Fody/">here</a> <br><br>  Thank you very much for your attention. </div><p>Source: <a href="https://habr.com/ru/post/263511/">https://habr.com/ru/post/263511/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263497/index.html">Intel lectures and training on software engineering. August, Moscow</a></li>
<li><a href="../263503/index.html">Blow from the past: DIPS-attack RIPv1, or the old routers are dangerous</a></li>
<li><a href="../263505/index.html">We display data from Serial in Chrome Application</a></li>
<li><a href="../263507/index.html">Python meetup - 2 years</a></li>
<li><a href="../263509/index.html">Developer Path, Part 3: The Game Creation History</a></li>
<li><a href="../263513/index.html">Continuous Success and why this should not be forgotten when developing a project (using the example of Drupal)</a></li>
<li><a href="../263515/index.html">Parsing a function from the standard library D</a></li>
<li><a href="../263531/index.html">We write and listen to conversations in 3CX</a></li>
<li><a href="../263533/index.html">The Magic of Tensor Algebra: Part 12 - Rodrigues-Hamilton Parameters in Solid Kinematics</a></li>
<li><a href="../263535/index.html">IBM, along with 200 universities around the world, is preparing the next generation of cloud service developers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>