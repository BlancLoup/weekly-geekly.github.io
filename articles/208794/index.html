<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Polymorphic end-to-end associations in Ruby on Rails</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article deals with the method of creating polymorphism for many-to-many connections in Ruby on Rails. 

 Task 
 Assume that you need to develop a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Polymorphic end-to-end associations in Ruby on Rails</h1><div class="post__text post__text-html js-mediator-article">  The article deals with the method of creating polymorphism for many-to-many connections in Ruby on Rails. <br><br><h4>  Task </h4><br>  Assume that you need to develop a system for managing freight transport.  At our disposal there are several types of this transport: trains, helicopters, trucks and barges.  And it is known that each vehicle carries out transportation only to strictly defined settlements.  For example, some trucks ride around the central part of Russia, some along the south, helicopters operate in Siberia and Kamchatka, trains are generally limited to railway tracks, and so on. <br>  Each type of transport in the developed system will be represented by its class: <b>Train</b> , <b>Copter</b> , <b>Truck</b> , <b>Ship,</b> respectively. <br>  Localities (cities, towns, research stations, here we are not interested in size, but in geographical coordinates), where transportation is carried out, are represented by the <b>Location</b> class. <br>  There is a condition: any <b>Location</b> can be attached to each unit of transport.  In turn, any number of vehicles of different types can be attached to each locality. <br><img src="https://habrastorage.org/getpro/habr/post_images/a41/94e/b20/a4194eb201e9f04bd16721b967b017b2.png"><br><a name="habracut"></a><br><br>  The problem would be solved very simply in two cases, if: <br>  - each settlement was associated with only one type of transport, it was possible to use the usual <a href="http://guides.rubyonrails.org/association_basics.html">polymorphic associations</a> ; <br>  - there was only one type of transport, then <a href="http://guides.rubyonrails.org/association_basics.html">many-to-many associations</a> could be used. <br>  But in this example it is necessary to use the third method, which includes the capabilities of both methods. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Non-optimal solution </h4><br>  The first thing that comes to mind is to create four service transitive tables that will combine each type of transport with settlements. <br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Train</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">train_locations</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dependent</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">destroy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">locations</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">train_locations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TrainLocation</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">belongs_to</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">train</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">belongs_to</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">location</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  <a href="http://pastebin.com/5ZxNf2Wa">View full code</a> <br><br>  And the <b>Location</b> class, which refers to all 4 modes of transport. <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Location</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">train_locations</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dependent</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">destroy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ship_locations</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dependent</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">destroy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">copter_locations</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dependent</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">destroy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">truck_locations</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dependent</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">destroy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trains</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">train_locations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ships</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ship_locations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">copters</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">copter_locations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trucks</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">truck_locations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Ufff ... It seems that there are 9 tables, 9 models and a bunch of homogeneous code.  Doesn't that seem too much to implement one connection?  And if there are 10 types of transport, you need 21 tables and 21 models for implementation? <br>  Why not try using polymorphism in a single transitive table? <br>  No sooner said than done! <br><br><h4>  Preliminary decision </h4><br>  Create a migration: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateMoveableLocations</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Migration </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">change</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create_table</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable_locations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">references</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">location</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">references</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">polymorphic</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timestamps</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  <i>Yes, I understand that moveable is not the most successful name, but it is better than transportable.</i> <br><br>  Next, create a class to store the associations: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MoveableLocation</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">belongs_to</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">location</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">belongs_to</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">polymorphic</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Create classes for modes of transport: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Train</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable_locations</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">as</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dependent</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">destroy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">locations</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable_locations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  <a href="http://pastebin.com/L7Z08Fzf">View full code</a> <br><br>  The <b>as</b> parameter is mandatory here, it tells the <b>Train</b> class that the connection is polymorphic. <br>  And reduce the <b>location</b> <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Location</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable_locations</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dependent</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">destroy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trains</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable_locations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ships</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable_locations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">copters</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable_locations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trucks</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable_locations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  We run tests (after all, everyone writes tests for models, right?) And ... they do not pass. <br><br><h4>  Optimal solution </h4><br>  The fact is that there is still a little bit of special magic that will explain to the <b>Location</b> class the correspondence of associations (trains, ships etc) to the values ‚Äã‚Äãin the column <b>moveable_type</b> . <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Location</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable_locations</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dependent</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">destroy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with_options</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable_locations</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">source</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">moveable</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">location</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trains</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">source_type</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Train</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ships</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">source_type</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ship</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">copters</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">source_type</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Copter</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trucks</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">source_type</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Truck</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  The <b>with_options</b> block here only reduces the amount of code and does not write <b>: through =&gt;: moveable_locations,: source =&gt;: moveable</b> after each association is declared. <br>  <b>source</b> and <b>source_type</b> are the parameters that will magically associate the <b>Location</b> with all modes of transport <i>(I met the statement that source_type is a replacement for the class_name parameter, but this is not quite true, source_type is used only for polymorphic associations)</i> . <br>  Now we can conveniently work with entities in this way: <br><pre> <code class="ruby hljs">train = Train.new train.locations &lt;&lt; city1 train.locations &lt;&lt; city2 train.locations &lt;&lt; city3 copter = Copter.new copter.locations &lt;&lt; city1</code> </pre><br>  And even so: <br><pre> <code class="ruby hljs">big_city = Location.new big_city.trains &lt;&lt; train1 big_city.trains &lt;&lt; train2 big_city.copters &lt;&lt; copter1 big_city.trucks &lt;&lt; truck1 big_city.trucks &lt;&lt; truck2</code> </pre><br>  As a result, we needed only one additional table and one additional model to implement a polymorphic transitive relationship. <br>  <a href="http://pastebin.com/FTmvfu0d">View full code</a> <br><br>  PS: <br>  Two lines in the means of transport: <br><pre> <code class="ruby hljs"> has_many <span class="hljs-symbol"><span class="hljs-symbol">:moveable_locations</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">as:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:moveable</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">dependent:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:destroy</span></span> has_many <span class="hljs-symbol"><span class="hljs-symbol">:locations</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">through:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:moveable_locations</span></span></code> </pre><br>  are common to all four classes, so they can be removed in a common plug-in </div><p>Source: <a href="https://habr.com/ru/post/208794/">https://habr.com/ru/post/208794/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208782/index.html">SoftEther VPN - an advanced multi-protocol VPN server and client</a></li>
<li><a href="../208784/index.html">How a good piece of hardware was made excellent - an overview of EMC VNX storage systems</a></li>
<li><a href="../208786/index.html">Packet crafting as it is</a></li>
<li><a href="../208788/index.html">Seamless splitting and splicing video with DirectShow</a></li>
<li><a href="../208792/index.html">Data Virtualization in WPF</a></li>
<li><a href="../208796/index.html">Domestic MOOC provider - Universarium</a></li>
<li><a href="../208798/index.html">Google Glass as a regular tool for data center employees</a></li>
<li><a href="../2088/index.html">In the UK, Google overtakes television</a></li>
<li><a href="../208800/index.html">Apple App Store. Get ERN</a></li>
<li><a href="../208802/index.html">Export Favorites on Habr√© in PDF</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>