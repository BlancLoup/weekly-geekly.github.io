<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Principles of Fast Haskell under GHC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="GHC (Glasgow Haskell Compiler) is a standard Haskell compiler. GHC is one of the coolest compilers in the world, but unfortunately without additional ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Principles of Fast Haskell under GHC</h1><div class="post__text post__text-html js-mediator-article"> GHC (Glasgow Haskell Compiler) is a standard Haskell compiler.  GHC is one of the coolest compilers in the world, but unfortunately without additional gestures, the programs compiled by it resemble interpreted ones in terms of speed, that is, they work very slowly.  However, if you unlock the full potential of the compiler, Haskell is close in performance to the same code in C. <br><br>  In this article, I summarize the experience of squeezing the maximum out of GHC when creating the <a href="http://habrahabr.ru/post/170571/">Yarr dataflow framework</a> . <br><a name="habracut"></a><br>  The article consists of rather trivial separately observations, but I think it is suitable as a reminder or a start in the subject.  The principles described are empirical, I do not know the internal structure of the GHC.  I don‚Äôt know the compiler theory either, so if for some reason there are generally accepted terms, suggest in the comments. <br><br>  The current GHC version is 7.6.1. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      One final note: in fact, with ‚Äúdefault‚Äù GHC, everything is not as bad as described in the first paragraph, even if you just compile with the <code>-O2</code> option.  Sometimes the compiler makes a fast machine code without a hint of a programmer, but it depends <i>solely on the position of the stars</i> , it is enough to fix one letter in the program so that the GHC suddenly stops understanding how to optimize it. <br><br><hr><br>  There are 2 main areas of optimization that are conducted by GHC: <br><ul><li>  Splitting data types into elementary pieces and transforming functions for working directly with them (see <a href="http://www.haskell.org/ghc/docs/7.6.1/html/users_guide/primitives.html">Unboxed types and primitive operations</a> ) </li><li>  Inline and Function Specialization </li></ul><br>  They support each other, that is, if the data structures do not split, then functions are built in worse, and vice versa.  Therefore, it makes no sense to follow only a couple of the following tips, there will be almost no result. <br><br><h4>  Data types </h4><br><h5>  Avoid multiple constructor data types. </h5><br>  <i>Including Maybe, Either and <b>lists</b> , no matter how ‚Äústandard‚Äù they are.</i>  The reason is obvious - such data types cannot be decomposed into components, because it is not statically known what their structure is. <br><br>  The only exception is enumeration types with several constructors without parameters: <code>Bool</code> , <code>Ordering</code> , etc. <br><br>  If you think about it, the lists in Haskell are simply connected, which are practically not used in imperative languages ‚Äã‚Äãbecause of their slowness.  So why not use <a href="http://hackage.haskell.org/package/vector">vectors</a> instead of Haskell (instead of standard strings - <a href="http://hackage.haskell.org/package/bytestring">ByteString</a> ), which are hardly inferior to the lists in terms of convenience and capabilities.  For replacing short lists with several elements, <a href="http://hackage.haskell.org/package/fixed-vector">vectors of statically known length are</a> even better suited. <br><br>  See also: <a href="http://www.haskell.org/haskellwiki/Performance/Data_types">HaskellWiki - Performance / Data types</a> . <br><br><h5>  Declare fields in structures to be strict, if you don‚Äôt know exactly why they should be lazy. </h5><br>  A normal, lazy field is a reference to a closure that returns a field value.  Strict field - a link to the field value.  The built-in (unboxed) field is the value itself (if it is also a structure, then it is fully embedded in the parent).  The built-in field is obtained by adding the strict directive <code>{-# UNPACK #-}</code> . <br><br>  Without the first option, as in the case of lists, it‚Äôs actually a pretty good life.  In each case, make an informed choice in favor of 2 or 3 options.  Fields by reference are sometimes more efficient in memory, faster when creating structures, checking for equality.  Built-in fields are faster when reading.  If built-in fields are most often needed (most likely), compile with the <code>-funbox-strict-fields</code> flag and add the <code>{-# NOUNPACK #-}</code> directive to the "reference" fields. <br><br>  See also: <a href="">Haskell Style Guide / Dealing with laziness</a> . <br><br><h5>  Explicitly calculate structures before reuse. </h5><br>  In the example, the structure <code>t</code> many times when displaying a vector: <br><pre> <code class="haskell hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Data.Vector <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> V ... data T = T !Int !Int fSum (<span class="hljs-type"><span class="hljs-type">T</span></span> <span class="hljs-title"><span class="hljs-title">xy</span></span>) = x + y ... <span class="hljs-comment"><span class="hljs-comment">-- t :: T V.map (+ (fSum t)) longVectorOfInts</span></span></code> </pre><br>  GHC does not take structure calculations out of a ‚Äúloop‚Äù: <br><pre> <code class="haskell hljs"><span class="hljs-comment"><span class="hljs-comment">--   GHC    V.map (\x -&gt; case t of (T yz) -&gt; x + y + z) longVectorOfInts</span></span></code> </pre><br>  In the machine code at each iteration there will be a link following and reading the same fields. <br><br>  However, if you ‚Äútell‚Äù the compiler outside the loop, it does not repeat the calculations already carried out somewhere higher on the ASD (abstract syntax tree): <br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">case</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> (<span class="hljs-type"><span class="hljs-type">T</span></span> xy) -&gt; <span class="hljs-type"><span class="hljs-type">V</span></span>.map (+ (fSum t)) longVectorOfInts <span class="hljs-comment"><span class="hljs-comment">-- GHC  : case t of (T xy) -&gt; let s = x + y in V.map (\x -&gt; x + s) longVectorOfInts</span></span></code> </pre><br>  Instead of writing cases manually, you can use the generalized control flow from the <a href="http://hackage.haskell.org/package/deepseq">deepseq</a> package. <br><br>  The example is not very successful, because the structure <code>t</code> used once and you can simply select <code>fSum t</code> as a variable, but I think the essence of the technique is clear. <br><br><h4>  Functions </h4><br>  <b>Rule number 1:</b> add to <i>all</i> small, often (on runtime) called, living far from the root of the ASD functions directive <code>INLINE</code> .  If functions are not built in, the tips in this section become harmful. <br><br><h5>  More features, lambda, currying! </h5><br>  Or, smartly, use the <a href="https://www.google.com/search%3Fhl%3Den%26q%3Dhaskell%2Bcontinuation%2Bpassing%2Bstyle%2Bperformance">continuation passing style</a> . <br><br>  The advantage of closures over data structures is that the GHC is much more positively configured to merge and reduce them. <br><br>  For example, in the Yarr framework, I use a whole system of functions to parameterize calculations instead of configuration structures.  The diagram shows the hierarchy <i>of</i> function <i>types</i> , the arrow ‚ÄúA ‚Üí B‚Äù means ‚ÄúB is obtained by partial application from A‚Äù, burgundy arguments are selected, which in turn are also functions: <br><img src="https://habrastorage.org/storage2/07d/c40/039/07dc40039da60d374e23059aedefa595.png"><br><br>  To ensure that the partially applied function will be specialized, in the definition, break the arguments with lambda: <br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">f</span></span> :: <span class="hljs-type"><span class="hljs-type">A</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">B</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">C</span></span> <span class="hljs-meta"><span class="hljs-meta">{-# INLINE f #-}</span></span> fab = ... <span class="hljs-comment"><span class="hljs-comment">-- body where ... -- declarations --&gt; fa \b -&gt; let ... -- declarations in ... -- body</span></span></code> </pre><br>  This trick is described in the <a href="http://www.haskell.org/ghc/docs/7.6.1/html/users_guide/pragmas.html">INLINE pragma</a> section of the GHC documentation. <br><br><h5>  Be careful with generic functions. </h5><br>  A call to a generalized function (a la true polymorphism in imperative languages) cannot be inline-defined by definition.  Therefore, such functions must be specialized at the call site.  If the GHC knows the exact type of the argument and the generic function itself is supplied with the <code>INLINE</code> directive, then it usually does so.  When extending generalization to several levels of functions, it does not specialize. <br><br><h5>  Raise everything you can to the level of types </h5><br>  If the goal is to get a productive program, it is obviously better to compile it longer than to execute.  In Haskell there are <a href="http://www.haskell.org/haskellwiki/Category:Type-level_programming">many mechanisms for transferring computations to the compilation stage</a> . <br><br>  In Yarr, I used marker <a href="http://www.haskell.org/haskellwiki/GHC/Indexed_types">type indices</a> for <a href="http://habrahabr.ru/post/170571/">static double dispatching</a> , <a href="http://www.haskell.org/haskellwiki/Type_arithmetic">static arithmetic</a> (ready-made arithmetic and logic is in the <a href="http://hackage.haskell.org/package/type-level">type-level</a> library) and some other things. <br><br><h4>  Compilation flags </h4><br>  <code>-O2</code> - always. <br><br>  About <code>-funbox-strict-fields</code> is written above. <br><br>  Now, with the exception of rare cases, faster machine code generates an LLVM <code>-fllvm -optlo-O3</code> : <code>-fllvm -optlo-O3</code> . <br><br>  In order for GHC not to be engaged in fortune telling on the coffee grounds and embed everything that is said, Ben Lippmeier <a href="http://hackage.haskell.org/packages/archive/repa/3.2.3.1/doc/html/Data-Array-Repa.html">recommends</a> using the <code>-funfolding-use-threshold1000 -funfolding-keeness-factor1000</code> . </div><p>Source: <a href="https://habr.com/ru/post/171425/">https://habr.com/ru/post/171425/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171411/index.html">The digest of news from the world of mobile development for the last week # 4 (February 24 - March 3, 2013)</a></li>
<li><a href="../171415/index.html">Uncompromising power and real mobility</a></li>
<li><a href="../171417/index.html">Extending the SOAP to PHP class</a></li>
<li><a href="../171419/index.html">Watching DVDs on Linux is illegal in the USA</a></li>
<li><a href="../171421/index.html">A look at Yandex.Store for Android (Survey)</a></li>
<li><a href="../171427/index.html">Establishing a ‚Äúsecure connection‚Äù with Wells Fargo Bank</a></li>
<li><a href="../171429/index.html">MyIDkey USB flash drive</a></li>
<li><a href="../171431/index.html">Simple-Science - Simple experiences for children (digest # 18)</a></li>
<li><a href="../171433/index.html">Designing high-performance systems: what is not told in the books</a></li>
<li><a href="../171435/index.html">Logic - the most interesting news gaming and IT-industry ‚Ññ16</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>