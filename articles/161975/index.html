<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to draw Zelenograd</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Watching the video Russia: Edits to OpenStreetMap 2007-2012 from ITO World, I wanted to make my own - only in Zelenograd. So that you can clearly see ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to draw Zelenograd</h1><div class="post__text post__text-html js-mediator-article"><img title="Fragment of one of the frames of the video" align="left" src="https://habrastorage.org/storage2/5a1/50a/97c/5a150a97c9b793899fe1dead02b3409f.png">  <a href="http://vimeo.com/53688271">Watching the</a> video <a href="http://vimeo.com/53688271">Russia: Edits to OpenStreetMap 2007-2012</a> from ITO World, I wanted to make my own - only in Zelenograd.  So that you can clearly see the details and even minor edits. <br><br>  The implementation took more than 2 weeks. <br>  In this article I will tell how it was done. <br>  The video itself is immediately under the cut. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/mYLt16fw4kE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Watch Full 1080p Fullscreen with Sound <br><br>  Creating such a video is divided into 2 main parts: <br><ol><li>  Get the right data </li><li>  Collect a video from this data. </li></ol><br><h1>  Get the right data </h1>  Obtaining historical data is somewhat hampered by the OpenStreetMap architecture, which is designed for the rapid issuance of the current map and editing, but not for uploading history.  Additionally, the task is complicated by <a href="http://blog.osmfoundation.org/2012/09/12/openstreetmap-data-license-is-odbl/">changing the license</a> from CC-BY-SA to ODbL, which led to the removal of some of the objects from the database and some other change history.  Zelenograd suffered when changing the license is very strong, at 7:18 it is clearly seen in the video. <br>  In general, while there is no service that would allow conveniently download the entire history of all objects in a certain area. <br><br><h2>  What do you need </h2>  To start, of course, you need to decide what to download. <br>  <a href="http://www.openstreetmap.org/browse/relation/1320358">Zelenograd along the administrative border</a> fits pretty well into an almost square frame.  However, it is impossible to hook the nearest surroundings (Mendeleevo, Chashnikovo, Goluboye, Firsanovka, Pyatnitskoe Highway, etc.) without turning, skewing or significant distortion of the scale.  It was decided to add only <a href="http://www.openstreetmap.org/browse/way/157628859">Firsanovskoye Highway</a> . <br>  Full HD 1920x1080 turned out to be somewhat disproportionate - Zelenograd in the center, incomplete Firsanovka and Skhodnya in the lower right corner and empty other angles.  When saving vertical resolution in 1080 lines, the minimum frame was 1220x1080.  After some meditation on <a href="http://en.wikipedia.org/wiki/File:Vector_Video_Standards4.svg">the video resolution scheme</a> , it was decided to expand to 1440x1080. <br>  To download the data, bbox 55.92-56.05,37.08-37.31 was taken - with a margin under the lines extending beyond the edge of the frame. <br><br><h2>  Data sources </h2>  From the main sources there is (at the time of writing): <br><ol><li>  The main database, issuing only ODbL data - either current in the region, or history by object, or changeset. </li><li>  The last <a href="http://planet.openstreetmap.org/planet/full-history/">full historical dump (full history planet file)</a> of October 19, weighing 37 GB in the bz2 archive, only ODbL data.  Those.  300-500 GB in unpacked form, a month and a half ago and not the whole story. </li><li>  The last <a href="http://planet.openstreetmap.org/cc-by-sa/full-experimental/">complete historical dump under SS-BY-SA</a> from June 1, weighing 35 GB in the bz2-archive.  This is 1.5 months before the ‚Äúcutting out‚Äù by the bot of data incompatible with ODbL and 4.5 months before the license change. </li><li>  <a href="http://planet.openstreetmap.org/replication/day/000/000/">Daily</a> , hourly and minutely diffs - as the current base for ODbL, and the <a href="http://planet.openstreetmap.org/cc-by-sa/day-replicate/000/000/">era of CC-BY-SA</a> , and the <a href="http://planet.openstreetmap.org/redaction-period/day-replicate/000/000/">transition period</a> . </li><li>  Various <a href="http://wiki.openstreetmap.org/wiki/Planet.osm/full">downloads complete history</a> . </li><li>  <a href="http://data.gis-lab.info/osm_dump/diff/RU/">The diurnal defaults of Russia on gis-lab</a> unfortunately contain omissions, the <a href="http://data.gis-lab.info/osm_dump/diff/local/">planetary ones</a> do not, but all of them contain only final versions of modified objects, i.e.  not quite suitable for video more detailed than 1 frame per day. </li></ol><br>  Experiments have shown that cutting the necessary data from a complete historical dump requires substantial resources.  For example, the <a href="https://trac.openstreetmap.org/browser/applications/utils/osm-extract/history-excerpt.pl">history-excerpt.pl</a> script complained about the lack of RAM, even when it was 6 GB. <br><br>  As a result, a mixed version was chosen: <br><ol><li>  The history until 2012.04.01 is taken from the unloading of Russia <a href="http://odbl.poole.ch/extracts/">from Simon Poole</a> (russia.osh.bz2 - 1 GB), only 17 GB in unpacked form. </li><li>  The story from 2012.04.01 to 2012.08.31 is taken from the <a href="http://planet.openstreetmap.org/redaction-period/day-replicate/000/000/">daily diffs of the transition period</a> .  Diffs docked with the era of CC-BY-SA is not complete (some of the April 1‚Äì4 edits are only in hourly and minute changes), but the Zelenograd edits are all daily.  However, 65 GB in unpacked form. </li><li>  The story from 2012.09.01 is taken from the main base by pumping out all the changeset in Zelenograd.  The changeset list was obtained by downloading hundreds of <a href="http://www.openstreetmap.org/browse/changesets%3Fbbox%3D37.08%252C55.92%252C37.31%252C56.05">pages of the history of changing a rectangular area</a> from the site openstreetmap.org.  This source produces a lot of unnecessary data (for example, <a href="http://www.openstreetmap.org/browse/changeset/14082505">Alaska import</a> caught, did not download), but for a short period the amount of data is small - only 90 MB. </li></ol><br><h2>  Cut the desired fragment </h2>  According to the current architecture, in OSM 3 entity types are node, way, and relation.  But if node (point) has coordinates, then way (line) is only a list of node and has no own coordinates.  To upload data for a specific area, this means that you need to select the necessary node, but to select the necessary way, you need to check all the nodes it uses.  Those.  it is necessary to build a sparse list of nodes (identifiers have almost reached 2 billion), allowing you to quickly check the way for it. <br>  Relation is used to group objects and draw complex constructions; they can consist of node, way, and other relation ones, including forming any level of nesting and looping.  For this video, it was decided not to load them and not to display them - since they do not give additional geometry (they can affect the order of painting over areas that are not used in the video). <br><br>  After several experiments, the following order was chosen: <br><ol><li>  The node list was compiled using the egrep utility, which is a regular expression <br>  very quickly pulled all the data through itself (including the packed data was sent to it from the archive without saving to a file). <br>  Next, only the node id (two egrep, sort and uniq) were pulled out of the list and saved to a file.  It took about 30 minutes in total. </li><li>  A specially written program line by line (without parsing XML) scanned the file and pulled out full information about all versions of the found node and about all the ways that use at least one of the selected nodes.  For daily diffs, in which the visible attribute for objects is not specified, this attribute was added based on an external tag (&lt;delete&gt;, etc.).  The search for the node list (about 170 thousand as a result) was speeded up by a 16-bit index (the upper 16 bits from the node id 32-bit representation).  For the list of way, refilled on the fly, the index was not used, because  Way gained only 26 thousand and verification is required much less.  It took about 7 hours, of which 5 hours - for 150 daily diffs. </li></ol><br><br>  The result was checked for correctness: <br><ol><li>  Verification of the successive increase in the versions showed that there are no gaps.  The latest versions of <a href="http://www.openstreetmap.org/browse/way/8038408">way 8038408</a> , which in 2008 went from Torzhok to Zelenograd, were removed manually, and now there is only for Torzhk and <a href="http://www.openstreetmap.org/browse/changeset/13672010">accidentally got</a> into the list of changes received from openstreetmap.org </li><li>  The cuts of the unloading for the necessary days coincided with the unloadings of the city of 2009-2012 that I had saved, as well as the clippings from the selective unloading of the <a href="http://data.gis-lab.info/osm_dump/dump/RU-MOS/">Moscow region from gis-lab</a> for 2012. </li></ol><br>  However, when drawing the frames, it was found that <a href="http://www.openstreetmap.org/browse/way/23273948">way 23273948</a> , which set the boundary of the Yahoo satellite image in 2008-2010, until April 2009 got into my bbox with only <a href="http://www.openstreetmap.org/browse/node/251868383">1 dot</a> and, accordingly, was drawn incorrectly.  Additional nodes of this way were added to the upload manually. <br><br>  The final <a href="http://ge.tt/8hvoTkS/v/4%3Fc">download can be downloaded (6.3 MB to rar)</a> . <br>  Do not forget only that this is data collection under two licenses - CC-BY-SA 2.0 for everything before 2012-09-12T10: 00: 00Z and ODbL 1.0 after. <br><br><h1>  Make a video </h1>  After receiving the data you can start drawing. <br>  However, you first need to determine the speed of the video. <br>  The initial idea of ‚Äã‚Äãmaking the speed constant collapsed at the sight of the list of first edits <br><ol><li>  2005-11-10T17: 35 </li><li>  2007-04-02T12: 30 </li><li>  2007-09-29T11: 29 </li></ol>  Those.  with a total interval of 7 years, for the first almost 2 years, only 2 edits (hereafter, tight).  Void between these edits, it was decided to "squander" quickly. <br>  The overall rate of 1 frame per day seemed too high.  5 years of more or less active edits - 1,830 frames, a little more than a minute. <br>  1 frame per hour will give 30 minutes of video, this is too much. <br>  I stopped at option 1 frame at 4 o'clock (i.e. x360000 relative to reality). <br>  Taking into account the scrolling at the beginning it turned out 11,800 frames, 7:52. <br><br><h2>  Chronokadry </h2> To draw frames, you must either keep all versions of all objects in quick access, or ‚Äúoverlay‚Äù changes consistently over time and draw frames at the right moments.  Stopped on the second version. <br>  Since the unloading from Simon Poole is organized ‚Äúall node - all way - all relation‚Äù, it had to be somehow streamlined over time.  A simple program (again line by line without parsing XML) was unloaded into chrono frames ‚Äî changes for each 4-hour interval were recorded in a separate file, named after the frame time.  It took about 10 minutes. <br>  Now it is enough to load chronokadry consistently and after each draw an image. <br><br>  The unloading, laid out a little higher, is actually a consistent docking of all chrono frames, since  the original was uneven on the structure. <br><br><h2>  SVG rendering </h2>  In order not to invent our own raster renderer, it was decided to create vector SVGs, which could then be converted into raster by ready-made programs.  SVG is convenient because it is xml-but text-based and supports all sorts of convenient things like translucency. <br>  To create SVG, I had to write the program again, now with XML parsing.  However, the amount of data has become quite acceptable. <br>  Rendering took 1 hour and 15 minutes.  The total amount of SVG - 15 GB. <br><br>  20120720080000.svg - the last frame before the arrival of the bot <br> <a href="http://ge.tt/8hvoTkS/v/5%3Fc"><img src="https://habrastorage.org/storage2/7ca/ba9/0c9/7caba90c9b7f464f7cc2036a806a89c9.png"></a> <br><br>  20120721000000.svg - apogee of cutting out non-ODbL data <br> <a href="http://ge.tt/8hvoTkS/v/6%3Fc"><img src="https://habrastorage.org/storage2/eb9/106/162/eb910616244f6a68a66227a88c0d3083.png"></a> <br><br>  I want to note that different programs sometimes interpret SVG in different ways and you have to be prepared for this.  Chromium, with which I looked at the generated files, sometimes showed me a different picture, as then did ImageMagick.  SVG formation had to be adjusted several times. <br><br><h2>  Convert to raster </h2>  Originally planned to convert SVG to <a href="http://en.wikipedia.org/wiki/Portable_Network_Graphics">PNG</a> , as the most suitable format for raster schemes.  However, I could not make friends with avidemux with PNGs formed by ImageMagick, avidemux persistently flooded me with a green frame. <br>  As a result, the conversion was made to BMP. <br>  The convert utility from <a href="http://www.imagemagick.org/script/index.php">ImageMagick</a> worked with a single key ‚Äî type truecolor <br>  The process took 6 hours.  The total amount of BMP is 53 GB. <br><br><h2>  Build video </h2>  The video was assembled from a pack of BMP files by the <a href="http://fixounet.free.fr/avidemux/">avidemux</a> program. <br>  The Xvid codec was chosen as GNU-shny and well-proven.  Regarding the standard settings, only the quantizer was rearranged by 2. <br>  The build took about 25 minutes. <br><br>  Video without music <a href="http://ge.tt/8hvoTkS/v/2%3Fc">laid out as a file (137 MB)</a> under the license CC-BY-SA 3.0 <br>  The two frames of SVG above are also under this license. <br><br><h2>  Music overlay </h2>  Music from my collection is not compatible with CC licenses, so the music version was made for youtube. <br>  To fill almost 8 minutes, the most epic fragments of the compositions were taken. <br><ol><li>  Vangelis - Voices (from about 1:00 to 6:50) </li><li>  Bond - Elysium (approximately from 0:30 to 2:30) </li></ol><br>  Music mixed in Adobe Audition, pasted on the video in <a href="http://www.virtualdub.org/">VirtualDub</a> <br>  Binding of some events to the music was not done, all coincidences are random. <br><br><h1>  Result </h1><br>  What is displayed on the video: <br><ul><li>  Timestamp and license at the relevant moment </li><li>  All unloaded way - lines </li><li>  All unloaded nodes that are not in any way - dots </li><li>  New objects flash white and slowly fade to green and dark green. </li><li>  Modified objects flash yellow and slowly fade to green and dark green. </li><li>  Deleted objects flash red and disappear smoothly (i.e. visible after actual deletion) </li><li>  If the nodes that are included in the way are modified, but the way itself does not change, the nodes flash with yellow dots and fade out. </li><li>  The nicknames of all those who performed the editing in the visible area are displayed - flashing white at the time of editing, gradually goes out to green and disappears </li><li>  Nicknames of two administrative accounts that have cut out non-ODBL data - flashing red </li></ul><br>  Thanks: <br><ul><li>  Simon Poole - for the full history of unloading Russia on April 1, 2012. </li><li>  <a href="http://forum.openstreetmap.org/viewtopic.php%3Fpid%3D294891">Larry0ua</a> - for the idea of ‚Äã‚Äãusing daily diffs. </li><li>  <a href="http://habrahabr.ru/users/giner/">giner</a> - for the idea of ‚Äã‚Äãshowing nicknames, help on using Linux utilities and beta testing. </li><li>  By ImageMagick, avidemux, VirtualDub, Xvid, osmconvert and Ubuntu </li></ul><br>  Suggestions accepted: <br><ul><li>  How to assemble a "video" in the form of 1 SVG with animation </li><li>  What video codec to use for better transmission of such wireframe graphics </li></ul></div><p>Source: <a href="https://habr.com/ru/post/161975/">https://habr.com/ru/post/161975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../161965/index.html">Parts prices 10 years ago</a></li>
<li><a href="../161967/index.html">The study of the attitude of popular programming languages ‚Äã‚Äãto random errors</a></li>
<li><a href="../161969/index.html">Inventarium.mobi - we pumped your feedback forms!</a></li>
<li><a href="../161971/index.html">Instant removal of special offers with kindle paperwhite</a></li>
<li><a href="../161973/index.html">The long-awaited revolutionary release of QEMU 1.3 has been released.</a></li>
<li><a href="../161977/index.html">Box2d and libgdx</a></li>
<li><a href="../161979/index.html">One Div: icons on CSS</a></li>
<li><a href="../161981/index.html">Promotion of mobile applications</a></li>
<li><a href="../161987/index.html">Standard PHP Library (SPL) - Part 1: Data Structures</a></li>
<li><a href="../161989/index.html">Perl6 - I / O Modules</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>