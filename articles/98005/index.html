<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Connecting a rotary encoder to a computer via USB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have long wanted to adapt the volume control made from the encoder to the laptop. You will need to connect this regulator to USB so that everything ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Connecting a rotary encoder to a computer via USB</h1><div class="post__text post__text-html js-mediator-article"> I have long wanted to adapt the volume control made from the <b>encoder</b> to the laptop.  You will need to connect this regulator to USB so that everything will be ‚Äúgrown-up‚Äù (and you cannot connect an external device to the laptop anyway).  Turn the encoder to the left - the volume should decrease, to the right - it should increase.  We press down the encoder knob - run some useful program, or switch to timbre control. <br><a name="habracut"></a><br>  For those who are not aware of what an encoder is, it‚Äôs such a twist, like a volume knob based on a conventional resistor, only this twist has no boundary positions ‚Äî how many will fit in any direction.  The encoder is spinning with nice soft clicks, and it looks like a normal variable resistor. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/f5f/9a6/10e/f5f9a610ec9dae763e5311cc14805a79.png" alt="image"><br><br>  Such devices are not uncommon in modern car receivers and any household devices, the user interface of which is processed by the microcontroller (and this is what any household appliances), and where you need smooth adjustment or adjustment.  A third contact that operates as a button on the handle is often built into the encoder - when we move the encoder handle down (along the axis), this button is triggered.  It greatly enriches the possibilities of user interface - on one encoder you can build the entire control system of an electronic device (but a hemorrhoid is added to a programmer, but these are trifles).  I just had such an encoder. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/geektimes/post_images/5c0/24a/e7b/5c024ae7bd6e08cf1513c0f12b9744ed.jpg" alt="image"><br><br>  The principle of operation of the encoder is quite simple - there are only two contacts in it (the button on the handle does not count), which begin to close as soon as the user starts to turn the encoder handle.  The contacts are connected to the two legs of the microcontroller (working as digital inputs), and when the encoder knob is rotated, impulses appear on these legs, out of phase and number of which the microcontroller determines the direction of rotation and the angle of rotation of the encoder knob. <br><img src="https://habrastorage.org/getpro/geektimes/post_images/661/a5b/299/661a5b2996b3606f24aad388ce7ea0a5.gif" alt="image"><br>  In order for the volume control to work, you need to solve at least three engineering tasks: <br><br>  <b>Step 1</b> .  Creating a low-speed USB device on a breadboard. <br>  <b>Step 2</b> .  Connect an encoder to this USB device, ensure that the microcontroller performs it, and transmits information about the rotation of the encoder to the computer. <br>  <b>Step 3</b> .  Understand how you can programmatically control the volume control.  Surely there is any multimedia API that allows you to do this.  Minimum program - you need to write a program that will receive signals from a USB device and control the volume.  It would be nice, of course, to write a driver, but it's scary to take it.  Better leave for later. <br><br>  So, I will describe the process of creating a regulator in steps.  I omit the details, otherwise it will be too boring.  To whom it is interesting, see the source [6] and documentation links. <br><br>  [ <b>Step 1. Creating a low-speed USB device on a breadboard</b> ] <br><br>  This step was completed without even starting - somehow too simple and banal.  Stupidly downloaded the sample project by reference [1].  Corrected a file usbconfig.h - for Ponte called my device <b>ENCODER DEMO</b> , for more fantasy was not enough.  I checked in the Makefile the type of process (ATmega16), the frequency of quartz (16 MHz) - to match my AVR-USB-MEGA16 layout.  I compiled the project in AVRStudio, flashed the mockup, connected it to the computer - it all started half a turn, my USB device worked properly as a virtual COM port - everything is exactly as written in article [1]. <br><br>  [ <b>Step 2. Connect the encoder to the USB device</b> ] <br><br>  This step caused the greatest fear in me that everything would work as it should.  That the encoder will be connected and I can read it - I did not doubt that.  There were doubts that I would be able to read it qualitatively, when USB protocol processing also works in the background - after all, this is not an easy task for the microcontroller (as it turned out later - I was worried completely in vain). <br><br>  As usual, I began to rummage through the Internet in search of ready-made subroutines for reading the encoder.  I found very quickly what I needed - for AVR, a very simple C code [2], the files encoder.c and encoder.h.  Say what you like, and open source is a cool thing. <br><br>  He attached two indication LEDs - GREEN and YELLOW - to indicate the direction of rotation of the encoder.  For convenience, I connected the encoder directly to the ISP connector, taking advantage of the fact that the MOSI, MISO and SCK signals are just the legs of PB5, PB6 and PB7 of the ATmega16 microcontroller (connected the A and B phases, as well as the encoder button). <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/ae9/bc6/b08/ae9bc6b080460b95d2cd959ae057d21c.jpg" alt="image"><br><br>  Corrected the definition of the legs, added the initialization code.  Attached the encoder.c module to the project.  Added to the main loop the main control of green and yellow LEDs, when it comes from the encoder.  The RED LED is tied to the encoder button - when you press it, the red LED lights up, release it - goes out.  Compiled, flashed - it works.  I twist the knob to the left, and the green LED flashes in time with the encoder clicks.  I twist the knob to the right - the yellow LED flashes.  Despite the fact that the encoder is read by the polling method, thanks to the effective code for reading the encoder, NO ANY criticism even when working simultaneously with the V-USB library (Respect, Pashgan!).  Added the output of information from the encoder to the virtual COM-port (we turn the encoder to the left, I bring minusiki '-' to the console, I turn to the right, I bring plus sign '+' to the console).  On the timer, every 10 ms, I display the status of the encoder button and indicate it with a red LED (the button is pressed - I transmit the symbol '1', released - '0').  Everything is working.  Boredom. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/4c2/b7f/93b/4c2b7f93b4824a5fb1d33aff599ab314.png" alt="image"><br><br>  In conclusion, I threw out the modules cmd.c, crc16.c, eepromutil.c, strval.c.  The amount of code dropped to 3 kilobytes is excellent, now it will fit in the memory of ATtiny45 (you can use AVR-USB-TINY45 layout tool in the future, it is smaller and cheaper). <br><br>  [ <b>Step 3. Understand how you can programmatically control the volume control</b> ] <br><br>  As usual, googled the question.  Weed out a bunch of garbage, and finally grabbed a pearl - [3].  Next thing technology.  I take out the favorite children's designer - Visual Studio.  Without thinking about anything, the wizard generates a dialog-based application.  I throw a volume control slider on the panel, bind a variable to it, add a slider position handler.  When the application starts, I tune the engine to a minimum of 0 and a maximum of 65535 (to match the bounds of the volume values ‚Äã‚Äãthat the mixer control libraries manipulate).  I read the <b>mixerGetControlDetails</b> function <b>with the</b> current volume value, and set the slider to the appropriate position.  In the engine position handler, the opposite is true - I read the engine position and set the desired volume with the function <b>MixSetControlDetails</b> .  Volume control is done exactly as written in article [3].  Checked - works. <br><br>  Now it remains the case for small things - to read what comes from the virtual COM port (on it we have a freshly baked USB device with an encoder).  If a minus (-) arrived, we move the slider to the left (decrease the volume), plus (+), then move the slider to the right (increase the volume).  If the characters 0 and 1 arrive, then the checkbox state is controlled accordingly (just to indicate whether the encoder button is pressed or not).  You can work with a COM port as you would with a regular file (see [4]).  We initialize the connection to the COM port as opening a file (by calling <b>:: CreateFile</b> ) in blocking mode.  We start a separate stream, we add a file reading to the infinite loop (with a blocking call <b>:: ReadFile</b> ) one character at a time, and we analyze this character.  According to which character came, we turn the slider slider in the right direction (the volume will adjust the slider handler) or update the state of the checkbox.  Checked - works. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/f20/75e/7d0/f2075e7d080a191a03a22591a6f3ad74.png" alt="image"><br><br>  That's all, actually.  Then you can do endless (and probably useless) improvement.  Make an automatic search for the desired virtual COM port (now, for simplicity, the COM port name is transmitted via the command line).  Transform a USB device from a <b>CDC</b> class to <b>HID</b> - this can simplify the code of a USB device, as well as simplify software search and discovery of a device on a computer by VID and HID.  Or write a service instead of the program (so that you do not need to run a separate program).  Or even a driver.  This is very interesting, but I do not know how (maybe, who of the habravchan will teach the mind? ..).  Screw some action to the encoder button.  Well, and so on to infinity. <br><br>  I hope someone my research will be useful in their own development.  If I missed something, I will be glad to hear comments in the comments. <br><br>  [ <b>UPD120803</b> ] <br><br>  One competent person assembled on the AVR microcontroller <a href="http://obruboff.ru/usb-volume-control-ver-2/">a volume control - a USB HID device that emulates a standard multimedia keyboard</a> (as suggested in the comments).  This keyboard has the ability to adjust the volume without additional software, all the necessary work is performed by the operating system driver. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/887/aaa/93f/887aaa93fb452a884fbf563f841ebca5.jpg" alt="image"><br><br>  [ <b>Links</b> ] <br><br>  <b>1</b> .  <a href="http://microsin.ru/content/view/1178/44/">USB console for controlling amateur radio devices</a> . <br>  <b>2</b>  <a href="http://chipenable.ru/index.php/library-for-iar.html">Here I found the code for the encoder</a> .  <a href="http://chipenable.ru/index.php/how-connection/9-encoder-avr.html">Here is the author's description of the algorithm</a> . <br>  <b>3</b>  <a href="http://www.codeproject.com/KB/audio-video/mixerSetControlDetails.aspx">Describes how to work with a sound card mixer via mixerSetControlDetails</a> . <br>  <b>4</b>  <a href="http://msdn.microsoft.com/en-us/library/ms810467.aspx">How to work with COM-port in Windows</a> . <br>  <b>5</b>  <a href="http://www.youtube.com/watch%3Fv%3D7_Jtani69kk">Video</a> showing the operation of the volume control. <br>  <b>6</b>  <a href="http://dfiles.ru/files/m0saic3d1">ENCODER DEMO project sources</a> (AVRStudio project and Visual Studio project). </div><p>Source: <a href="https://habr.com/ru/post/98005/">https://habr.com/ru/post/98005/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../97998/index.html">Memory management of the guest machine in the cloud</a></li>
<li><a href="../97999/index.html">New Kindle DX for $ 379</a></li>
<li><a href="../98000/index.html">From July 1 - duty-free import of goods up to 1000 euros (it was: 5-10 thousand rubles)</a></li>
<li><a href="../98001/index.html">Supercomputer problems in the middle lane</a></li>
<li><a href="../98003/index.html">Alan.Platform Tutorial (Part 1)</a></li>
<li><a href="../98006/index.html">Alan.Platform Tutorial (Part 2)</a></li>
<li><a href="../98010/index.html">Again about forms: default values</a></li>
<li><a href="../98013/index.html">Fractality Fractal Clock or Thoughts of Scale and Time</a></li>
<li><a href="../98014/index.html">Making a dystopian / cyberpunk mask</a></li>
<li><a href="../98016/index.html">Online consultant to the site through Jabber</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>