<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Centralized remote control control of lighting sources TsPKIO-2D Rotor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sorry, I have not had fun with naming for a long time, as well as with the periphery for home automation. Specifically, this thing - the remote contro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Centralized remote control control of lighting sources TsPKIO-2D Rotor</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/geektimes/post_images/72f/6a9/ceb/72f6a9ceb826b19cdb266c3d334da65b.jpg" alt="image"><br><br>  Sorry, I have not had fun with naming for a long time, as well as with the periphery for home automation.  Specifically, this thing - the remote control light - turned out, because I wanted something with an interface like "click-twist-click", and not with the usual scattering of buttons.  The wow effect is not achieved: the home ones do not notice the remote at close range, but at least I have closed the gestalt. <br><a name="habracut"></a><br>  Short TK: <br><br>  1) Control three lighting groups in the kitchen <br>  2) Control three groups of lighting in the room <br>  3) Control all light sources simultaneously <br>  4) Reasonable battery life (of the week) <br>  5) Compatibility with coding Livolo, SC2260, EV1527 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, you don‚Äôt need to read further if you don‚Äôt like Arduino, Livolo switches and Chinese radio sockets.  Because the first is the basis for the console, and the second and third is the periphery. <br><br><h2>  Concept </h2><br>  The control logic seemed to me the following: <br><br><ol><li>  Clicking on the "Krutilka" switches the zones of the lighting group around the ring (the kitchen - room - all). </li><li>  Turning the knob, depending on the direction of rotation, sequentially turns on or off the lighting of the selected group. </li><li>  The mode of operation (selected group) is displayed by an unobtrusive LED display. </li></ol><br>  Since I have radio control on the most despised option, without protection from interference and feedback, a small trick is also provided in case of a miss of a trigger. <br><br>  If turning the knob does not lead to the desired result, then the combined pressing and turning in the opposite direction allows you to skip the command.  Then the command can be repeated as usual. <br><br>  That is, if I turned the knob clockwise and the main light did not come on, then I can push the knob, turn it counterclockwise, and then release and turn it clockwise again to repeat the switch. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/V0ZpCxEb3-U" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Why so hard?  Then, besides awkward protocols, I also have awkward peripherals.  For example, Livolo radio-controlled light switches and radio relays, in which the same command to turn on and off, along with the usual radio rosettes, in which the commands to turn on and off are separate. <br><br>  The trick of skipping a team allows you to creatively beat non-power (non-power), without breaking the general scheme of illumination.  In addition, skipping a command allows you to jump over light sources that are not required to be turned on or off. <br><br>  And, of course, in order to understand what is happening with the console at all, it has a separate indicator, which is lit when a command is sent. <br><br>  If the console does not touch for some time (configured in the code), then the controller goes to sleep.  However, he does not save the last state, and when he wakes up by pressing the handle, he begins his life from scratch. <br><br>  It's not a mistake.  Again, I have switches without feedback, and the console is not physically able to obtain information about the current state of each controlled peripheral device. <br><br>  Therefore, immediately after waking up, turning the knob begins to either turn on or turn off the light from scratch. <br><br><h2>  First approach </h2><br>  The visual concept of the ‚Äúbox with a twist‚Äù view required, as you might guess, two things: the box and the twist.  In the first version, the role of the box was played by a thin powerbank, the use of which solved two problems at once: I had a case and a battery charging circuit, and already with a connector.  The battery itself, of course, had to be replaced with a more compact one, otherwise the filling would not fit. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/640/299/4df/6402994df7e71b82835d12f42541f1f0.jpg" alt="image"><br><br>  With the twister came out intricately.  In the course of the search, I found out that the nicer the potentiometer knob and the bigger it is, the closer its gram cost is to the gram gold value.  Therefore, I acquired a pen that minimally suited me for aesthetic properties. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/232/a3e/b60/232a3eb6074d6d8724fdc76d353274cc.jpg" alt="image"><br><br>  The control part was the result of an experiment with ATmega328P and a natural continuation of the storyline set by the already existing home automation (on the same Arduino and primitive radio protocols). <br><br>  I did not buy a lot of the above-mentioned controllers and conditionally layout (in fact, the adapter from the small case to the large step) boards to try to make a low-budget version of the Arduino with the minimum (but reasonable) number of elements. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/625/ebb/095/625ebb0959641911621741e00fb1b699.jpg" alt="image"><br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/be0/e1c/ac4/be0e1cac460246c56f97f0c45e1c8bc7.jpg" alt="image"><br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/53d/bc5/9f1/53dbc59f1bb9ec5583f84de546b2df76.jpg" alt="image"><br><br>  The experiment turned out to be successful, and the controller configured for the Arduino environment blinked with a LED quite successfully after swallowing the classic Blink.  Well, then according to the principle ‚Äúdoris owl‚Äù, I added an encoder (with a button), three LEDs, and a conventional transmitter with amplitude modulation on a carrier 433.92 MHz to the resulting board. <br><br>  To place all the elements in a small case, I had to suffer a little, but the remote still worked.  And although it would seem that the problem was solved, I wanted more - the original case. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/b0b/716/2cc/b0b7162cc2941009ef081f0f76e4a2a8.jpg" alt="image"><br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/36b/08b/c76/36b08bc76093a6b66fe3f5e1b3597b1a.jpg" alt="image"><br><br><h2>  Second approach </h2><br>  Actually, the first version (complaining) in appearance was a group of comrades smashed to smithereens, so I postponed it indefinitely.  But did not begin to disassemble: sorry. <br><br>  But when the 3D-printer appeared, he promised himself one day to make the very original case and thus close the issue with the remote control. <br><br>  I don‚Äôt know if it‚Äôs good or bad, I don‚Äôt really know how to evaluate my pieces.  But on 3DToday, the team is more welcoming than on MySKU (which I don‚Äôt complain about is not a gift myself), and they rated the body higher than I did. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/5a1/89d/905/5a189d905d402c93afba5e4f4d88c1da.jpg" alt="image"><br><br>  But having complete freedom of action, I refused the frail and vague Chinese batteries, and took the good old 18650 power source. And, as is easy to see, it is its dimensions that largely determine the dimensions of the whole case. <br><br>  The very same body I began to make modular, consisting of many parts, which allowed to reprint only individual (erroneous or not very optimal) elements, and not the whole product. <br><br>  Another point is that I really do not like to make cutouts for connectors, which I really do not get.  Therefore, in the supply chain there is another trick known for <a href="https://geektimes.ru/post/277730/">hedgehog Evelyn</a> : wireless charging. <br><br><img src="https://habrastorage.org/webt/ie/zq/6m/iezq6m_73cckmk6y-bidsohs9ye.jpeg"><br><br>  I had another receiver in the storeroom, which I immediately let go of the case. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/fDLqxxDvQhM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Finally, the last trick is rather obvious, but still: so that the console does not crawl on the table, I stuck a piece of non-slip car mat to the bottom.  And in the end, this thing is an absolute monolith, although rearranging it to another place is also not a problem. <br><br><h2>  What is required for repetition </h2><br><h3>  Piece of iron </h3><br>  1) ATmega328P controller - 1 pc.  (in my TQFP package, but any) <br>  2) 10 kŒ© resistor - 5 pcs.  (4 for suppressing encoder chatter, 1 for controller) <br>  3) Resistor 100 Ohm - 3 pcs. <br>  4) Ceramic capacitors 0.1 ŒºF - 4 pcs.  (on the controller and encoder chatter suppression) <br>  5) Pressure encoder (valcoder) - 1 pc.  (I have a <a href="https://static.chipdip.ru/lib/068/DOC000068637.pdf">PEC12-4220F-S0024</a> ) <br>  6) LEDs - 3 pcs.  (3 mm diameter) <br>  7) Lithium battery charging board - 1 pc.  (from the powerbank that came to hand, in theory, any one with automatic activation under load will do) <br>  8) Qi wireless charging receiver - 1 pc. <br>  9) Transmitter with amplitude modulation at 433 MHz - 1 pc.  ( <a href="https://www.aliexpress.com/item/1Lot-5-pair-10pcs-433Mhz-RF-transmitter-and-receiver-Module-link-kit-for-Arduino-ARM-MCU/32838898336.html">like this</a> ) <br>  10) Some fiberglass for the encoder board <br>  11) 3D printer <br>  12) Suitable plastic (I printed PLA) <br>  13) M4x30 screws - 4 pcs. <br><br>  In general, the number of components can be reduced.  For example, in a completely minimal version, the controller does not require a strapping at all, although I decided to follow the <a href="http://www.gammon.com.au/breadboard">advice of Nick Gammon</a> and did not regret a pair of capacitors and a resistor. <br><br>  Similarly, you can not bother with the hardware suppression of contact bounce, and try to do software.  Then you can cross out four more resistors and a pair of capacitors. <br><br>  Alternatively, you can use a ready-made Arduino board, like the Pro Mini, but in this case I cannot guarantee a low level of energy consumption, and you have to conjure it yourself.  At the same time it is necessary to correct the case. <br><br>  Scheme: <br><br><img src="https://habrastorage.org/webt/wo/xv/hh/woxvhhfaucpc3emhiyipfk56m1s.png"><br><br>  For reference, the ATmega328p pinout in the TQFP-32 package from <a href="http://www.hobbytronics.co.uk/arduino-atmega328-pinout">Hobby Electronics</a> : <br><br><img src="https://habrastorage.org/webt/1y/ea/sp/1yeasp0veriyrgvhrafu_inlwlm.jpeg"><br><br>  For my encoder, I drew a small fee: <br><br><img src="https://habrastorage.org/webt/i2/jg/d7/i2jgd7p7jlv1kyhbyjhoayd3d4k.jpeg"><br><br><img src="https://habrastorage.org/webt/ke/cr/yt/kecrytksno5yhwsjjdpcbwgc9-c.jpeg"><br><br><img src="https://habrastorage.org/webt/6y/vb/8j/6yvb8jl1h6zvpm-z-atgntumnsw.jpeg"><br><br>  For good, it would have to be drilled for mounting the encoder, or press it ‚Äúbelly-to-board (taking care of isolation so that there is no short circuit), so that the encoder is mounted a) more or less evenly and b) not loose.  Historically, I have the second option. <br><br>  For the case, it is important that the board height with details, excluding the encoder, be no more (or not much more) than 5 mm. <br><br><div class="spoiler">  <b class="spoiler_title">If you don‚Äôt have a ready-made Arduino board, then in order for it to work, you need to first write the Arduino bootloader to the ATmega328P controller.</b> <div class="spoiler_text">  To do this, you first need to add a description of the controller to the Arduino environment.  To do this, go <a href="https://www.arduino.cc/en/Tutorial/ArduinoToBreadboard">to the official website of Arduino</a> and download from there the archive of descriptions that is appropriate for your version of the environment ( <a href="">for 1.6</a> , <a href="">for 1.5</a> , <a href="">for 1.0</a> ). <br><br>  The contents of the archive should be extracted to the hardware folder of the Arduino environment folder.  In the future, I describe what is happening on the example of the environment 1.0.3, which I still use. <br><br>  When the descriptions are copied, you should launch Arduino and load the sketch of the programmer into the Arduino, which will be used as the programmer itself.  The sketch is in the menu File - Examples - ArduinoISP. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/037/517/98f/03751798f648adb8fea47a284a912667.jpg" alt="image"><br><br>  Of course, you should choose your fee and port.  I choose Mega, because I have it: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/7e7/483/4bd/7e74834bdd786979f926f4b65e2e344f.jpg" alt="image"><br><br>  After downloading the programmer sketch, you need to switch to the target board.  Those.  in our case, the ATmega328 with a frequency of 8 MHz and an internal master oscillator.  It will be on the list of boards if the descriptions mentioned above are copied correctly: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/b89/e98/7b2/b89e987b2243a79cc1d36e95d5a7ebab.jpg" alt="image"><br><br>  Now you need to connect the MISO, MOSI and SCK lines of the programming board and the board with the future Arduino, as well as connect the RESET, GND and VCC.  Plus, power is better in the last place. <br><br>  Based on the above infographics and descriptions of the Arduino Mega, the following picture emerges: <br><br>  SPI - Arduino Mega - ATmega328p <br><br>  MISO - 50 - 16 <br>  MOSI - 51 - 15 <br>  SCK - 52 - 17 <br>  SS (RESET) - 53 - 29 <br><br>  Physical connection to your taste, I used exclusively the barbaric method - the usual wire model directly into the holes of the board, without soldering and insulation: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/c14/df6/d5f/c14df6d5f4cdda937de81eb2fa555ee0.jpg" alt="image"><br><br>  If everything is ready - we write down the loader.  First, make sure that the correct programmer is selected (Service - Programmer - Arduino as ISP): <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/e0c/dc4/a0c/e0cdc4a0c8914fbed3f5328c676f0210.jpg" alt="image"><br><br>  Then we do the Service - Write the bootloader: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/568/21e/12f/56821e12f02cd705995d40429b15eec6.jpg" alt="image"><br></div></div><br>  After that, the output is a minimalist Arduino board, to load the skits into which you can use a USB-Serial adapter or a full-fledged Arduino board with such an adapter on board.  In the first case, you need to cross-connect the RX and TX, and do not forget to connect the common ground.  In the second case, you must additionally close the RESET Arduino to earth, which is used as an adapter. <br><br>  If you, like me, do not have an automatic controller reset circuit before loading the sketch, then there are two options: either pull its reset or just turn on its power when the Arduino environment writes about the start of loading. <br><br><h3>  Housing </h3><br>  The case, as I said, is modular.  This means that the plastic can be thrown onto the inner part hidden from the eyes, which is stale and no longer suitable.  You can wear electronics in it: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/030/0a3/251/0300a325144382295c6e3b8d54971e23.jpg" alt="image"><br><br>  I draw attention to the fact that the body is specific and designed to fit my version of the filling. <br><br>  I propose to make the rotor transparent so that it disperses the light of the indicators.  For greater weight, the M16 nut can be inserted inside the rotor: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/9a0/8ef/68e/9a08ef68e2a079da4af3ed1eb148e961.jpg" alt="image"><br><br>  Still need rotor shirt and cap to it.  The lid is simply inserted inside and held on to friction.  And, of course, can not do without the top and bottom of the outer case. <br><br>  I printed the rotor with a filling of 10%, the remaining elements - with a filling of 5%.  Plastic - PLA.  The set temperature of the nozzle on my printer is 200 on the first three layers, 185 on the following ones.  Unfortunately, I can not say what the true temperature of the nozzle.  The table is cold. <br><br>  The assembly is simple. <br><br><img src="https://habrastorage.org/webt/ka/cq/2-/kacq2-crn1cictkqxhpb0sok15u.jpeg"><br><br>  Boards are placed in the slots of the robust case, LEDs - with legs into the slots of the lower part of the robust case.  The transmitter antenna is displayed down, and the wireless charging receiver is also output down so that it is closer to that charge. <br><br><img src="https://habrastorage.org/webt/d9/zu/ex/d9zuextrjywuvjbj4ve68-c2rgg.png"><br><br>  The filling is fixed by an intermediate plate, in the groove of which the encoder wire harness passes. <br><br>  The encoder is fixed with the upper plate, and together it is tightened with screws M4x30, which themselves cut the threads in plastic. <br><br>  Now the rugged case can be enclosed in halves of the outer case  A rotor is put on the encoder shaft, and a shirt is attached to the rotor.  Optionally, a non-slip mat is glued to the bottom of the case.  Another option is a decorative insert that hides the seam between the body halves. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text">  In the code you need to set commands to turn on and off their peripheral devices.  Optionally - change auto-shutdown timeout. <br><br>  This is all located in the variables section. <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  : http://donalmorrissey.blogspot.ru/2010/04/sleeping-arduino-part-5-wake-up-via.html //  Livolo: http://forum.arduino.cc/index.php?action=dlattach;topic=153525.0;attach=108106 #include &lt;avr/sleep.h&gt; #include &lt;avr/power.h&gt; #include &lt;livolo.h&gt; #define adc_disable() (ADCSRA &amp;= ~(1&lt;&lt;ADEN)) // disable ADC (before power-off) #define adc_enable() (ADCSRA |= (1&lt;&lt;ADEN)) // re-enable ADC #define txPin 7 //   Livolo livolo(txPin); #define PULSESHORT 450 #define PULSELONG 1350 #define PULSESYNC 13950 #define encA 5 #define encB 6 //   #define buttonPin 2 //   () #define roomLed 10 //    #define kitchenLed 9 //    #define switchLed 3 //     #define switchLedTimeOut 150 //      #define switchTreshold 4 //      #define offDelay 15000 //   #define rLev 3 //     #define kLev 3 //     #define glev 2 //     #define txPowerPin 8 //    #define kitchenBackLightOn1 12 #define kitchenBackLightOn2 34 #define kitchenMainLightOn 56 #define roomBackLightOn 12 #define roomMainLightOn1 34 #define roomMainLightOn2 56 #define mainLightOn 12 #define kitchenBackLightOff1 12 #define kitchenBackLightOff2 34 #define kitchenMainLightOff 56 #define roomBackLightOff 12 #define roomMainLighOtff1 34 #define roomMainLightOff2 56 #define mainLightOff 12 #define LivoloID 8500 volatile byte rotorMode = 0; //   byte currentMode = 0; //    int curEncA, prevEncA, curButton, prevButton; //   ,  byte encCountPlus = 0; //   byte encCountMinus = 0; //   unsigned long offTimeOut = 0; //    unsigned long modeTimeOut = 0; //        unsigned long switchLedTime = 0; //      unsigned long modeTime = 0; //   unsigned int modeTreshold = 500; //     (  ) unsigned int bounceTreshold = 200; //     byte rLevState = 0; byte kLevState = 0; byte gLevState = 0; //   k - , r - , h - , b -  boolean kBackState = false; boolean kBackState1 = false; boolean kMainState = false; boolean rBackState = false; boolean rMainState = false; boolean rMainState1 = false; boolean hMainState = false; boolean bMainState = false; boolean afterSleep = false; //      boolean modeTimeOutStart = false; boolean switchLedOn = false; boolean allOn = false; //  " "    boolean allOff = false; //  " "    static void ookPulse(int on, int off) { digitalWrite(txPin, HIGH); delayMicroseconds(on); digitalWrite(txPin, LOW); delayMicroseconds(off); } static void rcSend(long remoteCode) { for (byte reSend = 0; reSend &lt; 8; reSend++) { for(byte repeat=0; repeat&lt;4; repeat++){ for (byte i = 24; i&gt;0; i--) { // transmit remoteID byte txPulse=bitRead(remoteCode, i-1); // read bits from remote ID // Serial.print(txPulse); switch (txPulse) { case 0: // 00 ookPulse(PULSESHORT,PULSELONG); //ookPulse(PULSESHORT,PULSELONG); break; case 1: // 11 ookPulse(PULSELONG,PULSESHORT); //ookPulse(PULSELONG,PULSESHORT); break; } // switch } // for loop ookPulse(PULSESHORT,PULSESYNC); // S(ync) // Serial.println(); } // repeat } delay(150); } void switchLedToggle() { digitalWrite(switchLed, HIGH); switchLedTime = millis(); switchLedOn = true; } void lightsUp(boolean lightsUpMode) { //       ""     //   "" -   if (afterSleep == true) { if (lightsUpMode == false) { gLevState = 1; rLevState = 3; kLevState = 3; } else {gLevState = 0; rLevState = 0; kLevState = 0; } afterSleep = false; //   " " } //   if (rotorMode == 2) { if (lightsUpMode == false){ if (allOff == false) { switchLedToggle(); if (digitalRead(buttonPin) == HIGH) { //   gLevState = 0; rLevState = 0; kLevState = 0; rcSend(kitchenBackLightOff1); rcSend(kitchenBackLightOff2); rcSend(roomBackLightOff); livolo.sendButton(LivoloID, mainLightOff); } allOff = true; allOn = false; } } if (lightsUpMode == true){ //  ,    if (allOn == false) { switchLedToggle(); if (digitalRead(buttonPin) == HIGH) { gLevState = 1; rLevState = 3; kLevState = 3; rcSend(kitchenBackLightOn1); rcSend(kitchenBackLightOn2); rcSend(roomBackLightOn); livolo.sendButton(LivoloID, mainLightOff); //    Livolo livolo.sendButton(LivoloID, kitchenMainLightOn); //#1   livolo.sendButton(LivoloID, roomMainLightOn1); // #2 livolo.sendButton(LivoloID, roomMainLightOn2); // #3 livolo.sendButton(LivoloID, mainLightOn); // #6 } allOn = true; allOff = false; } } } //  if (rotorMode == 1) { if (lightsUpMode == false &amp;&amp; kLevState &gt; 0) { switchLedToggle(); if (digitalRead(buttonPin) == HIGH) { if (kLevState == 3) { //   livolo.sendButton(LivoloID, kitchenMainLightOff); // #3 } if (kLevState == 2) { //   2 livolo.sendButton(LivoloID, kitchenBackLightOff2); // #6 } if (kLevState == 1) { //   1 rcSend(kitchenBackLightOff1); } } if (kLevState!=0) { kLevState--;} // Serial.println(kLevState); } if (lightsUpMode == true &amp;&amp; kLevState &lt; 3) { switchLedToggle(); kLevState++; if (digitalRead(buttonPin) == HIGH) { if (kLevState &gt; 3) {kLevState = 3;} // Serial.println(kLevState); if (kLevState == 1) { //   1 rcSend(kitchenBackLightOn1); } if (kLevState == 2) { //   2 livolo.sendButton(LivoloID, kitchenBackLightOn2); // #6 } if (kLevState == 3) { //   livolo.sendButton(LivoloID, kitchenMainLightOn); // #3 } } } } //  if (rotorMode == 0) { if (lightsUpMode == false &amp;&amp; rLevState &gt; 0) { switchLedToggle(); if (digitalRead(buttonPin) == HIGH) { if (rLevState == 3) { //  1 livolo.sendButton(LivoloID, roomMainLighOtff1); //#1 } if (rLevState == 2) { //   livolo.sendButton(LivoloID, roomMainLightOff2); // #2 } if (rLevState == 1) { //   rcSend(roomBackLightOff); } } if (rLevState != 0) { rLevState--; } } if (lightsUpMode == true &amp;&amp; rLevState &lt; 3) { switchLedToggle(); rLevState++; if (digitalRead(buttonPin) == HIGH) { if (rLevState == 1) { //   rcSend(roomBackLightOn); } if (rLevState == 2) { //   livolo.sendButton(LivoloID, roomMainLightOn1); //#1 } if (rLevState == 3) { //   1 livolo.sendButton(LivoloID, roomMainLightOn2); // #2 } } } } } void wakeUp() { detachInterrupt(0); } void setMode() { if (rotorMode &gt;= 2 ) { rotorMode = 0; } else { rotorMode++; } offTimeOut = millis(); } void ledBlink() { for (byte iLed = 0; iLed&lt;3; iLed++) { digitalWrite(kitchenLed, HIGH); digitalWrite(roomLed, HIGH); delay(100); digitalWrite(kitchenLed, LOW); digitalWrite(roomLed, LOW); delay(100); } } void setLed() { if (rotorMode == 0) { //  digitalWrite(roomLed, HIGH); digitalWrite(kitchenLed, LOW); } if (rotorMode == 1) { //  digitalWrite(roomLed, LOW); digitalWrite(kitchenLed, HIGH); } if (rotorMode == 2) { //    digitalWrite(roomLed, HIGH); digitalWrite(kitchenLed, HIGH); } } void enterSleep() { // ledBlink(); afterSleep = true; digitalWrite(txPin, LOW); digitalWrite(txPowerPin, LOW); digitalWrite(roomLed, LOW); digitalWrite(kitchenLed, LOW); digitalWrite(switchLed, LOW); pinMode(txPin, INPUT); pinMode(txPowerPin, INPUT); pinMode(roomLed, INPUT); pinMode(kitchenLed, INPUT); pinMode(switchLed, INPUT); attachInterrupt(0, wakeUp, LOW); adc_disable(); set_sleep_mode(SLEEP_MODE_PWR_DOWN); sleep_enable(); sleep_mode(); sleep_disable(); power_all_enable(); pinMode(txPin, OUTPUT); pinMode(txPowerPin, OUTPUT); pinMode(roomLed, OUTPUT); pinMode(kitchenLed, OUTPUT); pinMode(switchLed, OUTPUT); digitalWrite(txPin, LOW); digitalWrite(txPowerPin, HIGH); // ledBlink(); setLed(); offTimeOut = millis(); allOn = false; allOff = false; } void setup() { // Serial.begin(115200); pinMode(txPin, OUTPUT); pinMode(txPowerPin, OUTPUT); pinMode(roomLed, OUTPUT); pinMode(kitchenLed, OUTPUT); pinMode(switchLed, OUTPUT); digitalWrite(txPin, LOW); digitalWrite(txPowerPin, HIGH); digitalWrite(roomLed, LOW); digitalWrite(kitchenLed, LOW); digitalWrite(switchLed, LOW); // pinMode(buttonPin, INPUT_PULLUP); pinMode(buttonPin, INPUT); pinMode(encA, INPUT); pinMode(encB, INPUT); prevEncA = digitalRead(encA); offTimeOut = millis(); rotorMode = 0; setLed(); prevButton = digitalRead(buttonPin); } void loop() { if ((millis() - offTimeOut) &gt; offDelay) { enterSleep(); } else { //     if (switchLedOn == true) { if ((millis() - switchLedTime) &gt; switchLedTimeOut) { digitalWrite(switchLed, LOW); switchLedOn = false; } } //       if (digitalRead(buttonPin) == LOW) { offTimeOut = millis(); } //   curButton = digitalRead(buttonPin); if ((prevButton == HIGH) &amp;&amp; (curButton == LOW)) { if (modeTimeOutStart == false) { modeTimeOut = millis(); modeTimeOutStart = true; } } else { if (modeTimeOutStart == true) { modeTime = millis() - modeTimeOut; if ((modeTime &lt; modeTreshold) &amp;&amp; (modeTime &gt; bounceTreshold)) { setMode(); modeTimeOutStart = false; prevButton = digitalRead(buttonPin); } else { modeTimeOutStart = false; prevButton = digitalRead(buttonPin); } } } //    if (currentMode != rotorMode) { //       ,     currentMode = rotorMode; //     setLed(); } //   curEncA = digitalRead(encA); if ((prevEncA == LOW) &amp;&amp; (curEncA == HIGH)) { offTimeOut = millis(); if (digitalRead(encB) == LOW) { encCountMinus++; encCountPlus = 0; // Serial.println("Encoder Minus"); if (encCountMinus &gt; switchTreshold) { encCountMinus = 0; lightsUp(false); } } else { encCountPlus++; encCountMinus = 0; // Serial.println("Encoder Plus"); if (encCountPlus &gt; switchTreshold) { encCountPlus = 0; lightsUp(true); } } } prevEncA = curEncA; } }</span></span></code> </pre> <br></div></div><br>  Model housing <a href="http://3dtoday.ru/3d-models/khobbi/sdelay-sam/modulnyy_korpus_dlya_pulta_osveshcheniya/">by reference</a> . <br><br>  Everything. <br><br>  PS: I tried not to forget anything, but I could.  If so, I apologize and I will do my best to answer the leading questions correctly and correct mistakes. </div><p>Source: <a href="https://habr.com/ru/post/411093/">https://habr.com/ru/post/411093/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../411083/index.html">Sunset "Stars of Humanity"</a></li>
<li><a href="../411085/index.html">Pi-Sonos v3.0: work on the bugs or a completely new project?</a></li>
<li><a href="../411087/index.html">The nearest future of video cards</a></li>
<li><a href="../411089/index.html">How to identify a satellite in orbit</a></li>
<li><a href="../411091/index.html">Data Center Technologies: General Information on QFX Switches</a></li>
<li><a href="../411095/index.html">The Kepler telescope runs out of fuel. The final is near</a></li>
<li><a href="../411097/index.html">Standalone Mobile Messenger</a></li>
<li><a href="../411099/index.html">It is easy to estimate PPFD when the plant is illuminated with white LEDs: 1000 lx = 15 ¬µmol / s / m2</a></li>
<li><a href="../411101/index.html">Authorities in New York allowed to increase the cost of electricity for miners</a></li>
<li><a href="../411105/index.html">The effectiveness of courier drones will depend on where you live.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>