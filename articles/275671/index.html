<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>High-performance long polling chat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 There is a site on Laravel with real-time attendance of 700-1000 people. Previously, the site used third-party chat. He used WebSockets ....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>High-performance long polling chat</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/2c7/e26/1b5/2c7e261b55bfe77b7cdad6229cb0fe50.jpg" alt="image" align="right" width="250">  There is a site on <a href="https://ru.wikipedia.org/wiki/Laravel">Laravel</a> with real-time attendance of 700-1000 people.  Previously, the site used third-party chat.  He used <a href="https://ru.wikipedia.org/wiki/WebSocket">WebSockets</a> . <br><br>  Everything was fine, until one day the chat developer refused to support him due to the high load.  From that moment began the search for alternative chat systems ... <br><a name="habracut"></a><br><h5>  Technology selection </h5><br>  Many will say that now no one uses old browsers such as Opera12 or IE8, however, there are still quite a few such people, so it was decided to choose <i>Long Polling</i> . <br><br>  Initially, the site was hosted at <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B8%25D1%2580%25D1%2582%25D1%2583%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D1%2585%25D0%25BE%25D1%2581%25D1%2582%25D0%25B8%25D0%25BD%25D0%25B3">Shared hosting</a> , which was why there was a huge number of restrictions.  However, hosting managed the load.  It pleased.  And the only possible implementation of the chat was <a href="http://habrahabr.ru/post/128535/">long polling in PHP</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Implementation </h4><br><h5>  From words to deeds </h5><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/230/119/fa6/230119fa696095110df1df003666c009.gif" alt="image"></div><br><br>  The principle is clear and simple.  Ajax sends a request to the server, which reads the message.  The duration of the request, or rather the response from the server, depends on whether someone added a message.  That is, after the request, a cycle is started, which checks whether there are any new messages, and if there is a new message - the cycle is interrupted, the response is returned with a new message.  After receiving the response, the request is repeated.  And so on. <br><br>  Implementing such a thing in PHP is not much easier.  I spent on implementation in the amount of about 3 hours of my life. <br><br><h5>  Problems </h5><br>  However, he left it in the <a href="https://en.wikipedia.org/wiki/Minimum_viable_product">MVP (Minimum viable product)</a> stage.  And, as it turned out, for good reason.  When testing functionality on the production site simply fell.  RAM was filled in for 1-2 minutes and extinguished the server. <br><br>  Thinking a little, I decided that the matter is in the server.  And after some time the site was transferred to the <a href="https://ru.wikipedia.org/wiki/VPS">VPS</a> .  I have to say that the configuration is weak, and the RAM is only 1GB.  Nevertheless, the VPS chat held for 3-4 minutes.  Already better. <br><br>  In the end, after a long excavation of the Internet, I realized that writing a chat in PHP is pointless if the load on it will be more than 10 people. <br><br>  There are 2 options left: <br><br><ol><li>  <a href="https://ru.wikipedia.org/wiki/Node.js">Set nodeJS</a> and write chat on web sockets </li><li>  Write service on something else </li></ol><br>  And what do you think I chose?  Of course, the second option, otherwise I would not have written this article. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3c3/493/d69/3c3493d6997ff2d93dea3366c46ac78e.jpg" alt="image" align="left">  Since C ++ \ C implementations of server applications are not so many, all the more cross-platform, and all the more so since I am not strong in Ax, I chose <a href="https://ru.wikipedia.org/wiki/Lazarus">Lazarus</a> .  It is good that it has such a component as <i>FPHTTPServer</i> and an example application implementation. <br>  I‚Äôll also make a reservation that I don‚Äôt have Linux at hand.  All applications I do on Windows.  I was just sure that recompiling the application on another system is to spit.  After all, the same motto says!  <i>"Write once - compile everywhere!"</i> .  However, I managed it when there were 2 systems on my laptop (win7 + linux mint). <br><br>  Having compiled the application on win, I checked the functions locally.  Everything worked like a clock.  Nevertheless, it was a simple exe-schnick and I wanted something more - to write a normal service like <a href="https://ru.wikipedia.org/wiki/Apache">apache</a> .  Lazarus is not for you Delphi, although it is very similar.  Firstly, it is free, which automatically raises suspicion about the quality of the product.  And secondly, ... however, as well as thirdly and still the n-th number - all the inconveniences are associated with this.  Most of the questions on the Lazarus forum remain unanswered.  This is very sad.  As well as debugging an application with a pop-up error like ‚Äúuncatchable error‚Äù.  But, fortunately, at the end of the weekly period - I completed an analogue of the functionality that was written in PHP in 3 hours. <br><br>  Satisfied as an elephant, I decided to compile the application on Linux.  Logged in as root to the server and executing the apt-get-install lazarus command ‚Äî I quickly installed Lazarus, copied the sources, and, using the lazbuild -r project.lpi commands I‚Äôve discovered earlier on the Internet, I compiled the application.  It was the only, truly, most successful and fast stage. <br><br>  Having checked the work of the chat already on a real load, I realized that my idea was justified.  Chat worked, server load did not increase much.  It pleased.  Now I could go back to Windows and continue working on an improved version of the service (daemon).  As expected, everything worked out on Windows, albeit with a slight time delay. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e67/d7d/d3e/e67d7dd3ec1c163461aade4a1503a38e.jpg" alt="image" height="250"></div><br><br>  On Linux, the project did not compile.  When compiling, an error was issued stating that <i>Interfaces</i> unit was not found.  It was very strange.  At the forum, Lazarus did not receive a clear answer.  Many only wrote that when reinstalling everything worked.  However, reinstallation did not help.  In the end, I realized that my version of Lazarus is different from the one that stands on Linux.  Update the repository failed.  More precisely, the repository has been updated, but Lazarus remained the same version. <br><br>  Then I tried to download the installation package using wget.  As a result, error 177 came out (I don‚Äôt remember the exact number).  After the next outburst of emotions, I realized that the problem is in some symbol in the link.  I downloaded the installation package on MS OneDrive and created a short link, after which I successfully downloaded the file. <br><br>  Next, I deleted the old Lazarus and put a new version.  And what do you think the compiler reported?  Of course!  Incomprehensible mistakes! <br><br>  Relying on the past bitter experience with searching for answers on the Internet, I began to study the configs of lazarus.  The problem turned out to be simple - when installing, Lazarus for some reason did not create a new folder with configs.  Daddy remained from the previous version, although I deleted the old Lazarus using apt-get remove --purge.  Well, I saved the old configs, deleted the folder and again tried to recompile Lazarus IDE.  Magically, after that the configs folder was created and I was finally able to compile the daimon for linux. <br><br><h5>  Victory!  Or not? </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/a60/9c8/446/a609c84463b2fcaf9416d2cf3b43bec6.jpg" alt="image" align="right" height="400">  The service application was successfully compiled, but how to start it now? <br><br>  As one would expect, a simple script to create an entry in the service start ... did not work.  Moreover, I again found posts on the forum with my problem without an answer. <br><br>  Picked up another hour of internet, I found how to start the service using <i>start-stop-daemon</i> .  In the end, I realized that the startup script code that was laid out in the Lazarus examples works, but only if it is launched from the terminal.  Otherwise, he gave out something like "some file was not found." <br><br><h5>  The finish </h5><br>  The problem with starting / stopping the daimon through the <i>service</i> I have not decided.  Nevertheless, I was satisfied with the work done.  Moreover, the chat was able to withstand 1000 connections for 4 hours.  Unfortunately, the server configuration did not allow it to work longer.  However, I solved this problem with the help of the ‚Äúshow chat‚Äù button.  As a result, the load on the chat was given only by those users who really need it. </div><p>Source: <a href="https://habr.com/ru/post/275671/">https://habr.com/ru/post/275671/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275661/index.html">Fast and Furious Symfony + HHVM + MongoDB + CouchDB + Varnish</a></li>
<li><a href="../275663/index.html">What could be a stack of technologies for high-frequency trading</a></li>
<li><a href="../275665/index.html">How to monitor UPS ippon with NUT and Zabbix</a></li>
<li><a href="../275667/index.html">Analyzing Web Server Logs with GoAccess</a></li>
<li><a href="../275669/index.html">Kickstarter exit: how we failed</a></li>
<li><a href="../275673/index.html">Compilation: Over 800 resources for front-end developers</a></li>
<li><a href="../275675/index.html">QA: Conference invites speakers</a></li>
<li><a href="../275677/index.html">ABAP: Beautiful</a></li>
<li><a href="../275679/index.html">Can I make a game without an artist in 2 days? Devstory of my game Neobug Rush 2 Players</a></li>
<li><a href="../275685/index.html">Tips on how to write in C in 2016</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>