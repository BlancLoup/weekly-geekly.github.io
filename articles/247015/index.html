<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Write comparators correctly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Java, to introduce order among certain objects, you can write a comparator ‚Äî a class containing the compare function that compares two objects. An ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Write comparators correctly</h1><div class="post__text post__text-html js-mediator-article"> In Java, to introduce order among certain objects, you can write a comparator ‚Äî a class containing the <code>compare</code> function that compares two objects.  An alternative to the comparator is the natural order of the objects: the object implements the <code>Comparable</code> interface, which contains a <code>compareTo</code> method that allows you to compare this object with another.  The comparison function should return 0 if the objects are equal, a negative number (usually -1) if the first object is less than the second, and a positive number (usually 1) if the first is larger.  Typically, the implementation of such a function is not difficult, but there is one case that many people forget. <br><br>  Comparison is used by various algorithms from sorting and binary searching to maintaining order in sorted collections like <code>TreeMap</code> .  These algorithms are tied to three important properties of the comparison function: reflexivity (comparing an element with itself always gives 0), antisymmetry (comparing A with B and B with A should give a different sign) and transitivity (if comparing A with B and B with C gives the same sign, then the comparison of A with C should give the same).  If the comparing function does not satisfy these properties, the algorithm may produce a completely unpredictable result.  And most likely you will not get any exception, just the result will be incorrect. <br><br>  As it turned out, non-compliance with these properties is not such a rare situation.  The problem occurs when comparing real numbers - float or double. <br><a name="habracut"></a><br>  Suppose we have a class with a field of type double, and we want to order objects of this class depending on the value of the field.  Often you can find this code: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoubleHolder</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comparable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoubleHolder</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> d; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoubleHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> d)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.d = d; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compareTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DoubleHolder o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d &gt; od ? <span class="hljs-number"><span class="hljs-number">1</span></span> : d == od ? <span class="hljs-number"><span class="hljs-number">0</span></span> : -<span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.valueOf(d); } }</code> </pre> <br>  The compareTo method above has two problems.  The first is insignificant - it does not distinguish between +0.0 and -0.0: <code>new DoubleHolder(-0.0).compareTo(new DoubleHolder(+0.0))</code> returns 0. Sometimes it is not a bad thing, but in the case of sorting, elements with +0.0 and -0.0 will be located in an arbitrary order that will look ugly.  However, all this is minor compared to NaN.  The NaN number (in both double and float types) is a rather specific thing.  It is not more, not less and not equal to any other number.  As a result, we immediately get a violation of the properties of the comparison: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="java hljs">DoubleHolder nan = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoubleHolder(Double.NaN); DoubleHolder zero = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoubleHolder(<span class="hljs-number"><span class="hljs-number">0.0</span></span>); System.out.println(<span class="hljs-string"><span class="hljs-string">"nan.compareTo(nan): "</span></span>+nan.compareTo(nan)); System.out.println(<span class="hljs-string"><span class="hljs-string">"nan.compareTo(zero): "</span></span>+nan.compareTo(zero)); System.out.println(<span class="hljs-string"><span class="hljs-string">"zero.compareTo(nan): "</span></span>+zero.compareTo(nan));</code> </pre> <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>.compareTo(<span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>): <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>.compareTo(zero): <span class="hljs-number"><span class="hljs-number">-1</span></span> zero.compareTo(<span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>): <span class="hljs-number"><span class="hljs-number">-1</span></span></code> </pre> <br>  Neither reflexivity nor antisymmetry is observed.  You can also find such an implementation of comparison: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compareTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DoubleHolder o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d &gt; od ? <span class="hljs-number"><span class="hljs-number">1</span></span> : d &lt; od ? -<span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Here, all three previous comparisons will yield zero, that is, as if the properties are observed.  But, of course, it's too early to rejoice: <br><br><pre> <code class="java hljs">DoubleHolder nan = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoubleHolder(Double.NaN); DoubleHolder zero = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoubleHolder(<span class="hljs-number"><span class="hljs-number">0.0</span></span>); DoubleHolder one = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoubleHolder(<span class="hljs-number"><span class="hljs-number">1.0</span></span>); System.out.println(<span class="hljs-string"><span class="hljs-string">"zero.compareTo(nan): "</span></span>+zero.compareTo(nan)); System.out.println(<span class="hljs-string"><span class="hljs-string">"nan.compareTo(one): "</span></span>+nan.compareTo(one)); System.out.println(<span class="hljs-string"><span class="hljs-string">"zero.compareTo(one): "</span></span>+zero.compareTo(one));</code> </pre><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">zero</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.compareTo</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">nan</span></span>): 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">nan</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.compareTo</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">one</span></span>): 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">zero</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.compareTo</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">one</span></span>): <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span></code> </pre> <br>  Here transitivity is violated: the first object is equal to the second, the second is equal to the third, but the first to the third is not equal. <br><br>  What does it threaten a simple man in the street?  To understand this, create a simple list and try to mix and sort it several times: <br><pre> <code class="java hljs">List&lt;DoubleHolder&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>; i&lt;=<span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { data.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoubleHolder(i)); } data.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoubleHolder(Double.NaN)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { Collections.shuffle(data); Collections.sort(data); System.out.println(data); }</code> </pre> <br>  The output in each run is different and may look, for example, like this: <br><pre> <code class="hljs json">[NaN, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>] [NaN, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>] [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, NaN, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>] [NaN, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>] [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, NaN] [<span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, NaN, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>] [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, NaN, <span class="hljs-number"><span class="hljs-number">9.0</span></span>] [NaN, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>] [NaN, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>] [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, NaN, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>]</code> </pre> <br>  Or for the second implementation of <code>compareTo</code> : <br><pre> <code class="hljs json">[<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, NaN, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>] [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, NaN] [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, NaN] [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, NaN, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>] [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, NaN] [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, NaN] [<span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, NaN, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>] [<span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, NaN, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>] [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, NaN, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>] [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, NaN]</code> </pre> <br>  In about half of the cases, an element with NaN is nailed to the beginning or end of the list being sorted, and in other cases it begins to wander, spoiling the order of the surrounding elements. <br><br>  With collections using <code>DoubleHolder</code> as a key, nothing good will happen either.  Take, for example, the <code>TreeSet</code> .  With the second implementation of <code>compareTo</code> everything is quite simple: since an element containing NaN is equal to any other, it will not be possible to insert it into a non-empty set, because it decides that such an element already exists.  But beware if you insert the NaN element first: after that, it will not be possible to add anything else to the set. <br><br>  The first version of the comparison function is psychedelic.  For example, let's write this test: <br><pre> <code class="java hljs">Set&lt;DoubleHolder&gt; set = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TreeSet&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">50</span></span>; i++) { set.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoubleHolder( i%<span class="hljs-number"><span class="hljs-number">10</span></span>==<span class="hljs-number"><span class="hljs-number">0</span></span> ? Double.NaN : i%<span class="hljs-number"><span class="hljs-number">10</span></span> )); } System.out.println(set);</code> </pre> <br>  We inserted five elements containing NaN, and five elements containing each digit from 1 to 9. As a result, we have the following: <br><pre> <code class="hljs json">[NaN, NaN, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, NaN, NaN, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>, <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-number"><span class="hljs-number">7.0</span></span>, <span class="hljs-number"><span class="hljs-number">8.0</span></span>, <span class="hljs-number"><span class="hljs-number">9.0</span></span>, NaN]</code> </pre> <br>  It is quite expected to see NaN five times: they are not equal to each other.  But due to incorrect comparisons and some other elements were inserted several times.  You can see for yourself what happens to the TreeMap.  Note that one accidentally hit NaN can spoil the entire collection, and it is not always easy to debug it: the collection can exist for a long time in an incorrect state and pretend that everything is normal. <br><br>  Curiously, this problem should not exist at all.  Back in JDK 1.4, special static methods Float.compare and Double.compare appeared that will do everything for you, correctly processing special cases.  It is only necessary to write: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compareTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DoubleHolder o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Double.compare(d, od); }</code> </pre> <br>  Apparently, the deceptive simplicity of the comparison algorithm has an effect: sometimes a programmer believes that it is easier to write oneself than to search the documentation for the standard way to do it. <br><br>  Examples of incorrect double / float comparisons in various open source projects: <a href="">JTS</a> , <a href="">Batik</a> , <a href="">Hadoop</a> , <a href="">Hudson</a> , <a href="">ICU4J</a> , <a href="">Lucene</a> .  It is difficult to determine in which cases this may lead to problems, but this is the case when I would definitely correct: the correct and reliable option is usually also shorter than the wrong one. <br><br>  To change the situation, I <a href="https://code.google.com/p/findbugs/source/detail%3Fr%3Def65d4ee875d25690a5dcefbf34a1a7c378f1276">wrote a</a> small detector for FindBugs, which finds incorrectly implemented comparison functions and suggests using Float.compare/Double.compare. <br><br>  In general, for all primitive types there are similar methods.  If you need to compare several fields in turn, you can write this: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyObject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comparable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyObject</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> d; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; String s; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compareTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MyObject o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result; result = Double.compare(d, od); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(result != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; result = Integer.compare(i, oi); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(result != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; result = s.compareTo(os); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(result != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; result = Character.compare(c, oc); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre> <br>  It looks better than a bunch of branches with more and less.  And if you use <a href="http://habrahabr.ru/post/244347/">Guava</a> or something similar, then this: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compareTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MyObject o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ComparisonChain.start() .compare(d, od) .compare(i, oi) .compare(s, os) .compare(c, oc) .result(); }</code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/247015/">https://habr.com/ru/post/247015/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246997/index.html">New new thing (The new new thing)</a></li>
<li><a href="../246999/index.html">DOM is enough for everyone, or how to reconcile ReactJS with the fact that third-party libraries change its DOM</a></li>
<li><a href="../247003/index.html">Payler. Summing up 2014!</a></li>
<li><a href="../247005/index.html">Live code conference DevCon 2015</a></li>
<li><a href="../247013/index.html">Creation of the Ice Guard unit: from concept to 3D model</a></li>
<li><a href="../247017/index.html">Arduino programming in CLion</a></li>
<li><a href="../247019/index.html">Electronic Signature: Enterprise Practical Use of the CyberSafe Enterprise Software Product. Part one</a></li>
<li><a href="../247021/index.html">For those who failed to write plans</a></li>
<li><a href="../247023/index.html">Calculate CLV in the online store</a></li>
<li><a href="../247025/index.html">GDG DevFest Voronezh 2014: photo report and impressions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>