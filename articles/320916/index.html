<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to write curve queries with a non-optimal plan and make the DBMS think</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It's simple. Here you can find the "Basics of Query Analysis for Dummies" in the case of PostgreSQL and some wonderful non-fictional examples from pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to write curve queries with a non-optimal plan and make the DBMS think</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/9d6/d59/109/9d6d5910990445a089c5904186d60884.png" align="left">  It's simple.  Here you can find the "Basics of Query Analysis for Dummies" in the case of PostgreSQL and some wonderful non-fictional examples from production about how not to write queries on PostgreSQL and MySQL and what happens if you write them all the same. <br><br><a name="habracut"></a><br><br><h3>  Introduction </h3><br>  I will tell you about a few obvious things that are quite well described in mans and documentation, which is usually read after a dozen rakes, or after a certain number of limbs have been shot or after other self-harming. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There will be several parts, logically they are loosely connected with each other, but they all met in the course of solving various business needs and somehow satisfied its needs. <br><br><h3>  Nuances of work with </h3><br>  The very thing WITH, which is very similar to syntactic sugar without a large semantic load, is associated (with the uninitiated) with splitting a large footcloth into separate methods in the spirit of Martin and Fowler.  Here the main feature is that this is not an analogue of the method / function, especially when it comes to query optimization. <br><br>  Immediately I apologize to the reader, but later in the text there will be only pieces of requests that are of fundamental importance; requests will not be published in full.  First, in order not to bore with the features of the data structure, and second, so that I do not accidentally post something private corporate.  If the pieces are absolutely not readable, please do not hit hard, but suggest how to refine them.  Thank. <br><br>  How to do not. <br><br><div class="spoiler">  <b class="spoiler_title">The original sql piece from the main request body</b> <div class="spoiler_text"><pre><code class="sql hljs">LEFT JOIN specifications_history AS specification_history ON specification_history.id = specification_detail.entity_history_id AND specification_history.specification_id = ANY(specification_parts.ids) LEFT JOIN specification_revision_details AS specification_section_detail ON specification_section_detail.specification_revision_id = specification_revision.id AND specification_section_detail.entity_type = 1002 LEFT JOIN specification_sections_history AS specification_section_history ON specification_section_history.id = specification_section_detail.entity_history_id LEFT JOIN specification_revision_details AS section_item_detail ON section_item_detail.specification_revision_id = specification_revision.id AND section_item_detail.entity_type = 1003 LEFT JOIN section_items_history AS section_item_history ON section_item_history.id = section_item_detail.entity_history_id</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">'Refined' request piece</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> revision_products <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> specification_revision.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> revision_id, specification_history.specification_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> specification_id, section_item_history.product_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> product_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> specification_revisions <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> specification_revision <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> specification_revision_details <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> specification_detail <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> specification_detail.specification_revision_id = specification_revision.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> specification_detail.entity_type = <span class="hljs-number"><span class="hljs-number">1001</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> specifications_history <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> specification_histor <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> specification_history.id = specification_detail.entity_history_id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> specification_revision_details <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> specification_section_detail <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> specification_section_detail.specification_revision_id = specification_revision.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> specification_section_detail.entity_type = <span class="hljs-number"><span class="hljs-number">1002</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> specification_sections_history <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> specification_section_history <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> specification_section_history.id = specification_section_detail.entity_history_id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> specification_revision_details <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> section_item_detail <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> section_item_detail.specification_revision_id = specification_revision.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> section_item_detail.entity_type = <span class="hljs-number"><span class="hljs-number">1003</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> section_items_history <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> section_item_history <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> section_item_history.id = section_item_detail.entity_history_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> section_item_history.product_id <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> )</code> </pre><br></div></div><br>  Here the following happened: from the main request body, in which there were quite a few LEFT JOINs they were taken to WITH and turned into INNER JOIN.  The piece was given an euphonious name, so as to increase the readability of the main body, and all the details of the implementation dragged away.  Practice clean code at its best.  With readability, really, it became better.  In the main body of the request, there are 5 joins left instead of 10. Here, only the speed of the query execution immediately fell from 75 ms to 95 seconds.  Interesting things appeared in Explain: <br><br><pre> <code class="sql hljs"> -&gt; Unique (cost=796821.66..848031.33 rows=5120967 width=12) (actual time=80769.666..94946.622 rows=315260 loops=1) -&gt; Sort (cost=796821.66..809624.07 rows=5120967 width=12) (actual time=80769.663..90662.993 rows=37659600 loops=1) Sort Key: specification_revision_1.id, specification_history.specification_id, section_item_history.product_id Sort Method: external <span class="hljs-keyword"><span class="hljs-keyword">merge</span></span> Disk: <span class="hljs-number"><span class="hljs-number">809888</span></span>kB</code> </pre><br>  That is, someone took 37 lyam lines and began to sort them cheerfully in 1 gig of memory.  Then questions arose: <br><br><ul><li>  ‚ÄúBut where do we have 37kk lines, when is the 1.5kk in the largest table?‚Äù </li><li>  ‚ÄúWe didn‚Äôt change the algorithm, we just made the code readable, why did everything hang?‚Äù </li><li>  ‚ÄúHe is declarative, we said that we want, and how didn‚Äôt they say why it broke?‚Äù </li></ul><br>  <u>Answer</u> : transferring joins from the main body to WITH did exactly what is described in the <a href="https://www.postgresql.org/docs/9.5/static/queries-with.html">documentation</a> : <br><br><div class="spoiler">  <b class="spoiler_title">WITH Queries (Common Table Expressions)</b> <div class="spoiler_text">  If you are looking for a query, even if you have been a query or sibling.  It is an expensive way to get redundant work.  It is possible to prevent unwanted multiple evaluations with side-effects.  However, it‚Äôs not a problem.  It would be possible to appreciate that it would be possible to discard afterwards.  (If you can use only the limited number of rows.) <br></div></div><br>  Briefly and roughly: requests from WITH are executed once and, more often, not optimized, that is, the place of their use does not affect the execution plan. <br><br>  That is, we leveled a piece of the request to the level of an independent part, forgetting to add to it the important conditions from WHERE, which cut back the selection for most tomatoes.  As a result, the entire base was crossed, and then they gave this monster to the main body, where they took a dozen lines from it. <br><br>  In the specific case described above, WHERE had a condition of the form ‚Äúproduct_id = 1234‚Äù, which set the main constraint on the data.  If this condition were dragged into WITH, then everything would continue to work at about the same speed.  However, this can only be done in the case of a static value for the right side of the condition.  If aidishs are obtained, for example, during a recursive query, then in WITH such a condition cannot be dragged off and the idea of ‚Äã‚Äãsplitting the query into pieces will shamelessly slow down. <br><br>  <u>Conclusion</u> : <br><br><ul><li>  need to read the documentation; </li><li>  Not all development practices are equally useful in different areas of this development. </li></ul><br><h3>  Visualize explain </h3><br>  I think everyone is aware of <a href="https://explain.depesz.com/">explain.depesz.com</a> .  They beautifully show what is wrong with the request. <br><br><img src="https://habrastorage.org/files/413/eb9/ba2/413eb9ba268e44a5a3558489122b5b9e.png"><br><br>  In fact, this is just a coloring for the default output of the explain command, but this is very clear and especially helps at the beginning, until you know what to look at ... although it‚Äôs nice and convenient to lie and not at the beginning. <br><br>  Here I would like to say a few words for each of the columns and explain how they affect the outcome of the implementation.  Yes, it is written there in the <a href="https://explain.depesz.com/help">help</a> , but rarely does anyone read the help until it is secure. <br><br><ul><li>  # - just the sequence number of the operation during the execution of the request </li><li>  Exclusive - time to perform a specific operation (in milliseconds) </li><li>  Inclusive - time to execute the entire command pipeline (for example, in the picture above, to perform uniq, you need to sort at least) </li><li>  Rows X - how long <s>Akella</s> missed the planner when he vangal the number of rows that the operation should return (yes, this is important for later decisions about how to proceed with the query) </li></ul><br><h3>  Tips for novice optimizers </h3><br>  If everything slows down and do not know where to start, then here are a couple of tips.  You need to take a colored explain (preferably along with analyze) from the previous paragraph and look at it.  Most often, the problem (read, 80% + runtime) is concentrated in one of the operations described in the execution plan.  That is, by Exclusive / Inclusive to find the darkest and dumb place.  Again, in the example above, it is clear that the uniq operation lasts 94 seconds out of a total of 95 seconds for which the request is executed.  In the same place we see that in uniq almost all the time is occupied by sort, which lasts 90 seconds.  Here you can see the problem in the form of the number of rows, the sorting algorithm and the memory used.  It remains nothing: to understand "who is to blame and what to do."  Here, only knowledge of the target database's data structure and the requirements for the query results will help.  It may be enough to rearrange a couple of lines or add an additional condition, or it may be necessary to completely rewrite the request, since in its original form the only thing it can do well is to slow down. <br><br>  It is also worth paying attention to the big ‚ÄúRows X‚Äù.  This indicates a miss of the predicted and actual results of the sample and, most often, due to the lack of statistics on the tables.  This can lead to a non-optimal query execution plan.  For example: we want to select one row from a table with 1 million items;  if the planner decides that the result of the sample will not be 1 line, but ~ 200,000, then it will not search by index, but go full scan, since this is the optimal strategy for such a ratio of the resulting lines and table size.  Conclusions about the speed do yourself. <br><br><h3>  Standard rake </h3><br>  Here's what happened most often in practice and what caused the indecent behavior of requests: <br><br><ul><li>  misunderstanding of the data structure and data joining through unknown detours and detours, or, better yet, joining unnecessary data;  the extreme case was in MySQL;  Here is a slightly lightweight example that conveys the essence of the problem: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ordered_products.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> products, products <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ordered_products <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ordered_products.id</code> </pre> <br>  On the one hand, they simply indicated an extra table inside the FROM and did not use it at all.  On the other hand, we got an implicit connection of two tables through a CROSS JOIN and <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>N</mi><mn>2</mn></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.177ex" height="2.419ex" viewBox="0 -935.7 1368 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/320916/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjPPYQgQaWBLsi7G4YGpotpKIuxqQ#MJMATHI-4E" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/320916/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjPPYQgQaWBLsi7G4YGpotpKIuxqQ#MJMAIN-32" x="1292" y="513"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>N</mi><mn>2</mn></msup></math></span></span><script type="math/tex" id="MathJax-Element-1"> N ^ 2 </script>  resulting rows (relevant for at least MySQL 5.5).  In my case, the products table was 40k rows, but I did not wait for the end of the query.  As far as I know, Oracle can do <a href="https://habrahabr.ru/post/248817/">join elimination</a> , but, in any case, it's better not to rely on DBMS features, but to think with your head. <br><br><div class="spoiler">  <b class="spoiler_title">Bonus: how to do it in ActiveRecord and hang everything</b> <div class="spoiler_text"><pre> <code class="ruby hljs">Product.joins(<span class="hljs-string"><span class="hljs-string">", (</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{Product.table_name}</span></span></span><span class="hljs-string">) AS ordered_products"</span></span>). select(<span class="hljs-string"><span class="hljs-string">'ordered_products.*'</span></span>). group(<span class="hljs-string"><span class="hljs-string">"ordered_products.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{Product.primary_key}</span></span></span><span class="hljs-string">"</span></span>)</code> </pre><br></div></div><br></li><li>  Love for outer joins.  They generate, at a minimum, the geometric growth of rows in intermediate results and it may easily turn out that on some input data the query will slow down and the DBMS will drown on the amount of data.  An extreme example was on the query mentioned above on the test (which is with WITH).  It worked fine with a strict restriction on product_id.  The same query worked well with an array of 5-15 ID and the query execution time grew linearly, but then, each following ID in the array increased the query execution time by 2-3 times.  The problem was just in the OUTER JOIN set, which multiplicatively increased the number of rows processed and, from some point onwards, their number became outrageously large, and the execution plan could not be shown to underage developers. <br><br></li><li>  In the continuation of the previous paragraph: some people like to put FULL OUTER JOIN instead of LEFT / RIGHT, which is enough in the overwhelming majority of cases (tested on the inhabitants of the habr, with whom they discussed the request from the previous <a href="https://habrahabr.ru/post/314654/">article about interviews</a> ).  The problem is the same: generating extra data and increasing resource consumption.  From a personal one: FULL OUTER JOIN recently really needed production for the first time in 2 years ... was happy like a child. <br><br></li><li>  Wonderful magic with functions, for example, from PostgreSQL, when instead of a pair of joins in declarative style, they try to do the same, but in the imperative style through arrays and other data structures, together with the functions that transform them.  Example, unfortunately, I will not find, so I have to take my word for it.  I only remember that such things occasionally flash on <a href="http://stackoverflow.com/">stackoverflow</a> .  The only good news is that they almost never get the leaders on likes. </li></ul><br><h3>  the end </h3><br>  Thanks to all.  If you have your own wonderful examples of how not to do it, then please don't be silent, there are not many ‚Äúbad advice‚Äù and ‚Äúliving examples‚Äù.  And the article is, like the exam ticket, just a reason to talk. </div><p>Source: <a href="https://habr.com/ru/post/320916/">https://habr.com/ru/post/320916/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320900/index.html">Configuring the DNS server for North Korean security standards</a></li>
<li><a href="../320902/index.html">How we prepared the redis cluster</a></li>
<li><a href="../320904/index.html">Petersburg IT exports underestimated by a large amount</a></li>
<li><a href="../320906/index.html">Yii 2.0.11</a></li>
<li><a href="../320908/index.html">Trends 2016 and 2017 in the Japanese mobile industry</a></li>
<li><a href="../320918/index.html">Configure Let's Encrypt on Microsoft Azure</a></li>
<li><a href="../320920/index.html">Another look at the development of applications for smart TV</a></li>
<li><a href="../320922/index.html">Target as an antidepressant</a></li>
<li><a href="../320924/index.html">PushAll Auth - user authentication and feedback</a></li>
<li><a href="../320926/index.html">Create anamorphic distortion in Unity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>