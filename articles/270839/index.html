<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Class Requests at InterSystems Cach√©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 InterSystems Cach√© Class Requests is a useful tool used to abstract from SQL queries directly in COS code. In the simplest case, it loo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Class Requests at InterSystems Cach√©</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/intersystems/blog/270839/"><img width="30%" height="30%" alt="Andre Derain Landscape ear Chatou" title="Andre Derain Landscape ear Chatou" src="https://habrastorage.org/files/6d1/79d/221/6d179d22140445c3b69f87ed0f4fbf32.jpg" align="left"></a> <h2>  Introduction </h2><br>  InterSystems Cach√© <a href="">Class Requests</a> is a useful tool used to abstract from SQL queries directly in COS code.  In the simplest case, it looks like this: suppose you use the same SQL query in several places, but with different arguments. <br><br>  In order not to write it every time, you can designate the text of the query as a query of the class and subsequently refer to this query by its name.  And then there are custom queries in which you write the logic for obtaining the next line of results yourself.  Under the cut, I will talk about how this all can be used. <br><a name="habracut"></a><br><br><h2>  Basic Class Requests </h2><br>  So basic class queries are a method for representing SELECT SQL queries.  They are processed by the optimizer and the SQL compiler, as well as ordinary SQL queries, but they are easier to call from the COS context.  In the class definition, these are elements of the Query type (similarly, for example, Method or Property).  They are defined as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Type - <a href="">% SQLQuery</a> </li><li>  In the argument list, list the SQL query argument list. </li><li>  Request Type - SELECT </li><li>  The argument is accessed with a colon (similar to static SQL) </li><li>  Define the ROWSPEC parameter - it contains information about the names and data types of the returned results, as well as the order of the fields </li><li>  (Optional) Determine the parameter CONTAINID; it is equal to the sequence number of the field containing Id.  If Id is not returned, it is not necessary to specify CONTAINID </li><li>  (Optional) Define the COMPILEMODE parameter.  It is similar to the same parameter in static SQL and determines when the SQL expression is compiled.  If equal to IMMEDIATE (the default), then compilation occurs during class compilation.  If equal to DYNAMIC, then compilation occurs before the first execution of the query, similar to dynamic SQL </li><li>  (Optional) Define the parameter SELECTMODE - declaration of the format of the query results </li><li>  Add the SqlProc property if you want to call this query as an SQL procedure </li><li>  Set the SqlName property if you want to rename the query.  Default query name in SQL context: PackageName.ClassName_QueryName </li><li>  Cach√© Studio provides a class query wizard </li></ul><br><div class="spoiler">  <b class="spoiler_title">An example of defining the class Sample.Person with a ByName query that returns all people whose names begin with a specific letter.</b> <div class="spoiler_text">  <font color="#000080">Class Sample.Person Extends% Persistent</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000080">Property</font> <font color="#000000">Name</font> <font color="#000080">As% String</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">Property</font> <font color="#000000">DOB</font> <font color="#000080">As% Date</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">Property</font> <font color="#000000">SSN</font> <font color="#000080">As% String</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">Query</font> <font color="#000000">ByName (</font> <font color="#ff00ff">name</font> <font color="#000080">As% String</font> <font color="#000000">=</font> <font color="#800080">""</font> <font color="#000000">)</font> <font color="#000080">As% SQLQuery</font> <font color="#000080"><br></font>  <font color="#000000">(</font> <font color="#000080">ROWSPEC</font> <font color="#000000">=</font> <font color="#800080">"ID:% Integer, Name:% String, DOB:% Date, SSN:% String"</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#000080">CONTAINID</font> <font color="#000000">=</font> <font color="#000080">1</font> <font color="#000000">,</font> <font color="#000080">SELECTMODE</font> <font color="#000000">=</font> <font color="#800080">"RUNTIME"</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#000080">COMPILEMODE</font> <font color="#000000">=</font> <font color="#800080">"IMMEDIATE"</font> <font color="#000000">) [</font> <font color="#000080">SqlName</font> <font color="#000000">=</font> <font color="#008000">SP_Sample_By_Name</font> <font color="#000000">,</font> <font color="#000080">SqlProc</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">SELECT</font> <font color="#008000">ID</font> <font color="#000000">,</font> <font color="#008000">Name</font> <font color="#000000">,</font> <font color="#008000">DOB</font> <font color="#000000">,</font> <font color="#008000">SSN</font> <font color="#008000"><br></font>  <font color="#000080">FROM</font> <font color="#008000">Sample</font> <font color="#000000">.</font>  <font color="#008000">Person</font> <font color="#008000"><br></font>  <font color="#000080">WHERE</font> <font color="#000000">(</font> <font color="#008000">Name</font> <font color="#000000">% STARTSWITH</font> <font color="#800000">: name</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#000080">ORDER BY</font> <font color="#008000">Name</font> <font color="#008000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000000">}</font> </div></div><br>  You can use this query from the COS context as follows: <br><br><blockquote>  <font color="#0000ff">Set</font> <font color="#800000">statement</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% SQL.Statement</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">status</font> <font color="#000000">=</font> <font color="#800000">statement</font> <font color="#000000">.</font>  <font color="#0000ff">% PrepareClassQuery</font> <font color="#000000">(</font> <font color="#008000">"Sample.Person"</font> <font color="#000000">,</font> <font color="#008000">"ByName"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">If $$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">status</font> <font color="#000000">)</font> <font color="#800080">{</font> <font color="#0000ff">Do $ system</font> <font color="#008080">.OBJ</font> <font color="#000000">.</font>  <font color="#0000ff">DisplayError</font> <font color="#000000">(</font> <font color="#800000">status</font> <font color="#000000">)</font> <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">resultset</font> <font color="#000000">=</font> <font color="#800000">statement</font> <font color="#000000">.</font>  <font color="#0000ff">% Execute</font> <font color="#000000">(</font> <font color="#008000">"A"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">While</font> <font color="#800000">resultset</font> <font color="#000000">.</font>  <font color="#0000ff">% Next</font> <font color="#000000">()</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Write</font> <font color="#000000">!,</font> <font color="#800000">Resultset</font> <font color="#000000">.</font>  <font color="#0000ff">% Get</font> <font color="#000000">(</font> <font color="#008000">"name"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> </blockquote><br>  Or immediately get the resultset using the generated queryNameFunc method: <br><br><blockquote>  <font color="#0000ff">Set</font> <font color="#800000">resultset</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">Sample.Person</font> <font color="#000000">).</font>  <font color="#0000ff">ByNameFunc</font> <font color="#000000">(</font> <font color="#008000">"A"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">While</font> <font color="#800000">resultset</font> <font color="#000000">.</font>  <font color="#0000ff">% Next</font> <font color="#000000">()</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Write</font> <font color="#000000">!,</font> <font color="#800000">Resultset</font> <font color="#000000">.</font>  <font color="#0000ff">% Get</font> <font color="#000000">(</font> <font color="#008000">"name"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> </blockquote><br><br>  In addition, this query can be called from the SQL context in two ways: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Call</span></span> Sample.SP_Sample_By_Name(<span class="hljs-string"><span class="hljs-string">'A'</span></span>)</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Sample.SP_Sample_By_Name(<span class="hljs-string"><span class="hljs-string">'A'</span></span>)</code> </pre> <br>  This class can be found in the SAMPLES area that comes with the delivery of Cach√©.  That's all about simple queries.  We now turn to custom queries. <br><br><h2>  Custom Class Requests </h2><br>  Basic class queries are sufficient for most situations.  However, there are cases in which your application needs complete control over the behavior of the request, in particular: <br><br><ul><li>  The complex logic of determining which records should fall into the result.  Since in a custom query method that gives the following query result, you write yourself on COS, then this logic can be arbitrarily complex </li><li>  If you access data through an API whose format does not suit you </li><li>  If the data is stored in globala, without classes </li><li>  If access to data requires escalation of rights </li><li>  If you need to request an external API to access the data </li><li>  If access to the data requires access to the file system </li><li>  Any additional operations are required before executing the request itself (establishing a connection, checking rights, etc.) </li></ul><br>  So, how are custom class requests written?  To create a queryName query, you define 4 methods that implement all the logic of the query, from creation to destruction: <br><br><ul><li>  queryName - similar to the base class query, provides information about the query </li><li>  queryName <b>Execute</b> - initial request instantiation </li><li>  queryName <b>Fetch</b> - gets the following result </li><li>  queryName <b>Close</b> - query destructor </li></ul><br>  Now about these methods in more detail. <br><br><h3>  QueryName method </h3><br>  The queryName method provides information about the request. <br><br><ul><li>  Type -% Query </li><li>  Leave definition empty </li><li>  Define the ROWSPEC parameter - it contains information about the names and data types of the returned results, as well as the order of the fields </li><li>  (Optional) Determine the parameter CONTAINID; it is equal to the sequence number of the field containing Id.  If Id is not returned, it is not necessary to specify CONTAINID </li></ul><br>  As an example, we will create an AllRecords query (those. QueryName = AllRecords, and the method will be called simply AllRecords), which will in turn produce all the records of the stored class. <br><br>  First, create a new stored class Utils.CustomQuery: <br><br><blockquote>  <font color="#000080">Class Utils.CustomQuery Extends</font> <font color="#000000">(</font> <font color="#000080">% Persistent</font> <font color="#000000">,</font> <font color="#000080">% Populate</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000080">Property</font> <font color="#000000">Prop1</font> <font color="#000080">As% String</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">Property</font> <font color="#000000">Prop2</font> <font color="#000080">As% Integer</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000000">}</font> </blockquote><br>  Now we‚Äôll write a description of the AllRecords request: <br><br><blockquote>  <font color="#000080">Query</font> <font color="#000000">AllRecords ()</font> <font color="#000080">As% Query</font> <font color="#000000">(</font> <font color="#000080">CONTAINID</font> <font color="#000000">=</font> <font color="#000080">1</font> <font color="#000000">,</font> <font color="#000080">ROWSPEC</font> <font color="#000000">=</font> <font color="#800080">"Id:% String, Prop1:% String, Prop2:% Integer"</font> <font color="#000000">) [</font> <font color="#000080">SqlName</font> <font color="#000000">=</font> <font color="#008000">AllRecords</font> <font color="#000000">,</font> <font color="#000080">SqlProc</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font> </blockquote><br><h3>  QueryNameExecute method </h3><br>  The queryNameExecute method performs all the necessary query initialization.  It should have the following signature: <br><br><blockquote>  <font color="#000080">ClassMethod</font> <font color="#000000">queryNameExecute (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">,</font> <font color="#ff00ff">args</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font> </blockquote><br>  Where: <br><br><ul><li>  qHandle is used to communicate with other methods of query implementation </li><li>  This method should bring qHandle to the state that the queryNameFetch method takes as input. </li><li>  qHandle can take the values ‚Äã‚Äãof OREF, variable or multidimensional variable </li><li>  args are optional parameters passed to the query.  They can be arbitrarily many or not at all </li><li>  Return the request initialization status </li></ul><br>  Let's return to our example.  There are many options for circumventing an extent (the main approaches to organizing custom queries will be described later), I suggest using global circumvention using the <a href="">$ Order</a> function.  qHandle will respectively store the current Id, in this case the empty string.  arg is not used, since no additional arguments are needed.  The result is: <br><br><blockquote>  <font color="#000080">ClassMethod</font> <font color="#000000">AllRecordsExecute (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">qHandle</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font> </blockquote><br><h3>  QueryNameFetch method </h3><br>  The queryNameFetch method returns one result in <a href="">$ List</a> format.  It should have the following signature: <br><br><blockquote>  <font color="#000080">ClassMethod</font> <font color="#000000">queryNameFetch (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#000080">ByRef</font> <font color="#ff00ff">Row</font> <font color="#000080">As% List</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#000080">ByRef</font> <font color="#ff00ff">AtEnd</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">PlaceAfter</font> <font color="#000000">= queryNameExecute]</font> <font color="#000000"><br></font> </blockquote><br>  Where: <br><br><ul><li>  qHandle is used to communicate with other methods of query implementation </li><li>  When executing a query, qHandle accepts the values ‚Äã‚Äãset by queryNameExecute or by previous calling queryNameFetch </li><li>  Row must accept either a value in the <a href="">% List</a> format, or it must be equal to an empty string if there is no more data </li><li>  AtEnd must be 1 when the end of the data is reached. </li><li>  The PlaceAfter keyword determines the position of the method in the int code (there is <a href="http://habrahabr.ru/company/intersystems/blog/258081/">an article</a> about compiling and generating int code), the Fetch method should be located after the Execute method, this is important only when using <a href="">static SQL</a> , or rather <a href="">cursors</a> inside the query. </li></ul><br>  Inside this method, in general, the following operations are performed: <br><br><ol><li>  Determine whether the end of the data is reached. </li><li>  If the data is still there: Create% List and set the value of the Row variable </li><li>  Otherwise, set AtEnd to 1 </li><li>  Install qHandle for subsequent calls </li><li>  We return the status </li></ol><br>  In our example, it will look like this: <br><br><blockquote>  <font color="#000080">ClassMethod</font> <font color="#000000">AllRecordsFetch (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">Row</font> <font color="#000080">As% List</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">AtEnd</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#008000">#;</font>  <font color="#008000">Go around the global ^ Utils.CustomQueryD</font> <font color="#008000"><br></font>  <font color="#008000">#;</font>  <font color="#008000">Write the next id in qHandle, and the global value with the new id in val</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">qHandle</font> <font color="#000000">=</font> <font color="#0000ff">$ Order</font> <font color="#000000">(^ Utils.CustomQueryD (</font> <font color="#800000">qHandle</font> <font color="#000000">), 1,</font> <font color="#800000">val</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#008000">#;</font>  <font color="#008000">Check whether the data has reached the end</font> <font color="#008000"><br></font>  <font color="#0000ff">If</font> <font color="#800000">qHandle</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">AtEnd</font> <font color="#000000">= 1</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">Row</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#008000">#;</font>  <font color="#008000">If not, form% List</font> <font color="#008000"><br></font>  <font color="#008000">#;</font>  <font color="#008000">val = $ Lb ("", Prop1, Prop2) - see Storage Definition</font> <font color="#008000"><br></font>  <font color="#008000">#;</font>  <font color="#008000">Row = $ Lb (Id, Prop1, Prop2) - see the AllRecords ROWSPEC request</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">Row</font> <font color="#000000">=</font> <font color="#0000ff">$ Lb</font> <font color="#000000">(</font> <font color="#800000">qHandle</font> <font color="#000000">,</font> <font color="#0000ff">$ Lg</font> <font color="#000000">(</font> <font color="#800000">val</font> <font color="#000000">, 2),</font> <font color="#0000ff">$ Lg</font> <font color="#000000">(</font> <font color="#800000">val</font> <font color="#000000">, 3))</font> <font color="#000000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font> </blockquote><br><h3>  QueryNameClose method </h3><br>  The queryNameClose method terminates with a query after all data has been received.  It should have the following signature: <br><br><blockquote>  <font color="#000080">ClassMethod</font> <font color="#000000">queryNameClose (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">PlaceAfter</font> = queryNameFetch] <br></blockquote><br>  Where: <br><br><ul><li>  Cach√© performs this method after the last call to the queryNameFetch method. </li><li>  This method is a request destructor. </li><li>  In the implementation of this method, close the used SQL cursors, queries, delete local variables. </li><li>  Method returns status </li></ul><br>  In our example, you need to delete the local variable qHandle: <br><br><blockquote>  <font color="#000080">ClassMethod</font> <font color="#000000">AllRecordsClose (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">Kill</font> <font color="#800000">qhandle</font> <font color="#800000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  } <br></blockquote><br>  That's all.  After compiling the class, the AllRecords query can be used in the same way as the basic class queries ‚Äî using% SQL.Statement. <br><br><h2>  Custom query logic </h2><br>  So, how can you organize custom query logic?  There are 3 main approaches: <br><br><ul><li>  <a href="">Global traversal</a> </li><li>  <a href="">Static SQL</a> </li><li>  <a href="">Dynamic SQL</a> </li></ul><br><h3>  Global traversal </h3><br>  The approach is to use the $ Order function and the like to traverse the global.  It should be used in cases where: <br><br><ul><li>  The data is stored in globala, without classes </li><li>  It is necessary to reduce the number of gloref - calls to globals </li><li>  Results must / can be sorted by global key. </li></ul><br><h3>  Static SQL </h3><br>  The approach is to use cursors and static SQL.  This can be done in order to: <br><br><ul><li>  Simplify reading int code </li><li>  Simplify working with cursors </li><li>  Reduce compile time (static SQL is rendered in the class query and is compiled only once) </li></ul><br>  Features: <br><br><ul><li>  Cursors generated from queries of type% SQLQuery are automatically named, for example, Q14 </li><li>  All cursors used within a class must have different names. </li><li>  Error messages refer to internal cursor names that have an extra character at the end of the name.  For example, an error in the cursor Q140 most likely refers to the cursor Q14 </li><li>  Use PlaceAfter and make sure that the declaration and use of the cursor occur in one int program. </li><li>  INTO must be placed with FETCH, not with DECLARE </li></ul><br><div class="spoiler">  <b class="spoiler_title">An example using static SQL for Utils.CustomQuery</b> <div class="spoiler_text">  <font color="#000080">Query</font> <font color="#000000">AllStatic ()</font> <font color="#000080">As% Query</font> <font color="#000000">(</font> <font color="#000080">CONTAINID</font> <font color="#000000">=</font> <font color="#000080">1</font> <font color="#000000">,</font> <font color="#000080">ROWSPEC</font> <font color="#000000">=</font> <font color="#800080">"Id:% String, Prop1:% String, Prop2:% Integer"</font> <font color="#000000">) [</font> <font color="#000080">SqlName</font> <font color="#000000">=</font> <font color="#008000">AllStatic</font> <font color="#000000">,</font> <font color="#000080">SqlProc</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">AllStaticExecute (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">DECLARE</font> <font color="#008000">C</font> <font color="#000080">CURSOR FOR</font> <font color="#000080"><br></font>  <font color="#0000ff">SELECT</font> <font color="#008000">Id</font> <font color="#000000">,</font> <font color="#008000">Prop1</font> <font color="#000000">,</font> <font color="#008000">Prop2</font> <font color="#008000"><br></font>  <font color="#000080">FROM</font> <font color="#008000">Utils</font> <font color="#000000">.</font>  <font color="#008000">Customquery</font> <font color="#008000"><br></font>  <font color="#800080">)</font> <font color="#800080"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">OPEN</font> <font color="#008000">C</font> <font color="#800080">)</font> <font color="#800080"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">AllStaticFetch (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">Row</font> <font color="#000080">As% List</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">AtEnd</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">PlaceAfter</font> <font color="#000000">= AllStaticExecute]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#008000">#;</font>  <font color="#008000">INTO must be with FETCH</font> <font color="#008000"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">FETCH</font> <font color="#008000">C</font> <font color="#000000">INTO</font> <font color="#800000">: Id</font> <font color="#800000">,:</font> <font color="#800000">Prop1,: Prop2</font> <font color="#800080">)</font> <font color="#800080"><br></font>  <font color="#008000">#;</font>  <font color="#008000">Check whether the data has reached the end</font> <font color="#008000"><br></font>  <font color="#0000ff">If</font> <font color="#000000">(</font> <font color="#800000">SQLCODE</font> <font color="#000000">'= 0)</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">AtEnd</font> <font color="#000000">= 1</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">Row</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">Row</font> <font color="#000000">=</font> <font color="#0000ff">$ Lb</font> <font color="#000000">(</font> <font color="#800000">Id</font> <font color="#000000">,</font> <font color="#800000">Prop1</font> <font color="#000000">,</font> <font color="#800000">Prop2</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">AllStaticClose (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">PlaceAfter</font> <font color="#000000">= AllStaticFetch]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#800080">&amp; sql (</font> <font color="#0000ff">CLOSE</font> <font color="#008000">C</font> <font color="#800080">)</font> <font color="#800080"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  } <br></div></div><br><h3>  Dynamic SQL </h3><br>  The approach is to use other class queries and dynamic SQL.  This is relevant for cases when, in addition to the actual query, which we represent in the form of SQL, you need to perform some additional actions, for example, you need to execute a SQL query, but in several areas in turn.  Or you need an escalation of rights before executing the request. <br><br><div class="spoiler">  <b class="spoiler_title">Dynamic SQL Example for Utils.CustomQuery</b> <div class="spoiler_text">  <font color="#000080">Query</font> <font color="#000000">AllDynamic ()</font> <font color="#000080">As% Query</font> <font color="#000000">(</font> <font color="#000080">CONTAINID</font> <font color="#000000">=</font> <font color="#000080">1</font> <font color="#000000">,</font> <font color="#000080">ROWSPEC</font> <font color="#000000">=</font> <font color="#800080">"Id:% String, Prop1:% String, Prop2:% Integer"</font> <font color="#000000">) [</font> <font color="#000080">SqlName</font> <font color="#000000">=</font> <font color="#008000">AllDynamic</font> <font color="#000000">,</font> <font color="#000080">SqlProc</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">AllDynamicExecute (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">qHandle</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% SQL.Statement</font> <font color="#000000">).</font>  <font color="#0000ff">% ExecDirect</font> <font color="#000000">(,</font> <font color="#008000">"SELECT * FROM Utils.CustomQuery"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">AllDynamicFetch (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">Row</font> <font color="#000080">As% List</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">AtEnd</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">If</font> <font color="#800000">qHandle</font> <font color="#000000">.</font>  <font color="#0000ff">% Next</font> <font color="#000000">() = 0</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">AtEnd</font> <font color="#000000">= 1</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">Row</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">Row</font> <font color="#000000">=</font> <font color="#0000ff">$ Lb</font> <font color="#000000">(</font> <font color="#800000">qHandle</font> <font color="#000000">.</font> <font color="#0000ff">% Get</font> <font color="#000000">(</font> <font color="#008000">"Id"</font> <font color="#000000">),</font> <font color="#800000">qHandle</font> <font color="#000000">.</font> <font color="#0000ff">% Get</font> <font color="#000000">(</font> <font color="#008000">"Prop1"</font> <font color="#000000">),</font> <font color="#800000">qHandle</font> <font color="#000000">.</font> <font color="#0000ff">% Get</font> <font color="#000000">(</font> <font color="#008000">"Prop2"</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">AllDynamicClose (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">Kill</font> <font color="#800000">qhandle</font> <font color="#800000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  } </div></div><br><h2>  Alternative approach -% SQL.CustomResultSet </h2><br>  Alternatively, you can define the query as an inheritor of the <a href="">% SQL.CustomResultSet</a> class.  On Habr√© there is an article about using <a href="http://habrahabr.ru/company/intersystems/blog/160147/">% SQL.CustomResultSet</a> .  The advantages of this approach: <br><br><ul><li>  Slightly higher speed </li><li>  All meta-information is taken from the class definition, ROWSPEC is not needed. </li><li>  Compliance with the principles of OOP </li></ul><br>  When creating an inheritor of the% SQL.CustomResultSet class, the following steps must be performed: <br><br><ol><li>  Determine the properties that match the result fields. </li><li>  Define private properties that will contain the context of the query and not be part of the result. </li><li>  Redefine the% OpenCursor method ‚Äî the equivalent of the queryNameExecute method, which is responsible for the initial creation of the context.  In case of errors, set% SQLCODE and% Message </li><li>  Redefine the% Next method - an analogue of the queryNameFetch method responsible for obtaining the following result.  Fill in the properties.  The method returns 0, if there is no more data, if there is, then 1 </li><li>  Redefine the% CloseCursor method - an analogue of the queryNameClose method, if necessary </li></ol><br><div class="spoiler">  <b class="spoiler_title">An example using% SQL.CustomResultSet for Utils.CustomQuery</b> <div class="spoiler_text">  <font color="#000080">Class Utils.CustomQueryRS Extends% SQL.CustomResultSet</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000080">Property</font> <font color="#000000">Id</font> <font color="#000080">As% String</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">Property</font> <font color="#000000">Prop1</font> <font color="#000080">As% String</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">Property</font> <font color="#000000">Prop2</font> <font color="#000080">As% Integer</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">Method</font> <font color="#000000">% OpenCursor ()</font> <font color="#000080">As% Library.Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">..</font> <font color="#0000ff">Id</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000080">Method</font> <font color="#000000">% Next (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">sc</font> <font color="#000080">As% Library.Status</font> <font color="#000000">)</font> <font color="#000080">As% Library.Integer</font> <font color="#000000">[</font> <font color="#000080">PlaceAfter</font> <font color="#000000">=% Execute]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">sc</font> <font color="#000000">=</font> <font color="#0000ff">$$$ OK</font> <font color="#0000ff"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">..</font> <font color="#0000ff">Id</font> <font color="#000000">=</font> <font color="#0000ff">$ Order</font> <font color="#000000">(^ Utils.CustomQueryD (..</font> <font color="#0000ff">Id</font> <font color="#000000">), 1,</font> <font color="#800000">val</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Quit</font> <font color="#000000">: ..</font> <font color="#0000ff">Id</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">0</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">..</font> <font color="#0000ff">Prop1</font> <font color="#000000">=</font> <font color="#0000ff">$ Lg</font> <font color="#000000">(</font> <font color="#800000">val</font> <font color="#000000">, 2)</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">..</font> <font color="#0000ff">Prop2</font> <font color="#000000">=</font> <font color="#0000ff">$ Lg</font> <font color="#000000">(</font> <font color="#800000">val</font> <font color="#000000">, 3)</font> <font color="#000000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000000">}</font> </div></div><br>  Call it from the COS code as follows: <br><br><blockquote>  <font color="#0000ff">Set</font> <font color="#800000">resultset</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">Utils.CustomQueryRS</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">While</font> <font color="#800000">resultset</font> <font color="#000000">.</font>  <font color="#0000ff">% Next</font> <font color="#000000">()</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Write</font> <font color="#800000">resultset</font> <font color="#000000">.</font>  <font color="#0000ff">Id,!</font> <font color="#000000"><br></font>  <font color="#800080">}</font> </blockquote><br>  And in the SAMPLES area there is an example - the <a href="">Sample.CustomResultSet</a> class <a href="">that</a> implements the query for the <a href="">Samples.Person</a> class. <br><br><h2>  findings </h2><br>  Custom queries allow you to solve problems such as abstraction of SQL code in COS and implementation of behavior that is difficult to implement only by SQL. <br><br><h2>  Links </h2><br>  <a href="">Class Requests</a> <br>  <a href="">Global traversal</a> <br>  <a href="">Static SQL</a> <br>  <a href="">Dynamic SQL</a> <br>  <a href="">% SQL.CustomResultSet</a> <br>  <a href="">Utils.CustomQuery class</a> <br>  <a href="">Class Utils.CustomQueryRS</a> <br><br>  The author is grateful to Habrayuser <a href="http://habrahabr.ru/users/adaptun/" class="user_link">adaptun</a> for help in writing the article. </div><p>Source: <a href="https://habr.com/ru/post/270839/">https://habr.com/ru/post/270839/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270823/index.html">First article about checking C # project</a></li>
<li><a href="../270825/index.html">Component-oriented C # engine</a></li>
<li><a href="../270827/index.html">PostgreSQL on multicore servers Power 8</a></li>
<li><a href="../270829/index.html">Development and debugging of applications for Android Wear</a></li>
<li><a href="../270837/index.html">Embedding Addictions in Angular 2</a></li>
<li><a href="../270841/index.html">Cisco ipsec tunnel without using crypto map</a></li>
<li><a href="../270843/index.html">Digest of the game industry: October</a></li>
<li><a href="../270845/index.html">How to make an elephant out of a fly</a></li>
<li><a href="../270847/index.html">JS Programming Contest: Email Filters</a></li>
<li><a href="../270849/index.html">An example of solving a typical OOP problem in the Go language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>