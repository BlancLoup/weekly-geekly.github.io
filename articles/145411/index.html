<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we did the map services</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúOne of the most promising technologies of social communications is geolocation services (Location-based services - LBS), which allow to determine the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we did the map services</h1><div class="post__text post__text-html js-mediator-article">  <i>‚ÄúOne of the most promising technologies of social communications is geolocation services (Location-based services - LBS), which allow to determine the location of a user / mobile subscriber.</i> <br>  CNews (For more information: <a href="http://www.cnews.ru/reviews/index.shtml%3F2012/06/06/492022">www.cnews.ru/reviews/index.shtml?2012/06/06/492022</a> ‚Äù) <br><br>  The Mediagates team fully shares this view.  Therefore, today we want to tell Habrasoobschestvuyu how we developed geolocation services for our project - <a href="http://www.mediagates.ru/">Mediagates.ru</a> .  The post includes the choice of a map service, a description of the tasks, difficulties and algorithms for solving. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6cd/6be/046/6cd6be046989672dc28588465d399b1b.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  About Mediagates.ru </h4><br>  To make it clear what this is all about, first a few words about the project.  The main task of "Mediagates" is to unite professionals in the field of music: artists, producers, promoters, platforms and others.  In more detail about the possibilities of the project, as well as its architecture, we will tell in the next posts here on Habr√©.  In the meantime, you can read the <a href="http://mediagates.ru/blogs/164/post/8746">post about the project</a> on our website. <br><br>  Even at the design stage of the site, we realized that for a more visual presentation of information, you just need to use maps.  They make it possible to quickly find artists nearby or correctly advertise themselves using geo-targeting.  And now we invite everyone habrovchan on a beta test.  The fact that you can potestit, later in this article. <br><br><a name="habracut"></a><br><h4>  Main tasks </h4><br>  Our main and most important requirement was the maximum possible penetration of interactive and static maps on most pages of the project.  After studying the structure of our site, we came to the conclusion that it is necessary to have several basic modules that we can place in different sections of the project: <br><br><ol><li>  Interactive map with the ability to display on it certain types of markers (events, artists, promoters, sites, shops, etc.) and filter them by date; </li><li>  Tour Planner, which would allow the artists to plan their performances and movements on the map or on the big calendar, offer themselves to various sites and receive offers of joint performances from other users; </li><li>  The form for editing the location of an object so that all the content on the site can be tied to a map (for example, for the user it is a kind of check-in function); </li><li>  Static maps with markers on them to illustrate objects in the lists (otherwise you would have to initialize dozens of maps on each page, which would be costly both in terms of performance and the limits of map services).  Also, static maps were needed to export the tour planner to an image in JPG format. </li></ol><br>  For more information about the capabilities of the cards on Mediagates.ru, you can read in the article " <a href="http://mediagates.ru/blogs/164/post/36272/">Everything to the card</a> " posted on our website blog, and here we would like to talk about the technical aspects of the implementation of services. <br><br>  Of course, you will say that each of these points separately is relatively simple and obvious in implementation.  But we suggest to go deep into each of them, to understand how all of them can be combined in one project, and to deal with all the difficulties and pitfalls that we had to face during implementation.  Let's start with a very important decision: the choice of a map service. <br><br><h4>  Choosing a map service </h4><br>  I think you should not go into details, because Habr√© has many articles and reviews on this topic.  The main problem we faced here was that in the process of designing our service, the Google Maps API became paid.  We were afraid that this could spoil our plans, but after repeated detailed calculations, we were left with our decision to use the Google product. <br><br>  The map services we reviewed: <br><br><ul><li>  Google maps </li><li>  Yandex maps, </li><li>  Cloud Made (or Open Street Map), </li><li>  Bing </li><li>  API 2GIS. </li></ul><br>  The final analysis took place in early February 2012, the situation could have changed since then, but the selection parameters were as follows: <br><br><ul><li>  The quality of the drawing of the city of Yeisk (at the initial stage of the development of the project, it is important for us that the Russian Federation be drawn in sufficient detail), </li><li>  Drawing maps around the world (we have ambitious plans for the future) </li><li>  Willingness to customize the appearance of the cards (as a result refused from it), </li><li>  Legal restrictions on the number of initialization of maps or requests to a particular API, </li><li>  The quality of geocoding (including in the Russian Federation). </li></ul><br>  General impressions of the comparison were as follows: <br><br><ul><li>  OpenStreetMap turned out to be the most detailed around the world, but they have not the best Geocoding API; </li><li>  The level of drawing of Madrid (the capital of Spain) on Yandex Maps leaves much to be desired; </li><li>  Bing poorly prepared for the Russian Federation; </li><li>  API 2GIS have a good start - I hope that in the future the guys will compete with the main players in this market; </li><li>  Google Maps gives the awesome Geocoding API, although the detail of some cities in the Russian Federation suffers, which is not the case with Europe (he himself used their maps many times to navigate cities with iPad instead of navigator).  Google pay </li></ul><br>  As a result, we realized that at the moment we are most comfortable with the Google Maps API, despite its payment, but in the future it is possible that we will have to switch to another map service.  In this regard, it was decided to organize our code so that it was possible at any time to add classes to work with another map service, without the need to rewrite the main part of the work with maps.  In other words, they decided to divide the task into two subtasks: interactive on the site and communication with the map service. <br><br>  Google bribed us with a very good geocoding service (Google Geocoding API).  To be honest, our developers had a chance to actually see the joke that exists in the professional community ‚ÄúYandex - There is everything.  Google - Nothing was lost. ‚Äù: The Google Geocoding API manages to find the location of very, very many addresses, without requiring the user to enter it in the original language. <br><br>  Among the shortcomings of the Google service, it is worth emphasizing once again the weak ‚Äúknowledge‚Äù of Russia and payment (in case of exceeding the limit on accessing the API and initialization of maps).  So far, we have had to abandon the customization of cards due to the reduction of limits on the initialization of customized maps. <br><br>  So the service provider selected is Google.  So at our disposal were: <br><br><ul><li>  Google Maps API v3, </li><li>  Google Geocoding API v3, </li><li>  Google Static Maps API v2. </li></ul><br>  Now we offer to deal with the general architecture of the front-end and back-end.  Let's start with the front-end. <br><br><h4>  The main components of the front-end </h4><br>  As we have said, we wanted to be able in the future to quickly add the opportunity to work with another supplier of cards.  Therefore, we have developed fundamental classes, which are, in fact, an extension of such classes as: <br><br><ul><li>  google.maps.Map, </li><li>  google.maps.Marker, </li><li>  google.maps.Geocoder. </li></ul><br>  For markers, we needed an additional opportunity to display names and pop-up lists (for example, for groups of markers).  We decided to take the Gary Little MarkerWithLabel for V3 class and modify it to suit our needs. <br><br>  We also prepared the main classes for working with modules: <br><br><ol><li> interactive map with filters of different types of markers and a small calendar (in one lane), </li><li>  tour planner, which is built on the first class, replacing the small calendar with a larger one (of course, expanding its functionality), </li><li>  indication of the location of the object. </li></ol><br><h4>  The main components of the back-end </h4><br>  The back-end was supposed to perform the following main tasks: <br><br><ul><li>  Selection from the database of a large number of markers that meet the conditions of the request from the front-end and their grouping; </li><li>  Generating static maps for displaying items in lists and exporting the current map view in the tour planner to jpg image; </li><li>  Combining markers (or groups of markers) of user events with a continuous curve. </li></ul><br>  Here, first of all, you should pay attention to the grouping of markers, then we will consider the process of combining curve markers, and at the end - exporting maps. <br><br><h4>  Marker grouping </h4><br>  The need for grouping markers occurs when you have to work with a large number of objects on the map.  Some browsers start the brakes with the processing of several dozen non-standard markers.  To avoid this, it is necessary to combine the objects on the map into groups. <br><br>  Grouping is of two types: front-end and back-end.  The first is implemented in Java Script, the second - in the server language.  For Java Script grouping, there are quite a few ready-made engines that could be used, but transferring such a large amount of data from the server to the browser, the work is also ungrateful - the more data, the slower the browser will be to think that, as a result, it will decrease speed of work with the site and the deterioration of perception of information. <br><br><h4>  Server-side grouping of markers </h4><br>  After we stopped at the server-side grouping of markers, we began to wonder what algorithms were already invented in this area.  It is customary to talk about the two most common types of clustering: grid-based and distance-based.  The first option is simpler, the second is steeper in terms of algorithm and implementation.  We have taken the first path for a quick start, but we are already working on distance-based clustering, which we plan to implement in the near future. <br><br>  The essence of the grid-based grouping is simple: for each approximation (zoom), the globe is divided into shapes (relatively speaking, rectangles), which are groups.  In other words, if more than one object immediately falls into any of these figures, they are grouped into one marker, symbolizing the group. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3f9/bfc/f81/3f9bfcf81bfe31af939b24318e4e39a6.jpg" alt="image"><br><br><h4>  Combining curve markers </h4><br>  Initially, we thought to make a simple polyline, which will combine in a chronological order certain markers or groups of markers on the map.  It is clear that this is most conveniently done using the google.maps.Polyline and google.maps.PolylineOptions classes.  But first, our GUI designers, and then the programmers decided that it would be much more beautiful to have not a broken line, but a smooth (as far as point-based construction allows) curve, which will combine the markers of our users. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9a3/274/ad4/9a3274ad4441f7940511e92504e7e6dc.jpg" alt="image"><br><br>  As in the case of grouping, we decided to design this curve on the server side in order not to overload the user's computer.  After some short tests, we stopped at the interpolation method with cubic splines, the result of which is transferred from the server to JavaScript, which already draws it point by point using google.maps.Polyline. <br><br>  Let us dwell on the algorithm.  From the point of view of mathematics, he is nothing complicated.  In PHP, we made the following classes: <br><br><ol><li>  Point - just a visual storage of point coordinates </li><li>  Cubic - class to get the value of the function (of the form f (x) = d * x ^ 3 + c * x ^ 2 + b * x + a) and its derivative for a certain x and coefficients a, b, c, d </li><li>  Poly - interpolation itself </li></ol><br>  The following are minimized for understanding the source code of each of these classes. <br><br>  Point.inc <br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Point</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $x; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $y; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x, $y)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;x = $x; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;y = $y; } } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br><br>  Cubic.inc <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cubic</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $a; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $b; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $c; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $d; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a, $b, $c, $d)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;a = $a; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;b = $b; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;c = $c; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;d = $d; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eval_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($u)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;d * $u + <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;c) * $u + <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;b) * $u + <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;a; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eval_derivative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($u)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;b + $u * (<span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;c + <span class="hljs-number"><span class="hljs-number">3</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;d * $u); } } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  Poly.inc <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Poly</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $points; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;points = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x, $y)</span></span></span></span>{ array_push(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;points, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point($x, $y)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInterpolatedPoly</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($stepsNum = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">12</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $type = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'poly'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{ $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $j = <span class="hljs-number"><span class="hljs-number">0</span></span>; $u = <span class="hljs-number"><span class="hljs-number">0</span></span>; $ret = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Poly(); $sizeofPoints = sizeof(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;points); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($sizeofPoints &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span>){ $xpts = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;xpoints(); $ypts = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ypoints(); $xc = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;calcNaturalCubic($sizeofPoints - <span class="hljs-number"><span class="hljs-number">1</span></span>, $xpts); $yc = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;calcNaturalCubic($sizeofPoints - <span class="hljs-number"><span class="hljs-number">1</span></span>, $ypts); $ret-&gt;push($xc[<span class="hljs-number"><span class="hljs-number">0</span></span>]-&gt;eval_(<span class="hljs-number"><span class="hljs-number">0</span></span>), $yc[<span class="hljs-number"><span class="hljs-number">0</span></span>]-&gt;eval_(<span class="hljs-number"><span class="hljs-number">0</span></span>)); $stepsNum = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; sizeof($xc); $i++){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($j = <span class="hljs-number"><span class="hljs-number">1</span></span>; $j &lt;= $stepsNum; $j++){ $u = $j / $stepsNum; $nx = $xc[$i]-&gt;eval_($u); $ny = $yc[$i]-&gt;eval_($u); $ret-&gt;push($nx, $ny); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($type == <span class="hljs-string"><span class="hljs-string">'array'</span></span>){ $ret_ = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; sizeof($ret-&gt;points); $i++){ array_push($ret_, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'x'</span></span> =&gt; $ret-&gt;points[$i]-&gt;x, <span class="hljs-string"><span class="hljs-string">'y'</span></span> =&gt; $ret-&gt;points[$i]-&gt;y )); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $ret_; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $ret; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xpoints</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getPointsArray(<span class="hljs-string"><span class="hljs-string">'x'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ypoints</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getPointsArray(<span class="hljs-string"><span class="hljs-string">'y'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPointsArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($type)</span></span></span></span>{ $r = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $sizeofPoints = sizeof(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;points); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>($type){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'y'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $sizeofPoints; $i++) array_push($r, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;points[$i]-&gt;y); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'x'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $sizeofPoints; $i++) array_push($r, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;points[$i]-&gt;x); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $r; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calcNaturalCubic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($n, &amp;$x)</span></span></span></span>{ $gamma = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $delta = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $D = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $gamma[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">1.0</span></span> / <span class="hljs-number"><span class="hljs-number">2.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i = <span class="hljs-number"><span class="hljs-number">1</span></span>; $i &lt; $n; $i++) $gamma[$i] = <span class="hljs-number"><span class="hljs-number">1</span></span> / (<span class="hljs-number"><span class="hljs-number">4</span></span> - $gamma[$i<span class="hljs-number"><span class="hljs-number">-1</span></span>]); $gamma[$n] = <span class="hljs-number"><span class="hljs-number">1</span></span> / (<span class="hljs-number"><span class="hljs-number">2</span></span> - $gamma[$n<span class="hljs-number"><span class="hljs-number">-1</span></span>]); $delta[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">3</span></span> * ($x[<span class="hljs-number"><span class="hljs-number">1</span></span>] - $x[<span class="hljs-number"><span class="hljs-number">0</span></span>]) * $gamma[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i = <span class="hljs-number"><span class="hljs-number">1</span></span>; $i &lt; $n; $i++) $delta[$i] = (<span class="hljs-number"><span class="hljs-number">3</span></span> * ($x[$i + <span class="hljs-number"><span class="hljs-number">1</span></span>] - $x[$i - <span class="hljs-number"><span class="hljs-number">1</span></span>]) - $delta[$i - <span class="hljs-number"><span class="hljs-number">1</span></span>]) * $gamma[$i]; $delta[$n] = (<span class="hljs-number"><span class="hljs-number">3</span></span> * ($x[$n] - $x[$n - <span class="hljs-number"><span class="hljs-number">1</span></span>]) - $delta[$n - <span class="hljs-number"><span class="hljs-number">1</span></span>]) * $gamma[$n]; $D[$n] = $delta[$n]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i = $n - <span class="hljs-number"><span class="hljs-number">1</span></span>; $i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; $i--) $D[$i] = $delta[$i] - $gamma[$i] * $D[$i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; $C = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $n; $i++) $C[$i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Cubic($x[$i], $D[$i], <span class="hljs-number"><span class="hljs-number">3</span></span> * ($x[$i + <span class="hljs-number"><span class="hljs-number">1</span></span>] - $x[$i]) - <span class="hljs-number"><span class="hljs-number">2</span></span> * $D[$i] - $D[$i + <span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-number"><span class="hljs-number">2</span></span> * ($x[$i] - $x[$i + <span class="hljs-number"><span class="hljs-number">1</span></span>]) + $D[$i] + $D[$i + <span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $C; } } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  And here is the process of building our curves for arbitrary points.  At the input we have a named $ points array with pairs of x and y values ‚Äã‚Äãof each point. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//    require_once('Point.inc'); require_once('Cubic.inc'); require_once('Poly.inc'); //      $points = array(); for($i = 0; $i &lt; 10; $i++) $points[$i] = array('x' =&gt; rand(100, 500), 'y' =&gt; rand(100, 500)); //   ‚Ç¨    $_poly = new Poly(); //       foreach($points as &amp;$point) $_poly-&gt;push($point['x'], $point['y']); //    ‚Ç¨ ‚Ç¨  $lines = $_poly-&gt;getInterpolatedPoly(40, 'array'); //   $img = imagecreatetruecolor(600, 600); //   ‚Ç¨ ,     $whiteC = imagecolorallocate($img, 255, 255, 255); $greyC = imagecolorallocate($img, 127, 127, 127); $redC = imagecolorallocate($img, 255, 0, 0); //    imagefill($img, 0, 0, $whiteC); //   $halfOfPointWidth = 3; for($i = 0; $i &lt; sizeof($points); $i++) imagefilledrectangle($img, $points[$i]['x'] - $halfOfPointWidth, $points[$i]['y'] - $halfOfPointWidth, $points[$i]['x'] + $halfOfPointWidth, $points[$i]['y'] + $halfOfPointWidth, $redC); //     for($i = 0; $i &lt; sizeof($lines) - 1; $i++) imageline($img, $lines[$i]['x'], $lines[$i]['y'], $lines[$i+1]['x'], $lines[$i+1]['y'], $greyC); //       png ‚Ç¨ header('Content-Type:image/png'); imagepng($img); // ‚Ç¨  imagedestroy($img); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  At the output we have an array with coordinates for plotting a curve by points.  Here is a visualized example of what happened: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/66c/395/403/66c39540312738af6cbd00604dac1bcc.jpg" alt="image"><br><br>  And by changing a few settings, you can create an improvisation on the theme ‚ÄúHabraHabr Logo‚Äù: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/51c/dfa/cdd/51cdfacddeae62477e3a2754c847071b.jpg" alt="image"><br><br>  In the near future, we plan to slightly refine our curves so that they are not just a line, but small arrows that show direction. <br><br>  But now we believe that we gave artists, producers and organizers a convenient and beautiful way to tell everyone around what they do, what events they take part in as organizers or performers and where they are going to be at one time or another. <br><br><h4>  Static maps and export to JPG </h4><br>  After the user plans his tour on the map and calendar, he will certainly want to notify his friends on social networks or publish this information on his blog.  To do this, we made it possible to save the current map view with all the markers on the user's computer in JPG format. <br>  We implemented it like this: when you click on the ‚ÄúSave as JPG‚Äù button, Java Script sends all the information about the current map view and markers on it to the server, which loads the required map piece using the Google Static Maps API, saves markers on it and temporary storage file, a link to which is returned to the user in the browser. <br><br>  It would seem that nothing complicated: the main thing that should not be done is to try to place markers on the map on your own after uploading the image from the Google Static Maps API - nothing good will come of it.  The solution is much simpler: the API allows you to place external images when you specify their coordinates on the map. <br><br>  Here, one question remained open for us: how would you like to post a card on the user's wall on fb.com or vk.com?  We cannot say that we studied the problem in detail, but nothing better than exporting the map to jpg image, and then manually publishing it on the wall, we did not invent.  I would be happy if you tell me any way to publish a large image in the background.  At the same time, we must understand that this image does not fit the concept of user-generated, which allows you to post a large size on Facebook. <br><br><h4>  Search on the map </h4><br>  In conclusion, we would like to add a few words about the search for objects on the map.  When we thought about this function, we tried to combine the convenience of a graphical interface and getting the most relevant results.  From the point of view of the UI, I always liked the search on afisha.ru very much - you enter everything you like, and he himself tells you what is on the site by this request and sorts by content types. <br><br>  As a result, we used the search engine (or server, as it is sometimes called) sphinx, on which the main search on our site is based.  With it, we get the most relevant data on user request from the database.  Also, in case the user wants to find an address, we make a request to the Google Geocoding API. <br><br>  Search results by database and addresses are displayed sorted by type after the first three characters entered by the user and make it possible by clicking on them to quickly move to the place on the map where this object is located. <br><br><h4>  Conclusion </h4><br>  In general, perhaps, and everything that we would like to tell on this issue.  We are, of course, very interested in how habrayuzer will relate to the project, to the cards, in particular, and whether we survive the habraeffect.  So welcome, register, check, test.  Those who help with tips on exporting a card to Facebook and VKontakte will be very grateful. </div><p>Source: <a href="https://habr.com/ru/post/145411/">https://habr.com/ru/post/145411/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145405/index.html">New IM + 6.5: Goodbye MySpace, Hi ... Mamba</a></li>
<li><a href="../145407/index.html">Why do SED work poorly?</a></li>
<li><a href="../145408/index.html">Not ultrabook uniform: different unusual laptops at Computex 2012</a></li>
<li><a href="../145409/index.html">Automation of IT processes in conditions of low motivation and / or qualifications of performers</a></li>
<li><a href="../145410/index.html">Effective web development with Visual Studio 2012: innovations in packaging and minification of scripts and styles</a></li>
<li><a href="../145412/index.html">Get rid of worthlessness</a></li>
<li><a href="../145415/index.html">All information technologies in summary</a></li>
<li><a href="../145416/index.html">Google Drive. Report with data from the table. Creating a simple database. Part 1</a></li>
<li><a href="../145417/index.html">Getting free EDS keys in Ukraine</a></li>
<li><a href="../145418/index.html">WWDC banners over the past 5 years</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>