<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Document generation based on ODT templates. ODT to PDF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear habrovchane! 

 Not so long ago, I had to face a typical task - to create documents with user data based on ODT templates using PHP. It so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Document generation based on ODT templates. ODT to PDF</h1><div class="post__text post__text-html js-mediator-article">  Hello, dear habrovchane! <br><br>  Not so long ago, I had to face a typical task - to create documents with user data based on ODT templates using PHP.  It sounds very trivial, but I had to suffer a lot.  The fact is that none of the available means, one way or another, did not fit.  Some libraries formed a crooked document, others did not support Russian fonts, and still others moved pictures in the Harlem Shake style.  So I had to "ride". <br><br>  So, the task in brief: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Process ODT template.  Replace placeholders with custom values </li><li>  Convert to pdf.  Show user </li></ol><br><a name="habracut"></a><br><br>  <b>STEP 1. Process the ODT template.</b>  <b>Replace placeholders</b> <br><br>  It's no secret that ODT is a regular archive with xml on board.  All the pictures are hidden in a folder, the name of which can be anything, just to be referred to in the description file.  We will not go into details: it is enough just to say that content.xml is responsible for the main content of the document, manifest.xml is responsible for the ‚Äúdescriptive‚Äù part.  I draw your attention that the styles of the text do not interest us (at least under the conditions of this task).  Digging a little deeper into these xml, we derive an algorithm: <br><br><ol><li>  Unpack archive </li><li>  To replace the text: the content.xml parsim, replace the placeholder with the necessary values </li><li>  For images: load our images into the folder (create it inside the unpacked .odt document), parse content.xml, replace placeholders with a view frame <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">draw:frame</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">draw:style-name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"a0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">draw:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'.$file_name.'"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">text:anchor-type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"as-char"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">svg:x</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0in"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">svg:y</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0in"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">svg:width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'.$width.'in"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">svg:height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'.$height.'in"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style:rel-width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"scale"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style:rel-height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"scale"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">draw:image</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xlink:href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'.self::_ImgDir.DIRECTORY_SEPARATOR.$file_name.'"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xlink:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"simple"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xlink:show</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"embed"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xlink:actuate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"onLoad"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svg:title</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svg:desc</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">draw:frame</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  Next, add to the end of the manifest.xml block of the form <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest:file-entry</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">manifest:full-path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'.self::_ImgDir.DIRECTORY_SEPARATOR.$file_name.'"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">manifest:media-type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image/'.$ext.'"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br></li><li>  Archive the result back to ODT. </li></ol><br><br>  The algorithm is clearly simplified, but effective and easy.  On its basis, the odtFormat class (on the knees) was written.  A little help on how to use it: <br><br>  <i>Initialization</i> <br><pre> <code class="php hljs">$odtformat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> odtFormat(‚Äú$doc_path‚Äù, <span class="hljs-string"><span class="hljs-string">"$temp_dir"</span></span>);</code> </pre><br>  $ doc_path - path to the .odt template <br>  $ temp_dir - folder in which temporary files will be stored. <br><br>  <i>Insert text</i> <br><pre> <code class="php hljs">$odtformat-&gt;SetText(‚Äú$name‚Äù, ‚Äú$value‚Äù);</code> </pre><br>  $ name is the name of the placeholder <br>  $ value - user value <br><br>  <i>Insert image</i> <br><pre> <code class="php hljs">$odtformat-&gt;SetImage(‚Äú$name‚Äù, ‚Äú$img_path‚Äù ,$width, $height);</code> </pre><br>  $ name - placeholder'a name <br>  $ img_path - path to the image <br>  $ width - the desired width of the image in the document (if you do not specify the width of the original) <br>  $ height - the desired length of the image in the document (if not set - the length of the original) <br><br>  Saving the document <br><pre> <code class="php hljs">$odtformat-&gt;SaveToDisk(‚Äú$path_to_save‚Äù);</code> </pre><br>  $ path_to_save - where we will save (path + file name) <br><br>  I do not cite the remaining methods, everything can be seen in the source code.  Moreover, most of the auxiliary methods are taken from public sources.  And the code itself is as simple as two kopecks.  I will give only some settings: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> _SeporatorLeft = <span class="hljs-string"><span class="hljs-string">'{{'</span></span>;</code> </pre><br>  Separates placeholder from text on the left. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> _SeporatorRight = <span class="hljs-string"><span class="hljs-string">'}}'</span></span>;</code> </pre><br>  Separates placeholder from text to the right. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> _ImgDir = <span class="hljs-string"><span class="hljs-string">'media'</span></span>;</code> </pre><br>  Folder name with custom images <br>  Well, we can say that the .odt file, filled with the data we need, has already been formed.  Time for the second stage. <br><br>  <b>Attention!</b>  In order to replace placeholders correctly, when adding them to a document, use ‚ÄúClear Format‚Äù.  The class used for MS World 2013. But something tells me that the content of the odt is the same in other versions. <br><br>  <b>STEP 2. Convert to pdf.</b>  <b>Showing to user</b> <br><br>  I must say that I did not find the ideal solution.  Essentially, there are practically no solutions.  Break the "Internet", stumbled upon a handful of heavyweights, zend lotions and just junk.  So, I will tell everything as it was. <br>  First of all, I tried to use online services.  First was the Google Docs.  It's all clear.  Simply display the document on the page through the iframe, avoiding the conversion itself. <br>  Example: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://docs.google.com/viewer?url=http%3A%2F%2F127.0.0.1%2Fa.odt&amp;embedded=true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"600"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"780"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"border: none;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <i>Minuses:</i> <br><ul><li>  Display speed </li><li>  Curve Formatting </li><li>  When using third-party libraries to form odt, a strange white sheet appeared at the beginning of the document. </li><li>  Not pdf </li><li>  Online </li></ul><br>  <i>Pros:</i> <br><ul><li>  Simplicity </li></ul><br><br>  Obviously, this decision did not last long.  It is worth looking in the direction of Microsoft with their Office Apps.  An interesting hint was converting pdf as a print version (built-in online service function).  Thus, Microsoft can convert the file and show it right there. <br>  Example: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://co1-word-view.officeapps.live.com/wv/WordViewer/request.pdf?WOPIsrc=http%3A%2F%2Fco1%2D15%2Dview%2Dwopi%2Ewopi%2Elive%2Enet%3A808%2Foh%2Fwopi%2Ffiles%2F%40%2FwFileId%3FwFileId%3Dhttp://127.0.0.1/a.odt&amp;type=printpdf"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"600"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"780"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"border: none;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <i>Minuses</i> <br><ul><li>  Insanely long </li><li>  The decision itself is crooked. </li><li>  Unpredictable behavior in different browsers </li><li>  So it was not possible to get rid of the print window </li><li>  Online </li></ul><br>  <i>pros</i> <br><ul><li>  High-quality conversion </li></ul><br><br>  Not finding more decent online options, it was decided to use the server tools.  Libreoffice copes well with this task.  It has a built-in command-line document converter.  The idea was to throw the generated odt into a folder, transfer it to the key to exec, display the ready-made pdfs that are in the same folder.  Suppose we have already done apt-get install libreoffice.  It remains only to add one line of code: <br><br><pre> <code class="php hljs">exec(‚Äúlibreoffice --headless --invisible --convert-to pdf $full_path_to_file --outdir $full_path_to_dir‚Äù);</code> </pre><br>  $ full_path_to_file - full path to files (/var/www/*.odt) <br>  $ full_path_to_dir - full path to save folder (/ var / www / result /) <br><br>  How to show pdf in an iframe, I think you yourself know. <br><br>  <i>Minuses</i> <br><ul><li>  I need access to the server </li><li>  Heavy libreoffice package </li><li>  exec (similar commands in code are not very good) </li></ul><br>  <i>pros</i> <br><ul><li>  Marked increase in speed </li><li>  High-quality formatting </li><li>  Ease of use of finished documents </li><li>  Absolutely local solution </li></ul><br><br>  <b>Conclusion</b> <br>  With all the shortcomings of the solution, the goals are fulfilled.  I hope that this article will help to avoid some difficulties in performing such a task.  All good coding! <br><br>  <b>Links</b> <br>  <a href="">OdtFormat library</a> <br>  <a href="http://ru.wikipedia.org/wiki/LibreOffice">About LibreOffice</a> <br><br>  PS I apologize for the disgusting formatting. </div><p>Source: <a href="https://habr.com/ru/post/195160/">https://habr.com/ru/post/195160/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195148/index.html">GCC and Variable-Length Arrays</a></li>
<li><a href="../195150/index.html">Debian: create packages for a narrow range of systems</a></li>
<li><a href="../195152/index.html">Linux pipes tips & tricks</a></li>
<li><a href="../195154/index.html">Primitive game design. Turn-based card game development</a></li>
<li><a href="../195158/index.html">Pirates vs. copyright holders: insider view</a></li>
<li><a href="../195164/index.html">Russian Code Cup 2013: parse the tasks of the final</a></li>
<li><a href="../195168/index.html">AlterWiki - quick search on Russian wiki projects</a></li>
<li><a href="../195178/index.html">Ask an Intel expert a new generation of Intel Haswell processors.</a></li>
<li><a href="../195180/index.html">Billing in a tiny project. 10 lines of HTML code</a></li>
<li><a href="../195182/index.html">Acceleration of calculations using the GPU, now in Java!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>