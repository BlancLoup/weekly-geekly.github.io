<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with HealthKit. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The end and the beginning of the year for developers, as a rule, are always filled with a large number of projects. Having dealt with urgent matters a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with HealthKit. Part 2</h1><div class="post__text post__text-html js-mediator-article">  The end and the beginning of the year for developers, as a rule, are always filled with a large number of projects.  Having dealt with urgent matters and rolled up our sleeves, we at Techmas promised to share even more of our developments with colleagues. <br><br>  Despite the growing popularity of applications that HealthKit is already using, the demand for mobile health assessment solutions continues <a href="http://techmas.ru/cases/Accenture-Losing-Patience.pdf">to grow</a> . <br><br>  To clarify all the basic principles of working with the platform, we decided to return to the example from the last publication and supplement it with work with data samples from Health. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/06c/165/def/06c165defe0248c6a48948eebe94823c.jpg"></div><br><a name="habracut"></a><br><h2>  Introduction </h2><br>  Recall that earlier we made an overview of the overall functionality of HealthKit, reviewed the application for authentication in Health and the output characteristics of the user.  Now we will deal with samples ( <i>samples</i> ) for reading and writing new training data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Samples ( <i>samples</i> ) differ from characteristics ( <i>characteristics</i> ) in that they change over time and depend on user behavior.  For example, samples are used to add new training data, visualize them, define and calculate additional parameters. <br><br>  In the example, we show how to read data on the height and weight of the user from the Health application.  Next, we calculate the BMI (Body Mass Index) indicator and add the resulting value to track the dynamics of its change. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d45/06f/780/d4506f7805f3447eb89d5c2cce2a1da1.jpg"></div><br><br>  So back to the application from the previous section.  His code is <a href="https://github.com/barsuga/techHealthKit">here</a> . <br><br><h2>  Sample preparation </h2><br>  Create test data for the sample into the Health application. <br><br>  To do this, select the Weight item on the Body Measurements tab and enter several key points with information about the weight (weight) via Add Data Point. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/55f/221/606/55f2216061ae46ef8e29faefd5c3f581.jpeg"></div><br><br>  Data can be entered in any number and number at different intervals. <br><br>  Now we get permission to work with the parameters of the sample.  Add <i>authorizeHealthKit ()</i> to the authorization function (separately we talked about authorization earlier): <br><pre><code class="hljs lisp">let healthKitTypesToWrite = Set(<span class="hljs-name"><span class="hljs-name">arrayLiteral</span></span>: HKObjectType.quantityTypeForIdentifier(<span class="hljs-name"><span class="hljs-name">HKQuantityTypeIdentifierBodyMass</span></span>)!, HKObjectType.quantityTypeForIdentifier(<span class="hljs-name"><span class="hljs-name">HKQuantityTypeIdentifierActiveEnergyBurned</span></span>)!, HKObjectType.quantityTypeForIdentifier(<span class="hljs-name"><span class="hljs-name">HKQuantityTypeIdentifierDistanceWalkingRunning</span></span>)! )</code> </pre> <br><h2>  Reading a sample from Health </h2><br>  In our example, we will create the <i>readMostRecentSample ()</i> function, which will read the indicators by date and type. <br><br>  To obtain a sample, you must use a subclass of <i>HKSampleQuery</i> , which is inherited from <i>HKQuery</i> .  In essence, it works similar to Core Data's <i>NSFetchedRequest</i> . <br><br>  When forming the request, the following parameters are available: <br>  1. Sample type (for example, weight or height), <i>Type</i> . <br>  2. Conditions for the selection of the sample (period, values, etc.), <i>NSPredicate</i> . <br>  3. Sort method, <i>NSSortDescriptors</i> . <br><br>  The second and third parameters are optional.  After forming the query, <i>executeQuery ()</i> must be executed to display its result. <br><br>  In our example, we will create a method to get the last value for the specified sample type.  Add the following code to the <i>readMostRecentSample ()</i> function: <br><br><pre> <code class="hljs bash">// 1.    <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> past = NSDate.distantPast() <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> now = NSDate() <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> mostRecentPredicate = HKQuery.predicateForSamplesWithStartDate(past, endDate:now, options: .None) // 2.       <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> sortDescriptor = NSSortDescriptor(key:HKSampleSortIdentifierStartDate, ascending: <span class="hljs-literal"><span class="hljs-literal">false</span></span>) // 3.     <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> = 1 // 4.    <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> sampleQuery = HKSampleQuery(sampleType: sampleType, predicate: mostRecentPredicate, <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>, sortDescriptors: [sortDescriptor]) { (sampleQuery, results, error ) -&gt; Void <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> queryError = error { completion(nil,error) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>; } //    <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> mostRecentSample = results!.first as? HKQuantitySample <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> completion != nil { completion(mostRecentSample,nil) } } // 5.    self.healthKitStore.executeQuery(sampleQuery)</code> </pre><br>  Our function allows you to get the latest data on samples of a particular type.  For simplicity, the <i>readMostRecentSample ()</i> call <i>will be</i> added to the <i>viewDidLoad ()</i> method: <br><br><pre> <code class="hljs lua">// <span class="hljs-number"><span class="hljs-number">1.</span></span>   HKSampleType    let sampleType = HKSampleType.quantityTypeForIdentifier(HKQuantityTypeIdentifierBodyMass) // <span class="hljs-number"><span class="hljs-number">2.</span></span>       self.readMostRecentSample(sampleType!, completion: { (mostRecentWeight, <span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) -&gt; Void <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error reading weight from HealthKit Store: \(error.localizedDescription)"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre><br>  Here we use <i>quantityTypeForIdentifier</i> to determine the required sample, in our case <i>HKQuantityTypeIdentifierBodyMass</i> . <br><br><h2>  BMI value calculation </h2><br>  Now we will create a set for calculating and recording BMI.  It will be calculated by the formula: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">bmi</span></span> = weight / height<span class="hljs-regexp"><span class="hljs-regexp"> ^</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br>  As shown above, select the weight value (weight) from Health.  In the same way, we will get the height (height) of the user (replacing the data type and format, we use <i>HKQuantityTypeIdentifierHeight)</i> . <br><br>  Here we need the <i>HKQuantitySample</i> object.  You must also specify: <br><br>  ‚Ä¢ <i>HKQuantityType</i> object <i>type</i> to save.  In our case, this is <i>HKQuantityTypeIdentifierBodyMassIndex</i> . <br>  ‚Ä¢ <i>HKQuantity</i> object.  It is initialized with the passed value from the bmi parameter.  It is important that <i>HKUnit.countUnit ()</i> is used to convert the Double scalar type, which allows you to convert types to the necessary units. <br><br>  Then the BMI calculation will be as follows: <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> weight: HKQuantitySample <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> weightLocalizedString = ‚Äúempty<span class="hljs-string"><span class="hljs-string">" weight = (mostRecentWeight as? HKQuantitySample)!; kilograms = weight.quantity.doubleValueForUnit(HKUnit.gramUnitWithMetricPrefix(.Kilo)) let weightFormatter = NSMassFormatter() weightFormatter.forPersonMassUse = true; weightLocalizedString = weightFormatter.stringFromKilograms(kilograms) print(weightLocalizedString) let weightInKilograms = kilograms let heightInMeters: Double = 180 let bmi = weightInKilograms / heightInMeters * heightInMeters print(String(format: "</span></span>%<span class="hljs-number"><span class="hljs-number">.02f</span></span><span class="hljs-string"><span class="hljs-string">", bmi))</span></span></code> </pre><br><br>  Also note the use of formatting results using <i>NSMassFormatter</i> .  <i>NSMassFormater</i> itself, in essence, is not part of HelathKit, but it allows you to work with Health data types.  In particular, if kilograms are used in the application, and the device does not use the metric system, we are able to bring the units of measurement to the desired form. <br><br>  We will not dwell on issues of the interface, so the results will display in the console. <br><br><h2>  Adding a new sample to Health </h2><br><br>  Finally, to write the resulting BMI value to HelathKit, create a <i>saveBMISample</i> method <i>(bmi: Double, date: NSDate)</i> .  Output parameters: the BMI value itself and the date of its registration. <br><br><pre> <code class="hljs haskell">// <span class="hljs-number"><span class="hljs-number">1.</span></span>   <span class="hljs-type"><span class="hljs-type">BMI</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bmiType = <span class="hljs-type"><span class="hljs-type">HKQuantityType</span></span>.quantityTypeForIdentifier(<span class="hljs-type"><span class="hljs-type">HKQuantityTypeIdentifierBodyMassIndex</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bmiQuantity = <span class="hljs-type"><span class="hljs-type">HKQuantity</span></span>(unit: <span class="hljs-type"><span class="hljs-type">HKUnit</span></span>.countUnit(), doubleValue: bmi) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bmiSample = <span class="hljs-type"><span class="hljs-type">HKQuantitySample</span></span>(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">: bmiType, quantity: bmiQuantity, startDate: date, endDate: date) // 2.    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Health</span></span></span><span class="hljs-class"> healthKitStore.saveObject(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmiSample</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">withCompletion</span></span></span><span class="hljs-class">: { (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">success</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Void</span></span></span><span class="hljs-class"> in if( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class"> ) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">println</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Error</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">saving</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BMI</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sample</span></span></span><span class="hljs-class">: \(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">localizedDescription</span></span></span><span class="hljs-class">)") } else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">println</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BMI</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sample</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">saved</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">successfully</span></span></span><span class="hljs-class">!") } })</span></span></code> </pre><br>  The new BMI value is available for both standard viewing and can be used by a third-party authorized application. <br><br><h2>  Note </h2><br>  In practice, it makes sense to put all methods for working with HealthKit into a separate class. <br>  For our example, we limited ourselves to a demonstration of the key stages of working with the platform. <br><br>  The code for the final application is <a href="https://github.com/nindzyago/hktests">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/276429/">https://habr.com/ru/post/276429/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276419/index.html">Qt Dungeons: Monster Cooking Recipes (Part 1: Editing Heterogeneous Data)</a></li>
<li><a href="../276421/index.html">Microsoft strongly recommends users upgrade to Windows 10</a></li>
<li><a href="../276423/index.html">We invite you to an open lecture by Konstantin Sakhnov ‚ÄúHow to create your own game‚Äù</a></li>
<li><a href="../276425/index.html">Analysis of hosters and their tariffs for virtual servers</a></li>
<li><a href="../276427/index.html">‚ÄúWhy haven't artificial intelligence been invented yet?‚Äù Or testing CNTK tools from Microsoft Research</a></li>
<li><a href="../276431/index.html">Creating an Android application. Personalization</a></li>
<li><a href="../276433/index.html">A new version of Veeam Backup FREE Edition has been released: a brief overview and useful information about NFR-keys to the full version</a></li>
<li><a href="../276435/index.html">Recommendations for Designing the User Interface of RealSense Applications</a></li>
<li><a href="../276441/index.html">PyNSK # 6 - the sixth meeting of the Novosibirsk Python community</a></li>
<li><a href="../276443/index.html">Meaningful use of console applications in C #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>