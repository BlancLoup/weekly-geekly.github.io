<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nginx in the work of DevOps / Administrator. Dark side of power</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the work of DevOps / Administrators, there are often moments in which someone urgently needs to give someone access somewhere. Whether it's a docke...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nginx in the work of DevOps / Administrator. Dark side of power</h1><div class="post__text post__text-html js-mediator-article"><p>  In the work of DevOps / Administrators, there are often moments in which someone urgently needs to give someone access somewhere.  Whether it's a docker instance, one of the many containers, or some kind of internal service. </p><br><p>  Everyone knows about the capabilities of nginx in terms of traffic proxying, load balancing between servers, and other useful things that help to combine disparate services.  However, the task of solving problems arising in the development process is much more extensive. <br>  The main message of this article is to show a non-standard approach to seemingly simple things, such as providing temporary access to the inside of a closed segment. </p><a name="habracut"></a><br><p>  Let's start with the simple. </p><br><p>  You have a closed area within which various database instances, web services and so on are spinning.  Usually, nginx is in front of all of these, which drives traffic. <br>  Consider for example Galera Cluster for MySQL or MariaDB. </p><br><p>  Galera Cluster is an online block replication system for multiple MySQL or MariaDB instances. <br>  There are quite a few instructions for configuring the cluster, and each of them contains nginx with the <a href="http://nginx.org/ru/docs/stream/ngx_stream_core_module.html">stream</a> module.  The classic version of the configuration file is like this. </p><br><pre><code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">stream</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/mariadb-balancer-<span class="hljs-literal"><span class="hljs-literal">error</span></span>.log <span class="hljs-literal"><span class="hljs-literal">info</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> db { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">172.16.100.21:3306</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">172.16.100.22:3306</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">172.16.100.23:3306</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">172.16.100.24:3306</span></span> backup; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">172.16.100.25:3306</span></span> down; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">3306</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> db; <span class="hljs-attribute"><span class="hljs-attribute">proxy_connect_timeout</span></span> <span class="hljs-number"><span class="hljs-number">1s</span></span>; <span class="hljs-comment"><span class="hljs-comment"># detect failure quickly } }</span></span></code> </pre> <br><p>  On the host where nginx is installed, a listen socket is opened and incoming connections to this socket are serviced by the built-in nginx balancer.  As we all understand in systems where docker or kubernetes is used, there is no rigid binding of the service to the host on which this or that container is executed.  Then DNS rezolving comes into play and it all works fine until you need to connect to a specific node and a specific MySQL instance (MariaDB) bypassing the balancer.  And in this case the static config is a very bottleneck. </p><br><p>  What am I leading to? </p><br><p>  Consider the option when we have different services inside the contour, but they should be available on the same port open on the firewall and nginx.  Let's say we have three nodes on which there are three independent instances: Prod, Dev and Test with their ssh, mysql, nginx, apache, etc. </p><br><p>  From the point of view of HTTP / HTTPS, there are no problems.  I made a pack of virtual servers, zabindil for each desired domain name - the request came - the server name was determined from the request - the connection went to the correct instance.  Profit! </p><br><p>  Services ssh, mysql, postgresql and others do not know how to virtuosity and often, in order to organize a connection inside any instance, it is necessary to arrange a dance with a tambourine to open ports on a firewall, organize forwarding of packets, multihome source routing and so on. <br>  Although the decision itself lies on the surface.  Forward packets are a good thing, but it‚Äôs not very convenient to edit in the hands of the active development of the Firewall rule on the node that services incoming traffic. </p><br><p>  Most nginx mechanisms work in location and do not work in stream. </p><br><p>  However, there was a small loophole that allows you to optimize the process of dynamic connection to resources with minimal effort.  For this you need a local dns resolver with a memcached or redis database as a database backend. </p><br><p>  The essence is as follows.  When initiating a client-side connection to the server, nginx will try to resolve the client's IP address in the ssh.local or mysql.local zone on the local resolver 127.0.0.1 listening on port 5353. The server‚Äôs dns response must be the server address inside the loop that you must forward connection .  Nginx will do the rest of the work itself. </p><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">stream</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/ssh-forward-<span class="hljs-literal"><span class="hljs-literal">error</span></span>.log <span class="hljs-literal"><span class="hljs-literal">debug</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">resolver</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1:5353</span></span> valid=<span class="hljs-number"><span class="hljs-number">10s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">map</span></span> <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span> <span class="hljs-variable"><span class="hljs-variable">$sshtarget</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">default</span></span> <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>.ssh.local:<span class="hljs-number"><span class="hljs-number">22</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">map</span></span> <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span> <span class="hljs-variable"><span class="hljs-variable">$mysqltarget</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">default</span></span> <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>.mysql.local:<span class="hljs-number"><span class="hljs-number">3306</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">2223</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> <span class="hljs-variable"><span class="hljs-variable">$sshtarget</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_connect_timeout</span></span> <span class="hljs-number"><span class="hljs-number">1s</span></span>; <span class="hljs-comment"><span class="hljs-comment"># detect failure quickly } server { listen 33306; proxy_pass $mysqltarget; proxy_connect_timeout 1s; # detect failure quickly } }</span></span></code> </pre> <br><p>  What to give by default, if the client's address is not found in the correspondence tables - decide the system administrator.  You can return any non-existent address 127.0.0.2, etc. <br>  <b>I would like to draw your attention that the connection to a non-existent address will occur on behalf of nginx, so you must be careful when using this connection scheme.</b>  What to write dns server or use ready - everyone decides for himself.  You can take a <a href="https://gist.github.com/andreif/6069838">server on Python</a> and add a query to the database with it in a couple of lines or <a href="https://github.com/aborche/nginx-rdp-microdns">take my old project on a pearl</a> on which this configuration was tested. </p><br><p>  Managing the contents of the database can be implemented on anything.  The main thing to understand who should go at what point in time. </p><br><p>  Actually why the "dark side of the force"?  In essence, this scheme allows for the display of various information at different time intervals from different circuits providing this information with a single entry point.  You will never know which block of information from which contour will be displayed at a specific point in time. </p><br><p>  An established keepalive SSL tunnel will provide uninterrupted connection, and the missing, in auto-clear mode, from the dns database, the entry will not allow another host with the same IP to connect to your resources. </p><br><p>  Let's say a closed corporate portal for those who have previously logged in to the management system or the system for administering the company's internal resources, forwarding any port to an internal server.  In my case, this scheme is used for temporary forwarding of rdp connections to a specific computer on the network, according to the user's authorization, without using RDGateway.  Sometimes customers need to get to a particular circuit inside a closed area, and this temporary access scheme works great. </p><br><p>  I do not urge anyone to use this scheme on an ongoing basis, because  it is still not safe enough, but at critical moments you will have the opportunity to influence the situation inside the circuit located behind nginx. </p><br><p>  ¬© Aborche 2017 <br><img src="https://habrastorage.org/getpro/habr/post_images/7c5/e49/ede/7c5e49ede95e47e91424dbb9bafbb7bb.jpg" alt="Aborche"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/336162/">https://habr.com/ru/post/336162/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336152/index.html">Parallels Desktop for Mac 13: Ready for macOS High Sierra</a></li>
<li><a href="../336154/index.html">Log storage for a cloud platform. ELK implementation experience</a></li>
<li><a href="../336156/index.html">Python memory management</a></li>
<li><a href="../336158/index.html">How to remove ads from Android apps</a></li>
<li><a href="../336160/index.html">Some functional programming techniques in Python</a></li>
<li><a href="../336164/index.html">Pentestit Corporate Laboratories: Practical Information Security Skills</a></li>
<li><a href="../336166/index.html">Learn OpenGL. Part 2.3. - Materials</a></li>
<li><a href="../336168/index.html">Kaggle Mercedes and cross-validation</a></li>
<li><a href="../336170/index.html">Practice with dapp. Part 2. Deploying Docker images in Kubernetes using Helm</a></li>
<li><a href="../336172/index.html">Mobile browsers and their fluffy legs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>