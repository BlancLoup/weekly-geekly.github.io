<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Problems using NtQuerySystemInformation with undocumented arguments</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The morning that day began with the fact that we "broke if'y." This expression was once invented by one of my colleagues, who demonstrated how his deb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Problems using NtQuerySystemInformation with undocumented arguments</h1><div class="post__text post__text-html js-mediator-article">  The morning that day began with the fact that we "broke if'y."  This expression was once invented by one of my colleagues, who demonstrated how his debugger went to the if block when stepping through a code, despite the fact that the condition that the if was checking was exactly false.  The problem turned out to be trivial at that time - he used a release-optimized build, and in such a scenario, of course, you cannot trust step-by-step debugging.  But the expression ‚Äúbroken if'y‚Äù itself stuck and has been used in us since then to denote a situation when something so fundamental that it did not work even ceased to work. <br><br>  So, that day we had the function <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winternl/nf-winternl-ntquerysysteminformation">NtQuerySystemInformation broken</a> - one of the most important functions of Windows OS, which returns information about processes, threads, system descriptors, etc.  I once wrote <a href="https://habr.com/company/infopulse/blog/352060/">this article</a> about the benefits of using this function.  But it turned out that sometimes even such cornerstones of the system can fail. <br><br>  So what happened. <br><a name="habracut"></a><br>  For quite a long time (for several years already) we used the NtQuerySystemInformation function call with the SystemHandleInformation argument to get information about all the descriptors in the system.  Yes, this argument formally refers to the undocumented, but if you start looking for information on how to list all descriptors in all currently running applications on Windows, the combination NtQuerySystemInformation + SystemHandleInformation will be the most frequently proposed option.  And it really works, on all operating systems starting from Windows NT. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Why might you need to look for descriptors in all processes?  Well, for various reasons.  Utilities such as <a href="https://processhacker.sourceforge.io/">Process Hacker</a> simply show them for informational purposes.  There are programs that do it for the sake of finding a resource that is currently blocked by someone (for example, a file).  You can also, for example, find a mutex in someone else's process, used to allow only one copy of the program to run, close it and allow two instances of such an application to run.  Or list descriptors for the sake of duplicating them in order to organize a sandbox.  In general, there are many tasks. <br><br>  I will not completely cite the descriptor enumeration code here, I will only say that it was, in general, similar to the common examples, like <a href="https://blez.wordpress.com/2012/09/17/enumerating-opened-handles-from-a-process/">this</a> : <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((status = NtQuerySystemInformation( SystemHandleInformation, handleInfo, handleInfoSize, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> )) == STATUS_INFO_LENGTH_MISMATCH) handleInfo = (PSYSTEM_HANDLE_INFORMATION)<span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(handleInfo, handleInfoSize *= <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-comment"><span class="hljs-comment">// NtQuerySystemInformation stopped giving us STATUS_INFO_LENGTH_MISMATCH. if (!NT_SUCCESS(status)) { printf("NtQuerySystemInformation failed!\n"); return 1; } for (i = 0; i &lt; handleInfo-&gt;HandleCount; i++) { ... }</span></span></code> </pre> <br>  But here I launch our application - and suddenly it turns out that the descriptor I need (and I know for sure that it exists!) Is missing from the list returned by the NtQuerySystemInformation () function.  All arrived - "if'y broken." <br><br>  We are trying to reproduce the problem on other computers in the office.  On some reproduced, on most - no.  We are trying to understand how those on which are reproduced are different from those on which everything is good.  The Windows version is the same everywhere, the updates, the build of our program are all identical.  Suddenly, someone notices that all the laptops on which the problem has been reproduced are of the same model.  Hardware incompatibility?  But why suddenly now, before it worked ... In addition, there are other laptops of the same model in the office that are still working now.  Even the versions of the device drivers were compared - everything seemed to be the same.  But on some laptops everything works, but not on others. <br><br>  Hair pulling on my head lasted about half a day, until I accidentally paid attention to two things: <br><br><ol><li>  For some reason, the PIDs of the processes that are usually three, four or five-digit numbers on my computer have become six-digit.  It was rather strange to see PID type 780936. I did not notice these before.  At the same time, the total number of running processes was quite adequate (up to a hundred). </li><li>  The task manager on the CPU tab showed the total number of descriptors in the system - and it was huge, more than 800,000. </li></ol><br>  For a normal application, it is normal to open a hundred or two descriptors.  Well, a thousand.  Chrome with active use can open about 2000, Visual Studio on large projects can open 3000. But who opened 800,000?  Fortunately, the previously mentioned Process Hacker allows you to show the number of descriptors for each process and even sort the list of processes by the number of descriptors used. <br><br>  And what do we see?  And we see something like this: <br><br><img src="https://habrastorage.org/webt/yz/zi/vt/yzzivtoy8-an-odiloby55oherc.png"><br><br>  I have to say that I just did the above screenshot, so the first process in the list has ‚Äúonly‚Äù about 20,000 descriptors.  And then, when I saw the problem for the first time, there were about 650,000 of them there. And who is our hero?  Bingo!  This is the process of SynTPEnhService.exe. <br><br>  And here in my head the whole puzzle develops.  SynTPEnhService.exe is part of the Synaptics touchpad driver.  It was installed only on laptops of a certain model in our office, on which the problem occurred.  A short observation showed that every 5 seconds this process starts a child process, SynTPEnh.exe, which closes after 1-2 seconds.  At the same time, the parent process continues to hold the descriptor of the child process, which leads to the leakage of descriptors.  One every 5 seconds.  These are 17 280 descriptors per day.  Leave the computer turned on for a week and now you have more than a hundred thousand hung handles.  My personal computer did not reboot for more than a month - hence the PIDs of new processes with numbers above half a million.  This also explains why the problem was reproduced on some laptops in our office, but did not occur on others the same: some of my colleagues reloaded their PCs every day, and someone, like me, left them on for the night . <br><br>  By the way, at this point I remembered that I had already read about some problem with the Synaptics touchpad drivers.  Having rummaged a little, I found <a href="https://randomascii.wordpress.com/2017/09/05/hey-synaptics-can-you-please-stop-polling/">this article</a> written by Bruce Dawson (many translations of his articles were published at different times on Habr√©, but not this particular one).  There he describes the problem of memory leakage due to this endless restart of the SynTPEnh.exe process, but says nothing about the problem of handle leaks, so my find is still different from it. <br><br><h3>  Solution to the problem </h3><br>  So, the touchpad driver "eats" hundreds of thousands of handles - and so what?  And the fact that the NtQuerySystemInformation (SystemHandleInformation, ...) function written back in the days of Windows NT had (and has) some quite limited internal buffer.  I have not found an exact indication of its size anywhere, but obviously it was not designed for a million descriptors.  As a result, the function returns them ‚Äúas much as they can,‚Äù which means that among them it may or may not be the desired one. <br><br>  What to do?  As Rick from the animated series ‚ÄúRick and Morty‚Äù said: ‚ÄúWhen you invent teleportation, you immediately discover an unpleasant thing: you are the last in the Universe who invented it‚Äù.  As it turned out, Microsoft realized this problem with the limited buffer in NtQuerySystemInformation when calling it with the SystemHandleInformation argument already 20 years ago and therefore, starting with WindowsXP, they added another (and also undocumented) argument to the SystemExtendedHandleInformation function from WindowsXP.  When you call NtQuerySystemInformation (SystemExtendedHandleInformation, ...), all descriptors in the system will be returned, no matter how many.  Well, or rather, I do not know for sure, maybe there are some restrictions for this argument, but the fact that he can return 800,000 descriptors in the state is for sure. <br><br>  On the net, you can find examples of using SystemExtendedHandleInformation, for example, <a href="">this one</a> .  In general, everything is the same there, other structures are simply used, and that is all. <br><br>  It was a cautionary tale about using Widnows' undocumented arguments, which can be very useful, but it requires careful testing and readiness for non-standard problems. </div><p>Source: <a href="https://habr.com/ru/post/433906/">https://habr.com/ru/post/433906/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433896/index.html">Using machine learning is not difficult. Enough for a week ...</a></li>
<li><a href="../433898/index.html">Digest MBLT DEV :: release ‚Ññ200</a></li>
<li><a href="../433900/index.html">ICQ is dead. Long live ICQ?</a></li>
<li><a href="../433902/index.html">Repetition for the programmer: why it is important to solve similar problems</a></li>
<li><a href="../433904/index.html">Jira DataCenter - what is it? How does it work? How to deploy?</a></li>
<li><a href="../433908/index.html">Tetris on C # in 100 lines</a></li>
<li><a href="../433910/index.html">Thoughts on Rust 2019</a></li>
<li><a href="../433912/index.html">Want to attract the best engineers? Open code</a></li>
<li><a href="../433916/index.html">Go Community in Kazan and our meetings</a></li>
<li><a href="../433918/index.html">Why is the web so complicated?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>