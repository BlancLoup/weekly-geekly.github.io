<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CEF, Angular 2 using .Net Core class events</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a continuation of the article CEF, ES6, Angular 2, TypeScript using .Net Core classes to expand capabilities . 

 As expected, she did not att...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CEF, Angular 2 using .Net Core class events</h1><div class="post__text post__text-html js-mediator-article">  This is a continuation of the article <a href="https://habrahabr.ru/post/320960/">CEF, ES6, Angular 2, TypeScript using .Net Core classes to expand capabilities</a> . <br><br>  As expected, she did not attract much attention.  But many thanks to those who are interested in my work.  It is you who give me the incentive to continue research. <br><br>  I want to stay a bit at <a href="https://en.wikipedia.org/wiki/Chromium_Embedded_Framework">CEF</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is a cross-platform browser (with the kernel used by Google Chrome), with unlimited extensions due to the use of native C ++, which allows you to write a full-fledged cross-platform dext-based application with UI. <br><br>  In addition, <a href="http://4pda.ru/2017/02/06/335097/">Chrome 57 will bring support for C and C ++ languages ‚Äã‚Äãfor websites.</a> <br><br>  Today I will show how to use the events of the objects .Net Core classes in Angular 2. <br>  Many people after reading my first article argued that HTTP services can be used instead of using .Net classes. <br><br>  But with events we can make a full-fledged dextup application using trading equipment, exchanging data using various protocols, using instant messengers and so on. <br><br>  For example, take a class with events. <br><a name="habracut"></a><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EventTest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; EventWithTwoParameter; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; EventWithOneParameter; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action EventWithOutParameter; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsRun = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { EventWithTwoParameter?.Invoke(DateTime.Now.ToString(), <span class="hljs-number"><span class="hljs-number">1</span></span>); EventWithOneParameter?.Invoke(DateTime.UtcNow.ToString()); EventWithOutParameter?.Invoke(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsRun) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; IsRun = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (IsRun) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.Delay(<span class="hljs-number"><span class="hljs-number">2000</span></span>); Test(); } } }</code> </pre> <br>  Now we can use this class in Angular 2: <br><br><pre> <code class="hljs pgsql">export <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> TestEventComponent { EventsRes: EventRes[] = []; WOWE: WrapperObjectWithEvents; test: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>; EventTest: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>; constructor(private ngZone: NgZone) { let Net = NetObject.NetWrapper; //    . this.EventTest = Net.GetType("TestDllForCoreClr.EventTest", "TestDllForCoreClr"); //   this.test = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> this.EventTest(); //    ,     //    . this.CreateWrapperForEvents(this.test); } //        //   . //  <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>:  //   // arg1:<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.String // arg2:<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Int32 <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> EventWithTwoParameter(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>) { this.AddComment("EventWithTwoParameter", NetObject.NetWrapper.toString(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>(NetObject.FlagDeleteObject); } //  <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.String <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> EventWithOneParameter(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>) { this.AddComment("EventWithOneParameter ",NetObject.NetWrapper.toString(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> EventWithOutParameter(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>) { this.AddComment("EventWithOutParameter", NetObject.NetWrapper.toString(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)); } CreateWrapperForEvents(obj: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>): <span class="hljs-type"><span class="hljs-type">void</span></span> { let wrapForEvents = NetObject.GetWrapperForObjectWithEvents(obj, this.ngZone); wrapForEvents.AddEventHandler("EventWithTwoParameter", this.EventWithTwoParameter.bind(this)); wrapForEvents.AddEventHandler("EventWithOneParameter", this.EventWithOneParameter.bind(this)); wrapForEvents.AddEventHandler("EventWithOutParameter", this.EventWithOutParameter.bind(this)); //   wrapForEvents   this.WOWE = wrapForEvents; }</code> </pre> <br>  Well, do not forget to clear the links on the .Net side when the component is destroyed: <br><br><pre> <code class="hljs kotlin">ngOnDestroy() { NetObject.DeleteNetObjets(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.EventTest, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.test); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.WOWE.Close(); alert(<span class="hljs-string"><span class="hljs-string">"    .Net ="</span></span>+Net.CountItemsInStore()); }</code> </pre><br>  You can unsubscribe from events in three ways. <br><br>  // get the result of the subscribe method of the subject Subject. <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.AddEventHandlerResult= wrapForEvents.AddEventHandler(<span class="hljs-string"><span class="hljs-string">"EventWithTwoParameter"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.EventWithTwoParameter.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>));</code> </pre> <br>  And using it we will describe from the event: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.AddEventHandlerResult.unsubscribe();</code> </pre> <br>  But events from .Net will be processed on the side of JS. <br><br>  The following two options speak for themselves. <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.WOWE.RemoveEventHandler(<span class="hljs-string"><span class="hljs-string">"EventWithTwoParameter"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.WOWE.RemoveAllEventHandler();</code> </pre> <br>  Get the text of the TS module to describe the events can be obtained as follows: <br><br><pre> <code class="hljs kotlin">let DescribeMethodsTS= Net.GetType(<span class="hljs-string"><span class="hljs-string">"NetObjectToNative.DescribeMethodsTS"</span></span>, <span class="hljs-string"><span class="hljs-string">"NetObjectToNative"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.CodeModule = DescribeMethodsTS.GetCodeModuleTS(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.EventTest);</code> </pre> <br>  What is NgZone for you can read here.  <a href="http://www.sdblog.ru/archives/zony-i-change-detection-v-ionic-2-i-angular-2/">What are Zones?</a> <br><br>  We now turn to the inside story.  Dynamic compilation is used to get event wrappers.  The process is described in detail in <a href="https://habrahabr.ru/post/309850/">1C, .Net Core.</a>  <a href="https://habrahabr.ru/post/309850/">Dynamic compilation of a wrapper class for receiving events of a .Net object in 1C</a> <br><br>  Some changes have been made to CEF: <br><br><div class="spoiler">  <b class="spoiler_title">Event dynamic wrapper code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//            CEF public class ClassForEventCEF { EventInfo EI; public string EventKey; public IntPtr CppHandler; public object WrapperForEvent; public ClassForEventCEF(object WrapperForEvent, string EventKey, EventInfo EI, IntPtr CppHandler) { this.EventKey = EventKey; this.EI = EI; this.CppHandler = CppHandler; this.WrapperForEvent = WrapperForEvent; //    EI.AddEventHandler(WrapperForEvent, new System.Action&lt;object&gt;(CallEvent)); } public void CallEvent(object value) { IntPtr ResIntPtr = AutoWrap.AllocMem(48); var EventKeyPtr = WorkWithVariant.WriteStringInIntPtr(EventKey); WorkWithVariant.SetObjectInIntPtr(AutoWrap.WrapObject(value), ResIntPtr); //      CEF //        AutoWrap.EventCall(CppHandler, EventKeyPtr, ResIntPtr); } public void RemoveEventHandler() { EI.RemoveEventHandler(WrapperForEvent, new System.Action&lt;object&gt;(CallEvent)); } }</span></span></code> </pre><br>  This class is dynamically generated: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WrapperForEventTestDllForCoreClr_EventTest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IntPtr CppHandler; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TestDllForCoreClr.EventTest Target; Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, ClassForEventCEF&gt; EventStoage=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, ClassForEventCEF&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; EventWithTwoParameter; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; EventWithOneParameter; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; EventWithOutParameter; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WrapperForEventTestDllForCoreClr_EventTest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr CppHandler, TestDllForCoreClr.EventTest Target</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.CppHandler = CppHandler; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Target = Target; Target.EventWithTwoParameter += (arg1,arg2) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (EventWithTwoParameter!=<span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> EventWithTwoParameterObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> {arg1=arg1,arg2=arg2}; EventWithTwoParameter(EventWithTwoParameterObject); } }; Target.EventWithOneParameter += (obj) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (EventWithOneParameter!=<span class="hljs-literal"><span class="hljs-literal">null</span></span>) EventWithOneParameter(obj); }; Target.EventWithOutParameter += () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (EventWithOutParameter!=<span class="hljs-literal"><span class="hljs-literal">null</span></span>) EventWithOutParameter(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddEventHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> EventKey, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> EventName</span></span></span><span class="hljs-function">)</span></span> { EventInfo ei = GetType().GetEvent(EventName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> forEvent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassForEventCEF(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,EventKey, ei,CppHandler); EventStoage.Add(EventKey, forEvent); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveEventHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> EventKey</span></span></span><span class="hljs-function">)</span></span> { ClassForEventCEF cfe = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (EventStoage.TryGetValue(EventKey,<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> cfe)) { EventStoage.Remove(EventKey); cfe.RemoveEventHandler(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveAllEventHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cfe <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> EventStoage.Values) cfe.RemoveEventHandler(); EventStoage.Clear(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr Self, TestDllForCoreClr.EventTest Target</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WrapperForEventTestDllForCoreClr_EventTest(Self, Target); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Func&lt;IntPtr, TestDllForCoreClr.EventTest, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(WrapperForEventTestDllForCoreClr_EventTest.CreateObject);</code> </pre><br></div></div><br>  Well, on the JS side, the event is handled like this: <br><br><div class="spoiler">  <b class="spoiler_title">TS event wrapper code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> EventEmitter{ <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> subject = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Subject&lt;<span class="hljs-keyword"><span class="hljs-keyword">any</span></span>&gt;(); constructor(private ngZone: NgZone) { // this.data = Observable.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>((observer: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>) =&gt; this.dataObserver = &lt;Observer&lt;<span class="hljs-keyword"><span class="hljs-keyword">any</span></span>&gt;&gt;observer); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> subscribe(EventHandler: (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>) =&gt; <span class="hljs-type"><span class="hljs-type">void</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.subject.subscribe({ next: (v) =&gt; this.ngZone.run(()=&gt; EventHandler(v)) }); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> emit(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>) { this.subject.next(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Complete() { this.subject.complete(); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> EventItem { constructor(<span class="hljs-built_in"><span class="hljs-built_in">public</span></span> EventKey: string, <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Event:EventEmitter){} } //EventEmitter export <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> WrapperObjectWithEvents { //     EventKey  EventEmitter EventsList = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Map&lt;string, EventItem&gt;(); //  EventKey  EventEmitter EventEmittersList = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Map&lt;string, EventEmitter&gt;(); constructor(private NetTarget: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>, private ngZone: NgZone) { }; //       .Net <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> RaiseEvent(EventKey: string, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>) { //   ,    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.EventEmittersList.has(EventKey)) { let Event = this.EventEmittersList.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(EventKey); Event.emit(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> AddEventHandler(EventName: string, EventHandler: (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>) =&gt; <span class="hljs-type"><span class="hljs-type">void</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> { let ei: EventItem; let isFirst = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.EventsList.has(EventName)) { let EventKey = <span class="hljs-keyword"><span class="hljs-keyword">window</span></span>.CallNetMethod(<span class="hljs-number"><span class="hljs-number">0</span></span>, "GetUniqueString"); let Event = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> EventEmitter(this.ngZone); ei = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> EventItem(EventKey, Event); this.EventsList.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(EventName, ei); this.EventEmittersList.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(EventKey, Event); NetObject.EventCallers.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(EventKey, this.RaiseEvent.bind(this)); isFirst = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ei = this.EventsList.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(EventName); // let res = ei.Event.subscribe(this.ngZone.run(() =&gt;EventHandler)); let res = ei.Event.subscribe((<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>) =&gt; { EventHandler(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isFirst) this.NetTarget.AddEventHandler(ei.EventKey, EventName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> RemoveEventHandler(EventName: string) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.EventsList.has(EventName)) { let ei = this.EventsList.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(EventName); let EventKey = ei.EventKey this.NetTarget.RemoveEventHandler(EventKey); NetObject.EventCallers.<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(EventKey); this.EventEmittersList.<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(EventKey); this.EventsList.<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(EventName); ei.Event.Complete(); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> RemoveAllEventHandler() { this.NetTarget.RemoveAllEventHandler(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (let ei <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> this.EventsList.<span class="hljs-keyword"><span class="hljs-keyword">values</span></span>()) { { NetObject.EventCallers.<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(ei.EventKey); ei.Event.Complete(); } this.EventsList.clear(); this.EventEmittersList.clear(); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>() { this.RemoveAllEventHandler(); this.NetTarget(NetObject.FlagDeleteObject); } }</code> </pre><br></div></div><br><br>  By the way, a good article on the topic. <a href="https://habrahabr.ru/company/nixsolutions/blog/261031/">Jet extensions in .Net</a> <br>  As for gluttony <br>  CEF with the initial page without Angular 2, but with loaded .Net Core assemblies.  takes 20 mb <br>  With the call of unpretentious methods comes to 30mb <br>  If you connect a dynamic compilation, it grows to 70 mb <br><br>  If you connect Angular 2, then the size immediately reaches 90 MB. <br><br>  But even further I use dynamic compilation. Size does not go over 100 MB <br><br>  It should be borne in mind that 2 garbage collectors are working. <br>  It is quite acceptable. <br><br>  It is not difficult to make the transfer of JS objects and functions to the .Net side only for the duration of the method call. <br><br>  Or, by analogy with Net, make a JS object storage.  Fortunately, in .Net there are finalizers and it is not so critical to follow the release of links. <br><br>  Although the development of all downloaded 5 people.  But in fact, there are a lot of interne for programmers in TS, C # and the bundles between C ++ and .Net. <br><br>  If someone is interested, then the projects and sources can be downloaded <a href="https://yadi.sk/d/0If7C5jZ3CEhmf">here</a> . <br><br>  A brief description of the content.  In the cefsimple \ Release \ directory there is an executable file with libraries and the initial page Test.html.  In the cefsimple \ NetObjectToNative \ directory <br>  There are all files for sharing between CEF and .Net Core.  ManagedDomainLoader and ClrLoader are responsible for downloading .Net Core, receiving and passing methods for exchanging data. <br><br>  Handlers for exchange between JS and CEF are implemented in CefV8HandlersForNet.  NetConverter converts data between Net and Cef. <br><br>  In NetObjectToCEF are files that implement the exchange with CEF.  In TestDllForCoreClr lie all used examples for Test. <br><br>  In the file TestTypeScript \ TestTypeScript \ app \ there are ts files that implement the proxy.  NetProxy.ts file that implements the proxy. <br><br>  home.component.ts test with AngleSharp.  counter.component.ts various feature tests.  TestSpeed.ts speed tests. <br><br>  Also a project without node_modules.  install through a call in the TestTypeScript directory npm install. <br><br>  The essence of the tests is as follows.  Run TestTypeScript and CefProgects \ cefsimple \ Release \ cefsimple.exe.  On the initial page, you can try the tests on JS.  To use TS tests, you need to go to the site that you need to specify in the field below ‚ÄúEnter the site address‚Äú to go to it ‚Äù.‚Äù  There are three tests. <br><br>  If you want to compile cefsimple.  Then download the 32-bit Standard Distribution from here and replace the tests \ cefsimple \ cc and h files in the directory and copy the NetObjectToNative directory. <br><br>  To use VS 2015, type cmake.exe -G "Visual Studio 14" in the root directory of the CEF. <br><br>  For VS 2017 cmake.exe -G "Visual Studio 15 2017". </div><p>Source: <a href="https://habr.com/ru/post/321452/">https://habr.com/ru/post/321452/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321440/index.html">How to enable JTAG debugging via USB</a></li>
<li><a href="../321442/index.html">Openstack. Detective story or where the connection is lost? Part one</a></li>
<li><a href="../321444/index.html">We read Google tables from the web application</a></li>
<li><a href="../321446/index.html">How does it feel to be a developer in Russia when you're forty</a></li>
<li><a href="../321448/index.html">Load balancing and fault tolerance in Odnoklassniki</a></li>
<li><a href="../321454/index.html">Connecting Facebook SDK for Xamarin.Forms</a></li>
<li><a href="../321456/index.html">The method of recursive coordinate bisection for decomposition of computational grids</a></li>
<li><a href="../321458/index.html">How we made the application of the international loyalty program PINS: case</a></li>
<li><a href="../321460/index.html">Games do not have to entertain</a></li>
<li><a href="../321462/index.html">Changes in the procedure for issuing a certificate for signing the code for Certum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>