<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Release cycle for Infrastructure as Code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On the Internet, you can find quite a few articles on the topic Infrastructure as Code, SaltStack utilities, Kitchen-CI and so on, however, as I have ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Release cycle for Infrastructure as Code</h1><div class="post__text post__text-html js-mediator-article"><p>  On the Internet, you can find quite a few articles on the topic Infrastructure as Code, SaltStack utilities, Kitchen-CI and so on, however, as I have not seen various IaC examples, they often remain only code, as a rule, with the division into branches in VCS corresponding the name of the environment type, for example dev / int, is possible even with tags, and as a rule, there is no need to talk about a full-fledged development cycle of configurations.  In any case, with companies with which this situation is familiar, I did not find any articles. <br>  Maybe it is understandable - total Agile and "once and in production." <br>  I will try to rectify the situation of this article. </p><a name="habracut"></a><br><h3 id="kratkoe-opisanie-raboty">  Brief job description </h3><br><p>  In this article, I will talk about solutions in the field of configuration and management of infrastructure solutions for projects of a platform consisting of 20 different components, not counting the analytical unit, with a total of 70 "server units" - just in such systems, there is more than enough space for creativity and engineering. </p><br><p>  To be honest, not such a large number, especially if all this is controlled and configured automatically.  Could tell more about the system, but to be honest, about the same thing, just smeared on a greater number of instances, and the "enterprise", read as kostulnosti more. <br>  An example of the environment so for the seed. </p><br><p>  The described platform is controlled entirely via SaltStack, the creation and launch of new instances is naturally named by the SaltCloud module.  Of course, each service platform must be configured, but do not forget about the configuration of system services. </p><br><p>  So, for example, the configuration of the most ordinary web server will include not only nginx / httpd and the site configuration itself, but also system services: </p><br><ul><li>  network configuration </li><li>  configure ssh daemon </li><li>  host authorization </li><li>  tcp_wrapper setting </li><li>  iptables </li><li>  selinux / apparmor </li><li>  time synchronization </li><li>  logging </li><li>  audit </li></ul><br><p>  Do not forget about the DNS records for the site, issue and re-issue of certificates. <br>  If you describe the configuration for each service separately, you can go crazy, even if you just copy-paste it. </p><br><p>  Fortunately, SaltStack, as well as most other configuration management systems, has reproducible configuration blocks called <a href="https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html">Formulas</a> .  However, copying formulas, or imposing them directly from the repository, even if using a tag or a special release brunch, is not entirely correct from the point of view of stabilization and reproducibility - the tag can be rewritten, the brunch is updated, and monitor for a valid revision and tighten it is too difficult because  it is necessary to keep a list of correspondences of dependencies between formulas relying on revisions.  To this end, the process of versioning modules and dependencies was invented a long time ago.  Yes, of course, it is possible, along with the revision, to maintain the dependency on the version, however VCS were invented to maintain the history of file changes, and not to fix release artifacts. </p><br><p>  You should not also forget about the situation when you need to use formulas in the customer‚Äôs environment, and, to put it mildly, it is not safer to open access to the server of the company‚Äôs repositories from the customer‚Äôs environment. <br>  SaltStack provides a component that allows you to work with binary packages with versions. </p><br><p>  This component is called <a href="https://docs.saltstack.com/en/latest/topics/spm/">SaltStack Packet Manager</a> or SPM for short.  At its core, the resulting package is tar, compressed bzip with meta information, for which the <a href="https://docs.saltstack.com/en/latest/topics/spm/spm_formula.html">FORMULA</a> file is responsible.  It is worth noting that to maintain the repository, you also need to create a meta-information file generated in the presence of all stored artifacts in the repository, the principle is the same as that of the Yum repository.  There are several shortcomings in SPM, such as the inability to enumerate the list of formulas available in the repository, despite the fact that it tightens the metadata file that contains this information, specify the version of the formula dependency, but this is only due to the youth of SPM itself, it appeared if memory does not change, in version 2016.3. </p><br><h3 id="obekt-reliza">  Release object </h3><br><p>  Let's still get to the point.  To do this, consider the configuration of the <a href="https://github.com/gitbucket/gitbucket">Gitbucket</a> service, who is not up to date - the open source git repository management system written in scala, with a fairly good API, a plug-in system, a pleasant and convenient web interface, perfectly compared to such masters as Bitbucket, GitHub, GitLab (without CI) and especially gorgeous compared to Beanstalk. </p><br><p>  So, as I said, it is written in scala, is a web application, so we need at least the following configurations - java, tomcat, nginx. <br>  We will use Kitchen-CI on the Docker host as a kitchen-salt provider. </p><br><p>  Let's take a look at the configuration directory structure just in case: </p><br><pre><code class="hljs ruby">gitbucket-formula <span class="hljs-params"><span class="hljs-params">|-- gitbucket |</span></span> <span class="hljs-params"><span class="hljs-params">|-- frontend |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>-- templates <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>-- nginx-http.conf <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>-- nginx-https.conf <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| `-- upstream.conf |</span></span> <span class="hljs-params"><span class="hljs-params">| `-- init.sls |</span></span> <span class="hljs-params"><span class="hljs-params">|-- plugins |</span></span> <span class="hljs-params"><span class="hljs-params">| `-- init.sls |</span></span> <span class="hljs-params"><span class="hljs-params">|-- templates |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>-- database.conf <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-string"><span class="hljs-string">`-- gitbucket.conf | |-- init.sls | `</span></span>-- settings.jinja <span class="hljs-params"><span class="hljs-params">|-- test |</span></span> <span class="hljs-string"><span class="hljs-string">`-- integration | |-- fe | | `</span></span>-- serverspec <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-string"><span class="hljs-string">`-- frontend_spec.rb | |-- fe-ssl | | `</span></span>-- serverspec <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-string"><span class="hljs-string">`-- frontend_ssl_spec.rb | |-- gitbucket | | `</span></span>-- serverspec <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-string"><span class="hljs-string">`-- gitbucket_spec.rb | `</span></span>-- helpers <span class="hljs-params"><span class="hljs-params">| `-- serverspec |</span></span> <span class="hljs-params"><span class="hljs-params">|-- fe_shared_spec.rb |</span></span> <span class="hljs-params"><span class="hljs-params">|-- fe_ssl_shared_spec.rb |</span></span> <span class="hljs-string"><span class="hljs-string">`-- gitbucket_shared_spec.rb |-- .editorconfig |-- .gitattributes |-- .gitconfig |-- .gitignore |-- .kitchen.yml |-- pillar.example |-- FORMULA `</span></span>-- README.md</code> </pre> <br><p>  As you can see, the formula contains not only the basic service configuration parameters, but also tests written for serverspec in the test directory, the FORMULA meta information file, the configuration descriptor for kitchen, and the git repository service configuration files. </p><br><p>  At the moment, we are interested in exactly the .kitchen.yml file: </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">driver:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> docker <span class="hljs-symbol"><span class="hljs-symbol">use_sudo:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">require_chef_omnibus:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">socket:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">tcp:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/dckhub.platops.org:2375 volume: /sys</span></span><span class="hljs-regexp"><span class="hljs-regexp">/fs/cgroup</span></span> <span class="hljs-symbol"><span class="hljs-symbol">cap_add:</span></span> - SYS_ADMIN <span class="hljs-symbol"><span class="hljs-symbol">provisioner:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> salt_solo <span class="hljs-symbol"><span class="hljs-symbol">formula:</span></span> gitbucket <span class="hljs-symbol"><span class="hljs-symbol">salt_bootstrap_options:</span></span> <span class="hljs-string"><span class="hljs-string">'stable 2016.11'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">dependencies:</span></span> - <span class="hljs-symbol"><span class="hljs-symbol">path:</span></span> ../tomcat-formula <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> tomcat - <span class="hljs-symbol"><span class="hljs-symbol">path:</span></span> ../oracle-jdk-formula <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> oracle-jdk - <span class="hljs-symbol"><span class="hljs-symbol">path:</span></span> ../nginx-formula <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> nginx <span class="hljs-symbol"><span class="hljs-symbol">state_top:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">base:</span></span> <span class="hljs-string"><span class="hljs-string">'*'</span></span>: - gitbucket <span class="hljs-symbol"><span class="hljs-symbol">pillars:</span></span> top.<span class="hljs-symbol"><span class="hljs-symbol">sls:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">base:</span></span> <span class="hljs-string"><span class="hljs-string">'*'</span></span>: - gitbucket gitbucket.<span class="hljs-symbol"><span class="hljs-symbol">sls:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">tomcat:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">instance:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> <span class="hljs-string"><span class="hljs-string">'gitbucket'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">connport:</span></span> <span class="hljs-string"><span class="hljs-string">'8080'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">sslport:</span></span> <span class="hljs-string"><span class="hljs-string">'8443'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">xms:</span></span> <span class="hljs-string"><span class="hljs-string">'512M'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">xmx:</span></span> <span class="hljs-string"><span class="hljs-string">'1G'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mdmsize:</span></span> <span class="hljs-string"><span class="hljs-string">'256M'</span></span> frontend.<span class="hljs-symbol"><span class="hljs-symbol">sls:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">gitbucket:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">frontend:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">enabled:</span></span> False <span class="hljs-symbol"><span class="hljs-symbol">ssl:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">enabled:</span></span> False <span class="hljs-symbol"><span class="hljs-symbol">external:</span></span> False <span class="hljs-symbol"><span class="hljs-symbol">crt:</span></span> <span class="hljs-params"><span class="hljs-params">| -----</span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">BEGIN</span></span></span><span class="hljs-params"> CERTIFICATE----- C    ssl  localhost -----</span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">END</span></span></span><span class="hljs-params"> CERTIFICATE----- key: |</span></span> -----<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> RSA PRIVATE KEY-----    -----<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> RSA PRIVATE KEY----- <span class="hljs-symbol"><span class="hljs-symbol">platforms:</span></span> - <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> debian <span class="hljs-symbol"><span class="hljs-symbol">driver_config:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">debian:</span></span><span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-symbol"><span class="hljs-symbol">run_command:</span></span> /sbin/init <span class="hljs-symbol"><span class="hljs-symbol">provision_command:</span></span> - apt-get install -y --no-install-recommends wget curl tar mc iproute apt-utils apt-transport-https locales - localedef --no-archive -c -i en_US -f UTF-<span class="hljs-number"><span class="hljs-number">8</span></span> en_US.UTF-<span class="hljs-number"><span class="hljs-number">8</span></span> &amp;&amp; localedef --no-archive -c -i ru_RU -f UTF-<span class="hljs-number"><span class="hljs-number">8</span></span> ru_RU.UTF-<span class="hljs-number"><span class="hljs-number">8</span></span> - <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> centos <span class="hljs-symbol"><span class="hljs-symbol">driver_config:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> dckreg.platops.org/centos-<span class="hljs-symbol"><span class="hljs-symbol">systemd:</span></span><span class="hljs-number"><span class="hljs-number">7.3</span></span>.<span class="hljs-number"><span class="hljs-number">1611</span></span> <span class="hljs-symbol"><span class="hljs-symbol">run_command:</span></span> /sbin/init <span class="hljs-symbol"><span class="hljs-symbol">provision_command:</span></span> - yum install -y -q wget curl tar mc iproute - localedef --no-archive -c -i en_US -f UTF-<span class="hljs-number"><span class="hljs-number">8</span></span> en_US.UTF-<span class="hljs-number"><span class="hljs-number">8</span></span> &amp;&amp; localedef --no-archive -c -i ru_RU -f UTF-<span class="hljs-number"><span class="hljs-number">8</span></span> ru_RU.UTF-<span class="hljs-number"><span class="hljs-number">8</span></span> - sed -i -r <span class="hljs-string"><span class="hljs-string">'s/^(.*pam_nologin.so)/#\1/'</span></span> /etc/pam.d/sshd - sed -i <span class="hljs-string"><span class="hljs-string">'s/tsflags=nodocs//g'</span></span> /etc/yum.conf <span class="hljs-symbol"><span class="hljs-symbol">suites:</span></span> - <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> gitbucket - <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> fe <span class="hljs-symbol"><span class="hljs-symbol">provisioner:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">pillars:</span></span> top.<span class="hljs-symbol"><span class="hljs-symbol">sls:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">base:</span></span> <span class="hljs-string"><span class="hljs-string">'*'</span></span>: - gitbucket - frontend frontend.<span class="hljs-symbol"><span class="hljs-symbol">sls:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">gitbucket:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">frontend:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">enabled:</span></span> True - <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> fe-ssl <span class="hljs-symbol"><span class="hljs-symbol">provisioner:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">pillars:</span></span> top.<span class="hljs-symbol"><span class="hljs-symbol">sls:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">base:</span></span> <span class="hljs-string"><span class="hljs-string">'*'</span></span>: - gitbucket - frontend frontend.<span class="hljs-symbol"><span class="hljs-symbol">sls:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">gitbucket:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">frontend:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">enabled:</span></span> True <span class="hljs-symbol"><span class="hljs-symbol">url:</span></span> localhost <span class="hljs-symbol"><span class="hljs-symbol">ssl:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">enabled:</span></span> True</code> </pre> <br><p>  In the Driver section, we specify the parameters for working with the docker host, a local address can also be specified, in addition, other drivers can be used, for example, <a href="https://github.com/test-kitchen/kitchen-vagrant">vagrant</a> , <a href="https://github.com/test-kitchen/kitchen-ec2">ec2</a> and <a href="https://github.com/test-kitchen%3Futf8%3D%25E2%259C%2593%26q%3Ddriver">others</a> . <br>  The Provisioner section is responsible for the configuration needed by SaltStack for the configuration rolling, it is here that we establish the dependencies listed above for this formula, the service configurations transmitted via pillar. <br>  The Platforms section defines platforms, read as the operating systems on which testing will be performed. <br>  And finally Suites, in this section we set the types of configurations that we will test on the platforms listed above.  In the above descriptor for Kitchen, testing of three types is configured: </p><br><ul><li>  net service setup - java + tomcat 8 + gitbucket </li><li>  setup with nginx over HTTP only </li><li>  configure with nginx with HTTP / S </li></ul><br><p>  A total of 3 configurations will be tested for each OS - Debian Jessie and CentOS 7. </p><br><p>  As you can see from the directory view, there is a test folder in it, which contains the separation according to the testing suites - gitbucket, fe, fe-ssl, also pay attention to the helpers folder, it contains shared_examples for each type of testing, in order not to write the same tests. </p><br><h3 id="zavisimosti">  Dependencies </h3><br><p>  Let's focus our attention on the Provisioner section, in addition to the pillar configuration and the parameters of the bootstrap for SaltStack, this section also contains information about the dependencies of this configuration, which should be available by relative or absolute paths during the configuration process.  As you can see, only those configurations that are directly involved in testing this service are listed. <br>  Of course, we can add those 9 system services listed above to fully cover the instance configuration, but first, such tests will take hours, for example, the Jenkins formula with installing all the necessary plug-ins for two OS families with 3 configurations for each lasts about an hour, - secondly, depending on the specific infrastructure, their set will be different and the number of such sets tends to infinity, and in the third case, such testing will still be performed when knurling on the integration environment. </p><br><p>  Now that we are familiar with the subject of the release, we can proceed to the actual construction of the release configuration process. <br>  We will use the familiar Jenkins as a sceduler, Nexus OSS 2 will be used to store artifacts. </p><br><h3 id="reliznyy-payplayn">  Release Pipeline </h3><br><p>  It's time to write a Jenkinsfile with a description of everything you need to run and so beautiful little squares with stages. </p><br><p><img src="https://habrastorage.org/web/066/16b/a0c/06616ba0c0344540b4764af3e11c07dd.png"></p><br><p>  As a launch node, we will start, with the help of the Docker-cloud plugin, a container in which all the components we need are installed - ruby, test-kitchen, kitchen-salt, kitchen-docker and, in fact, the docker-engine itself, to be able to work with docker host. </p><br><p>  First, download the repository with the basic formula in the directory with the repository name.  As we have already said, we need other formulas as dependencies, it‚Äôs time to get a list of them and pull them off into a workspace.  Please note that we use the standard naming of repositories, so we can use relative paths to the directory with the dependency by the repository name. </p><br><pre> <code class="hljs bash">node(<span class="hljs-string"><span class="hljs-string">"kitchen-ci"</span></span>) { try { stage(<span class="hljs-string"><span class="hljs-string">'Checkout repository'</span></span>) { checkout changelog: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, poll: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, scm: [ <span class="hljs-variable"><span class="hljs-variable">$class</span></span> : <span class="hljs-string"><span class="hljs-string">'GitSCM'</span></span>, branches : [ [ name: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${branch}</span></span></span><span class="hljs-string">"</span></span> ] ], doGenerateSubmoduleConfigurations: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, extensions : [ [ <span class="hljs-variable"><span class="hljs-variable">$class</span></span>: <span class="hljs-string"><span class="hljs-string">'RelativeTargetDirectory'</span></span>, relativeTargetDir: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${repository}</span></span></span><span class="hljs-string">"</span></span> ] ], userRemoteConfigs : [ [ url: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${gitRepositoryUrl}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${repository}</span></span></span><span class="hljs-string">.git"</span></span> ] ] ] dir(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${repository}</span></span></span><span class="hljs-string">"</span></span>) { gitCommit = sh(returnStdout: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, script: <span class="hljs-string"><span class="hljs-string">"git rev-parse HEAD"</span></span>).trim() } currentBuild.displayName = <span class="hljs-string"><span class="hljs-string">"#</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${env.BUILD_NUMBER}</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${repository}</span></span></span><span class="hljs-string">"</span></span> currentBuild.description = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${branch}</span></span></span><span class="hljs-string">(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${gitCommit.take(7)}</span></span></span><span class="hljs-string">)"</span></span> } } catch (err) { currentBuild.result = failedStatus } def kitchenConfig = readYaml(file: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${repository}</span></span></span><span class="hljs-string">/.kitchen.yml"</span></span>) def formulaMetadata = readYaml(file: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${repository}</span></span></span><span class="hljs-string">/FORMULA"</span></span>) def dependencies = kitchenConfig.provisioner.dependencies def platforms = kitchenConfig.platforms try { stage(<span class="hljs-string"><span class="hljs-string">'Get formula dependencies'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (dependency <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dependencies) { depRepo = dependency[<span class="hljs-string"><span class="hljs-string">'path'</span></span>] - ~/\.{2}\// println <span class="hljs-string"><span class="hljs-string">"Prepare \"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${depRepo}</span></span></span><span class="hljs-string">\" as dependency"</span></span> checkout changelog: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, poll: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, scm: [ <span class="hljs-variable"><span class="hljs-variable">$class</span></span> : <span class="hljs-string"><span class="hljs-string">'GitSCM'</span></span>, branches : [ [ name: <span class="hljs-string"><span class="hljs-string">'*/master'</span></span> ] ], doGenerateSubmoduleConfigurations: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, extensions : [ [ <span class="hljs-variable"><span class="hljs-variable">$class</span></span>: <span class="hljs-string"><span class="hljs-string">'RelativeTargetDirectory'</span></span>, relativeTargetDir: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${depRepo}</span></span></span><span class="hljs-string">"</span></span> ] ], userRemoteConfigs : [ [ url: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${gitRepositoryUrl}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${depRepo}</span></span></span><span class="hljs-string">.git"</span></span> ] ] ] } } } catch (err) { currentBuild.result = failedStatus }</code> </pre> <br><p>  For simplicity, we do not specify the version of the dependency and download the latest stable from the wizard, however, this is easy to implement through the file versions that we install when successfully completing this pipeline to then tag along, or from the same binary repository. </p><br><p>  Also, we will run testing only for two types of platforms, solely in order not to reset the display of beautiful squares. </p><br><p><img src="https://habrastorage.org/web/b33/225/7f9/b332257f9f304c0982716608b44a3b29.png"></p><br><p>  The next step is actually launching testing of the targeted platform with the <code>kitchen verify</code> .  This command starts the container assembly, then rolls the SaltStack configuration, after which Kitchen runs the tests written in Serverspec: </p><br><pre> <code class="hljs kotlin"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (targetPlatform <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> targetPlatforms) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { stage(<span class="hljs-string"><span class="hljs-string">"Test integration with </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${targetPlatform}</span></span></span><span class="hljs-string">"</span></span>) { dir(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${repository}</span></span></span><span class="hljs-string">"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (platforms[<span class="hljs-string"><span class="hljs-string">'name'</span></span>].containsAll(targetPlatform.toLowerCase())) { ansiColor(<span class="hljs-string"><span class="hljs-string">'xterm'</span></span>) { sh <span class="hljs-string"><span class="hljs-string">"kitchen verify </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${targetPlatform.toLowerCase()}</span></span></span><span class="hljs-string">"</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { println <span class="hljs-string"><span class="hljs-string">"Skipping checks for \"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${targetPlatform}</span></span></span><span class="hljs-string">\" platform"</span></span> } } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { currentBuild.result = failedStatus } }</code> </pre> <br><p>  In the fe-ssl configuration, 42 tests are run, including those listed below: </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'serverspec'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:backend</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:exec</span></span> host_name = <span class="hljs-string"><span class="hljs-string">`cat /etc/hostname`</span></span> instance_name = <span class="hljs-string"><span class="hljs-string">'gitbucket'</span></span> nginx_confd = <span class="hljs-string"><span class="hljs-string">'/etc/nginx/conf.d'</span></span> nginx_keyd = <span class="hljs-string"><span class="hljs-string">'/etc/nginx/keys'</span></span> status_host = <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span> gitbucket_version = <span class="hljs-string"><span class="hljs-string">'4.10'</span></span> ssl_vhost = nginx_confd + <span class="hljs-string"><span class="hljs-string">'/90-'</span></span> + instance_name + <span class="hljs-string"><span class="hljs-string">'-https.conf'</span></span> certs = [ nginx_keyd + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + host_name.chomp + <span class="hljs-string"><span class="hljs-string">'.crt'</span></span>, nginx_keyd + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + host_name.chomp + <span class="hljs-string"><span class="hljs-string">'.key'</span></span>, ] ports = <span class="hljs-string"><span class="hljs-string">%w[ 443 ]</span></span> shared_examples_for <span class="hljs-string"><span class="hljs-string">'gitbucket nginx ssl frontend'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> describe <span class="hljs-string"><span class="hljs-string">'### Frontend SSL configuration ###'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> describe file(ssl_vhost) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it { should be_file } it { should be_owned_by <span class="hljs-string"><span class="hljs-string">'root'</span></span> } it { should be_grouped_into <span class="hljs-string"><span class="hljs-string">'root'</span></span> } it { should be_mode <span class="hljs-number"><span class="hljs-number">644</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> certs.each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|cert|</span></span> describe file(cert) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it { should be_file } it { should be_owned_by <span class="hljs-string"><span class="hljs-string">'root'</span></span> } it { should be_grouped_into <span class="hljs-string"><span class="hljs-string">'root'</span></span> } it { should be_mode <span class="hljs-number"><span class="hljs-number">600</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> ports.each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|port|</span></span> describe port(port) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it { should be_listening.with(<span class="hljs-string"><span class="hljs-string">'tcp'</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> describe <span class="hljs-string"><span class="hljs-string">'### Frontend SSL status ###'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> describe command(<span class="hljs-string"><span class="hljs-string">'curl -Iso /dev/null -w "%{http_code} %{redirect_url}" '</span></span>+ status_host ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> its(<span class="hljs-symbol"><span class="hljs-symbol">:stdout</span></span>) { should match <span class="hljs-string"><span class="hljs-string">'301 https://localhost/'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> describe command(<span class="hljs-string"><span class="hljs-string">'curl -ILso /dev/null -w "%{http_code}" --insecure '</span></span>+ status_host ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> its(<span class="hljs-symbol"><span class="hljs-symbol">:stdout</span></span>) { should match <span class="hljs-string"><span class="hljs-string">'200'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> describe command(<span class="hljs-string"><span class="hljs-string">'curl -sL --insecure '</span></span> +\ status_host +\ <span class="hljs-string"><span class="hljs-string">'|grep "header-version"|awk -F\'&gt;|&lt;\' \'{print $3}\''</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> its(<span class="hljs-symbol"><span class="hljs-symbol">:stdout</span></span>) { should match gitbucket_version } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p><img src="https://habrastorage.org/web/527/7ac/c60/5277acc601a34092a443d418e1952f6d.png"></p><br><p>  So, all the tests passed, then it is time to build the package and upload it to the binary artifacts repository. <br>  The artifact is <code>spm build</code> , and since we have already started the shell stage, we‚Äôll see the curl artifact. </p><br><pre> <code class="hljs kotlin"> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { stage(<span class="hljs-string"><span class="hljs-string">'Build and deploy SPM artifact'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentBuild.result != failedStatus) { withCredentials([[$<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">'UsernamePasswordMultiBinding'</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">credentialsId : binaryRepoCredentials</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">usernameVariable: 'USERNAME'</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">passwordVariable: 'PASSWORD']]) { dir</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${repository}</span></span></span><span class="hljs-string">"</span></span>) { sh <span class="hljs-string"><span class="hljs-string">"""#!/usr/bin/env bash sudo spm build . formula=\$(ls -1A </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${spmBuildDir}</span></span></span><span class="hljs-string">|grep '.spm') if [[ -n \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$formula</span></span></span><span class="hljs-string"> ]]; then response=\$(curl --compressed \ -u </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${env.USERNAME}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${env.PASSWORD}</span></span></span><span class="hljs-string"> \ -s -o /dev/null -w "%{http_code}\n" \ -A 'Jenkins POST Invoker' \ --upload-file </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${spmBuildDir}</span></span></span><span class="hljs-string">/\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$formula</span></span></span><span class="hljs-string"> \ </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${binaryRepoUrl}</span></span></span><span class="hljs-string">); if [[ \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$response</span></span></span><span class="hljs-string"> -ne 201 ]]; then echo "Something goes wrong! HTTP_CODE: \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$response</span></span></span><span class="hljs-string">"; exit 1; else echo "Formula \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$formula</span></span></span><span class="hljs-string"> deployed."; fi else echo "Couldn't find file"; exit 1; fi """</span></span> } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { println <span class="hljs-string"><span class="hljs-string">"We will not packing failed formulas"</span></span> } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { currentBuild.result = failedStatus }</code> </pre> <br><p><img src="https://habrastorage.org/web/62e/cda/a19/62ecdaa193d4428fa5adfdedc741a2db.png"></p><br><p>  This is almost all finished, it remains to put the tag on the current commit and run the <code>kitchen destroy</code> to remove all created containers. </p><br><pre> <code class="hljs perl"> try { stage(<span class="hljs-string"><span class="hljs-string">'Tag version in SCM'</span></span>) { currentTag = formulaMetadata[<span class="hljs-string"><span class="hljs-string">'version'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentBuild.result != failedStatus) { dir(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${repository}</span></span></span><span class="hljs-string">"</span></span>) { sh <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"#!/usr/bin/env bash if [[ \$(git tag -l|grep </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${currentTag}</span></span></span><span class="hljs-string">) ]]; then if [[ "</span></span>\$(git show-<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> --tags|<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> ${currentTag}|awk <span class="hljs-string"><span class="hljs-string">'{print \$1}'</span></span>|cut -b-<span class="hljs-number"><span class="hljs-number">7</span></span>)<span class="hljs-string"><span class="hljs-string">" != "</span></span>${gitCommit.take(<span class="hljs-number"><span class="hljs-number">7</span></span>)}<span class="hljs-string"><span class="hljs-string">" ]]; then echo "</span></span>Tag \<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${currentTag}</span></span></span><span class="hljs-string">\" will be updated."</span></span> git tag -d ${currentTag} git <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> origin :${currentTag} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> echo <span class="hljs-string"><span class="hljs-string">"Tag \"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${currentTag}</span></span></span><span class="hljs-string">\" already exists. Skipping."</span></span> fi <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> echo <span class="hljs-string"><span class="hljs-string">"Creating tag \"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${currentTag}</span></span></span><span class="hljs-string">\""</span></span> git tag ${currentTag} git <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> origin --tags fi <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" } } else { println "</span></span>We will <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> tag revision <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> failed formulas<span class="hljs-string"><span class="hljs-string">" } } } catch (err) { currentBuild.result = failedStatus } try { stage('Cleanup after tests') { dir("</span></span>${repository}<span class="hljs-string"><span class="hljs-string">") { sh "</span></span>kitchen destr<span class="hljs-string"><span class="hljs-string">" } } } catch (err) { currentBuild.result = failedStatus }</span></span></code> </pre> <br><p><img src="https://habrastorage.org/web/0f4/726/62f/0f472662f52b4a47a13498a7780c0f4d.png"></p><br><p>  Generally, in Kitchen-CI there is a <code>test</code> command that runs such stages as <code>destroy</code> , <code>create</code> , <code>converge</code> , <code>setup</code> , <code>verify</code> and again <code>destroy</code> , however some of our formulas use container linking in the testing process, for example, FreeIPA, which starts the server configuration first, checks its performance , then the container starts with the client's configuration and enters it into the domain of the linked server, but if you run <code>test</code> , the server will rise, test, and then be removed before raising the client.  That is why we use the <code>verify</code> command and the most recent stage in the pipeline is precisely the cleaning through <code>destroy</code> . </p><br><h3 id="rabotaem-s-repozitoriem">  We work with a repository </h3><br><p><img src="https://habrastorage.org/web/6a5/a5e/949/6a5a5e949d9b4fe9b31821edb0441fa0.png"></p><br><p>  The formula has been tested, a tag has been placed in the repository, the artifact has been deposited in the binary repository, but it is still not available for SaltStack - you need to update the meta-information, which requires running the <code>spm create_repo $DIR</code> command in the repository directory with all formulas. <br>  Nexus is also configured via SaltStack, and therefore SPM is installed on it locally, which we will use. <br>  Install the python-inotify module on the Nexus host and configure <a href="https://docs.saltstack.com/en/latest/topics/beacons/">SaltStack Beacon</a> for salt-minion, which will follow every five seconds changes in the formula directory: </p><br><pre> <code class="hljs pgsql">#/etc/salt/minion.d/beacons.conf beacons: inotify: <span class="hljs-type"><span class="hljs-type">interval</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> disable_during_state_run: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> /opt/nexus/data/<span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>/org.platops.salt.formulas: mask: - <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> - modify - <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> - attrib recurse: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> auto_add: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exclude</span></span>: - /opt/nexus/data/<span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>/org.platops.salt.formulas/SPM-METADATA - /opt/nexus/data/<span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>/org.platops.salt.formulas/.nexus/</code> </pre> <br><p>  At this stage, we need to restart salt-minion, after that, in case of changing the files in the directory, salt-master will receive an event about it: </p><br><pre> <code class="hljs pgsql">salt/beacon/nexus.platops.org/inotify//opt/nexus/data/<span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>/org.platops.salt.formulas { "_stamp": "2017-07-09T10:31:11.283771", "change": "IN_ATTRIB", "id": "nexus.platops.org", "path": "/opt/nexus/data/storage/org.platops.salt.formulas/gitbucket-1.0.0-1.spm"</code> </pre> <br><p>  On salt-master, we set up a <a href="https://docs.saltstack.com/en/latest/topics/reactor/">reactor</a> , which monitors events from the configured beacon and starts the configured state: </p><br><pre> <code class="hljs pgsql">#/etc/salt/master.d/reactor.conf reactor: - <span class="hljs-string"><span class="hljs-string">'salt/beacon/nexus.platops.org/inotify//opt/nexus/data/storage/org.platops.salt.formulas'</span></span>: - /srv/salt/reactor/<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>-spm-metadata.sls</code> </pre> <br><p>  And actually state which runs the command we need: </p><br><pre> <code class="hljs lua">#/srv/salt/reactor/update-spm-metadata.sls update spm repository metadata: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>.cmd.run: - tgt: {{ data[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] }} - <span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>: - spm create_repo /opt/nexus/data/storage/org.platops.salt.formulas</code> </pre> <br><p>  Do not forget to restart salt-master, salt-minion and everything, in fact, every five seconds, the beacon checks for events through inotify in the directory and starts updating the repository metadata. <br>  For those who use Nexus 3, it is also possible to implement this, look towards the Nexus <a href="https://books.sonatype.com/nexus-book/reference3/webhooks.html">webhooks</a> and <a href="https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html">Salt-API</a> . </p><br><h3 id="ustanavlivaem-formuly">  Install formulas </h3><br><p>  Configure the repository in /etc/salt/spm.repos.d/nexus.repo on the salt-master, note that the password is set with plain-text, do not forget to set the appropriate permissions on this file, 400 for example, and use the proxy user with limited permissions, well, or add SPM to use encrypted passwords: </p><br><pre> <code class="hljs 1c"><span class="hljs-meta"><span class="hljs-meta">#/etc/salt/spm.repos.d/nexus.repo nexus.platops.org: url: https:</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//nexus.platops.org/content/sites/org.platops.salt.formulas username: saltmaster password: supersecret</span></span></span></span></code> </pre> <br><p>  We update the data on the formulas on salt-master and set the formula: </p><br><pre> <code class="hljs swift">spm update_repo spm install gitbucket <span class="hljs-type"><span class="hljs-type">Installing</span></span> packages: gitbucket <span class="hljs-type"><span class="hljs-type">Proceed?</span></span> [<span class="hljs-type"><span class="hljs-type">N</span></span>/y] y ... installing gitbucket</code> </pre> <br><p>  Actually everything, a tested, tagged and packaged formula was installed in the salt-master directory. </p><br><p>  We have organized such a fairly simple but effective release cycle of configurations for ourselves, coupled with the assembly of pull-requests, it helps us in the early stages to detect problems in formula dependencies, in the configuration of services, and also allows us to easily distribute configurations between various customer environements. </p><br><p>  There is no limit to perfection, and you can add a lot more, be it to automatically start updating the repository data on the salt-master and automatically updating the formulas on it, testing with dependencies with a hard-coded version for greater compatibility, adding support for password encryption to SPM, adding to SPM capabilities for displaying a list of available formulas, adding to SPM the ability to install dependencies of a specific version, expanding the number of platforms tested, and so on and so forth. </p><br><p>  By the way, in the tests that I cited, the test values ‚Äã‚Äãare rigidly set, which are also installed in pillar in .kitchen.yml, which in essence creates the information digestion, thanks to my colleague <a href="https://habrahabr.ru/users/thunderspb/">Alexander Shevchenko</a> , we no longer use them, but I think about that , he will write himself. </p><br><p>  Thank you all, I hope the article will be useful in your work. </p><br><p><img src="https://habrastorage.org/web/028/916/e33/028916e33293410884347687e738530d.png"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/333922/">https://habr.com/ru/post/333922/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333908/index.html">Which languages ‚Äã‚Äãare most in demand in finance: the views of Wall Street recruiters</a></li>
<li><a href="../333910/index.html">Actions upon arrival at work - receiving cases, updating, documenting, auditing</a></li>
<li><a href="../333912/index.html">Neural conversational models: how to teach a neural network social conversation. Lecture in Yandex</a></li>
<li><a href="../333916/index.html">‚ÄúNecessity arises from both sides‚Äù: the DevOops program committee on the conference and on DevOps</a></li>
<li><a href="../333920/index.html">We raise Linux on MIPSfpga and Altera FPGA</a></li>
<li><a href="../333926/index.html">Orchid CMS - another CMS on Laravel</a></li>
<li><a href="../333928/index.html">Integration of Apache CloudStack with third-party systems. Subscribing to events using Apache Kafka</a></li>
<li><a href="../333930/index.html">How the vulnerability of the payment system revealed credit card information</a></li>
<li><a href="../333932/index.html">learnopengl. Lesson 2.2 - Lighting Basics</a></li>
<li><a href="../333936/index.html">Is it true that people write insane code with overlapping side effects, while maintaining equanimity?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>