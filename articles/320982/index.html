<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to test RoR containers with GitLab CI in a container</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is good about GitLab is that, being an elephant in size in a china shop, it can be carefully installed and almost always works from the box. But ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to test RoR containers with GitLab CI in a container</h1><div class="post__text post__text-html js-mediator-article">  What is good about GitLab is that, being an elephant in size in a china shop, it can be carefully installed and almost always works from the box.  But he is not able to recover and take care of himself, when very straight arms like mine break his usual environment.  I will not go into how I managed to kill him to a state where even removing and installing from scratch does not help, but in order to avoid another endless epic with debugging and reinstalling the server, I brought the whole thing to the Docker container.  Conveniently - there are no million dependencies on the working machine, mounted the directories for repositories, logs and databases and everything works.  Recovery - recreate the container and feed backups (by the way, do not forget to check your backups, as the GitLab experience says, this is not superfluous). <br><br>  On the other hand, there is an application being developed by Rails that only holds code on a real machine;  Rails, gems, and everything else rests in the Docker container.  For its work, it uses Redis and Postgres, each in its own container.  For each container, a directory is mounted so that the data important for the application does not remain inside. <br><br><img src="https://habrastorage.org/files/264/a0b/760/264a0b760c1a445983820651452e21b2.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The challenge is for Gitlab CI to work properly.  It seems simple, but - he himself is in the container. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">By the way, docker-compose.yml to rails application</b> <div class="spoiler_text"><pre><code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">services:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">postgres:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">postgres:</span></span><span class="hljs-number"><span class="hljs-number">9.4</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/var/db</span></span><span class="hljs-regexp"><span class="hljs-regexp">/test/postres</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/var/lib/postgresql/data</span></span> <span class="hljs-symbol"><span class="hljs-symbol">env_file:</span></span> .env <span class="hljs-symbol"><span class="hljs-symbol">ports:</span></span> - <span class="hljs-string"><span class="hljs-string">"54321:5432"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">redis:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">redis:</span></span>latest <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/var/db</span></span><span class="hljs-regexp"><span class="hljs-regexp">/test/redis</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/data</span></span> <span class="hljs-symbol"><span class="hljs-symbol">app:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">build:</span></span> . <span class="hljs-symbol"><span class="hljs-symbol">env_file:</span></span> .env <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/var/www</span></span><span class="hljs-regexp"><span class="hljs-regexp">/test:/var</span></span><span class="hljs-regexp"><span class="hljs-regexp">/www/test</span></span> <span class="hljs-symbol"><span class="hljs-symbol">ports:</span></span> - <span class="hljs-string"><span class="hljs-string">"3000"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">links:</span></span> - postgres - redis</code> </pre> <br>  In the .env file is for example the password to the database, POSTGRES_PASSWORD.  <a href="https://hub.docker.com/r/_/postgres/">Here</a> you can see which variables are used in the postgresql container.  Instead of ports, you can use expose, but for monitoring from a host it is better to open a window to the world. <br><br>  There are no comments to Redis at all - he connected, he himself <a href="https://docs.docker.com/engine/reference/builder/">expose</a> at 6379, and it works.  Everyone would like that. <br></div></div><br>  The first thought is to install Docker in Docker.  I believe in humanity, and in the fact that there is a person in the world who in a reasonable time made a real nesting, with the installation of a Docker in a container that <b>really</b> works, but I personally did not succeed.  So, we need the second option - to test from the outside: all containers should be located next to the GitLab container, automatically created and destroyed by the CI system from inside the container. <br><img src="https://habrastorage.org/files/b82/ae9/9a9/b82ae99a975f4a61a461489637e38ba6.png"><br>  For tests, we do not need to mount external directories, all the same, these are one-time.  After the tests, all containers automatically stop. <br><br><h3>  Sharim Docker </h3><br><blockquote>  It is not recommended to give untrusted programs in containers access to the Docker on the host.  Having such, you can easily launch the creation of another container on the host, which will mount the desired directory or even a whole volume (or devices, for example a webcam or printer), install the necessary code for the attacker, and slowly pull out all your bitcoins, and all this without leaving cozy sandbox.  But since I am testing my code, caution can be ignored. </blockquote><br>  To allow the container to manage its father, you need to forward the parent socket to it.  In an ideal world, this is done like this: <br><br><pre> <code class="bash hljs">docker run .. -v /var/run/docker.sock:/var/run/docker.sock</code> </pre> <br>  but for those who are not looking for easy ways in life, it does not work.  First you need to add more <br><br><pre> <code class="bash hljs">-v /usr/bin/docker:/usr/bin/docker</code> </pre> <br>  then discover that this only works if the docker's binaries on the host are static (do not ask), otherwise you will have to take care of each library in this directory separately.  If your host's docker binary is not static (don't ask!) How it is with me, then work on. <br><br>  See the list of libraries in / usr / bin / docker: <br><br><pre> <code class="bash hljs">ldd /usr/bin/docker</code> </pre> <br><pre> <code class="bash hljs">linux-vdso.so.1 (0x00007fffb9ff4000) libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f711fe27000) libltdl.so.7 =&gt; /usr/lib/x86_64-linux-gnu/libltdl.so.7 (0x00007f711fc1d000) libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f711f871000) /lib64/ld-linux-x86-64.so.2 (0x000055a205b12000) libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f711f66d000)</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Lazy</b> <div class="spoiler_text">  I only needed the ibltdl.so.7 library, everything else in the container was there, all the same Gitlab is not Alphine Linux for you.  You can check it using the container console, calling <i>docker</i> in it, it will tell you which library does not exist.  Connect the right and try again.  If you don‚Äôt think that such a path is easier, mount everything.  He will forgive. </div></div><br>  Writing to Gitlab's docker-compose.yml (not a project, do not confuse) paths that seem to be intuitive, and having tried to start the Gitlab container: <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> ... - <span class="hljs-regexp"><span class="hljs-regexp">/var/run</span></span><span class="hljs-regexp"><span class="hljs-regexp">/docker.sock:/var</span></span><span class="hljs-regexp"><span class="hljs-regexp">/run/docker</span></span>.sock - <span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/docker:/usr</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bin/docker</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/docker/libltdl</span></span>.so.<span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/usr/bin/docker/libltdl</span></span>.so.<span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre> <br>  docker at the start broke out a terrible rugannya, which was so rude that almost every word was shielded seven times! <br><br><pre> <code class="bash hljs">ERROR: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> gitlab Cannot start service gitlab: invalid header field value <span class="hljs-string"><span class="hljs-string">"oci runtime error: container_linux.go:247: starting container process caused \"process_linux.go:359: container init caused \\\"rootfs_linux.go:53: mounting \\\\\\\"/usr/bin/docker/libltdl.so.7\\\\\\\" to rootfs \\\\\\\"/var/lib/docker/devicemapper/mnt/2df228e042aed186eebbb484989e44cee3126c0a3bfb42d25c8998ada5afb9bd/rootfs\\\\\\\" at \\\\\\\"/usr/bin/docker/libltdl.so.7\\\\\\\" caused \\\\\\\"stat /usr/bin/docker/libltdl.so.7: not a directory\\\\\\\"\\\"\"\n"</span></span></code> </pre> <br>  The solution "in the forehead": <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> ... - <span class="hljs-regexp"><span class="hljs-regexp">/var/run</span></span><span class="hljs-regexp"><span class="hljs-regexp">/docker.sock:/var</span></span><span class="hljs-regexp"><span class="hljs-regexp">/run/docker</span></span>.sock - <span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/docker:/usr</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bin/docker</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/usr/lib</span></span><span class="hljs-regexp"><span class="hljs-regexp">/x86_64-linux-gnu/libltdl</span></span>.so.<span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/usr/lib/x86_64-linux-gnu/libltdl</span></span>.so.<span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre> <br>  That is, we need file paths from the right side of the library table. <br><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml by Gitlab</b> <div class="spoiler_text"><pre> <code class="hljs kotlin">gitlab: image: <span class="hljs-string"><span class="hljs-string">'gitlab/gitlab-ce:8.14.5-ce.0'</span></span> restart: unless-stopped hostname: <span class="hljs-string"><span class="hljs-string">'git.habrahabr.ru'</span></span> environment: GITLAB_OMNIBUS_CONFIG: <span class="hljs-string"><span class="hljs-string">"external_url 'http://git.habrahabr.ru'"</span></span> ports: - <span class="hljs-string"><span class="hljs-string">"3456:80"</span></span> #        <span class="hljs-number"><span class="hljs-number">80</span></span>- . - <span class="hljs-string"><span class="hljs-string">"52022:22"</span></span> volumes: - /docker/gitlab/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/conf:/etc/gitlab - /docker/gitlab/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/logs:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/gitlab - /docker/gitlab/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/opt/gitlab - /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/docker.sock:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/docker.sock - /usr/bin/docker:/usr/bin/docker - /usr/lib/x86_64-linux-gnu/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7</code> </pre> </div></div><br><h3>  Create a .gitlab-ci.yml </h3><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: <span class="hljs-string"><span class="hljs-string">"ruby:2.3"</span></span> services: - redis:latest - postgres:<span class="hljs-number"><span class="hljs-number">9.4</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> cache: paths: - vendor/ruby before_script: - apt-get update -q &amp;&amp; apt-get install nodejs -yqq #    .  <span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span>  . - gem install bundler --no-ri --no-rdoc - bundle install -j $(nproc) --path vendor rspec: stage: test script: - bundle <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> rake db:create - bundle <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> rake db:migrate - bundle <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> rake db:<span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> - rspec spec</code> </pre> <br>  To create this file correctly, it is best to look at the docker-compose.yml applications.  For example, the postgres container - we don‚Äôt need to connect volumes, we don‚Äôt need an env file with a password to the database (we don‚Äôt care what the password is in the database that lives for 10 seconds), the ports are out.  That is, it remains only to specify the image name (image).  Redis: volumes are not needed, so only the image name.  The main image is ruby, into which Gitlab will mount the code, and will run before_script. <br><br><h4>  Instead of an epilogue </h4><br>  You can screw anything you like on a GitLab configured in this way, from the Registry of images to Docker-in-docker solutions.  For example, instead of deploying code in a ruby ‚Äã‚Äãcontainer with GitLab tools, create a solution based on gitlab / dind in which to run the docker build.  But this is a completely different article. </div><p>Source: <a href="https://habr.com/ru/post/320982/">https://habr.com/ru/post/320982/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320972/index.html">A little Intel Xeon Phi can now get everyone</a></li>
<li><a href="../320974/index.html">On the state of affairs in the field of children's technical creativity. Immediate prospects</a></li>
<li><a href="../320976/index.html">Unconventional orientation of the PLO</a></li>
<li><a href="../320978/index.html">We invite you to Data Fest‚Å¥ February 11 and 12</a></li>
<li><a href="../320980/index.html">Criminals discovered using the ATP service in Windows Defender</a></li>
<li><a href="../320984/index.html">Overview of the architecture and subsystems of deployment and monitoring. How engineers make the system transparent to design</a></li>
<li><a href="../320986/index.html">5 things that need to be done before the startup of the startup at the international level</a></li>
<li><a href="../320988/index.html">Gitlab "lies", the base is destroyed (restored)</a></li>
<li><a href="../320990/index.html">4 rules of working in Sketch on large projects</a></li>
<li><a href="../320992/index.html">Where to go to the programmer for knowledge this year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>