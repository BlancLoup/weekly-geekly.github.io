<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JavaScript to APK. The pitfalls of developing for Android for those who are stoned by PhoneGap. Building bridges from java to javascript</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habra! 

 I love JavaScript games and try to make their code bulletproof to port to all platforms. Six months ago, I already wrote about building ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JavaScript to APK. The pitfalls of developing for Android for those who are stoned by PhoneGap. Building bridges from java to javascript</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habra! <br><br>  I love JavaScript games and try to make their code bulletproof to port to all platforms.  Six months ago, I already wrote about building Android applications and today I would like to reveal the topic in more detail. <br><br>  Immediately I warn you that I had to give up PhoneGap, because  The experience of using it in two projects upset me.  It does an excellent job with ‚ÄúHello World‚Äù applications, but with a pipeline assembly, nuances emerge in a row. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Why PhoneGap did not go:</b> <br>  1. It is initially empty.  Constantly have to connect all new and new modules. <br>  2. Many modules are written crookedly.  They either take a lot of excess, or they behave unexpectedly.  For example, from two modules for Android to send SMS, one did not work, the second sent true under any conditions. <br>  3. Elementary things are not solved, like getting an EMEI phone.  You need to constantly finish. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/85e/102/023/85e1020239f9fa0fe030839f60b325d8.jpg"><br><a name="habracut"></a><br>  I did not understand the essence of PhoneGap.  Initially, I was expecting one button ‚Äúto do well‚Äù, and it is not really doing nothing.  Under each platform, I still need to put the SDK.  Under each task - to search and install the module.  The modules themselves are also limited.  They can do something only for a part of the platforms, and if needed for others, they have to look again for modules that I can do on other devices.  A lot of garbage and unnecessary things, but you want to build builds with a minimum of costs.  All these factors make writing natively.  And here reefs begin to get out. <br><br>  <b>Why CocoonJS did not go:</b> <br>  With CocoonJS worked a little, so no special questions arose.  Canvas builds really work faster.  But in general, I did not see the point of working with CocoonJS, since  He paid. <br><br>  As for the assembly for other platforms and other nuances - there will be a separate article about it, and further discussion on this topic or the PhoneGap topic is beyond the scope of this one. <br><br><h3>  Let's get to the point </h3><br><br>  To begin, let's start with the basics - WebView with a running HTML page on full screen.  In onCreate MainActivity, we write: <br><br><pre><code class="java hljs">vw = (WebView) findViewById(R.id.webview); vw.setVerticalScrollBarEnabled(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   vw.setHorizontalScrollBarEnabled(false); //   vw.getSettings().setJavaScriptEnabled(true); //  JavaScript vw.getSettings().setDomStorageEnabled(true); //  localStorage  .. vw.getSettings().setSupportZoom(false); //  , ..       vw.getSettings().setSupportMultipleWindows(false); //   . // ..     SPA  vw.addJavascriptInterface(new WebAppInterface(this), "API"); //    JavaScript. //       Java.  JavaScript`   API vw.loadUrl("file:///android_asset/index.html"); //    vw.setWebViewClient(new WebViewClient());</span></span></code> </pre> <br>  All disputable situations will be resolved in Java.  Remember, you write for Bada or SmartTV - there is always some standard functionality that allows you to throw bridges in JavaScript.  In our case for Android, we threw an instance of the WebAppInterface class, and the class itself will look like this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebAppInterface</span></span></span><span class="hljs-class"> </span></span>{ Context mContext; <span class="hljs-comment"><span class="hljs-comment">/** Instantiate the interface and set the context */</span></span> WebAppInterface(Context c) { mContext = c; } <span class="hljs-comment"><span class="hljs-comment">/**   ,    JavaScript */</span></span> <span class="hljs-meta"><span class="hljs-meta">@JavascriptInterface</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSms</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String phoneNumber, String message)</span></span></span><span class="hljs-function"> </span></span>{ ... -   } }</code> </pre><br>  <b>Reef:</b> Working with such bridges can usually be asynchronous or unpredictable and full of surprises. <br><br>  If you need Java to inform JavaScript about any event out of the blue, the easiest way to reach it is to knock at the URL: <br><br><pre> <code class="java hljs">vw.loadUrl(<span class="hljs-string"><span class="hljs-string">"javascript: ... -   JavaScript"</span></span>);</code> </pre><br>  <b>The underwater stone:</b> In Android `s&gt; 4 from Samsung` s at the touch event DOM elements can be highlighted in blue. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f19/0b4/56d/f190b456d6b77d7fec41ecc611b81fbb.jpg"><br><br>  Pay attention to this nuance.  Typical "protection" will not help you: <br><br><pre> <code class="css hljs">* { <span class="hljs-attribute"><span class="hljs-attribute">-webkit-tap-highlight-color</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(255, 255, 255, 0); <span class="hljs-attribute"><span class="hljs-attribute">-webkit-focus-ring-color</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(255, 255, 255, 0); <span class="hljs-attribute"><span class="hljs-attribute">outline</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">-moz-user-select</span></span>: -moz-none; <span class="hljs-attribute"><span class="hljs-attribute">-o-user-select</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">-khtml-user-select</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-user-select</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">user-select</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-text-size-adjust</span></span>: none; }</code> </pre><br>  To get around the bug, add: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.addEventListener) { <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">"touchstart"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ }, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre><br>  But this does not always solve the problem.  Perhaps the problem is affected by the layout itself.  For example, take two applications: Sudoku and Test.  In Sudoku, the board is laid out with a table, and for the table such a decision helped.  In the test, the buttons are.  It seems that everything is by the standards of HTML5 semantics, and everything should be more than fine, but in fact you have to finish off with the following CSS combos: <br><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.some_button</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:focus</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.some_button</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:focus</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:active</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(0, 0, 0, 0); }</code> </pre><br>  I also noticed that the blue selection does not appear if the touch event had to be exactly on the button text (the text must be very large). <br><br>  <b>The underwater rock:</b> In Android, &lt;4 fonts can spread out. <br><br><img src="http://bakhirev.biz/StalinGrad/habr/JsToAndroid_nofonts34.jpg"><br><br>  The way to deal with the bug - either to check or disable fonts.  Although, on the other hand, perhaps I had the curves themselves fonts. <br><br>  <b>Reef:</b> Android is case sensitive. <br><br>  If you have got a picture with .JPG among the heap of resources .jpg - you will hardly ever notice the difference in the browser, but the picture will not load in WebView. <br><br>  <b>Reef:</b> Android is sensitive to reserved words. <br><br>  For example, I had a folder named classijizm in assets.  Android refused to build the project and could not clearly explain the error.  Renamed klassijizm - earned.  Again, in the usual browser, Android didn‚Äôt have such problems. <br><br>  <b>Reef:</b> Audio tag on Android is not working. <br><br>  More precisely, it works in the browser, but does not work when you use it inside WebView.  To get around this limitation, you can skip the bridge and rewrite it with native code.  Add to onCreate: <br><br><pre> <code class="java hljs">mp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaPlayer();</code> </pre><br>  And for WebView we extend JavaScript interface: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JavascriptInterface</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">audio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String url)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soundClick = getAssets().openFd(url); mp.reset(); mp.setDataSource(soundClick.getFileDescriptor(), soundClick.getStartOffset(), soundClick.getLength()); mp.prepare(); mp.start(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } }</code> </pre><br>  <b>Reef:</b> Instead of closing, Android collapses applications.  Therefore, if you use Audio - you need to at least turn off the sound. <br><br>  The essence of the problem is that, suppose you have a game running.  The user has left the application, but continues to hear sounds from a running game.  Therefore, from Java, you need to knock into JavaScript and ask to stop the game. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBackPressed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ vw.loadUrl(<span class="hljs-string"><span class="hljs-string">"javascript: windowClose();"</span></span>); MainActivity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.finish(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onPause(); vw.loadUrl(<span class="hljs-string"><span class="hljs-string">"javascript: windowClose();"</span></span>); MainActivity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.finish(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onResume(); vw.loadUrl(<span class="hljs-string"><span class="hljs-string">"javascript: windowOpen();"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroy(); vw.loadUrl(<span class="hljs-string"><span class="hljs-string">"javascript: windowClose();"</span></span>); MainActivity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.finish(); }</code> </pre><br>  The command MainActivity.this.finish ();  I'm trying to close the application at every opportunity.  So you can be more confident that Android next time just starts everything from the beginning, and will not try to restore anything.  It is clear that in games like Sudoku you can‚Äôt do that, but in most games you can, because  they are quite simple (the same FlappyBirds or Tests).  I advise you to be afraid of attempts by Android to return everything as it was, because  other bugs appear. <br><br>  Reef <b>:</b> Android with onResume does not always successfully restore applications.  And indeed on some devices there are problems with re-launching. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/07b/b38/3e2/07bb383e2439fc74c47bf26b454f4632.jpg"><br><br>  For example, it can stop timers or miraculously stop reacting to resize.  Therefore, in any strange situation, call resize and recheck timers. <br><br>  Reef <b>:</b> when minimizing / opening the application, several WebViews can occur that will work in parallel and interfere with each other. <br><br>  To surely get away from such a problem, we add in the manifesto: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> //      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">WebView</span></span></span><span class="hljs-tag">    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:configChanges</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"keyboardHidden|orientation|screenSize"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> //            </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:clearTaskOnLaunch</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:noHistory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:launchMode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"singleTask"</span></span></span><span class="hljs-tag"> &gt;</span></span></code> </pre><br>  To make our JavaScript application look even better, you can run it full screen by removing the black bar from the top.  To do this, add to the manifest: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:theme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@android:style/Theme.NoTitleBar.Fullscreen"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Reef <b>:</b> localStorage, in which you save the data will be destroyed after the application is closed. <br><br>  To save data between two calls, you need to save the data in the native SharedPreferences.  Prokin two bridges to save and load: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JavascriptInterface</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveSomeThing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message, String id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(numberDataForSave &gt; Integer.parseInt(id)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; numberDataForSave = Integer.parseInt(id); SharedPreferences preferences = getSharedPreferences(<span class="hljs-string"><span class="hljs-string">"com.example.something"</span></span>, MODE_PRIVATE); SharedPreferences.Editor editor = preferences.edit(); editor.putString(<span class="hljs-string"><span class="hljs-string">"somethingID"</span></span>, message); editor.commit(); } <span class="hljs-meta"><span class="hljs-meta">@JavascriptInterface</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadSomeThing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SharedPreferences preferences = getSharedPreferences(<span class="hljs-string"><span class="hljs-string">"com.example.something"</span></span>, MODE_PRIVATE); String message = preferences.getString(<span class="hljs-string"><span class="hljs-string">"somethingID"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message; }</code> </pre><br>  <b>The underwater stone:</b> Methods work asynchronously (or did it seem to me ?!).  If saving is called very often, the data may come in the wrong order. <br><br>  In fact, the bug will look like this - not the last line has been saved, but the previous one.  To solve the problem, we numbered data in JavaScript and native code.  In the method for saving there is a variable numberDataForSave, which checks the index of the stored data.  If the index is less than the last stored, the data is ignored. <br><br>  Reef <b>:</b> The layout of the main activity is usually a lot of superfluous. <br><br>  For one WebView in full screen, we do not need so much.  You can cut by leaving: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WebView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/webview"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fill_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fill_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:scrollbars</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"none"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  <b>The underwater stone:</b> Sent SMS without a SIM card.  SMS did not go away, but callback returned true. <br><br>  If you are using PhoneGap, it is possible that the SMS sending module for Android is written crookedly (in any case, I personally encountered this problem).  It returns true on any outcome.  To implement this normally, let's build a bridge for sending SMS from Java to JavaScript: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JavascriptInterface</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSms</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String phoneNumber, String message)</span></span></span><span class="hljs-function"> </span></span>{ SmsManager sms = SmsManager.getDefault(); sms.sendTextMessage(phoneNumber, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, message, sendSmsPendingIntent, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); }</code> </pre><br>  And add the method to the class MainActivity: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> PendingIntent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registerSentSmsReceiver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String SENT = <span class="hljs-string"><span class="hljs-string">"SMS_SENT"</span></span>; PendingIntent sentPI = PendingIntent.getBroadcast(MainActivity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(SENT), <span class="hljs-number"><span class="hljs-number">0</span></span>); sendSmsReceiver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BroadcastReceiver() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context arg0, Intent arg1)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (getResultCode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Activity.RESULT_OK: vw.loadUrl(<span class="hljs-string"><span class="hljs-string">"javascript: smsSend(true);"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: vw.loadUrl(<span class="hljs-string"><span class="hljs-string">"javascript: smsSend(false);"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }; registerReceiver(sendSmsReceiver, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntentFilter(SENT)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sentPI; }</code> </pre><br>  To prevent the application from crashing with the new class, you need to update onDestroy: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroy(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sendSmsReceiver != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { unregisterReceiver(sendSmsReceiver); } }</code> </pre><br>  Remember, sendSmsReceiver always needs to be checked out when destroying. <br><br>  <b>The underwater stone:</b> On Android, from Samsung, WebView slows down on touch events.  Moreover, it can even stop the rendering when the finger is held. <br><br>  From this bugs will not go anywhere.  So did it.  This was one of the reasons for promoting CocoonJS.  If you wish, you can rewrite the canvas element to the native one (using all the same bridges), but this is already trash.  It‚Äôs better to write everything in Java at once.  But, nevertheless, it still makes sense to compile an APK file, since  besides Samsung, there are a lot of phones from other manufacturers, and everything may not be so bad there.  Well, in the same Tizen ªe in this regard, a fairy tale in general. <br><br>  I apologize in advance for the crooked moments in Java, since  still my javascript profile.  Well, the demo is <a href="">Russian</a> and <a href="https://play.google.com/store/apps/details%3Fid%3Dalexey.bakhirev.grantwood">English</a> from the article, if anyone is interested. </div><p>Source: <a href="https://habr.com/ru/post/214531/">https://habr.com/ru/post/214531/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214517/index.html">Writing a generator for Yeoman.io</a></li>
<li><a href="../214519/index.html">Full comments for google sites with dynamically changing table height</a></li>
<li><a href="../214525/index.html">The logic of thinking. Part 4. Background Activity</a></li>
<li><a href="../214527/index.html">IBM Watson supercomputer will be available from a smartphone: a contest for mobile application developers has been announced</a></li>
<li><a href="../214529/index.html">Suitcases iPhones and Gopnik in Butovo: how we almost went broke on Apple products</a></li>
<li><a href="../214533/index.html">Gravity: a real photoset from NASA, in the style of the same film</a></li>
<li><a href="../214535/index.html">Windows applications in users' web browsers. Own cloud with blackjack etc</a></li>
<li><a href="../214537/index.html">ORANGEMAN: Rusonix distributes servers for free</a></li>
<li><a href="../214543/index.html">How to make friends MS Office and LibreOffice</a></li>
<li><a href="../214545/index.html">Plastic revolver: when one barrel is small</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>