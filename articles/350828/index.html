<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The process of porting Linux device drivers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, hablochiteli! 

 Introduction 
 Sometimes it happens that there is a need to upgrade to a newer version of the Linux kernel and, accordingly, t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The process of porting Linux device drivers</h1><div class="post__text post__text-html js-mediator-article">  Hello, hablochiteli! <br><br><h3>  Introduction </h3><br>  Sometimes it happens that there is a need to upgrade to a newer version of the Linux kernel and, accordingly, to migrate existing device drivers. <br><br><img src="https://habrastorage.org/webt/5r/nt/bj/5rntbjo583-vvnhho7wszb7pjs0.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The transfer process can take from several minutes to a longer period of time.  It depends not only on the complexity of the driver, but also on which version of the kernel you are going to upgrade to (API has a tendency to change - hence all the problems climb), and also on the quality of the code implementation, it is easier to rewrite than to migrate but we will not talk about it. <br><br>  Unfortunately, I can not attach the source code of the driver, but we will consider all the problems that I and you may encounter during the migration process.  Next, we will consider an example of porting a simple driver with kernel version 2.6.25 to 4.12.5, which is located in drivers / serial / name_uart.c.  Also the next resource <a href="https://elixir.bootlin.com/linux/v2.6.25.20/source">2.6.25</a> and <a href="https://elixir.bootlin.com/linux/v4.12.5/source">4.12.5</a> will help us a lot, where you can see the structure of the kernel, as well as the source codes. <br><a name="habracut"></a><br><h3>  Formulation of the problem </h3><br>  The formulation of the problem is extremely primitive and simple - it is required to transfer the above mentioned driver from kernel version 2.6.25 to 4.12.5. <br><br><h3>  Implementation </h3><br>  First of all, if you are not familiar with the driver that you have to transfer, then I would recommend at least superficially examine it.  This can greatly simplify the task.  After that, you can proceed to the transfer. <br><br>  <b>Step one</b> <br><br>  Our driver has the following path in the 2.6.25 kernel: <i>drivers / serial / name_uart.c</i> <br>  Now we need to find a suitable directory where you can put it.  And here we meet the first problem - there is no such directory drivers / serial / in the kernel 4.12.5. <br><br>  It is solved very simply: we take and put our driver in <i>drivers / tty / serial / name_uart.c</i> <br><br>  <b>Step two</b> <br><br>  After this, in order for Linux to be able to include our driver in the assembly, we need to add it to two files. <br><br>  First file: <i>drivers / tty / serial / Makefile</i> <br>  We add the following line to it: <br><br><pre><code class="cpp hljs">obj-$(CONFIG_SERIAL_NAME) += name_uart.o</code> </pre> <br>  Second file: <i>drivers / tty / serial / Kconfig</i> <br>  In it we write the following: <br><br><pre> <code class="cpp hljs">config SERIAL_NAME tristate <span class="hljs-string"><span class="hljs-string">"SERIAL_NAME UART driver"</span></span> help Write description here</code> </pre> <br>  <b>Step Three</b> <br><br>  Once we have completed the first two steps, you can proceed to the assembly. <br><br>  From the root directory, run make menuconfig and include our driver in the build. <br>  When the command is executed, the graphical interface opens and there is no problem to find our driver in it (you can do the search in the following way: click / and write the full or part of the name, then enter). <br><br>  There is another way - you can simply edit the .config file and include your driver in the build. <br><br>  Then you can try to build the kernel with our included driver. <br><br>  <b>Step Four</b> <br><br>  After we tried to build the kernel, most likely we had errors that need to be resolved in order to perform a successful kernel build afterwards and be sure to check our driver for operability. <br><br>  The error I encountered was an outdated interface for working with the proc system, as well as a remote macro. <br><br>  For example, the call to irequest_irq in kernel 2.6.25 is successful, BUT <br><br><pre> <code class="cpp hljs">irequest_irq(<span class="hljs-number"><span class="hljs-number">64</span></span> + ISC_DMA, dma_interrupt_handler, IRQF_DISABLED, <span class="hljs-string"><span class="hljs-string">"DMA"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre> <br>  in kernel 4.12.5, the IRQF_DISABLED macro was removed, and therefore the driver was not going to. <br>  Solution - take and substitute 0 instead of IRQF_DISABLED. <br><br><pre> <code class="cpp hljs">irequest_irq(<span class="hljs-number"><span class="hljs-number">64</span></span> + ISC_DMA, dma_interrupt_handler, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"DMA"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre> <br>  The next error was that in the kernel version 2.6.25, interaction with the proc system occurred using create_proc_entry, the implementation of which you will no longer find in 4.12.5. <br><br>  Therefore, it was necessary to rewrite the implementation a bit, and the result was the following: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/****************************************************************************** * /proc interface ******************************************************************************/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xr16_get_status</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct seq_file *m, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uart_name_uart</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pp</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> f; u64 tmp; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i, xmax = ARRAY_SIZE(pp-&gt;in_irq); seq_printf(m, <span class="hljs-string"><span class="hljs-string">"UART NAME ports stat:\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; UART_NAME_MAXPORTS; i++) { pp = &amp;uart_name_16_ports[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!pp-&gt;used) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; local_irq_save(f); tmp = ktime_to_us(ktime_sub(ktime_get(), pp-&gt;ktm_last)); do_div(tmp, USEC_PER_SEC); <span class="hljs-comment"><span class="hljs-comment">/* *   . */</span></span> local_irq_restore(f); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xr16_proc_open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct inode *inode, struct file *file)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> single_open(file, uart_name_get_status, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_operations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uart_name_proc_fops</span></span></span><span class="hljs-class"> = {</span></span> .owner = THIS_MODULE, .open = uart_name_proc_open, .read = seq_read, .llseek = seq_lseek, .release = single_release, }</code> </pre> <br>  If we summarize all the above, the driver transfer is divided into the following steps: <br><br>  1. copy the source code of the previous version of the driver to the new version of the Linux kernel; <br>  2. add the description in Kconfig and in the Makefile; <br>  3. pick up our driver with the help of the busybox into the kernel assembly (or by directly editing the .config file); <br>  4. try to eliminate all errors during the build, until the kernel is assembled. <br><br>  So, we looked at the basics of how to port the device driver to a newer version of the Linux kernel, as well as problems that you may encounter. <br><br>  In the next article we will write our first full-fledged own driver according to a given technical task for one of the new versions of the Linux kernel, and also we will test it not only using standard Linux utilities, but we will also write our own test for it. <br><br>  Please, if you find inaccuracies, or you have something to add - write in the LAN or in the comments. <br><br>  Thank! </div><p>Source: <a href="https://habr.com/ru/post/350828/">https://habr.com/ru/post/350828/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350816/index.html">New API React: Suspense (ru subtitles, from Dan's speech on JS Conf)</a></li>
<li><a href="../350818/index.html">How to increase network bandwidth in the data center: a new PSE-3 chip is introduced</a></li>
<li><a href="../350820/index.html">Copying data from a website using R and the rvest library</a></li>
<li><a href="../350822/index.html">How I was looking for a job in Singapore</a></li>
<li><a href="../350824/index.html">Remote educational game creation program</a></li>
<li><a href="../350830/index.html">Alan Kay: The future can not be built gradually</a></li>
<li><a href="../350832/index.html">6 interesting bugs that I encountered while making the game for VKontakte</a></li>
<li><a href="../350834/index.html">Chip Puzzle: an unbreakable processor will be developed for DARPA</a></li>
<li><a href="../350836/index.html">Descriptor graphics in MATLAB: the second horizontal axis</a></li>
<li><a href="../350838/index.html">We study parallel computing with OpenMPI and a supercomputer on the example of hacking neighbor WiFi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>