<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Remote execution of system commands on request via sockets in Python 3. Part 2. Data transfer protocol</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, I explained how to create a server and client in Python 3 using embedded sockets. But this application had many flaws, which ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Remote execution of system commands on request via sockets in Python 3. Part 2. Data transfer protocol</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/post/268993/">previous article,</a> I explained how to create a server and client in Python 3 using embedded sockets.  But this application had many flaws, which I will try to correct in this and subsequent articles. <br><br>  So what are the disadvantages of our application? <br><ul><li>  A single packet is sent, the length of which cannot exceed a predetermined limit of 1 KB. </li><li>  An application without verification passes the argument passed from the network to the shell (URL). </li><li>  Lack of functionality.  We cannot, for example, download all images from Habr, or download a separate hub. </li></ul><br>  Today I will tell how to solve the first problem, and at the same time a little about TCP. <br><br><h5>  Protocol Description </h5><br>  We used the bare protocol TCP to transfer data between the server and the client.  TCP is a streaming protocol; it transmits data in a sequential set of bytes.  Transmitting a command with arguments over the network in the first version of our application, we read only 1024 bytes of data from the received packet.  But what if the data does not fit in 1024 bytes?  There is only one way out - to split the data into several packages on one host and ‚Äúglue‚Äù them into one piece when received on another host.  But how do you know when one team ends (with its arguments) and another begins?  To do this, we need to know how long the entire transmitted message is. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since we cannot find out the length of the message in advance, we will have to transmit it in one of the packets.  Of course, it is better to do this at the very beginning of the first package.  Having allocated only 4 bytes for storing the message length, we will be able to send a message of over 4 billion characters!  The message length is information about it, that is, part of the header, the header of our protocol.  What protocol do you ask?  If you believe Wikipedia, then <br><blockquote>  A data transfer protocol is a set of logical-level interface agreements that define the exchange of data between different programs. </blockquote><br>  We agreed that we will transmit data in several packets via TCP, and at the beginning of the data of the first packet the length of the entire message in bytes will be stored.  So we developed our simple protocol!  It must be remembered that our protocol is based on TCP, which means it has the same features as the last one. <br><a name="habracut"></a><br><h5>  Protocol development </h5><br>  We described our protocol, it is time to develop it! <br><br>  The <b>sendall</b> socket method in Python independently breaks the data into packets and sends them to the server.  Here you can not bathe.  To transfer the length we translate it into a <b>C struct of</b> type <b>unsigned int</b> (4 bytes) using the built-in library <b>struct</b> . <br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-comment"><span class="hljs-comment">#    def send(connection, data): #      data = bytes(data, "utf8") #  C struct  unsigned int  4 ,   .   4 ,   ,   . connection.sendall(struct.pack('&gt;I', len(data)) + data)</span></span></code> </pre> <br>  The <i>'&gt; I'</i> parameter passed to the <b>struct.pack</b> function asks to transfer the second parameter to the <b>unsigned int</b> ( <i>I</i> ) type in reverse byte order ( <i>&gt;</i> ).  Consider this later. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   def recv_packets(connection, n): piece = b'' #        &lt;b&gt;n&lt;/b&gt; while len(piece) &lt; n: #     ,      &lt;b&gt;n&lt;/b&gt; packet = connection.recv(n - len(piece)) #     ,     if not packet: return None piece += packet return piece #     def recv(connection): #  ,    length_data = recv_packets(connection, 4) #    ,     if not length_data: return None #     data_len = struct.unpack('&gt;I', length_data)[0] # ,   UTF-8.    "utf8", "utf-8", "UTF8", "UTF-8",     . return recv_packets(connection, data_len).decode("utf8")</span></span></code> </pre><br>  In the <b>recv_packets</b> function <b>,</b> we read already received data until we receive a part of the message of the required length.  If the socket <b>recv</b> method returns nothing, then we could not receive the message completely.  In this case, too, nothing is returned, and then nothing returns the <b>recv</b> function of our protocol. <br><br><h5>  Protocol use </h5><br>  Now we can use our protocol written on top of another protocol - TCP.  At the same time, I will talk about what is happening at this moment under the hood. <br><br>  To get started, go to the directory with the newly created <b>protocol.py</b> file and run the Python 3 interpreter (usually the <b>python3</b> command) in two terminals, command line interpreters, or development environment.  In both, enter the following commands in turn. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket, protocol &gt;&gt;&gt; sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</code> </pre><br>  The first line imports the socket library and our mini-protocol, the second one creates a socket with the TCP / IPv4 protocol.  AF_INET ‚Äî pair (domain / IPv4, port), SOCK_STREAM ‚Äî streaming connection type on which the TCP protocol is based. <br><br>  The next two lines are entered in the first terminal. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>sock.bind((<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, <span class="hljs-number"><span class="hljs-number">65043</span></span>)) &gt;&gt;&gt; sock.listen(<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre><br>  At this point, the operating system takes up the address <i>localhost: 65043</i> for our application and our application begins to listen to it.  If you have not yet understood, a socket is a software interface that is created by the operating system. <br><br>  We join the server through the second terminal. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>sock.connect((<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, <span class="hljs-number"><span class="hljs-number">65043</span></span>))</code> </pre><br>  At this point, the following happens.  The client is sending a small package.  My first packet is 74 bytes long.  <i>(The length is not always the same, I quote it so that it is approximately clear what is being sent at the moment of establishing a connection.)</i> They can be expanded as follows: 8 bytes - two Ethernet addresses, 20 bytes - an IP header, and 46 bytes - a TCP header .  There are two bits in the packet from the TCP header ‚Äî <b>syn</b> and <b>ack</b> .  In the first packet, <i>syn = 1, ack = 0</i> .  After that, the server sends us a packet of the same length (74 bytes), acknowledging receipt and allowing to connect, with <i>syn = 1, ack = 1</i> .  Then the client sends the third packet, but not 74, but 66 bytes in length.  In the third packet, <i>syn = 0, ack = 1</i> .  This package finally establishes the connection and now we can receive and receive packets.  It looks like a successful connection.  If you would like to study TCP and other possible cases in more detail, you can read about it, for example, in the TANENTBAUM book ‚ÄúComputer Networks‚Äù. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>conn, addr = sock.accept()</code> </pre><br>  We read information about the client.  At this point, no packets are transmitted, we just take the data already recorded. <br><br>  In the second terminal, enter <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>protocol.send(sock, <span class="hljs-string"><span class="hljs-string">"Hello, localhost!"</span></span>)</code> </pre><br>  With this line we send a message to the server using our mini-protocol. <br>  At this moment we send a package with the following content to the server (excluding headers): <br> <code>00:00:00:11:48:65:6c:6c:6f:2c:20:6c:6f:63:61:6c:68:6f:73:74:21 <br></code> <br>  <i>00: 00: 00: 11</i> - <b>0x11</b> , or <b>17</b> in decimal notation, is the length of the transmitted message (not the data, but the message, since the data, in this case, is 4 bytes of length + message). <br>  <i>48: 65: 6c: 6c: 6f: 2c: 20: 6c: 6f: 63: 61: 6c: 68: 6f: 73: 74: 21</i> - transmitted string <b>Hello, localhost!</b> <br>  The server responds with another packet confirming receipt. <br><br>  Finally, we read and decode the message in the first terminal, the client: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>protocol.recv(conn)</code> </pre><br>  You can break the connection by typing in the second terminal <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>sock.close()</code> </pre><br>  The client sends the server a packet with the <b>fin</b> bit set, saying that it has no more data to send and wants to break the connection.  In response, the server also sends a packet with the <i>fin</i> bit <i>= 1</i> . <br>  The same command in the first terminal will stop the server and it will stop listening. <br><br><h5>  Conclusion </h5><br>  After all we have done, we can easily transfer messages between client and server applications.  The changes are not very different, so I did not mention the code listings in the article, but put the project on <a href="https://github.com/SemperPeritus/httrack-deamon">GitHub</a> .  In the next article I will talk about security.  If you are interested in something else that you would like to hear about in the following articles, then write about it in the comments. </div><p>Source: <a href="https://habr.com/ru/post/269019/">https://habr.com/ru/post/269019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269003/index.html">Script shipping management online store</a></li>
<li><a href="../269007/index.html">Virtual quadrocopter on Unity + OpenCV (Part 2)</a></li>
<li><a href="../269009/index.html">Altera + OpenCL: we program under FPGA without knowledge of VHDL / Verilog</a></li>
<li><a href="../269015/index.html">Office as Platform, edition 8 - contextual Office application with Visual Studio Code on OS X, Linux and Windows</a></li>
<li><a href="../269017/index.html">What is ReactOS?</a></li>
<li><a href="../269021/index.html">JCoro ‚Äã‚Äã- asynchronous on coroutines in Java</a></li>
<li><a href="../269023/index.html">HikariCP - the fastest pool of connections in java</a></li>
<li><a href="../269025/index.html">Amazon Web Services Infrastructure Inside. Part 2</a></li>
<li><a href="../269027/index.html">Comparison of MaxMind and Sypex bases</a></li>
<li><a href="../269029/index.html">Hibernate Developer Documentation - Chapter IV. Batch processing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>