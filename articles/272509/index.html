<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Randomness in PHP7 - Will I get lucky?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will analyze the problems related to the generation of random numbers used in cryptography. PHP5 does not provide a simple mechanis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Randomness in PHP7 - Will I get lucky?</h1><div class="post__text post__text-html js-mediator-article"><img width="100%" src="https://habrastorage.org/files/dd7/176/96c/dd717696cc1a4dc69497bb7d06734f94.jpg" alt="   PHP" title="Cryptographic randomization in PHP"><br><br>  In this article we will analyze the problems related to the generation of random numbers used in cryptography.  PHP5 does not provide a simple mechanism for generating crypto-resistant random numbers, while PHP7 solves this problem by introducing <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D1%2580%25D0%25B8%25D0%25BF%25D1%2582%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8_%25D1%2581%25D1%2582%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B3%25D0%25B5%25D0%25BD%25D0%25B5%25D1%2580%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580_%25D0%25BF%25D1%2581%25D0%25B5%25D0%25B2%25D0%25B4%25D0%25BE%25D1%2581%25D0%25BB%25D1%2583%25D1%2587%25D0%25B0%25D0%25B9%25D0%25BD%25D1%258B%25D1%2585_%25D1%2587%25D0%25B8%25D1%2581%25D0%25B5%25D0%25BB">CSPRNG</a> functions. <br><br><h2>  What is CSPRNG? </h2><br>  Quoting <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D1%2580%25D0%25B8%25D0%25BF%25D1%2582%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8_%25D1%2581%25D1%2582%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B3%25D0%25B5%25D0%25BD%25D0%25B5%25D1%2580%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580_%25D0%25BF%25D1%2581%25D0%25B5%25D0%25B2%25D0%25B4%25D0%25BE%25D1%2581%25D0%25BB%25D1%2583%25D1%2587%25D0%25B0%25D0%25B9%25D0%25BD%25D1%258B%25D1%2585_%25D1%2587%25D0%25B8%25D1%2581%25D0%25B5%25D0%25BB">Wikipedia</a> , a cryptographically secure pseudorandom number generator (eng. Cryptographically secure pseudorandom number generator, CSPRNG) is a pseudorandom number generator with specific properties that allow it to be used in cryptography. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      CSPRNG is mainly used for the following purposes: <br><ul><li>  Key generation (including generation of public / private keys) </li><li>  Create random passwords for user accounts </li><li>  Encryption systems </li></ul><br>  The main aspect of maintaining high security is the high quality of randomness. <br><br><h2>  CSPRNG in PHP7 </h2><br>  PHP7 introduces two new features that can be used for <a href="http://php.net/manual/en/function.random-bytes.php"><code>random_bytes</code></a> : <a href="http://php.net/manual/en/function.random-bytes.php"><code>random_bytes</code></a> and <a href="http://php.net/manual/en/function.random-int.php"><code>random_int</code></a> . <a name="habracut"></a><br><br>  The <code>random_bytes</code> function returns a string and takes as input parameters an <code>int</code> that defines the length (in bytes) of the return value: <br><br><pre> <code class="php hljs">$bytes = random_bytes(<span class="hljs-number"><span class="hljs-number">10</span></span>); var_dump(bin2hex($bytes)); <span class="hljs-comment"><span class="hljs-comment">//possible ouput: string(20) "7dfab0af960d359388e6"</span></span></code> </pre><br>  <code>random_int</code> returns an integer in the specified range: <br><br><pre> <code class="php hljs">var_dump(random_int(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//possible output: 27</span></span></code> </pre><br><h2>  Behind the scenes </h2><br>  Sources of randomness of the above functions differ depending on the environment: <br><ul><li>  Windows will always use <code>CryptGenRandom();</code> </li><li>  On other platforms - subject to availability, <a href=""><code>arc4random_buf()</code></a> will be enabled (true for BSD-derived systems or systems with <code>libbsd</code> ). </li><li>  If the above is unavailable, the system <a href="http://man7.org/linux/man-pages/man2/getrandom.2.html"><code>getrandom(2)</code></a> will be used in Linux. </li><li>  If all of this fails, PHP will attempt to use <code>/dev/urandom</code> as the final attempt. </li><li>  If you cannot use these sources, an error will be thrown. </li></ul><br><h2>  Simple test </h2><br>  A good system for generating random numbers is determined by the "quality" of the generations.  To test it, a set of statistical tests is often used, allowing, without delving into the complex topic of statistics, to compare the known reference behavior with the result of the generator and to help in assessing its quality. <br><br>  One of the easiest tests is a dice game.  The estimated probability of a six loss with one bone is one to six, but at the same time, if I roll three dice 100 times, then the expected loss of 1, 2 and 3 six is ‚Äã‚Äãapproximately the following: <br><ul><li>  0 six = 57.9 times </li><li>  1 six = 34.7 times </li><li>  2 six = 6.9 times </li><li>  3 sixes = 0.5 times </li></ul><br>  Here is the code to play the roll of bones 1,000,000 times: <br><br><pre> <code class="php hljs">$times = <span class="hljs-number"><span class="hljs-number">1000000</span></span>; $result = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i=<span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $times; $i++) { $dieRoll = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">//initializes just the six counting to zero $dieRoll[roll()] += 1; //first die $dieRoll[roll()] += 1; //second die $dieRoll[roll()] += 1; //third die $result[$dieRoll[6]] += 1; //counts the sixes } function roll() { return random_int(1,6); } var_dump($result);</span></span></code> </pre><br>  Running code in PHP7 using <code>random_int</code> and a simple <code>rand</code> will <code>random_int</code> following results: <br><table><tbody><tr><th>  Sixes </th><th>  Expected Result </th><th>  random_int </th><th>  rand </th></tr><tr><td>  0 </td><td>  579,000 </td><td>  579430 </td><td>  578179 </td></tr><tr><td>  one </td><td>  347,000 </td><td>  346927 </td><td>  347620 </td></tr><tr><td>  2 </td><td>  69000 </td><td>  68985 </td><td>  69586 </td></tr><tr><td>  3 </td><td>  5000 </td><td>  4658 </td><td>  4615 </td></tr></tbody></table><br>  For a better comparison of <code>rand</code> and <code>random_int</code> we construct a graph of results using the formula: <code> PHP</code> - <code> </code> / <code>sqrt( )</code> . <br><br>  The graph will look like this (the closer to zero, the better): <br><div style="text-align:center;"><img src="https://habrastorage.org/files/942/335/eef/942335eef1ae4f09935722986e17d66a.png" alt=" test random" title="schedule test random"></div><br>  Even despite the bad result with three sixes and the simplicity of the test, we see a clear advantage of <code>random_int</code> over <code>rand</code> . <br><br><h2>  What about PHP5? </h2><br>  By default, PHP5 does not provide any strong pseudo-random number generators.  But there are actually several options, such as <a href="http://php.net/manual/en/function.openssl-random-pseudo-bytes.php"><code>openssl_random_pseudo_bytes()</code></a> , <a href="http://php.net/manual/en/function.mcrypt-create-iv.php"><code>mcrypt_create_iv()</code></a> or using <a href="https://en.wikipedia.org/wiki//dev/random"><code>/dev/random</code></a> directly or <a href="https://en.wikipedia.org/wiki//dev/random"><code>/dev/urandom</code></a> with <code>fread()</code> .  There are also libraries such as <a href="https://github.com/ircmaxell/RandomLib">RandomLib</a> or <a href="https://pecl.php.net/package/libsodium">libsodium</a> . <br><br>  If you want to start using a good random number generator and at the same time are not yet ready to switch to PHP7, you can use the <a href="https://github.com/paragonie/random_compat"><code>random_compat</code></a> library from Paragon Initiative Enterprises.  It allows using <code>random_bytes()</code> and <code>random_int()</code> in PHP 5.x projects. <br><br>  The library can be installed via <a href="https://getcomposer.org/">Composer</a> : <br><br><pre> <code class="bash hljs">composer require paragonie/random_compat</code> </pre><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>; $string = random_bytes(<span class="hljs-number"><span class="hljs-number">32</span></span>); var_dump(bin2hex($string)); <span class="hljs-comment"><span class="hljs-comment">// string(64) "8757a27ce421b3b9363b7825104f8bc8cf27c4c3036573e5f0d4a91ad2aaec6f" $int = random_int(0,255); var_dump($int); // int(81)</span></span></code> </pre><br>  Compared to PHP7, <code>random_compat</code> uses slightly different priorities: <br><ol><li>  <code>fread()</code> <code>/dev/urandom</code> if available </li><li> <code>mcrypt_create_iv($bytes, MCRYPT_CREATE_IV)</code> </li> <li> <code>COM('CAPICOM.Utilities.1')-&gt;GetRandom()</code> </li> <li> <code>openssl_random_pseudo_bytes()</code> </li> </ol><br><br>  For more information on why this order is used, you can read the <a href="">documentation</a> . <br><br>  An example of generating a password using the library: <br><br><pre> <code class="php hljs">$passwordChar = <span class="hljs-string"><span class="hljs-string">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span></span>; $passwordLength = <span class="hljs-number"><span class="hljs-number">8</span></span>; $max = strlen($passwordChar) - <span class="hljs-number"><span class="hljs-number">1</span></span>; $password = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $passwordLength; ++$i) { $password .= $passwordChar[random_int(<span class="hljs-number"><span class="hljs-number">0</span></span>, $max)]; } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $password; <span class="hljs-comment"><span class="hljs-comment">//possible output: 7rgG8GHu</span></span></code> </pre><br><h2>  Short summary </h2><br>  You should always use cryptographically <code>random_compat</code> pseudo-random number generators, and <code>random_compat</code> is a good solution for this. <br><br>  If you need a reliable source of random data, then look towards <code>random_int</code> and <code>random_bytes</code> . <br><br><h3>  Related Links </h3><br><ul><li>  <a href="https://en.wikipedia.org/wiki/Diehard_tests">Die hard test</a> </li><li>  <a href="http://bit.ly/1Mrptf5">Chi-square test with dice example</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Kolmogorov-Smirnov_test">Kolmogorov-Smirnov Test</a> </li><li>  <a href="http://random.mat.sbg.ac.at/tests/theory/spectral/">Spectral test</a> </li><li>  <a href="http://cristianopi.altervista.org/RaBiGeTe_MT">RaBiGeTe test suite</a> </li><li>  <a href="http://cristianopi.altervista.org/RaBiGeTe_MT">Random Number Generation In PHP (2011)</a> </li><li>  <a href="http://ubm.io/1Ot46vL">Testing RNG part 1</a> <a href="http://ubm.io/1VNzh3N">and 2</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/272509/">https://habr.com/ru/post/272509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272491/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ188 (December 1 - 6, 2015)</a></li>
<li><a href="../272495/index.html">PHP Digest number 75 - interesting news, materials and tools (November 22 - December 6, 2015)</a></li>
<li><a href="../272497/index.html">Disposable without borders</a></li>
<li><a href="../272505/index.html">How do I use SVG sprites</a></li>
<li><a href="../272507/index.html">JavaScript encryption using the pidCrypt library</a></li>
<li><a href="../272513/index.html">Implement Bootstrap 3 Datepicker in SonataAdminBundle</a></li>
<li><a href="../272517/index.html">Presentation of the e-government portal in Kiev</a></li>
<li><a href="../272519/index.html">Simple Blender. Part 1</a></li>
<li><a href="../272521/index.html">Detailing, reflections and post effects in GTA V</a></li>
<li><a href="../272523/index.html">Editing a Raspberry Pi image with qemu-user-static (Ubuntu 14.04)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>