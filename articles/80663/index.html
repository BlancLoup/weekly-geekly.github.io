<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Views module - API. The basics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Surely, many who work with drupal are familiar with the Views . As Drupaler.ru says, the Views module is a Setup and control for displaying any type o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Views module - API. The basics</h1><div class="post__text post__text-html js-mediator-article">  Surely, many who work with drupal are familiar with the <a href="http://drupal.org/project/views">Views</a> .  As <a href="http://drupaler.ru/module/views">Drupaler.ru</a> says, the Views module is a <i>Setup and control for displaying any type of content anywhere on the site</i> , i.e.  it allows you to create pages, blocks, replace the contents of the nodes, user pages and more, forming the content of any available fields on the site.  But what to do when it is necessary to display information provided by a third-party module, and to which we do not have access from Views? <br><a name="habracut"></a><br>  To make it clear, further on a live example: <br><br>  On the site I use the <a href="http://drupal.org/project/privatemsg">PrivateMSG</a> module.  It allows users to send private messages to each other.  With Views, I assembled a block that displays information about the current user. <br><br>  <b>Task:</b> <i>Display in the block the number of new messages and the number of all messages in the Inbox folder of the current user.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Solution:</b> <i>Write a module that would add the necessary values ‚Äã‚Äãto the Views constructor.</i> <br><br>  Unfortunately, there is very little information on the Internet on this subject, and the <a href="http://views.doc.logrus.com/">Views API manual is</a> rather complicated and incomprehensible. <br><br>  <b>So let's get started.</b> <br><ol><li>  <i><b>Create a new module.</b></i> <br>  As expected, create a directory, call it the name of our future module.  I called it <i>privatemsg_extraviews</i> . <br>  In the directory create files <i>privatemsg_extraviews.info, privatemsg_extraviews.module, privatemsg_extraviews.views.inc</i> .  Next, we need to create another 2 files, but more on that later. <br></li><li>  <i><b>privatemsg_extraviews.info</b></i> <br>  This file contains information about our module.  It is necessary for the drupal to recognize the module. <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">name = privatemsg_extraviews <br> description =   views  Private Messages <br> core = 6.x <br> package = Mail <br> version = <font color="#A31515">"6.x-1.1"</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  This is enough for the drupal to recognize our module. <br></li><li>  <i><b>privatemsg_extraviews.module</b></i> <br>  The main file of the module.  It contains the entire structure of the module, all the hooks, and generally everything. <br>  We only need to indicate that the module works with Views. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">* Implementation of hook_views_api().</font> <br> <font color="#008000">*/</font> <br> function privatemsg_extraviews_views_api() { <br> <font color="#0000ff">return</font> array( <br> <font color="#A31515">'api'</font> =&gt; 2, <font color="#008000">//   API</font> <br> <font color="#A31515">'path'</font> =&gt; drupal_get_path( <font color="#A31515">'module'</font> , <font color="#A31515">'privatemsg_extraviews'</font> ), <font color="#008000">//      Views</font> <br> ); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br></li><li>  <i><b>privatemsg_extraviews.views.inc</b></i> <br>  The most interesting.  In this file we write the whole system of working with Views.  The module itself will find it, because  we specified the directory in the hook above. <br>  The main hook we need is <i>hook_views_data ()</i> .  In it, we determine which database table we add, and what information we return. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> function privatemsg_extraviews_views_data() { <br> <font color="#008000">//     Views</font> <br> $data[ <font color="#A31515">'privatemsg'</font> ][ <font color="#A31515">'table'</font> ][ <font color="#A31515">'group'</font> ] = t( <font color="#A31515">'Private Messages'</font> ); <br> <font color="#008000">//  </font> <br> $data[ <font color="#A31515">'privatemsg'</font> ][ <font color="#A31515">'table'</font> ][ <font color="#A31515">'join'</font> ] = array( <br> <font color="#008000">// users -         </font> <br> <font color="#A31515">'users'</font> =&gt; array( <br> <font color="#008000">//  </font> <br> <font color="#A31515">'left_field'</font> =&gt; <font color="#A31515">'uid'</font> , <br> <font color="#A31515">'field'</font> =&gt; <font color="#A31515">'uid'</font> , <br> ), <br> ); <br> <font color="#008000">// count -  ,    </font> <br> $data[ <font color="#A31515">'privatemsg'</font> ][ <font color="#A31515">'count'</font> ] = array( <br> <font color="#A31515">'title'</font> =&gt; t( <font color="#A31515">'  '</font> ), <br> <font color="#A31515">'help'</font> =&gt; t( <font color="#A31515">'    ""'</font> ), <br> <font color="#008000">//   </font> <br> <font color="#A31515">'field'</font> =&gt; array( <br> <font color="#008000">//    </font> <br> <font color="#A31515">'handler'</font> =&gt; <font color="#A31515">'privatemsg_extraviews_handler_field_count'</font> , <br> <font color="#008000">//     </font> <br> <font color="#A31515">'click sortable'</font> =&gt; TRUE, <br> ), <br> ); <br> <font color="#008000">// </font> <br> $data[ <font color="#A31515">'privatemsg'</font> ][ <font color="#A31515">'count_new'</font> ] = array( <br> <font color="#A31515">'title'</font> =&gt; t( <font color="#A31515">'  '</font> ), <br> <font color="#A31515">'help'</font> =&gt; t( <font color="#A31515">'     ""'</font> ), <br> <font color="#A31515">'field'</font> =&gt; array( <br> <font color="#A31515">'handler'</font> =&gt; <font color="#A31515">'privatemsg_extraviews_handler_field_count_new'</font> , <br> <font color="#A31515">'click sortable'</font> =&gt; TRUE, <br> ), <br> ); <br> <font color="#0000ff">return</font> $data; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Next we need <i>hook_views_handlers ()</i> to initialize the field handlers. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">function privatemsg_extraviews_views_handlers() { <br> <font color="#0000ff">return</font> array( <br> <font color="#008000">// </font> <br> <font color="#A31515">'handlers'</font> =&gt; array( <br> <font color="#A31515">'privatemsg_extraviews_handler_field_count'</font> =&gt; array( <br> <font color="#008000">// ,    </font> <br> <font color="#A31515">'parent'</font> =&gt; <font color="#A31515">'views_handler_field_numeric'</font> , <br> <font color="#008000">//     </font> <br> <font color="#A31515">'path'</font> =&gt; drupal_get_path( <font color="#A31515">'module'</font> , <font color="#A31515">'privatemsg_extraviews'</font> ), <br> ), <br> <font color="#008000">// </font> <br> <font color="#A31515">'privatemsg_extraviews_handler_field_count_new'</font> =&gt; array( <br> <font color="#A31515">'parent'</font> =&gt; <font color="#A31515">'views_handler_field_numeric'</font> , <br> <font color="#A31515">'path'</font> =&gt; drupal_get_path( <font color="#A31515">'module'</font> , <font color="#A31515">'privatemsg_extraviews'</font> ), <br> ), <br> ), <br> ); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  As I said above, we will need to create 2 more files - these are just field handlers.  Create the <i>privatemsg_extraviews_handler_field_count.inc</i> and <i>privatemsg_extraviews_handler_field_count_new.inc</i> files in the module directory. <br></li><li>  <i><b>privatemsg_extraviews_handler_field_count.inc</b></i> <br>  Handler for the field "number of messages." <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> <font color="#008000">//  ,     " "</font> <br> <font color="#0000ff">class</font> privatemsg_extraviews_handler_field_count extends views_handler_field_numeric { <br> <font color="#008000">//   </font> <br> function query() { <br> <font color="#008000">//  </font> <br> $table = $ <font color="#0000ff">this</font> -&gt;query-&gt;ensure_table( <font color="#A31515">'pm_index'</font> ); <br> <font color="#008000">//   </font> <br> $sql = <font color="#A31515">"SELECT COUNT(DISTINCT thread_id) FROM {pm_index} p WHERE p.deleted = 0 AND p.uid = users.uid"</font> ; <br> <font color="#008000">//     </font> <br> $ <font color="#0000ff">this</font> -&gt;query-&gt;add_field( <font color="#A31515">''</font> , <font color="#A31515">"($sql)"</font> , <font color="#A31515">'count'</font> ); <br> $ <font color="#0000ff">this</font> -&gt;field_alias = <font color="#A31515">'count'</font> ; <br> } <br> <font color="#008000">//   </font> <br> function render($values) { <br> $txt = $values-&gt;count; <br> <font color="#0000ff">if</font> ($txt) { <br> <font color="#0000ff">return</font> $txt; <br> } <br> <font color="#0000ff">else</font> { <br> <font color="#0000ff">return</font> parent::render($values); <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br></li><li>  <i><b>privatemsg_extraviews_handler_field_count_new.inc</b></i> <br>  Handler for the field "Number of new messages."  (likewise) <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> <br> <font color="#0000ff">class</font> privatemsg_extraviews_handler_field_count_new extends views_handler_field_numeric { <br> function query() { <br> $table = $ <font color="#0000ff">this</font> -&gt;query-&gt;ensure_table( <font color="#A31515">'pm_index'</font> ); <br> $sql = <font color="#A31515">"SELECT COUNT(DISTINCT thread_id) FROM {pm_index} p WHERE p.deleted = 0 AND p.is_new = 1 AND p.uid = users.uid"</font> ; <br> $ <font color="#0000ff">this</font> -&gt;query-&gt;add_field( <font color="#A31515">''</font> , <font color="#A31515">"($sql)"</font> , <font color="#A31515">'count_new'</font> ); <br> $ <font color="#0000ff">this</font> -&gt;field_alias = <font color="#A31515">'count_new'</font> ; <br> } <br> <br> function render($values) { <br> $txt = $values-&gt;count_new; <br> <font color="#0000ff">if</font> ($txt) { <br> <font color="#0000ff">return</font> $txt; <br> } <br> <font color="#0000ff">else</font> { <br> <font color="#0000ff">return</font> parent::render($values); <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br></li></ol><br><br>  After all done, Views will generate a type request. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">SELECT</font> users.uid <font color="#0000ff">AS</font> uid, <br> ( <font color="#0000ff">SELECT</font> <font color="#0000ff">COUNT</font> ( <font color="#0000ff">DISTINCT</font> thread_id) <font color="#0000ff">FROM</font> pm_index p <font color="#0000ff">WHERE</font> p.deleted = 0 <font color="#0000ff">AND</font> p.uid = users.uid) <font color="#0000ff">AS</font> <font color="#0000ff">count</font> , <br> ( <font color="#0000ff">SELECT</font> <font color="#0000ff">COUNT</font> ( <font color="#0000ff">DISTINCT</font> thread_id) <font color="#0000ff">FROM</font> pm_index p <font color="#0000ff">WHERE</font> p.deleted = 0 <font color="#0000ff">AND</font> p.is_new = 1 <font color="#0000ff">AND</font> p.uid = users.uid) <font color="#0000ff">AS</font> count_new <br> <font color="#0000ff">FROM</font> users users <br> <font color="#0000ff">WHERE</font> users.uid = 1</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  and returns the required values. <br><br>  I hope the instruction will be useful to someone.  If there is interest, I can write in more detail about Views, there is still a lot of interesting things: how to create your own settings for the fields, how to create the fields available in filters and sorts, your arguments and links, and much more. <br><br>  <b>UPD:</b> Transferred to the blog "Drupal".  Thanks for the karma. </div><p>Source: <a href="https://habr.com/ru/post/80663/">https://habr.com/ru/post/80663/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../80654/index.html">Which free OS distributions do you use?</a></li>
<li><a href="../80655/index.html">qTrack: the easiest task management system</a></li>
<li><a href="../80656/index.html">The idea of ‚Äã‚Äãselling terminal sessions</a></li>
<li><a href="../80657/index.html">Details about "undressing" scanners at airports</a></li>
<li><a href="../80658/index.html">Setting the resolution on an external monitor (openbox)</a></li>
<li><a href="../80667/index.html">ASRock H55DE3 motherboard review</a></li>
<li><a href="../80670/index.html">Pasteorg comparison for hosting code snippets</a></li>
<li><a href="../80672/index.html">Google apps started rolling out Google Drive for domains</a></li>
<li><a href="../80675/index.html">Nokia 5800 and that did not like after a month of use</a></li>
<li><a href="../80676/index.html">HP Envy 15 - USB 3.0 Laptop</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>