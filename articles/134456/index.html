<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create an RDS terminal farm using NLB technology and publish RD Web Access to ISA Server 2006</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, we want to achieve load balancing on our terminal servers, their fault tolerance, or we want to add a second server to the existing terminal serve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create an RDS terminal farm using NLB technology and publish RD Web Access to ISA Server 2006</h1><div class="post__text post__text-html js-mediator-article">  So, we want to achieve load balancing on our terminal servers, their fault tolerance, or we want to add a second server to the existing terminal server to increase the performance of the service.  In my example, I will implement the following scheme: <br><img src="https://habrastorage.org/storage1/8ff6ec9e/2bcb0750/76e32b5e/1b1fe3dd.png"><br><a name="habracut"></a><br>  As we see, to implement such a scheme, we need three servers.  Moreover, the role of the Broker can be installed on the server we already have, for example, on a file or print server.  For clarity, we call our servers as follows: <br><br><img src="https://habrastorage.org/storage1/d4e5cebb/8b08ea4e/6dd7a292/0cb32346.png"><br><br>  As we see, the name of our domain is domain.local.  For access to terminal services outside the domain name domain.ru will be used.  Thus, in our DNS domain.local domain, we will need to create an additional zone called domain.ru, where we will then create an RDS.domain.ru record that will refer to the IP address of the terminal farm. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  1. Install terminal services on an RDS1 server. </h4><br><br><h5>  1.1 Add the roles ‚ÄúRemote Desktop Services‚Äù (Remote Desktop Services) and ‚ÄúNetwork Policy and Access Services‚Äù (Network Policy and Access Services).  Select the following role services for installation: </h5><br><br>  - Remote Desktop Session Host (Remote Desktop Session Host) <br><br>  - Remote Desktop Gateway <br><br>  - Remote Desktop Web Access <br><br>  - Network Policy Server (NPS) <br><br>  When installing services, we tick the ‚ÄúRequire NLA‚Äù box; the rest of the settings will be configured later.  Reboot the server at the first request. <br><br><h5>  1.2 Let's create an RDFarm.domain.local record in the DNS of our domain, which will be assigned the IP address 192.168.0.80.  This will be the internal address of our farm, as well as the address of the NLB cluster. </h5><br><br><h5>  1.3 Let's create in the DNS zone domain.ru of our domain an RDS.domain.ru record, to which we will assign the same IP address as the cluster address - 192.168.0.80.  This will be the external address of our farm through which remote users will log in. </h5><br><br><h5>  1.4 Go to the Remote Desktop Services - RemoteApp Manager - RD Gateway snap-in and configure the settings as follows: </h5><br><br><img src="https://habrastorage.org/storage1/594acc28/9fc01c59/c8788157/d36781f4.png"><br><br>  On the Digital Signature tab, we indicate the certificate that must be previously requested.  To complete this step, you must have a certificate authority (CA) in your domain.  On the RDS1 server, run mmc and add the Certificates (computer account) snap-in: <br><br><img src="https://habrastorage.org/storage1/7b707a3f/013d0f11/00e97f12/c0b68612.png"><br><br><img src="https://habrastorage.org/storage1/1545f602/aff8f7db/d40ce739/57dd9625.png"><br><br><img src="https://habrastorage.org/storage1/523837cd/80112051/532a8f1c/4d560ab2.png"><br><br><img src="https://habrastorage.org/storage1/bfae1139/a3dac92d/b1cf2085/fae3751f.png"><br><br><img src="https://habrastorage.org/storage1/82ce71f6/67dffa5d/fca0da60/1a6497d5.png"><br><br>  After receiving the certificate, export it to a pfx file ‚Äî we will need it to configure the second server. <br><br>  Now on the Digital Signature tab we can indicate our certificate: <br><br><img src="https://habrastorage.org/storage1/c077bc52/5902e6ee/69c00791/12eacb4c.jpg"><br><br><h5>  1.5 Go to the Remote Desktop Services snap-in - RemoteApp Manager and in the RemoteApp Programs section and add one remote application.  Let it be a calculator. </h5><br><br><img src="https://habrastorage.org/storage1/0c9b3f1c/4d8bce98/0aac0fb3/ed0d5077.png"><br><br>  Click the "Properties" button and add to the list of users who can run our Calculator, the rd_users group. <br><br><img src="https://habrastorage.org/storage1/37ebf246/a34d4dfd/fecbd264/2a59d51f.jpg"><br><br><h5>  1.6 Go to the snap-in Remote Desktop Services - RD Gateway Manager and configure the properties of RDS1 (Local).  But before that, you need to request another certificate (see clause 1.4), but this time with the Common Name of the external address - RDS.domain.ru. </h5><br><br><img src="https://habrastorage.org/storage1/9662be7b/8dca10de/249d257e/99a8c7a1.png"><br><br><img src="https://habrastorage.org/storage1/cf38749f/0e4a1a91/2fe89852/b3de713b.png"><br><br>  On the Private Key tab, do not forget to specify that the key can be exported. <br><br>  After receiving the certificate, export it to a pfx file ‚Äî we will need it to configure the second server. <br><br>  Now we specify this certificate in the properties of our remote desktop gateway: <br><br><img src="https://habrastorage.org/storage1/cb0d747e/60cada2f/87698351/a393311d.jpg"><br><br>  Go to the Server Farm tab, where we will add our RDS1 server to the gateway farm: <br><br><img src="https://habrastorage.org/storage1/24442595/44b4db36/c783501f/292b09f7.jpg"><br><br>  Please note that at this stage the status field does not have to be ‚ÄúOK‚Äù. <br><br><h5>  1.7 Go to the Remote Desktop Services - RD Gateway Manager - RDS1 (Local) - Policies - Connection Authorization Policies snap-in and create a connection authorization policy using the wizard: </h5><br><br><img src="https://habrastorage.org/storage1/356c3d85/03b830bd/d04d6930/9ad6f11a.jpg"><br><br>  Add to the list of authorized users to connect the group rdg_users, which will include all those who need to get access to terminal services. <br><br><img src="https://habrastorage.org/storage1/baf3a086/b190f62a/267da06e/5dfdf299.jpg"><br><br><h5>  1.8 Go to the snap-in Remote Desktop Services - RD Gateway Manager - RDS1 (Local) - Policies - Resource Authorization Policies and create an application authorization policy bypassing the wizard (Create New Policy - Custom): </h5><br><br><img src="https://habrastorage.org/storage1/ffdbdc69/3f9d24e0/80fd2047/822e9177.png"><br><br><img src="https://habrastorage.org/storage1/888e9150/50c56177/652f6a5d/9955fd1b.jpg"><br><br><img src="https://habrastorage.org/storage1/4a117250/b3695f7a/dd3dc099/abaf187a.png"><br><br><img src="https://habrastorage.org/storage1/0888f289/d9202465/e8cbe1bc/a7adaf10.png"><br><br><h5>  1.9 Go to the Remote Desktop Services - RD Session Host Configuration snap-in and configure the RDP-Tcp connection properties as follows: </h5><br><br><img src="https://habrastorage.org/storage1/e669d53f/d4e57e74/ab69ac84/e5ed1cbb.png"><br><br>  Click on the ‚ÄúSelect‚Äù button and specify the certificate with the Common Name of our farm - RDFarm.domain.local (it was already installed on the server in paragraph 1.4). <br><br><img src="https://habrastorage.org/storage1/51878d00/c582a78d/87fda04a/0c30b5ed.png"><br><br>  The remaining parameters are not configurable. <br><br>  Here, in RD Session Host Configuration, we configure licensing parameters. <br><br><img src="https://habrastorage.org/storage1/2d1213d7/b716b037/0d6cb87a/254d2b30.jpg"><br><br><h5>  1.10 To check the settings of the RemoteApp application, go to <a href="https://localhost/RDWeb">localhost / RDWeb</a> </h5><br><br><h4>  2. Install terminal services on an RDS2 server. </h4><br><br><h5>  2.1 Add the roles ‚ÄúRemote Desktop Services‚Äù (Remote Desktop Services) and ‚ÄúNetwork Policy and Access Services‚Äù (Network Policy and Access Services).  Select the following role services for installation: </h5><br><br>  - Remote Desktop Session Host (Remote Desktop Session Host) <br><br>  - Remote Desktop Gateway <br><br>  - Remote Desktop Web Access <br><br>  - Network Policy Server (NPS) <br><br>  When installing services, we tick the ‚ÄúRequire NLA‚Äù box; the rest of the settings will be configured later.  Reboot the server at the first request. <br><br><h5>  2.2 Configure the second RDS2 server in the same way as our first server is configured, except that you do not need to request certificates - they must be imported from the RDS1 server.  To import certificates, run mmc and add the Certificates (computer account) snap-in: </h5><br><br><img src="https://habrastorage.org/storage1/7b707a3f/013d0f11/00e97f12/c0b68612.png"><br><br><img src="https://habrastorage.org/storage1/8af6ab3f/40dd9163/bdb1a491/aab171a1.png"><br><br>  Specify the path to the pfx files containing the certificates and import them into the personal certificates of the RDS2 computer. <br><br><h4>  3. Creating and configuring a terminal farm. </h4><br><br><h5>  3.1 Install the RD Connection Broker role on the BROKER server. <br><br>  3.2 Add the RDS1 and RDS2 servers to the Session Broker Computers local group on the BROKER server. <br><br>  3.3 We add all our three servers to the TS Web Access Computers local group on the RDS1 and RDS2 servers <br><br>  3.4 On the BROKER server, we add our RDS1 and RDS2 servers to the RD Web Access group (Admin Tools&gt; Remote Desktop Services&gt; Remote Desktop Connection Manager&gt; Add RD Web Access Server). <br><br>  3.5 First on the RDS1 server and then on the RDS2, go to Remote Desktop Services&gt; Remote Desktop Session Host Configuration and change the settings of the RD Connection Broker: </h5><br><br><img src="https://habrastorage.org/storage1/162d613f/1ecff9ed/45692d74/5960746b.png"><br><br><h5>  3.6 Configuring RemoteApp applications to work with our farm.  To do this, on the RDS1 and RDS2 servers, go to Remote Desktop Services&gt; RemoteApp Manager and change the Server Name parameter: </h5><br><br><img src="https://habrastorage.org/storage1/4f118d91/31fdd4e3/1a74afa4/78a81cc8.png"><br><br><h5>  3.7 On the BROKER server, go to Remote Desktop Services&gt; Remote Desktop Connection Manager&gt; RemoteApp Sources and click the button "Add RemoteApp Source ...": </h5><br><br><img src="https://habrastorage.org/storage1/58350419/e5b5c8d1/071bcb64/9e377402.png"><br><br>  Add all our possible RemoteApp resources: RDFarm.domain.local, RDS1.domain.local, RDS2.domain.local and RDS.domain.ru. <br><br><h4>  3.8 Create an NLB cluster. </h4><br><br><h5>  3.8.1 Install the Network Load Balancing component on RDS1 and RDS2 servers.  Next, open the Network Load Balancing Manager snap-in on the RDS1 server and create a cluster: </h5><br><br><img src="https://habrastorage.org/storage1/b6fdf5bb/9ec97017/897a595f/85d0cf6b.jpg"><br><br><img src="https://habrastorage.org/storage1/7e98570d/9eddc2c2/195ae5c8/538a736f.png"><br><br><img src="https://habrastorage.org/storage1/5af10a93/2356c461/6298c27f/c572bc47.png"><br><br><img src="https://habrastorage.org/storage1/008d31dd/42322090/280d91a1/6014b215.jpg"><br><br>  We include in the balancing only 443 and 3389 TCP ports. <br><br><img src="https://habrastorage.org/storage1/12c0f27d/32070607/61ce8430/3ab5c54d.png"><br><br><h5>  3.8.2 Add a second computer (RDS2) to the NLB cluster <br><br>  3.9 Make sure that on the RDS1 and RDS2 servers, in the properties of the RD Gateway Manager server, both our servers are listed on the Server Farm tab: </h5><br><br><img src="https://habrastorage.org/storage1/73438a4f/2e85e5e1/17dd887c/7d522372.jpg"><br><br><h5>  3.10 On the RDS1 and RDS2 servers, go to the IIS Manager snap-in, then Sites - Default Web Site - RDWeb - Pages and on the right click Application Settings, where we set the DefaultTSGateway parameter to RDS.domain.ru: </h5><br><br><img src="https://habrastorage.org/storage1/08103460/0e5ff9bf/5f2b28b4/9cf2ac27.jpg"><br><br><h4>  4. Publish the RemoteApp application farm on ISA Server. </h4><br><br>  First you need to install our certificate with the Common Name "RDS.domain.ru" on the ISA server (you can do it the same way as in the case of the RDS2 server, when we transferred the certificate to it from RDS1). <br><br>  I will not discuss this section in too much detail, but I will manage only the most important screenshots with the settings of the publishing rule and the creation of a WEB listener: <br><br><img src="https://habrastorage.org/storage1/94d853f3/7a436eae/ea3ce04a/594608ef.png"><br><br><img src="https://habrastorage.org/storage1/421092f5/986ec76e/98861cff/a1d89dd3.png"><br><br><img src="https://habrastorage.org/storage1/8f4863b4/73edc498/5d9a6b43/8dc2e6d0.png"><br><br><img src="https://habrastorage.org/storage1/6dcf127b/58acea9c/98a19aac/644970cf.png"><br><br><img src="https://habrastorage.org/storage1/06cd2f56/0cc545f7/a7ad5400/a7599196.png"><br><br><img src="https://habrastorage.org/storage1/592183f2/224abe5b/2eeb4845/e805d98a.png"><br><br><img src="https://habrastorage.org/storage1/8fdcf13c/1387efa1/0d422a6d/d1fb9879.png"><br><br><img src="https://habrastorage.org/storage1/7a5a27cb/9a5073f2/74da2362/a2585133.jpg"><br><br><img src="https://habrastorage.org/storage1/28f5656d/b3d4d576/2c4fd745/3b1a26f5.png"><br><br><img src="https://habrastorage.org/storage1/7ad1d1b3/a307e113/184dc019/c65a0df7.png"><br><br><img src="https://habrastorage.org/storage1/4cce3b7f/cc8ab16d/199c7c31/386163ea.png"><br><br><img src="https://habrastorage.org/storage1/511ebb8b/fd77346c/61710b4e/ae71497d.png"><br><br><img src="https://habrastorage.org/storage1/78a2176f/f07c46ea/23f1b742/c40ee17c.png"><br><br><img src="https://habrastorage.org/storage1/8adb8330/a1c9516a/aac69d99/88321ec8.png"><br><br><img src="https://habrastorage.org/storage1/1b10940a/f44df4a6/8b02d4a9/13219c80.png"><br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/134456/">https://habr.com/ru/post/134456/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134448/index.html">Imagine Cup Meeting in Tomsk</a></li>
<li><a href="../134450/index.html">Russian startups in the Spanish village</a></li>
<li><a href="../134452/index.html">Path to Intel Programming Wizard</a></li>
<li><a href="../134453/index.html">Configure SSL for TomCat</a></li>
<li><a href="../134454/index.html">Expert system in 1832</a></li>
<li><a href="../134457/index.html">Work with PySide</a></li>
<li><a href="../134461/index.html">Google Celebrates Robert Noyes 84th Birthday</a></li>
<li><a href="../134462/index.html">Selenium: working with page elements using @FindBy and PageFactory</a></li>
<li><a href="../134464/index.html">How to create a secure system. A brief introduction to SDL</a></li>
<li><a href="../134465/index.html">Kitchen computer table</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>