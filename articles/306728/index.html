<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL. How to keep cats or the history of one migration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The story is taken from a real project. But since the real project is too boring (and under the NDA), this article uses a simplified example. 

 There...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL. How to keep cats or the history of one migration</h1><div class="post__text post__text-html js-mediator-article">  The story is taken from a real project.  But since the real project is too boring (and under the NDA), this article uses a simplified example. <br><br>  There was once a project.  And he had a database.  And there was a table in the database for storage, well, let's say, cats.  Here it is: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cats ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span>, cname <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), ctype <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) );</code> </pre> <br>  It's pretty simple: every cat has an id, a name, and a type. <br><br>  Of course, we had business requirements for cats and their types.  For example, we knew for sure that we have the <b>big furry</b> , <b>neko</b> and <b>sudden danger</b> types.  They assumed that the types of <b>long tail</b> and <b>sleeper-eater</b> may appear.  But we expected the requirements to change.  And while it is not known what types will be needed in the end.  Therefore, the <b>varchar (20)</b> data type was used. <br><a name="habracut"></a><br>  After a long time and several releases, we finally made an accurate list of types of cats.  By this time, there were already tens of millions of cats in the table with very different types, many of which are outdated.  It was necessary to restore order, bring all the values ‚Äã‚Äãin the table in line with the new requirements. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <hr><br>  So let's apply the engineering approach: <br><ul><li>  let's build a theory </li><li>  check it out with experiments </li><li>  develop a practical solution based on the theory </li><li>  apply the solution and evaluate the result. </li></ul><br><h2>  We build a theory </h2><br><br>  Create an ENUM data type and list valid values ‚Äã‚Äãin it.  Then do the migration: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> cat_type <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ENUM (<span class="hljs-string"><span class="hljs-string">'big furry'</span></span>, <span class="hljs-string"><span class="hljs-string">'small red'</span></span>, <span class="hljs-string"><span class="hljs-string">'long tail'</span></span>, <span class="hljs-string"><span class="hljs-string">'crafty hunter'</span></span>, <span class="hljs-string"><span class="hljs-string">'sudden danger'</span></span>, <span class="hljs-string"><span class="hljs-string">'sleeper-eater'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cats <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> ctype <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> cat_type <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> ctype::cat_type;</code> </pre><br>  We still do not know that in this form migration will not work.  Forgot about invalid values ‚Äã‚Äãalready existing in the table.  We learn about this later, when we try to apply migration =) <br><br>  So we forbid the creation of cats with an unacceptable value of type.  And also reduce the size of the table and the size of the index across the ctype field.  The size of the table is not so important, but reducing the index is good.  We have already dealt with indexes that did not fit in RAM.  And this, to put it mildly, not very useful indices. <br><br>  Let's estimate what memory gains can be expected. <br><br>  For storing a varchar value, 1‚Äì4 bytes per character are allocated (depending on the encoding) and 1 or 4 more bytes are stored for storing the length of the string (for more, see <a href="https://www.postgresql.org/docs/current/static/datatype-character.html">www.postgresql.org/docs/current/static/datatype-character.html</a> ).  In our case, this is 1 byte per character (utf8, Latin letters) and 1 byte per line length.  Strings are 9-14 characters long.  We assume that on average we have 12 bytes per value. <br><pre> <code class="sql hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_column_size(<span class="hljs-string"><span class="hljs-string">'big furry'</span></span>); 10 &gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_column_size(<span class="hljs-string"><span class="hljs-string">'sleeper-eater'</span></span>); 14</code> </pre><br>  It is known that enum values ‚Äã‚Äãoccupy 4 bytes, regardless of their length. <br><pre> <code class="sql hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_column_size(<span class="hljs-string"><span class="hljs-string">'big furry'</span></span>::cat_type); 4 &gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_column_size(<span class="hljs-string"><span class="hljs-string">'sleeper-eater'</span></span>::cat_type); 4</code> </pre><br>  One row in the table is: <br><ul><li>  27 bytes per row header </li><li>  8 bytes id, </li><li>  21 bytes cname (we assume that all cats have names of 20 characters each), </li><li>  12 bytes ctype </li></ul><br>  Total: 68 bytes. <br><br>  After migration will be 27 + 8 + 21 + 4 = 60 bytes.  The difference is small, but for 50 million lines the total gain should be significant. <br>  We have 2 indexes, by id and by ctype.  The index on id will not change.  The ctype index should decrease.  We don‚Äôt know how the index memory is arranged, but we expect that if one value has decreased by 3 times, then the index will decrease by 2-3 times. <br><br><h2>  Experiment number 1 </h2><br>  For the experiment, create two tables: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cats1 ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) );</code> </pre><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> cat_type <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ENUM (<span class="hljs-string"><span class="hljs-string">'big furry'</span></span>, <span class="hljs-string"><span class="hljs-string">'small red'</span></span>, <span class="hljs-string"><span class="hljs-string">'long tail'</span></span>, <span class="hljs-string"><span class="hljs-string">'crafty hunter'</span></span>, <span class="hljs-string"><span class="hljs-string">'sudden danger'</span></span>, <span class="hljs-string"><span class="hljs-string">'sleeper eater'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cats2 ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> cat_type, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) );</code> </pre><br>  Fill it with test data: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> ss; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> cats1 (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">md5</span></span>(random()::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>), (<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-string"><span class="hljs-string">'big furry'</span></span>, <span class="hljs-string"><span class="hljs-string">'small red'</span></span>, <span class="hljs-string"><span class="hljs-string">'long tail'</span></span>, <span class="hljs-string"><span class="hljs-string">'crafty hunter'</span></span>, <span class="hljs-string"><span class="hljs-string">'sudden danger'</span></span>, <span class="hljs-string"><span class="hljs-string">'sleeper eater'</span></span>]) [<span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'ss'</span></span>) % <span class="hljs-number"><span class="hljs-number">5</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">500000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> cats2 (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">md5</span></span>(random()::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>), ((<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-string"><span class="hljs-string">'big furry'</span></span>, <span class="hljs-string"><span class="hljs-string">'small red'</span></span>, <span class="hljs-string"><span class="hljs-string">'long tail'</span></span>, <span class="hljs-string"><span class="hljs-string">'crafty hunter'</span></span>, <span class="hljs-string"><span class="hljs-string">'sudden danger'</span></span>, <span class="hljs-string"><span class="hljs-string">'sleeper eater'</span></span>]) [<span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'ss'</span></span>) % <span class="hljs-number"><span class="hljs-number">5</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>])::cat_type <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">500000</span></span>);</code> </pre><br>  Yes, the names of our cats are rather strange.  But for the experiment are suitable. <br><br>  Create indices: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> cats1_index <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> cats1(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> cats2_index <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> cats2(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>);</code> </pre><br>  And let's see how much memory they occupied: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pg_relation_size(<span class="hljs-string"><span class="hljs-string">'cats1'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> table_size, pg_indexes_size(<span class="hljs-string"><span class="hljs-string">'cats1'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> indexes_size; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pg_relation_size(<span class="hljs-string"><span class="hljs-string">'cats2'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> table_size, pg_indexes_size(<span class="hljs-string"><span class="hljs-string">'cats2'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> indexes_size;</code> </pre><br>  Theoretically, the rows in the first table occupy 68 * 500,000 = 34,000,000 bytes, in the second table 60 * 500,000 = 30,000,000 bytes.  In practice, we see 34,136,064 and 30,121,984 bytes.  The figures turned out to be close. <br><br>  It is clear that the table is more complex than just 500,000 rows evenly one after the other.  There are allocated memory pages of 8 KB.  Pages have their own titles and other meta-information.  And the values ‚Äã‚Äãin the lines are somehow aligned (for more, see <a href="https://www.postgresql.org/docs/9.5/static/storage-page-layout.html">www.postgresql.org/docs/9.5/static/storage-page-layout.html</a> ). <br><br>  But what about indexes? <br>  The <b>pg_indexes_size</b> function shows the total memory consumption for all indexes associated with the table, and not for each separately.  But it does not matter, we can call it before creating an index on ctype and after.  And then we will see that the index by id is 11,255,808 bytes, and the indices by ctype for the first table are 15,794,176 bytes, and for the second table it is 11,255,808 bytes. <br>  Noticeably less, but not 2-3 times, as we expected.  Why is that? <br><br><h2>  Experiment number 2 </h2><br>  Create several simple tables containing only one column: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> t_bool (f <span class="hljs-built_in"><span class="hljs-built_in">bool</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> t_sint (f <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> t_int (f <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> t_bint (f <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> t_c7 (f <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">7</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> t_c8 (f <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> t_c9 (f <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> t_c15 (f <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> t_c16 (f <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">16</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> t_c20 (f <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>));</code> </pre><br>  Fill them with data: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> t_bool (f) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">500000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> t_sint (f) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">500000</span></span>); ... <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> t_c7 (f) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'abcdefg'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">500000</span></span>); ... <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> t_c20 (f) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'abcd efgh abcd efgh '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">500000</span></span>);</code> </pre><br>  Create indices: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_bool(f); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_sint(f); ... <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_c20(f);</code> </pre><br>  And let's see how much space the table and index take: <br><table><tbody><tr><td>  <b>Data type</b> <br></td><td>  <b>Byte per value</b> <br></td><td>  <b>Size table</b> <br></td><td>  <b>Index size</b> <br></td></tr><tr><td>  bool <br></td><td>  one <br></td><td>  18,128,896 <br></td><td>  11,255,808 <br></td></tr><tr><td>  smallint <br></td><td>  2 <br></td><td>  18,128,896 <br></td><td>  11,255,808 <br></td></tr><tr><td>  int <br></td><td>  four <br></td><td>  18,128,896 <br></td><td>  11,255,808 <br></td></tr><tr><td>  bigint <br></td><td>  eight <br></td><td>  18,128,896 <br></td><td>  11,255,808 <br></td></tr><tr><td>  char (7) <br></td><td>  eight <br></td><td>  18,128,896 <br></td><td>  11,255,808 <br></td></tr><tr><td>  char (8) <br></td><td>  9 <br></td><td>  22,142,976 <br></td><td>  15.794,176 <br></td></tr><tr><td>  char (9) <br></td><td>  ten <br></td><td>  22,142,976 <br></td><td>  15.794,176 <br></td></tr><tr><td>  char (15) <br></td><td>  sixteen <br></td><td>  22,142,976 <br></td><td>  15.794,176 <br></td></tr><tr><td>  char (16) <br></td><td>  17 <br></td><td>  26,091,520 <br></td><td>  20,332,544 <br></td></tr><tr><td>  char (20) <br></td><td>  21 <br></td><td>  26,091,520 <br></td><td>  20,332,544 <br></td></tr></tbody></table><br>  We see that the sizes of the table and the index are the same in the ranges of values ‚Äã‚Äã1-8 bytes, 9-16 bytes and more than 16 bytes. <br>  It seems that small optimizations, such as replacing an int with a smallint, provide little benefit.  Well, except in some cases, when in one table there are many columns that can be so optimized. <br>  Replacing varchar with enum gives a win if the varchar values ‚Äã‚Äãare on average more than 8 bytes (longer than 7 characters). <br><br><h2>  We are developing a practical solution. </h2><br>  Now we know what to expect in practice, and are ready to realize our migration. <br>  We return to our cats: <br><pre> <code class="ruby hljs">CREATE TABLE cats ( id serial, cname varchar(<span class="hljs-number"><span class="hljs-number">20</span></span>), ctype varchar(<span class="hljs-number"><span class="hljs-number">20</span></span>), primary key(id) ); CREATE INDEX c1 ON cats(ctype);</code> </pre><br>  We fill the table with data so that it contains invalid and NULL values. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> ss; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> cats (cname, ctype) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">md5</span></span>(random()::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>), (<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-string"><span class="hljs-string">'big furry'</span></span>, <span class="hljs-string"><span class="hljs-string">'small red'</span></span>, <span class="hljs-string"><span class="hljs-string">'long tail'</span></span>, <span class="hljs-string"><span class="hljs-string">'crafty hunter'</span></span>, <span class="hljs-string"><span class="hljs-string">'sudden danger'</span></span>, <span class="hljs-string"><span class="hljs-string">'sleeper-eater'</span></span>, <span class="hljs-string"><span class="hljs-string">'black eye'</span></span>, <span class="hljs-string"><span class="hljs-string">'sharp claw'</span></span>, <span class="hljs-string"><span class="hljs-string">'neko'</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>]) [<span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'ss'</span></span>) % <span class="hljs-number"><span class="hljs-number">10</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">500000</span></span>);</code> </pre><br>  Trying to migrate: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> cat_type <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ENUM (<span class="hljs-string"><span class="hljs-string">'big furry'</span></span>, <span class="hljs-string"><span class="hljs-string">'small red'</span></span>, <span class="hljs-string"><span class="hljs-string">'long tail'</span></span>, <span class="hljs-string"><span class="hljs-string">'crafty hunter'</span></span>, <span class="hljs-string"><span class="hljs-string">'sudden danger'</span></span>, <span class="hljs-string"><span class="hljs-string">'sleeper-eater'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cats <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> ctype <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> cat_type <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> ctype::cat_type;</code> </pre><br>  And we find out that our naive ALTER TABLE does not work: <br><pre> <code class="sql hljs">ERROR: invalid input value for enum cat_type: "black eye"</code> </pre><br>  And you need to write a function to convert the type: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> cast_to_cat_type(ctype <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> cat_type <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> res cat_type; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> ctype <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'big furry'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> res := <span class="hljs-string"><span class="hljs-string">'big furry'</span></span>; WHEN 'small red' THEN res := 'small red'; WHEN 'long tail' THEN res := 'long tail'; WHEN 'crafty hunter' THEN res := 'crafty hunter'; WHEN 'sudden danger' THEN res := 'sudden danger'; WHEN 'sleeper-eater' THEN res := 'sleeper-eater'; ELSE res := NULL; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span>; RETURN res; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plpgsql;</code> </pre><br>  And try again: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cats <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> ctype <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> cat_type <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> cast_to_cat_type(ctype);</code> </pre><br>  This time it worked.  Just to show someone such a function is embarrassing.  Oh, I think I just gave out my secret propensity to copy-paste =) Shh, let's pretend that I did not write this, but you did not see it, ok?  And I will write differently: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> cast_to_cat_type(ctype <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> cat_type <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> res cat_type; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> res := ctype::cat_type; EXCEPTION WHEN others THEN res := NULL; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; RETURN res; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plpgsql;</code> </pre><br>  Here it can be safely sent to code review. <br><br><h2>  Evaluate the result </h2><br>  What we got in the end?  The sizes of the table and indexes before migration: 33,038,336 and 26,140,672 bytes.  After migration: 28,581,888 and 22,511,616 bytes.  Considering that in the real table we have not 500 thousand records, but 50 million, the gain will be substantial. <br>  But under some conditions you can win even more.  Suppose a business is not interested in cats of the wrong or unknown type, in requests they are excluded.  Then you can exclude them from the index. <br><br>  Use the <a href="https://www.postgresql.org/docs/current/static/indexes-partial.html">partial index</a> : <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> CONCURRENTLY c2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> cats(ctype) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ctype <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> c1;</code> </pre><br>  And now the size of the indices is 18,014,208 bytes.  Here, of course, everything will depend on how many cats we have turned out to be wrong. <br>  Curious question, what to do next with the wrong cats.  But this is a question for the business, not for the developer. <br><br>  It remains to make sure that the correct values ‚Äã‚Äãare inserted into the table, and incorrect values ‚Äã‚Äãare not inserted: <br><pre> <code class="sql hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> cats (cname, ctype) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'Murzik'</span></span>, <span class="hljs-string"><span class="hljs-string">'crafty hunter'</span></span>), (<span class="hljs-string"><span class="hljs-string">'Vasjka'</span></span>, <span class="hljs-string"><span class="hljs-string">'sleeper-eater'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> &gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> cats (cname, ctype) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'Sharik'</span></span>, <span class="hljs-string"><span class="hljs-string">'big dog'</span></span>); ERROR: invalid input value for enum cat_type: "big dog"</code> </pre><br>  Everything works as it should. <br><br>  <i>We also have a couple of interesting migration stories, and how difficult it is to live with large tables.</i>  <i>Let's tell about it next time.</i> <br><br>  Yura Zhloba, <br>  Web developer. </div><p>Source: <a href="https://habr.com/ru/post/306728/">https://habr.com/ru/post/306728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306714/index.html">Open Ivideon API: First Steps</a></li>
<li><a href="../306716/index.html">Frontend developers should be on topic</a></li>
<li><a href="../306720/index.html">Evening of December 31</a></li>
<li><a href="../306724/index.html">Tools for prototyping: from a quick-assembled layout to full-featured prototypes</a></li>
<li><a href="../306726/index.html">Youtube Player - creating your own JavaScript player</a></li>
<li><a href="../306732/index.html">Bottom navigation</a></li>
<li><a href="../306734/index.html">Migration to the cloud. Simple steps to improve business performance</a></li>
<li><a href="../306736/index.html">Graphic password does not allow the viewer to steal himself.</a></li>
<li><a href="../306738/index.html">AppCode 2016.2: new refactorings and inspections, live templates, improvements to code autocompletion, and all this is about Swift</a></li>
<li><a href="../306742/index.html">Responsive Search for UITableView</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>