<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up a Mikrotik router for various tasks in SOHO</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a tracing paper with an internal instruction written by me personally, according to which we set up new routers in the company. The po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up a Mikrotik router for various tasks in SOHO</h1><div class="post__text post__text-html js-mediator-article">  This article is a tracing paper with an internal instruction written by me personally, according to which we set up new routers in the company.  The points will be arranged in a more or less chronological order, but each of them is an independent mini-instruction to one of the services used in our company. <br><a name="habracut"></a><br><h4>  1. Power on, initial setup </h4><br>  First you need to connect to the device.  By default, the configuration on the router is configured on the <code>192.168.88.0/24</code> subnet.  Open the address in the browser, download and save on your computer, <code>Winbox.exe</code> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/420/bd3/8e3/420bd38e3ee923752f46db1cebe9b7b0.png"><br><br>  Launch <code>Winbox</code> , on the contrary <code>Connect to</code> press the <code>"‚Ä¶"</code> button, and after a few seconds your router should appear in the list. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/bad/f67/345/badf673456ac9a1a2b75adccc6cb26e3.png"><br><br>  Double click the mouse on the MAC address and connect as <code>admin</code> without a password. <br>  When you first log in, the system will warn you that an automatic router configuration script has been launched.  Click the <code>Remove Configuration</code> button: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ffb/360/693/ffb360693019a71b17245e9665a64f3b.png"><br><br>  After that, we wait until the <code>Winbox</code> console closes, and after a few seconds we start <code>Winbox</code> again (from where you saved it) and again connect to the MAC address. <br>  Having connected, we select <code>Interfaces</code> on the left and delete unnecessary interfaces - <code>VLAN, Bridge</code> .  We go into the settings of each interface (there are only 5 of them on the company's router) and disable the <code>Master-port</code> and <code>proxy-arp</code> , bringing the settings to the following form: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6e8/e3a/cb5/6e8e3acb544eb35555f41277cd93f9d7.png"><br><br><h4>  2. IP issuance </h4><br>  Go to <code>IP ‚Äî Addresses</code> .  We issue the necessary addresses to the necessary interfaces.  In case of using a router in the Escort network, 2 Internet service providers and an internal network are connected to it.  The second internal network is formed via VPN.  We specify the required IP for each interface. <br><pre> <code class="bash hljs">[admin@Mikrotik] /ip address&gt; <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> Flags: X - disabled, I - invalid, D - dynamic <span class="hljs-comment"><span class="hljs-comment"># ADDRESS NETWORK INTERFACE 0 I ;;; , !!! 10.0.33.1/24 10.0.33.0 ether4-hosting-network 1 22.22.22.17/29 22.22.22.16 ether2-gateway2 2 11.11.11.1/28 11.11.11.0 ether1-gateway1 3 192.168.3.101/22 192.168.0.0 ether3-internal-network 4 I 192.168.4.2/22 192.168.4.0 ether4-hosting-network</span></span></code> </pre><br><br><h4>  3. Routing </h4><br><h5>  3.1.  Creating master and slave routes </h5><br>  Go to the <code>IP ‚Äî Routes</code> .  By default, interfaces are used instead of hosts for routing.  It is recommended to remove all static routes, and dynamic ones after changing statics will change themselves.  <b>Attention: in order to remove everything painlessly, you need to connect to the router via a local network, without using routes, otherwise the connection will be interrupted when you delete the main one</b> .  Next, create new routes: in the <code>Dst.Address</code> field <code>Dst.Address</code> specify 0.0.0.0/0, in the Gateway field, set the IP of the main gateway.  Do not forget about the distance - which route is shorter, it will be the main one.  In general, route settings should look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/39f/e35/5b5/39fe355b5b21bb68d1a77fc8b0038d49.png"><br><br>  For external interfaces, we specify 11.11.11.11 with a distance of 4 and 22.22.22.22 with a distance of 3 as gateways. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/106/0fa/f50/1060faf50ff83446850bc0a3f3df2dc2.png"><br><br>  After adding three routes (2 for external channels and 1 for the internal network), the router can be connected to the network and connected via IP 192.168.3.101 using the internal IP. <br><br><h5>  3.2.  Creating table routing </h5><br>  The configuration created above allows you to create 2 external interfaces, of which only one can work per unit of time ‚Äî that is, the one that has a smaller distance and that has more distance ‚Äî will work only when the cable is pulled out of the first interface.  For obvious reasons, this does not suit us - we need the simultaneous operation of two gateways.  To do this, you need to teach the router to return traffic to the interface from which the request came.  This is done by creating two additional routes and setting up a firewall.  First, create the necessary routes.  Previously created routes will also be useful, but you can clone them, because  they will change slightly.  To do this, click on the route created earlier, click the <code>Copy</code> button and add the <code>Routing Mark</code> - mark the routes with the interface name, respectively.  I called them <code>to_ISP1</code> and <code>to_ISP2</code> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/769/453/18d/76945318d01d373b93ba33a2925a6acb.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/fc9/f43/5a2/fc9f435a2101ce2afa5d34c9246f10d0.png"><br><br>  Next, go to <div class="spoiler">  <b class="spoiler_title">IP - Firewall - Mangle</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/4a9/df7/18c/4a9df718ceec368cea1b1ebb7007f29b.png"><br></div></div><br>  Create rules: <br><pre> <code class="bash hljs"> General: Chain: prerouting In-interface:      Connection Mark: no-mark ,   Action: Action: mark connection New Connection Mark: ISP1_conn Passthrough:  .</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Pictures to secure the material</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/4bb/055/762/4bb055762e23c2b55c37a4bae393fb2f.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/839/ac2/41e/839ac241eb0d4117a588de76d6ff54da.png"><br></div></div><br><br>  These actions must be repeated twice - for 2 external interfaces (brand <code>ISP1_conn</code> and <code>ISP2_conn</code> respectively). <br>  Next, you need to create 2 more rules that will direct outgoing traffic marked <code>ISP1_conn</code> and <code>ISP2_conn</code> to the routes marked above.  Create a rule: <br><pre> <code class="bash hljs">General: Chain: output Connection Mark: ISP1_conn Action: mark routing New Routing Mark: to_ISP1 Passthrough:  .</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Pictures</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/61b/fd8/667/61bfd86675f7485cbbde74c754d4dc51.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/45f/fc9/75a/45ffc975a726c48c1bf9b1c29e3253cf.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/7e2/420/e00/7e2420e005eb269d6ea6f6f91cf031a3.png"><br></div></div><br><br><h4>  4. Balancing routes in Master-Slave mode </h4><br>  So, we have achieved the presence of two simultaneously working gateways, one of which has the highest priority than the second.  The problem with this setting is that switching between gateways will be done only when the physical link on the device interface is dropped.  But there are other situations as well: there is no more money in the account, problems on the provider side and so on - situations in which even the main gateway is available, but there is no further traffic and in this case the main gateway will not be switched.  For auto- <code>Netwatch</code> , you need to use the <code>Netwatch</code> feature, which monitors the presence of traffic on the interfaces and switches traffic depending on the rules.  Configuring this functionality consists of 3 steps. <br><br><h5>  4.1.  Create switch scripts </h5><br>  Go to the <code>System ‚Äî Scripts</code> .  Create 4 scripts with the names <code>ISP1-DOWN, ISP1-UP, ISP2-DOWN, ISP2-UP</code> .  All scripts give maximum rights. <br><div class="spoiler">  <b class="spoiler_title">Script Contents</b> <div class="spoiler_text">  ISP1-DOWN: <br><pre> <code class="bash hljs">/ip route <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> [find dst-address=0.0.0.0/0 and gateway=11.11.11.11 and distance &gt;=4];</code> </pre><br>  ISP1-UP: <br><pre> <code class="bash hljs">/ip route <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> [find dst-address=0.0.0.0/0 and gateway=11.11.11.11 and distance &gt;= 4];</code> </pre><br>  ISP2-DOWN: <br><pre> <code class="bash hljs">/ip route <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> [find dst-address=0.0.0.0/0 and gateway=22.22.22.22 and distance &gt;=3];</code> </pre><br>  ISP2-UP: <br><pre> <code class="bash hljs">/ip route <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> [find dst-address=0.0.0.0/0 and gateway=22.22.22.22 and distance &gt;=3];</code> </pre><br></div></div><br><h5>  4.2.  Creating Netwatch Rules </h5><br>  Go to <code>Tools ‚Äî Netwatch</code> <br>  Create a new rule: <br><br><pre> <code class="bash hljs">host: 8.8.4.4 Interval: 00:00:10 timeout: 1000ms Up: ISP2-UP Down: ISP2-DOWN   : host: 8.8.8.8 Interval: 00:00:10 timeout: 1000ms Up: ISP1-UP Down: ISP1-DOWN</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Pictures</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/122/d3e/bdf/122d3ebdf27c48c57f471c2cfd246232.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/847/9e5/25a/8479e525a929d6fbb9ff86dfad0d862b.png"><br></div></div><br><h4>  4.3.  We create permanent independent routes. </h4><br>  Before each of the hosts (8.8.8.8 and 8.8.4.4), we prescribe a unique route with a reduced distance through different gateways (11.11.11.11 and 22.22.22.22). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9c5/f1f/2cd/9c5f1f2cda274aefe058905379976847.png"><br><br>  You can check the operation of <code>netwatch</code> breaking a logical (non-physical) link on one of the external interfaces.  In my company, a managed switch was used for this, where a port that was not adjacent to the router was extinguished.  Thus, the ping to host 8.8.8.8 failed, but the physical link was active.  After the termination of the ping, Netwatch extinguished the necessary routes and the internal network accessed the Internet through a backup interface. <br><br><h4>  5. We create NAT </h4><br>  Go to the <code>IP ‚Äî Firewall</code> , go to the tab <code>NAT</code> <br>  Create 2 rules for each of the external interfaces: <br><pre> <code class="bash hljs">Chain: srcnat Out-Interface:     Action: masquerade</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/86a/a76/6d8/86aa766d8ced172d87312dfe7f5d5422.png"><br></div></div><br>  You can check NAT by pinging one of the websites on the Internet from a computer connected to the internal interface of the router.  If you disable one of the two rules of NAT on the router, you can see how the trace to the selected host on the Internet changes. <br><br><h4>  6. Create a VPN server </h4><br><h5>  6.1.  We create the pool of IP addresses we need. </h5><br>  In the company's network, it was decided to use the subnet 192.168.168.0/22, with client addressing starting with 192.168.170.2 and the gateway address (of the router itself) 192.168.170.1 <br>  Go to the <code>IP ‚Äî Pool</code> and create a new <code>vpn-pool</code> with a range of 192.168.170.2-192.168.171.254: <br><img src="https://habrastorage.org/getpro/habr/post_images/c3a/b3f/c25/c3ab3fc25c15751b40fb9f2959c52202.png"><br><h5>  6.2.  Enable PPTP server </h5><br>  Go to the <code>PPP</code> menu item, then on the <code>Interfaces</code> tab we find the <code>PPTP Server</code> button.  Put the <code>Enabled, mschap2</code> and select <code>Default Profile: default-encoding</code> . <br><img src="https://habrastorage.org/getpro/habr/post_images/a4d/8f7/b19/a4d8f7b1942d0ef8162fc80e70d15933.png"><br><br><h5>  6.3.  Configure encryption </h5><br>  Go to the <code>PPP Profile</code> tab.  On the <code>General</code> tab, we specify the <code>Local Address: 192.168.170.1</code> , <code>Remote Address: vpn-pool</code> .  On the <code>Protocols</code> tab on the option <code>Use Encryption</code> set the answer option is <code>Yes</code> . <br><br><h5>  6.4.  Create accounts </h5><br>  Go to the <code>Secrets</code> tab.  Create user: <br><pre> <code class="bash hljs">Name:   Password:   Service: any Profile: default-encryption Local Address: 192.168.170.1 Remote Address: ,  ,   ,   vpn-pool.    ,    VPN    .</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/889/32c/fb7/88932cfb7c15c27dc31f150a076fad02.png"><br></div></div><br><h5>  6.5.  Batch account creation </h5><br>  For batch creation of secrets (accounts) VPN, you can use the script. <br>  You need to go to the <code>System ‚Äî Scripts</code> , click "create a new" and insert the text of the script we need. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/203/eea/95c/203eea95c408a8bb6fed272003e5c4c6.png"><br><div class="spoiler">  <b class="spoiler_title">Script text</b> <div class="spoiler_text"><pre> <code class="bash hljs">:global content [/file get [/file find name=vpnusers.txt] contents] ; :global contentLen [ :len <span class="hljs-variable"><span class="hljs-variable">$content</span></span> ] ; :global lineEnd 0; :global line <span class="hljs-string"><span class="hljs-string">""</span></span>; :global lastEnd 0; :<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> lineEnd [:find <span class="hljs-variable"><span class="hljs-variable">$content</span></span> <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$lastEnd</span></span> ] ; :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> line [:pick <span class="hljs-variable"><span class="hljs-variable">$content</span></span> <span class="hljs-variable"><span class="hljs-variable">$lastEnd</span></span> <span class="hljs-variable"><span class="hljs-variable">$lineEnd</span></span>] ; :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> lastEnd ( <span class="hljs-variable"><span class="hljs-variable">$lineEnd</span></span> + 2 ) ; :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> tmpArray [:toarray <span class="hljs-variable"><span class="hljs-variable">$line</span></span>] ; :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [:pick <span class="hljs-variable"><span class="hljs-variable">$tmpArray</span></span> 0] != <span class="hljs-string"><span class="hljs-string">""</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :put <span class="hljs-variable"><span class="hljs-variable">$tmpArray</span></span>; /ppp secret add name=[:pick <span class="hljs-variable"><span class="hljs-variable">$tmpArray</span></span> 0] password=[:pick <span class="hljs-variable"><span class="hljs-variable">$tmpArray</span></span> 1] \ <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-address=[:pick <span class="hljs-variable"><span class="hljs-variable">$tmpArray</span></span> 2] remote-address=[:pick <span class="hljs-variable"><span class="hljs-variable">$tmpArray</span></span> 3] \ profile=[:pick <span class="hljs-variable"><span class="hljs-variable">$tmpArray</span></span> 4] service=[:pick <span class="hljs-variable"><span class="hljs-variable">$tmpArray</span></span> 5]; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$lineEnd</span></span> &lt; <span class="hljs-variable"><span class="hljs-variable">$contentLen</span></span>)</code> </pre><br></div></div><br>  After creating the script, it is enough to create a file in which to adhere to the following syntax: <br><br> <code>,,IP_,IP_,_,</code> <br> <br><div class="spoiler">  <b class="spoiler_title">The finished file should look something like this.</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/537/eb7/3fe/537eb73fefd4d737f3663a2cdd222ead.png"><br></div></div><br>  <b>Please note that the last line is empty.</b>  If it is not left empty, the last filled line will not be processed. <br>  Next you need to open the menu item <code>Files</code> .  The created file must be dragged with the mouse into the resulting window.  The file must be called <code>vpnusers.txt</code> , otherwise the script will not work. <br>  After these preparations, you can go to <code>System ‚Äî Scripts</code> , select the script we need and click <code>Run Script</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/184/889/c7c/184889c7c2285aff3d49f8ecede44b42.png"><br><br>  As a result of the script, in <code>PPP ‚Äî Secrets</code> you can see the added accounts <br><br><img src="https://habrastorage.org/getpro/habr/post_images/430/ede/06a/430ede06a99b577096ae3977df3f8959.png"><br><br><h4>  7. Configure SSTP </h4><br>  <a href="http://en.wikipedia.org/wiki/Secure_Socket_Tunneling_Protocol">SSTP</a> requires certificates.  I used self-signed certificates issued by the <a href="https://openvpn.net/index.php/open-source/downloads.html">OpenVPN snap-in</a> .  To obtain certificates you do not need to put all the components <div class="spoiler">  <b class="spoiler_title">it is enough just indicated in the screenshots</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/d11/e7d/508/d11e7d508f83b15f959aa5e03464844c.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/5ae/e13/ca7/5aee13ca79ca9ddb83fd75d0ab549f81.png"><br></div></div><br>  Next, run cmd on behalf of the administrator and go to the <code>c:\Program Files\OpenVPN\easy-rsa\</code> directory (or <code>Program Files (x86)</code> , if you installed the 32-bit version of OpenVPN on 64-bit Windows).  Open for editing the file <code>vars.bat</code> .  If not, then rename <code>vars.bat.sample</code> to <code>vars.bat</code> and <code>vars.bat</code> it to the form: <br><div class="spoiler">  <b class="spoiler_title">vars.bat</b> <div class="spoiler_text"><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off rem Edit this variable to point to rem the openssl.cnf file included rem with easy-rsa. <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> HOME=%ProgramFiles%\OpenVPN\easy-rsa <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> KEY_CONFIG=openssl-1.0.0.cnf rem Edit this variable to point to rem your soon-to-be-created key rem directory. rem rem WARNING: clean-all will <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> rem a rm -rf on this directory rem so make sure you define rem it correctly! <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> KEY_DIR=keys rem Increase this to 2048 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you rem are paranoid. This will slow rem down TLS negotiation performance rem as well as the one-time DH parms rem generation process. <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> KEY_SIZE=1024 rem These are the default values <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> fields rem <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> will be placed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the certificate. rem Change these to reflect your site. rem Don<span class="hljs-string"><span class="hljs-string">'t leave any of these parms blank. set KEY_COUNTRY=RU set KEY_PROVINCE=Nsk set KEY_CITY=Novosibirsk set KEY_ORG=Escort set KEY_EMAIL=i_nichupienko@soft-escort.ru set KEY_CN=87.245.176.183 set KEY_NAME=temp_nie set KEY_OU=changeme set PKCS11_MODULE_PATH=changeme set PKCS11_PIN=1234</span></span></code> </pre><br></div></div><br>  Next, I cleanly edited the <code>build-ca.bat</code> : <br><div class="spoiler">  <b class="spoiler_title">build-ca.bat</b> <div class="spoiler_text"><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> %HOME% rem build a cert authority valid <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ten years, starting now <span class="hljs-string"><span class="hljs-string">"c:\Program Files\OpenVPN\bin\openssl.exe"</span></span> req -days 3650 -nodes -new -x509 -keyout %KEY_DIR%\%1.key -out %KEY_DIR%\%1.crt -config %KEY_CONFIG%</code> </pre><br></div></div><br>  After that, run in the following sequence: <br><br><pre> <code class="bash hljs">c:\Program Files\OpenVPN\easy-rsa&gt;vars.bat c:\Program Files\OpenVPN\easy-rsa&gt;clean-all.bat c:\Program Files\OpenVPN\easy-rsa&gt;build-ca.bat newuser</code> </pre><br><br>  You can just press enter to the questions of the last command in (the data entered in the <code>vars.bat</code> file will be used), and you can enter new data.  In general, as convenient. <br><div class="spoiler">  <b class="spoiler_title">Command execution</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/ae6/ef7/d1c/ae6ef7d1c2687913864e531bd870f0a2.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Result</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/fbb/2e2/1e4/fbb2e21e43b98330165d9bac170f722d.png"><br></div></div><br>  In the <code>Winbox</code> router, click the <code>Files</code> button and copy the resulting files from the folder using the Drag'n'Drop method. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/73c/3b8/5a7/73c3b85a7a2cfe2b0f72200233ef990c.png"><br><br>  Next in <code>Winbox</code> go to <code>System ‚Äî Certificates</code> .  Click <code>Import</code> , first select one file, then the second: <br><img src="https://habrastorage.org/getpro/habr/post_images/cdd/658/a62/cdd658a6259e280c3b10ebf05da4f126.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/385/67d/26d/38567d26d64bc1bddaa9dcbbeef56907.png"><br><br>  Go to the <code>PPP ‚Äî Profile</code> , open the <code>default-encryption</code> created earlier, click <code>Copy</code> and on the <code>Protocol</code> tab change the value of the <code>Use Encryption</code> field from <code>Yes</code> to <code>Required</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/72c/6e7/d70/72c6e7d70622f30d4be464a0966bc1ec.png"><br><br>  For the profile name, specify <code>SSTPprofile</code> . <br>  Then, in the <code>System ‚Äî PPP</code> go to the <code>Interface</code> tab and click the <code>SSTP-Server</code> button there.  We set the <code>Enabled</code> <code>SSTPProfile</code> , select <code>SSTPProfile</code> as the <code>Default Profile</code> and specify the certificate we need.  We select only <code>mschap2</code> as the authentication method. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1ac/88d/f87/1ac88df877661e790a456c945b79f4c3.png"><br><br>  Since when creating secrets (logins / passwords) for <code>PPP</code> we initially specified the type of service <code>Any</code> , but now we don‚Äôt need to create anything extra.  Connection is ready. <br><br>  Since this article is about configuring a router, and not a client, I will not discuss how to import this certificate into various operating systems and configure client SSTP connections.  I will only mention that the received certificate must be added to trusted root certification authorities. <br><br><h4>  8. Configure Key Firewall Rules </h4><br>  Go to <code>IP ‚Äî Firewall ‚Äî Filter Rules</code> <br><br><h5>  8.1.  Access to the router via <code>Winbox</code> from the internal network </h5><br>  Create a rule: <br><pre> <code class="bash hljs">Chain: Input Protocol: tcp Dst.Port: 8291 In. Interface: ether3-internal Action: accept</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/d2a/145/f33/d2a145f33177806921d9ae1f01cba40c.png"><br></div></div><br><h5>  8.2.  Ping out from the internal network </h5><br>  Create 2 rules: <br><pre> <code class="bash hljs">Chain: forward Protocol: icmp Out. Interface: ether1-gateway1  ether2-gateway2 (    , ..       .    ,   2) Action: accept</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/8dc/555/8a0/8dc5558a03f11b2790dcb021e9cbb7d9.png"><br></div></div><br><br><h5>  8.3.  Ping the internal network from the VPN network </h5><br><pre> <code class="bash hljs">Chain: forward Protocol: icmp Src.Address: 192.168.170.0/24 Dst.Address: 192.168.0.0/22 Action: accept</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/550/65a/d3a/55065ad3a3a80ca01f450edd86754947.png"><br></div></div><br><h5>  8.4.  RDP access from the VPN to the internal network </h5><br><pre> <code class="bash hljs">Chain: forward Protocol: tcp Src.Address: 192.168.170.0/24 Dst.Address: 192.168.0.0/22 Dst.Port: 3389 Action: accept</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/759/c69/25b/759c6925ba7100229d67e739091b7743.png"><br></div></div><br><h4>  9. Publication of port 80 of the machine 192.168.2.82 outside </h4><br>  Go to <code>IP ‚Äî Firewall ‚Äî NAT</code> <br><pre> <code class="bash hljs">Chain: dstnat Protocol: tcp Dst.Port: 80 In.Interface: ether1-gateway1 ( ether2-gateway2      ) Action: netmap To Addresses: 192.168.2.82 To Ports: 80</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/590/53b/992/59053b99201761553eb4136ea37e7cca.png"><br></div></div><br><h4>  10. Publication of port 3389 of the machine 192.168.2.82 to the VPN </h4><br>  This rule is necessary to create access without using routing on the client machine, since  machine 2.82 will have an additional <code>IP-:</code> from the same subnet segment as the VPN client. <br>  Go to <code>IP ‚Äî Firewall ‚Äî NAT</code> <br><pre> <code class="bash hljs">Chain: dstnat Dst.Address: 192.168.170.82 Protocol: tcp Dst.Port: 3389 Action: dst-nat To Addresses: 192.168.2.82 To Ports: 3389</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/d9c/568/1d3/d9c5681d3ca4e2b67ac9759174e613b5.png"><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/227913/">https://habr.com/ru/post/227913/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../227893/index.html">Install and configure openchange under CentOS 6.5</a></li>
<li><a href="../227897/index.html">Open networks and switches without OS</a></li>
<li><a href="../227903/index.html">Linux dominates supercomputers like never before</a></li>
<li><a href="../227907/index.html">Any Packt Publishing eBook can be purchased for $ 10.</a></li>
<li><a href="../227911/index.html">As I wrote checkers</a></li>
<li><a href="../227915/index.html">Algorithm Visualization</a></li>
<li><a href="../227917/index.html">Do not deny yourself anything: Facebook has added 20 more gender options. Now there are 70</a></li>
<li><a href="../227921/index.html">Three new items in MongoDB 2.8</a></li>
<li><a href="../227925/index.html">Forecast World Cup 2014 in the language of Wolfram</a></li>
<li><a href="../227927/index.html">SSD + raid0 - not so simple</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>