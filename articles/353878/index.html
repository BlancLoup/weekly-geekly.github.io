<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to hide DNS requests from the prying eyes of the provider</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Configuring 1.1.1.1 from Cloudflare and other DNS services still requires command line skills 

 Encrypting the traffic between your device and the DN...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to hide DNS requests from the prying eyes of the provider</h1><div class="post__text post__text-html js-mediator-article"><h3>  Configuring 1.1.1.1 from Cloudflare and other DNS services still requires command line skills </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/ff7/714/bb4/ff7714bb4ec4153bdb82472b5774d348.jpg"><br>  <i><font color="gray">Encrypting the traffic between your device and the DNS service will prevent unauthorized persons from monitoring traffic or changing the address</font></i> <br><br>  <a href="https://arstechnica.com/tech-policy/2017/12/goodbye-net-neutrality-ajit-pais-fcc-votes-to-allow-blocking-and-throttling/">The death of network neutrality</a> and the weakening of the rules for Internet service providers to handle network traffic have caused many concerns about confidentiality.  Providers (and other unauthorized persons who monitor passing traffic) have long had a tool to easily monitor the behavior of people on the Internet: these are their domain name servers (DNS).  Even if they have not yet monetized this data (or did not replace traffic), they probably will soon begin. <br><br>  DNS is a telephone directory of the Network that issues the actual network IP address associated with the hosting and domain names of sites and other Internet services.  For example, it turns arstechnica.com into 50.31.169.131.  Your Internet provider offers DNS in a package of services, but it can also log DNS-traffic - in fact, record the history of your actions on the Internet. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      "Open" DNS-services allow you to bypass the services of providers for the sake of privacy and security, and in some countries - to avoid content filtering, surveillance and censorship.  April 1 (not a joke), the company Cloudflare launched its new, free and high-performance DNS-service designed to improve the privacy of users on the Internet.  It also promises to completely hide DNS traffic from prying eyes using encryption. <br><a name="habracut"></a><br>  Named for its IP address, service <a href="https://1.1.1.1/">1.1.1.1</a> is the result of a partnership with the APNIC research team, the Asia-Pacific Network Information Center, one of the five regional Internet registrars.  Although it is also available as an ‚Äúopen‚Äù normal DNS resolver (and very fast), Cloudflare still supports two DNS encryption protocols. <br><br>  Although it was developed with some unique ‚Äúbuns‚Äù from Cloudflare, but 1.1.1.1 is not the first encrypted DNS service.  <a href="https://arstechnica.com/information-technology/2017/11/new-quad9-dns-service-blocks-malicious-domains-for-everyone/">Quad9</a> , OpenDNS from Cisco, service 8.8.8.8 from Google, and many smaller services that support various full DNS encryption schemes work successfully.  But encryption does not necessarily mean that your traffic is invisible: some DNS services with encryption still write your requests to the log for various purposes. <br><br>  Cloudflare promised not to log DNS traffic and hired a third-party firm to audit it.  Jeff Huston from APNIC reported that APNIC is going to use data <a href="https://labs.apnic.net/%3Fp%3D1127">for research purposes</a> : the 1.0.0.0/24 and 1.1.1.0/24 ranges were initially configured as addresses for ‚Äúblack‚Äù traffic.  But APNIC will not get access to encrypted DNS traffic. <br><br>  It is not as easy for users to connect DNS encryption as changing the address in the network settings.  Currently, no OS directly supports DNS encryption without additional software.  And not all services are the same in terms of software and performance. <br><br>  But given the importance of the issue - lately in all the news they are talking about turning user data into a product - I decided to see how DNS-based encryption works for Cloudflare.  As a result, my internal laboratory rat won - and I found that I was testing and sorting clients for several DNS providers through three DNS encryption protocols: DNSCrypt, DNS over TLS and DNS over HTTPS.  They all work, but I warn you: although the procedure becomes simpler, you can hardly explain the DNS encryption to your parents by phone (unless they are experienced Linux command line users). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/74a/2bc/a23/74a2bca231d9c07b709504ba0bb84b7f.png"><br>  <i><font color="gray">How DNS works</font></i> <br><br><h1>  Why do we do this? </h1><br>  There are many reasons for better protection of DNS traffic.  Although web traffic and other communications can be protected by cryptographic protocols such as Transport Layer Security (TLS), almost all DNS traffic is transmitted unencrypted.  This means that your provider (or someone else between you and the Internet) can register visited sites even when working through a third-party DNS ‚Äî and use this data to their advantage, including filtering content and collecting data for advertising purposes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c21/42c/bec/c2142cbec3e8dfbc3779c8ec2a5f9445.jpg"><br>  <i><font color="gray">What is the typical data exchange between a device and a DNS resolver?</font></i> <br><br>  ‚ÄúWe have a last-mile problem in the DNS,‚Äù said Cricket Liu, the chief DNS architect at Infoblox, which deals with information security.  ‚ÄúMost of our security mechanisms address communications between servers.‚Äù  But there is a problem with surrogates of resolvers on various operating systems.  In reality, we cannot protect them. ‚Äù  The problem is especially noticeable in countries where the authorities are more hostile to the Internet. <br><br>  To some extent, using a DNS that does not keep logs helps.  But it still does not prevent an attacker from filtering requests for content or intercepting addresses using packet capture or deep packet inspection.  In addition to passive wiretapping, there is a threat of more active attacks on your DNS traffic - DNS server spoofing by the provider or special services with redirection to your own server to track or block traffic.  Something similar (although, apparently, not maliciously) seems to be happening with <a href="https://www.dslreports.com/forum/r31901379-AT-T-gateway-5268ac-maybe-others-misrouting-1-1-1-0-24">random traffic redirection to the address 1.1.1.1 from the AT &amp; T network</a> , judging by the messages on the DSLReports forums. <br><br>  The most obvious way to evade surveillance is to use a VPN.  But while VPNs hide the contents of your traffic, a DNS query may be required to connect to a VPN.  And during a VPN session, DNS queries can also sometimes be sent by web browsers or other software outside the VPN tunnel, creating <a href="https://www.dnsleaktest.com/what-is-a-dns-leak.html">‚ÄúDNS leaks‚Äù</a> that reveal the sites visited. <br><br>  This is where DNS encryption protocols come into play: these are DNSCrypt (among others, it is supported by OpenDNS from Cisco), <a href="https://www.rfc-editor.org/info/rfc7858">DNS by TLS</a> (supported by Cloudflare, Google, Quad9, OpenDNS) and <a href="https/%3Finclude_text%3D1">DNS by HTTPS</a> (supported by Cloudflare, Google and the adult lock service) <a href="https://cleanbrowsing.org/">CleanBrowsing</a> content).  Encryption ensures that traffic does not scan and does not change, and that requests will not receive and will not process a fake DNS server.  It protects against MiTM attacks and espionage.  A DNS proxy with one of these services (directly on the device or on a ‚Äúserver‚Äù on the local network) will help prevent DNS leaks through VPNs, since a proxy server will always be the fastest DNS server available. <br><br>  However, this protection option is not available to the mass user.  None of these protocols is natively supported by any DNS resolver that comes with the OS.  All require installation (and probably compiling) of a client application that acts as a local DNS ‚Äúserver‚Äù, relaying requests made by browsers and other applications upstream to a secure DNS provider of your choice.  And although two of these three technologies are offered for the role of standards, none of the options we have tested has yet been presented in its final form. <br><br>  Therefore, if you want to plunge into DNS encryption, then it is better to take for a DNS server in the home network Raspberry Pi or another separate device.  Because you will surely find that setting up one of the listed clients is already enough hacking to not want to repeat the process again.  It's easier to request DHCP settings on the local network - and point all computers to one successful installation of the DNS server.  I repeated this to myself many times during testing, observing the fallout of Windows clients one by one and the hibernation of clients under MacOS. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/887/de5/c78/887de5c780afbc8055ae206a9dad16f6.jpg"><br>  <i><font color="gray">The DNSCrypt community tried to make an accessible tool for those who do not have command-line skills by launching DNSCloak (left) for iOS and Simple DNSCrypt (for right) under Windows</font></i> <br><br><h1>  Encrypted </h1><br>  For the sake of completeness in the historical perspective, we will begin the review with the very first DNS encryption technology - DNSCrypt.  First introduced in BSD Unix in 2008, the DNSCrypt tool was originally intended to protect not from eavesdropping, but from DNS spoofing.  However, it can be used as part of a privacy management system ‚Äî especially in combination with a DNS server without logs.  As noted by DNSCrypt developer Frank Denis, <a href="https://dnscrypt.info/map/">many more servers support DNSCrypt</a> than any other type of DNS encryption. <br><br>  ‚ÄúDNSCrypt is a little more than just a protocol,‚Äù says Frank Denis.  ‚ÄúNow the community and active projects characterize it much better than my original protocol, developed at the weekend.‚Äù  The DNSCrypt community has created easy-to-use clients, such as <a href="https://simplednscrypt.org/">Simple DNSCrypt</a> for Windows and a <a href="https://itunes.apple.com/us/app/dnscloak-dnscrypt-doh-client/id1330471557%3Fmt%3D8">client for Apple iOS called DNS Cloak</a> , which makes DNS encryption more accessible to non-technical people.  Other activists have set up an independent network of private DNS servers based on a protocol that helps users evade the use of corporate DNS systems. <br><br>  ‚ÄúDNSCrypt is not connecting to the servers of a particular company,‚Äù said Denis.  - We urge everyone to raise their own servers.  Make it very cheap and easy.  Now that we have secure resolvers, I'm trying to solve the problem of content filtering with respect to confidentiality. ‚Äù <br><br>  For those who want to run a DNS server with DNSCrypt support for their entire network, the best client will be <a href="https://github.com/jedisct1/dnscrypt-proxy">DNSCrypt Proxy 2</a> .  The old version of DNSCrypt Proxy is still available as a package for most major Linux distributions, but it is better to download the new version's binary directly from the official repository on GitHub.  There are versions for Windows, MacOS, BSD and Android. <br><br>  DNSCrypt's privacy protection experience is embodied in the DNSCrypt Proxy.  The program is easily configured, supports access time restrictions, domain templates and blacklists of IP addresses, query logs and other functions of a fairly powerful local DNS server.  But to get started, the most basic configuration is enough.  There is an example of a TOML configuration file ( <a href="https://github.com/toml-lang/toml">Tom's Obvious Minimal Language</a> , created by GitHub co-founder Tom Preston-Werner).  You can simply rename it before running the DNSCrypt Proxy - and it will become the working configuration file. <br><br>  By default, the proxy server uses Quad9 open DNS resolver to search and retrieve <a href="">from GitHub a</a> curated list of open DNS services.  Then connects to the server with the fastest response.  If necessary, you can change the configuration and select a specific service.  Information about servers in the list is encoded as a <a href="https://github.com/jedisct1/dnscrypt-proxy/wiki/stamps">‚Äúserver stamp‚Äù</a> .  It contains the IP address of the provider, the public key, the information whether the server supports DNSSEC, whether the provider stores logs and blocks any domains.  (If you do not want to depend on a remote file during installation, you can run the <a href="https://github.com/jedisct1/vue-dnsstamp">‚Äústamp calculator‚Äù in JavaScript - and generate your own local static list of servers in this format</a> ). <br><br>  For my DNSCrypt testing, I used Cisco's OpenDNS as a remote DNS service.  At the first requests, the DNSCrypt performance turned out to be slightly worse than the regular DNS, but then the DNSCrypt Proxy caches the results.  The slowest requests were processed in the region of 200 ms, while the average ones were processed in about 30 ms.  (Your results may vary depending on the provider, recursion when searching for a domain, and other factors).  In general, I did not notice the slowdown in speed when browsing the web. <br><br>  The main advantage of DNSCrypt is that it looks like a ‚Äúregular‚Äù DNS.  Good or bad, it transmits UDP traffic on port 443 - the same port is used for secure web connections.  This gives relatively fast rezolving addresses and reduces the likelihood of blocking on the provider's firewall.  To further reduce the likelihood of blocking, you can change the configuration of the client and send requests over TCP / IP (as shown by testing, this minimally affects the response time).  So the encrypted DNS traffic for most network filters is similar to HTTPS traffic - at least in appearance. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c45/58f/dc9/c4558fdc97e5c937759c8b7f37f2db80.jpg"><br>  <i><font color="gray">Showing DNSCrypt traffic and local DNSCrypt Proxy traffic.</font></i>  <i><font color="gray">Wireshark Sniffer says this is HTTPS traffic, because I forced the use of TCP.</font></i>  <i><font color="gray">If you send it via UDP, then Wireshark will see Chrome QUIC traffic.</font></i> <br><br>  DNSCrypt, on the other hand, does not rely on trusted certificate authorities for encryption ‚Äî the client must trust the signature public key issued by the provider.  This signature key is used to verify certificates that are retrieved using simple (unencrypted) DNS queries and are used for key exchange using <a href="https://cryptography.io/en/latest/hazmat/primitives/asymmetric/x25519/">the X25519 key exchange algorithm</a> .  In some (older) DNSCrypt implementations, there is a condition for a client-side certificate that can be used as an access control scheme.  This allows them to log your traffic no matter what IP address you came from, and link it to your account.  This scheme is not used in DNSCrypt 2. <br><br>  From a developer‚Äôs point of view, it‚Äôs a bit difficult to work with DNSCrypt  ‚ÄúDNSCrypt is not particularly well documented, and not so many of its implementations,‚Äù says Liu Cricket from Infoblox.  In fact, we were able to find only a single client in active development - this is DNSCrypt Proxy, and OpenDNS stopped supporting its development. <br><br>  An interesting choice of cryptography in DNSCrypt may scare some developers.  The protocol uses Curve25519 (RFC 8032), X25519 (RFC 8031), and Chacha20Poly1305 (RFC 7539).  One implementation of the X24419 algorithm in <a href="https://github.com/pyca/cryptography">Pyca Python cryptographic libraries is</a> marked as ‚Äúcryptographically dangerous‚Äù because it is very easy to make mistakes with it.  But the main cryptographic algorithm used is Curve25519, ‚Äúis one of the simplest elliptic curves for safe use,‚Äù said Denis. <br><br>  The developer says that DNSCrypt was never considered an IETF standard, because it was created by volunteers without a corporate "roof."  Presenting it as a standard ‚Äúwould take time as well as protection at the IETF meetings,‚Äù he said.  ‚ÄúI can't afford it, like the other developers who work on it in their spare time.  Almost all the ratified DNS-related specifications are actually written by people from the same several companies from year to year.  If your business is not related to DNS, then it‚Äôs really hard to get a vote. ‚Äù <br><br>  Although <a href="https://dnscrypt.info/public-servers/">several DNS services use DNSCrypt</a> (for example, CleanBrowsing to block ‚Äúadult‚Äù content and Cisco OpenDNS to block malicious domains), the new privacy-oriented DNS providers (including Google, Cloudflare and Quad9) refused DNSCrypt and chose one of the Other IETF-approved technologies: DNS over TLS and DNS over HTTPS.  Now DNSCrypt Proxy supports DNS over HTTPS and specifies Cloudflare, Google and Quad9 in the default settings. <br><br><img src="https://habrastorage.org/webt/sp/-1/02/sp-102gs_1s5shlan3rnzo-5uig.jpeg"><br>  <i><font color="gray">TLS <a href="https://arstechnica.com/information-technology/2014/02/making-nsa-style-spying-harder-cloudflare-offers-more-robust-web-crypto/">became a priority</a> for CloudFlare when it was necessary to strengthen the encryption of web traffic to protect against snooping</font></i> <br><br><h1>  Crossing with TLS </h1><br>  DNS has TLS (Transport Layer Security) several advantages over DNSCrypt.  First is the <a href="https://www.rfc-editor.org/info/rfc8310">proposed IETF standard</a> .  It also works quite simply in its essence - it accepts requests from the standard DNS format and encapsulates them into encrypted TCP traffic.  Aside from TLS-based encryption, this is essentially the same as sending DNS over TCP / IP instead of UDP. <br><br>  There are several working clients for DNS over TLS.  The best option I found is called Stubby, it was developed as part of the <a href="https://dnsprivacy.org/">DNS Privacy Project</a> .  Stubby is distributed as part of the Linux package, but there is also a version for MacOS (installed using Homebrew) and a version for Windows, although the work on the latter has not yet been completed. <br><br>  Although I managed to consistently run Stubby on Debian after a battle with some dependencies, this client crashed regularly in Windows 10 and tends to hang on MacOS.  If you're looking for a good guide to installing Stubby on Linux, the best documentation I've found is <a href="https://www.reddit.com/r/pihole/comments/7oyh9m/guide_how_to_use_pihole_with_stubby/">Frank Santoso's post on Reddit</a> .  He also wrote a shell script for installation on the Raspberry Pi. <br><br>  On the plus side, Stubby allows configurations using multiple DNS-based services over TLS.  The YAML configuration file allows you to configure several IPv4 and IPv6 services and includes settings for SURFNet, Quad9, and other services.  However, the YAML implementation used by Stubby is space sensitive, so be careful when adding a new service (for example, Cloudflare).  At first I used tabs - and everything broke. <br><br>  DNS clients using TLS, when connected to a DNS server, authenticate using <a href="https://tools.ietf.org/html/rfc2693">simple public key infrastructure</a> (SPKI).  SPKI uses the provider‚Äôs local cryptographic hash of the certificate, usually on <a href="https://www.thesslstore.com/blog/difference-sha-1-sha-2-sha-256-hash-algorithms/">the SHA256 algorithm</a> .  In Stubby, this hash is stored as part of the server description in the YAML configuration file, as shown below: <br><br><pre><code class="hljs pgsql">upstream_recursive_servers: #IPv4 #Cloudflare DNS <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> TLS <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> - address_data: <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tls_auth_name: "cloudflare-dns.com" tls_pubkey_pinset: - digest: "sha256" <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: yioEpqeR4WtDwE9YxNVnCEkTxIjx6EEIwFSQW+lJsbc= - address_data: <span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tls_auth_name: "cloudflare-dns.com" tls_pubkey_pinset: - digest: "sha256" <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: yioEpqeR4WtDwE9YxNVnCEkTxIjx6EEIwFSQW+lJsbc=</code> </pre> <br>  After establishing a TCP connection between the client and the server via port 853, the server presents its certificate, and the client verifies it with the hash.  If everything is in order, then the client and server produce a handshake TLS, exchange keys and start an encrypted communication session.  From this point on, data in an encrypted session follows the same rules as in DNS over TCP. <br><br>  After the successful launch of Stubby, I changed the network settings of the DNS network to send requests to 127.0.0.1 (localhost).  Wireshark sniffer shows this switching point well when DNS traffic becomes invisible. <br><br> <a href=""><img src="https://habrastorage.org/webt/xj/vg/h2/xjvgh2psrj9rypvkvkrpnochkhi.png"></a> <br>  <i><font color="gray">Switching from normal DNS traffic to TLS encryption</font></i> <br><br>  Although DNS over TLS can work like DNS over TCP, but TLS encryption has a slight effect on performance.  Digub requests to Cloudflare via Stubby ran for me on average about 50 milliseconds (your results may vary), while simple DNS queries to Cloudflare receive an answer in less than 20 ms. <br><br>  Part of the slowdown occurs on the server side due to unnecessary use of TCP.  Normally, DNS is running on the fast UDP protocol: sent and forgotten, while the TCP message requires a connection negotiation and a packet receipt check.  A UDP-based version of DNS over TLS called <a href="https://tools.ietf.org/html/rfc8094">DNS over Datagram Transport Layer Security (DTLS) is</a> currently in experimental development ‚Äî it can increase protocol performance. <br><br>  There is also a problem with certificate management.  If the provider deletes the certificate and starts using the new one, there is currently no clean way to update the SPKI data on clients, except for cutting out the old one and inserting the new certificate into the configuration file.  Before you figure this out, it would be helpful to use some kind of key management scheme.  And since the service runs on the rare port 853, then with a high probability DNS over TLS can be blocked on the firewall. <br><br>  But this is not a problem for the leader of our hit parade - DNS over HTTPS.  It passes through most firewalls, as if those do not exist. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/344/798/c1f/344798c1f95caeac1b91807fe8d2f43c.jpg"><br>  <i><font color="gray">Google and Cloudflare seem to see the future of an encrypted DNS in the same way.</font></i> <br><br><h1>  DNS over https: DoH! </h1><br>  Both Google and Cloudflare seem to see the DNS protocol over HTTPS, also known as DoH, as the most promising option for DNS encryption.  Published as an <a href="https-03">IETF draft draft</a> , the DoH protocol encapsulates DNS requests into HTTPS packets, turning them into plain, encrypted web traffic. <br><br>  Requests are sent as HTTP POST or GET with the body in the <a href="http://www.zytrax.com/books/dns/ch15/">format of a DNS message</a> (datagram from ordinary DNS requests) or as <a href="https/json-format/">an HTTP GET request in JSON format</a> (if you are not against a small overhead).  And there are no problems with certificate management.  As with normal HTTPS web traffic, no authentication is required to connect via DoH, and the certificate is verified by a certification authority. <br><br> <a href=""><img src="https://habrastorage.org/webt/-r/-t/mg/-r-tmg6l15mghgivnyoeyktir2w.jpeg"></a> <br>  <i><font color="gray">Fix DNS-transactions through DoH.</font></i>  <i><font color="gray">Only HTTPS, TLS and nothing else are visible</font></i> <br><br>  HTTPS is a rather cumbersome protocol for DNS queries, especially in JSON format, so you have to put up with some performance degradation.  Required server-side resources will almost certainly make the usual DNS server administrator shed a tear.  But the simplicity of working with well-understood web protocols makes the development of both client and server code for DoH much more accessible for developers who have eaten a dog on web applications (just a few weeks ago, Facebook engineers released the <a href="https://facebookexperimental.github.io/doh-proxy/">DoH server concept and client in Python</a> ). <br><br>  As a result, although ink has not yet dried out on the RFC specifications for DoH, a number of DNS clients using HTTPS are ready for use.  True, some of them are sharpened for specific DNS providers.  Loss of performance depends on the server and on the quality of a particular client. <br><br>  For example, take the Cloudflare <a href="https://developers.cloudflare.com/argo-tunnel/">Argo tunneling client</a> (aka <a href="https://developers.cloudflare.com/argo-tunnel/downloads/">cloudflared</a> ).  This is a <a href="https://blog.cloudflare.com/argo-tunnel/">multifunctional tunneling tool</a> designed primarily to establish a secure channel for connecting web servers to the Cloudflare CDN network.  HTTPS DNS is just another service that is now supported by CDN. <br><br>  By default, if you run Argo from the command line (on Linux and MacOS, you need superuser privileges, and on Windows you need to start the client from PowerShell as administrator), then it sends DNS requests to <code>https://cloudflare-dns.com/dns-query</code> .  If a normal DNS is not configured, then a small problem is possible, because this address must be resolved to 1.1.1.1, otherwise Argo will not start. <br><br>  This can be corrected in one of three ways.  The first option is to install the device with a local host ( <code>127.0.0.1</code> for IPv4 and <code>::1</code> for IPv6) as the primary DNS server in the network configuration, and then add 1.1.1.1 as an additional resolver.  This is a working version, but it is not perfect in terms of privacy and performance.  It is better to add the server URL from the command line when loading: <br><br><pre> <code class="hljs ruby">$ sudo cloudflared proxy-dns --upstream <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/1.0.0.1/dns</span></span>-query</code> </pre> <br>  If you are sure that you want to switch to Cloudflare's DNS server, which gives the advantage of automatic updating, then you can configure it as a service in Linux using the YAML configuration file containing Cloudflare's IPv4 and IPv6 addresses: <br><br><pre> <code class="hljs ruby">proxy-<span class="hljs-symbol"><span class="hljs-symbol">dns:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> proxy-dns-<span class="hljs-symbol"><span class="hljs-symbol">upstream:</span></span> - <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/1.1.1.1/dns</span></span>-query - <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/1.0.0.1/dns</span></span>-query</code> </pre> <br>  When configured with the correct upstream addressing, the performance of dig queries through Argo varies widely: from 12 ms for popular domains to as much as 131 ms.  Pages with more cross-site content load ... a little longer than usual.  Again, your result may be different - it probably depends on your location and connectivity.  But this is about what I expected from the gloomy DoH protocol. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3e5/86a/22d/3e586a22d3a4d05a0afc58b5633f4263.jpg"><br>  <i><font color="gray">Like <a href="https://blog.cloudflare.com/argo-tunnel/">Cloudflare</a> , we believe that the tunnels illustrate Operation Argo better than Ben Affleck</font></i> <br><br>  In order to make sure that the problem is in the DoH protocol, and not in the Cloudflare programmers, I have experienced two other tools.  First, a proxy from Google called <a href="https://github.com/pforemski/dingo">Dingo</a> .  It was written by Pavel Foremsky, an Internet researcher from the Institute of Theoretical and Applied Computer Science of the Polish Academy of Sciences  Dingo only works with the Google DoH implementation, but it can be configured to the nearest Google DNS service.  This is good, because without this optimization, Dingo gobbled up all DNS performance.  Dig queries on average were executed over 100 milliseconds. <br><br>  While checking the processing of standard requests by the <code>dns.google.com</code> service <code>dns.google.com</code> I came across an alternative to the default address 8.8.8.8 from Google (172.217.8.14, if you know).  I added it to Dingo from the command line: <br><br><pre> <code class="hljs pgsql">$ sudo ./dingo-linux-amd64 -port=<span class="hljs-number"><span class="hljs-number">53</span></span> -gdns:<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>=<span class="hljs-number"><span class="hljs-number">172.216</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span></code> </pre> <br>  This reduced the response time by about 20%, that is, up to about the rate of the Argo. <br><br>  And DNKrypt Proxy 2 unexpectedly showed DoH's optimal performance. After the recent addition of DoH Cloudflare to the supervised list of public DNS services, DNSCrypt Proxy almost always connects to Cloudflare by default due to the low latency of this server.  To make sure, I even manually configured it under the Cloudflare DoH revolver before running the battery of dig queries. <br><br>  All requests were processed in less than 45 milliseconds - this is faster than Cloudflare's own client, and with a large margin.  With the DoH service from Google, performance was worse: requests were processed on average about 80 milliseconds.  This is an indicator without optimization on the nearest DNS server from Google. <br><br>  In general, the DNSCrypt Proxy performance by DoH is almost indistinguishable from the DNS resolver for TLS, which I checked earlier.  In fact, it is even <i>faster</i> .  I'm not sure if this is due to some particular DoH implementation ‚Äî maybe because of the use of the standard DNS message format encapsulated in HTTPS instead of the JSON format ‚Äî either due to the way Cloudflare handles two different protocols. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a9e/9b6/793/a9e9b6793b4efb12a5176db6ba0bd884.png"><br>  <i><font color="gray">I'm not Batman, but my threat model is still a bit more complicated than most people</font></i> <br><br><h1>  Why so tormented? </h1><br>  I am a professional paranoid.  <a href="https://arstechnica.com/information-technology/2017/07/how-i-learned-to-stop-worrying-mostly-and-love-my-threat-model/">My threat model</a> is different from yours, and I would prefer to keep as much of my actions online as safe as possible.  But given the number of current threats to privacy and security due to DNS traffic manipulation, many people have good reason to use some form of DNS encryption.  I was pleased to find that some implementations of all three protocols do not have a very negative effect on the speed of transmission of traffic. <br><br>  However, it is important to note that DNS encryption alone will not hide your actions on the Internet.  If several sites are hosted on the server, then the TLS extension called Server Name Indicator (SNI), used in HTTPS connections, can still show in plain language the name of the site you visited.  For complete confidentiality, you still need to use VPN (or Tor) to encapsulate traffic in such a way that a provider or any other spying party cannot pull out the metadata from the packets.  But none of these services works with Tor.  And if a government agency works against you, then you can‚Äôt be sure of anything. <br><br>  Another problem is that, although the great guys from the DNSCrypt community have done a lot of work, this privacy is still too difficult for ordinary people.  Although some of these DNS clients for encryption turned out to be relatively easy to configure, none of them can be called guaranteed simple for normal users.  To make these services truly useful, they should be more closely integrated into hardware and software that people buy - home routers, operating systems for personal computers and mobile devices. <br><br>  Internet providers will certainly try to more actively monetize normal DNS traffic, and government agencies and criminals who seek to use it to the detriment of the user will not disappear anywhere.  But it is unlikely that major OS developers strive to reliably protect the DNS in an accessible way for most people, because they are often interested in monetization, as are Internet providers.  In addition, these developers may face resistance to change from some governments that want to maintain DNS monitoring capabilities. <br><br>  So, in the near future, these protocols will remain a tool for those few people who really care about the privacy of their data and are ready to work a little for this.  I hope the community around DNSCrypt will continue to be active and move things forward. </div><p>Source: <a href="https://habr.com/ru/post/353878/">https://habr.com/ru/post/353878/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353866/index.html">A little about physics in almost Agar IO on aicups.ru</a></li>
<li><a href="../353868/index.html">Map matching and processing of raw GPS data on an industrial scale</a></li>
<li><a href="../353870/index.html">Telecom's digital transformation, or how operators ‚Äúgo‚Äù to IT</a></li>
<li><a href="../353872/index.html">Hybrid Storage for Out-of-the-House Homes and High Availability from Synology</a></li>
<li><a href="../353876/index.html">Configure Sublime Text 3 to work with VHDL files</a></li>
<li><a href="../353880/index.html">Telegram and AWS Blocking - Morning does not start with coffee</a></li>
<li><a href="../353884/index.html">Sophisticated javascript call center</a></li>
<li><a href="../353886/index.html">Asynchronous Loops and Stream APIs in Node.js 10</a></li>
<li><a href="../353888/index.html">Where and how to grow talents?</a></li>
<li><a href="../353890/index.html">A simple filter to automatically remove the background from images</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>