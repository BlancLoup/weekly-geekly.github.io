<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Understanding x64 support in WPE Pro</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think that most of the local inhabitants are familiar with the concept of a sniffer . Despite the fact that they have the same goal (interception of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Understanding x64 support in WPE Pro</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e12/e99/fdf/e12e99fdf5d1db703fa1e8f35706eb4d.png" alt="image"><br><br>  I think that most of the local inhabitants are familiar with the concept of a <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580_%25D1%2582%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D0%25BA%25D0%25B0">sniffer</a> .  Despite the fact that they have the same goal (interception of packets that meet certain criteria), they achieve it in a completely different way.  Some software listens to the specified network interface (for example, <a href="https://www.wireshark.org/">Wireshark</a> , where it is implemented using the <a href="http://en.wikipedia.org/wiki/Pcap">Pcap</a> library), and some - intercepts calls of those responsible for interacting with the network of WinAPI-functions.  Both that and the other method have their pros and cons, however, if the task requires the interception of packets from a specific previously known application, then the second option is usually tritely more convenient.  In this case, there is no need to find out the IP addresses and ports that this program uses (especially considering the fact that there can be quite a lot of them), and you can simply say ‚ÄúI want to intercept all the packages of this application‚Äù.  Convenient, isn't it? <br><br>  Perhaps the most popular sniffer to date, working on the principle of interception of calls of certain WinAPI-functions, is <a href="http://wpepro.net/">WPE Pro</a> .  Perhaps, many of you have heard about it in various forums dedicated to online games, because this sniffer is used in most cases to get advantages in various games.  It performs its task perfectly, but it has one unpleasant drawback - it does not know how to work with 64-bit applications.  It just so happened that according to one of the arisen tasks, I just needed to intercept packets from a 64-bit application, and I looked in the direction of Wireshark.  Unfortunately, it was not very convenient to use it in this situation - the application under study sent data to different IP addresses, each time opening a new port.  Googling a bit, I found that there are no ready-made analogues of WPE Pro with x64 support (if there are any, I would appreciate links in the comments - note that we are talking about Windows).  The WPE Pro author did not leave any contact details on the official website and in the sniffer itself, so I decided to sort out this issue on my own. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      How was the process and what came of it, read under the cut. <br><a name="habracut"></a><br>  So what needs to be done first?  Right, download WPE Pro yourself.  This can be done on the <a href="http://wpepro.net/">official website of the</a> sniffer, where two versions are offered for download at once - 0.9a and 1.3.  We will consider version 0.9a, because it works on the latest versions of Windows. <br><br>  Downloaded?  Now let's check if he is covered by some kind of packer or protector: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a92/385/73c/a9238573cf23aa50a5451c89378f3805.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/504/f86/7b7/504f867b71279fd7b6342316d3075b9b.png" alt="image"><br><br>  Looks like we won't have to shoot anything this time.  Then we take <a href="http://www.ollydbg.de/">OllyDbg</a> and download ‚ÄúWpePro.net.exe‚Äù.  For example, let's run the 64-bit version of <a href="http://www.dependencywalker.com/">Dependency Walker</a> and find out why WPE Pro cannot display it in the list of processes available for interception. <br><br>  Get a list of current processes in WinAPI in two main ways: <br><br><ul><li>  Using the <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms682489(v%3Dvs.85).aspx">CreateToolhelp32Snapshot</a> , <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms684834(v%3Dvs.85).aspx">Process32First</a> and <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms684836(v%3Dvs.85).aspx">Process32Next</a> bundle of functions (an example can be found <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686701(v%3Dvs.85).aspx">here</a> ) </li><li>  Using the <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms682629(v%3Dvs.85).aspx">EnumProcesses</a> function (an example can be found, for example, <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682623(v%3Dvs.85).aspx">here</a> ) </li></ul><br>  If you wish, you can read about the difference between these methods, for example, <a href="http://stackoverflow.com/questions/4021307/enumprocesses-vs-createtoolhelp32snapshot">here</a> . <br><br>  We look at the intermodular calls of the ‚ÄúWpePro.net.exe‚Äù module and see that there is neither <b>CreateToolhelp32Snapshot</b> nor <b>EnumProcesses</b> here.  Perhaps the application gets their address at run-time using the WinAPI function <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms683212(v%3Dvs.85).aspx">GetProcAddress</a> , so let's look at the referenced text strings.  At this time, everything is exactly the opposite - it was found as the string ‚ÄúCreateToolhelp32Snapshot‚Äù and ‚ÄúEnumProcesses‚Äù.  Place the breakpoints in the places where the data lines are accessed, click on the ‚ÄúTarget program‚Äù button in WPE Pro and look at the place where we stopped: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/060/d6d/c1c/060d6dc1c02e211b30508f70e8798fe5.png" alt="image"><br><br>  If you press F9, then we will see that the same breakout is triggered several more times before finally a window appears with a list of current processes.  Let's see why Dependency Walker was not in it.  We close the window, press the ‚ÄúTarget program‚Äù button again and perform step-by-step debugging, starting from the same bryak.  Shortly after the calls to <b>GetProcAddress,</b> we find ourselves in a loop in which the following functions are sequentially called - <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms684320(v%3Dvs.85).aspx">OpenProcess</a> , <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms682631(v%3Dvs.85).aspx">EnumProcessModules</a> , hiding behind the <b>CALL DWORD PTR DS</b> instruction <b>: [EDI + 10]</b> , <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms683198(v%3Dvs.85).aspx">GetModuleFileNameEx</a> ( <b>CALL DWORD PTR DS</b> instruction <b>: [ECX + 14]</b> ) and <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms724211(v%3Dvs.85).aspx">CloseHandle</a> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/012/52b/fd0/01252bfd049c8c5f848758cdbd7bd4d6.png" alt="image"><br><br>  Let's put the breakpoint at <b>0x0042A910</b> , where the last argument of the <b>OpenProcess</b> function, PID, is <b>pushed</b> onto the stack and try to wait until the <b>EAX</b> register takes on a value equal to the Dependency Walker process identifier.  On my machine at that moment it was equal to 6600, i.e.  0x19C8. <br><br>  If we run through the code, we will see that in the case of a Dependency Walker, the <b>TEST EAX, EAX</b> instruction located at <b>0x0042A942</b> and following the call to the WinAPI function <b>EnumProcessModules</b> causes the following conditional jump operator to jump to <b>0x0042A9E7</b> where the call is located <b>CloseHandle</b> , which, of course, is not the normal course of the application, because we have not even reached the call to the <b>GetModuleFileNameEx</b> function: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/85a/349/17b/85a34917b597da85b6e82ec076056327.png" alt="image"><br><br>  Note the error code - 0x12B (ERROR_PARTIAL_COPY).  Let's see why this can happen.  Open the documentation for the function <b>EnumProcessModules</b> and see the following: <br><br><blockquote>  If this is a 32-bit application running on a WOW64, it can only be enumerate.  If this is a process, it‚Äôs ERROR_PARTIAL_COPY (299) </blockquote><br>  Yes, this is our case. <br><br>  Despite the fact that the documentation for the function <b>GetModuleFileNameEx</b> does not say anything similar, it behaves in a similar way, as described, for example, <a href="http://winprogger.com/getmodulefilenameex-enumprocessmodulesex-failures-in-wow64/">here</a> .  One solution to this problem is to use the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684919(v%3Dvs.85).aspx">QueryFullProcessImageName</a> function, which will work fine even if called from a 32-bit application running in WOW64, if applied to a 64-bit process. <br><br>  Now we can set the function call <b>EnumProcessModules</b> <br><br><pre><code class="hljs sql">0042A93F . FF57 10 <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> DWORD PTR DS:[EDI+<span class="hljs-number"><span class="hljs-number">10</span></span>] ; EnumProcessModules 0042A942 . 85C0 TEST EAX,EAX 0042A944 90 NOP 0042A945 90 NOP 0042A946 90 NOP 0042A947 90 NOP 0042A948 90 NOP 0042A949 90 NOP 0042A94A . 8B4424 14 MOV EAX,DWORD PTR SS:[ESP+14] 0042A94E . BE 00000000 MOV ESI,0</code> </pre> <br>  and write code cave to replace <b>GetModuleFileNameEx</b> with the <b>QueryFullProcessImageName</b> function: <br><br><pre> <code class="hljs ruby"><span class="hljs-number"><span class="hljs-number">0042</span></span>A971 /E9 DA3F060<span class="hljs-number"><span class="hljs-number">0</span></span> JMP WpePro_n.<span class="hljs-number"><span class="hljs-number">004</span></span>8E95<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0042</span></span>A976 <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A977 |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP <span class="hljs-number"><span class="hljs-number">0042</span></span>A978 <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A979 |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP ; GetModuleFileNameEx <span class="hljs-number"><span class="hljs-number">0042</span></span>A97A <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A97B |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP <span class="hljs-number"><span class="hljs-number">0042</span></span>A97C <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A97D |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP <span class="hljs-number"><span class="hljs-number">0042</span></span>A97E <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A97F |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP <span class="hljs-number"><span class="hljs-number">0042</span></span>A98<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A981 |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP <span class="hljs-number"><span class="hljs-number">0042</span></span>A982 <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A983 |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP <span class="hljs-number"><span class="hljs-number">0042</span></span>A984 <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A985 |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP <span class="hljs-number"><span class="hljs-number">0042</span></span>A986 <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A987 |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP <span class="hljs-number"><span class="hljs-number">0042</span></span>A988 <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A989 |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP <span class="hljs-number"><span class="hljs-number">0042</span></span>A98A <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A98B |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP <span class="hljs-number"><span class="hljs-number">0042</span></span>A98C <span class="hljs-params"><span class="hljs-params">|90 NOP 0042A98D |</span></span><span class="hljs-number"><span class="hljs-number">90</span></span> NOP <span class="hljs-number"><span class="hljs-number">0042</span></span>A98E &gt; <span class="hljs-params"><span class="hljs-params">|6A 14 PUSH 14 0042A990 . |</span></span>E8 <span class="hljs-number"><span class="hljs-number">7</span></span>FCF030<span class="hljs-number"><span class="hljs-number">0</span></span> CALL WpePro_n.<span class="hljs-number"><span class="hljs-number">00467</span></span>914</code> </pre><br><pre> <code class="hljs css">0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E950</span></span> 60 <span class="hljs-selector-tag"><span class="hljs-selector-tag">PUSHAD</span></span> 0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E951</span></span> 9<span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PUSHFD</span></span> 0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E952</span></span> 8<span class="hljs-selector-tag"><span class="hljs-selector-tag">D5C24</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">AC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LEA</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EBX</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SS</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[ESP-54]</span></span> 0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E956</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">C74424</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">AC</span></span> 040&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">MOV</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SS</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[ESP-54]</span></span>,104 0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E95E</span></span> 53 <span class="hljs-selector-tag"><span class="hljs-selector-tag">PUSH</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EBX</span></span> 0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E95F</span></span> 50 <span class="hljs-selector-tag"><span class="hljs-selector-tag">PUSH</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span> 0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E960</span></span> 6<span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> 00 <span class="hljs-selector-tag"><span class="hljs-selector-tag">PUSH</span></span> 0 0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E962</span></span> 55 <span class="hljs-selector-tag"><span class="hljs-selector-tag">PUSH</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EBP</span></span> 0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E963</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">E8</span></span> 777<span class="hljs-selector-tag"><span class="hljs-selector-tag">CB675</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CALL</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">KERNEL32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.QueryFullProcessImageNameA</span></span> 0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E968</span></span> 9<span class="hljs-selector-tag"><span class="hljs-selector-tag">D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">POPFD</span></span> 0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E969</span></span> 61 <span class="hljs-selector-tag"><span class="hljs-selector-tag">POPAD</span></span> 0048<span class="hljs-selector-tag"><span class="hljs-selector-tag">E96A</span></span> ^ <span class="hljs-selector-tag"><span class="hljs-selector-tag">E9</span></span> 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">FC0F9FF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">JMP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">WpePro_n</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0042A98E</span></span></code> </pre><br>  Now WPE Pro displays many new processes, including our Dependency Walker: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f5/8c5/43d/1f58c543d47e1115d50ae644c5c69732.png" alt="image"><br><br>  However, when trying to attach to this process, WPE Pro gives an unpleasant message for us: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f8e/cd1/e36/f8ecd1e36072cb76056a44b76ed9de4d.png" alt="image"><br><br>  Here we, unfortunately, can do nothing.  <a href="http://en.wikipedia.org/wiki/DLL_injection">DLL injection is</a> performed by <a href="http://en.wikipedia.org/wiki/DLL_injection">injecting</a> its DLL into the target-process address space, and the following is <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa384231(v%3Dvs.85).aspx">stated</a> on MSDN: <br><br><blockquote>  On 64-bit Windows, a 64-bit process cannot be loaded a 32-bit dynamic-link library (DLL).  Additionally, a 32-bit process cannot be loaded a 64-bit DLL </blockquote><br>  It is easy to guess that WPE Pro comes only with a 32-bit library. <br><br>  What to do?  Write your WinSock interceptor?  Why not? <br><br>  But how will we do this?  The first thing that comes to mind is to use <a href="http://research.microsoft.com/en-us/projects/detours/">Detours</a> , but the official site immediately states that support for 64-bit applications is only in the Professional Edition: <br><br><blockquote>  Detours Express is limited to 32-bit processes on x86 processors </blockquote><br>  Then let's try <a href="https://easyhook.codeplex.com/">EasyHook</a> .  Among other things, this library just allows you to work with 64-bit applications: <br><br><blockquote>  You must be able to compile any code, and you will be able to </blockquote><br>  With minor changes to the example shown in the official <a href="https://easyhook.codeplex.com/downloads/get/623723">tutorial</a> , we get code that intercepts calls to the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms740121(v%3Dvs.85).aspx">recv</a> and <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms740149(v%3Dvs.85).aspx">send</a> functions from WinSock and outputs the intercepted messages byte-by-byte in hexadecimal: <br><br>  <b>The code of the program making the DLL injection</b> <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> EasyHook; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Runtime.Remoting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Sniffer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> MsgType { Recv, Send }; [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Message</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] Buf; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Len; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MsgType Type; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InjectorInterface</span></span> : <span class="hljs-title"><span class="hljs-title">MarshalByRefObject</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnMessages</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message[] messages</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Message message <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (message.Type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MsgType.Recv: Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Received {0} bytes via recv function"</span></span>, message.Len); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MsgType.Send: Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Sent {0} bytes via send function"</span></span>, message.Len); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Unknown action"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> curByte <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> message.Buf) { Console.Write(<span class="hljs-string"><span class="hljs-string">"{0:x2} "</span></span>, curByte); } Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"====================="</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Print</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(message); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ping</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args.Length != <span class="hljs-number"><span class="hljs-number">1</span></span>) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Usage: Sniffer.exe [pid]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pid = Int32.Parse(args[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> channelName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; RemoteHooking.IpcCreateServer&lt;InjectorInterface&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> channelName, WellKnownObjectMode.SingleCall); RemoteHooking.Inject( pid, InjectionOptions.DoNotRequireStrongName, <span class="hljs-string"><span class="hljs-string">"WinSockSpy.dll"</span></span>, <span class="hljs-string"><span class="hljs-string">"WinSockSpy.dll"</span></span>, channelName); Console.ReadLine(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"An error occured while connecting to target: {0}"</span></span>, ex.Message); } } } }</code> </pre><br>  <b>The code of the DLL itself that will be injected into the target process</b> <br><br><pre> <code class="hljs perl">using EasyHook; using Sniffer; using System; using System.Collections.Generic; using System.Linq; using System.Runtime.InteropServices; using System.Text; using System.Threading; using System.Threading.Tasks; namespace WinSockSpy { public class Main : EasyHook.IEntryPoint { public Sniffer.InjectorInterface Interface; public LocalHook RecvHook; public LocalHook SendHook; public LocalHook WSASendHook; public Stack&lt;Message&gt; Queue = new Stack&lt;Message&gt;(); public Main(RemoteHooking.IContext InContext, String InChannelName) { Interface = RemoteHooking.IpcConnectClient&lt;Sniffer.InjectorInterface&gt;(InChannelName); } public void Run(RemoteHooking.IContext InContext, String InChannelName) { try { RecvHook = LocalHook.Create( LocalHook.GetProcAddress(<span class="hljs-string"><span class="hljs-string">"Ws2_32.dll"</span></span>, <span class="hljs-string"><span class="hljs-string">"recv"</span></span>), new DRecv(RecvH), this); SendHook = LocalHook.Create( LocalHook.GetProcAddress(<span class="hljs-string"><span class="hljs-string">"Ws2_32.dll"</span></span>, <span class="hljs-string"><span class="hljs-string">"send"</span></span>), new DSend(SendH), this); RecvHook.ThreadACL.SetExclusiveACL(new Int32[] { <span class="hljs-number"><span class="hljs-number">0</span></span> }); SendHook.ThreadACL.SetExclusiveACL(new Int32[] { <span class="hljs-number"><span class="hljs-number">0</span></span> }); } catch (Exception ex) { Interface.Print(ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } // Wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> host process termination... try { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (true) { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">500</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Queue.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Message[] messages = null; lock (Queue) { messages = Queue.ToArray(); Queue.Clear(); } Interface.OnMessages(messages); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Interface.Ping(); } } } catch (Exception) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> NET Remoting will raise an exception <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> host is unreachable } } //<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">recv</span></span>( <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> _In<span class="hljs-number"><span class="hljs-number">_</span></span> SOCKET <span class="hljs-keyword"><span class="hljs-keyword">s</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> _Out<span class="hljs-number"><span class="hljs-number">_</span></span> char *buf, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> _In<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> _In<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flags //); [DllImport(<span class="hljs-string"><span class="hljs-string">"Ws2_32.dll"</span></span>)] public static extern <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">recv</span></span>( IntPtr <span class="hljs-keyword"><span class="hljs-keyword">s</span></span>, IntPtr buf, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flags ); <span class="hljs-regexp"><span class="hljs-regexp">//int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">send</span></span>( <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> _In<span class="hljs-number"><span class="hljs-number">_</span></span> SOCKET <span class="hljs-keyword"><span class="hljs-keyword">s</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> _In<span class="hljs-number"><span class="hljs-number">_</span></span> const char *buf, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> _In<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> _In<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flags //); [DllImport(<span class="hljs-string"><span class="hljs-string">"Ws2_32.dll"</span></span>)] public static extern <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">send</span></span>( IntPtr <span class="hljs-keyword"><span class="hljs-keyword">s</span></span>, IntPtr buf, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flags ); [UnmanagedFunctionPointer(CallingConvention.StdCall, CharSet = CharSet.Unicode, SetLastError = true)] delegate <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DRecv( IntPtr <span class="hljs-keyword"><span class="hljs-keyword">s</span></span>, IntPtr buf, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flags ); [UnmanagedFunctionPointer(CallingConvention.StdCall, CharSet = CharSet.Unicode, SetLastError = true)] delegate <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DSend( IntPtr <span class="hljs-keyword"><span class="hljs-keyword">s</span></span>, IntPtr buf, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flags ); static <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> RecvH( IntPtr <span class="hljs-keyword"><span class="hljs-keyword">s</span></span>, IntPtr buf, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flags) { Main This = (Main)HookRuntimeInfo.Callback; lock (This.Queue) { byte[] message = new byte[len]; Marshal.Copy(buf, message, <span class="hljs-number"><span class="hljs-number">0</span></span>, len); This.Queue.Push(new Message { Buf = message, Len = len, Type = MsgType.Recv }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">recv</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">s</span></span>, buf, len, flags); } static <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SendH( IntPtr <span class="hljs-keyword"><span class="hljs-keyword">s</span></span>, IntPtr buf, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flags) { Main This = (Main)HookRuntimeInfo.Callback; lock (This.Queue) { byte[] message = new byte[len]; Marshal.Copy(buf, message, <span class="hljs-number"><span class="hljs-number">0</span></span>, len); This.Queue.Push(new Message { Buf = message, Len = len, Type = MsgType.Send }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">send</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">s</span></span>, buf, len, flags); } } }</code> </pre><br>  Of course, there is still something to work on: <br><ul><li>  First, there is no interception of <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms741688(v%3Dvs.85).aspx">WSARecv</a> , <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms742203(v%3Dvs.85).aspx">WSASend</a> and some other functions that can be used in target applications. </li><li>  Second, the lack of a GUI and ‚Äústring‚Äù representation of intercepted messages </li><li>  etc </li></ul><br>  However, the functionality demonstrated here was quite enough to solve the task set before me, and the rest is left to the discretion of the readers. <br><br><h3>  Afterword </h3><br>  Research and modification of binary files does not always give an instant result, as was observed in my previous articles (if interested, read about it <a href="http://habrahabr.ru/post/257125/">here</a> and <a href="http://habrahabr.ru/post/257591/">here</a> ), so sometimes you have to go back to the very beginning and change your approach to solving a problem.  But there is absolutely nothing abnormal in this - as you know, any experience is useful, and reverse engineering is no exception. <br><br>  Thank you for your attention, and again I hope that the article was useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/259459/">https://habr.com/ru/post/259459/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259449/index.html">Windows SSH support by Microsoft</a></li>
<li><a href="../259451/index.html">Why buy monsters? - The practice of domestic import substitution software</a></li>
<li><a href="../259453/index.html">STM32 training for the masses</a></li>
<li><a href="../259455/index.html">Attackers use Linux / Moose to compromise Linux-embedded systems, part 2</a></li>
<li><a href="../259457/index.html">How did jQuery start</a></li>
<li><a href="../259463/index.html">We calculate gamemasters characters in World of Warcraft using Python</a></li>
<li><a href="../259465/index.html">Modeling objects for animation on Canvas</a></li>
<li><a href="../259467/index.html">How to write your NIF in Elixir</a></li>
<li><a href="../259469/index.html">Manage Windows computers from the Linux console</a></li>
<li><a href="../259471/index.html">API Jellyfish: write full text RSS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>