<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Frontend distribution via CDN</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the world of modern web technologies, everything is rapidly developing and changing. A couple of years ago, it was completely normal, at the reques...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Frontend distribution via CDN</h1><div class="post__text post__text-html js-mediator-article">  In the world of modern web technologies, everything is rapidly developing and changing.  A couple of years ago, it was completely normal, at the request of the client, to render the DOM structure on the server (for example, using PHP) and return a fully-formed page.  Now more and more sites appear with a complete separation of the frontend (Angular, React, Vue.js ...) from the backend (some API endpoints), where at the frontend almost all the content is generated through scripts, and the server gives only data on request.  Here we could mention the SSR (Server Side Rendering), but this is not about this work. <br><br>  At all times, developers and website owners faced a difficult task: to deliver content as quickly as possible to as many customers as possible.  One of the best decisions is to use the CDN (Content Delivery Network) to distribute static files.  In the case of the dynamic rendering of pages on the server, we had to be limited to a small list of objects that could be placed in the CDN: style sheets, script files, images.  However, the frontend written on Angular (React, Vue.js ...) is static entirely, including the index page.  And here comes the thought: why not organize distribution through the entire front-end CDN? <br><br>  This article will talk about setting up a complete solution for development, version control, automatic assembly and delivery of a static site using Gitlab CI, Amazon S3 and Amazon CloudFront.  We will also discuss setting up related things: git, secure connection via HTTPS, domain mail, DNS hosting, backend server ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you are interested in this topic, welcome under cat.  Caution!  Many screenshots. <br><a name="habracut"></a><br><h2>  What we get as a result of the walkthrough: </h2><br><ul><li>  Start site on Angular. </li><li>  Version control (git). </li><li>  Automatic assembly and publication of the frontend in the Amazon S3 shopping cart. </li><li>  Frontend distribution via CDN (Amazon CloudFront). </li><li>  Free SSL certificate from Amazon with auto-renewal (for site operation via HTTPS). </li><li>  Free domain mail from Yandex and a convenient interface for managing DNS records (and not only). </li><li>  Bash script automatically configure the backend server. </li><li>  Backend server running on Debain 9 OS (nginx + PHP7.1-FPM). </li><li>  Free SSL certificate from Let's Encrypt with auto-renewal (for the work of the domain root zone and backend services via HTTPS). </li></ul><br><h2>  What we need for this: </h2><br><ul><li>  Domain name with access to the control panel of the registrar. </li><li>  <a href="https://gitlab.com/">Gitlab account</a> . </li><li>  <a href="https://aws.amazon.com/ru">AWS (Amazon Web Services) Account</a> </li><li>  <a href="https://yandex.ru/">Account on Yandex</a> . </li><li>  VDS (Virtual Dedicated Server) with Debain 9 installed. </li></ul><br><h3>  A few words about this choice of tools </h3><br>  I spent a lot of time looking for suitable services based on a number of criteria.  Firstly, this is the price - I would like the service to be either free or not very expensive.  Secondly - reliability.  It is also good if the service takes on most of the responsibilities, eliminating the need to install and configure something.  For example, why set up your own git server, use some kind of third-party CI (Continuous Integration) service, if Gitlab provides all these services out of the box, as well as an unlimited number of private repositories, organizations, and coworkers?  Why set up domain mail on your own server, if you can provide it to Yandex?  About the CDN - I just did not find anything cheaper than Amazon CloudFront.  Amazon S3 file storage is also not expensive (and why store a lot of files on VDS, if it is expensive?). <br><br><h3>  So let's go! </h3><br><h2>  1. DNS hosting and Yandex mail </h2><br>  To begin, we will tie your domain to Yandex mail.  We take this step primarily to configure domain mail.  We will need to confirm domain ownership in order to receive the Amazon Amazon certificate, and for this we will need to receive an email at webmaster@yourdomain.com. <br><br>  1.1.  We are registered / logged in in <a href="https://yandex.ru/">Yandex</a> . <br><br>  1.2.  Go to the <a href="https://pdd.yandex.ru/">domain mail Yandex</a> and add your domain (menu item "Connect domain"). <br><br><img src="https://habrastorage.org/webt/ta/vd/_c/tavd_cxjmjg2rlx3r6ps499m6im.png"><br><br>  Here I want to immediately note that Yandex has got ‚Äútraffic rules 2.0‚Äù or ‚ÄúYandex.Connect‚Äù.  However, I can‚Äôt decide if the Yandex.Connect interface is <s>not overworked</s> too simple and lacks the necessary functionality, or if it‚Äôs too complicated and doesn‚Äôt have the necessary functionality.  Anyway, I was not able to add several domains at once to Yandex.Connect, with the ability to edit the DNS records of each of them separately.  Therefore, for me personally, it turned out to be easier to first add the domain to the traffic rules (Mail For Domain), and then transfer it to Yandex.Connect, which we will do. <br><br>  1.3.  We confirm ownership of the domain. <br><br><img src="https://habrastorage.org/webt/sy/eq/lu/syeqlu9gl5taycd7hwht51cxhfa.png"><br><br>  The easiest way for us is to delegate a domain to Yandex.  To do this, install the following NS servers for your domain in the registrar's control panel: <br><br> <code>dns1.yandex.net <br> dns2.yandex.net <br></code> <br>  Attention!  This step should be performed strictly after the domain is connected to the mail for the domain (clause 1.2). <br><br>  1.4.  We are waiting up to 72 hours (as lucky). <br>  Verification of domain ownership should pass automatically.  After that, on the page of the <a href="https://pdd.yandex.ru/">traffic rules</a> in the list of "My domains" you should see a green message indicating that "the domain is connected and delegated to Yandex". <br><br><img src="https://habrastorage.org/webt/ch/e_/57/che_57hwluadcnuxeowkhwdghxs.png"><br><br>  Now we can connect mail for the domain.  You do not need to configure MX records for a domain, because  we delegated the domain to the NS NS servers. <br>  At this stage, we have already received domain mail with the ability to add up to 1000 mailboxes and with the correct DNS mail records. <br><br>  1.5.  We create the first mailbox johndoe@yourdomain.com. <br><br>  1.6.  In the top menu, click on the link "Migrate to Connect." <br>  We carry out the transfer of the domain in Yandex.Connect, specify the name of the organization.  After that, the <a href="https://connect.yandex.ru/portal/home">https://connect.yandex.ru/portal/home</a> page becomes available. <br><br><img src="https://habrastorage.org/webt/fe/a8/q-/fea8q-ewp3gg0uukh4rdosg9yna.png"><br><br>  1.7.  Go to the "Admin".  Here we have various settings available. <br>  The most interesting thing for us is the ‚ÄúDNS Management‚Äù menu item.  We return to it later.  Now we need to add a mailbox alias called webmaster@yourdomain.com.  We will need this box to receive a letter requesting confirmation of domain ownership from Amazon. <br><br>  1.8.  Go to the menu item "Organizational structure" and select the only (so far) user that was automatically created when the first mailbox was added (item 1.5). <br><br><img src="https://habrastorage.org/webt/xn/kb/az/xnkbaz7af0nfmeu4dzqemn0egjc.png"><br><br>  1.9.  Click the ellipsis in the upper right corner of the user card, in the drop-down menu, select the item ‚ÄúManage aliases‚Äù. <br><br>  In the window that appears, click the button "Add new". <br><br><img src="https://habrastorage.org/webt/c5/yo/jh/c5yojhjw3maa9iqvpqejo_usdvu.png"><br><br>  Enter the "webmaster" and click the "Add" button. <br><br>  Now we have an alias of the mailbox webmaster@yourdomain.com and we are ready to accept letters to the domain mail. <br><br><h2>  2. Amazon Web Services Account </h2><br>  To follow the steps in this guide, you need an <a href="https://aws.amazon.com/ru">AWS</a> root user account. <br><br>  If you do not have an account yet, then you are incredibly lucky and you can use the free AWS level.  For this you need to go through <a href="https://aws.amazon.com/ru/free">the registration procedure</a> .  During the registration process, they will ask you for the credit card details, from where they will withdraw (and will not return!) $ 1 to verify solvency.  You will also need to specify your phone number, which will be called by a robot from America. <br><br>  In general, the registration process is quite simple and in my opinion does not require a detailed description. <br><br><h2>  3. Amazon Security Credentials </h2><br>  To automatically exchange data with AWS services, we will use the aws cli console utility (AWS Command Line Interface).  The utility is authorized using the Access key ID and Secret access key pairs.  Create them. <br><br>  3.1.  Go to the AWS console. <br><br>  3.2.  In the top menu on the right, click on your login.  In the drop-down menu, select the item "My Security Credentials". <br><br><img src="https://habrastorage.org/webt/f5/uc/6i/f5uc6idzbwpkufu3ibkyu_emi28.png"><br><br>  3.3.  A warning window may appear here. <br><br><img src="https://habrastorage.org/webt/mm/zp/iu/mmzpiuwv8rbu2v0jpahkmmu0wes.png"><br><br>  You can ignore it and click the "Continue to Security Credentials" button. <br><br>  3.4.  In the menu on the left, select the item "Users".  Click the button "Add user". <br><br>  3.5.  In the field "User name" we write the user name.  For example, "cli-manager". <br>  In the item ‚ÄúAccess type‚Äù put a tick ‚ÄúProgrammatic access‚Äù. <br><br><img src="https://habrastorage.org/webt/6q/7i/xb/6q7ixbet1gxjlsplbmjuvrufuii.png"><br><br>  Click the button "Next: Permissions". <br><br>  3.6.  In the next paragraph, select ‚ÄúAttach existing policies directly‚Äù.  Select the checkbox "AdministratorAccess". <br><br><img src="https://habrastorage.org/webt/u3/lj/5h/u3lj5hodfenlby5cstuhyfqjehu.png"><br><br>  Click the "Next: Review" button. <br><br>  3.7.  In the next paragraph, click the button "Create user". <br><br>  3.8.  In the last paragraph, we will see the newly created user and his data. <br><br><img src="https://habrastorage.org/webt/sp/rt/n_/sprtn_pox79g3gcsvw2pko9lth4.png"><br><br>  Attention!  Immediately write down the Access key ID and Secret access key (you can see it by clicking ‚Äúshow‚Äù) and / or download the .csv file with user data (by clicking the Download .csv button).  You will never see the secret access key anywhere else. <br><br><h2>  4. Amazon SSL Certificate </h2><br>  Now we need to get an SSL certificate for our domain. <br><br>  4.1.  In the AWS console, select Services from the top menu. <br><br>  4.2.  In the search for services, type "Certificate manager". <br><br>  4.3.  Click the button ‚ÄúRequest a certificate‚Äù. <br><br>  4.4.  In the field "Domain name" we write "* .yourdomain.com". <br><br><img src="https://habrastorage.org/webt/eb/ww/3w/ebww3wjj0w9cpbbc-iraunzqigw.png"><br><br>  Pay attention to the asterisk and the point before the domain name.  Thus, we will receive a wildcard certificate for the domain and all its subdomains.  Click the button ‚ÄúReview and request‚Äù. <br><br>  4.5.  In the next paragraph, click the "Confirm and request" button. <br><br>  4.6.  In the next paragraph, press the button "Continue". <br><br><img src="https://habrastorage.org/webt/zg/-d/vi/zg-dvi2mqqiw_ceiyfpefg71xkq.png"><br><br>  Here we will see the certificate just requested and its status: ‚ÄúPending validation‚Äù. <br><br>  4.7.  Now we go into the mail <a href="https://mail.yandex.ru/">Yandex</a> . <br>  Login to your domain mailbox, which you created in step 1.5.  of this guide (johndoe@yourdomain.com).  You should have received a letter requesting confirmation of your domain ownership from Amazon. <br><br><img src="https://habrastorage.org/webt/8b/ew/-j/8bew-j2jzsmu6vcvszs4bvkr2_4.png"><br><br>  4.8.  Follow the link in the letter. <br>  A new browser tab opens with a domain ownership confirmation page. <br><br><img src="https://habrastorage.org/webt/o5/xc/bh/o5xcbhe0lf7cjow-h-rmttpigxm.png"><br><br>  Push the "I Approve" button. <br>  The certificate must pass a successful confirmation. <br><br>  Returning to the Certificate manager we will see our certificate and its status: ‚ÄúIssued‚Äù. <br><br><h2>  5. Amazon S3 Recycle Bin </h2><br>  Create an Amazon S3 bucket in which static frontend files will be stored. <br><br>  5.1.  In the AWS console, select Services from the top menu. <br><br>  5.2.  In the search for services we type "S3". <br><br>  5.3.  Click the "Create bucket" button. <br><br><img src="https://habrastorage.org/webt/si/e7/gr/sie7gr8ijbhckoq5gxq2ofny2cu.png"><br><br>  In the field ‚ÄúBucket name‚Äù we indicate the name of the host (along with www).  It must completely coincide with the name of your domain.  For example: <a href="http://www.yourdomain.com/">www.yourdomain.com</a> . <br><br>  In the "Region" field, select "US East (N. Virginia)".  First, it will allow to avoid possible problems with redirection to the wrong objects ( <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/Redirects.html">article of documentation</a> ).  Secondly, it is the most popular region and the cheapest prices here.  Third, we do not care in which region the basket is located, since  CDN will distribute content, and clients will not directly access S3 files. <br><br>  Click "Next" several times, leaving all the fields as is. <br><br>  A new basket with the name <a href="http://www.yourdomain.com/">www.yourdomain.com</a> appears in the list of your baskets. <br><br>  5.4.  Edit the properties of the basket. <br>  Click on the empty space next to the name of your basket.  A pop-up window will appear on the right side of the window. <br><br><img src="https://habrastorage.org/webt/p4/qn/ka/p4qnkazkutqv4ghyigrg8gzyrwq.png"><br><br>  5.5.  Select the item "Properties". <br><br><img src="https://habrastorage.org/webt/rd/wc/zc/rdwczcb44uvtsai1gowgdsykixq.png"><br><br>  5.6.  Click on "Static website hosting". <br><br><img src="https://habrastorage.org/webt/zd/qp/kg/zdqpkg3j4e95vd1k9ls1yguni4u.png"><br><br>  Immediately copy the "Endpoint" URL (listed at the top of the window).  You will need it for further settings. <br><br>  Select the first item ‚ÄúUse this bucket to host a website‚Äù. <br><br>  In the field "Index document" we write "index.html". <br><br>  Click the "Save" button. <br><br>  5.7.  Select the "Permissions" tab. <br><br>  Here we need to add <a href="http://www.yourdomain.com.s3-website-us-east-1.amazonaws.com/">www.yourdomain.com.s3-website-us-east-1.amazonaws.com</a> and https: //*.yourdomain.com to the list of allowed hosts for cross-domain queries. <br><br><img src="https://habrastorage.org/webt/1g/od/b4/1godb4lstru3l1h4kqeqp7-chme.png"><br><br>  Press the "CORS configuration" button. <br>  We will not parse the XML file format.  For a detailed study of this issue, you can read the <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/cors.html">documentation</a> .  We just need to copy this into the text field: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CORSConfiguration</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://s3.amazonaws.com/doc/2006-03-01/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CORSRule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedOrigin</span></span></span><span class="hljs-tag">&gt;</span></span>http://www.yourdomain.com.s3-website-us-east-1.amazonaws.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedOrigin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedMethod</span></span></span><span class="hljs-tag">&gt;</span></span>GET<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedMethod</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedMethod</span></span></span><span class="hljs-tag">&gt;</span></span>HEAD<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedMethod</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span>Content-*<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span>Host<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span>Origin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CORSRule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CORSRule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedOrigin</span></span></span><span class="hljs-tag">&gt;</span></span>https://*.yourdomain.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedOrigin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedMethod</span></span></span><span class="hljs-tag">&gt;</span></span>GET<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedMethod</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedMethod</span></span></span><span class="hljs-tag">&gt;</span></span>HEAD<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedMethod</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span>Content-*<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span>Host<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span>Origin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CORSRule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CORSConfiguration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Replace the AllowedOrigin tag values ‚Äã‚Äãwith yours.  The first address is the same Static website endpoint that you copied in paragraph 5.6 of this guide. <br>  Click the "Save" button. <br><br><h2>  6. Distributing Amazon CloudFront </h2><br>  Now we need to organize the distribution of files through the CDN from the newly created basket. <br><br>  6.1.  In the AWS console, select Services from the top menu. <br><br>  6.2.  In the search for services, we type "CloudFront". <br><br>  6.3.  Click the button "Create Distribution". <br><br><img src="https://habrastorage.org/webt/m_/tg/t6/m_tgt6u69nc9powfp-vy9ytwxbc.png"><br><br>  Select the delivery method "Web", click the corresponding button "Get Started". <br>  A very large form will open (I will not do the screen). <br>  Go through the fields we need.  We do not touch the rest of the fields, leave as is.  In any case, we have the opportunity to further change all these settings. <br><br>  Origin Settings <br><br>  <b>Origin Domain Name</b> : here carefully!  No need to choose the domain " <a href="http://www.yourdomain.com.s3.anazonaws.com/">www.yourdomain.com.s3.anazonaws.com</a> " from the tooltip for this field!  We put in here the Static website endpoint, which you copied in paragraph 5.6 of this guide, without the ‚Äúhttp: //‚Äù at the beginning. <br><br>  Default Cache Behavior Settings <br><br>  <b>Viewer Protocol Policy</b> : select the item "Redirect HTTP to HTTPS". <br>  <b>Allowed HTTP Methods</b> : select "GET, HEAD, OPTIONS". <br>  <b>Cached HTTP Methods</b> : put a tick in front of "OPTIONS". <br>  <b>Cache Based on Selected Request Headers</b> : select the "Whitelist" item.  In the " <b>Whitelist Headers</b> " item that appears, select "Origin", click the "Add" button. <br>  <b>Object Caching</b> : Select the item "Customize". <br>  <b>Minimum TTL</b> : write the value "300". <br>  <b>Compress Objects Automatically</b> : select ‚ÄúYes‚Äù. <br><br>  Distribution Settings <br><br>  <b>Alternate Domain Names (CNAMEs)</b> : in the text box, write " <a href="http://www.yourdomain.com/">www.yourdomain.com</a> " and "static.yourdomain.com" - one on each line.  At static.yourdomain.com, we will have access to everything the same as through <a href="http://www.yourdomain.com/">www.yourdomain.com</a> .  We will use it to get static files to reduce the number of requests to the main domain. <br>  <b>SSL Certificate</b> : select the item ‚ÄúCustom SSL Certificate‚Äù.  Below in the drop-down list, select the previously obtained SSL certificate "* .yourdomain.com". <br>  <b>Default Root Object</b> : enter ‚Äúindex.html‚Äù (without a slash at the beginning). <br><br>  Click the button "Create Distribution". <br>  Distribution created.  It will appear in the list with the status "In Progress".  For some time (usually up to 10 minutes), it will acquire the status ‚ÄúEnabled‚Äù. <br>  Immediately copy the ID and Domain Name of our distribution, we will need them for further settings. <br><br>  6.4.  Set up error pages. <br><br>  Click on the distribution ID in the list.  Go to the tab "Error Pages". <br><br><img src="https://habrastorage.org/webt/e5/vg/_i/e5vg_iehxrvqh-wecuelmauljaq.png"><br><br>  Click the "Create Custom Error Response" button. <br>  In the "HTTP Error Code" select "403: Forbidden". <br>  ‚ÄúCustomize Error Response‚Äù - select ‚ÄúYes‚Äù. <br>  In the "Response Page Path" enter "/index.html". <br>  In the "HTTP Response Code" select "200: OK". <br><br>  Repeat the same steps for error 404. <br><br>  Thus, not found or denied addresses will be redirected to index.html and processed by Angular Router. <br><br><h2>  7. Backend server </h2><br>  It's time to set up a backend server. <br><br>  Even if you have a completely static site that does not require API calls on the server, VDS will not hurt.  The fact is that the root domain entry must be type A (and / or AAAA if you have IPv6) and, accordingly, refer to the IP address.  My opinion is the easiest and cheapest way to get a permanent IP address on the Internet is to rent a VDS.  In addition to this, we are able to place various services on this IP address: API, databases, real-time messaging service, and anything else.  Some DNS hosting providers provide the ability to use ALIAS instead of an A record, where you can enter a domain name, not an IP address.  For example, you can use Amazon Route 53, set up a domain root record as a link to another S3 basket, which will redirect to your CloudFront distribution. <br><br>  In any case, this is the choice of everyone.  I'm inclined to rent VDS, especially since the prices for them are now quite affordable.  For example, <a href="https://www.ihor.ru/">Ayhor Hosting</a> provides VDS (1 PU / 512 MB RAM / 10 GB HDD) for only 1080 rubles per year.  This is the cheapest fare, to begin with, it is quite suitable for us.  Although, I recommend purchasing VDS with SSD. <br><br>  Next, I will describe the process of configuring VDS (or a full server) with root access and the Debian 9 operating system on board. <br><br>  In my work, I use several VDS of the same type and do not use any control panels, such as ISPManager.  Therefore, I automated the server setup process by writing a simple bash script.  Let's do the same and create some files.  Be careful!  Line strings in files should be in Unix (LF) style, not Windows (CRLF). <br><br>  <b>nginx.conf</b> : <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">user</span></span> www-data; <span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/error.log <span class="hljs-literal"><span class="hljs-literal">warn</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pid</span></span> /var/run/nginx.pid; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">use</span></span> <span class="hljs-literal"><span class="hljs-literal">epoll</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/mime.types; <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> application/octet-stream; <span class="hljs-attribute"><span class="hljs-attribute">log_format</span></span> main <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_addr</span></span></span><span class="hljs-string"> - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_user</span></span></span><span class="hljs-string"> [</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$time_local</span></span></span><span class="hljs-string">] "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$status</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$body_bytes_sent</span></span></span><span class="hljs-string"> "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_referer</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_user_agent</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_forwarded_for</span></span></span><span class="hljs-string">"'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/nginx/access.log main; <span class="hljs-attribute"><span class="hljs-attribute">sendfile</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">tcp_nopush</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">client_header_timeout</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">client_body_timeout</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">reset_timedout_connection</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">client_max_body_size</span></span> <span class="hljs-number"><span class="hljs-number">32m</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">client_body_buffer_size</span></span> <span class="hljs-number"><span class="hljs-number">128k</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_tokens</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_vary</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_disable</span></span> <span class="hljs-string"><span class="hljs-string">"msie6"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_proxied</span></span> any; <span class="hljs-attribute"><span class="hljs-attribute">gzip_min_length</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_comp_level</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_types</span></span> application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/octet-stream application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy; <span class="hljs-attribute"><span class="hljs-attribute">expires</span></span> max; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/conf.d/<span class="hljs-regexp"><span class="hljs-regexp">*.conf</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/sites-enabled/*; }</code> </pre><br>  This is the main nginx configuration file.  The main thing that we are doing here is to enable gzip compression and enable configs, which will be located in the <b>/ etc / nginx / sites-enabled</b> directory. <br><br>  <b>ssl.conf</b> : <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ssi</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/letsencrypt/live/{{DOMAIN}}/fullchain.pem"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/letsencrypt/live/{{DOMAIN}}/privkey.pem"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_trusted_certificate</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/letsencrypt/live/{{DOMAIN}}/chain.pem"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_ciphers</span></span> AES256+EECDH:AES256+EDH; <span class="hljs-attribute"><span class="hljs-attribute">ssl_prefer_server_ciphers</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_protocols</span></span> TLSv1.<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_ecdh_curve</span></span> secp384r1; <span class="hljs-attribute"><span class="hljs-attribute">ssl_dhparam</span></span> /etc/nginx/dhparam.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_stapling</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_stapling_verify</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_session_timeout</span></span> <span class="hljs-number"><span class="hljs-number">24h</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_session_cache</span></span> shared:SSL:<span class="hljs-number"><span class="hljs-number">24m</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_buffer_size</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span>;</code> </pre><br>  Nginx configuration template for SSL.  Here we connect the certificate that Let's give us to Encrypt and set the required SSL parameters, which should give us an A + rating in the <a href="https://www.ssllabs.com/ssltest">Qualys SSL Server Test</a> .  Pay attention to the {{DOMAIN}} substrings - this is as it should be.  The setup script itself will replace them with your domain. <br><br>  <b>site.conf</b> : <br><pre> <code class="hljs coffeescript">server { server_name {{DOMAIN}}; listen <span class="hljs-number"><span class="hljs-number">80</span></span>; listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2; error_log <span class="hljs-literal"><span class="hljs-literal">off</span></span>; access_log <span class="hljs-literal"><span class="hljs-literal">off</span></span>; add_header X-Content-Type-Options nosniff; add_header X-XSS-Protection <span class="hljs-string"><span class="hljs-string">"1; mode=block"</span></span>; add_header Strict-Transport-Security <span class="hljs-string"><span class="hljs-string">"max-age=31536000;"</span></span>; add_header Cache-Control public; include <span class="hljs-regexp"><span class="hljs-regexp">/etc/nginx/ssl.conf; location /</span></span>.well-known<span class="hljs-regexp"><span class="hljs-regexp">/acme-challenge/</span></span> { alias <span class="hljs-regexp"><span class="hljs-regexp">/var/www/</span></span>.well-known<span class="hljs-regexp"><span class="hljs-regexp">/acme-challenge/</span></span>; } location / { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span> https:<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>www.$host:<span class="hljs-number"><span class="hljs-number">443</span></span>$request_uri; } }</code> </pre><br>  Nginx configuration template for the domain root zone.  Here we connect the SSL configuration, make available from outside the directory in which Let's Encrypt will add files for domain validation.  All requests to <a href="http://yourdomain.com/">yourdomain.com</a> or <a href="https://yourdomain.com/">yourdomain.com are</a> redirected to <a href="https://www.yourdomain.com/">www.yourdomain.com</a> . <br><br>  <b>api.conf</b> : <br><pre> <code class="hljs bash">server { server_name {{DOMAIN}}; listen 80; error_log off; access_log off; add_header X-Content-Type-Options nosniff; add_header X-XSS-Protection <span class="hljs-string"><span class="hljs-string">"1; mode=block"</span></span>; location /.well-known/acme-challenge/ { <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> /var/www/.well-known/acme-challenge/; } location / { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> 301 https://<span class="hljs-variable"><span class="hljs-variable">$host</span></span>:443<span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span>; } } server { server_name {{DOMAIN}}; listen 443 ssl http2; access_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/{{DOMAIN}}.access.log; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/{{DOMAIN}}.error.log; add_header X-Frame-Options DENY; add_header X-Content-Type-Options nosniff; add_header X-XSS-Protection <span class="hljs-string"><span class="hljs-string">"1; mode=block"</span></span>; add_header Strict-Transport-Security <span class="hljs-string"><span class="hljs-string">"max-age=31536000;"</span></span>; add_header Cache-Control public; add_header <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Origin'</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_origin</span></span></span><span class="hljs-string">"</span></span>; add_header <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Credentials'</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>; add_header <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Methods'</span></span> <span class="hljs-string"><span class="hljs-string">'GET, HEAD, OPTIONS, POST, PUT, DELETE, PATCH'</span></span>; add_header <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Headers'</span></span> <span class="hljs-string"><span class="hljs-string">'Accept,Accept-Encoding,Accept-Language,Authorization,Cache-Control,Content-Length,Content-Type,Origin,If-Modified-Since,User-Agent,X-Requested-With'</span></span>; add_header <span class="hljs-string"><span class="hljs-string">'Access-Control-Expose-Headers'</span></span> <span class="hljs-string"><span class="hljs-string">'X-Powered-By'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$root_path</span></span> /var/www/{{DOMAIN}}; root <span class="hljs-variable"><span class="hljs-variable">$root_path</span></span>; disable_symlinks if_not_owner from=<span class="hljs-variable"><span class="hljs-variable">$root_path</span></span>; charset utf-8; index index.php; autoindex off; include /etc/nginx/ssl.conf; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$request_method</span></span> ~* ^(OPTIONS|HEAD)$) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> 204; } location / { try_files <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span>/ /index.php?<span class="hljs-variable"><span class="hljs-variable">$query_string</span></span>; } location ~ \.php$ { try_files <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> =404; fastcgi_pass unix:/var/run/php/php7.1-fpm.sock; fastcgi_index index.php; include fastcgi_params; fastcgi_param SCRIPT_FILENAME <span class="hljs-variable"><span class="hljs-variable">$document_root</span></span><span class="hljs-variable"><span class="hljs-variable">$fastcgi_script_name</span></span>; } }</code> </pre><br>  Nginx configuration template for the api.yourdomain.com subdomain.  Here we also connect the SSL configuration, make available from the outside the directory in which Let's Encrypt will add files for domain validation.  All requests to <a href="http://api.yourdomain.com/">api.yourdomain.com are</a> redirected to <a href="https://api.yourdomain.com/">api.yourdomain.com</a> .  We connect PHP7.1-FPM. <br><br>  <b>setup.sh</b> : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash time_start=`date +%s` ######################## # EDIT THESE VARIABLES: ######################## DOMAIN=yourdomain.com API_DOMAIN="api.$DOMAIN" SUPERUSER="inpassor" SUPERUSER_PASSWORD="12341234" USER="johndoe" USER_EMAIL="johndoe@yourdomain.com" USER_PASSWORD="12341234" ######################## apt update echo y | apt install dialog apt-utils echo y | apt install sed wget gnupg nano htop curl zip unzip apt-transport-https lsb-release ca-certificates debian-archive-keyring certbot # add users adduser --quiet --disabled-password --gecos "" $SUPERUSER echo "$SUPERUSER:$SUPERUSER_PASSWORD" | chpasswd adduser --quiet --disabled-password --gecos "" $USER echo "$USER:$USER_PASSWORD" | chpasswd sed -i "s/$SUPERUSER:x:1000:1000/$SUPERUSER:x:0:0/" /etc/passwd # add external repositories and GPG keys echo "deb http://nginx.org/packages/debian/ stretch nginx" &gt; /etc/apt/sources.list.d/nginx.list wget --quiet -O - https://nginx.org/packages/keys/nginx_signing.key | apt-key add - echo "deb https://packages.sury.org/php/ stretch main" &gt; /etc/apt/sources.list.d/php.list wget --quiet -O - https://packages.sury.org/php/apt.gpg | apt-key add - apt update echo y | apt upgrade echo y | apt install nginx php7.1-cli php7.1-fpm php7.1-mbstring php7.1-curl php7.1-xml # nginx setup mkdir /var/www mkdir "/var/www/$API_DOMAIN" chown -R $USER:www-data /var/www rm /etc/nginx/conf.d/default.conf cp nginx.conf /etc/nginx/nginx.conf echo "" &gt; /etc/nginx/ssl.conf mkdir /etc/nginx/sites-available mkdir /etc/nginx/sites-enabled sed "s@{{DOMAIN}}@$DOMAIN@g" site.conf &gt; /etc/nginx/sites-available/$DOMAIN.conf ln -s /etc/nginx/sites-available/$DOMAIN.conf /etc/nginx/sites-enabled sed "s@{{DOMAIN}}@$API_DOMAIN@g" api.conf &gt; /etc/nginx/sites-available/$API_DOMAIN.conf ln -s /etc/nginx/sites-available/$API_DOMAIN.conf /etc/nginx/sites-enabled # ssl setup service nginx restart certbot register --agree-tos --email $USER_EMAIL certbot certonly --webroot -w /var/www -d $DOMAIN -d $API_DOMAIN --rsa-key-size 4096 openssl dhparam -out /etc/nginx/dhparam.pem 4096 sed "s@{{DOMAIN}}@$DOMAIN@g" ssl.conf &gt; /etc/nginx/ssl.conf service nginx restart chown -R nginx:$USER /var/log/nginx chmod 664 /var/log/nginx/* time_end=`date +%s` echo Execution time: $((time_end-time_start)) sec.</span></span></code> </pre><br>  Bash script to automatically configure the server.  At the beginning of the file, several variables are declared: <br><br>  DOMAIN = yourdomain.com # your domain (without www in the beginning) <br>  API_DOMAIN = "api. $ DOMAIN" # subdomain on which the API backend will be (here it is api.yourdomain.com) <br>  SUPERUSER = "inpassor" # name of root user with root rights <br>  SUPERUSER_PASSWORD = "12341234" # root password <br>  USER = "johndoe" # username <br>  USER_EMAIL = "johndoe@yourdomain.com" # user email - used to register with Let's Encrypt <br>  USER_PASSWORD = "12341234" # user password <br><br>  Of course, you need to reassign them. <br><br>  Then the following actions are performed sequentially: <br><br><ul><li>  Installs the necessary packages. </li><li>  External repositories and GPG keys are added to access more recent nginx and PHP packages. </li><li>  The packages nginx, php7.1-cli, php7.1-fpm, php7.1-mbstring, php7.1-curl and php7.1-xml are installed. </li><li>  Configured nginx. </li><li>  The process of obtaining the SSL certificate Let's Encrypt is launched.  Please note that the dhparam.pem file is also generated here.  This process is very long, so you can save the generated file and later copy it. </li></ul><br>  That's all, the server setup script is ready here. <br><br>  Now we can log in to our VDS through SSH (by its IP address) as root, copy the * .conf and setup.sh files, make setup.sh executable (chmod 700 setup.sh) and run it. <br><br>  After the VDS setup process is ready for operation. <br><br>  We have installed nginx, which listens to requests for addresses: <a href="http://api.yourdomain.com/">yourdomain.com</a> , <a href="https://api.yourdomain.com/">yourdomain.com</a> , <a href="http://api.yourdomain.com/">api.yourdomain.com</a> , <a href="https://api.yourdomain.com/">api.yourdomain.com</a> .  Requests to http are redirected to https, requests to yourdomain.com are redirected to <a href="http://www.yourdomain.com/">www.yourdomain.com</a> .  At <a href="https://api.yourdomain.com/">api.yourdomain.com</a> we have an API.  Now there is empty and in order for it to respond to our requests, you need to create the index.php file in the /var/www/api.yourdomain.com/ directory. <br><br>  But so far this is not available, for the reason that we have not registered the necessary DNS settings. <br><br><h2>  8. DNS settings </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> After we set up the distribution of CloudFront and backend server, we are ready to make the final setup of DNS records. </font></font><br><br>  8.1.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We return to </font></font><a href="https://connect.yandex.ru/portal/home"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Connect</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br>  8.2.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go to the "Admin". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.3. </font><font style="vertical-align: inherit;">Select the menu item "DNS Management". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We need to add four new DNS records.</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Type A record: in the ‚ÄúHost‚Äù field, enter ‚Äú@‚Äù, in the ‚ÄúRecord Value‚Äù field - the IP address of our VDS, in the ‚ÄúTTL‚Äù field - ‚Äú3600‚Äù. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Record A: ‚ÄúHost‚Äù - ‚Äúapi‚Äù, ‚ÄúRecord value‚Äù - VDS IP address, ‚ÄúTTL‚Äù - ‚Äú3600‚Äù. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CNAME record: ‚ÄúHost‚Äù - ‚Äúwww‚Äù, ‚ÄúRecord value‚Äù - Domain Name of CloudFront distribution (see clause 6.3 of this guide), ‚ÄúTTL‚Äù - ‚Äú3600‚Äù. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CNAME record: ‚ÄúHost‚Äù - ‚Äústatic‚Äù, ‚ÄúRecord value‚Äù - Domain Name of CloudFront distribution, ‚ÄúTTL‚Äù - ‚Äú3600‚Äù. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have just sent requests to yourdomain.com (without www) and api.yourdomain.com to our VDS, and requests to </font></font><a href="http://www.yourdomain.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.yourdomain.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and static.yourdomain.com - to the distribution of CloudFront.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 9. Gitlab repository </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Next we need to create a private git repository to store and version the source files of our project on Angular. </font></font><br><br>  9.1.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Register / log in to </font></font><a href="https://gitlab.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gitlab</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br>  9.2.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Press the "New project" button. </font></font><br><br><img src="https://habrastorage.org/webt/op/60/_l/op60_lacfqvh-qpg7gsks8tvqcc.png"><br><br>  9.3.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, choose the path to the project and its name. </font></font><br><br><img src="https://habrastorage.org/webt/ts/t-/gs/tst-gsqbwi3imhnkdbqmsefur08.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set ‚ÄúVisibility Level‚Äù to ‚ÄúPrivate‚Äù and press the ‚ÄúCreate project‚Äù button. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.4. Add your public SSH key in the settings. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you do not have a key, you need to create it. How to create a private key pair - a public key in the Windows system can be read, for example, </font></font><a href="https://habrahabr.ru/post/39254"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the top menu, click on your avatar, in the drop-down menu, select the item "Settings". </font></font><br><br><img src="https://habrastorage.org/webt/ca/nv/ay/canvaybush07g48nqbpa_y9hjyi.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the menu on the left, select the item "SSH Keys". </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insert the contents of the public key file into the ‚ÄúKey‚Äù field. In Windows, it is usually located along the path: C: \ Users \ YourUsername \ .ssh \ id_rsa.pub. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the field ‚ÄúTitle‚Äù we write the name of the key (whatever).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.5. </font><font style="vertical-align: inherit;">We clone a repository on the local computer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To do this, we must have git / git for Windows installed on our computer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the command line, go to the local folder with your projects, for example, in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C: \ Projects</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>  Run the command: <br><br><pre> <code class="hljs perl">git clone git@gitlab.com:YourLogin/<span class="hljs-keyword"><span class="hljs-keyword">my</span></span>-awesome-project.git MyAwesomeProject</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The repository address ‚Äúgit@gitlab.com: YourLogin / my-awesome-project.git‚Äù can be found on the project‚Äôs main page on the Gitlab website. </font><font style="vertical-align: inherit;">Here ‚ÄúMyAwesomeProject‚Äù is the name of the local folder with the project that will be created automatically. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have just cloned an empty repository to a local computer and we have a project folder in which we can start creating your project.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10. Gitlab CI </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We set up Gitlab CI to automatically build a project, synchronize the collected files with the Amazon S3 bucket and update the CloudFront distribution. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.1. </font><font style="vertical-align: inherit;">We go to our project on the site </font></font><a href="https://gitlab.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://gitlab.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br>  10.2.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the menu on the left, select "CI / CD" - "Environments". </font></font><br><br><img src="https://habrastorage.org/webt/27/co/dy/27codys5-r76nppw11yuba7larg.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Press the "New environment" button.</font></font><br><br>  10.3.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the field "Name" enter "prod". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the field ‚ÄúExternal URL‚Äù enter your domain (along with https: // and www at the beginning). For example: </font></font><a href="https://www.yourdomain.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.yourdomain.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Click the "Save" button. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.4. In the menu on the left, select ‚ÄúSettings‚Äù - ‚ÄúCI / CD‚Äù. </font></font><br><br><img src="https://habrastorage.org/webt/9f/4x/ox/9f4xoxunzk4i_p9x6qymqwl4v1s.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.5. Opposite the point ‚ÄúSecret variables‚Äù press the button ‚ÄúExpand‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the ‚ÄúKey‚Äù field, enter ‚ÄúAWS_ACCESS_KEY_ID‚Äù. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the field "Value" enter your Access key ID, obtained in paragraph 3.8 of this guide. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the field ¬´Environment scope¬ª leave an asterisk. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Click the button ‚ÄúAdd new variable‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add another variable ‚ÄúAWS_SECRET_ACCESS_KEY‚Äù. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We repeat the actions, in the ‚ÄúValue‚Äù field, enter your Secret access key, obtained in paragraph 3.8 of this guide.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And one more variable is ‚ÄúAWS_DISTRIBUTION_ID‚Äù. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We repeat the actions, in the field ‚ÄúValue‚Äù we enter your Distribution ID, obtained in clause 6.3 of this guide. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This time, in the ‚ÄúEnvironment scope‚Äù field, enter ‚Äúprod‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It should turn out as in the screenshot: </font></font><br><br><img src="https://habrastorage.org/webt/7h/v_/pz/7hv_pzsw6l8rlzto0u7oayxsusg.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have completed the environment settings and CI variables, the rest will be written further directly in our project in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.gitlab-ci.yml file</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 11. Starting site on Angular </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It is time to create our project on Angular. </font></font><br><br>  11.1.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the command line, go to the directory of our project - where we have cloned an empty repository (see clause 9.5 of this guide). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In our example, this is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C: \ Projects \ MyAwesomeProject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We execute the following commands:</font></font><br><br><pre> <code class="hljs coffeescript"><span class="hljs-built_in"><span class="hljs-built_in">npm</span></span> i -g @angular/cli ng <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> yourdomain.com --style=scss --skip-git=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --directory=.</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We replace yourdomain.com with the name of your project (it does not have to be the same as the domain name). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have globally established Angular cli and in the project directory there are files with which you can start working.</font></font><br><br>  11.2.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.gitignore</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">:</font></font><br><br> <code>/.idea <br> /dist <br> /out-tsc <br> /node_modules <br> /e2e/*.js <br> /e2e/*.map <br> npm-debug.log <br> package-lock.json <br></code> <br><br>  11.3.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Edit the file </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.angular-cli.json</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the ‚Äúapps‚Äù section, we find the ‚Äúassets‚Äù key and change its value to:</font></font><br><br><pre> <code class="hljs json">[ { <span class="hljs-attr"><span class="hljs-attr">"glob"</span></span>: <span class="hljs-string"><span class="hljs-string">"**/*"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">"./assets/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"output"</span></span>: <span class="hljs-string"><span class="hljs-string">"./"</span></span> } ]</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, all the files and directories that will be located in src / assets will fall into the root of our build. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In ‚Äústyles‚Äù, replace ‚Äústyles.scss‚Äù with ‚Äústyles / styles.scss‚Äù.</font></font><br><br>  11.4.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">src / styles</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directory </font><font style="vertical-align: inherit;">and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">drag the src / styles.scss</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file there </font><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a src / styles / _variables.scss file with the following contents:</font></font><br><br><pre> <code class="hljs rust">$<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>-url: <span class="hljs-symbol"><span class="hljs-symbol">'https</span></span>:<span class="hljs-comment"><span class="hljs-comment">//static.yourdomain.com';</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the beginning of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">src / styles / styles.scss</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file, </font><b><font style="vertical-align: inherit;">insert the</font></b><font style="vertical-align: inherit;"> line:</font></font><br><br><pre> <code class="hljs css">@<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'variables'</span></span>;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the future, the build script will update the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ static-url</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">src / styles / _variables.scss file</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, we will have the opportunity to prescribe in styles the paths to images and fonts through this variable. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11.5. </font><font style="vertical-align: inherit;">Add the file </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">src / assets / favicon.ico</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">How are we without an icon then? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11.6. </font><font style="vertical-align: inherit;">Create a file </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">src / assets / robots.txt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><font style="vertical-align: inherit;">11.7. </font><font style="vertical-align: inherit;">Create the </font><b><font style="vertical-align: inherit;">src / assets / sitemap.xml</font></b><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">:</font></font><br><br> <code>User-agent: * <br> Host: {{SERVER_URL}} <br> Sitemap: {{SERVER_URL}}/sitemap.xml <br></code> <br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">urlset</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.sitemaps.org/schemas/sitemap/0.9"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loc</span></span></span><span class="hljs-tag">&gt;</span></span>{{SERVER_URL}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loc</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">urlset</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  11.8.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.gitlab-ci.yml file</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="hljs perl">image: node:<span class="hljs-number"><span class="hljs-number">8.9</span></span> stages: - deploy cache: paths: - node_modules/ before_script: - npm install --unsafe-perm --silent --global @angular/cli - npm install --unsafe-perm --silent - apt update - echo <span class="hljs-keyword"><span class="hljs-keyword">y</span></span> | apt install python-dev unzip - curl <span class="hljs-string"><span class="hljs-string">"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip"</span></span> -o <span class="hljs-string"><span class="hljs-string">"awscli-bundle.zip"</span></span> - unzip awscli-bundle.zip - ./awscli-bundle/install -i /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/aws -b /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/aws deploy_prod: stage: deploy only: - master environment: name: prod artifacts: paths: - dist script: - DEPLOY_SERVER=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${CI_ENVIRONMENT_URL/https:\/\/www./}</span></span></span><span class="hljs-string">"</span></span> - STATIC_URL=<span class="hljs-string"><span class="hljs-string">"https://static.$DEPLOY_SERVER"</span></span> - sed -i <span class="hljs-string"><span class="hljs-string">"s@$static-url:.*;@$static-url:'$STATIC_URL';@g"</span></span> src/styles/_variables.scss - ng build --prod --aot --build-optimizer --<span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-progress --extract-licenses=false - sed -i -e <span class="hljs-string"><span class="hljs-string">"s@\"</span></span> href=\<span class="hljs-string"><span class="hljs-string">"@\"</span></span> href=\<span class="hljs-string"><span class="hljs-string">"$STATIC_URL\/@g; s@href=\"styles@href=\"$STATIC_URL\/styles@g; s@src=\"@src=\"$STATIC_URL\/@g"</span></span> dist/index.html - SED_PATTERN=<span class="hljs-string"><span class="hljs-string">"s</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">@{</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">{STATIC_URL}</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">@$STATIC_URL@g; s</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">@{</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">{SERVER_URL}</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">@$CI_ENVIRONMENT_URL@g"</span></span> - sed -i -e <span class="hljs-string"><span class="hljs-string">"$SED_PATTERN"</span></span> dist/robots.txt - sed -i -e <span class="hljs-string"><span class="hljs-string">"$SED_PATTERN"</span></span> dist/sitemap.xml - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY - aws s3 rm s3:<span class="hljs-regexp"><span class="hljs-regexp">//www</span></span>.$DEPLOY_SERVER/ --recursive --exclude <span class="hljs-string"><span class="hljs-string">"*"</span></span> --include <span class="hljs-string"><span class="hljs-string">"*.css"</span></span> --include <span class="hljs-string"><span class="hljs-string">"*.js"</span></span> --include <span class="hljs-string"><span class="hljs-string">"*.json"</span></span> --include <span class="hljs-string"><span class="hljs-string">"*.html"</span></span> --include <span class="hljs-string"><span class="hljs-string">"*.xml"</span></span> --include <span class="hljs-string"><span class="hljs-string">"*.txt"</span></span> - aws s3 sync dist/ s3:<span class="hljs-regexp"><span class="hljs-regexp">//www</span></span>.$DEPLOY_SERVER/ --<span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-progress --<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> --size-only --acl public-<span class="hljs-keyword"><span class="hljs-keyword">read</span></span> - aws cloudfront create-invalidation --distribution-id $AWS_DISTRIBUTION_ID --paths /*.html /*.xml /*.txt /*.json</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's see what we have here. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker image "node: 8.9" is used for the script. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Declares one step of the ‚Äúdeploy‚Äù build. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The "node_modules" directory is cached. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before executing the build script, a global installation of </font></font><a href="https://habrahabr.ru/users/angular/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">angular</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / cli is performed, after which all dependencies of the project are installed. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, the necessary python-dev and unzip packages are installed, the aws cli utility is downloaded, unpacked and installed. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A single task is declared with the name ‚Äúdeploy_prod‚Äù, which is performed in the ‚Äúprod‚Äù environment, at the ‚Äúdeploy‚Äù stage and only in the ‚Äúmaster‚Äù branch. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result of this task, artifacts will be created - the entire contents of the ‚Äúdist‚Äù directory (the result of the project build). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task fulfillment process:</font></font><br><br><ul><li>   $DEPLOY_SERVER,     $CI_ENVIRONMENT_URL (  ¬´External URL¬ª, .  10.3  ),  ¬´ <a href="https://www/">www</a> .¬ª   (yourdomain.com). </li><li>   $STATIC_URL ‚Äî <a href="https://static/">static</a> .$DEPLOY_SERVER (https://static.yourdomain.com). </li><li>   "$static-url"   src/styles/_variables.scss   $STATIC_URL (https://static.yourdomain.com). </li><li>    Angular (environment ‚Äî production, AOT,  build optimizer,     ,     ). </li><li>   index.html      ,         $STATIC_URL. </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the robots.txt and sitemap.xml files, the substring "{{SERVER_URL}}" is replaced with the value $ CI_ENVIRONMENT_URL (https://www.yourdomain.com), the substring "{{STATIC_URL}}" is replaced with the value $ STATIC_URL (https: //static.yourdomain.com). </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The access key ID and secret key are set to securely connect to AWS. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S3, recursively deletes all * .css, * .js, * .json, * .html, * .xml and * .txt files from the recycle bin. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The ‚Äúdist‚Äù directory is synchronized with the S3 basket (without displaying progress on the screen, deleting the files missing from the ‚Äúdist‚Äù files from the basket, comparing only the sizes of the files, publishing the files for reading). </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To distribute CloudFront, invalidation ( </font></font><a href="http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Invalidation.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) is created with the removal of * .html, * .xml, * .txt and * .json files from the root folder.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11.9. </font><font style="vertical-align: inherit;">Run the following command in the project directory:</font></font><br><br><pre> <code class="hljs pgsql">git <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> . git <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> -m "first commit" git push</code> </pre><br>  Everything!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we have completed all the steps in this guide correctly, it remains to wait for Gitlab to complete the task, and we will see our launch site at </font></font><a href="https://www.yourdomain.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.yourdomain.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><img src="https://habrastorage.org/webt/mj/qb/rz/mjqbrzhuq0lp-lwvvj4yaf4mpam.png"><br><br>  Congratulations! <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12. Conclusion </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, we have just deployed a convenient working environment for creating a site on Angular, set up an automatic build of the project and its delivery via CDN. </font><font style="vertical-align: inherit;">We also set up a backend server, SSL certificates, DNS records and we have domain mail. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What I did not mention in the article and what else can I do?</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we need an API backend, we need to create it (in our example, in PHP). </font><font style="vertical-align: inherit;">Most likely, it will be necessary to complicate the bash server setup script by adding there, for example, installing databases.</font></font></li><li>   ,     robots.txt      Host,            S3   CloudFront. </li><li>  Gitlab CI       ‚Äî ¬´prod¬ª.  ,   ,     . </li><li>       Gitlab CI  . </li><li>  , ,       Angular.    ? </li></ul></div><p>Source: <a href="https://habr.com/ru/post/342152/">https://habr.com/ru/post/342152/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342136/index.html">Can VeraCrypt become the next TrueCrypt?</a></li>
<li><a href="../342138/index.html">Security Week 45: Ether has frozen in wallets, a million fake WhatsApps, useless protection of intellectual property</a></li>
<li><a href="../342140/index.html">Nostalgia post. Secrets of Internet prices: why megabits can cost from $ 0 to $ 200 or how to get 100 Gbit / s for a penny?</a></li>
<li><a href="../342146/index.html">Expansion of the menu functionality in nanoCAD 8.5: macros and LISP expressions</a></li>
<li><a href="../342148/index.html">Digital Transformation: Lottery in the Cloud</a></li>
<li><a href="../342154/index.html">Simulator cars Breitenberg</a></li>
<li><a href="../342156/index.html">How self-taught programmers get jobs in reality</a></li>
<li><a href="../342158/index.html">How to legalize newsletter clients</a></li>
<li><a href="../342160/index.html">Operator << options for logger</a></li>
<li><a href="../342162/index.html">Syntax analysis in NLTK. Continuation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>