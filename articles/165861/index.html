<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Control decorative lighting on Arduino from your phone</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 Last summer, I became interested in creating a system of decorative monochrome lighting with LEDs for an apartment under repair, and the qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Control decorative lighting on Arduino from your phone</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br>  Last summer, I became interested in creating a system of decorative monochrome lighting with LEDs for an apartment under repair, and the question arose on the basis of which to assemble it. <br><br>  I wanted to be able to: <br><br><ul><li>  To control the backlight modes (fading speed, luminance intensity) remotely, from an Android phone on the bluetooth or a remote control of home appliances via IR </li><li>  The possibility of easy reprogramming modes of operation on the device itself </li><li>  Cost - the less the better </li><li>  Availability of components </li></ul><br><a name="habracut"></a><br>  The choice was simple - and I became the owner of a Chinese copy of the Arduino Uno3 called DK-Duino Uno, bought for 15 evergreens on ebee.  Simultaneously with the controller, the LEDs themselves were purchased (blue, 3 bucks per hundred), the HC-05 bluetooth module for $ 12 and a 12V / 5A power supply unit for $ 7 - for a total of $ 37, or 1,100 rubles.  On ebee there is an opportunity to buy sets of LED tape 5m + controller + IR remote for $ 17, but this option did not fit because of the need to direct the console to the receiver of the controller, which is planned to hide behind furniture / plinth. <br>  The idea did not shine with originality, I just wanted to create something comfortable, durable and clear in the management of all residents of the house. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Idea </h4><br>  The LEDs located along the walls are located in the holes drilled in the laminate / parquet, a short distance from the wall (there were already a couple of posts about the similar arrangement of LEDs).  When turned on - a smooth change in the brightness of individual LEDs with simultaneous displacement along the wall of the brightest - like landing lights on the runway. <br><br>  What I wanted to translate into the backlight system <br><br><ul><li>  Change of speed and brightness of a luminescence, up to full shutdown </li><li>  Bright mode </li><li>  Attenuation mode without running </li></ul><br><br><h4>  Implementation - Arduino </h4><br>  To manage, I chose the phone on Android and the bluetooth, as the easiest way, not tied to the command system of a particular console, not subject to the problems of transmitting commands through obstacles like wall-furniture-cats. <br>  The basis was taken from one of the many schemes of running fire with attenuation, found in the vastness of the infinite. <br>  The maximum number of LEDs is 6, according to the number of PWM outputs of the selected Arduino. <br><br>  What was needed to complete: the ability to connect the bluetooth module to receive control commands and send current status data to the phone for display. <br><br>  I successfully coped with this, the result was a sketch for Arduino: <br><br><div class="spoiler">  <b class="spoiler_title">Sketch code</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SoftwareSerial.h&gt; enum LedState { LED_ON, LED_OFF }; boolean isFadeMode = false; #define LED_CNT 6 int ledPins[LED_CNT] = {11, 10, 9, 6, 5, 3}; // pwm pins int ledBrightnessesWave[LED_CNT] = {0, 50, 100, 150, 205, 255}; // represents initial brightness for wave mode int ledStepsWave[LED_CNT] = {-5, 5, 5, 5, 5, 5}; // represents initial change for wave mode int ledBrightnesses[LED_CNT]; // represents brightness for pin int ledSteps[LED_CNT]; // represents change, each pin gets its own change so it wont interfere with any other pin int ledSpeed = 50; int maxLedBrightness = 255; int ledBrightnessesConst = 255; // represents brightness for pins in no wave or fade mode LedState led_state; #define rxPin 2 #define txPin 4 #define SPEED_PREFIX 'G' #define SPEED_PREFIX_MAX 'P' #define BRIGHTNESS_PREFIX 'Q' #define BRIGHTNESS_PREFIX_MAX 'Z' #define MIN_SPEED_DELAY 5 #define MAX_SPEED_DELAY 100 #define MIN_BRIGHTNESS 5 #define MAX_BRIGHTNESS 255 // set up a new serial port SoftwareSerial mySerial = SoftwareSerial(rxPin, txPin); void setup() { for (int i = 0; i &lt; LED_CNT; i++) { pinMode(ledPins[i], OUTPUT); //set pwm pins to output //copy initial values ledBrightnesses[i] = ledBrightnessesWave[i]; ledSteps[i] = ledStepsWave[i]; } led_state = LED_ON; Serial.begin(9600); pinMode(rxPin, INPUT); pinMode(txPin, OUTPUT); mySerial.begin(115200); } int getBrightness(int b) { return b; } int valueToDelay(int value) { return MIN_SPEED_DELAY + (MAX_SPEED_DELAY - MIN_SPEED_DELAY) * value / (SPEED_PREFIX_MAX - SPEED_PREFIX); } int valueToBrightness(int value) { return MIN_BRIGHTNESS + (MAX_BRIGHTNESS - MIN_BRIGHTNESS) * value / (BRIGHTNESS_PREFIX_MAX - BRIGHTNESS_PREFIX); } void recalculateBrightness(int brValue) { ledBrightnessesConst = valueToBrightness(brValue); } void ledFade() { if (led_state == LED_OFF) { for (int i = 0; i &lt; LED_CNT; i++) { analogWrite(ledPins[i], ledBrightnessesConst); // update all pins } return; } String s = "###"; for (int i = 0; i &lt; LED_CNT; i++) { analogWrite(ledPins[i], getBrightness(ledBrightnesses[i])); int newBr = ledBrightnesses[i] + ledSteps[i]; if (newBr &lt;= 0 || newBr &gt;= maxLedBrightness) { ledSteps[i] =- ledSteps[i]; //change direction if exceeds max/min value } else { ledBrightnesses[i] = newBr; } s.concat(ledBrightnesses[i]); if (i &lt; LED_CNT - 1) //skip separator for last entity s.concat("-"); } s.concat("***"); char charBuf[1000]; s.toCharArray(charBuf, 1000); mySerial.write(charBuf); mySerial.flush(); delay(ledSpeed); } void loop() { if (mySerial.available()) { char command = mySerial.read(); Serial.println("command is -&gt; " + command); boolean handled = false; boolean changeFadeMode = false; switch (command) { case 'a': led_state = LED_OFF; handled = true; break; case 'b': led_state = LED_ON; ledSpeed = 50; handled = true; //do these lines to set wave mode changeFadeMode = true; isFadeMode = true; break; case 'c': led_state = LED_ON; ledSpeed = 30; handled = true; //do these lines to set wave mode changeFadeMode = true; isFadeMode = true; break; case 'd': led_state = LED_ON; ledSpeed = 10; handled = true; //do these lines to set wave mode changeFadeMode = true; isFadeMode = true; break; case 'e': led_state = LED_ON; changeFadeMode = true; handled = true; break; default: break; } if (changeFadeMode) { if (isFadeMode) { Serial.println("Set fade mode off"); for (int i = 0; i &lt; LED_CNT; i++) { //copy initial values ledBrightnesses[i] = ledBrightnessesWave[i]; ledSteps[i] = ledStepsWave[i]; } } else { Serial.println("Set fade mode on"); for (int i = 0; i &lt; LED_CNT; i++) { ledBrightnesses[i] = 0; ledSteps[i] = 5; } } isFadeMode = !isFadeMode; } else { //do nothing } if (!handled) { boolean isSpeedCommand = command &gt;= SPEED_PREFIX &amp;&amp; command &lt;= SPEED_PREFIX_MAX; boolean isBrCommand = command &gt;= BRIGHTNESS_PREFIX &amp;&amp; command &lt;= BRIGHTNESS_PREFIX_MAX; if (isSpeedCommand) { led_state = LED_ON; int speedValue = command - SPEED_PREFIX; //from 0 to 9 ledSpeed = valueToDelay(speedValue); } if (isBrCommand) { led_state = LED_OFF; int brValue = command - BRIGHTNESS_PREFIX; //from 0 to 9 recalculateBrightness(brValue); } } } ledFade(); }</span></span></span></span></code> </pre> <br></div></div><br><br>  Depending on the command received, the controller either changes the speed or the brightness of the LEDs.  You can also program any arbitrary actions on the received command - in the example I turn off the backlight and change the speed. <br>  In each cycle, the controller sends a bluetooth string to the paired device on the form ### 0-50-100-150-200-250 ***, where the numbers are the brightness values ‚Äã‚Äãof six LEDs, with a maximum of 255. <br><br>  Scheme: <br><img src="https://habrastorage.org/storage2/c3a/470/c74/c3a470c7400a04d3cd450162f9c6e8b0.png"><br><br><h5>  Problems </h5><br>  What faced: the inability to receive multi-character commands from the phone.  For example, by sending the command s150 (according to the idea - to set the speed of 150 parrots with a maximum of 255), I received instead of the transferred string a complete nonsense like s ###, where instead of Sharp there were any ASCII characters.  Perhaps this is due to the use of the SoftwareSerial class to connect the bluetooth.  Smoking Google showed that I am not the only one lucky with this problem, but there is no solution other than changing the modes of the HC-05 module.  There was no desire to bother with AT commands, so I decided to use only single-character commands from certain ranges, especially for the task that was quite enough.  For example - for the speed of 10 values ‚Äã‚Äãand commands from G to P, for brightness - range from Q to Z, respectively. <br><br><h4>  Implementation - Android </h4><br>  An application was written for the phone, with the ability to specify the transmitted commands without rewriting and compiling the code - for universality. <br><br>  Screenshots of the application: <br><table><tbody><tr><td><img src="https://habrastorage.org/storage2/3bb/41d/e74/3bb41de7416cbded876a027dfcd2a555.png"></td><td><img src="https://habrastorage.org/storage2/fec/d3a/18e/fecd3a18e38dbe920b4ba37955846387.png"></td><td><img src="https://habrastorage.org/storage2/c82/bc3/504/c82bc35048c901d2ba0c308bd96f5784.png"></td></tr></tbody></table><br>  There were no special problems - there is good documentation, and a very good one, as well as a huge number of tips on StackOverflow.  But I had to deal with something ‚Äî for example, the inability to connect to Arduino using the standard BluetoothDevice class method: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Get a BluetoothSocket to connect with the given BluetoothDevice try { // MY_UUID is the app's UUID string, also used by the server code tmp = device.createRfcommSocketToServiceRecord(MY_UUID); } catch (IOException e) { }</span></span></code> </pre><br><br>  Instead, I had to climb into the reflex and pull the private method: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Class class1 = device.getClass(); Class aclass[] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class[<span class="hljs-number"><span class="hljs-number">1</span></span>]; aclass[<span class="hljs-number"><span class="hljs-number">0</span></span>] = Integer.TYPE; Method method = class1.getMethod(<span class="hljs-string"><span class="hljs-string">"createRfcommSocket"</span></span>, aclass); Object aobj[] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[<span class="hljs-number"><span class="hljs-number">1</span></span>]; aobj[<span class="hljs-number"><span class="hljs-number">0</span></span>] = Integer.valueOf(<span class="hljs-number"><span class="hljs-number">1</span></span>); tmp = (BluetoothSocket)method.invoke(device, aobj); }</code> </pre><br><br>  What is the reason for this problem is unknown, but it occurs for many. <br><br>  Another problem arose when parsing the string received from the microcontroller.  Instead of lines like ### 0-50-100-150-200-250 *** ### 0-50-100-150-200-250 *** ... sometimes there were lines with an incorrect number of elements, incorrect separators or markers start / end sequence.  I solved the problem by writing the received string analyzer and discarding the wrong sequences.  After that, it was easy to implement a view with the display of the current state of the LEDs. <br><br><h4>  Results </h4><br>  A working application for the phone and a sketch for Arduino, the working scheme on the layout. <br>  Video of the example of the scheme: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Z-1hdHoF8sE%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700258&amp;usg=ALkJrhh93mTUtSY1cMvLN7X-wy6d2HFruA" frameborder="0" allowfullscreen=""></iframe><br><br>  What's next: <br><br><ul><li>  Actually the final soldering of the circuit and wiring of all the wires-LEDs around the room </li><li>  Connecting the volume-presence modules to enable / disable the system depending on the presence of a person in the room </li><li>  Connecting the clock module - why the daytime lights? </li></ul><br><br>  All sources are available here: <a href="http://code.google.com/p/arduinopad/">code.google.com/p/arduinopad</a> <br><br>  <b>Updates:</b> <br>  Arduino maximum at pwm output can produce 40 mA.  Therefore, if you need more current - use for example the transistor BC557 - get up to 100 mA.  If more is needed, then you can use any driver, for example, ULN2803APG - there will already be up to a half ampere per channel. </div><p>Source: <a href="https://habr.com/ru/post/165861/">https://habr.com/ru/post/165861/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165847/index.html">What is stopping innovation in Silicon Valley?</a></li>
<li><a href="../165849/index.html">Music sales make up only 6% of the musician's income.</a></li>
<li><a href="../165853/index.html">LogicDiscovery - simple logic analyzer</a></li>
<li><a href="../165855/index.html">File system load profiling with iostat and gnuplot - amateur notes</a></li>
<li><a href="../165857/index.html">Poster of the structure of Windows Azure services in Russian</a></li>
<li><a href="../165863/index.html">Swedish school introduces compulsory Minecraft lessons</a></li>
<li><a href="../165865/index.html">Seminar-meeting "e-Estonia - the way to Europe!" # 2</a></li>
<li><a href="../165869/index.html">Whois: practical user guide</a></li>
<li><a href="../165873/index.html">IT specialists focus their resume on teamwork, hard work and analytical mind</a></li>
<li><a href="../165875/index.html">Tactile transforming keyboard for touchscreen displays presented at CES 2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>