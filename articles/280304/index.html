<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implement a try macro for gcc under win32</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the GCC builds for windows (cygwin, mingw) out of the box there is no convenient macro __try {} __except {} for intercepting both program (throw My...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implement a try macro for gcc under win32</h1><div class="post__text post__text-html js-mediator-article">  In the GCC builds for windows (cygwin, mingw) out of the box there is no convenient macro __try {} __except {} for intercepting both program (throw MyExc) and system (signals).  Let's try to invent your bike. <br><br>  The whole article in 3 points: <br><br><ol><li>  Create try catch block </li><li>  Wrapping it in a seh block </li><li>  When SEH catches an exception, we throw a program exception. </li></ol><br>  If interested, welcome under cat. <br><a name="habracut"></a><br><h4>  Some theory </h4><br><h5>  An exception </h5><br>  An exception is a certain event, an exceptional situation that occurred during the execution of a program.  This can be, for example, dividing by zero, referring to an invalid address, or stack overflow.  In general, exception handling is the program's reaction to an event that has occurred.  It should be borne in mind that exceptions can be generated programmatically. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Windows exception path </h5><br>  Inappropriate actions occur <br>  processor <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B5%25D1%2580%25D1%258B%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">interrupt</a> that the operating system handles.  If the exception occurred in the context of the user's application, then the Windows kernel, having carried out the necessary actions, transfers control to the thread in which the exception occurred for its further processing.  However, the thread continues its execution not from the place of an exception, but from a special function - the exception manager KiUserExceptionDispatcher (NTDLL.DLL).  The dispatcher is transferred all the necessary information about the place of exclusion and its nature.  These are the EXCEPTION_RECORD and CONTEXT structures. <br><br>  KiUserExceptionDispatcher loads a chain of exception handlers (more on this later) and calls them in turn until the exception is handled. <br><br><h5>  Seh in windows </h5><br>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D1%2580%25D1%2583%25D0%25BA%25D1%2582%25D1%2583%25D1%2580%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B0%25D0%25B1%25D0%25BE%25D1%2582%25D0%25BA%25D0%25B0_%25D0%25B8%25D1%2581%25D0%25BA%25D0%25BB%25D1%258E%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B9">The SEH</a> (Structured Exception Handling) windows exception handling mechanism.  Represents a chain of EXCEPTION_REGISTRATION structures located on the thread stack. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EXCEPTION_REGISTRATION</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EXCEPTION_REGISTRATION</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">//   EXCEPTION_REGISTRATION     PEXCEPTION_ROUTINE handler; //   - } EXCEPTION_REGISTRATION, *PEXCEPTION_REGISTRATION;</span></span></code> </pre> <br>  In Win32, the pointer to the last EXCEPTION_REGISTRATION is in the <a href="https://en.wikipedia.org/wiki/Win32_Thread_Information_Block">TIB (Thread Information Block)</a> .  Further description of the structures and ways to access them will apply only to Win32. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NT_TIB32</span></span></span><span class="hljs-class"> {</span></span> DWORD ExceptionList; DWORD StackBase; DWORD StackLimit; DWORD SubSystemTib; DWORD FiberData; DWORD ArbitraryUserPointer; DWORD Self; } NT_TIB32,*PNT_TIB32;</code> </pre><br>  The first DWORD in TIB'e - points to the EXCEPTION_REGISTRATION of the current stream.  The tib of the current thread is indicated by the FS register.  Thus, at FS: [0], you can find a pointer to the EXCEPTION_REGISTRATION structure. <br><br>  So, let's begin! <br><br><h4>  Lot of practice </h4><br>  <i>The full version of the source can be viewed on <a href="https://bitbucket.org/ExIngus/gcceh/src">bitbucket</a></i> . <br>  <i>Project made in Netbeans 8.1</i> . <br>  <i>For assembly code, I use intel syntax, since</i>  <i>he is accustomed to me. For this in gcc for building you need the -masm = intel key</i> . <br><br><h5>  Experiment 1 </h5><br><pre> <code class="cpp hljs">EXCEPTION_DISPOSITION __<span class="hljs-function"><span class="hljs-function">cdecl </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">except_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( PEXCEPTION_RECORD pException, PEXCEPTION_REGISTRATION pEstablisherFrame, PCONTEXT pContext, PEXCEPTION_REGISTRATION *pDispatcherContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"EXCEPTION_RECORD(%p):\n"</span></span> <span class="hljs-string"><span class="hljs-string">" Address=%p\n"</span></span> <span class="hljs-string"><span class="hljs-string">" Code=%lx\n"</span></span> pException, pException-&gt;ExceptionAddress, pException-&gt;ExceptionCode); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ex_1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    EXCEPTION_REGISTRATION EXCEPTION_REGISTRATION seh_ex_reg = EXCEPTION_REGISTRATION(); //  fs:[0]     int seh_prev_addr; asm ("mov %0,fs:[0];" : "=r" (seh_prev_addr) :); seh_ex_reg.prev = (_EXCEPTION_REGISTRATION_RECORD*) seh_prev_addr; seh_ex_reg.handler = (PEXCEPTION_ROUTINE) &amp; except_handler; //  fs:[0]    asm volatile("mov fs:[0], %0;"::"r"(&amp;seh_ex_reg) :); *(char *) 0 = 0; //   //   asm volatile("mov fs:[0], %0;"::"r"(seh_ex_reg.prev) :); }</span></span></code> </pre><br>  Perform, see the result: <br><blockquote>  EXCEPTION_RECORD (0028f994): <br>  Address = 00401d1b EIP instructions where the exception occurred <br>  Code = c0000005 STATUS_ACCESS_VIOLATION ((DWORD) 0xC0000005) <br></blockquote><br><img src="https://habrastorage.org/files/a08/88a/c91/a0888ac916874c67baf8618feecd5c0d.png"><br><br><h5>  Experiment 2 </h5><br>  Wrap the code inside ex_1 in try {} catch {} and try to just throw an exception from except_handler: <br><blockquote>  EXCEPTION_RECORD (0028f994): <br>  Address = 00401d7e <br>  Code = c0000005 <br>  terminate called after throwing an instance of 'test :: SEH_EXCEPT' <br></blockquote><br>  Natural result. <br><br>  We look into what turns into try ... catch in gcc, we look into assembly code, we smoke manuals. <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throw_seh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> SEH_EXCEPT(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ex_2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ NOP; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"try1\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> SEH_EXCEPT(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (...) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"catch1\n"</span></span>); } NOP; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"try2\n"</span></span>); throw_seh(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (...) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"catch2\n"</span></span>); } }</code> </pre><br><img src="https://habrastorage.org/files/0a8/dc1/59a/0a8dc159a346492f80dc630861d334a3.png"><br><br>  If you are interested in what __cxa_allocate_exception and __cxa_throw are and recommend reading the cycle of articles ‚ÄúC ++ exception handling under the hood or how exceptions work in C ++‚Äù. <br><br>  <i>The idea: we will throw exceptions not from except_handler but from a synthetic function, into which the call will ‚Äúoccur‚Äù instead of the instruction that caused the error.</i> <br><br><h5>  Final option </h5><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SEH_EXCEPTION</span></span></span><span class="hljs-class"> {</span></span> PVOID address; DWORD code; }; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">landing_throw_unwinder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PVOID exceptionAddress, DWORD exceptionCode)</span></span></span><span class="hljs-function"> </span></span>{ SEH_EXCEPTION ex = SEH_EXCEPTION(); ex.address = exceptionAddress; ex.code = exceptionCode; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> ex; } EXCEPTION_DISPOSITION __<span class="hljs-function"><span class="hljs-function">cdecl </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">except_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( PEXCEPTION_RECORD pException, PEXCEPTION_REGISTRATION pEstablisherFrame, PCONTEXT pContext, PEXCEPTION_REGISTRATION *pDispatcherContext)</span></span></span><span class="hljs-function"> </span></span>{ DWORD pLanding = (DWORD) &amp; landing_throw_unwinder; <span class="hljs-comment"><span class="hljs-comment">// call // push  DWORD exceptionCode pContext-&gt;Esp = pContext-&gt;Esp - 4; *(DWORD *) (pContext-&gt;Esp) = pException-&gt;ExceptionCode; // push  exceptionAddress pContext-&gt;Esp = pContext-&gt;Esp - 4; *(PVOID *) (pContext-&gt;Esp) = pException-&gt;ExceptionAddress; // push   pContext-&gt;Esp = pContext-&gt;Esp - 4; *(int *) (pContext-&gt;Esp) = pContext-&gt;Eip; pContext-&gt;Eip = pLanding; //   return ExceptionContinueExecution; } /** *     try{..}catch{...}       *          catchIndex *      * mov[esp+20],index * call __throw_magic_link *(push eip; jmp __throw_magic_link) */ __attribute__((noinline, stdcall)) void __throw_magic_link() { int test; asm volatile ("mov %0,1;" : "=r" (test)); // gcc     throw if (test &gt; 0) { return; } throw SEH_EXCEPTION(); } void ex_4() { EXCEPTION_REGISTRATION __seh_ex_reg = EXCEPTION_REGISTRATION(); try { //  EXCEPTION_REGISTRATION,    fs:[0] int __seh_prev_addr; asm ( "mov %0,fs:[0];" : "=r" (__seh_prev_addr) :); __seh_ex_reg . prev = (_EXCEPTION_REGISTRATION_RECORD *) __seh_prev_addr; __seh_ex_reg . handler = (PEXCEPTION_ROUTINE) &amp; seh::except_handler; asm volatile ( "mov fs:[0], %0;" ::"r" (&amp; __seh_ex_reg) :); //       catch  int catchIndex; asm volatile ( "mov %0,[esp+0x20];" : "=r" (catchIndex) :); //""   ""   //    try{..}catch{...}       //   catchIndex seh::__throw_magic_link(); { *(char *) 0 = 0; } //  ,  catchIndex,       asm volatile ( "mov [esp+0x20],%0;" ::"r" (catchIndex) :); //    asm volatile ( "mov fs:[0], %0;" ::"r" (__seh_ex_reg . prev) :); } catch (SEH_EXCEPTION) { //    asm volatile ( "mov fs:[0], %0;" ::"r" (__seh_ex_reg . prev) :); printf("except1!\n"); } }</span></span></code> </pre><br></div></div><br>  In except_handler, we make the transition to the function that throws an exception, by editing the CONTEXT: <br><br><pre> <code class="cpp hljs">DWORD pLanding = (DWORD) &amp; landing_throw_unwinder; <span class="hljs-comment"><span class="hljs-comment">// push   pContext-&gt;Esp = pContext-&gt;Esp - 4; *(int *) (pContext-&gt;Esp) = pContext-&gt;Eip; pContext-&gt;Eip = pLanding; //   return ExceptionContinueExecution;</span></span></code> </pre><br>  After installing SEH, inside the try block we add a call to a special function __throw_magic_link, which, according to the compiler, can throw an exception.  This will prevent the compiler from cutting out our try ... catch block as not used.  To avoid problems when working nested blocks, remember and restore catchIndex. <br><br><h5>  <b>Macro</b> </h5><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">undef</span></span></span><span class="hljs-meta"> __try #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __try \ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (bool _try = true) {\ EXCEPTION_REGISTRATION __seh_ex_reg = EXCEPTION_REGISTRATION();</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*    EXCEPTION_REGISTRATION*/</span></span></span><span class="hljs-meta">\ try {\ int __seh_prev_addr;\ asm (</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mov %0,fs:[0];"</span></span></span><span class="hljs-meta"> : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=r"</span></span></span><span class="hljs-meta"> (__seh_prev_addr) :);\ __seh_ex_reg.prev = (_EXCEPTION_REGISTRATION_RECORD*) __seh_prev_addr;\ __seh_ex_reg.handler = (PEXCEPTION_ROUTINE) &amp; seh::except_handler;\ asm volatile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mov fs:[0], %0;"</span></span></span><span class="hljs-meta">::</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta">(&amp;__seh_ex_reg) :);\ int catchIndex; asm volatile (</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mov %0,[esp+0x20];"</span></span></span><span class="hljs-meta"> : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=r"</span></span></span><span class="hljs-meta"> (catchIndex) :);</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* catch */</span></span></span><span class="hljs-meta">\ seh::__throw_magic_link();\ </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*begin try bloc*/</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __except_line(filter, </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> )\ asm volatile (</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mov [esp+0x20],%0;"</span></span></span><span class="hljs-meta"> ::</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta"> (catchIndex) :);;\ asm volatile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mov fs:[0], %0;"</span></span></span><span class="hljs-meta">::</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta">(__seh_ex_reg.prev) :);\ } catch (filter) {\ asm volatile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mov fs:[0], %0;"</span></span></span><span class="hljs-meta">::</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta">(__seh_ex_reg.prev) :);\ _try = false;\ goto __seh_catch_ ## </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">;\ }\ } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta">\ __seh_catch_ ## </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">:\ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!_try)\ </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*begin catch bloc*/</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __except_line__wrap(filter, </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> ) __except_line(filter,</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">undef</span></span></span><span class="hljs-meta"> __except #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __except(filter) __except_line__wrap(filter,__LINE__) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __exceptSEH __except_line__wrap(SEH_EXCEPTION,__LINE__) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br></div></div><br>  So, the concept works, now you need to write a macro for convenient use, a template like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// __try: if (bool _try = true) { //       else EXCEPTION_REGISTRATION __seh_ex_reg; // try     catch try { // seh   //  __try: { //  } // __except: // seh }catch (filter) { // seh _try = false; goto seh_label; }\ } else seh_label: if (!_try) //  __except: { //  } // : __try{ throw_test(); } __except{ printf("except1!\n"); }</span></span></code> </pre><br>  This code is more a warm-up for the mind, non-residential ready-made business decision, and was written for several evenings because of the desire to dig deeper into the assembler code.  Thank you for your attention, I will be grateful for the criticism. <br><br>  <a href="https://bitbucket.org/ExIngus/gcceh/src">Sources</a> <br><br>  Related articles: <br><br>  <a href="http://www.wasm.ru/series/9">Win32 SEH inside</a> <br>  <a href="https://habrahabr.ru/post/279111/">C ++ exception handling under the hood</a> </div><p>Source: <a href="https://habr.com/ru/post/280304/">https://habr.com/ru/post/280304/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280294/index.html">Not IoT, but raspberry! We build the IoT-project on Raspberry Pi with Windows 10 and DeviceHive</a></li>
<li><a href="../280296/index.html">How to clean up the mailbox using a neural network. Part 2</a></li>
<li><a href="../280298/index.html">Pitfalls .load () and .get ()</a></li>
<li><a href="../280300/index.html">Beeline Data School: Spring, Knowledge, New Course</a></li>
<li><a href="../280302/index.html">RSA encryption through the OpenSSL library in Delphi</a></li>
<li><a href="../280306/index.html">Learn to command</a></li>
<li><a href="../280308/index.html">Hackathon Angelhack 2016: a week later in the first of 4 cities</a></li>
<li><a href="../280310/index.html">Simple Yii2 application to send mail</a></li>
<li><a href="../280312/index.html">On the value of cards in the game "Drunkard"</a></li>
<li><a href="../280316/index.html">Flow ... or not serious post about serious things</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>