<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sound output to Arduino Due</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will talk about how to output audio to the Arduino Due without active use of the processor. 

 After receiving a fee and experimenti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sound output to Arduino Due</h1><div class="post__text post__text-html js-mediator-article">  In this article I will talk about how to output audio to the Arduino Due without active use of the processor. <br><br>  After receiving a fee and experimenting with sketches, I realized that I would not write firmware in a standard IDE and began to look for an alternative.  My choice was Atmel Studio version 6.0.  I really liked this IDE, which is made on the basis of Visual Studio 2010. I liked it especially because it all worked out of the box.  In the wizard to create a new project, I chose the Arduino Due board, chose the project a la ‚ÄúHello World‚Äù (blinking LED), compiled and launched.  Particularly pleased that there were no layers and libraries hidden from me.  The firmware was completely assembled from the source code, it eventually bribed me, and I stayed at the Atmel Studio.  By the way, Visual Assist is already built into it, which makes writing code even more comfortable. <br><br>  And so, I was faced with the task of outputting audio through DACC (Analog Converter Controller), but without 100% of the processor load.  Ideally, I wanted to send the next portion of data to the DACC and forget about it until it is necessary to send a new portion. <br>  For this I had to use PDC (Peripheral DMA Controller) and TC (Timer Counter).  In the end, everything turned out to be quite simple, but I suffered a little before it all worked.  If interested, then I ask under the cat. <br><a name="habracut"></a><br>  By itself, the sound output is not any difficulty.  We simply write the next 12-bit value to the DACC channel, pausing between these operations.  An example of audio output is available in Atmel Studio (DAC Sinewave Example).  In this example, the system timer is initialized (System Timer), in the interrupt handler of which the amplitude value is written to the DACC channel.  Also, at first glance, the processor should not be too heavy, but for a frequency of 32 kHz, we already need 32,000 interrupts per second, not to mention that for other purposes the system timer will not work, because  it will have to reconfigure each time to the desired frequency. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order to send data to the DACC in portions, you can use the PDC, but it sends data without a pause, i.e  expects when the next half-word will be taken by iron and immediately sends the next one.  To output the sound is not enough for us, because  data should be recorded with a specific frequency.  Here, one of the DACC modes of operation comes to our rescue, namely, he knows how to use TC as a trigger.  So, it remains for us to tune in the desired TC frequency and tell the DACC to use one of the TC channels. <br><br>  TC is set to waveform mode.  To do this, a counter value is written to the Ra register, at which a signal appears at the output, and a value (in our case, Ra + 1), at which the output signal is reset, is written to the Rc register.  Thus, we generate a signal of a given frequency, which is transmitted to the input of the DACC. <br><br>  When using the PDC, it must be borne in mind that it does not know how to transfer data from ROM, only from RAM. <br><div class="spoiler">  <b class="spoiler_title">The sound processing module is located in the sound.c file.</b> <div class="spoiler_text"><pre><code class="hljs haskell">//   static uint16_t g_buffer[<span class="hljs-number"><span class="hljs-number">4096</span></span>]; //   ,        static volatile uint16_t g_buffer_head, g_buffer_tail, g_buffer_size; //         static inline uint16_t get_continuous_data_size_irq(void) { return g_buffer_head &lt;= g_buffer_tail ? g_buffer_tail - g_buffer_head : <span class="hljs-type"><span class="hljs-type">ARRAYSIZE</span></span>(g_buffer) - g_buffer_head; } //       static inline uint16_t get_buffer_capacity(void) { return g_buffer_size; } //     static uint16_t copy_in_buffer(const uint16_t * <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">, uint16_t size) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tail</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_tail</span></span></span><span class="hljs-class">; //        </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint32_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_copy</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ARRAYSIZE(g_buffer)</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tail</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memcpy</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> *)(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tail</span></span></span><span class="hljs-class">), (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size_t</span></span></span><span class="hljs-class">)(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_copy</span></span></span><span class="hljs-class"> &lt;&lt; 1)); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_copy</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">) { //        </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memcpy</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_copy</span></span></span><span class="hljs-class">, (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_copy</span></span></span><span class="hljs-class">) &lt;&lt; 1); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tail</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_copy</span></span></span><span class="hljs-class">; } else { //        </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tail</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">; } return tail; } //     ,    static inline void move_head_irq(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_head</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_size</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_head</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ARRAYSIZE(g_buffer)</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_head</span></span></span><span class="hljs-class"> &gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_tail</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_head</span></span></span><span class="hljs-class"> -= </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ARRAYSIZE(g_buffer)</span></span></span><span class="hljs-class">; } //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PDC</span></span></span><span class="hljs-class"> //    static pdc_packet_t g_pdc_packet; //     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PDC</span></span></span><span class="hljs-class"> static volatile uint32_t g_pdc_packet_size; //   0,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PDC</span></span></span><span class="hljs-class">    static volatile uint8_t g_pdc_active; //    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class"> static inline void disable_irq(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_disable_interrupt</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC_IER_ENDTX</span></span></span><span class="hljs-class">); } //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PDC</span></span></span><span class="hljs-class"> ,     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class"> static inline void restore_irq(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_active</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_enable_interrupt</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC_IER_ENDTX</span></span></span><span class="hljs-class">); } #define </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC_PDC_PACKET_MAX_SIZE</span></span></span><span class="hljs-class"> 512 //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class"> // ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PDC</span></span></span><span class="hljs-class"> void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC_Handler</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) { //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint32_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_get_interrupt_status</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> &amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC_IER_ENDTX</span></span></span><span class="hljs-class">) { //   ,   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">move_head_irq</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_packet_size</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_size</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_continuous_data_size_irq</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_size</span></span></span><span class="hljs-class"> == 0) { //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_packet_size</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_active</span></span></span><span class="hljs-class"> = 0; //    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_disable_interrupt</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC_IDR_ENDTX</span></span></span><span class="hljs-class">); } else { //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PDC</span></span></span><span class="hljs-class">     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_packet</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ul_addr</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint32_t</span></span></span><span class="hljs-class">)(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_head</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_packet_size</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC_PDC_PACKET_MAX_SIZE</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_size</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_packet</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ul_size</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_packet_size</span></span></span><span class="hljs-class">; //  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pdc_tx_init</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PDC_DACC</span></span></span><span class="hljs-class">, &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_packet</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NULL</span></span></span><span class="hljs-class">); } } } //   0 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC</span></span></span><span class="hljs-class">      static void tc_adjust_frequency(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frequency</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint32_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">divider</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sysclk_get_cpu_hz</span></span></span><span class="hljs-class">() / </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frequency</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">divider</span></span></span><span class="hljs-class"> &gt;&gt;= 1; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tc_write_ra</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC0</span></span></span><span class="hljs-class">, 0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">divider</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tc_write_rc</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC0</span></span></span><span class="hljs-class">, 0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">divider</span></span></span><span class="hljs-class"> + 1); } //   void sound_init_hardware(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) { //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sysclk_enable_peripheral_clock</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ID_TC0</span></span></span><span class="hljs-class">); //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC0</span></span></span><span class="hljs-class">   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">waveform</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tc_init</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC0</span></span></span><span class="hljs-class">, 0, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC_CMR_TCCLKS_TIMER_CLOCK1</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC_CMR_WAVE</span></span></span><span class="hljs-class"> /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Waveform</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mode</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enabled</span></span></span><span class="hljs-class"> */ | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC_CMR_ACPA_SET</span></span></span><span class="hljs-class"> /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RA</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compare</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Effect</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">set</span></span></span><span class="hljs-class"> */ | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC_CMR_ACPC_CLEAR</span></span></span><span class="hljs-class"> /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compare</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Effect</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clear</span></span></span><span class="hljs-class"> */ | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC_CMR_CPCTRG</span></span></span><span class="hljs-class"> /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UP</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mode</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">automatic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trigger</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">on</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compare</span></span></span><span class="hljs-class"> */ ); //  -   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC</span></span></span><span class="hljs-class">,    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tc_adjust_frequency</span></span></span><span class="hljs-class">(8000); //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tc_start</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC0</span></span></span><span class="hljs-class">, 0); //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sysclk_enable_peripheral_clock</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ID_DACC</span></span></span><span class="hljs-class">); //    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_reset</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">); //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">   "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">half</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">word</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_set_transfer_mode</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">, 0); //    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_set_power_save</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">, 0, 0); //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TC0</span></span></span><span class="hljs-class">    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_set_trigger</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">, 1); //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TAG</span></span></span><span class="hljs-class">     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_set_channel_selection</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">, 1); //    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_enable_channel</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">, 1); //     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_set_analog_control</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC_ACR_IBCTLCH0(0x02)</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC_ACR_IBCTLCH1(0x02)</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC_ACR_IBCTLDACCORE(0x01)</span></span></span><span class="hljs-class">); //    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NVIC_DisableIRQ(DACC_IRQn)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NVIC_ClearPendingIRQ(DACC_IRQn)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NVIC_EnableIRQ(DACC_IRQn)</span></span></span><span class="hljs-class">; //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PDC</span></span></span><span class="hljs-class">     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pdc_enable_transfer</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PDC_DACC</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PERIPH_PTCR_TXTEN</span></span></span><span class="hljs-class">); //    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_packet_size</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_active</span></span></span><span class="hljs-class"> = 0; } //        void sound_start(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frequency</span></span></span><span class="hljs-class">) { //     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sound_stop</span></span></span><span class="hljs-class">(); //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tc_adjust_frequency</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frequency</span></span></span><span class="hljs-class">); } //    void sound_stop(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) { //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dacc_disable_interrupt</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DACC_IER_ENDTX</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_packet_size</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_head</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_tail</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_size</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ARRAYSIZE(g_buffer)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_active</span></span></span><span class="hljs-class"> = 0; } //          uint8_t sound_data(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">) { //    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">capacity</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_buffer_capacity</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">capacity</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> 0; //     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tail</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">copy_in_buffer</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">); //    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">disable_irq</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_tail</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tail</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_size</span></span></span><span class="hljs-class"> -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_head</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ARRAYSIZE(g_buffer)</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_buffer_head</span></span></span><span class="hljs-class"> -= </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ARRAYSIZE(g_buffer)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g_pdc_active</span></span></span><span class="hljs-class"> = 1; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">restore_irq</span></span></span><span class="hljs-class">(); //    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> 1; }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">I wrote a small example of use.</b> <div class="spoiler_text"><pre> <code class="hljs lua">#include &lt;asf.h&gt; #include <span class="hljs-string"><span class="hljs-string">"sound.h"</span></span> #define STRING_HEADER <span class="hljs-string"><span class="hljs-string">"-- Sound firmware --\r\n"</span></span> \ <span class="hljs-string"><span class="hljs-string">"-- "</span></span>BOARD_NAME<span class="hljs-string"><span class="hljs-string">" --\r\n"</span></span> \ <span class="hljs-string"><span class="hljs-string">"-- Compiled: "</span></span>__DATE__<span class="hljs-string"><span class="hljs-string">" "</span></span>__TIME__<span class="hljs-string"><span class="hljs-string">" --\r"</span></span> static void configure_console(void) { const usart_serial_options_t uart_serial_options = { .baudrate = <span class="hljs-number"><span class="hljs-number">115200</span></span>, .paritytype = UART_MR_PAR_NO }; sysclk_enable_peripheral_clock(ID_UART); stdio_serial_init(UART, &amp;uart_serial_options); } #include <span class="hljs-string"><span class="hljs-string">"sound_data.c"</span></span> static uint32_t g_sound_pos = <span class="hljs-number"><span class="hljs-number">0</span></span>; int main (void) { sysclk_init(); board_init(); configure_console(); puts(STRING_HEADER); printf(<span class="hljs-string"><span class="hljs-string">"CPU Frequency %li MHz\r\n"</span></span>, sysclk_get_cpu_hz() / <span class="hljs-number"><span class="hljs-number">1000000</span></span>); sound_init_hardware(); sound_start(<span class="hljs-number"><span class="hljs-number">16000</span></span>); puts(<span class="hljs-string"><span class="hljs-string">"Work...\r"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { //    <span class="hljs-number"><span class="hljs-number">512</span></span>   ,   uint32_t size = <span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-number"><span class="hljs-number">512</span></span>, ARRAYSIZE(g_sound_data) - g_sound_pos); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sound_data(g_sound_data + g_sound_pos, size)) { //      g_sound_pos += size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (g_sound_pos &gt;= ARRAYSIZE(g_sound_data)) g_sound_pos = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //    ,    } } }</code> </pre><br></div></div><br>  Here in the loop we send data from the array to the output queue, in case of success, we move to the end of the array, having reached the end, we return to the beginning.  We work endlessly. <br><br>  I use this module in another project, I output the sound when receiving the next packet via USB, so the task not to load the processor was completed. <br>  You can also send audio data with a pre-calculated pause between packets, for example, if the packet size is 512 half words, and the sound frequency is 8 kHz, then the pause between sending will be 512/8000 = 64 ms. <br><br>  It would be nice to get rid of copying data, if we are sure that they do not come from ROM.  And the PDC can transmit two packets at once, this can also be used. <br><br>  Dynamically changing the frequency of the sound, you can smooth out the unevenness in its content.  For example, when filling the buffer by 2/3 of its volume, we slightly increase the frequency so that it is emptied faster. <br><br>  I stitched the board using the standard utility from the Arduino IDE, it was too lazy to look for alternative ways, and this one completely suited me.  You can send an example to the controller with the command: <br> <code>bossac.exe --port=COM4 -U false -e -w -v -b sound.bin ‚ÄìR</code> <br> <br>  bossac.exe - utility from Arduino IDE <br>  Specify the COM port name. <br>  The firmware file can be found in the Debug or Release directory of your project. <br><br>  The entire project can be found here <a href="https://github.com/artalex/arduino_due_sound">github.com/artalex/arduino_due_sound</a> <br><br>  Atmel Studio has a huge number of examples for Arduino Due, I strongly advise you to study them. <br><br>  The pinout of the board is described here <a href="http://arduino.cc/en/Hacking/PinMappingSAM3X">arduino.cc/en/Hacking/PinMappingSAM3X</a> . <br>  Here is a link to the description of the SAM3X controller: <a href="http://www.atmel.com/Images/doc11057.pdf">www.atmel.com/Images/doc11057.pdf</a> . <br><br>  An example array was obtained by the wave2hex.py script.  It lies in the scripts directory in the project. <br>  Use this: <code>wave2hex.py ‚ÄìI some.wav</code> , where some.wav is the name of the file to be converted. </div><p>Source: <a href="https://habr.com/ru/post/208436/">https://habr.com/ru/post/208436/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208424/index.html">Peer Broadcast Features</a></li>
<li><a href="../208428/index.html">Apple's patent policy in recent years. View from the outside</a></li>
<li><a href="../208430/index.html">Home CNC router as an alternative to a 3D printer, part two</a></li>
<li><a href="../208432/index.html">We collect the project on a RAM disk by means of Maven</a></li>
<li><a href="../208434/index.html">Background update data in iOS7</a></li>
<li><a href="../208442/index.html">Cheat Sheet on SOLID Principles with PHP Examples</a></li>
<li><a href="../208444/index.html">We help the robot sorter in the mail</a></li>
<li><a href="../208446/index.html">Improved UPX compression ratio</a></li>
<li><a href="../208448/index.html">Agency DARPA launched a project to create biodegradable electronics, self-destructing on command</a></li>
<li><a href="../208450/index.html">The revived "moonwalker" or a toy, about which not all have heard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>