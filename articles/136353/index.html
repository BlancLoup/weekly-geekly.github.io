<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Check replication MySQL master-master via Zabbix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After setting up a master-master replication of MySQL, the next logical step is to set up verification of this system. Reading tutorials on the Intern...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Check replication MySQL master-master via Zabbix</h1><div class="post__text post__text-html js-mediator-article">  After setting up a master-master replication of MySQL, the next logical step is to set up verification of this system.  Reading tutorials on the Internet, it became clear that such replication is a popular affair, and it flies two or three times.  Therefore, I decided to insert a check whether replication is still working or something has happened and everything has flown down. <br>  The first few Google queries showed that it is impossible to believe ‚ÄúSHOW SLAVE STATUS \ G‚Äù: Stuck is good, but it often lies a lot.  A little thought, I came to the following decision: <br><a name="habracut"></a><br>  * A database is created on two servers, a label in it in which both servers are written to the crown.  Replication should automatically transfer data from one server to another. <br>  * Writes a script that is called on the crown to update the data. <br>  * A script is written that reads the tablet and watches when the data from the ‚Äúother‚Äù server was last updated.  If everything is good, it writes 1, if not - 0 (this status is easier to check with Zabbiks) <br>  * Fits your UserParameter into the zabbiks agent config.  Added triggers in zabbiks <br>  *Coffee <br><br><h5>  Training </h5><br>  On both servers we create a database and tables: <br><br> <code>create database repl_check; <br> use repl_check; <br> create table repl_status(s_id int, server_time TIMESTAMP); <br> insert into repl_status values(1,NOW());</code> <br> <br>  Do not forget to include this database in the replication, you need to add the line to /etc/my.cnf <br> <code>binlog-do-db=repl_check</code> <br> <br>  Restart both mysql servers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  We give signs of life </h5><br>  Each server has its own config, and a unique server_id.  Initially I tried to use the global @@ server_id, which is defined in my.cnf for replication, but the binary log transmits the command completely, and each server executes it for a different server_id, (Ie, the first one updates the line where server_id = 1, and the second one where server_id = 2), and I decided not to suffer, but simply to enter unique server_id for each server. <br>  max_seconds_diff is the maximum difference to which the server thinks everything is fine.  In principle, there may be a small value, but I decided not to fall into fanaticism.  If there is a real problem, I will find out in 3 minutes anyway. <br><br>  <b>config.php</b> <br> <code>&lt;?php <br> $username="root"; <br> $password=""; <br> $dbname="repl_check"; <br> $server_id=1; <br> $max_seconds_diff = 130; <br> ?&gt;</code> <br> <br>  <b>repl_update.php</b> <br> <code>&lt;?php <br> include('config.php'); <br> <br> $sql_conn = mysql_connect("localhost",$username,$password); <br> if ($sql_conn == NULL) <br> die("failed connecting"); <br> mysql_select_db($dbname); <br> <br> $sql_query = "update repl_status set server_time=NOW() where s_id like " . intval($server_id); <br> mysql_query($sql_query,$sql_conn); <br> <br> mysql_close($sql_conn); <br> ?&gt;</code> <br> <br>  We add it to kroner.  Now every minute both servers will update the database, each line with its own server_id <br> <code>crontab -e <br> * * * * * php /home/myuser/scripts/check_repl/repl_update.php</code> <br>  Everything, the plate is updated every minute. <br><br><h5>  Recognize signs of life. </h5><br>  <b>check_repl.php</b> <br> <code>&lt;?php <br> include('config.php'); <br> <br> $sql_conn = mysql_connect("localhost",$username,$password); <br> if ($sql_conn == NULL) <br> die("failed connecting"); <br> mysql_select_db($dbname); <br> <br> $time_result = mysql_query("select time_to_sec(timediff(NOW(), max(server_time))) as serv_time_diff from repl_status where s_id != " . intval($server_id)); <br> $result_row = mysql_fetch_array($time_result, MYSQL_ASSOC); <br> $seconds_diff = intval($result_row["serv_time_diff"]); <br> <br> mysql_free_result($time_result); <br> mysql_close($sql_conn); <br> <br> if ($seconds_diff &gt; $max_seconds_diff) <br> print "0"; //bad <br> else <br> print "1"; //good! <br> ?&gt;</code> <br> <br>  For convenience, I have added a script next: <br><br>  <b>check_repl.sh</b> <br> <code>#!/bin/sh <br> php /home/myuser/scripts/check_repl/check_repl.php</code> <br> <br>  To check, on one of the servers, you need to start ‚Äúslave stop‚Äù, wait 2-3 minutes and run check_repl.sh.  In this case, we should get 0. If we start ‚Äúslave start‚Äù, in a minute the status should equalize. <br><br><h5>  Zabbiks </h5><br>  This line should be added to /etc/zabbix/zabbix_agentd.conf (or where the config is located) <br> <code>UserParameter=mysql_repl.check,/home/myuser/scripts/check_repl/check_repl.sh</code> <br> <br>  This means that if zabbix (or zabbix_get) requests an item with the key mysql_repl.check, then our script will start and we will get its value (0 or 1) <br><br>  After this, you need to restart the agent of zabbiks and you can add item and trigger to zabbiks.  In Item, in the Show value field, set the Service state (in this case, 0 is down, 1 up) <br>  mysql_repl.check <br>  And the trigger on it: {MyHost: mysql_repl.check.last (0)} &lt;1 <br><br>  Do not forget that item and trigger must be added to both hosts.  Where replication will fly - there will be a trigger. <br><br>  Everything. <br>  I wish high availability to your mysql servers. </div><p>Source: <a href="https://habr.com/ru/post/136353/">https://habr.com/ru/post/136353/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136347/index.html">Robbers stop taking CDs and DVDs</a></li>
<li><a href="../136348/index.html">Spaces in indesign and how i put them</a></li>
<li><a href="../136350/index.html">3D editors, pros and cons</a></li>
<li><a href="../136351/index.html">CSS modal windows</a></li>
<li><a href="../136352/index.html">Change your hard disk on your MacBook Pro in three clicks</a></li>
<li><a href="../136354/index.html">Interview with the creator of NGINX Igor Sysoev</a></li>
<li><a href="../136356/index.html">Invitation to the Java Day SPB 2012 conference</a></li>
<li><a href="../136357/index.html">Amazon Free Usage Tier now includes Windows instance.</a></li>
<li><a href="../136358/index.html">Oatmeal - Why some emails remain unanswered</a></li>
<li><a href="../136360/index.html">Optimize javascript to speed up web page loading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>