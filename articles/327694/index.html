<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search in the Django REST Framework using Elasticsearch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Users search for products in the online store, search for articles, search is an integral component of the site. Fast and flexible search is difficult...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search in the Django REST Framework using Elasticsearch</h1><div class="post__text post__text-html js-mediator-article"><p>  Users search for products in the online store, search for articles, search is an integral component of the site.  Fast and flexible search is difficult to implement with relational databases.  For such tasks use search engines, one of which is <a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a> .  Elasticsearch is well documented and available out of the box on AWS. </p><br><p>  To work with elasticsearch, the library uses <a href="https://github.com/elastic/elasticsearch-py">elasticsearch-py</a> or <a href="https://github.com/elastic/elasticsearch-dsl-py">elasticsearch-dsl-py</a> .  elasticsearch-dsl-py is an add-on over elasticsearch-py, it is easy to use and supports version 5.x elasticsearch.  Based on this library, the <a href="https://github.com/myarik/django-rest-elasticsearch">django-rest-elasticsearch</a> library was created, which is based on the ideology of the existing search in the <a href="http://www.django-rest-framework.org/">Django REST Framework</a> .  Below I will describe in detail how to implement a search in the Django REST Framework using elasticsearch using this library. </p><br><a name="habracut"></a><br><p>  As an example, consider the implementation of a simple blog with filtering by tags and search by article title. </p><br><h2 id="ustanovka">  Installation </h2><br><p>  The installation process of elasticsearch and django is detailed in the official documentation.  With the installation package everything is quite simple </p><br><pre><code class="hljs sql">pip <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> django-rest-elasticsearch</code> </pre> <br><h2 id="sozdanie-modeli-i-indeksa">  Creating a model and index </h2><br><p>  Create a model </p><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Blog</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> title = models.CharField(_(<span class="hljs-string"><span class="hljs-string">'Title'</span></span>), max_length=<span class="hljs-number"><span class="hljs-number">1000</span></span>) created_at = models.DateTimeField(_(<span class="hljs-string"><span class="hljs-string">'Created at'</span></span>), auto_now_add=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) body = models.TextField(_(<span class="hljs-string"><span class="hljs-string">'Body'</span></span>)) tags = ArrayField(models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">200</span></span>), blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) is_published = models.BooleanField(_(<span class="hljs-string"><span class="hljs-string">'Is published'</span></span>), default=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__str__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.title</code> </pre> <br><p>  After creating the model, we will describe our model as an elasticsearch document. </p><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BlogIndex</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocType</span></span></span><span class="hljs-class">): pk = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Integer</span></span></span><span class="hljs-class">() title = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Text</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fields</span></span></span><span class="hljs-class">={'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raw'</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Keyword</span></span></span><span class="hljs-class">()}) created_at = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Date</span></span></span><span class="hljs-class">() body = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Text</span></span></span><span class="hljs-class">() tags = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Keyword</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">multi</span></span></span><span class="hljs-class">=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">True</span></span></span><span class="hljs-class">) is_published = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Boolean</span></span></span><span class="hljs-class">() </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Meta</span></span></span><span class="hljs-class">: index = 'blog'</span></span></code> </pre> <br><p>  Now you can create an index in elasticsearch </p><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">BlogIndex</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>()</code> </pre> <br><h2 id="avtomaticheskoe-obnovlenie-dokumentov-v-elasticsearch">  Automatic update of documents in elasticsearch </h2><br><p>  After creating the model and the index, it is necessary that any changes in our model are displayed in elasticsearch.  The best way to do this is to add a django signal that will send notifications when changes occur in the model.  Before creating a signal, create a serializer for converting a django object into an elasticsearch document </p><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rest_framework_elasticsearch.es_serializer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ElasticModelSerializer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> .models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Blog <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> .search_indexes <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BlogIndex <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ElasticBlogSerializer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ElasticModelSerializer)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Meta</span></span></span><span class="hljs-class">:</span></span> model = Blog es_model = BlogIndex fields = (<span class="hljs-string"><span class="hljs-string">'pk'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>, <span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-string"><span class="hljs-string">'tags'</span></span>, <span class="hljs-string"><span class="hljs-string">'body'</span></span>, <span class="hljs-string"><span class="hljs-string">'is_published'</span></span>)</code> </pre> <br><p>  Now add a signal </p><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.db.models.signals <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pre_save, post_delete <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.dispatch <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> receiver <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> .serializers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Blog, ElasticBlogSerializer @receiver(pre_save, sender=Blog, dispatch_uid=<span class="hljs-string"><span class="hljs-string">"update_record"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_es_record</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sender, instance, **kwargs)</span></span></span><span class="hljs-function">:</span></span> obj = ElasticBlogSerializer(instance) obj.save() @receiver(post_delete, sender=Blog, dispatch_uid=<span class="hljs-string"><span class="hljs-string">"delete_record"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete_es_record</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sender, instance, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> obj = ElasticBlogSerializer(instance) obj.delete(ignore=<span class="hljs-number"><span class="hljs-number">404</span></span>)</code> </pre> <br><p>  After adding a signal, any changes in the model will be instantly made in elasticsearch </p><br><h2 id="sozdanie-view">  Create view </h2><br><p>  Let's start creating a view for searching and filtering. </p><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> elasticsearch <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Elasticsearch, RequestsHttpConnection <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rest_framework_elasticsearch <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> es_views, es_filters <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> .search_indexes <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BlogIndex <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BlogView</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(es_views.ListElasticAPIView)</span></span></span><span class="hljs-class">:</span></span> es_client = Elasticsearch(hosts=[<span class="hljs-string"><span class="hljs-string">'elasticsearch:9200/'</span></span>], connection_class=RequestsHttpConnection) es_model = BlogIndex es_filter_backends = ( es_filters.ElasticFieldsFilter, es_filters.ElasticSearchFilter ) es_filter_fields = ( es_filters.ESFieldFilter(<span class="hljs-string"><span class="hljs-string">'tag'</span></span>, <span class="hljs-string"><span class="hljs-string">'tags'</span></span>), ) es_search_fields = ( <span class="hljs-string"><span class="hljs-string">'tags'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>, )</code> </pre> <br><p>  That's all, search examples </p><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/example.com/blogs</span></span><span class="hljs-regexp"><span class="hljs-regexp">/api/list</span></span>?search=elasticsearch <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/example.com/blogs</span></span><span class="hljs-regexp"><span class="hljs-regexp">/api/list</span></span>?tag=opensource <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/example.com/blogs</span></span><span class="hljs-regexp"><span class="hljs-regexp">/api/list</span></span>?tag=opensource,aws</code> </pre> <br><p>  The full sample code is available on <a href="https://github.com/myarik/django-rest-elasticsearch/tree/master/example_project">github</a> .  I hope that the article will help you implement the search in your project. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/327694/">https://habr.com/ru/post/327694/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327684/index.html">How to raise your i2p-site (eepsite) on VDS (VPS) under Ubuntu (LAMP). Briefing for beginners</a></li>
<li><a href="../327686/index.html">Structure and execution model of .NET Core applications</a></li>
<li><a href="../327688/index.html">Structural Classification: Examples and Misconceptions</a></li>
<li><a href="../327690/index.html">Carousel on Vanilla.JS. Part 2</a></li>
<li><a href="../327692/index.html">Java, first cup</a></li>
<li><a href="../327698/index.html">How to share the environment for building and running a service in Docker today and how to do it tomorrow</a></li>
<li><a href="../327700/index.html">SVG sprite with webpack in one line</a></li>
<li><a href="../327702/index.html">So why all the same need Refresh tokens in OAuth?</a></li>
<li><a href="../327704/index.html">Computer vision on the example of an application for IKEA. Part 1</a></li>
<li><a href="../327706/index.html">Calculate the residence of passengers of the ship (with accuracy to the house)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>