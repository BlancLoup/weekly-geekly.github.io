<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Generation of dungeons in Diablo 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Diablo 1 is a classic 1996 roguelike in the hack and slash genre. It was one of the first successful attempts to introduce the broad masses to rogueli...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Generation of dungeons in Diablo 1</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7ac/daa/380/7acdaa38058e3058ff1a6ba9a7ca0ce2.png" alt="image"></div><br>  <a href="https://en.wikipedia.org/wiki/Diablo_(video_game)">Diablo 1</a> is a classic 1996 roguelike in the hack and slash genre.  It was one of the first successful attempts to introduce the broad masses to roguelike, which had previously had niche graphics in the form of ASCII art.  The game spawned several sequels and many imitations.  She is known for its dark, gloomy atmosphere, thickening as the player descends into the dungeons, located under the city of Tristram.  It was one of the first games for me with procedural card generation, and the possibility of generating such believable levels just shook me. <br><br>  Recently, I learned that due to the detection of various files with debugging symbols, several game fans took on the task of <a href="https://github.com/diasurgical/devilution">reverse-engineering the source code</a> to clean it up and figure out what the code written by the developers looked like.  So began my weekly excursion into the study of how lead developer David Brevik created these levels.  Perhaps because of this, the magic of the game for me partially collapsed, but I learned many techniques that will be useful for developers of similar games, so in this article I will share them. <br><br>  Thanks to David Brevik and the team of Blizard North for creating such an amazing game, as well as <a href="https://github.com/galaxyhaxz">galaxyhaxz</a> and the Devilution team for their amazing work in restoring the readable source code of the project. <br><a name="habracut"></a><br><h1>  Introduction </h1><br>  Diablo is a game of isometric tiles.  The game consists of 4 stages, each of which has 4 levels.  Stages of the game: Cathedral, Catacombs, Caves and Hell.  There are also several fixed levels, such as the city of Tristram, which I will not discuss in the article.  In Diablo there are separate procedures for generating levels for each of the 4 stages, so I will first talk about their features, and then consider separately the work of each of the stages. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I was only interested in how the levels were generated.  To learn about quests, monsters, etc.  I recommend reading <a href="http://www.lurkerlounge.com/diablo/jarulf/jarulf162.pdf">Jarulf's Guide To Diablo and Hellfire</a> , in which these aspects are described in detail. <br><br><h1>  General features </h1><br>  Although each stage has its own level generator, all of them have common features. <br><br><h2>  Dungeons and tiles </h2><br>  Each level of the game is generated to fill a grid of 40 x 40 tiles.  The X axis corresponds to the southeast, and the Y axis corresponds to the southwest. <br><br>  These tiles are used only for level generation tasks.  After creating a level, each tile is divided into 4 "dungeon fragments" that are rendered on the screen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aac/af2/49b/aacaf249b2356c104c27fb93a053b87a.png"></div><br>  This more detailed grid is used to determine passable tiles, and also provides more efficient reuse of graphics memory.  Earlier, I wrote about <a href="https://www.boristhebrave.com/2013/07/14/tileset-roundup/">tile sharing schemes</a> . <br><br>  This means that the standard Diablo map consists of more than a hundred tiles, many of which are minor variations of others to take into account all possible ways of combining them.  We will talk about this later. <br><br>  To my surprise, unlike other games in this series, dungeon maps are not made up of pre-created blocks.  Almost everything is created secretly with the help of algorithms. <br><br><h2>  Multistep process </h2><br>  Each dungeon generation procedure is divided into two stages.  "Pregeneration" does not deal with the choice of tiles at all.  It simply generates an array in which passable tiles are marked, tiles with doors, and some other high-level details.  At the second stage, this dungeon preparation is converted into an array of tiles, after which the generation is performed and changes are made taking into account these tiles. <br><br>  It should be incredibly convenient for the designer.  You can experiment with the floor plan completely regardless of the choice of tiles and style.  But in many cases they are interrelated, providing a more holistic sense of level. <br><br>  All stages of the creation of blanks dungeons begin with a level filled with a solid "solid", after which the individual parts of the level recursively turn into floor tiles.  I will tell you more about this below. <br><br><h2>  Finished Fragments </h2><br>  Finished fragments are pre-created level blocks that are simply inserted into a randomly generated level.  They are used for most of the game quests.  At each level there can be only one ready fragment, the location of which at each stage is selected separately. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fef/c34/5c5/fefc345c546569296a0e1059c6a2bbbb.gif"></div><br>  <i>Butcher's Den is one of the first finished fragments found in the game.</i> <br><br><h2>  Mini-sets </h2><br>  Mini-kits are another way to insert pre-created content into the level.  These are small pieces, usually about 3 √ó 3 in size, randomly inserted into the dungeon.  There is a simple pattern matching pattern, due to which they appear only in the ‚Äúright‚Äù places.  Often they are encoded with additional requirements, for example, mini-sets cannot be placed close to each other, they cannot be superimposed on the finished fragments, and so on.  Some mini-sets always search and replace, while others do so with a fixed probability. <br><br>  Mini-kits are used in Diablo for many different purposes.  They are used to place large objects from tiles, such as stairs, to correct combinations of tiles that do not connect well with each other, as well as to add tiles of random variability. <br><br><h2>  Themed rooms </h2><br>  Themed rooms are small spaces bounded by a wall and a door.  Typically, they are randomly located in some pre-defined objects.  For example, in libraries there is always a bookcase with two candles on each side, several random book holders and monsters.  Monster den contains monsters and a random item, and so on. <br><br>  At the athedral stage levels, the generator creates suitable rooms that are recognized by <a href="https://en.wikipedia.org/wiki/Flood_fill">shading</a> and are reused.  At other stages, the algorithm finds open spaces in which walls and a door are drawn to create rooms. <br><br>  Each type of themed room has specific size requirements and the stage at which it is generated. <br><br><h2>  Tile replacements </h2><br>  Some cards have a special adaptation of the tiles, but they all have a common feature: some tiles can be replaced with similar variations.  The most standard tiles (for example, floors and flat walls) have various variations that allow to reduce the level of monotony.  Tile replacements are never reused next to each other. <br><br><h2>  Pattern matching and ‚Äúfixes‚Äù </h2><br>  As stated above, mini-sets are used as a search and replace mechanism that corrects the generator‚Äôs shortcomings.  But at most stages there are procedures that detect and fix more specific problems.  I will not go into details, because they are just a bunch.  Suffice it to say that Diablo is quite buggy, and closer to release it became obvious that it would be easier to add recognition of specific problems than to eliminate their fundamental causes. <br><br>  One of the most common ‚Äúfixes‚Äù was ‚Äúlockout removal‚Äù (lockout): it checked if it was possible to go through the entire dungeon, and started the generation again if it was not. <br><br><h2>  Quests </h2><br>  Most of the quests were created with the help of ready-made fragments, but some of them used their own logic.  For example, Zhar the Mad generates themed library rooms, the entrance to Poisoned Water is generated by a mini-set, and Anvil of Fury has a specific level generation code.  I will not go into details, but the code is full of similar checks for quests. <br><br><h1>  Cathedral </h1><br>  The cathedral is probably the most iconic of the stages of Diablo.  It is characterized by long rows of Gothic arches, cramped rooms and many narrow spaces in the form of doorways.  Let's see how it was created. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68a/04e/c56/68a04ec568d05dac4c8f8c2040d68680.png" alt="image"></div><br><h2>  Dungeon Harvesting </h2><br>  The first thing the algorithm does is draw the "core" of the card.  He randomly selects up to three 10 √ó 10 rooms in predetermined positions along the central axis X or Y. A wide corridor connecting the rooms is also drawn along the axis.  If there is a ready-made fragment on the level, then it is always located in the center of one of these rooms.  These central dungeon rooms are marked as unsuitable for new walls, so that they always remain large open spaces. <br><br>  All other rooms are generated by the ‚Äúbudding‚Äù recursive technique in a function called <code>L5roomGen</code> , which is initiated in each of these rooms, and the choice of axis. <br><br><h3>  L5roomGen function </h3><br><ul><li>  It is transferred to the rectangle of the original room, from which you need to start budding, as well as the preferred axis. </li><li>  With probability 1/4, the preferred axis changes. </li><li>  A random size of a new room is selected, 2, 4 or 6 tiles on each side. </li><li>  For each side of the source room along the selected axis (i.e., SE / NC for X, SW / CB for Y): <br><ul><li>  The rectangle of the new room is aligned with the center of the edge of the source room. </li><li>  A check is made that nothing has been drawn before that and we have not reached the end of the map.  Walls require a single tile boundary. </li><li>  If the check is completed successfully, the room is drawn. </li></ul></li><li>  For each rendered room, <code>L5roomGen</code> is called <code>L5roomGen</code> , which transfers a new room and an axis opposite to that used previously. </li></ul><br>  In the end, this procedure begins with several rooms carved inside the "solid" tiles, and then repeatedly sticks new rectangles to cut new passable areas.  At this stage, all the "rooms" are open on the one hand, because each new room is located directly next to the previous one, without gaps to accommodate the walls. <br><br>  Then the generator counts the number of generated passable tiles.  If it is below the minimum threshold, which increases with each level, the dungeon is destroyed and an attempt to generate is performed anew. <br><br><h2>  Underground </h2><br>  So far, the algorithm has only tiles "hard" and gender.  We need to replace them with real wall tiles.  For this, Diablo uses the marching squares algorithm, which I <a href="https://www.boristhebrave.com/2018/04/15/marching-cubes-tutorial/">described in a previous article</a> . <br><br>  However, the game uses an unusual variation of it.  Taylset of the cathedral contains walls, but they are always located on the far edge of the tile.  Therefore, there is a tile with a wall on the northeast face, but there are no tiles with a wall on the southeast face.  To create walls on other sides, you need to find a ‚Äúhard‚Äù tile that has an additional wall that extends outward from the border of the tile.  It sounds strange, but in fact it is very convenient to sort the walls by depth. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b65/14b/193/b6514b19377666d0c7b06bf76002dd08.svg"></div><br>  To cope with this, Diablo on the marching cubes stage skips some walls: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/553/284/1c2/5532841c2542510b979e4dae6dee2183.svg"></div><br>  Additional walls are added later, at the ‚Äúpatch‚Äù stage.  I think this simple procedure has the most effect on the ‚Äústyle‚Äù of the cathedral.  Since the opposite walls are attached to solid tiles, in the case of two rooms separated by one wall tile, the opposite wall will simply not be created.  This means that the dividers between rooms are ‚Äúthinner‚Äù than can usually be obtained in the resolution at which marching squares are performed. <br><br>  After placing the main walls, the generator adds four free-standing columns to each of the central rooms and the colonnade of arches for the central corridor.  This allows you to give the cathedral a sense of being designed more thoughtfully than other levels, and also helps players navigate. <br><br>  Then the generator randomly adds separating walls.  Splitting walls always run straight along the axis from one wall to another.  They start from the corners, thanks to which the areas are beautifully divided into rooms.  In 25% of cases, the wall is a series of arches, in 25% of cases it is a series of arches with a grill that overlaps the entrance, and in all other cases it is a solid wall.  In the case of gratings and solid walls, a door or arch is randomly added somewhere along the dividing wall to make the space passable. <br><br>  The fill procedure detects potential themed rooms. <br><br>  Stairs are placed to connect with other levels.  If it is impossible to place them, the attempt to generate the dungeon begins anew. <br><br>  As for the placement of mini-sets, ‚Äúfixes‚Äù and replacements, I will not discuss them in detail.  My favorite is PANCREAS1 mini kit, which has a 1% chance of placing a pile of bloody flesh on the floor tile.  At the end, 5-10 lamp objects are placed to decorate the dungeon. <br><br><h1>  Catacombs </h1><br>  Unlike the Cathedral, seeming to be a projected building, the Catacombs feel much more natural.  They are characterized by square rooms connected to each other by a multitude of winding corridors.  In many places, instead of the doors are wide openings.  increasing the likelihood that a player will be surrounded by many enemies. <br><br>  To generate the catacombs, the most complex generation algorithm in the game was used.  I suspect that the lack of time has forced developers to use simpler solutions in the subsequent stages. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/086/22d/49e/08622d49e3f39ea4fca7d81a67393183.jpg" alt="image"></div><br><h2>  Dungeon Harvesting </h2><br>  The procedure for creating a blank dungeon for the catacombs is quite unique.  In all other stages there is a single boolean value indicating the presence or absence of the floor (plus a set of bits for additional details).  Catacombs store the dungeon preparation in the form of an ASCII card, almost like a classic roguelike.  And this is not particularly surprising, given the recognition of <a href="http://www.rpgfan.com/features/David_Brevik_Interview/index.html">David Brevik that he drew inspiration for Diablo from Angband</a> . <br><br>  The main room generator is again a recursive algorithm, but this time a recursive partition.  The <code>CreateRoom</code> function <code>CreateRoom</code> called for the entire dungeon area of ‚Äã‚Äã40 √ó 40 minus 1 border tile. <br><br><h3>  CreateRoom function </h3><br><ul><li>  The <code>CreateRoom</code> function <code>CreateRoom</code> passed a rectangle that indicates the area within which you want to generate rooms.  Functions are also passed details about the source room (initially null). </li><li>  If the area is too narrow, exit the function. </li><li>  A random size is selected for a room ranging from 4 to 9 tiles on each side, taking into account the maximum size of the area in which the room should be located. </li><li>  A random position is selected in the area to place the room. </li><li>  The room is drawn on an ASCII card.  In the picture with a <code>'.'</code>  Tiles of the floor are indicated, the symbol <code>'#'</code> is the surrounding wall, and the letters <code>'A'</code> , <code>'B'</code> , <code>'C'</code> and <code>'E'</code> are the four corners. </li><li>  If the room has an original room: <br><ul><li>  A random tile is selected at the nearest edges of the original and new rooms. </li><li>  This information is recorded in the list of corridors, which will be used later. </li></ul></li><li>  The remaining parts of the area, excluding the current room, are cut, creating four rectangles. </li><li>  The size of each rectangle is reduced by two tiles to create space between the rooms, and then the <code>CreateRoom</code> function is called recursively, the region for which this rectangle is used, and the created room as the source. </li></ul><br>  If there is a ready-made fragment on the map, then it will always be in the first room created by CreateRoom, and its dimensions are made such that it contains this fragment. <br><br>  After calls to <code>CreateRoom</code> an ASCII array is obtained, similar to the one shown below (thanks <a href="https://github.com/nomdenom">nomdenom</a> for extracting it from the code): <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span>#<span class="hljs-selector-id"><span class="hljs-selector-id">#B</span></span> #..# <span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span>###<span class="hljs-selector-id"><span class="hljs-selector-id">#B</span></span> #..# #....# #..# #....# <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>#<span class="hljs-selector-id"><span class="hljs-selector-id">#E</span></span> #....# <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>###<span class="hljs-selector-id"><span class="hljs-selector-id">#EA</span></span>####<span class="hljs-selector-id"><span class="hljs-selector-id">#B</span></span> #.....# #.....# <span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span>#######<span class="hljs-selector-id"><span class="hljs-selector-id">#B</span></span> #.....# #........# #.....# #........# <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>####<span class="hljs-selector-id"><span class="hljs-selector-id">#E</span></span> #........# <span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#B</span></span> #........# #.# #........# #.# #........# #.# #........# #.# #........# #.# <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>#######<span class="hljs-selector-id"><span class="hljs-selector-id">#E</span></span> #.# #.# <span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#BC</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#E</span></span> #.# <span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span>###<span class="hljs-selector-id"><span class="hljs-selector-id">#B</span></span> #.# #....# #.# #....# #.# #....# #.# <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>###<span class="hljs-selector-id"><span class="hljs-selector-id">#E</span></span> #.# #.# <span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span>####<span class="hljs-selector-id"><span class="hljs-selector-id">#BC</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#E</span></span> #.....# <span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span>##<span class="hljs-selector-id"><span class="hljs-selector-id">#B</span></span> #.....# #...# #.....# <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>##<span class="hljs-selector-id"><span class="hljs-selector-id">#E</span></span> #.....# <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>####<span class="hljs-selector-id"><span class="hljs-selector-id">#E</span></span></code> </pre><br>  In this case, the ‚Äúroot‚Äù room, originally created, was the lowest. <br><br>  Then, the previously collected information on corridors is applied.  A line is drawn between each recorded pair of points.  When it crosses a wall, a <code>'D'</code> written, and when it crosses a solid tile, <code>','</code> .  Corridors have a random width: 1, 2, or 3. Corner tiles are used to help navigate. <br><br>  If the doors are next door to another door, then they are skipped, and the corridors can overlap each other, which allows you to hide the simplicity of the generator. <br><br>  After recording all the corridors, the ASCII card is cleared.  Corner tiles become wall tiles, and tiles next to <code>','</code> also become walls.  Finally, the characters <code>','</code> are replaced by the characters <code>'.'</code>  .  So we get the dungeon plan shown below. <br><br><pre> <code class="hljs css">#### #..# ###### #..# #....# #..# #....# <span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>## #....# #.# <span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>#### #<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>#### #..# #.....# #..# ###.....# #<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>######## #<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>.....# #........# #.#.....# #........# ### #.#<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>#### #........# #.### #.##...# #........###<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>.# #.##...# #........##..#.# #.##...# #........##..#.# #.##...# #........##..#.# #.##...# #........##..#.# #.##...# ##<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>#######..#.# #.##...# #.......#..#.# #.##<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>## ###.....#..### #.# #.# ######<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>##.# #.# #.# #....#.# #.# #.# #...<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>.# #.# #.# #....###### #.# #.# #<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>####....## #.# #.# #...........# #.# #.# ####....##<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>####.# ### ######.....##.# #####<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>.....##.# #..<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>.#....<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>..# #####.#.....#### #########</code> </pre><br>  As you can see, this procedure can leave quite a lot of empty space on the map.  Therefore, the next step of the generator is ‚Äúfilling the voids‚Äù.  He searches for any adjacent wall segments to which additional floor rectangles can be glued.  Rectangles can be at least 5 √ó 5 and not more than 12 √ó 14. <br><br>  Void filling continues until a minimum of 700 tiles is reached, or the retry limit is reached.  If the generator failed to reach 700 tiles, the dungeon generation starts from scratch. <br><br>  This gives us the dungeon preparation shown below. <br><br><pre> <code class="hljs css"> ########## #........# ########### #........# #.........# #........# #.........# #........# #.........# #### #........# #.........# #..# #######..###.........# #..# #..............# #..# #..............# <span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>## #..............# #.# <span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>####.........# #<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>#### #..# ########### #.....# #..# ###.....# #<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>######## #<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>.....# #........# #.#.....# ########........# ### #.#<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>#### #...............# #.### #.##...# #...............###<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>.# #.##...# #...............##..#.# #.##...# #...............##..#.# #.##...# #...............##..#.# #.##...# #...............##..#.# #.##...# #......##<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>#######..#.# #.##...# #......# #.......#..#.# #.##<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>## #......# ###.....#..### #.# #.# #......########<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>##.# #.# #.# #.........# #....#.# #.# #.# #.........# #...<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>.# #.# #.# #.........# #....###### #.# #.# #.........# #<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>####....## #.# #.# #.........# #...........# #.# #.# #.........# ####....##<span class="hljs-selector-id"><span class="hljs-selector-id">#D</span></span>####.# ### #.........# ######.....##.# #.........# #####<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>.....##.# #.........# #..<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>.#....<span class="hljs-selector-class"><span class="hljs-selector-class">.D</span></span>..# ########### #####.#.....#### #########</code> </pre><br><h2>  Underground </h2><br>  Again, the catacombs are different from the standard formula levels.  Instead of the marching squares algorithm (which assigns tiles based on squares of 2 √ó 2 dungeon blanks), their own pattern matching procedure is used, which examines each of the 3 √ó 3 rectangles of the dungeon blanks and selects the corresponding tile for the dungeon.  Patterns determine what each dungeon blank tile should be: wall, floor, door, solid tile, or a combination of both.  I do not quite understand why. <br><br>  The rest of the function will seem familiar to you from the Cathedral.  Stairs are placed on the map up and down, the dungeon is checked for the possibility of complete passage, and various corrections are made.  As described in the ‚ÄúGeneral Features‚Äù section, rooms are inserted, and then a number of mini-sets and tile replacements are inserted. <br><br>  I think that mini-kits somehow affect the doorways, but they are pretty boring to read without tools, so I didn‚Äôt go deep into this topic. <br><br><h1>  Caves </h1><br>  Caves levels are filled with vast open spaces and lava rivers.  The walls of this area are rough and wavy.  The only rectangular components here are wooden platforms, which apparently appeared later than the caves themselves. <br><br>  This stage is one of the most beautiful in the game thanks to animated lava.  It is felt that it is very different from the previous levels made up of rooms.  Therefore, I was very surprised that the main part of the generation is modeled according to the principles of the Cathedral stage, and the cards are given a more ‚Äúcaveman‚Äù look using tricky tricks. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9b6/b2c/a41/9b6b2ca41b1a48ad9aebcd9be48ee162.jpg" alt="image"></div><br><h2>  Dungeon Harvesting </h2><br>  Creating a cave level begins with one random 2 √ó 2 room located somewhere near the center of the map.  Then the generator calls <code>DRLG_L3CreateBlock</code> procedure for each edge of this block. <br><br>  At drawing at this level of rectangles usual filling is not used.  The entrails are always solid, but each tile on the border has a 50% chance of becoming a floor, and otherwise remains solid. <br><br><h3>  DRLG_L3CreateBlock procedure </h3><br><ul><li>  This function gets the edge of the rectangle, i.e.  starting point, direction and length. </li><li>  Selects the size of the newly created block in the range of 3-4 on each side. </li><li>  A new block is randomly placed relative to the input edge. </li><li>  If there is not enough space to draw the block, then exit is performed. </li><li>  The block is drawn. </li><li>  With probability 1/4, exit is performed. </li><li>  <code>DRLG_L3CreateBlock</code> is called <code>DRLG_L3CreateBlock</code> for three edges, except for the one from which we came. </li></ul><br>  Although this procedure is similar to <code>L5roomGen</code> , using a much smaller block size and drawing rough edges gives it a much more organic look.  In addition, it does not include a border in 1 tile for walls, therefore, unlike previous generators, it can create loops. <br><br>  After creating a rough outline of a dungeon form, the generator applies erosion procedures: <br><br><ul><li>  First, he finds areas of 2 √ó 2 tiles with diagonally opposed solid tiles.  It is often difficult to work with such formations when performing marching squares, therefore one of the continuous tiles is randomly replaced by the floor. </li><li>  All solid single tiles, surrounded by 8 floor tiles, are replaced with a floor tile. </li><li>  All long and straight sections of the walls are randomly roughened by replacing 50% of the walls with floor tiles. </li><li>  Diagonals from solid tiles are eliminated again. </li></ul><br>  All these procedures add more floor tiles, so the map becomes more open. <br><br>  If it has less than 600 floor tiles, then the map is generated anew. <br><br><h2>  Underground </h2><br>  The dungeon blank is converted into tiles using marching squares.  Unlike Cathedral and Catacombs, tilesets are much more convenient here, and contain almost all the combinations required for marching squares.  There are no tiles for diagonally opposite walls, but they were eliminated in the blank phase, so they never appear. <br><br>  Then, as usual, there is a lot of mini-sets.  In the code there are several mini-sets that define a separate section of the walls and replace it with stalagmites and a floor, which increases the openness of the spaces. <br><br>  Lava lakes are added.  The algorithm searches for an adjacent section of the walls using a <a href="https://en.wikipedia.org/wiki/Flood_fill">fill</a> .  If he manages to find a section of walls / solid tiles less than 40 tiles, completely surrounded by floor tiles, then they are replaced by lava.  If the lake of lava is impossible to find, the generation of the dungeon begins anew. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/282/8a4/716/2828a4716c9319b5399e76ccb04b11a9.png"></div><br>  <i>A wall of 3 √ó 3 turns into a lake of lava</i> <br><br>  Then add some lava rivers.  The generator is making several attempts to paint a river starting from the lake of lava and ending in the wall.  The following requirements are made to the river: it must not cross itself, the river has a length of 7-100 tiles, and there must be a suitable place on it to house the bridge.  Bridge Tile ensures that the entire map remains passable.  If space is available, up to four rivers can be added to the map. <br><br>  Then themed rooms are placed.  At this stage, the walls of thematic rooms are wooden fences, through which it is impossible to pass, but you can watch.  Wooden fences are also used in the two following procedures.  The first one installs a fence on all the remaining sections of the walls that have fairly long straight sections.  The second draws a line of fences on the map, from one wall to the opposite, and then inserts a door.  Unlike the procedure for generating a cathedral, it does not look for angles to begin creating these walls. <br><br><h1>  Hell </h1><br>  Hell is the last stage of Diablo.  It focuses on the monsters, and level design goes into the background.  This stage has the smallest tileset of all, and most of it is used for huge stairs and pentagrams.  Hellish levels usually consist of several square rooms and have a symmetrical scheme. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/180/9a3/804/1809a38040316bde51bb114a03f10f99.png" alt="image"></div><br><h2>  Dungeon Harvesting </h2><br>  Hell generation begins with a random room of 5-6 tiles on each side (more if there is a ready-made fragment for the quest), and then the same recursive budding is used as in Cathedral.  However, generation is limited to an area of ‚Äã‚Äã20 √ó 20. <br><br>  A vertical and horizontal corridor is added, stretched to the edge of the 20 √ó 20 area. <br><br>  Then the dungeon blank is mirrored horizontally and vertically to get full size. <br><br><h2>  Underground </h2><br>  The dungeon's blank is again converted into tiles using marching squares.  Then, similarly to the creation of the Cathedral, walls are added, as in the Catacombs and Caves. <br><br><h1>  Conclusion </h1><br>  I really enjoyed reading this code.  Although there are obviously bugs in it, the names are assigned randomly, and some parts cannot be recreated in high-quality source code, it is clearly visible that this code has undergone a serious battle test and is full of clever ideas. <br><br>  Here are the most important lessons for me: <br><br><ul><li>  The devil is in the details: the individual components are not insanely complex, but in combination they give something remarkable.  I imagine how the developers pored over the improvement of quality, until the levels turned from simply good to stunning.  The number of tiles and the combinatorial complexity of tilesets is also very high - it is impossible to implement this without paying attention to how the elements are connected. </li><li>  Finding and replacing pattern matching is a very powerful tool with which you can implement many different effects.  It eliminates generational bugs, adds variability, inserts pre-created content, manages erosion and does much more. </li><li>  Dividing the generation of the dungeon on the patency map (preparation of the dungeon) and the generation of tiles is also a very convenient technique, both in terms of design and debugging. </li><li>  If you want to give different areas a different style, then a great solution is to create a separate algorithm.      ,         . </li><li>   ,      . </li></ul></div><p>Source: <a href="https://habr.com/ru/post/460038/">https://habr.com/ru/post/460038/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460022/index.html">PHP Digest 160 (July 1 - 15, 2019)</a></li>
<li><a href="../460028/index.html">The solution to the task with pwnable.kr 04 - flag. Packed executables</a></li>
<li><a href="../46003/index.html">The first three steps to optimizing LAMP</a></li>
<li><a href="../460030/index.html">Native development, React Native and Flutter: selection criteria</a></li>
<li><a href="../460036/index.html">Alice's B2B skill: from prototype to the first ruble saved</a></li>
<li><a href="../460040/index.html">We get USRN extracts from Rosreestr, bypassing api. Expectations in python, square millimeters in Rosreestr</a></li>
<li><a href="../460044/index.html">Oven heater temperature control, with timer on Arduino</a></li>
<li><a href="../460046/index.html">BDD Python Framework Comparison: Pros and Cons</a></li>
<li><a href="../460048/index.html">How we built vulnerability management</a></li>
<li><a href="../460052/index.html">Interoperability of Cisco Solutions at GosSOPKOY and FinCERT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>