<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Draw a wave of the .wav file</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I decided to devote myself to solving an exotic task - to draw a wave of a wave file, as audio and video editors do, using Python. As a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Draw a wave of the .wav file</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/ea66f451/2eb7f13d/183849f6/d333f9a0.png"><br>  Some time ago I decided to devote myself to solving an exotic task - to draw a wave of a wave file, as audio and video editors do, using Python.  As a result, I got a small script that copes with it.  So, the picture above is generated by him from the song ‚ÄúUnder Pressure‚Äù of the Queen group.  For comparison - the type of wave in the audio editor: <br><img src="https://habrastorage.org/storage/3811ce38/b2b2c125/5da0b7fe/3ff9bb98.png"><br>  To parse the sound, I used the <a href="http://numpy.scipy.org/">numpy</a> library, and for plotting the graph, <a href="http://matplotlib.sourceforge.net/">matplotlib</a> .  Under the cat, I lay out the basics of working with wav-files and the script algorithm. <br><a name="habracut"></a><br>  <b>UPD1:</b> thinning coefficient k is better to take approximately k = nframes / w / 32, picked empirically.  Updated pictures with a new coefficient. <br><br>  <a href="http://en.wikipedia.org/wiki/WAV">WAV</a> is a format for storing an uncompressed audio stream, widely used in the media industry.  Its peculiarity is that a fixed number of bits are allocated for amplitude coding.  This affects the size of the output file, but makes it very easy to read.  A typical wave file consists of a header, an audio stream body and a tail for additional information where audio editors can write their own metadata. <br><br>  The main parameters are extracted from the header part ‚Äî the number of channels, the bitrate, the number of frames ‚Äî based on which the audio stream is parsed.  The wave file stores 1 or 2 channels, each of which is encoded with 8, 16, 24 or 32 bits.  A sequence of bits describing the amplitude of a wave at a point in time is called a sample.  The sequence of samples for all channels at a certain moment is called a frame. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, <b>\ xe2 \ xff \ xe3 \ xf</b> is a frame of a 16-bit wav file.  Hence, <b>\ xe2 \ xff</b> is the sample of the first (left) channel, and <b>\ xe3 \ xf</b> is the second (right) channel.  Samples are signed integer numbers (except for files with samples of 8 bits, unsigned numbers). <br><br>  The rich Python library has a <a href="http://docs.python.org/library/wave.html">wave</a> module designed for parsing wav files.  It allows you to get the main characteristics of the sound and read it on separate frames.  This is where its capabilities end, and you will have to parse the audio stream yourself. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> wave wav = wave.open(<span class="hljs-string"><span class="hljs-string">"music.wav"</span></span>, mode=<span class="hljs-string"><span class="hljs-string">"r"</span></span>) (nchannels, sampwidth, framerate, nframes, comptype, compname) = wav.getparams() content = wav.readframes(nframes)</code> </pre> <br>  With these lines, we create an object to read the wav file (if the ‚Äúr‚Äù parameter is omitted, then an object will be created for writing that does not suit us).  The getparams () method returns a tuple of basic file parameters (in order): the number of channels, the number of bytes per sample, the number of times per second, the total number of frames, the type of compression, the name of the type of compression.  I carried them all into separate variables so as not to refer to the fields of the object each time. <br><br>  The readframes () method reads the specified number of frames relative to the internal pointer of the object and increments it.  In this case, we at one time read all the frames in a single byte string into the content variable. <br><br>  Now we need to parse this line.  The sampwidth parameter determines how many bytes are spent on encoding a single sample: <br><ul><li>  1 = 8 bits, unsigned integer (0-255), </li><li>  2 = 16 bits, signed integer (-32768-32767) </li><li>  4 = 32 bits, signed long integer (-2147483648-2147483647) </li></ul><br>  Parsing is as follows: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np types = { <span class="hljs-number"><span class="hljs-number">1</span></span>: np.int8, <span class="hljs-number"><span class="hljs-number">2</span></span>: np.int16, <span class="hljs-number"><span class="hljs-number">4</span></span>: np.int32 } samples = np.fromstring(content, dtype=types[sampwidth])</code> </pre><br>  This is where the numpy library is involved.  Its main purpose is mathematical operations with arrays and matrices.  Numpy operates with its own data types.  The fromstring () function creates a one-dimensional array from a byte string, and the dtype parameter determines how the elements of the array will be interpreted.  In our example, the data type is taken from the ‚Äútypes‚Äù dictionary, in which the sample sizes and numpy data types are compared. <br><br>  Now we have an array of audio stream samples.  If there is one channel in it, the whole array will represent it, if two (or several), then you need to ‚Äúthin out‚Äù the array by selecting for each channel the kadzh n-th element: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(nchannels): channel = samples[n::nchannels]</code> </pre><br>  In this loop, each audio channel is selected in the channel array using a slice of the form [offset :: n], where offset is the index of the first element and n is the sampling step.  But the channel array contains a huge number of points, and the output of the graph for a 3-minute file will require a huge investment of memory and time.  Let's enter some additional variables in the code: <br><pre> <code class="python hljs">duration = nframes / framerate w, h = <span class="hljs-number"><span class="hljs-number">800</span></span>, <span class="hljs-number"><span class="hljs-number">300</span></span> DPI = <span class="hljs-number"><span class="hljs-number">72</span></span> peak = <span class="hljs-number"><span class="hljs-number">256</span></span> ** sampwidth / <span class="hljs-number"><span class="hljs-number">2</span></span> k = nframes/w/<span class="hljs-number"><span class="hljs-number">32</span></span></code> </pre><br><br>  duration is the duration of the stream in seconds, w and h are the width and height of the output image, DPI is an arbitrary value needed to convert pixels to inches, peak is the peak value of the sample amplitude, k is the channel thinning factor depending on the image width;  matched empirically. <br><br>  Adjust the display of the graph: <br><pre> <code class="python hljs">plt.figure(<span class="hljs-number"><span class="hljs-number">1</span></span>, figsize=(float(w)/DPI, float(h)/DPI), dpi=DPI) plt.subplots_adjust(wspace=<span class="hljs-number"><span class="hljs-number">0</span></span>, hspace=<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br>  Now the cycle with the output channels will look like this: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(nchannels): channel = samples[n::nchannels] channel = channel[<span class="hljs-number"><span class="hljs-number">0</span></span>::k] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nchannels == <span class="hljs-number"><span class="hljs-number">1</span></span>: channel = channel - peak axes = plt.subplot(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, n+<span class="hljs-number"><span class="hljs-number">1</span></span>, axisbg=<span class="hljs-string"><span class="hljs-string">"k"</span></span>) axes.plot(channel, <span class="hljs-string"><span class="hljs-string">"g"</span></span>) axes.yaxis.set_major_formatter(ticker.FuncFormatter(format_db)) plt.grid(<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, color=<span class="hljs-string"><span class="hljs-string">"w"</span></span>) axes.xaxis.set_major_formatter(ticker.NullFormatter())</code> </pre><br>  The loop checks for the number of channels.  As I said, the 8-bit sound is stored in unsigned integers, so it needs to be normalized, taking away half of the amplitude from each sample. <br><br>  Finally, set the format of the bottom axis <br><pre> <code class="python hljs">axes.xaxis.set_major_formatter(ticker.FuncFormatter(format_time))</code> </pre><br>  Let's save the graph in the picture and show it: <br><pre> <code class="python hljs">plt.savefig(<span class="hljs-string"><span class="hljs-string">"wave"</span></span>, dpi=DPI) plt.show()</code> </pre><br><br>  format_time and format_db are functions for formatting the values ‚Äã‚Äãof the scales of the axes of the abscissas and ordinates. <br><br>  format_time formats the time by sample number: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">format_time</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x, pos=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> duration, nframes, k progress = int(x / float(nframes) * duration * k) mins, secs = divmod(progress, <span class="hljs-number"><span class="hljs-number">60</span></span>) hours, mins = divmod(mins, <span class="hljs-number"><span class="hljs-number">60</span></span>) out = <span class="hljs-string"><span class="hljs-string">"%d:%02d"</span></span> % (mins, secs) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hours &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: out = <span class="hljs-string"><span class="hljs-string">"%d:"</span></span> % hours <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> out</code> </pre><br>  The format_db function formats the sound volume according to its amplitude: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">format_db</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x, pos=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pos == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> peak <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"-inf"</span></span> db = <span class="hljs-number"><span class="hljs-number">20</span></span> * math.log10(abs(x) / float(peak)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> int(db)</code> </pre><br>  The whole script: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> wave <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> matplotlib.pyplot <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> plt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> matplotlib.ticker <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ticker <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> math types = { <span class="hljs-number"><span class="hljs-number">1</span></span>: np.int8, <span class="hljs-number"><span class="hljs-number">2</span></span>: np.int16, <span class="hljs-number"><span class="hljs-number">4</span></span>: np.int32 } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">format_time</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x, pos=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> duration, nframes, k progress = int(x / float(nframes) * duration * k) mins, secs = divmod(progress, <span class="hljs-number"><span class="hljs-number">60</span></span>) hours, mins = divmod(mins, <span class="hljs-number"><span class="hljs-number">60</span></span>) out = <span class="hljs-string"><span class="hljs-string">"%d:%02d"</span></span> % (mins, secs) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hours &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: out = <span class="hljs-string"><span class="hljs-string">"%d:"</span></span> % hours <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> out <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">format_db</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x, pos=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pos == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> peak <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"-inf"</span></span> db = <span class="hljs-number"><span class="hljs-number">20</span></span> * math.log10(abs(x) / float(peak)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> int(db) wav = wave.open(<span class="hljs-string"><span class="hljs-string">"music.wav"</span></span>, mode=<span class="hljs-string"><span class="hljs-string">"r"</span></span>) (nchannels, sampwidth, framerate, nframes, comptype, compname) = wav.getparams() duration = nframes / framerate w, h = <span class="hljs-number"><span class="hljs-number">800</span></span>, <span class="hljs-number"><span class="hljs-number">300</span></span> k = nframes/w/<span class="hljs-number"><span class="hljs-number">32</span></span> DPI = <span class="hljs-number"><span class="hljs-number">72</span></span> peak = <span class="hljs-number"><span class="hljs-number">256</span></span> ** sampwidth / <span class="hljs-number"><span class="hljs-number">2</span></span> content = wav.readframes(nframes) samples = np.fromstring(content, dtype=types[sampwidth]) plt.figure(<span class="hljs-number"><span class="hljs-number">1</span></span>, figsize=(float(w)/DPI, float(h)/DPI), dpi=DPI) plt.subplots_adjust(wspace=<span class="hljs-number"><span class="hljs-number">0</span></span>, hspace=<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(nchannels): channel = samples[n::nchannels] channel = channel[<span class="hljs-number"><span class="hljs-number">0</span></span>::k] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nchannels == <span class="hljs-number"><span class="hljs-number">1</span></span>: channel = channel - peak axes = plt.subplot(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, n+<span class="hljs-number"><span class="hljs-number">1</span></span>, axisbg=<span class="hljs-string"><span class="hljs-string">"k"</span></span>) axes.plot(channel, <span class="hljs-string"><span class="hljs-string">"g"</span></span>) axes.yaxis.set_major_formatter(ticker.FuncFormatter(format_db)) plt.grid(<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, color=<span class="hljs-string"><span class="hljs-string">"w"</span></span>) axes.xaxis.set_major_formatter(ticker.NullFormatter()) axes.xaxis.set_major_formatter(ticker.FuncFormatter(format_time)) plt.savefig(<span class="hljs-string"><span class="hljs-string">"wave"</span></span>, dpi=DPI) plt.show()</code> </pre><br>  More examples: <br><img src="https://habrastorage.org/storage/8a4e7133/6ee242a5/bc6e1260/17138752.png"><br><img src="https://habrastorage.org/storage/48fc4ac1/68394b79/384e234a/db972cd0.png"></div><p>Source: <a href="https://habr.com/ru/post/113239/">https://habr.com/ru/post/113239/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../113233/index.html">NDIS. Introduction</a></li>
<li><a href="../113234/index.html">Brainfuck interpreter using normal Markov algorithms</a></li>
<li><a href="../113236/index.html">Small testing of two libraries for working with ZIP archives (C # language)</a></li>
<li><a href="../113237/index.html">Counting objects in the image</a></li>
<li><a href="../113238/index.html">Bumburum number</a></li>
<li><a href="../113240/index.html">Anonymous leaders may soon be arrested</a></li>
<li><a href="../113241/index.html">MocoSpace has expressed interest in acquiring MySpace</a></li>
<li><a href="../113243/index.html">google translate script</a></li>
<li><a href="../113244/index.html">The film, shot on Canon 7D, bought for $ 4 million</a></li>
<li><a href="../113245/index.html">Neural networks and character recognition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>