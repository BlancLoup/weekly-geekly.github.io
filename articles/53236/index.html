<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How can you reduce the consumption of RAM on the VPS by 2 times, without changing anything in the program settings</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Took a VPS, built on OpenVZ. I put Debian Lenny there and all sorts of programs (the usual LAMP, in fact). From the point of view of resource consumpt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How can you reduce the consumption of RAM on the VPS by 2 times, without changing anything in the program settings</h1><div class="post__text post__text-html js-mediator-article"> Took a VPS, built on OpenVZ.  I put Debian Lenny there and all sorts of programs (the usual LAMP, in fact).  From the point of view of resource consumption, I almost didn‚Äôt set anything up, about 200M of occupied RAM came out (right after the start). <br>  Posted by <code>ulimit -s 1024</code> in /etc/init.d/rc closer to the top.  Rebooted.  Memory consumption on VPS more than doubled, it was about 100M. <br><br>  If you have a VPS on Xen or similar, then you do not have a rake, with whom I fought here.  If on OpenVZ (Virtuozzo) and comrades, you probably have the same rake on a VPS. <br><br>  In the article - why and how it works. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h4>  Openvz vs xen </h4><br>  The difference between OpenVZ and Xen, which interests us here: <b>OpenVZ is limited to virtual memory</b> .  Ie, for example, the tariffs of the form ‚Äú256 + 256 burstable‚Äù mean that max is available to us.  256M is virtual memory (and 512M virtual on holidays). <br><br>  Many programs allocate themselves virtual memory "in reserve", because  during normal operation (or virtualization through Xen and friends), it can be allocated as many as you want (physically accessible) without any consequences.  This is one of the reasons why VPS on Xen cost more than the same VPS on OpenVZ - they really provide more resources. <br><br><h4>  But that is not all </h4><br>  <b>For each running thread in virtual memory, space is allocated for the stack</b> .  So, in debian lenny, for example, by default this place is = 10M.  We take some apache with mpm_worker (which creates a bunch of threads), run under OpenVZ - hundreds of megabytes of memory are spent. <br><br>  10 megabytes per stack is a lot.  And it is set so much, because  If linux is started normally, this memory is ‚Äúfree‚Äù - you could install at least 100M without negative effects (unless programs with recursion bugs would be agonizing longer).  Typically, the program requires several times less, even with the account "in reserve". <br><br><h4>  Reduce default stack size </h4><br>  The server is not a public computer; programs that will be launched there are known in advance.  These programs usually do the same thing all the time.  Somehow I don‚Äôt see the reasons for the abrupt changes in the size of the memory stack they need. <br><br>  To reduce the default stack size, use the <code>ulimit -s &lt;     &gt;</code> command.  The parameter changes for programs launched from the current shell (well, hierarchically, too, essno).  We start this thing when the system boots (inside the script that starts the daemons) - that's all. <br><br>  There is an obvious warning - if you set a limit too low, something complicated (with a bunch of recursive code or an incomprehensible-why-sly work with the stack) can start to fall.  Caution does not hurt.  You are warned.  Make backups.  But 10M under the stack is, in most cases, a lot) <br><br>  It seemed to me the optimal size of 2M.  Extremes and experimenters can reduce further (I tried it, everything worked fine with me at 32K), but there the gain is already small, and the risk increases, there is little sense in general.  Try it though. <br><br>  In principle, running ulimit for all processes is pretty rough.  For more fine-tuning, you can (zadolbatsya) edit the launch scripts of individual demons.  Also, for some programs, it is possible to change memory in configs, which they will allocate to the thread thread, for example, apache, ThreadStackSize directive for mpm_worker.  As a matter of fact, my Apache was set up in worker mode (php via fastcgi, if that), and stack memory was limited using ThreadStackSize without ulimit (the decrease was 2 times due to mysql with InnoDB, fastcgi php processes, mail servers and any trifles). <br><br>  To test this whole affair, if you are afraid to go straight into /etc/init.d/rc, you can <br>  1) to see how much a process takes in memory, <br>  2) in the shell enter <code>ulimit -s &lt;-,  &gt;</code> , <br>  3) restart the process (something like <code>/etc/init.d/mysql restart</code> ) <br>  4) look again, how much it takes now, and check that everything works <br><br><h4>  Thoughts </h4><br>  As a result, we have: OpenVZ users are paying a lot of RAM for the possibility of sometime (devils when) run a rare tricky program, whereas for all the rest it costs nothing.  Therefore, we act as it seems to me logical: when virtualizing OpenVZ, we reduce the max.  stack depth to 1-2M.  On all HP-UX (which I, however, had never seen), for example, 64K, and do not cry.  And from reducing the max.  stack depth is released a bunch of RAM for more important pieces. <br><br>  Criticism and comments are welcome. </div><p>Source: <a href="https://habr.com/ru/post/53236/">https://habr.com/ru/post/53236/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../53229/index.html">"My personal startup"</a></li>
<li><a href="../53231/index.html">Avira Antivir</a></li>
<li><a href="../53232/index.html">Why is Russia tolerated and not lived?</a></li>
<li><a href="../53234/index.html">Convenient interface Need for Speed ‚Äã‚ÄãWorld Online</a></li>
<li><a href="../53235/index.html">Two-legged robot in theory</a></li>
<li><a href="../53239/index.html">Angels</a></li>
<li><a href="../53240/index.html">So much for the year of youth. Innovations in Russia</a></li>
<li><a href="../53241/index.html">vim, and how to make it a full IDE.</a></li>
<li><a href="../53243/index.html">Interesting‚Ä¶</a></li>
<li><a href="../53248/index.html">Description to the film library (theory, perhaps someone will be interested and implementation)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>