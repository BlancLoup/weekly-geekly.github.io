<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AdBlockBlock - bypass ad blockers. Method 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Doing something that violates the sacred will of the local gentlemen to the content, which only they want to see around themselves is, of course, a un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AdBlockBlock - bypass ad blockers. Method 1</h1><div class="post__text post__text-html js-mediator-article">  Doing something that violates the sacred will of the local gentlemen to the content, which only they want to see around themselves is, of course, a ungrateful and karmically dangerous thing.  But the arms race between advertising blockers and advertising systems cannot be avoided, so we need to talk about it.  Now, when the total volume of cut traffic revolves around 1% - everything is somewhat vyalenko, but there are already looking around site owners who receive less than 30% of the money from advertising.  Advertising networks are beginning to communicate with each other, exchange specifications, there is already some Israeli startup on this topic - I think it is tempting to increase the income immediately and by interest with minimal effort.  In the Russian segment, everything is still costing with admonitory ads like ‚ÄúYou have disabled advertising - this prevents us from developing‚Äù or simply ignoring the fact of the existence of such users.  I must say, <b>let it all remain so</b> . <br><br>  Here, only in the mode of minimal proof of performance - we will bypass the most common type of ad blockers - by the URL pattern.  The method should support: <br><br><ul><li>  storing cookie advertising systems on the user side </li><li>  transfer no less information about the user than the browser: User-Agent, IP </li><li>  require minimal customization of most standard promotional tags </li><li>  to be easily connected and changeable in cases when someone was not lazy and nevertheless added a custom rule that has fallen into the mainstream </li></ul> <br>  To achieve the result, we will mask all URLs of advertising networks through a kind of proxy between the publisher server and the advertiser. <a name="habracut"></a>  The method is not the cheapest in terms of resources, it is also potentially dangerous for advertisers: the source of fraud cannot be done without assessing the quality of traffic through clicks or conversions, and for publishers, if Google is banned, the entire site will be banned.  Accordingly, it requires a certain threshold of trust between them, but these are all separate issues.  Yes, all coincidences or references are random, took what came to hand. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, we want all the site calls for those who have detected ad blockers, like <br> <code><a href="http://ads/"></a> ads.*.ru/228129/prepareCode?pp=g&amp;ps=bugf&amp;p2=ezfl&amp;pct=a&amp;plp=a&amp;pli=a&amp;pop=a' <br></code> <br><br>  Replace with local, indistinguishable from the content of the site, for example <br><br> <code>/meduza/2015/09/28/shapitorbFgFQ4Y7_Z3jaPSRix09Pn5VyrnV5Pcki64JcXvjIyzlgYXerh3yMMgY8DB5vleYAkS_gbRiHDSyQHU7QscAd38-1tKyYnnLjLSlpHq6aJ4sEo <br></code> <br><br>  <b>For clarity, I'll start with what will be needed.</b> <br><br>  1. Take an advertising tag, encrypt the first entry point (the one that is in the ad tag itself) manually <br><br><pre> <code class="javascript hljs">&lt;!-- : <span class="hljs-number"><span class="hljs-number">990</span></span>x90js--&gt; <span class="xml"><span class="hljs-comment"><span class="xml"><span class="hljs-comment">&lt;!--: &lt; &gt;--&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"><span class="xml"><span class="xml"> </span></span><span class="hljs-comment"><span class="xml"><span class="xml"><span class="hljs-comment">&lt;!-- (function(){ //var link = 'http://ads.XXXXXX.ru/228129/prepareCode?pp=g&amp;ps=bugf&amp;p2=ezfl&amp;pct=a&amp;plp=a&amp;pli=a&amp;pop=a', var link = '/meduza/2015/09/28/shapitorbFgFQ4Y7_Z3jaPSRix09Pn5VyrnV5Pcki64JcXvjIyzlgYXerh3yMMgY8DB5vleYAkS_gbRiHDSyQHU7QscAd38-1tKyYnnLjLSlpHq6aJ4sEo', params = 'phone'; new AXXXBanner(link, params).createBanner(); })(); //--&gt;</span></span></span></span><span class="xml"><span class="xml"> </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br>  2. Slightly expand the server configuration (in this case, nginx) by starting to process such URLs in a special mode and returning the processing of the request at the mercy of the script: <br><br><pre> <code class="nginx hljs"> <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /meduza/<span class="hljs-number"><span class="hljs-number">2015</span></span>/<span class="hljs-number"><span class="hljs-number">09</span></span>/<span class="hljs-number"><span class="hljs-number">28</span></span>/shapito { <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$prefix</span></span> <span class="hljs-string"><span class="hljs-string">"http://localhost:9090/meduza/2015/09/28/shapito"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">rewrite</span></span> shapito(.*)$ /adbb.php?query=<span class="hljs-variable"><span class="hljs-variable">$1</span></span>&amp;url_mask_prefix=<span class="hljs-variable"><span class="hljs-variable">$prefix</span></span>&amp;ua=<span class="hljs-variable"><span class="hljs-variable">$http_user_agent</span></span>&amp;remote_addr=<span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; }</code> </pre><br>  All - after this ad will be shown. <br><br>  <b>How it works.</b> <br><br><div class="spoiler">  <b class="spoiler_title">Retreat, choice of means</b> <div class="spoiler_text">  I wanted to write all the logic on Lua, but I was too lazy to rebuild nginx and, since PHP is potentially closer to the site owners, I used it.  Trivial code was written for proof-of-concept, in two pages, can be reproduced in any language - attached at the end.  There is a dependency on mbcrypt and curl. <br></div></div><br>  <b>Work algorithm.</b> <br><br>  1. Decrypt the passed string with the configuration key, receiving the target URL <br><br>  2. Take a domain from there, encrypt it <br><br> <code>ads.XXXXXX.ru -&gt; pPM9l7raWppVawqO <br></code> <br><br>  3. For this key, look in the cookies sent to us, find the value of the form <br><br> <code>niFJ2HLxzm27hCLnQUvcmLx62sEU-worI4tjmSAfqxNSMR6DSZ279lampNh_CN2jlu7FXaVk0WRVt-HMxy4vdm0uEncngawC6RvcKBwRXrT0wIi0icl4BvSXPJzH99C_5-mTmneEISfz <br></code> <br><br>  And we will decrypt it, having received the original cookies, once sent to us from this server for installation. <br><br>  4. If the URL contains click markers, do nothing more - just give 302 redirect and exit. <br><br>  5. Otherwise, we make a request to the target URL, passing the cookie, the source user User-Agent and the real IP in the X-Forwarded-For header. <br><br>  6. Analyze the response from the server: <br><br>  5.1.  If a Set-Cookie was sent - repack them (the key is an encrypted domain, the value is an encrypted Set-Cookie from the call results), and install them, you get something like <br><br> <code>Set-Cookie:oI5upmClXJaq6DY4QWT5g5ZsvQ=niFJ3pLNsqSh0x19ux1HB-3XQiMb3XDhuJC5Byrefm_xOIDJBlZ2FL5q2zvyVtPcNOimtTk-lfoY; expires=Mon, 28-Dec-2015 08:23:57 GMT; Max-Age=7776000 <br></code> <br><br>  5.2.  If the content-type does not contain text or javascript - for example, images, gif-pixels - we give the content as-is, adjusting the caching to taste (but it is better not necessary).  And we leave <br><br>  5.3.  For all other content-types, we search for the URL in the response body by a pattern, encrypt each one, and using the prefix transmitted from the server, we replace the calls with masked ones, that is, places like <br><br><pre> <code class="javascript hljs">object_1986381203 += <span class="hljs-string"><span class="hljs-string">'&lt;a href="http://ads.XXXXX.ru/228129/goLink?pr=gleurtb&amp;p5=dcxnh&amp;p1=bohgi&amp;p2=ezfl" target="_blank"&gt;&lt;img src="http://content.XXXXX.ru/150924/XXXX/507850/1421973.jpg" width="990" height="90" alt="" border=0&gt;&lt;/a&gt;'</span></span>;</code> </pre><br>  Will be given away like this: <br><br><pre> <code class="javascript hljs">object_1986381203 += <span class="hljs-string"><span class="hljs-string">'&lt;a href="/meduza/2015/09/28/shapitorbFgFQ4Y7_Z3jaPSRix09Pn5VyrnV5P" target="_blank"&gt;&lt;img src="/meduza/2015/09/28/shapitorbFgFQ4Y7_Z3jaPSRix09Pn5VyrnV5Pcki64JcXvjIyzlgYXerh3yMMgY8DB5vleYA" width="990" height="90" alt="" border=0&gt;&lt;/a&gt;'</span></span>;</code> </pre><br>  We give the changed content and exit. <br><br>  6. The browser itself will make the necessary calls, for each of which everything will be completed with p.1 <br><br>  <b>Script configuration section</b> <br><br><pre> <code class="php hljs">$CONF = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'mask_urls'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'prefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/meduza/2015/09/28/shapito'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//default, will be overriden by `url_mask_prefix` 'url_search_patterns' =&gt; array( '@https?://[^\\\'\"\n\r\?]+@i', ), ), 'redirect_if_contains' =&gt; array( '/click', '/reference', '/link', '/goLink' ), 'encrypt' =&gt; array ( 'iv' =&gt; '2uV17Dil', 'key' =&gt; 'JbaSyaXwD46qIlKdt8mJ4', 'cipher' =&gt; MCRYPT_GOST, 'mode' =&gt; MCRYPT_MODE_CFB ), 'cookie' =&gt; array( 'expire' =&gt; 90*24*60*60, ), 'url_call' =&gt; array(), );</span></span></code> </pre><br>  <i>Once again, this is a concept - you <b>cannot</b> use it in production!</i>  <i>He <b>will make</b> an anonymous proxy from your server.</i> <br><br><div class="spoiler">  <b class="spoiler_title">adbb.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $CONF = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'mask_urls'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'prefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/meduza/2015/09/28/shapito'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//default could be taken from `url_ 'url_search_patterns' =&gt; array( '@https?://[^\\\'\"\n\r\?]+@i', ), ), 'redirect_if_contains' =&gt; array( '/click', '/reference', '/link', '/goLink' ), 'encrypt' =&gt; array ( 'iv' =&gt; '2uV17Dil', 'key' =&gt; 'JbaSyaXwD46qIlKdt8mJ4', 'cipher' =&gt; MCRYPT_GOST, 'mode' =&gt; MCRYPT_MODE_CFB ), 'cookie' =&gt; array( 'expire' =&gt; 90*24*60*60, ), 'url_call' =&gt; array(), ); require_once __DIR__."/adbb_functions.php"; if ( !array_key_exists('query', $_REQUEST) or !$query = $_REQUEST['query']) return; adbb_debug_log('Request params', $_REQUEST); $extra_query = ''; if (($delpos = strpos($query, '&amp;')) !== false) { adbb_debug_log('Extra parameters passed, getting encypted part only. @ position ', $delpos); $extra_query = substr($query, $delpos); adbb_debug_log('Extra query ', $extra_query); $query = substr($query, 0, $delpos); adbb_debug_log('Encrypted query after cut ', $query); } adbb_debug_log('We should have successfully decrypted url with the key for all further logic, decrypting...'); if ( !$url = adbb_decrypt($query, $CONF['encrypt']) ) { adbb_debug_log('Failed. Exiting'); return; } adbb_debug_log('Decrypted URL', $url); if (array_key_exists('url_mask_prefix', $_REQUEST)) { adbb_debug_log('Overriding initial url_mask_prefix ['.$CONF['mask_urls']['prefix'].'] to', $_REQUEST['url_mask_prefix']); $CONF['mask_urls']['prefix'] = $_REQUEST['url_mask_prefix']; } $extra_args = $_REQUEST; unset($extra_args['query'], $extra_args['ua'], $extra_args['remote_addr'], $extra_args['url_mask_prefix']); $url_to_call = $url . (strpos($url, '?') === false ? '?' : '&amp;' ) . http_build_query($extra_args).'&amp;'.$extra_query; adbb_debug_log('Looking for cookies to send to remote host...'); $domain_cookies = ''; $parse = parse_url($url_to_call); $domain_to_call = $parse['host']; if ($domain_to_call) { $domain_cookie_key = adbb_encrypt($domain_to_call, $CONF['encrypt']); adbb_debug_log('Will look for cookies for domain ['.$domain_to_call.'], key', $domain_cookie_key); if (isset($_COOKIE) and array_key_exists($domain_cookie_key, $_COOKIE) and $_COOKIE[$domain_cookie_key]) { adbb_debug_log('Found something, will try to decrypt cookie value ', $_COOKIE[$domain_cookie_key]); if ($json_encoded_cookies = adbb_decrypt($_COOKIE[$domain_cookie_key], $CONF['encrypt']) and $cookies = @json_decode($json_encoded_cookies) ) { adbb_debug_log('Going to send cookies decrypted', $cookies); $domain_cookies = implode('; ', $cookies); } } } adbb_debug_log('Checking if redirect is needed...'); foreach ($CONF['redirect_if_contains'] as $needle) { if (strpos($url_to_call, $needle) !== false ) { $url_to_call .= '&amp;cookies='.urlencode($domain_cookies); adbb_debug_log('URL contains '.$needle.' going to redirect to ', $url_to_call); header('Location: '.$url_to_call); exit; } } adbb_debug_log('About to call remote URL ', $url_to_call); adbb_debug_log('With User-Agent ', $_REQUEST['ua']); adbb_debug_log('With X-Forwarded-For ', $_REQUEST['remote_addr']); adbb_debug_log('With Cookie ', $domain_cookies); $result = adbb_call_url( $url_to_call, '', $_REQUEST['ua'], array( 'X-Forwarded-For' =&gt; $_REQUEST['remote_addr'], 'Cookie' =&gt; $domain_cookies ) ); if ($result) { adbb_debug_log('Call successfull.'); $info = $result['info']; $header = $result['header']; $content = $result['content']; adbb_debug_log('Remote response info', $info); adbb_debug_log('Remote response headers', $info); $parse = parse_url($url); $domain = $parse['host']; if (array_key_exists('Set-Cookie', $header[count($header)-1])) { adbb_debug_log('Found Set-Cookie in response, taking last one'); $domain_set_cookies = $header[count($header)-1]['Set-Cookie']; $domain_cookies = adbb_translate_cookie_values($domain_set_cookies); adbb_debug_log('Translated domain cookies', $domain_cookies); $json_encoded_cookies = json_encode($domain_cookies); adbb_debug_log('Json encoded cookies', $json_encoded_cookies); $encrypted_cookies_domain = adbb_encrypt( $domain, $CONF['encrypt'] ) ; $encrypted_cookies_values = adbb_encrypt( $json_encoded_cookies, $CONF['encrypt'] ) ; adbb_debug_log('About to set encrypted cookie for domain ['.$domain.'] as ['.$encrypted_cookies_domain.'] with value ', $encrypted_cookies_values); setcookie($encrypted_cookies_domain, $encrypted_cookies_values, time()+$CONF['cookie']['expire']); } if (strpos($info['content_type'], 'text') === false and strpos($info['content_type'], 'javascript') === false ) { adbb_debug_log('Non-text content type '.$info['content_type'].', passing as is. Cache headers not implemented'); header('Content-Type: '.$info['content_type']); echo $content; } else { adbb_debug_log('Initial content in remote response', $content); $new_content = adbb_mask_urls($content, $CONF['mask_urls'], $CONF['encrypt']); echo $new_content; } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">adbb_functions.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adbb_encrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data, $encrypt_conf)</span></span></span><span class="hljs-function"> </span></span>{ $iv = $encrypt_conf[<span class="hljs-string"><span class="hljs-string">'iv'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rtrim(strtr( base64_encode(mcrypt_encrypt($encrypt_conf[<span class="hljs-string"><span class="hljs-string">'cipher'</span></span>], $encrypt_conf[<span class="hljs-string"><span class="hljs-string">'key'</span></span>], $data, $encrypt_conf[<span class="hljs-string"><span class="hljs-string">'mode'</span></span>],$iv)), <span class="hljs-string"><span class="hljs-string">'+/'</span></span>, <span class="hljs-string"><span class="hljs-string">'-_'</span></span>), <span class="hljs-string"><span class="hljs-string">'='</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adbb_decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data, $encrypt_conf)</span></span></span><span class="hljs-function"> </span></span>{ $encrypted = base64_decode(str_pad(strtr( $data, <span class="hljs-string"><span class="hljs-string">'-_'</span></span>, <span class="hljs-string"><span class="hljs-string">'+/'</span></span>), strlen( $data ) % <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'='</span></span>, STR_PAD_RIGHT)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mcrypt_decrypt( $encrypt_conf[<span class="hljs-string"><span class="hljs-string">'cipher'</span></span>], $encrypt_conf[<span class="hljs-string"><span class="hljs-string">'key'</span></span>], $encrypted, $encrypt_conf[<span class="hljs-string"><span class="hljs-string">'mode'</span></span>], $encrypt_conf[<span class="hljs-string"><span class="hljs-string">'iv'</span></span>] ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adbb_translate_cookie_values</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($set_cookies)</span></span></span><span class="hljs-function"> </span></span>{ $keys = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($set_cookies <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $sc) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($pos = strpos($sc, <span class="hljs-string"><span class="hljs-string">';'</span></span>)) { $keys[] = substr($sc, <span class="hljs-number"><span class="hljs-number">0</span></span>, $pos); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $keys[] = $sc; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $keys; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adbb_get_headers_from_curl_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($headerContent)</span></span></span><span class="hljs-function"> </span></span>{ $headers = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">// Split the string on every "double" new line. $arrRequests = explode("\r\n\r\n", $headerContent); // Loop of response headers. The "count() -1" is to //avoid an empty row for the extra line break before the body of the response. for ($index = 0; $index &lt; count($arrRequests) -1; $index++) { foreach (explode("\r\n", $arrRequests[$index]) as $i =&gt; $line) { if ($i === 0) $headers[$index]['http_code'] = $line; else { list ($key, $value) = explode(': ', $line); if (array_key_exists($key, $headers[$index])) { if (is_array($headers[$index][$key])) { $headers[$index][$key][] = $value; } else { $t = $headers[$index][$key]; $headers[$index][$key] = array( $t ); $headers[$index][$key][] = $value; } } else { $headers[$index][$key] = $value; } } } } return $headers; } function adbb_call_url($url, $cookie, $ua, $headers) { $ch = curl_init(); $curlopt_headers = array(); foreach ($headers as $k =&gt; $v) $curlopt_headers[] = $k.': '.$v; $options = array( CURLOPT_URL =&gt; $url, CURLOPT_RETURNTRANSFER =&gt; true, CURLOPT_FOLLOWLOCATION =&gt; true, CURLOPT_USERAGENT =&gt; $ua, CURLOPT_CONNECTTIMEOUT =&gt; 5, CURLOPT_TIMEOUT =&gt; 5, CURLOPT_MAXREDIRS =&gt; 5, CURLOPT_SSL_VERIFYHOST =&gt; 0, CURLOPT_COOKIE =&gt; $cookie, CURLOPT_HTTPHEADER =&gt; $curlopt_headers, CURLOPT_VERBOSE =&gt; 1, CURLOPT_HEADER =&gt; 1, ); curl_setopt_array($ch, $options); $response = curl_exec($ch); if (!$response) return false; $header_size = curl_getinfo($ch, CURLINFO_HEADER_SIZE); $header = adbb_get_headers_from_curl_response(substr($response, 0, $header_size)); $content = substr($response, $header_size); $info = curl_getinfo($ch); return array( 'header' =&gt; $header, 'content' =&gt; $content, 'info' =&gt; $info ); } function adbb_mask_urls($content, $mask_conf, $encrypt_conf) { $prefix = $mask_conf['prefix']; $url_search_patterns = $mask_conf['url_search_patterns']; foreach ($url_search_patterns as $pattern) { $matches = array(); if (preg_match_all($pattern, $content, $matches)) { adbb_debug_log('Url matches ',$matches); foreach ($matches[0] as $m) { $encrypted_url = adbb_encrypt($m, $encrypt_conf); $content = str_replace($m, $prefix.$encrypted_url, $content); } } } return $content; } function adbb_debug_log($message, $obj = false) { // $s = $message.($obj ? ' ( '.(is_string($obj) ? $obj : var_export($obj,true) ) . ' )' : '' )."\n"; // static $f = null; // if (!$f and $f = @fopen("/tmp/adbb_tmp_log".date("Ymd"),"a+")) { // fputs($f, "== New call =="); // } // if ($f) { // fputs($f, $s); // } //echo $s ; }</span></span></code> </pre><br></div></div><br>  To get the primary login link itself, run with the same configuration. <br><br><pre> <code class="php hljs">adbb_encrypt(<span class="hljs-string"><span class="hljs-string">'http://ads.XXX.ru/XXXX/prepareCode?pp=g&amp;ps=bugf&amp;p2'</span></span>, $CONF[<span class="hljs-string"><span class="hljs-string">'encrypt'</span></span>]);</code> </pre><br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/267911/">https://habr.com/ru/post/267911/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267899/index.html">Online Trading: How to become a developer of systems for trading on the exchange</a></li>
<li><a href="../267901/index.html">The digest of news from the world of development on Unity</a></li>
<li><a href="../267903/index.html">Common Python problems and solutions (translation)</a></li>
<li><a href="../267905/index.html">Egret Free open source HTML5 game engine</a></li>
<li><a href="../267907/index.html">SAP Afaria. Small SMS for hacking a large company</a></li>
<li><a href="../267913/index.html">According to Rambler.iOS # 4</a></li>
<li><a href="../267915/index.html">ZeroNights 2015: Hack now - Save the future</a></li>
<li><a href="../267919/index.html">Network overlay technologies for data centers. Part 1</a></li>
<li><a href="../267921/index.html">Authorization in Redmine from another site</a></li>
<li><a href="../267923/index.html">Search and read legacy code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>