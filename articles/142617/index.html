<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write smart Remote - Desktop client on C # and XNA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, I'll show you how to write a Remote - Desktop client using C # + XNA 


 This topic inspired me to write this article. 

 A bit of myself 
 I wait...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write smart Remote - Desktop client on C # and XNA</h1><div class="post__text post__text-html js-mediator-article">  Hi, I'll show you how to write a Remote - Desktop client using C # + XNA <br><img src="https://habrastorage.org/storage2/e66/972/5f4/e669725f44ca9338c96d82fed35731c0.png"><br><br>  This <a href="http://habrahabr.ru/post/128467/">topic</a> inspired me to write this article. <br><a name="habracut"></a><br><h4>  A bit of myself </h4><br>  I waited a long time for the second part of that article, but I did not wait.  As the author argued, the second article was supposed to be the implementation of image transmission via UDP protocol to a remote client.  After that I tried to implement the second part of the article myself, but it always turned out badly.  Due to the slow drawing of the GDI, the program simply hung on the computer <i>Core 2 Duo 2.66 GHz, Nvidia GeForce 9600 GT</i> .  I used different optimization algorithms, but it didn't help much and then I decided to use XNA. <br><br><h4>  Selection of transmission protocol </h4><br>  I wanted very much to choose the TCP transfer protocol, there are fewer problems with it, but I chose UDP, because everyone says that it is better for such cases to take blah blah blah ... You‚Äôre probably wondering why there are more problems with UDP?  The answer is simple - a UDP message cannot exceed 65,507 bytes in size, which is not very convenient.  Our packets average 130,000 bytes in size (for a screen size of 1366x768), when we try to send such a packet, an error occurs, as shown below. <br><img src="https://habrastorage.org/storage2/ba7/4e7/7c1/ba74e77c1fda4f1f7cb6cfce470a59cb.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This problem can be solved in two ways: <br>  1) Create a crutch <br>  2) Create a structure <br><br>  1) Since I'm lazy, I chose a crutch.  The crutch is to break a larger message into many small ones and write the number of pieces in the first message that will be sent.  I called it a crutch, because, having lost the first message, the program <s>will fly to hell to</s> not properly glue the image (it will not know how many parts the image is broken into). <br><br>  2) You can break the screen into many pieces and remember their coordinates.  All this will need to be stored in the structure, which is very convenient, by the way, this algorithm will help to make optimization in the future. <br><br><h4>  Practice </h4><br>  I'll start with a simple one.  From the sender.  We will send screenshots of our screen to a remote computer.  I wrote a function for loading data and initializing some variables. <br><br>  The launch point is our Run () function. <br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Load(); <span class="hljs-comment"><span class="hljs-comment">//       udpClient = new UdpClient(); Bitmap BackGround = new Bitmap(width, height); Graphics graphics = Graphics.FromImage(BackGround); while (true) { //    graphics.CopyFromScreen(0, 0, 0, 0, new Size(width, height)); //       byte [] bytes = ConvertToByte(BackGround); List&lt;byte[]&gt; lst = CutMsg(bytes); for (int i = 0; i &lt; lst.Count; i++) { //    udpClient.Send(lst[i], lst[i].Length, ipEndPoint); } } }</span></span></code> </pre> <br>  Load () data is loaded first, variables are declared and looped.  In the loop, we get the screen image, convert it to a byte array, use my crutch (splitting the message into several messages - CutMsg (bytes)), send all the packets. <br><br>  Nothing interesting happens in the Load () function. <br>  Two lines will be read from the <i>ip.txt</i> file.  The first line is the IP address to which you want to send data.  The second line is the Port to which the sending will occur.  Also there will be getting the length and width of the screen. <br><br>  Conversion function <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> [] ConvertToByte(Bitmap bmp) { MemoryStream memoryStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream(); <span class="hljs-comment"><span class="hljs-comment">//       Jpeg bmp.Save(memoryStream, System.Drawing.Imaging.ImageFormat.Jpeg); return memoryStream.ToArray(); }</span></span></code> </pre><br><br>  And the most interesting is the implementation of the crutch. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt; CutMsg(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bt) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Lenght = bt.Length; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] temp; List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt; msg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt;(); MemoryStream memoryStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream(); <span class="hljs-comment"><span class="hljs-comment">//    2    memoryStream.Write( BitConverter.GetBytes((short)((Lenght / 65500) + 1)), 0, 2); //     memoryStream.Write(bt, 0, bt.Length); memoryStream.Position = 0; //      -   while (Lenght &gt; 0) { temp = new byte[65500]; memoryStream.Read(temp, 0, 65500); msg.Add(temp); Lenght -= 65500; } return msg; }</span></span></code> </pre><br>  I share the data on blocks of 65,500 (the number took less to clearly get) and write them to the sheet of byte arrays, after I return this sheet. <br><br><h4>  Recipient Code </h4><br>  It‚Äôs more complicated with the recipient, I used delegates and events there for asynchronous work and I don‚Äôt want to bore you with code that I‚Äôll write the main thing. <br><br>  Asynchronous data retrieval. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> countErorr = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AsyncReceiver</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { IPEndPoint ep = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IPEndPoint(IPAddress.Loopback, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { MemoryStream memoryStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = udpClient.Receive(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> ep); memoryStream.Write(bytes, <span class="hljs-number"><span class="hljs-number">2</span></span>, bytes.Length - <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> countMsg = bytes[<span class="hljs-number"><span class="hljs-number">0</span></span>] - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (countMsg &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; countMsg; i++) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bt = udpClient.Receive(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> ep); memoryStream.Write(bt, <span class="hljs-number"><span class="hljs-number">0</span></span>, bt.Length); } GetData(memoryStream.ToArray()); memoryStream.Close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { countErorr++; } } }</code> </pre><br>  We again see the looping, then we get the first packet, we read the first byte from it (the number of future messages is written in this byte), if the message is longer than 10, we obviously lost the first packet, therefore we add the loss counter, otherwise we get all the messages - we glue them into one and raise the GetData event (byte []). <br><br>  In GetData (byte []) we get Texture2D, converting it from an array of bytes. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Receive_GetData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] Date</span></span></span><span class="hljs-function">)</span></span> { BackGround = ConvertToTexture2D(Date); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Texture2D </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConvertToTexture2D</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] bytes</span></span></span><span class="hljs-function">)</span></span> { MemoryStream memoryStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream(bytes); System.Drawing.Bitmap bmp = (System.Drawing.Bitmap)System.Drawing.Bitmap.FromStream(memoryStream); <span class="hljs-comment"><span class="hljs-comment">//    .png,  Texture2D    memoryStream = new MemoryStream(); bmp.Save(memoryStream, System.Drawing.Imaging.ImageFormat.Png); //    Texture2D return Texture2D.FromStream(GraphicsDevice, memoryStream); }</span></span></code> </pre><br><br>  You can download the whole project at the end of the article, so do not despair if I have not written something. <br><br><h4>  Results and conclusion </h4><br>  As a result, when the ‚Äúsender‚Äù and ‚Äúreceiver‚Äù are simultaneously launched, recursion and a huge amount of losses occur on their computer (30‚Äì90 losses), when the ‚Äúsender‚Äù is started on my computer, and on the computer of the ‚Äúreceiver‚Äù parents, there is at least a loss (10 15 losses).  Both computers (parents and mine) are connected to the same Wi-Fi network with a 54 Mbit / s channel.  There is a ping (about 250 ms.) - reminds by ping TeamViewer.  If you add optimization and replace the crutch, you get a great program for image transfer. <br><br>  Recursion <br><img src="http://habrastorage.org/storage2/0e0/d40/8ac/0e0d408ac449bd79e4ce8c758e972942.png"><br><br>  Parents computer (image transfer from my computer to theirs) <br><img src="http://habrastorage.org/storage2/5e5/e19/437/5e5e19437a44533d44e3a74d0539aab7.png"><br><br>  What does a loss look like? <br><img src="http://habrastorage.org/storage2/8a2/aa9/2a8/8a2aa92a834ce6d7a11e75c8d21cde9e.png"><br><br>  In the next article I will finish the program, or rather add the ability to remote control and maybe even optimize it. <br><br>  Download <a href="">project</a> <br>  Download <a href="">Receiver</a> (Receives Images) <br>  Download <a href="">Sender</a> (Sends Images) <br><br>  PS I reloaded the source code on github <a href="https://github.com/Luchanso/remote-desktop">github.com/Luchanso/remote-desktop</a> </div><p>Source: <a href="https://habr.com/ru/post/142617/">https://habr.com/ru/post/142617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142610/index.html">Jubilee ZX Spectrum: 30 years</a></li>
<li><a href="../142611/index.html">Hello, we are looking for partners!</a></li>
<li><a href="../142612/index.html">Microsoft data centers</a></li>
<li><a href="../142613/index.html">Badoo: Meet new colleagues</a></li>
<li><a href="../142614/index.html">Sony released open source analysis tool APK</a></li>
<li><a href="../142618/index.html">‚ÄúRunet today‚Äù, April 23, 2012. Experts of the issue: Dmitry Chistov, Mikhail Gurevich, Fedor Virin</a></li>
<li><a href="../142619/index.html">TeliaSonera allocated VoIP traffic to a separate tariff plan for some countries</a></li>
<li><a href="../142621/index.html">Brainwashing by Evil Martians - Ruby on Rails development workshop May 19-20 in Moscow</a></li>
<li><a href="../142622/index.html">Rule Engine, or how to make the system easier</a></li>
<li><a href="../142623/index.html">Algorithm of life with a technical mindset</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>