<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Consider the simplest cases of Internet distribution within the office network.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 In the course of work, sometimes you have to connect clients either with the machines present on FreeBSD (a common option is to keep workin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Consider the simplest cases of Internet distribution within the office network.</h1><div class="post__text post__text-html js-mediator-article">  <i>Foreword</i> <br>  In the course of work, sometimes you have to connect clients either with the machines present on FreeBSD (a common option is to keep working files on sambas there) or to give them such a solution on request, for the most convenient solution of the client‚Äôs pressing problems.  The article is intended for a reader extremely weakly acquainted with FreeBSD.  I think that people who understand this article will be extremely disgusting - I recommend not to read further and not to injure yourself. <br><br><img src="http://img225.imageshack.us/img225/4941/sxem1.jpg" alt="image"><br><br><a name="habracut"></a><br>  The required set of knowledge is a general familiarity with * nix-like operating systems (any Linux, perhaps a makos), a cold-blooded attitude to the console, and basic ideas about network operation. <br>  The article was glued from the cheat sheet written for our staff and intended for elementary education.  Man 5, at least in this writing, at one time learned something, we believe that it has the right to exist. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The installation of FreeBSD is already very detailed and even in beautiful pictures is described very well and accessible from other people and we will modestly keep silent about it.  In addition, installing FreeBSD for a person who previously installed, say, Debian or FreeBSD (here, smiley) should not be a problem. <br><br>  <i>After-foreword and answers to your first thoughts</i> <br>  - yes, I know about the existence of pfnat, ipnat, ng_nat - if you also know such words, please do not read further (see above again) <br>  - yes, I know that pf is faster but I do not consider it appropriate to use it with streams of less than 50-60 Mbit <br>  - no, we will not proceed from the tasks set in the heading to build a full balancing on a round robin <br>  - No, not Linux - because the article is not about him. <br>  - and not makos - although yes, you can ... probably. <br>  - once again - about pf but on faster things we'll talk next time <br>  - yes, based on the experience of nuclear ipfw nat faster by 20 percent, it is very easy to switch to using it after the notion of working with natd <br>  - No, and we will keep silent about 2850 <br>  - yes, I really think ipfw is quite flexible.  Seriously. <br>  - no, I don't like squid, polipo, privoxy - then I will explain why <br><br>  So, we begin to deal directly with the solution of the tasks posed, and consider a spherical network of spontaneous layouts in a vacuum. <br><br><img src="http://img121.imageshack.us/img121/3422/net.jpg" alt="Spherical office network in vacuum"><br><br>  What we want to do: <br>  ‚Ä¢ Trivial and practical minimum - the circulation of our network on the Internet <br>  ‚Ä¢ We will assume that the Internet is looking at the network card rl0 with the address 10.10.10.1 and into our internal network of the network card fxp0 with the address 192.168.0.1 and one more not plugged network card xl0 (hereinafter we may know why we can use it) <br><br>  We will need: <br>  1. Machine with FreeBSD installed <br>  2. a little time <br>  3. 2 cups of coffee <br><br>  To begin with, we assemble and install the kernel, because IPFIREWALL and IPDIVERT are not included in the GENERIC box that comes out of the box, which we need right now, but it doesn‚Äôt include many things.  In principle, the process of building the kernel has already been described many times and there is no point in repeating it, but I feel that this step-by-step and accessible manual is written requires this routine. <br><br>  So the kernel build: <br><br>  #cd / usr / src / sys / i386 / conf <br>  # cp GENERIC MYROUTER <br>  #vim MYROUTER <br><br>  We rule the kernel configuration for our minimum well or optional minimum needs (read separately): <br><br>  MYROUTER ident <br>  options IPFIREWALL <br>  options IPFIREWALL_DEFAULT_TO_ACCEPT <br>  options IPFIREWALL_FORWARD <br>  options DUMMYNET <br>  options IPDIVERT <br>  options HZ = 1000 <br>  options IPFIREWALL_VERBOSE <br>  options IPFIREWALL_VERBOSE_LIMIT = 100 <br><br>  and collect: <br>  #config MYROUTER <br>  #cd ../compile/MYROUTER <br>  #make depend <br>  #make <br><br>  Backing up the old kernel if something scary happens: <br><br>  #cp ‚ÄìR / boot / kernel / boot / good <br><br>  and install the new kernel <br><br>  #make install <br><br>  <i>Note - if we are going to natit on an external piece of iron or another host, and then only control the utilization of the channel, then IPDIVERT is completely unnecessary, you can freely dispense with the ipfw module loading and do without reassembling the kernel.</i> <br><br>  We start playing with NAT, for the sake of which all this was started: <br><br>  we put in /etc/rc.conf <br><br>  defaultrouter = "10.10.10.2" # default gateway <br>  ifconfig_rl0 = "inet 10.10.10.1 netmask 255.255.255.0" <br>  ifconfig_fxp0 = "inet 192.168.0.1 netmask 255.255.255.0" <br>  gateway_enable = "YES" # yes, we will <br>  firewall_enable = "YES" # cut in ipfw <br>  firewall_script = "/ etc / firewall.conf" # from here our ipfw should take the rules <br>  natd_enable = "YES" # cut in natd <br>  natd_interface = "rl0" # and tell him where we will natit (network card looking to the Internet) <br><br>  Here it is recommended everywhere.  Personally, I am accustomed to letting natd not on the interface but on a specific ipishka with a specific port for a diverta.  You can do this for example from the same /etc/firewall.conf in the form / sbin / natd -u -p 8671 -a 10.10.10.1 (Why it's so convenient to do this, too, consider in the case of PBR) <br><br>  Next, create the above /etc/firewall.conf <br><br>  In many manuals that I came across, it is offered in the simplest form like this: <br><br>  #! / bin / sh <br>  FwCMD = "/ sbin / ipfw -q" <br>  $ {FwCMD} -f flush <br>  $ {FwCMD} add divert natd from rl0 <br>  $ {FwCMD} add 65535 allow <br><br>  divert from any to any via in general an ugly option, we go further, if we do something, we will do it more beautifully: <br><br>  #! / bin / sh <br>  / sbin / natd -u -p 8671 -a 10.10.10.1 <br>  FwCMD = "/ sbin / ipfw -q" <br>  $ {FwCMD} -f flush <br><br>  # Networks define <br>  $ {FwCMD} table 2 add 192.168.0.0/24 <br>  $ {FwCMD} table 9 add 10.10.10.8/32 <br>  #internet natting and preserving <br>  $ {FwCMD} add 1799 divert 8671 ip from table \ (2 \) to not table \ (9 \) out via rl0 <br>  $ {FwCMD} add 2099 divert 8671 ip from any to 10.10.10.1 in via rl0 <br><br>  For the future, we remember that in table (2) we have networks or hosts that we will natit, and in table (9) those hosts that we don‚Äôt want to NAT to.  As an example, we mentioned a host on 10.10.10.8 there that is on the 10.10.10 / 24 network and let's say it performs the functions of our office% service_name%.  Accordingly, in order for us to reach him from the 192.168 / 24 network, you need to drive a static routing call to 10.10.10.1 <br><br>  So back to the task and set the execution rights. <br><br>  #chmod a + x /etc/firewall.conf <br><br>  Then you can look at the sky, cross and reboot. <br>  #reboot <br><br>  After downloading, there is a chance that we will see a working NAT and our users will be able to see the suffering Internet, registering ipishki from 192.168.0.0/24 range and specifying the default gateway 192.168.0.1 plus Provider DNS (we have not yet raised our own). <br><br>  Checking the operation of the nat method <br>  #ipfw show <br><br>  As a result, we should see something like <br><br>  1265581 168080800 divert 8671 ip from table (2) to not table (9) out via rl0 <br>  769868437 668041277852 divert 8671 ip from any to 10.10.10.1 in via rl0 <br><br>  It is clear that we missed a lot, for example, throwing away trash from GENERIC, tuning kernel options to ensure human performance during sessions and a huge stream, cutting any garbage on the interfaces, but more on that next time if you want. <br><br>  <b>Let's go further in the real tasks that can suddenly stand in front of us.</b> <br><br>  Quite often there is the task of providing different bandwidth to different hosts. <br>  For example, Svetlana Denisovna doesn‚Äôt need a very fast Internet connection during her work, and her bosses want her channel to look like a symmetrical 256 Kbps.  OK no problem: <br><br>  ipfw pipe 10256 config bw 256Kbit / s queue 32Kbytes <br>  ipfw pipe 20256 config bw 256Kbit / s queue 32Kbytes <br>  ipfw add 10000 pipe 10256 ip from 192.168.0.6 to not table \ (9 \) via fxp0 in <br>  ipfw add 10000 pipe 10256 ip from not table \ (9 \) to 192.168.0.6 via fxp0 out <br><br>  After verifying that it‚Äôs working, you can duplicate all this in /etc/firewall.conf.  Having never tested another rule, even the most obvious, do not add it to the config - you will always have a way to access without unnecessary nerves. <br>  If the speed needs to be cut on the entire network, or else somehow on the mask, it would be more logical to do, let's say, like this: <br><br>  $ {FwCMD} pipe 9999 config bw 512Kbit / s queue 64Kbytes mask dst-ip 0xffffffff <br>  $ {FwCMD} pipe 9998 config bw 512Kbit / s queue 64Kbytes mask dst-ip 0xffffffff <br>  $ {FwCMD} add 5000 pipe 9999 ip from table \ (2 \) to not table \ (9 \) via fxp0 in <br>  $ {FwCMD} add 5000 pipe 9998 ip from not table \ (9 \) to table \ (2 \) via fxp0 out <br><br>  Turning the mask in the pipe we can do either ‚Äúthis is the speed at all‚Äù or ‚Äúthis is the speed for everyone‚Äù as indicated in the example. <br><br>  <i>What else would I like to do after that?</i>  <i>Very much to be honest.</i> <br><br>  1. Configure DHCP <br>  2. Raise your DNS <br>  3. I would like to shoot realistic statistics of traffic walking on interfaces using snmp and draw beautiful graphics using cacti <br>  4. Have the ability to limit the traffic on users within the network <br>  5. Have detailed statistics on who and what traffic is spent on. <br>  6. Set up backup channels if there is another provider (and forgot about xl0) <br>  7. Learn how to arrange traffic between multiple channels using ipfw <br><br>  <i>How do you want everything to look in the final?</i> <br>  At least like this: <br><img src="http://img225.imageshack.us/img225/1386/sgconfig.png" alt="sgconfig"><br><br>  These 7 points in conjunction with the accelerated installation of billing (picture above) I would like to consider in the next article if someone will be interested and karma after today's pressing the ‚Äúpublish‚Äù button will allow;) <br><br>  PS and yes - my Russian has not improved since the <a href="http://nightfly.habrahabr.ru/blog/70305/">previous post was</a> published.  I sincerely apologize. <br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/70414/">https://habr.com/ru/post/70414/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70403/index.html">Midnight Commander: Skins</a></li>
<li><a href="../70405/index.html">Multi-touch with four displays</a></li>
<li><a href="../70407/index.html">Zero houses</a></li>
<li><a href="../70408/index.html">Yota</a></li>
<li><a href="../70410/index.html">Another App Store, this time for netbooks on the Intel Atom</a></li>
<li><a href="../70416/index.html">Miracle Breeding - Traktor + Ableton</a></li>
<li><a href="../70419/index.html">ProkatVsego - rental and rental catalog of everything you want</a></li>
<li><a href="../70424/index.html">Feature Driven Development for Web Developers</a></li>
<li><a href="../70426/index.html">New advertising Windows 7</a></li>
<li><a href="../70427/index.html">What unites Liberty Reserve and Alertpay?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>