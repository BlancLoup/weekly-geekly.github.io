<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>My home automation system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 The purpose of this article (cycle) is an introductory story about my home automation system, of course I did not invent it and created e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>My home automation system</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  The purpose of this article (cycle) is <s>an</s> introductory story about my home automation system, of course I did not invent it and created everything from scratch, but only collected technologies and projects that I considered most suitable for this purpose and added a little from myself.  The level is amateur, but as a result everything works, people use me and do not run after me with a cudgel.  He did everything himself.  Constructive criticism is welcome, it will be interesting to know any opinion. <br><br>  The system includes equipment and a set of programs: the automation system itself for communication of equipment and visualization, communication and telemetry for remote monitoring and updating, voice assistant from Yandex.  Everything <i>(almost everything) is</i> open and laid out on <a href="https://github.com/">Github</a> . <br><a name="habracut"></a><br><h3>  Equipment level </h3><br>  The main and necessary part is a server based on the Raspberry Pi, but it can easily work on a PC with Debian or Ubuntu.  Raspbian operating system.  The system should work 24/7/365 so a high-quality power supply unit is needed, for example, a bp for the iPad is perfect. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/_v/-j/fk/_v-jfkopnckaqd6d2url7bbyso4.jpeg"><br><br>  For Remote Control, I also need the skill for a voice assistant. Yandex needs a server with a ‚Äúwhite‚Äù IP and domain.  The server is running an MQTT server, using SSL / TLS for security. <br><br>  KNX support via BAOS 771-774 gateway.  BAOS is the interface between the KNX bus and the LAN.  Allows you to access the addresses on the bus via a web service in JSON format. <br><br>  <b>My equipment:</b> <br><br>  <a href="https://github.com/hjltu/hjmqtt/tree/master/arduino">Projects for Arduino IDE</a> <br><br>  <b>Wifi Controller based on Wemos D1 mini</b> <br><br><img src="https://habrastorage.org/webt/rg/tk/85/rgtk85up8tdsr6xayaj8ocg47-w.jpeg"><br><br>  230 volt mains supply, it is also possible without a power supply from a common 5 volt bus to power Wemos or from the equipment it controls, such as a curtain drive.  It is possible to install in the installation and terminal boxes of sufficient depth, for example behind a switch. <br><br>  It can be used instead of radio control with different curtain drives. <br><br><div class="spoiler">  <b class="spoiler_title">Scheme</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/oy/xk/4w/oyxk4wsdxrvbw4dpkhtzajo6kt0.png"><br></div></div><br>  Pinout pin driven: <br>  L1, L2 - Power outputs from the BT-137S triacs, controlled by wemos D0, D5 outputs through an MOC 3063S optocoupler with control of phase transition through zero.  Switching the load on and off will take place without interfering with the network. <br>  p1, p2 - pwm output for dimmers or motorized curtain drives or additional buttons, depends on the settings.  correspond to the conclusions of wemos D6, D7. <br>  A0 analog input for connecting various sensors, such as light or an additional button. <br>  ds - The connection of the DS18B20 temperature sensor corresponds to pin D1. <br>  DHT - Connecting the DHT22 temperature sensor corresponds to pin D2. <br>  b1, b2 - Buttons, short and long press, with the function of the counter of clicks, can be connected to the pulse outputs of electricity meters, water, etc. <br><br><div class="spoiler">  <b class="spoiler_title">Demonstration of work</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/PPkzPMNiBQY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  The controller program is created in the Arduino IDE.  Suitable for all ESP-8266 based boards.  Network configuration, control and operation of the controller is carried out by MQTT.  For convenient viewing of settings, there is a Web-interface, previously there was a possibility to control via http, but then I found it unnecessary and removed it. <br><br><div class="spoiler">  <b class="spoiler_title">Web interface</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xs/ru/id/xsruid9tfryat8x2raxfmv7dggu.png"><br></div></div><br>  Web interface can be disabled.  For the convenience of initial configuration, a script winit.sh and instructions are provided.  To reset the controller to the default settings, either enter the ‚Äúdefault 1‚Äù command or simultaneously press the b1, b2 buttons for 20 seconds.  There is also a simplified version of the program for controlled outlets Sonoff. <br><br>  <b>Arduino Mega based controller</b> <br><br><img src="https://habrastorage.org/webt/ld/_e/cy/ld_ecy2suip8ef20lc4nmpqi53k.jpeg"><br><br>  It consists of the megabyte itself and the shield of the W5100 network card, the board divides the outputs for dimmers and the inputs for sensors and buttons, the relay outputs must be connected separately using a cable to the 2-row connector located on the mega board on the opposite side of the power and USB ports.  The controller is rated for the D6MG package. <br><br>  Pinout: <br><br>  D2-9, D11-13 - PWM outputs for dimmers, PWM frequency is increased from the standard. <br>  D14-21 - DS18B20 and DHT22 temperature sensors. <br>  D22-49 - relay outputs, outputs D22-29 can be configured for louver drives, gates, curtains. <br>  D10,50-53 - uses a W5100 network card. <br>  A0-16 - inputs for buttons, short and long press.  A0-A6 can be configured for analog sensors. <br><br>  Network settings for mega are set in the program before the firmware.  IP address is fixed. <br><br><div class="spoiler">  <b class="spoiler_title">Web interface</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tv/9g/pp/tv9gppypwll3i_iyaqbpnjfzhbq.png"><br></div></div><br>  <b>Dimmer on a simistor BT137-600E</b> <br><br><img src="https://habrastorage.org/webt/ss/uy/ah/ssuyahexjpkmq75dsydnyyefyie.jpeg"><br><br>  Input 220 volts, PWM control 0-5 / 3.3 volts, set by jumper setting.  0-5 volts to work with Arduino Mega or 0-3.3 volts in the case of wemos.  The PWM signal is fed to the analog input A0 Arduino Pro where it is converted into a delay for the opening of the triac, a connector is provided for flashing the arduine in place.  There is a place for the radiator.  On the arduino side, there is an arduine control and power supply connector (PWM, -, +), on the side of the SMIstor there is a 4-pin power connector - power and output to the load, if necessary, you can also install a varistor or snubber on it.  The dimmer board is designed for the D2MG case. <br><br>  Dimmer project: <br><br> <a href="https://www.pcbway.com/project/shareproject/W108955ASU1_triac_dimmer_24_nov_18.html"><img src="https://habrastorage.org/getpro/habr/post_images/8a1/ec4/335/8a1ec433583539dc1962e14fe1f031cd.png" alt="PCB from PCBWay"></a> <br><br><div class="spoiler">  <b class="spoiler_title">Demonstration of work</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/Dj-iw9Rz5CE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  <b>There is also a block of triacs for 28 channels</b> in the D9MG package. <br><br><div class="spoiler">  <b class="spoiler_title">I apologize for the quality of the picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/os/iy/ri/osiyriitdnczwrpxqcxttd3saaq.jpeg"><br></div></div><br>  The equipment is connected via the LAN, the protocol for MQTT communication.  I am using the MQTT Mosquitto server. <br><br><h3>  Software part </h3><br>  For convenience, you first need to prepare an image of the operating system with all the necessary programs, I use Raspbian Stretch Lite.  You will need to install nodejs, python-pip, python3-pip, supervisor, mosquitto, mosquitto-clients, sqlite3.  And pip packages: paho-mqtt and psutil.  You can also install Node-red, perfect for all kinds of experiments. <br><br>  After the release of Apple Homekit in 2016, it turned out that all the manufacturers and developers for the entire existence of the Smart Home systems could not do anything close in terms of convenience and functionality compared to homky, this is similar to the situation with the release of the first iPhone, when it turned out that the whole zoo phones, smartphones, communicators turned into a bunch of unnecessary trash.  In any case, it is always pleasant to use a quality and finished product. <br><br>  I chose the <a href="https://github.com/hobbyquaker/homekit2mqtt">homekit2mqtt</a> project as the main visualization system.  Of course, you can use OpenHUB or Homeassistant, these systems also work with MQTT. <br><br>  <a href="https://github.com/hjltu/hjmqtt">hjmqtt</a> <br>  Homekit2mqtt creates Homekit Bridge, it can be found in the program "Home" on Apple devices.  Accessories (lighting, sensors, thermostats, etc.) need to be written in a special file in JSON format.  For the creation of this file, the scripts filegen.sh and install.sh are responsible.  In filegen.sh, you need to register accessories, install.sh adds homekit2mqtt to startup and starts.  The most important thing happens in the hjmqtt.py file - the connection of the accessories with the equipment, in the file also manually, you need to register the accessories and the equipment parameters, the addresses for the KNX. <br>  Functionality for accessories is registered in the files accessory.py and accessoryknx.py.  Device statuses are stored in the sqlite database, for database operations, the statdb.py library is used. <br><br>  <a href="https://github.com/hjltu/hjconnect">hjconnect</a> <br>  The following project is needed for remote telemetry.  This is the use of memory, disks, load and temperature, for this the psutil package is used.  Now the open access version of hjconnect is available only for monitoring and without encryption and with a separate project a program for linking files to the same MQTT <a href="https://github.com/hjltu/file-transfer-via-mqtt">file-transfer-via-mqtt</a> .  Settings are right in the main hjconnect.py file.  If you run it with the "-l" parameter, you can test it on the local MQTT server, the settings for the remote server are on line 160 <br><br><pre><code class="python hljs">rclient.connect(<span class="hljs-string"><span class="hljs-string">"test.mosquitto.org"</span></span>, <span class="hljs-number"><span class="hljs-number">1883</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>)</code> </pre> <br>  server test.mosquitto.org can be replaced with your domain or IP.  To identify the Raspberry Pi, the processor serial number is included in the topic, if the program is run on another computer instead of the serial number, the string ‚ÄúSN‚Äù will be displayed.  Message interval is set in line 96 <br><br><pre> <code class="python hljs">th = threading.Timer(<span class="hljs-number"><span class="hljs-number">9</span></span>, my_stat) <span class="hljs-comment"><span class="hljs-comment"># interval</span></span></code> </pre> <br>  where 9 is seconds. <br><br><div class="spoiler">  <b class="spoiler_title">An example of what monitoring looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xa/dk/tu/xadktutaa2aiieil1rcwxzhz7zs.png"><br></div></div><br>  <a href="https://github.com/hjltu/sima">sima</a> <br>  Now the only speaker that speaks Russian is only Yandex.  Creating a skill for Alice is easy enough.  In contrast to the Siri given complete freedom of action.  And access on any devices.  Only, unfortunately, while there is no sane way to start the skill, it is inconvenient to constantly start the skill. <br><br><div class="spoiler">  <b class="spoiler_title">Demo</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/XiIFVnCSt-M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  This is a working example of skill.  To get started, the skill will require an SSL certificate, you can generate it using openssl.  In the sima.py file in line 14 there is an example of certificate generation <br><br><pre> <code class="bash hljs">openssl req -new -keyout crt.pem -out crt.pem -x509 -days 365 -nodes -subj <span class="hljs-string"><span class="hljs-string">'/CN=site.com/O=user/C=RU'</span></span></code> </pre> <br>  site.com and user need to be replaced with their data. <br><br>  When a skill is launched on a new device, its ID is recorded.  In order to associate an identifier and an automation system, you first need to create a new csv file in the clients directory, following the sample my.csv file.  A serial number is written in the file according to the template, this is the same serial number from the hjconnect program, and the management objects are written: name, type, topic.  A topic is a significant part of the MQTT accessory topic from a JSON file for homekit2mqtt.  Then, using sn.py, you need to convert the serial number to a password and call this password on the device from which you will manage.  The connection is provided by the hjconnect program, and the MQTT monitoring server is the same computer on which the skill is running. <br><br>  Thanks, bye. </div><p>Source: <a href="https://habr.com/ru/post/442600/">https://habr.com/ru/post/442600/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442588/index.html">Ask a question to the author of the language Lua</a></li>
<li><a href="../442592/index.html">Using Joomla Accounts in a Django Project</a></li>
<li><a href="../442594/index.html">And you will monitor everything for me? Aha</a></li>
<li><a href="../442596/index.html">Soundtrack for the game: humanists cry too</a></li>
<li><a href="../442598/index.html">Do we need Headhunters?</a></li>
<li><a href="../442602/index.html">Does speed reduce speed reduction?</a></li>
<li><a href="../442606/index.html">Domain Object with Lombok: Battle Classics</a></li>
<li><a href="../442608/index.html">The QuadrigaCX cryptobirds cold wallets, the founder of which died, were empty</a></li>
<li><a href="../442610/index.html">Telegram-bot + Google Analytics</a></li>
<li><a href="../442612/index.html">Cardboard engine for an electrical board game. As we brought it closer to reality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>