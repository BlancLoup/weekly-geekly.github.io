<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The problem of continuous protection of web applications. View from the side of researchers and operators. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, we continue the topic started a week ago. Last time, the developer of WAF shared his views on continuous protection of web applications. Today I w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The problem of continuous protection of web applications. View from the side of researchers and operators. Part 2</h1><div class="post__text post__text-html js-mediator-article">  So, we continue the topic started a week ago.  Last time, the developer of WAF <a href="http://habrahabr.ru/company/solarsecurity/blog/331786/">shared</a> his views on continuous protection of web applications.  Today I would like to talk about how this problem is solved in the Solar JSOC cyber attack monitoring and response center.  Under the cut - everything about the combat operation of WAF: what methods of work we consider the most effective, how our clients' web services attack and how WAF works (and sometimes does not work). <br><br><img src="https://habrastorage.org/web/f39/f99/9b2/f39f999b2d804111be1f266dd6e033ad.jpg"><br><a name="habracut"></a><br>  One of the most important aspects related to WAF, in addition to the choice of vendor and product implementation, is the further operation.  At the same time, the classic approach to the operation of the Web Application Firewall is very conditional and has a number of important features. <br><br>  Firstly, due to the location of WAF and the type of resources it protects, promptly updating signatures and installing patches on it is a much higher priority than in the case of other equipment.  The website always sticks out, which makes it particularly vulnerable to various newly published vulnerabilities.  A delay of several days can threaten serious losses and hacking of the protected resource.  Vendors release signatures quickly, but the process of launching them into lockout mode usually takes place in several stages.  First, the learning process takes place when we observe the number of draws and analyze the packets for which the signature worked.  Further, it is transferred to another mode.  But in the case of critical vulnerabilities, you must either immediately transfer the signature into the block, or, without waiting for the vendor to update, write the signature yourself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Secondly, proactive exploitation comes to the fore with WAF - response to incidents in a mode close to online, analysis and operational tuning of policies and profiles.  This is especially true in the case of a hybrid mode of operation, when part of the workouts are not blocked, but only fixed by WAF.  This is done to minimize the risk of blocking legitimate requests. <br><br>  Thirdly, due to the reduction of the release cycle, the problem of dynamic content and profiling requires the presence of specialists working in full-time mode. <br><br><h3>  WAF Operation <br></h3><br>  What is the task of operation?  I identified four main areas: <br><br><ol><li>  Update - tracking patches, including closing errors.  This was mentioned above, so we move on. </li><li>  Writing private signatures: <br><ul><li>  Tracking new critical signatures, joint testing with the customer and preparation of countermeasures for the period until the official updates are released (if it is not possible to write custom ones). </li><li>  writing signatures as compensation measures to close application source code vulnerabilities: <br><ul><li>  vulnerabilities known to developers, the closure of which requires large-scale modifications of the source code; </li><li>  vulnerabilities identified by analyzing the source code of applications. </li></ul></li></ul></li><li>  Profiling of requests, references to pages of the site, application. </li><li>  Validation - checking and analyzing the parameters of requests / responses to the protected resource / application. </li></ol><br>  However, only the first of the above points can be performed independently from the development department.  All other operating functions are inextricably linked with the developers of the protected website or application.  Another important role is played by testing collected profiles and created policies, including in query blocking mode. <br><br>  I think that there is no doubt that the ‚Äúcome-configured-enabled-works‚Äù option is not viable in 99% of cases and does not work on dynamically changing content.  Exceptions are those customers who block requests for static signatures, exclude testing of updates arriving on WAF and immediately roll them into production.  That is, if we are not talking about the learning functionality of WAF, the cycle of updates, installing patches over RFC, creating policies for a specific protected resource - you may not need a full time specialist or service manual. <br><br><h3>  WAF mode <br></h3><br>  The first option: only blocking - by signatures and profile.  Two points must be taken into account here: 1) there is a fairly high risk of blocking legitimate requests;  2) and, conversely, WAF can skip requests that exploit vulnerabilities and holes.  It may happen that with a large-scale scan, 99.9% of requests will be blocked, and 0.1% will pass, but this will be enough for a successful attack.  Upon analysis, 0.1% new custom signatures are written and added to the block. <br><br>  Second option: notification only.  In this case, upon the triggering of the signatures, it is necessary to conduct a comprehensive investigation and correlate data with other sources, for example, with databases in the case of using SQL injections.  Given the huge amount of WAF responses, it‚Äôs almost impossible to manually analyze them all. <br><br>  That is why the third variant is most often used - hybrid. <br><br>  In this case, the analysis of static signatures is carried out, and in the absence or minimal number of false positives, they are transferred to the blocking mode. <br><br>  In parallel, analysts profile the work of the site and user activities in order to further identify anomalies.  It should be noted here that the translation of a policy created on the basis of a site profile into a blocking mode is impossible without serious analytics and interaction with the development.  Otherwise it threatens to block legitimate requests, which will result in reputational loss for the customer. <br><br>  At the same time, due to both dynamic content and newly emerging situations related to customer activities, the refinement of policies, custom signatures, the list of exceptions never ends ‚Äî this is a continuous process. <br><br>  Below is an example of setting up groups of signatures of one of our clients.  As part of the service, we connected the WAF and web server logs (IIS) to the Solar JSOC SIEM system.  Critical signatures are placed in blocking mode, logged and added to the training list, in case you need to make exceptions: <br><br><img src="https://habrastorage.org/web/5f4/e39/16a/5f4e3916a9c84d269c577108028cf15c.png"><br><br>  Content settings: <br><br><img src="https://habrastorage.org/web/842/b3f/d3f/842b3fd3f4a04f9d9d7338e7319f6f15.png"><br><br>  Invalid request headers are not blocked yet, but there is training and logging of such requests: <br><br><img src="https://habrastorage.org/web/a15/8cf/22d/a158cf22dd3243ee8a819b5b44037290.png"><br><br>  Whichever option you choose, it is important to keep in mind the need to analyze both the requests that caused the triggers and the missing requests to the application.  And forcing WAF to log the missed requests is quite laborious from the point of view of load, so it is more expedient to look at the logs of the application itself or the web server. <br><br><h3>  Custom signatures <br></h3><br>  One of the most important moments in the operation of Web Application Firewall is to write custom signatures.  This is required in several cases: the emergence of a new vulnerability, the registration of anomalies that require additional analysis, and the collection of long-term statistics of authentication in the application. <br><br>  In the case of a serious vulnerability, such as shellshock, for example, operational policy refinement is required.  Usually, the WAF operation service can implement it within 1-2 hours, while the vendor can take up to several days.  Delay in such situations threatens the successful exploitation of the vulnerability, since the attackers work almost instantly, launching a scan of all the white addresses on the Internet for vulnerability. <br><br>  An example of the detection of anomalies using manual analysis is the collection of statistics on the large volume of traffic sent and received.  In general, a large session size does not indicate an incident, but when viewing the overall statistics, you can find really important triggers.  Similarly, with monitoring file downloads with non-standard extensions - in general, blocking such attachments is impractical, but analyzing them, including using a sandbox, is recommended. <br><br><h3>  Work with dynamic content <br></h3><br>  The correct cycle of working with constantly changing content, it seems to me, should look like this: <br><br><ol><li>  Formed policy is unloaded from the combat server to the test environment. </li><li>  In the process of testing the updated content, compatibility with the current WAF policy is simultaneously tested, if necessary, it is adjusted. </li><li>  In an ideal scheme, an application or service update is tested on a pilot group (region).  At this stage, the WAF policy is transferred to the blocking mode and tested in combat conditions.  Tuning and tweaking policy configuration is also performed. </li><li>  Further update and policy is applied globally to all customers of the customer and becomes a reference until the next update. </li></ol><br>  In an ideal world there are pre-productive environments, functional and stress tests lasting about 2 weeks.  But life sometimes puts things differently.  Approximately in 30% of cases we have to work with a reduced development mode of applications and web sites at customers, when the update immediately ‚Äúrolls‚Äù onto productive servers.  In this case, it is necessary to quickly adjust the WAF policy to the new working conditions.  For this, profiling is started for a short period of time - half a day-day.  Due to the large amount of traffic, this is often sufficient for training.  After this time, the ‚Äúpre-profiled‚Äù updated policy is transferred to the blocking mode. <br><br>  Both methods require additional attention from the operational service during the transition to the blocking mode.  This is done for manual analysis of blocked requests, since no intelligent system of training and profiling can work perfectly without false positives. <br><br>  Here are two vivid examples of the development cycle of our customers: <br><br>  The first case - the customer releases one release per week.  At the same time, the interaction between the customer and the contractor does not provide for a detailed release notes, according to which it can be understood whether a policy adjustment is necessary.  The only option is to work ‚Äúhot‚Äù with a short and operational cycle of tuning WAF policies: <br><br><img src="https://habrastorage.org/web/b29/31a/c88/b2931ac882504cee84c75a7c7e031668.png"><br><br>  In our other client, part of the site changes several times a day as part of the placement of new products, promotions, etc.  It is impossible to include any profiling and blocking on the collected profile for this part of the site content.  Therefore, we are working on it in the mode of monitoring anomalies and creating custom signatures. <br><br><h3>  Integration of WAF with SIEM: how and what is needed? <br></h3><br>  If a company uses its own or outsourced Security Operations Center, connecting WAF to a SIEM system will allow for prompt notification and analysis of all types of incidents, including web attacks, from a single point - the SIEM system. <br><br>  To fix and further investigate incidents in the SIEM system, you need to connect the following sources: <br><br><ul><li>  Directly WAF itself. </li><li>  Web server logs.  As mentioned above, enabling logging of all requests for WAF can cause excessive load, so it is easier to connect logging to IIS or Apache. </li><li>  Logs of the WAF protected application for tracking requests. </li><li>  Database logs for tracking requests. </li></ul><br>  <i>The important point in collecting logs of a web server or application is not only the completeness of the collection of information, but also the analysis of the retrospective.</i>  <i>SIEM systems are sharpened for storing large amounts of data with the ability to quickly search in retrospect with a depth of several months, including using regular expressions for queries.</i>  <i>This is another powerful argument for integrating WAF with SIEM.</i> <i><br></i> <br>  When connecting WAF, you need to understand which fields, headers and metadata will be useful in the investigation of incidents.  As an example, consider connecting the F5 ASM to ArcSight. <br><br><img src="https://habrastorage.org/web/39b/72f/3df/39b72f3df47d43488c7939d83100840a.jpg"><br><br>  Of the required fields is to highlight: <br><br>  Date and time of the event <br>  Signature name ‚Äî for example, ‚ÄúIllegal request length‚Äù <br>  Attack type - for example, ‚ÄúSession Hijacking‚Äù <br>  Requested URL: <br><br><pre><code class="hljs markdown">/login?<span class="hljs-strong"><span class="hljs-strong">_****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>=/sitebuilder/<span class="hljs-strong"><span class="hljs-strong">****/myaccount/login/**</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>form</code> </pre> <br>  Request method - GET, POST, etc. <br>  Address from which the request came <br>  Address to which the request came <br>  Connection protocol <br>  Site response code <br>  The name of the policy on which the signature worked <br>  Date and time of this policy <br><br>  Despite the limitation of 4096 characters in the customstring-fields of ArcSight, we "zamapi" there the entire request, the analysis of which very often comes in handy in the investigation: <br><br><img src="https://habrastorage.org/web/3a3/19c/ffd/3a319cffdd8c48b48ddd831c8fbfc02f.jpg"><br><br>  First line monitoring specialists handle potential incidents that are configured for different scenarios: <br><br><ol><li>  The abnormal number of different signatures that worked on a WAF from an external host is a potential scan for vulnerabilities. </li><li>  Triggering signatures for several days in a row from a single external host is a slow scan. </li><li>  Triggering the threshold value of signatures in a short period of time from different hosts - distributed scanning / application-level DDoS. </li><li>  Attempt to exploit critical vulnerabilities.  In the case of the drawdown of this scenario, our specialists, together with customers, analyze not only the WAF logs, but also successful requests from the same address to the website.  Further, according to the results of the analysis and when the need arises, the WAF policy is finalized. </li></ol><br>  After the first line specialists notify the WAF operation service, the latter have the opportunity to connect to the GIS interface and ‚Äútune‚Äù policies in real time to counter the attack.  Connecting to a SIEM system allows you not only to set up prompt notification of potential incidents, but also to enrich information about attacks with information from other systems, as well as to produce complex correlation along chains of events.  For example, to understand the success of an attack, information from a Web Application Firewall can be correlated with queries in SQL databases or local logs of a web server. <br><br>  Our approach to handling incidents: <br><br><img src="https://habrastorage.org/web/410/d13/af9/410d13af9f05429db4dcf5069596c2ee.png"><br><br>  For example, in one of our customers, the key business component is an online store.  All existing business processes are tied to the logic of working with clients and processing orders.  As a loyalty program, the company uses virtual points, which can be used to calculate the store, including partial.  When making a purchase at the stage of choosing a payment method, the customer has the opportunity to enter the number of points in the field that will be used instead of real money. <br><br>  The customer needs to control suspicious transactions - too many bonuses or transactions with bonuses for a certain time.  A separate table (Active List in ArcSight) is used as a tool for collecting summary statistics.  Daily unloading from this sheet is sent to the analyst to study the anomalies that do not fall into the current correlation response. <br><br>  An entry was found in one of these unloadings: <br><br><pre> <code class="php hljs">modify_order_bonus <span class="hljs-string"><span class="hljs-string">":"</span></span>{\<span class="hljs-string"><span class="hljs-string">"bonusAvailable\":18.0,\"bonus\":-20000}"</span></span> reason: success</code> </pre><br>  When analyzing this anomaly, it turned out that one of the clients tried using POST requests, containing various variations of bonuses required for writing off, to deceive the logic of the website.  And got his way!  When sending a negative value, the system compared the number of available bonuses with the number of bonuses to the write-off and, when performing mathematical inequality, approved the process. <br><br>  But this is not all: with the further processing of the order in specialized systems, to which information was transferred from the website, the value of the bonuses required for write-off was taken modulo!  So the client has successfully received a discount of 20 thousand rubles, with 18 points on the account. <br><br>  The Web Application Firewall did not see anything abnormal because the request structure was correct and the number of requests was not suspicious.  Only the subsequent collection of statistics and viewing of events through the eyes of a live analyst revealed a successful fraud attempt in the client‚Äôs key business application. <br><br>  From here we can draw the following conclusion: any important requests to a key application, such as redemption of points, cash, etc., should be logged using the custom policy settings on WAF or by connecting the application logs and further analysis in the SIEM system. <br><br><h3>  Application Environment Protection <br></h3><br>  Not all hackers are attacking the application "in the forehead."  In some cases, it is much easier to penetrate the infrastructure of the company and attack the application or its database from the inside in order to make changes directly.  In addition, there are internal intruders, including those with access to the application, and they need no less control. <br><br>  To solve this problem by WAF is impossible, this is work for the SIEM system.  The case for the protection of a key application is solved in a complex and usually the sources connected to the SIEM include: <br><br><ul><li>  Logs of operating systems for application servers, databases, auxiliary systems, terminal servers. </li><li>  Logs of firewalls separating the application segment from the rest. </li><li>  WAF logs. </li><li>  Application logs (front-end, back-end). </li><li>  Web server logs. </li><li>  Application database logs, at least at the level of authentication, and better at the level of requests to the database itself. </li><li>  VPN logs in case of contractors working with the application via remote connections. </li></ul><br>  Next, an analysis of current risks and vectors of potential attacks, fraudulent operations and violations in the application: <br><br><ul><li>  Monitoring the work of contractors with the application. </li><li>  Supervision of the work of privileged employees. </li><li>  Identify external attacks on the application. </li></ul><br>  On the basis of the vectors defined above, the sources and points of control necessary for the connection are determined in the form of correlation rules that are configured in the SIEM system. <br><br>  The composition of the rules for identifying incidents usually includes three blocks: <br><br><ul><li>  Control of user actions - calls to the application / database, work in it for all types of users, including privileged ones. </li><li>  Control the integrity of key tables, files, registry branches, environment settings, running services and processes. </li><li>  Anomaly detection - collecting profiles based on statistics and further monitoring deviations from it. </li></ul><br>  The overwhelming part of the rules for detecting incidents in the environment of the application does not change much in the basic logic, and customization consists of changing configurations in the Active List.  The same applies to the profiling rules. <br><br>  The content associated with the work of the application itself is created in most cases individually and includes a survey of the system, conducting interviews with owners and developers, and further analytics to find ‚Äúbottlenecks‚Äù. <br><br>  As a summary of the article, I would like to emphasize that the security of key applications and sites is only partly related to external direct threats, and one should always take into account a wider vector of potential attacks and fraudulent operations. </div><p>Source: <a href="https://habr.com/ru/post/332846/">https://habr.com/ru/post/332846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332834/index.html">Superjob php meetup</a></li>
<li><a href="../332836/index.html">Continuous Integration: CircleCI vs Travis CI vs Jenkins</a></li>
<li><a href="../332840/index.html">Automatic text recognition in video</a></li>
<li><a href="../332842/index.html">GitLab CI for continuous integration and delivery in production. Part 2: Overcoming Difficulties</a></li>
<li><a href="../332844/index.html">Study of the sustainability of national segments of the network</a></li>
<li><a href="../332848/index.html">Steam Greenlight and Steam Direct: what indie developers need to know</a></li>
<li><a href="../332850/index.html">GraphQL queries. From simple to more complex</a></li>
<li><a href="../332852/index.html">The five main aspects of poor Internet security</a></li>
<li><a href="../332854/index.html">Experiment: Does Financial Inequality Occur With a Random Distribution of Money?</a></li>
<li><a href="../332856/index.html">Konstantin Budnik, EPAM: ‚ÄúApache Hadoop has moved into the commodity phase - there‚Äôs almost nothing new.‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>