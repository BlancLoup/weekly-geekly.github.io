<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The release of Rails 4.1 has been released. Some subtleties of moving</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On April 8, the official Ruby on Rails blog post reported the official release of Rails 4.1. All functionality fit in 5200 commits. 

 On Habr√© was al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The release of Rails 4.1 has been released. Some subtleties of moving</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b37/479/7d4/b374797d4f42fb0731e23f2797a40a3a.jpg" alt="image"><br>  On April 8, the official Ruby on Rails blog post reported the official release of Rails 4.1.  All functionality fit in 5200 commits. <br><br>  On Habr√© was already a <a href="http://habrahabr.ru/post/207172/">review of the</a> beta version.  You can also read <a href="http://edgeguides.rubyonrails.org/4_1_release_notes.html">Release Notes</a> and <a href="http://edgeguides.rubyonrails.org/upgrading_ruby_on_rails.html">A Guide for Upgrading Ruby on Rails</a> . <br><br>  In the article I would like to highlight some of the subtleties and details of what is under the hood. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Active Record Enums </h4><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Conversation</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class">: [ :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">active</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">archived</span></span></span><span class="hljs-class"> ] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># conversation.update! status: 0 conversation.active! conversation.active? # =&gt; true conversation.status # =&gt; "active" # conversation.update! status: 1 conversation.archived! conversation.archived? # =&gt; true conversation.status # =&gt; "archived" # conversation.update! status: 1 conversation.status = "archived" # conversation.update! status: nil conversation.status = nil conversation.status.nil? # =&gt; true conversation.status # =&gt; nil</span></span></span></span></code> </pre> <br>  Now we have this syntax for enums.  Very tasty, very convenient, but it is important to understand a few points. <br><br>  1. The enumeration is stored as an integer in the database, but can be obtained by name.  (Enum values ‚Äã‚Äãmap to integers in the database, but can be queried by name). <br>  This is what the migration of the example above will look like: <br><pre> <code class="ruby hljs">create_table <span class="hljs-symbol"><span class="hljs-symbol">:conversations</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|t|</span></span> t.column <span class="hljs-symbol"><span class="hljs-symbol">:status</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  In this case, in SQL queries, you will also have to use integers: <br> <code>where('status &lt;&gt; ? OR status &lt;&gt; ?', 0, 1)</code> <br> <code>where('status &lt;&gt; ? OR status &lt;&gt; ?', STATUS[:resolved], STATUS[:rejected])</code> <br>  Note that in this case, STATUS is a class constant that is automatically added by the macro when an enumeration is created. <br><br>  2. The enumeration <u>does not use the</u> ENUM type implemented in some databases.  As a result, you cannot change the order of the values ‚Äã‚Äãin the enumeration after creating records in the database.  This will lead to confusion and conflict.  You also can‚Äôt just delete an unnecessary value.  For this, the correspondence between the string and numeric values ‚Äã‚Äãmust be specified explicitly. <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bug</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">: 0, </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#removed status with id=1 in_progress: 2, resolved: 3, rejected: 4, reopened: 5 } end</span></span></span></span></code> </pre><br>  You can get this hash through <code>Bug.statuses</code> <br><br>  3. There are restrictions on the names of enumeration values. <br>  You cannot call the enum values ‚Äã‚Äãby the names of existing scopes, associations (which is understandable) and already existing enumerations within the same model (which is not obvious).  For example: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bug</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class">: [ :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">closed</span></span></span><span class="hljs-class"> ] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">code_review_status</span></span></span><span class="hljs-class">: [ :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">finished</span></span></span><span class="hljs-class"> ] </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#    end</span></span></span></span></code> </pre><br><br><h4>  New behavior Default scopes </h4><br>  Now the default_scope affects all other scopes by default, unless explicitly stated otherwise. <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default_scope</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pending</span></span></span><span class="hljs-class">' } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">active</span></span></span><span class="hljs-class">, -&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">active</span></span></span><span class="hljs-class">' } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inactive</span></span></span><span class="hljs-class">, -&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inactive</span></span></span><span class="hljs-class">' } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Now <code>User.active</code> will be equivalent to <code>User.where(state: 'pending').where(state: 'active')</code> .  Those.  by default, all scopes chains (chains) to default_scope. <br>  To avoid this, you need to explicitly ‚Äúunhook‚Äù the scope from default_scope with <code>unscope, except, rewhere</code> : <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default_scope</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pending</span></span></span><span class="hljs-class">' } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">active</span></span></span><span class="hljs-class">, -&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unscope</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">active</span></span></span><span class="hljs-class">') } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inactive</span></span></span><span class="hljs-class">, -&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rewhere</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inactive</span></span></span><span class="hljs-class">' } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br><h4>  Extended CSRF protection. </h4><br>  Now, by default, CSRF protection is enabled on get requests with the .js format. <br>  For an honest developer, there are two application implications of this. <br>  Firstly, all the tests that checked the formation of the correct JS code fall down.  To fight this is easy. <br>  Instead <br> <code>post :create, format: :js</code> <br>  We write <br> <code>xhr :post, :create, format: :js</code> <br>  And secondly, if you still need to allow third-party sites to request js code, then you must explicitly specify this by adding a filter to the controller: <br><pre> <code class="ruby hljs">skip_before_filter <span class="hljs-symbol"><span class="hljs-symbol">:verify_authenticity_token</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">only:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:stats</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:visitor</span></span>]</code> </pre><br>  Well, in each action you need to add to the response header: <br><pre> <code class="ruby hljs">response.headers[<span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Origin'</span></span>] = <span class="hljs-string"><span class="hljs-string">'*'</span></span></code> </pre><br>  Or, instead of an asterisk, specify the name of the site that is allowed access. <br><br><hr><br>  While this is all that had to tinker with myself.  Of course, the functionality of the new release of Rails 4.1 is much broader.  But there everything seems to be clear, they have already written about it, moreover, the description of the new functionality, as always, is at its best. <br>  But just in case I will give a list of the rest of Major Features: <br><ul><li>  Added Spring default preloader to new projects </li><li>  Added file <code>config/secrets.yml</code> along with functionality for storing application secrets. </li><li>  Action Pack Variants - the ability to use different answers for different types of devices (tablet, desktop, phone, etc.) </li><li>  Action Mailer Previews - integration of gem MailView in Rails - easy work with letter templates. </li><li>  Message Verifiers - exchange and authentication of important messages. </li><li>  Module # concerning - convenient sharing of responsibilities between classes (to be honest, I don‚Äôt find a situation where I would need this functionality) </li></ul><br>  Officially, MySQL Server 4.1 support has been discontinued (this is if someone else besides me is forced to work with this rare book).  In reality, it still works. </div><p>Source: <a href="https://habr.com/ru/post/219175/">https://habr.com/ru/post/219175/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../219159/index.html">Threshold decoder</a></li>
<li><a href="../219161/index.html">Worn Eyes Will Help You Look Friendly</a></li>
<li><a href="../219163/index.html">Heartbleed and Open Source Misconceptions</a></li>
<li><a href="../219167/index.html">Useful materials for mobile developer # 48 (April 7-13)</a></li>
<li><a href="../219169/index.html">New "Civilization" will be released this fall</a></li>
<li><a href="../219177/index.html">Increase data processing speed with data locality in Hadoop</a></li>
<li><a href="../219179/index.html">Top 5 simple changes that significantly increased conversion</a></li>
<li><a href="../219183/index.html">Smart bookmarks based on Elasticsearch</a></li>
<li><a href="../219185/index.html">The 80/20 principle. Beginner's Guide</a></li>
<li><a href="../219187/index.html">Methods of formation of cost in the procurement unit ERP-systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>