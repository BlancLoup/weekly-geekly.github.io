<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A simple way to not destroy a running Exchange / Lync with playful hands</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How to quickly save IIS security settings? 
 Many administrators were faced with a situation where changing a couple of authorization parameters in II...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A simple way to not destroy a running Exchange / Lync with playful hands</h1><div class="post__text post__text-html js-mediator-article"><h4>  How to quickly save IIS security settings? </h4><br>  Many administrators were faced with a situation where changing a couple of authorization parameters in IIS so that ‚Äúit‚Äôs working right now, as it should, without torturing the user with unnecessary authorization requests‚Äù resulted in a partially <s>completely</s> non-working configuration of the entire system. <br>  Unfortunately, <a href="http://technet.microsoft.com/en-us/library/gg247612(v%3Dexchg.150).aspx">typical IIS settings for the same Exchange 2013</a> in official sources do not cover all possible configurations, in particular Exchange 2010 / Lync 2013 / Exchange 2013 / Edge TMG 2010 coexistence scenarios. The task is to save (write out) all the working settings after the next ‚Äútuning‚Äù often postponed for later.  Typical recommendation: " <a href="http://isazonov.wordpress.com/2013/11/16/%25D0%25BD%25D0%25B5-%25D0%25BC%25D0%25B5%25D0%25BD%25D1%258F%25D0%25B9%25D1%2582%25D0%25B5-%25D0%25BD%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B8-iis-%25D0%25BD%25D0%25B0-%25D1%2581%25D0%25B5%25D1%2580%25D0%25B2%25D0%25B5%25D1%2580%25D0%25B5-%25D1%2581-%25D1%2583%25D1%2581%25D1%2582/">screwed IIS - reinstall the system</a> " - it works, but it takes a lot of time. <br>  But there is a PowerShell! <br>  Analysis of the development of a simple but useful script, designed to reverse the situation, and is given in this article. <br><a name="habracut"></a><br>  First of all, we need to decide on the sites whose settings you want to save.  In my case, already at this step there were discrepancies with the typical setting.  IIS on the Exchange 2013 server reinstalled after the intervention of skilled hands was somewhat different in appearance from what was expected: <br><img src="https://habrastorage.org/getpro/habr/post_images/888/998/699/8889986993b379fdbcbd1a5040420d3e.png"><br>  Therefore, saving the settings ‚Äúas is‚Äù is necessary not for one but two sites. <br>  Well, we get sites: <br><pre>  # for each of the found sites perform a few simple steps 
 get website |  ForEach-Object-Process {
 # getting application path to character variable 
 $ xPath = "IIS: \ sites \" + $ _. Name 
 # transition in the IIS $ xPath namespace 
 cd $ xPath 
 # output for clarity, where we hit 
 $ xPath
 # getting a collection of web applications in the current site 
 $ myWebApp = get-webApplication 
 # output all members of the collection  
 $ myWebApp 
 }
</pre><br><br><div class="spoiler">  <b class="spoiler_title">The result of the script:</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/b56/db9/9b4/b56db99b4c433b539743c010221189c1.png" alt="The result of the script - a list of applications in all sites"><br></div></div><br><br>  Application directories on hand, what does this give us? <br>  And here is what: now we can get an authentication method for each of them! <br>  A good description of how to get to these settings is <a href="http://www.iis.net/learn/manage/powershell/powershell-snap-in-changing-simple-settings-in-configuration-sections">on this link.</a> <br>  For example, the code that displays whether basic authentication is enabled for the $ WebApp application in the Exchange Back End site: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre>  (Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/basicAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ WebApp.Path) .value </pre><br><br>  We need to ‚Äúwrap‚Äù this code in an iterator in order not to enter the name of the site and the application itself.  Those.  one iterator will run around the sites, and inside it, the loop will bypass all site applications. <br><br>  To make it easier, let's first get the settings for only one site, and display the result by simply outputting the values ‚Äã‚Äãof variables: <br>  Option script number 1: <br><br><pre> get-webSite
 cd IIS: \ Sites \ "Exchange Back End"
 get-webApplication |  ForEach-Object -process { 
 $ propPath = $ _. Path
 $ propAA = (Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/anonymousAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value 
 $ propBA = (Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/basicAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value 
 $ propCA = (Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/clientCertificateMappingAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value 
 $ propDA = (Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/digestAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value 
 $ propIA = (Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/iisClientCertificateMappingAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value 
 $ propWA = (Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/windowsAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value 
 $ _. Path;  $ propAA;  $ propBA;  $ propCA;  $ propDA;  $ propIA;  $ propWA;
 } 
</pre><br><br>  Already working, but ugly and not on all sites. <br>  In powerShell there is a wonderful output formatting command: <b>Format-Table</b> , let's put it into practice: <br><br><pre> # Script text
 get-webSite
 cd IIS: \ Sites \ "Exchange Back End"
 $ myWebApp = get-webApplication
 $ myWebApp |  Format-Table -AutoSize Path, 
 @ {Label = "anonim:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/anonymousAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value}},
 @ {Label = "Basic:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/basicAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value}},
 @ {Label = "ClientCert:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/clientCertificateMappingAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value}},
 @ {Label = "Digest:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/digestAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value}},
 @ {Label = "IIS client Cert:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/iisClientCertificateMappingAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value}},
 @ {Label = "Windows";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/windowsAuthentication -Name Enabled -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .value}},
 @ {Label = "SSL Flags";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/access -Name * -PSPath IIS: \ sites \ "Exchange Back End" -location $ _. Path) .SSLflags}}

 cd IIS: \ Sites \ "Default Web Site"
 $ myWebApp = get-webApplication
 $ myWebApp |  Format-Table -AutoSize Path, 
 @ {Label = "anonim:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/anonymousAuthentication -Name Enabled -PSPath IIS: \ sites \ "Default Web Site" -location $ _. Path) .value}},
 @ {Label = "Basic:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/basicAuthentication -Name Enabled -PSPath IIS: \ sites \ "Default Web Site" -location $ _. Path) .value}},
 @ {Label = "ClientCert:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/clientCertificateMappingAuthentication -Name Enabled -PSPath IIS: \ sites \ "Default Web Site" -location $ _. Path) .value}},
 @ {Label = "Digest:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/digestAuthentication -Name Enabled -PSPath IIS: \ sites \ "Default Web Site" -location $ _. Path) .value}},
 @ {Label = "IIS client Cert:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/iisClientCertificateMappingAuthentication -Name Enabled -PSPath IIS: \ sites \ "Default Web Site" -location $ _. Path) .value}},
 @ {Label = "Windows";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/windowsAuthentication -Name Enabled -PSPath IIS: \ sites \ "Default Web Site" -location $ _. Path) .value}},
 @ {Label = "SSL Flags";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/access -Name * -PSPath IIS: \ sites \ "Default Web Site" -location $ _. Path) .SSLflags}}
 

</pre><br>  Here, Format-Table acts as an iterator, and I also added the SSL flag, which is significant and often lost after the ‚Äúexperiments‚Äù. <br><br>  In order not to write wild repeating code, entering the site name with your hands, let's add an iterator over the sites, as was done at the very beginning of the article: <br><br>  The final version of the script: <br><br><br><pre> get website |  ForEach-Object-Process { 
 $ xSite = "IIS: \ sites \" + $ _. Name  
 cd $ xSite  
 $ xSite 
 $ myWebApp = get-webApplication
 $ myWebApp |  Format-Table -AutoSize Path, 
 @ {Label = "anonim:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/anonymousAuthentication -Name Enabled -PSPath $ xSite -location $ _. Path) .value}},
 @ {Label = "Basic:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/basicAuthentication -Name Enabled -PSPath $ xSite -location $ _. Path) .value}},
 @ {Label = "ClientCert:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/clientCertificateMappingAuthentication -Name Enabled -PSPath $ xSite -location $ _. Path) .value}},
 @ {Label = "Digest:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/digestAuthentication -Name Enabled -PSPath $ xSite -location $ _. Path) .value}},
 @ {Label = "IIS client Cert:";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/iisClientCertificateMappingAuthentication -Name Enabled -PSPath $ xSite -location $ _. Path) .value}},
 @ {Label = "Windows";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/authentication/windowsAuthentication -Name Enabled -PSPath $ xSite -location $ _. Path) .value}},
 @ {Label = "SSL Flags";  Expression = {(Get-WebConfigurationProperty -Filter /system.webServer/security/access -Name * -PSPath $ xSite -location $ _. Path) .SSLflags}}
 } 

</pre><br><br>  In this variant, $ _ within the Format-Table command refers to the current application, and $ _ in the second line refers to the current site from the ForEach-Object iterator. <br><br>  So, at the output we get an excellent picture, which allows restoring the changed settings so irrelevant. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aff/aef/903/affaef9037316fdba4bbd59fb85f2503.png" alt="The result of the script is a table of application authorization methods."><br><br>  The options for screwing the output to a file with logging time and the host name where it was performed there are many, here they were not considered.  There is room for improvement. <br><br>  I have already launched this script on all IIS in my organization, and now if I‚Äôm going to change something, I‚Äôll have a chance to remember what I‚Äôve changed.  just comparing the picture "before" and "after."  Comments on further improvements are welcome.  About backups and the inadmissibility of changing something on the ‚Äúcombat‚Äù servers in the course, but life is complicated and there are exceptions to the rules. <br><br>  I hope that my humble experience will save someone time. </div><p>Source: <a href="https://habr.com/ru/post/204454/">https://habr.com/ru/post/204454/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204442/index.html">"Lisp in Small Pieces" in Russian</a></li>
<li><a href="../204446/index.html">Timelapse timer on arduino</a></li>
<li><a href="../204448/index.html">Intel processors for tablets and smartphones - plans for the near future</a></li>
<li><a href="../204450/index.html">Glyndwr University or another article about education abroad</a></li>
<li><a href="../204452/index.html">Turning a Chromebook into a full-fledged working laptop</a></li>
<li><a href="../204458/index.html">WorldSkills Russia professional skills competition</a></li>
<li><a href="../204464/index.html">Caching Tutorial Part 2</a></li>
<li><a href="../204466/index.html">Microsoft Robotics. Parallel data processing</a></li>
<li><a href="../204470/index.html">Calculation of the position of celestial bodies in the sky. Part 1</a></li>
<li><a href="../204474/index.html">Furious bulls: how Wall Street became dependent on "high-speed" trades. Part 5 (and last)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>