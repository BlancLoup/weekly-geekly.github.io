<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Realtime on your resource in a few minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="During the development of the game, we were faced with the need to ensure maximum real-time data exchange between users, which led to experiments with...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Realtime on your resource in a few minutes</h1><div class="post__text post__text-html js-mediator-article">  During the development of the game, we were faced with the need to ensure maximum real-time data exchange between users, which led to experiments with various comet libraries. <br>  The first bike was built on dklab realplexor, which, as it was once again attempted to use it, as expected, let us down.  Maybe our hands are crooked, but unfortunately we didn‚Äôt manage to get events without delays of 5-10-15 seconds. <br>  Dancing with a tambourine lasted a long time, with the result that we decided to stop at <b>nginx_http_push_module</b> , and the time spent was still worth it. <br><a name="habracut"></a><br>  The main problems that have arisen when working with this module: <br><ul><li>  A disabled cache entails a loss of events (a cycle of 250 passes gave the client only 3 events). </li><li>  The included cache entails a recursive receipt of the last event. </li></ul><br><br>  Among the shortcomings, it is possible to single out only the impossibility of sending messages to several channels at the same time, at the level of the library itself, which is in realplexor, as well as the lack of storing several events coming to the channel in a short period of time (reconnect time). <br><br>  A little jaggle helped find the JS function, which, at first glance, solved the problem: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Listener</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, successCallback, failureCallback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> etag = <span class="hljs-number"><span class="hljs-number">0</span></span>, lastModified = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> launched = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> failure = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.successTimeout = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.failureTimeout = <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getTimeout = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> failure ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.failureTimeout : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.successTimeout; }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> listen = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $.ajax(scope.ajaxOptions); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> beforeSend = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">jqXHR</span></span></span><span class="hljs-function">) </span></span>{ jqXHR.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"If-None-Match"</span></span>, etag); jqXHR.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"If-Modified-Since"</span></span>, lastModified); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> complete = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">jqXHR</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeout = getTimeout(); etag = jqXHR.getResponseHeader(<span class="hljs-string"><span class="hljs-string">'Etag'</span></span>); lastModified = jqXHR.getResponseHeader(<span class="hljs-string"><span class="hljs-string">'Last-Modified'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeout = jqXHR.statusText == <span class="hljs-string"><span class="hljs-string">'success'</span></span> ? scope.successTimeout : scope.failureTimeout; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { setTimeout(listen, timeout); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { listen(); } }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ajaxOptions = { <span class="hljs-attr"><span class="hljs-attr">url</span></span> : url, <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-attr"><span class="hljs-attr">async</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">error</span></span> : failureCallback, <span class="hljs-attr"><span class="hljs-attr">success</span></span> : successCallback, <span class="hljs-attr"><span class="hljs-attr">dataType</span></span> : <span class="hljs-string"><span class="hljs-string">'json'</span></span>, <span class="hljs-attr"><span class="hljs-attr">complete</span></span> : complete, <span class="hljs-attr"><span class="hljs-attr">beforeSend</span></span> : beforeSend, <span class="hljs-attr"><span class="hljs-attr">timeout</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">24</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.start = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">timeout</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!launched) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(timeout) == <span class="hljs-string"><span class="hljs-string">'undefined'</span></span> || timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>) { listen(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { setTimeout(listen, timeout); } launched = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }; }</code> </pre> <br><br>  A few dances with tambourines made it clear that she has her own skeletons in the closet: <br><ul><li>  If several events have arrived at the client, and immediately after this the refresh of the page follows - they will come to you again (from the cache). </li><li>  If the tab was inactive for a long time - the requester died, and was no longer processed before refreshing the page. </li></ul><br><br>  The first problem was resolved quite simply, replacing <br> <code>var etag = 0, lastModified = 0;</code> <br>  on <br> <code>var etag = 0: <br> lastModified = LOAD_TIME;</code> <br>  where <b>LOAD_TIME</b> was set by a constant in the index, as <br> <code>var LOAD_TIME = "&lt;?=date('r');?&gt;";</code> <br>  The second problem, I hoped, would be solved just as easily by replacing <br> <code>timeout: 1000 * 60 * 60 * 24</code> <br>  on <br> <code>timeout: 1000 * 20</code> <br>  creating a forced reconnect to nginx every X seconds (in our case, the optimal interval was 20 seconds). <br>  But when he started testing, he got even more collisions than before - after the reconstructions the hellish flood of events began.  Thank you console, for clarifying the situation.  The problem was that when the check did a reconnect, the complete handler continued to update the data on the headers, so the following request went off with If-None-Match and If-Modified-Since null. <br><br>  In the end, got the most stable function: <br><br><pre> <code class="javascript hljs">&lt;script&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> LOAD_TIME = <span class="hljs-string"><span class="hljs-string">"&lt;?=date('r');?&gt;"</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* * !        ,      ,   index.php,     JS ,    . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Listener</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, successCallback, failureCallback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> etag = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastModified = LOAD_TIME; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> launched = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> failure = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.successTimeout = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.failureTimeout = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getTimeout = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> failure ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.failureTimeout : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.successTimeout; }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> listen = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $.ajax(scope.ajaxOptions); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> beforeSend = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">jqXHR</span></span></span><span class="hljs-function">) </span></span>{ jqXHR.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"If-None-Match"</span></span>, etag); jqXHR.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"If-Modified-Since"</span></span>, lastModified); cw(<span class="hljs-string"><span class="hljs-string">"BEFORE None-Match : "</span></span>+etag); cw(<span class="hljs-string"><span class="hljs-string">"BEFORE Modified : "</span></span>+lastModified); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> complete = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">jqXHR</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeout = getTimeout(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (jqXHR.getResponseHeader(<span class="hljs-string"><span class="hljs-string">'Etag'</span></span>) != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; jqXHR.getResponseHeader(<span class="hljs-string"><span class="hljs-string">'Last-Modified'</span></span>) != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { etag = jqXHR.getResponseHeader(<span class="hljs-string"><span class="hljs-string">'Etag'</span></span>); lastModified = jqXHR.getResponseHeader(<span class="hljs-string"><span class="hljs-string">'Last-Modified'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeout = jqXHR.statusText == <span class="hljs-string"><span class="hljs-string">'success'</span></span> ? scope.successTimeout : scope.failureTimeout; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { setTimeout(listen, timeout); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { listen(); } }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ajaxOptions = { <span class="hljs-attr"><span class="hljs-attr">url</span></span> : url, <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-attr"><span class="hljs-attr">async</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">error</span></span> : failureCallback, <span class="hljs-attr"><span class="hljs-attr">success</span></span> : successCallback, <span class="hljs-attr"><span class="hljs-attr">dataType</span></span> : <span class="hljs-string"><span class="hljs-string">'json'</span></span>, <span class="hljs-attr"><span class="hljs-attr">complete</span></span> : complete, <span class="hljs-attr"><span class="hljs-attr">beforeSend</span></span> : beforeSend, <span class="hljs-attr"><span class="hljs-attr">timeout</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span> * <span class="hljs-number"><span class="hljs-number">20</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.start = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">timeout</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!launched) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(timeout) == <span class="hljs-string"><span class="hljs-string">'undefined'</span></span> || timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>) { listen(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { setTimeout(listen, timeout); } launched = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.start(); } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/script&gt;</span></span></code> </pre> <br><br>  Calling an event handler looks like this: <br><br><pre> <code class="javascript hljs">&lt;script&gt; $(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ Listener(<span class="hljs-string"><span class="hljs-string">'/listener?cid=chanel_1'</span></span>, onSuccess, onError); }); <span class="hljs-comment"><span class="hljs-comment">/* *onSuccess  onError -   ( )    ,        . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSuccess</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data) { $(<span class="hljs-string"><span class="hljs-string">"#messages"</span></span>).prepend(data.time + <span class="hljs-string"><span class="hljs-string">" | "</span></span> +data.msg); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"EMPTY DATA"</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ alert(<span class="hljs-string"><span class="hljs-string">"ERROR"</span></span>); } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/script&gt;</span></span></code> </pre> <br><br>  Since in the examples on the module site there is no code that could send a message to several channels at once, we decided to write our own function. <br>  Implementation in php: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($cids, $text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* * $cids - ID ,  ,     - ID  * $text - ,    */</span></span> $c = curl_init(); $url = <span class="hljs-string"><span class="hljs-string">'http://server_name/publisher?cid='</span></span>; $message = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'time'</span></span> =&gt; time(), <span class="hljs-string"><span class="hljs-string">'msg'</span></span> =&gt; $text ); curl_setopt($c, CURLOPT_RETURNTRANSFER, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); curl_setopt($c, CURLOPT_POST, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array($cids)) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($cids <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $v) { curl_setopt($c, CURLOPT_URL, $url.$v); curl_setopt($c, CURLOPT_POSTFIELDS, json_encode($message)); $r = curl_exec($c); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { curl_setopt($c, CURLOPT_URL, $url.$cids); curl_setopt($c, CURLOPT_POSTFIELDS, json_encode($message)); $r = curl_exec($c); } curl_close($c); } <span class="hljs-comment"><span class="hljs-comment">// push (1, ""); // push (array(1, 2, 3), ""); // push (array('chanel_1' =&gt; 1, 'chanel_2' =&gt; 'user_100500', 'chanel_3' =&gt; 'global'), "");</span></span></code> </pre><br><br>  With the installation of Dklab Realplexor, no problems arose and full documentation is available on the website (http://dklab.ru/lib/dklab_realplexor) of the developer. <br>  However, with <b>nginx_http_push_module,</b> everything is not so simple, to be honest, on <b>CentOS, the</b> finished package including this module could not be found, so everything was collected from the sources. <br><br>  So let's start: <br><br>  Create a daddy where we will download all the necessary elements. <br><pre> <code class="bash hljs">mkdir ~/nginx_push; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/nginx_push;</code> </pre> <br><br>  Download the latest sources from the githab: <br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git://github.com/slact/nginx_http_push_module.git</code> </pre> <br><br>  We download the latest version of nginx, in our case it is nginx-1.1.15 <br><pre> <code class="bash hljs">wget http://nginx.org/download/nginx-1.1.15.tar.gz;</code> </pre> <br><br>  Downloading additional required libraries: <br><pre> <code class="bash hljs">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.21.tar.gz; wget http://zlib.net/zlib-1.2.6.tar.gz;</code> </pre> <br><br>  Unpack archives: <br><pre> <code class="bash hljs">tar -zxf nginx-1.1.15.tar.gz; tar -zxf pcre-8.21.tar.gz tar -zxf zlib-1.2.6.tar.gz</code> </pre> <br><br>  Go to the source folder of nginx <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nginx-1.1.15;</code> </pre> <br><br>  And configure nginx <br><br><pre> <code class="bash hljs">./configure --prefix=/usr --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/error.log --pid-path=/var/run/nginx/nginx.pid --lock-path=/var/lock/nginx.lock --user=nginx --group=nginx --with-http_ssl_module --with-http_gzip_static_module --http-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/access.log --http-client-body-temp-path=/tmp/nginx/client/ --http-proxy-temp-path=/tmp/nginx/proxy/ --http-fastcgi-temp-path=/tmp/nginx/fcgi --with-pcre=../pcre-8.21 --with-zlib=../zlib-1.2.6 --with-http_perl_module --with-http_stub_status_module ‚Äìadd-module=../nginx_http_push_module/</code> </pre> <br><br>  Then <br><br><pre> <code class="bash hljs">make make install</code> </pre> <br><br>  now create the file /etc/init.d/nginx <br><pre> <code class="bash hljs">nano /etc/init.d/nginx;</code> </pre> <br><br>  and put there such a script: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ### BEGIN INIT INFO # Provides: nginx # Required-Start: $local_fs $remote_fs $network $syslog # Required-Stop: $local_fs $remote_fs $network $syslog # Default-Start: 2 3 4 5 # Default-Stop: 0 1 6 # Short-Description: starts the nginx web server # Description: starts nginx using start-stop-daemon ### END INIT INFO PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin DAEMON=/usr/sbin/nginx NAME=nginx DESC=nginx # Include nginx defaults if available if [ -f /etc/default/nginx ]; then . /etc/default/nginx fi test -x $DAEMON || exit 0 set -e . /lib/lsb/init-functions test_nginx_config() { if $DAEMON -t $DAEMON_OPTS &gt;/dev/null 2&gt;&amp;1; then return 0 else $DAEMON -t $DAEMON_OPTS return $? fi } case "$1" in start) echo -n "Starting $DESC: " test_nginx_config # Check if the ULIMIT is set in /etc/default/nginx if [ -n "$ULIMIT" ]; then # Set the ulimits ulimit $ULIMIT fi start-stop-daemon --start --quiet --pidfile /var/run/$NAME.pid \ --exec $DAEMON -- $DAEMON_OPTS || true echo "$NAME." ;; stop) echo -n "Stopping $DESC: " start-stop-daemon --stop --quiet --pidfile /var/run/$NAME.pid \ --exec $DAEMON || true echo "$NAME." ;; restart|force-reload) echo -n "Restarting $DESC: " start-stop-daemon --stop --quiet --pidfile \ /var/run/$NAME.pid --exec $DAEMON || true sleep 1 test_nginx_config start-stop-daemon --start --quiet --pidfile \ /var/run/$NAME.pid --exec $DAEMON -- $DAEMON_OPTS || true echo "$NAME." ;; reload) echo -n "Reloading $DESC configuration: " test_nginx_config start-stop-daemon --stop --signal HUP --quiet --pidfile /var/run/$NAME.pid \ --exec $DAEMON || true echo "$NAME." ;; configtest|testconfig) echo -n "Testing $DESC configuration: " if test_nginx_config; then echo "$NAME." else exit $? fi ;; status) status_of_proc -p /var/run/$NAME.pid "$DAEMON" nginx &amp;&amp; exit 0 || exit $? ;; *) echo "Usage: $NAME {start|stop|restart|reload|force-reload|status|configtest}" &gt;&amp;2 exit 1 ;; esac exit 0</span></span></code> </pre> <br><br>  And now <br><pre> <code class="bash hljs">chkconfig --add nginx chkconfig --level 345 nginx on</code> </pre> <br><br>  Everything.  At this point, the nginx installation is complete, and you can start the nginx service. <br><pre> <code class="bash hljs">service nginx start</code> </pre> <br><br>  Now let's go to the settings: <br><br>  <b>/ publisher</b> - is used to write to the channel and should be available only to your server, otherwise anyone can write to it. <br><pre> <code class="bash hljs">location /publisher { //     ,     ?cid= <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$push_channel_id</span></span> <span class="hljs-variable"><span class="hljs-variable">$arg_cid</span></span>; push_publisher; push_message_timeout 1m; //    push_message_buffer_length 20000; //   allow 127.0.0.1; deny all; }</code> </pre> <br><br>  <b>/ listener</b> - is available to everyone and serves to distribute messages to channel subscribers. <br><pre> <code class="bash hljs">location /listener { //     ,     ?cid= <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$push_channel_id</span></span> <span class="hljs-variable"><span class="hljs-variable">$arg_cid</span></span>; push_subscriber; push_subscriber_concurrency broadcast; default_type text/plain; }</code> </pre> <br><br>  On this setting everything.  The solution is good for everyone, but we have difficulty setting up crossdomain-ajax, and in the module, in the main branch, there is no jsonp support at the moment.  BUT, a fork was found with this functionality (https://github.com/Kronuz/nginx_http_push_module).  Its installation does not differ from the original. <br><br>  To enable jsonp support in the location / listener section, add <br><pre> <code class="bash hljs">//     /?callback= push_channel_jsonp_callback <span class="hljs-variable"><span class="hljs-variable">$arg_callback</span></span>;</code> </pre> <br><br>  Now, if the data is transferred to the callback parameter, the module will wrap the data in jsonp. <br><br>  There is no separate demo, but registered users in VK can see the work on a live example in our game - <a href="http://vk.com/app2814545">vk.com/app2814545</a> <br>  Fights were built on this technology (in fact, they demanded this rialtime), casinos, reports about receiving / spending resources and many other events. </div><p>Source: <a href="https://habr.com/ru/post/139339/">https://habr.com/ru/post/139339/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139328/index.html">What do you need from the forms?</a></li>
<li><a href="../139329/index.html">Stopwatch on CSS3 without pictures, scripts and SMS</a></li>
<li><a href="../139335/index.html">Instagram has grown to 25 million users: the largest social network on a mobile platform</a></li>
<li><a href="../139337/index.html">Mutation testing on the example of Pitest</a></li>
<li><a href="../139338/index.html">App Store Reaches 25 Billion Downloads</a></li>
<li><a href="../139340/index.html">Developing a simple Eclipse RCP application.</a></li>
<li><a href="../139341/index.html">Khan Academy will use JavaScript to teach programming</a></li>
<li><a href="../139342/index.html">Electronic necklace. Part 2</a></li>
<li><a href="../139343/index.html">Cellular operators will not give SMS without a fight</a></li>
<li><a href="../139344/index.html">Building the Microsoft Detours Library under Visual Studio 2008</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>