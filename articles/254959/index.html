<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ansible - let's try</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ansible is a relatively young configuration management system, its history goes back a little over three years. But despite this, he quickly and quick...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ansible - let's try</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://www.ansible.com/home">Ansible</a> is a relatively young configuration management system, its history goes back a little over three years.  But despite this, he quickly and quickly broke into the world of configuration management systems, displacing Chef, Puppet and SaltStack. <br><br>  Let's look at him closely to see why he is so loved by techies. <br><br>  So, what is good ansbile: <br><ul><li>  low entry threshold; </li><li>  declarative configuration language; </li><li>  no additional software is required on managed nodes; </li><li>  just write an extra module. </li></ul><br><a name="habracut"></a><br><h2>  Low entry threshold </h2><br>  You can start using ansible in a couple of minutes.  Let's say you are using OSX. <br><pre><code class="hljs sql">$ brew <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> ansible $ ansible <span class="hljs-comment"><span class="hljs-comment">--version ansible 1.8.4 configured module search path = None</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now create the <code>hosts</code> : <br><pre> <code class="hljs bash">[<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>] localhost ansible_connection=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span></code> </pre><br><br>  Go: <br><pre> <code class="hljs pgsql">$ ansible -i hosts -m ping <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> localhost | success &gt;&gt; { "changed": <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, "ping": "pong" }</code> </pre><br>  What have we done?  For all hosts ( <code>all</code> parameter) from the hosts file, execute the ping module.  Let's see something else. <br><br><div class="spoiler">  <b class="spoiler_title">ansible -i hosts -a 'ls -lah' all</b> <div class="spoiler_text"><pre> <code class="hljs ruby">$ ansible -i hosts -a <span class="hljs-string"><span class="hljs-string">"ls -lah"</span></span> all localhost <span class="hljs-params"><span class="hljs-params">| success |</span></span> rc=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>total <span class="hljs-number"><span class="hljs-number">12</span></span>K drwxr-xr-x <span class="hljs-number"><span class="hljs-number">5</span></span> brun staff <span class="hljs-number"><span class="hljs-number">170</span></span> Apr <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">50</span></span> . drwxr-xr-x <span class="hljs-number"><span class="hljs-number">91</span></span> brun staff <span class="hljs-number"><span class="hljs-number">3.1</span></span>K Apr <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">37</span></span> .. -rw-r--r-- <span class="hljs-number"><span class="hljs-number">1</span></span> brun staff <span class="hljs-number"><span class="hljs-number">230</span></span> Apr <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">07</span></span> export.sh -rw-r--r-- <span class="hljs-number"><span class="hljs-number">1</span></span> brun staff <span class="hljs-number"><span class="hljs-number">42</span></span> Apr <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">48</span></span> hosts -rw-r--r-- <span class="hljs-number"><span class="hljs-number">1</span></span> brun staff <span class="hljs-number"><span class="hljs-number">376</span></span> Apr <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">49</span></span> playbook.yml</code> </pre><br></div></div><br><br>  If the module (the <code>-m</code> key) is not specified, the <a href="http://docs.ansible.com/command_module.html">command</a> module is used.  In fact, ansible can be used not only as a configuration management system, but also as a framework for distributed command execution. <br><br><h2>  Declarative configuration language </h2><br>  In addition to the ansible utility, there is the ansible-playbook utility that you will use most often. <br><br>  For further examples, I started the t2.micro machine on aws with Ubuntu 14.04 and registered it in hosts. <br><pre> <code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">hosts</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[web]</span></span> 111<span class="hljs-selector-class"><span class="hljs-selector-class">.111</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.111</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.111</span></span></code> </pre><br>  Also, in order not to enter parameters into the command line every time, I created a file, <code>ansible.cfg</code> , in the project directory. <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># ansible.cfg [defaults] hostfile = hosts</span></span></code> </pre><br><br>  After that, create our first script (playbook in ansible terminology) <code>web.yml</code> . <br><br><div class="spoiler">  <b class="spoiler_title">web.yml</b> <div class="spoiler_text"><pre> <code class="hljs delphi"># web.yml --- - hosts: all user: ubuntu tasks: - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Update apt cache apt: update_cache=yes sudo: yes - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Install required packages apt: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=<span class="hljs-comment"><span class="hljs-comment">{{ item }</span></span>} sudo: yes with_items: - nginx - postgresql</code> </pre><br></div></div><br><br>  We start our first script, which updates the apt cache, and then installs two packages: nginx and postgresql. <br><div class="spoiler">  <b class="spoiler_title">ansible-playbook web.yml</b> <div class="spoiler_text"><pre> <code class="hljs markdown">$ ansible-playbook web.yml PLAY [all] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*** GATHERING FACTS **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [111.111.111.111] TASK: [Update apt cache] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*** ok: [111.111.111.111] TASK: [Install required packages] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*** changed: [111.111.111.111] =&gt; (item=nginx,postgresql) PLAY RECAP **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>* 111.111.111.111 : ok=3 changed=1 unreachable=0 failed=0</code> </pre><br></div></div><br>  In fact, we called the <a href="http://docs.ansible.com/apt_module.html">apt module</a> twice, only with different parameters.  The script file itself <a href="https://ru.wikipedia.org/wiki/YAML">is a Yaml language file</a> interspersed with the <a href="http://jinja.pocoo.org/">Jinja2</a> template engine. <br><br><h2>  No additional software needs to be installed on managed nodes. </h2><br>  Indeed, in order to control the machine, it must have Python installed (and it is installed by default on all modern linux systems) and must have ssh access.  Compare this with other systems where it is necessary to deliver a client who needs specific versions of different languages ‚Äã‚Äãand libraries.  This fact, by the way, makes starting with ansible much easier than for other systems. <br><br><h2>  Just write an extra module. </h2><br>  A module can be written in any language, it should be able to accept input parameters and issue json in response.  But why write a new module if there <a href="http://docs.ansible.com/list_of_all_modules.html">are</a> already <a href="http://docs.ansible.com/list_of_all_modules.html">242 modules</a> for all occasions (in version 1.8.4).  In case you really lack something, there is a <a href="http://docs.ansible.com/developing_modules.html">good description of how to write your module</a> . <br><br><h2>  Something serious </h2><br>  I would not want to make a huge sheet of the script, so let's split the script into parts using the mechanism of roles. <br><br>  For those who are too lazy to write something themselves, there are already thousands of ready-made roles on the <a href="https://galaxy.ansible.com/list">ansible galaxy</a> site, and they are of quite decent quality in order to use them in battle. <br><br>  We will create a pure role. <br><div class="spoiler">  <b class="spoiler_title">ansible-galaxy init nginx -p roles</b> <div class="spoiler_text"><pre> <code class="hljs dos">$ ansible-galaxy init nginx -p roles - nginx was created successfully $ <span class="hljs-built_in"><span class="hljs-built_in">tree</span></span> ‚îú‚îÄ‚îÄ roles ‚îÇ  ‚îî‚îÄ‚îÄ nginx ‚îÇ  ‚îú‚îÄ‚îÄ README.<span class="hljs-built_in"><span class="hljs-built_in">md</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ defaults ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ main.yml ‚îÇ  ‚îú‚îÄ‚îÄ files ‚îÇ  ‚îú‚îÄ‚îÄ handlers ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ main.yml ‚îÇ  ‚îú‚îÄ‚îÄ meta ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ main.yml ‚îÇ  ‚îú‚îÄ‚îÄ tasks ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ main.yml ‚îÇ  ‚îú‚îÄ‚îÄ templates ‚îÇ  ‚îî‚îÄ‚îÄ vars ‚îÇ  ‚îî‚îÄ‚îÄ main.yml</code> </pre><br></div></div><br><br>  <code>web.yml</code> finish the <code>web.yml</code> file. <br><div class="spoiler">  <b class="spoiler_title">web.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">--- - hosts: all user: ubuntu sudo: yes roles: - nginx</span></span></code> </pre><br></div></div><br>  Note the <code>sudo: yes</code> key.  He allows not to write this line in each task.  Most administrative tasks should still run as <code>root</code> , so it makes sense to leave it here. <br><br>  And in the <code>roles/nginx/tasks/main.yml</code> we write the following: <br><br><div class="spoiler">  <b class="spoiler_title">roles / nginx / tasks / main.yml</b> <div class="spoiler_text"><pre> <code class="hljs delphi">--- - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Update apt cache apt: update_cache=yes - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Install required packages apt: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=nginx</code> </pre><br></div></div><br><br>  Using roles, you can reuse code (although whether Yaml code is a philosophical question).  Of course, the example is intentionally simplified, but it becomes clear from it how to organize projects with a large number of components into ansible. <br><br><h2>  Data </h2><br>  In ansible there is a built-in <code>setup</code> module that is run first for all managed nodes.  Let's see what he does. <br><br><div class="spoiler">  <b class="spoiler_title">ansible -m setup all -u ubuntu</b> <div class="spoiler_text"><pre> <code class="hljs ruby">$ ansible -m setup all -u ubuntu <span class="hljs-string"><span class="hljs-string">"ansible_facts"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ansible_all_ipv4_addresses"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"172.31.7.80"</span></span> ], <span class="hljs-string"><span class="hljs-string">"ansible_architecture"</span></span>: <span class="hljs-string"><span class="hljs-string">"x86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"ansible_bios_date"</span></span>: <span class="hljs-string"><span class="hljs-string">"12/03/2014"</span></span>, <span class="hljs-string"><span class="hljs-string">"ansible_bios_version"</span></span>: <span class="hljs-string"><span class="hljs-string">"4.2.amazon"</span></span>, <span class="hljs-string"><span class="hljs-string">"ansible_cmdline"</span></span>: { <span class="hljs-string"><span class="hljs-string">"BOOT_IMAGE"</span></span>: <span class="hljs-string"><span class="hljs-string">"/boot/vmlinuz-3.13.0-44-generic"</span></span>, <span class="hljs-string"><span class="hljs-string">"console"</span></span>: <span class="hljs-string"><span class="hljs-string">"ttyS0"</span></span>, <span class="hljs-string"><span class="hljs-string">"ro"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"root"</span></span>: <span class="hljs-string"><span class="hljs-string">"UUID=fd803688-5c41-4188-8a06-382a65a520bf"</span></span> }, <span class="hljs-string"><span class="hljs-string">"ansible_default_ipv4"</span></span>: { <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"172.31.7.80"</span></span>, <span class="hljs-string"><span class="hljs-string">"alias"</span></span>: <span class="hljs-string"><span class="hljs-string">"eth0"</span></span>, <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>: <span class="hljs-string"><span class="hljs-string">"172.31.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"interface"</span></span>: <span class="hljs-string"><span class="hljs-string">"eth0"</span></span>, <span class="hljs-string"><span class="hljs-string">"macaddress"</span></span>: <span class="hljs-string"><span class="hljs-string">"06:a8:07:41:47:a5"</span></span>, <span class="hljs-string"><span class="hljs-string">"mtu"</span></span>: <span class="hljs-number"><span class="hljs-number">9001</span></span>, <span class="hljs-string"><span class="hljs-string">"netmask"</span></span>: <span class="hljs-string"><span class="hljs-string">"255.255.240.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"network"</span></span>: <span class="hljs-string"><span class="hljs-string">"172.31.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"ether"</span></span> } ...   </code> </pre><br></div></div><br>  The setup module collects various data for the node, it is an analogue of ohai in chef (by the way, ansible can also use ohai to collect information).  All this data can then be used in scripts and templates.  For example, the default ip address can be obtained by referring to the variable <code>ansible_default_ipv4</code> . <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># web.yml tasks: - debug: msg={{ansible_default_ipv4}}</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">ansible-playbook web.yml</b> <div class="spoiler_text"><pre> <code class="hljs markdown">$ ansible-playbook web.yml PLAY [all] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*** GATHERING FACTS **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [111.111.111.111] TASK: [debug msg="{{ansible_default_ipv4}}"] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">***</span></span> ok: [111.111.111.111] =&gt; { "msg": "{u'macaddress': u'06:a8:07:41:47:a5', u'network': u'172.31.0.0', u'mtu': 9001, u'alias': u'eth0', u'netmask': u'255.255.240.0', u'address': u'172.31.7.80', u'interface': u'eth0', u'type': u'ether', u'gateway': u'172.31.0.1'}" }</code> </pre><br></div></div><br><br><h2>  Templates </h2><br>  In ansible there are templates that use the template Jinja2.  Let's make 2 templates. <br><br><pre> <code class="hljs pgsql"># roles/nginx/templates/ansible.conf.j2 <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> default_server; root /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nginx/html; <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.htm; }</code> </pre><br><br><pre> <code class="hljs django"><span class="xml"><span class="xml"># roles/nginx/templates/index.html.j2 </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ ansible_default_ipv4 }}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ ansible_env }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br>  Notice the variables in double curly braces (for example, <code>{{ ansible_env }}</code> ) are the ansible variables that we collected using the <code>setup</code> module we already know. <br><br><h2>  Handlers </h2><br>  In order to work out some actions asynchronously, in ansible there are handlers (handlers) that can be called from tasks.  Create your own handler that reboots nginx. <br><br><pre> <code class="hljs delphi"># roles/nginx/handlers/main.yml --- # handlers <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> nginx - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: reload nginx service: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=nginx state=reloaded</code> </pre><br><br>  Now we will complete the task file for the nginx role. <br><br><div class="spoiler">  <b class="spoiler_title">roles / nginx / tasks / main.yml</b> <div class="spoiler_text"><pre> <code class="hljs delphi"># roles/nginx/tasks/main.yml --- - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Update apt cache apt: update_cache=yes - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Install required packages apt: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=nginx - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Start nginx service service: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=nginx state=started - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Delete <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> nginx site <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: path=/etc/nginx/sites-enabled/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> state=absent notify: reload nginx - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Create <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> nginx site template: src=ansible.conf.j2 dest=/etc/nginx/sites-enabled/ansible owner=www-data group=www-data notify: reload nginx - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Create <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> template: src=<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html.j2 dest=/usr/share/nginx/html/<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html owner=www-data group=www-data</code> </pre><br></div></div><br>  As is clear from the description, this task sets nginx, runs it, deletes the default nginx configuration file, creates the configuration file from the template <code>ansible.conf.j2</code> , which we wrote above, and generates the <code>index.html</code> file from the template that we described above .  Please note that some tasks send <code>notify: reload nginx</code> notifications <code>notify: reload nginx</code> .  Moreover, in this case, 2 notifications should be sent to reboot nginx, but, in fact, they will be merged into one, as will be seen below.  Notifications are needed to reboot nginx (or any other service) only in case the template (or something else) has changed, so as not to do it every time you start ansible. <br><br>  So, run the resulting script. <br><br><div class="spoiler">  <b class="spoiler_title">ansible-playbook web.yml</b> <div class="spoiler_text"><pre> <code class="hljs markdown">$ ansible-playbook web.yml PLAY [all] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*** GATHERING FACTS **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [111.111.111.111] TASK: [nginx | Update apt cache] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> ok: [111.111.111.111] TASK: [nginx | Install required packages] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">** ok: [111.111.111.111] TASK: [nginx | Start nginx service] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [111.111.111.111] TASK: [nginx | Delete default nginx site] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [111.111.111.111] TASK: [nginx | Create default nginx site] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [111.111.111.111] TASK: [nginx | Create index.html file] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**** changed: [111.111.111.111] TASK: [debug msg="{{ansible_default_ipv4}}"] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">** ok: [111.111.111.111] =&gt; { "msg": "{u'macaddress': u'06:a8:07:41:47:a5', u'network': u'172.31.0.0', u'mtu': 9001, u'alias': u'eth0', u'netmask': u'255.255.240.0', u'address': u'172.31.7.80', u'interface': u'eth0', u'type': u'ether', u'gateway': u'172.31.0.1'}" } NOTIFIED: [nginx | reload nginx] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**** changed: [111.111.111.111] PLAY RECAP **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>* 111.111.111.111 : ok=9 changed=4 unreachable=0 failed=0</code> </pre><br></div></div><br>  As you can see, at the end nginx reloaded the configuration.  Let's look at the browser. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ce3/877/ced/ce3877ced8565d891eb23410a2350e4e.png"><br><br>  Voila!  We installed and launched nginx with the configuration file we needed, generated for it a page with the data from ansible, and reloaded nginx. <br><br><h2>  disadvantages </h2><br>  And so that you do not think that ansible is the ideal product, which has no place to develop, I will tell about its shortcomings. <br><br><ul><li>  No dependency manager.  Now all roles can be stored in the repository, but there is no clear answer how to work with dependencies and update roles.  Everyone uses this approach (it was the same with Chef, for example, 3 years ago), but as the project grows, the disadvantages of this approach are obvious.  <em>UPDATE</em> The dependency manager is in <a href="http://docs.ansible.com/galaxy.html">some form</a> , it is not clear just why this is written "in small print below." </li><li>  Incomplete documentation.  Answers to some obvious questions have to google, and often they are in private blogs and tickets on github. </li><li>  The ansible-pull mode for large installations will require a serious ‚Äúfile completion‚Äù. </li><li>  Inconvenient debag.  Even when calling with the <code>-vvvv</code> key, <code>-vvvv</code> not always clear which command was executed on the server and what prevented it from executing. </li><li>  Quick development.  Of course, this disadvantage has a reverse side - ansible is really developing rapidly.  But I came across a bug when version 1.8.1 worked, and 1.8.4 broke. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/254959/">https://habr.com/ru/post/254959/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254947/index.html">"Kings of the North" - the battle for gameplay</a></li>
<li><a href="../254949/index.html">Static analysis of PHP code on the example of Symfony2 (part 2)</a></li>
<li><a href="../254951/index.html">Thorns around gold</a></li>
<li><a href="../254955/index.html">Morphological image processing. Lectures from Yandex</a></li>
<li><a href="../254957/index.html">Risks and metrics in test automation</a></li>
<li><a href="../254961/index.html">Release Rust 1.0 Beta</a></li>
<li><a href="../254965/index.html">FAMP on pfsense using PHP-FPM</a></li>
<li><a href="../254969/index.html">The killer bundle of NSCache and UINib</a></li>
<li><a href="../254971/index.html">To help the teacher-teacher. Instant test validation</a></li>
<li><a href="../254973/index.html">Convert svg to png</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>