<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Internal device llst, part 2 or Little Smalltalk + LLVM =</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Together with humbug , we bring to your attention the third article from the Low Level Smalltalk (LLST) series. We hope that the article will b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Internal device llst, part 2 or Little Smalltalk + LLVM =</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://llst.org/"><img src="https://habrastorage.org/getpro/habr/post_images/1a5/888/596/1a58885963900139f3bf27b8a5ebbd16.png" align="left"></a>  Hello!  Together with <a href="https://habrahabr.ru/users/humbug/" class="user_link">humbug</a> , we bring to your attention the third article from the <a href="http://llst.org/">Low Level Smalltalk</a> (LLST) series.  We hope that the article will be interesting not only for fans of <s>bicycles of</s> unusual programming languages, but also for those who are interested in such a wonderful thing as <a href="http://ru.wikipedia.org/wiki/Low_Level_Virtual_Machine">LLVM</a> . <br><br>  Let me remind you that the goal of our project is to create our own virtual machine compatible with <a href="http://en.wikipedia.org/wiki/Little_Smalltalk">Little Smalltalk</a> at the byte-code level.  The key difference is the heterogeneous architecture, which allows you to execute bytecodes both programmatically and compile them into low-level processor instructions by translating to LLVM IR code.  Of course, the second method allows us to achieve higher performance and use the computing resources at our disposal in an optimal way. <br><br>  However, first things first ... <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  New in <a href="https://github.com/0x7CFE/llst/releases">version 0.2</a> </h4><br>  Compared to the previous version described in the <a href="http://habrahabr.ru/post/164769/">previous article</a> , there are a lot of changes: <br><br><div class="spoiler">  <b class="spoiler_title">Show list</b> <div class="spoiler_text"><ul><li>  We connected the <a href="http://ru.wikipedia.org/wiki/Readline">library readline</a> .  Now you can conveniently edit the command line;  there is a history of previously entered commands (Ctrl + R) and auto-completion on the Tab key.  In general, everything works the same as in any normal shell. </li><li>  Added primitives work with files and implemented to write the image to disk.  Now with the new VM you can do almost the same thing as the original one. </li><li>  Implemented primitive multitasking (green threads) based on the class Scheduler.  The plans - full multithreading. </li><li>  Tests are written for basic operations with objects that greatly simplify subsequent debugging.  Tests are awesome! </li><li> The pointers to the heap objects <code>hptr&lt;&gt;</code> .  Previously, they used external <code>std::list&lt;&gt;</code> lists, now the list is maintained in a stack space.  This alone sped up the software VM by half. </li><li>  In <a href="https://github.com/0x7CFE/llst/tree/feature/37/native_api">branch 37</a> , the sketches of the Native API are made, which in the future will allow conveniently writing native methods completely without wrappers and other crutches.  Methods are implemented "in place", in the same classes that describe the structure of equivalent entities from Smalltalk.  Examples can be found <a href="">here</a> , <a href="">here</a> and <a href="">here</a> . </li><li>  An attempt has been made to implement Generational GC based on the existing Baker.  In fact, the difference is in the role of the halves of the heap and the storage of the list of references between generations.  Thus, during a quick build it is necessary to run through only the younger generation and take from there objects that are referenced from older generations.  The code is written, but not yet debugged. </li><li>  Work has begun on rewriting ImageBuilder from scratch using Flex / Bison.  The inherited utility has a lot of problems: you cannot pass parameters, there is no normal error output, ‚Äúmystical‚Äù crashes when changing a pair of characters in the image code;  the same ‚Äúmystical‚Äù revivals when deleting, for example, a comment, etc. In addition, the utility in some cases generates an incorrect byte code.  Of course, it is impossible to live like this, so we decided to redo it.  At the moment, the grammar of Little Smalltalk is fully described;  In addition to the constructions of the language, there are also control commands that are used to build the primary bootstrap image. </li><li>  We got a domain name and <a href="https://github.com/0x7CFE/llst">moved to GitHub</a> .  Now the repository is available at <a href="http://llst.org/">llst.org</a> .  Pay attention also to the <a href="http://llst.org/issues">tracker</a> . </li></ul><br></div></div><br><br>  And now, the most interesting: <br><br><ul><li>  Implemented the Smalltalk bytecode translation into the LLVM IR code.  And this is done on the fly, right at the time of sending the message.  That is, during the first call some time will be spent on translation and compilation of the method code (milliseconds), but subsequent calls will be executed natively. </li><li>  An additional pass has been implemented, which will remove the extra intrinsics <a href="http://llvm.org/docs/GarbageCollection.html">llvm.gcroot</a> , to reduce the number of memory accesses (and increase the speed, of course). </li><li>  Statistics are collected on the messages sent and hot-points of the methods.  This is the basis for subsequent optimizations. </li><li>  Finally, a pass for modifying ‚Äúhot‚Äù methods is implemented, which, based on the collected statistics, changes the methods by introducing direct calls, bypassing caches and searching in class tables.  This allows you to use the pipeline and the predictor of the transition processor in an optimal way, which has a positive effect on performance. </li></ul><br><br>  Currently, hot code with run-through optimizations runs from 2 to 100 times faster compared to the previous version of the software VM (depending on the executable code).  Not bad, I think.  Although there is still room for development.  In fact, the simplest optimizations have been made that do not require complex graph analysis and type inference.  If desired, and the availability of free time, you can do much more spectacular things. <br><br><h5>  What it looks like </h5><br>  Let's see how knowledge of call statistics can speed up code.  We will conduct tests on the sorting algorithm already known to us, described in the last article, and also on the benchmark, which allows us to estimate the speed of processing messages.  Those who wish to install the version locally, I advise you to either install the <a href="https://github.com/0x7CFE/llst/releases">compiled version</a> , or compile from source, after having read the points <a href="https://github.com/0x7CFE/llst">Usage and LLVM</a> in the description of the <a href="https://github.com/0x7CFE/llst">repository</a> on the githaba. <br><br>  Let's start with the benchmark: <br><pre> <code class="smalltalk hljs">loopBenchmark | sum | sum &lt;- 0. 1 to: 100000 do: [ :x | sum &lt;- sum + 1 ]. ^sum</code> </pre><br>  This "ingenious" code a hundred thousand times adds one to the variable <code>sum</code> .  Of course, at the output we must get the same one hundred thousand (or our VM can be sent to the garbage). <br><br>  And here is the result of the run: <br><div class="spoiler">  <b class="spoiler_title">many beeches</b> <div class="spoiler_text"><pre> <code class="smalltalk hljs"><span class="hljs-string"><span class="hljs-string">$ </span></span>./llst <span class="hljs-type"><span class="hljs-type">Image</span></span> read complete. <span class="hljs-type"><span class="hljs-type">Loaded</span></span> <span class="hljs-number"><span class="hljs-number">5442</span></span> objects <span class="hljs-type"><span class="hljs-type">Soft</span></span> run: <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-type"><span class="hljs-type">Cold</span></span> jit run: <span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-type"><span class="hljs-type">Hot</span></span> jit run: <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-type"><span class="hljs-type">JIT</span></span> <span class="hljs-type"><span class="hljs-type">Runtime</span></span> stat: <span class="hljs-type"><span class="hljs-type">Messages</span></span> dispatched: <span class="hljs-number"><span class="hljs-number">200006</span></span> <span class="hljs-type"><span class="hljs-type">Objects</span></span> allocated: <span class="hljs-number"><span class="hljs-number">200004</span></span> <span class="hljs-type"><span class="hljs-type">Blocks</span></span> invoked: <span class="hljs-number"><span class="hljs-number">200002</span></span> <span class="hljs-type"><span class="hljs-type">Block</span></span> cache hits: <span class="hljs-number"><span class="hljs-number">199999</span></span> misses <span class="hljs-number"><span class="hljs-number">3</span></span> ratio <span class="hljs-number"><span class="hljs-number">100.00</span></span> % <span class="hljs-type"><span class="hljs-type">Message</span></span> cache hits: <span class="hljs-number"><span class="hljs-number">400004</span></span> misses <span class="hljs-number"><span class="hljs-number">6</span></span> ratio <span class="hljs-number"><span class="hljs-number">100.00</span></span> % <span class="hljs-type"><span class="hljs-type">Hot</span></span> methods: <span class="hljs-type"><span class="hljs-type">Hit</span></span> count <span class="hljs-type"><span class="hljs-type">Method</span></span> name <span class="hljs-number"><span class="hljs-number">200000</span></span> <span class="hljs-type"><span class="hljs-type">Block</span></span>&gt;&gt;value: (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">Number</span></span>&gt;&gt;to:do: (<span class="hljs-number"><span class="hljs-number">1</span></span> sites) value: (index <span class="hljs-number"><span class="hljs-number">20</span></span>, offset <span class="hljs-number"><span class="hljs-number">109</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Block</span></span> <span class="hljs-number"><span class="hljs-number">200000</span></span>) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">Undefined</span></span>&gt;&gt;loopBenchmark (<span class="hljs-number"><span class="hljs-number">1</span></span> sites) to:do: (index <span class="hljs-number"><span class="hljs-number">15</span></span>, offset <span class="hljs-number"><span class="hljs-number">73</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">SmallInt</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">Block</span></span>&gt;&gt;value (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-type"><span class="hljs-type">Patching</span></span> active methods that have hot call sites <span class="hljs-type"><span class="hljs-type">Recompiling</span></span> method for patching: <span class="hljs-type"><span class="hljs-type">Number</span></span>&gt;&gt;to:do: <span class="hljs-type"><span class="hljs-type">Patching</span></span> <span class="hljs-type"><span class="hljs-type">Number</span></span>&gt;&gt;to:do: ...done. <span class="hljs-type"><span class="hljs-type">Verifying</span></span> ...done. <span class="hljs-type"><span class="hljs-type">Recompiling</span></span> method for patching: <span class="hljs-type"><span class="hljs-type">Undefined</span></span>&gt;&gt;loopBenchmark <span class="hljs-type"><span class="hljs-type">Patching</span></span> <span class="hljs-type"><span class="hljs-type">Undefined</span></span>&gt;&gt;loopBenchmark ...done. <span class="hljs-type"><span class="hljs-type">Verifying</span></span> ...done. <span class="hljs-type"><span class="hljs-type">Optimizing</span></span> <span class="hljs-type"><span class="hljs-type">Number</span></span>&gt;&gt;to:do: ...done. <span class="hljs-type"><span class="hljs-type">Verifying</span></span> ...done. <span class="hljs-type"><span class="hljs-type">Optimizing</span></span> <span class="hljs-type"><span class="hljs-type">Undefined</span></span>&gt;&gt;loopBenchmark ...done. <span class="hljs-type"><span class="hljs-type">Verifying</span></span> ...done. <span class="hljs-type"><span class="hljs-type">Compiling</span></span> machine code for <span class="hljs-type"><span class="hljs-type">Number</span></span>&gt;&gt;to:do: ...done. <span class="hljs-type"><span class="hljs-type">Compiling</span></span> machine code for <span class="hljs-type"><span class="hljs-type">Undefined</span></span>&gt;&gt;loopBenchmark ...done. <span class="hljs-type"><span class="hljs-type">All</span></span> is done. <span class="hljs-type"><span class="hljs-type">Patched</span></span> cold jit run: <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-type"><span class="hljs-type">Patched</span></span> hot jit run: <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-type"><span class="hljs-type">JIT</span></span> <span class="hljs-type"><span class="hljs-type">Runtime</span></span> stat: <span class="hljs-type"><span class="hljs-type">Messages</span></span> dispatched: <span class="hljs-number"><span class="hljs-number">200010</span></span> <span class="hljs-type"><span class="hljs-type">Objects</span></span> allocated: <span class="hljs-number"><span class="hljs-number">400008</span></span> <span class="hljs-type"><span class="hljs-type">Blocks</span></span> invoked: <span class="hljs-number"><span class="hljs-number">400004</span></span> <span class="hljs-type"><span class="hljs-type">Block</span></span> cache hits: <span class="hljs-number"><span class="hljs-number">399998</span></span> misses <span class="hljs-number"><span class="hljs-number">6</span></span> ratio <span class="hljs-number"><span class="hljs-number">100.00</span></span> % <span class="hljs-type"><span class="hljs-type">Message</span></span> cache hits: <span class="hljs-number"><span class="hljs-number">400006</span></span> misses <span class="hljs-number"><span class="hljs-number">10</span></span> ratio <span class="hljs-number"><span class="hljs-number">100.00</span></span> % <span class="hljs-type"><span class="hljs-type">Hot</span></span> methods: <span class="hljs-type"><span class="hljs-type">Hit</span></span> count <span class="hljs-type"><span class="hljs-type">Method</span></span> name <span class="hljs-number"><span class="hljs-number">200000</span></span> <span class="hljs-type"><span class="hljs-type">Block</span></span>&gt;&gt;value: (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-type"><span class="hljs-type">Block</span></span>&gt;&gt;value (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">Undefined</span></span>&gt;&gt;loopBenchmark (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">Number</span></span>&gt;&gt;to:do: (<span class="hljs-number"><span class="hljs-number">1</span></span> sites) value: (index <span class="hljs-number"><span class="hljs-number">20</span></span>, offset <span class="hljs-number"><span class="hljs-number">109</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Block</span></span> <span class="hljs-number"><span class="hljs-number">200000</span></span>) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">Undefined</span></span>&gt;&gt;loopBenchmark (<span class="hljs-number"><span class="hljs-number">1</span></span> sites) to:do: (index <span class="hljs-number"><span class="hljs-number">15</span></span>, offset <span class="hljs-number"><span class="hljs-number">73</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">SmallInt</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) ===-------------------------------------------------------------------------=== ... <span class="hljs-type"><span class="hljs-type">Statistics</span></span> <span class="hljs-type"><span class="hljs-type">Collected</span></span> ... ===-------------------------------------------------------------------------=== <span class="hljs-number"><span class="hljs-number">2</span></span> adce - <span class="hljs-type"><span class="hljs-type">Number</span></span> of instructions removed <span class="hljs-number"><span class="hljs-number">2</span></span> branchfolding - <span class="hljs-type"><span class="hljs-type">Number</span></span> of block tails merged <span class="hljs-number"><span class="hljs-number">2</span></span> branchfolding - <span class="hljs-type"><span class="hljs-type">Number</span></span> of dead blocks removed <span class="hljs-number"><span class="hljs-number">1</span></span> cgscc-passmgr - <span class="hljs-type"><span class="hljs-type">Maximum</span></span> <span class="hljs-type"><span class="hljs-type">CGSCCPassMgr</span></span> iterations on one <span class="hljs-type"><span class="hljs-type">SCC</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> codegen-dce - <span class="hljs-type"><span class="hljs-type">Number</span></span> of dead instructions deleted <span class="hljs-number"><span class="hljs-number">63</span></span> codegenprepare - <span class="hljs-type"><span class="hljs-type">Number</span></span> of <span class="hljs-type"><span class="hljs-type">GEPs</span></span> converted to casts <span class="hljs-number"><span class="hljs-number">9</span></span> codegenprepare - <span class="hljs-type"><span class="hljs-type">Number</span></span> of blocks eliminated <span class="hljs-number"><span class="hljs-number">114</span></span> codegenprepare - <span class="hljs-type"><span class="hljs-type">Number</span></span> of memory instructions whose address computations were sunk <span class="hljs-number"><span class="hljs-number">47</span></span> codegenprepare - <span class="hljs-type"><span class="hljs-type">Number</span></span> of uses of <span class="hljs-type"><span class="hljs-type">Cast</span></span> expressions replaced with uses of sunken <span class="hljs-type"><span class="hljs-type">Casts</span></span> <span class="hljs-number"><span class="hljs-number">313</span></span> dagcombine - <span class="hljs-type"><span class="hljs-type">Number</span></span> of dag nodes combined <span class="hljs-number"><span class="hljs-number">0</span></span> dse - <span class="hljs-type"><span class="hljs-type">Number</span></span> of other instrs removed <span class="hljs-number"><span class="hljs-number">12</span></span> dse - <span class="hljs-type"><span class="hljs-type">Number</span></span> of stores deleted <span class="hljs-number"><span class="hljs-number">54</span></span> gvn - <span class="hljs-type"><span class="hljs-type">Number</span></span> of blocks merged <span class="hljs-number"><span class="hljs-number">2</span></span> gvn - <span class="hljs-type"><span class="hljs-type">Number</span></span> of instructions <span class="hljs-type"><span class="hljs-type">PRE</span></span><span class="hljs-string"><span class="hljs-string">'d 125 gvn - Number of instructions deleted 2 gvn - Number of loads PRE'</span></span>d <span class="hljs-number"><span class="hljs-number">37</span></span> gvn - <span class="hljs-type"><span class="hljs-type">Number</span></span> of loads deleted <span class="hljs-number"><span class="hljs-number">265</span></span> inline - <span class="hljs-type"><span class="hljs-type">Number</span></span> of functions inlined <span class="hljs-number"><span class="hljs-number">271</span></span> inline-cost - <span class="hljs-type"><span class="hljs-type">Number</span></span> of call sites analyzed <span class="hljs-number"><span class="hljs-number">263</span></span> instcombine - <span class="hljs-type"><span class="hljs-type">Number</span></span> of dead inst eliminated <span class="hljs-number"><span class="hljs-number">1</span></span> instcombine - <span class="hljs-type"><span class="hljs-type">Number</span></span> of dead stores eliminated <span class="hljs-number"><span class="hljs-number">67</span></span> instcombine - <span class="hljs-type"><span class="hljs-type">Number</span></span> of instructions sunk <span class="hljs-number"><span class="hljs-number">492</span></span> instcombine - <span class="hljs-type"><span class="hljs-type">Number</span></span> of insts combined <span class="hljs-number"><span class="hljs-number">159</span></span> isel - <span class="hljs-type"><span class="hljs-type">Number</span></span> of blocks selected using <span class="hljs-type"><span class="hljs-type">DAG</span></span> <span class="hljs-number"><span class="hljs-number">7667</span></span> isel - <span class="hljs-type"><span class="hljs-type">Number</span></span> of times dag isel has to try another path <span class="hljs-number"><span class="hljs-number">101</span></span> jit - <span class="hljs-type"><span class="hljs-type">Number</span></span> of bytes of global vars initialized <span class="hljs-number"><span class="hljs-number">5310</span></span> jit - <span class="hljs-type"><span class="hljs-type">Number</span></span> of bytes of machine code compiled <span class="hljs-number"><span class="hljs-number">12</span></span> jit - <span class="hljs-type"><span class="hljs-type">Number</span></span> of global vars initialized <span class="hljs-number"><span class="hljs-number">239</span></span> jit - <span class="hljs-type"><span class="hljs-type">Number</span></span> of relocations applied <span class="hljs-number"><span class="hljs-number">3</span></span> jit - <span class="hljs-type"><span class="hljs-type">Number</span></span> of slabs of memory allocated by the <span class="hljs-type"><span class="hljs-type">JIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> loop-simplify - <span class="hljs-type"><span class="hljs-type">Number</span></span> of pre-header or exit blocks inserted <span class="hljs-number"><span class="hljs-number">3</span></span> machine-licm - <span class="hljs-type"><span class="hljs-type">Number</span></span> of hoisted machine instructions <span class="hljs-type"><span class="hljs-type">CSEed</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> machine-licm - <span class="hljs-type"><span class="hljs-type">Number</span></span> of machine instructions hoisted out of loops <span class="hljs-number"><span class="hljs-number">73</span></span> machine-sink - <span class="hljs-type"><span class="hljs-type">Number</span></span> of machine instructions sunk <span class="hljs-number"><span class="hljs-number">6</span></span> memdep - <span class="hljs-type"><span class="hljs-type">Number</span></span> of block queries that were completely cached <span class="hljs-number"><span class="hljs-number">11</span></span> memdep - <span class="hljs-type"><span class="hljs-type">Number</span></span> of fully cached non-local ptr responses <span class="hljs-number"><span class="hljs-number">43</span></span> memdep - <span class="hljs-type"><span class="hljs-type">Number</span></span> of uncached non-local ptr responses <span class="hljs-number"><span class="hljs-number">784</span></span> pei - <span class="hljs-type"><span class="hljs-type">Number</span></span> of bytes used for stack in all functions <span class="hljs-number"><span class="hljs-number">1</span></span> phi-opt - <span class="hljs-type"><span class="hljs-type">Number</span></span> of dead <span class="hljs-type"><span class="hljs-type">PHI</span></span> cycles <span class="hljs-number"><span class="hljs-number">15</span></span> phielim - <span class="hljs-type"><span class="hljs-type">Number</span></span> of atomic phis lowered <span class="hljs-number"><span class="hljs-number">31</span></span> pre-<span class="hljs-type"><span class="hljs-type">RA</span></span>-sched - <span class="hljs-type"><span class="hljs-type">Number</span></span> of loads clustered together <span class="hljs-number"><span class="hljs-number">48</span></span> reassociate - <span class="hljs-type"><span class="hljs-type">Number</span></span> of insts reassociated <span class="hljs-number"><span class="hljs-number">29</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of cross class joins performed <span class="hljs-number"><span class="hljs-number">251</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of identity moves eliminated after coalescing <span class="hljs-number"><span class="hljs-number">92</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of identity moves eliminated after rewriting <span class="hljs-number"><span class="hljs-number">7</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of instructions deleted by <span class="hljs-type"><span class="hljs-type">DCE</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of instructions re-materialized <span class="hljs-number"><span class="hljs-number">1</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of interferences evicted <span class="hljs-number"><span class="hljs-number">251</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of interval joins performed <span class="hljs-number"><span class="hljs-number">11</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of new live ranges queued <span class="hljs-number"><span class="hljs-number">683</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of original intervals <span class="hljs-number"><span class="hljs-number">369</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of registers assigned <span class="hljs-number"><span class="hljs-number">1</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of registers unassigned <span class="hljs-number"><span class="hljs-number">3</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of rematerialized defs for spilling <span class="hljs-number"><span class="hljs-number">4</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of rematerialized defs for splitting <span class="hljs-number"><span class="hljs-number">3</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of spilled live ranges <span class="hljs-number"><span class="hljs-number">2</span></span> regalloc - <span class="hljs-type"><span class="hljs-type">Number</span></span> of splits finished <span class="hljs-number"><span class="hljs-number">4</span></span> simplifycfg - <span class="hljs-type"><span class="hljs-type">Number</span></span> of blocks simplified <span class="hljs-number"><span class="hljs-number">2</span></span> twoaddrinstr - <span class="hljs-type"><span class="hljs-type">Number</span></span> of instructions aggressively commuted <span class="hljs-number"><span class="hljs-number">2</span></span> twoaddrinstr - <span class="hljs-type"><span class="hljs-type">Number</span></span> of instructions commuted to coalesce <span class="hljs-number"><span class="hljs-number">4</span></span> twoaddrinstr - <span class="hljs-type"><span class="hljs-type">Number</span></span> of instructions promoted to <span class="hljs-number"><span class="hljs-number">3</span></span>-address <span class="hljs-number"><span class="hljs-number">30</span></span> twoaddrinstr - <span class="hljs-type"><span class="hljs-type">Number</span></span> of two-address instructions <span class="hljs-number"><span class="hljs-number">14</span></span> x86-codegen - <span class="hljs-type"><span class="hljs-type">Number</span></span> of floating point instructions <span class="hljs-number"><span class="hljs-number">1414</span></span> x86-emitter - <span class="hljs-type"><span class="hljs-type">Number</span></span> of machine instructions emitted -&gt;</code> </pre> </div></div><br>  Five lines are important here: <br><pre> <code class="smalltalk hljs"><span class="hljs-type"><span class="hljs-type">Soft</span></span> run: <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-type"><span class="hljs-type">Cold</span></span> jit run: <span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-type"><span class="hljs-type">Hot</span></span> jit run: <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-type"><span class="hljs-type">Patched</span></span> cold jit run: <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-type"><span class="hljs-type">Patched</span></span> hot jit run: <span class="hljs-number"><span class="hljs-number">9</span></span></code> </pre><br>  The first line is the execution of the method by means of a software VM.  The slowest way: no tricks, the code is executed extremely correctly, instruction by instruction.  This mode is good for debugging, as it does not make any changes to the code;  it is also used by the built-in image compiler when parsing the command line. <br><br>  The second line is the ‚Äúcold‚Äù JIT run.  The method is translated into a functionally equivalent IR code, compiled into processor instructions that are already executed directly.  Already at this stage, some optimizations are made, which will be discussed later.  It can be seen that even with the compilation of the method, the final execution time is less than pure execution.  This is not always the case.  Often, for complex methods, the first execution may require ‚âà 100 ms more time, but then we get a gain.  In the same mode, statistics on calls is accumulated (each time a call handler is invoked, which runs the compiled method). <br><br>  The third line is the ‚Äúhot run‚Äù.  The method already familiar JIT is called, so ready, compiled code is involved.  There is no overhead projector - just checking for the presence of methods in the cache and a direct function call.  The result is obvious. <br><br>  The fourth line is the ‚Äúcold‚Äù run of the patcher and the placement of direct calls (directs) where statistics show the feasibility of this event.  In this case, the whole body is thrown out of the function (which is recompiled again), and then the patcher is passed.  Full recompilation is needed so that the patcher can find the instruction that needs to be replaced with a direct call.  The problem is that after optimizing passes (as well as preparing code for the GC), the method body may change beyond recognition.  After all these manipulations, the IR code is compiled into real processor instructions and then executed. <br><br>  The fifth line is the ‚Äúhot‚Äù run of the patched and optimized method.  Again, just the execution, without any tricks. <br><br>  Such are the cakes ... Extrapolating the values, we get that about 12 million blocks per second are processed on my machine.  From this constant, you can get an estimate of the number of processed messages.  In the JIT code corresponding to the <code>Number&gt;&gt;to:do:</code> method, three operations are performed, equivalent to the following message parcels: <br><br><ul><li>  Sending <code>&lt;</code> to the counter object inside <code>#to:do:</code> (loop condition); </li><li>  Sending <code>#value:</code> to a block object (block call); </li><li>  Sending <code>+</code> <code>sum</code> object (loop body). </li></ul><br>  We get a constant of 36 million, which can be viewed as a rough estimate above the number of messages sent per second. <br><br>  At the same time, this is far from the speed limit.  For example, if we rewrite the body of the benchmark using the <code>whileTrue:</code> construction <code>whileTrue:</code> <br><pre> <code class="smalltalk hljs">loopBenchmark | sum | sum &lt;- 0. [ sum &lt; 1000000 ] whileTrue: [ sum &lt;- sum + 1 ]. ^sum</code> </pre><br>  then the results of the run on one <i>million</i> (instead of one hundred thousand, pay attention to the constant) will be: <br><pre> <code class="smalltalk hljs"><span class="hljs-type"><span class="hljs-type">Soft</span></span> run: <span class="hljs-number"><span class="hljs-number">197</span></span> <span class="hljs-type"><span class="hljs-type">Cold</span></span> jit run: <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-type"><span class="hljs-type">Hot</span></span> jit run: <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre><br>  In this case, we get the equivalent already ‚âà 8.1 ‚ãÖ 10 <sup>8</sup> messages per second, or acceleration of 197/4 ‚âà 50 times.  This is because now the compiled version does not contain <i>any</i> real message sending operation.  <code>whileTrue:</code> expands to a linear instruction set with transitions;  all operations occur on numbers for which there are separate branches of execution that involve arithmetic operations directly. <br><br>  The results of the runner with the patcher do not differ from the results of the JIT hot run, because there are no message packages, which means there is no statistics that can be collected, and there are no calls to the software VM that could be replaced by direct calls to JIT functions. <br><br>  Of course, you need to be very careful about all sorts of benchmarks (especially integer) when it comes to VM performance.  We use these figures only for a rough assessment of the optimization performed and as an indication that, on average, the code began to run faster. <br><br>  Of course, the real numbers will be less, because here we have almost ideal conditions for optimization: cycles and arithmetic are compiled into native code entirely.  The presence of direct transition instructions optimally utilizes the processor transition predictor, caches miss less.  Hence, the increase in comparison with the non-optimized version, where for each parcel you need to go into the stub-processor, look into the cache and understand who really needs to address the message.  Even taking into account 99% of hits, precious processor clock cycles are spent on it all the same. <br><br>  The sorting test shows the results more modest: <br><pre> <code class="smalltalk hljs"><span class="hljs-type"><span class="hljs-type">Soft</span></span> run: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-type"><span class="hljs-type">Cold</span></span> jit run: <span class="hljs-number"><span class="hljs-number">140</span></span> <span class="hljs-type"><span class="hljs-type">Hot</span></span> jit run: <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-type"><span class="hljs-type">Patched</span></span> cold jit run: <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-type"><span class="hljs-type">Patched</span></span> hot jit run: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">full output</b> <div class="spoiler_text"><pre> <code class="smalltalk hljs"><span class="hljs-type"><span class="hljs-type">Preparing</span></span> test data ...done <span class="hljs-type"><span class="hljs-type">Soft</span></span> run: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-type"><span class="hljs-type">Cold</span></span> jit run: <span class="hljs-number"><span class="hljs-number">140</span></span> <span class="hljs-type"><span class="hljs-type">Hot</span></span> jit run: <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-type"><span class="hljs-type">JIT</span></span> <span class="hljs-type"><span class="hljs-type">Runtime</span></span> stat: <span class="hljs-type"><span class="hljs-type">Messages</span></span> dispatched: <span class="hljs-number"><span class="hljs-number">210613</span></span> <span class="hljs-type"><span class="hljs-type">Objects</span></span> allocated: <span class="hljs-number"><span class="hljs-number">17746</span></span> <span class="hljs-type"><span class="hljs-type">Blocks</span></span> invoked: <span class="hljs-number"><span class="hljs-number">43006</span></span> <span class="hljs-type"><span class="hljs-type">Block</span></span> cache hits: <span class="hljs-number"><span class="hljs-number">43001</span></span> misses <span class="hljs-number"><span class="hljs-number">5</span></span> ratio <span class="hljs-number"><span class="hljs-number">99.99</span></span> % <span class="hljs-type"><span class="hljs-type">Message</span></span> cache hits: <span class="hljs-number"><span class="hljs-number">369520</span></span> misses <span class="hljs-number"><span class="hljs-number">51704</span></span> ratio <span class="hljs-number"><span class="hljs-number">87.73</span></span> % <span class="hljs-type"><span class="hljs-type">Hot</span></span> methods: <span class="hljs-type"><span class="hljs-type">Hit</span></span> count <span class="hljs-type"><span class="hljs-type">Method</span></span> name <span class="hljs-number"><span class="hljs-number">44061</span></span> <span class="hljs-type"><span class="hljs-type">Link</span></span>&gt;&gt;next (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">35102</span></span> <span class="hljs-type"><span class="hljs-type">MetaObject</span></span>&gt;&gt;in:at:put: (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">27775</span></span> <span class="hljs-type"><span class="hljs-type">Link</span></span>&gt;&gt;value (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">25778</span></span> <span class="hljs-type"><span class="hljs-type">Block</span></span>&gt;&gt;value:value: (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">17746</span></span> <span class="hljs-type"><span class="hljs-type">Class</span></span>&gt;&gt;new (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">17356</span></span> <span class="hljs-type"><span class="hljs-type">MetaLink</span></span>&gt;&gt;value:next: (<span class="hljs-number"><span class="hljs-number">3</span></span> sites) new (index <span class="hljs-number"><span class="hljs-number">3</span></span>, offset <span class="hljs-number"><span class="hljs-number">7</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">MetaLink</span></span> <span class="hljs-number"><span class="hljs-number">17356</span></span>) in:at:put: (index <span class="hljs-number"><span class="hljs-number">11</span></span>, offset <span class="hljs-number"><span class="hljs-number">31</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">MetaLink</span></span> <span class="hljs-number"><span class="hljs-number">17356</span></span>) in:at:put: (index <span class="hljs-number"><span class="hljs-number">18</span></span>, offset <span class="hljs-number"><span class="hljs-number">72</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">MetaLink</span></span> <span class="hljs-number"><span class="hljs-number">17356</span></span>) <span class="hljs-number"><span class="hljs-number">17226</span></span> <span class="hljs-type"><span class="hljs-type">Block</span></span>&gt;&gt;value: (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">15619</span></span> <span class="hljs-type"><span class="hljs-type">List</span></span>&gt;&gt;add: (<span class="hljs-number"><span class="hljs-number">1</span></span> sites) value:next: (index <span class="hljs-number"><span class="hljs-number">5</span></span>, offset <span class="hljs-number"><span class="hljs-number">13</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">MetaLink</span></span> <span class="hljs-number"><span class="hljs-number">15619</span></span>) <span class="hljs-number"><span class="hljs-number">1999</span></span> <span class="hljs-type"><span class="hljs-type">List</span></span>&gt;&gt;isEmpty (<span class="hljs-number"><span class="hljs-number">1</span></span> sites) = (index <span class="hljs-number"><span class="hljs-number">4</span></span>, offset <span class="hljs-number"><span class="hljs-number">9</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">SmallInt</span></span> <span class="hljs-number"><span class="hljs-number">1999</span></span>) <span class="hljs-number"><span class="hljs-number">1999</span></span> <span class="hljs-type"><span class="hljs-type">SmallInt</span></span>&gt;&gt;= (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">1867</span></span> <span class="hljs-type"><span class="hljs-type">List</span></span>&gt;&gt;insert:onCondition: (<span class="hljs-number"><span class="hljs-number">10</span></span> sites) isEmpty (index <span class="hljs-number"><span class="hljs-number">3</span></span>, offset <span class="hljs-number"><span class="hljs-number">7</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">1867</span></span>) add: (index <span class="hljs-number"><span class="hljs-number">10</span></span>, offset <span class="hljs-number"><span class="hljs-number">27</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) value (index <span class="hljs-number"><span class="hljs-number">33</span></span>, offset <span class="hljs-number"><span class="hljs-number">166</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">10419</span></span>) value:value: (index <span class="hljs-number"><span class="hljs-number">40</span></span>, offset <span class="hljs-number"><span class="hljs-number">210</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Block</span></span> <span class="hljs-number"><span class="hljs-number">10419</span></span>) next (index <span class="hljs-number"><span class="hljs-number">48</span></span>, offset <span class="hljs-number"><span class="hljs-number">268</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">1481</span></span>) value:next: (index <span class="hljs-number"><span class="hljs-number">50</span></span>, offset <span class="hljs-number"><span class="hljs-number">286</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">MetaLink</span></span> <span class="hljs-number"><span class="hljs-number">1481</span></span>) value:next: (index <span class="hljs-number"><span class="hljs-number">57</span></span>, offset <span class="hljs-number"><span class="hljs-number">21</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">1481</span></span>) next (index <span class="hljs-number"><span class="hljs-number">68</span></span>, offset <span class="hljs-number"><span class="hljs-number">8</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">8938</span></span>) value:next: (index <span class="hljs-number"><span class="hljs-number">81</span></span>, offset <span class="hljs-number"><span class="hljs-number">24</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">MetaLink</span></span> <span class="hljs-number"><span class="hljs-number">256</span></span>) next: (index <span class="hljs-number"><span class="hljs-number">83</span></span>, offset <span class="hljs-number"><span class="hljs-number">9</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-number"><span class="hljs-number">1481</span></span> <span class="hljs-type"><span class="hljs-type">Link</span></span>&gt;&gt;value:next: (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">392</span></span> <span class="hljs-type"><span class="hljs-type">List</span></span>&gt;&gt;size (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">390</span></span> <span class="hljs-type"><span class="hljs-type">MetaList</span></span>&gt;&gt;new (<span class="hljs-number"><span class="hljs-number">2</span></span> sites) new (index <span class="hljs-number"><span class="hljs-number">4</span></span>, offset <span class="hljs-number"><span class="hljs-number">9</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">MetaCollection</span></span> <span class="hljs-number"><span class="hljs-number">390</span></span>) in:at:put: (index <span class="hljs-number"><span class="hljs-number">12</span></span>, offset <span class="hljs-number"><span class="hljs-number">34</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">MetaList</span></span> <span class="hljs-number"><span class="hljs-number">390</span></span>) <span class="hljs-number"><span class="hljs-number">384</span></span> <span class="hljs-type"><span class="hljs-type">Link</span></span>&gt;&gt;next: (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">262</span></span> <span class="hljs-type"><span class="hljs-type">Collection</span></span>&gt;&gt;sort: (<span class="hljs-number"><span class="hljs-number">13</span></span> sites) size (index <span class="hljs-number"><span class="hljs-number">3</span></span>, offset <span class="hljs-number"><span class="hljs-number">7</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">262</span></span>) insertSort: (index <span class="hljs-number"><span class="hljs-number">12</span></span>, offset <span class="hljs-number"><span class="hljs-number">34</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">132</span></span>) popFirst (index <span class="hljs-number"><span class="hljs-number">21</span></span>, offset <span class="hljs-number"><span class="hljs-number">88</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) new (index <span class="hljs-number"><span class="hljs-number">26</span></span>, offset <span class="hljs-number"><span class="hljs-number">126</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">MetaList</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) new (index <span class="hljs-number"><span class="hljs-number">31</span></span>, offset <span class="hljs-number"><span class="hljs-number">158</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">MetaList</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) value:value: (index <span class="hljs-number"><span class="hljs-number">42</span></span>, offset <span class="hljs-number"><span class="hljs-number">219</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Block</span></span> <span class="hljs-number"><span class="hljs-number">15359</span></span>) add: (index <span class="hljs-number"><span class="hljs-number">49</span></span>, offset <span class="hljs-number"><span class="hljs-number">279</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">8207</span></span>) add: (index <span class="hljs-number"><span class="hljs-number">56</span></span>, offset <span class="hljs-number"><span class="hljs-number">12</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">7152</span></span>) do: (index <span class="hljs-number"><span class="hljs-number">59</span></span>, offset <span class="hljs-number"><span class="hljs-number">31</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) sort: (index <span class="hljs-number"><span class="hljs-number">64</span></span>, offset <span class="hljs-number"><span class="hljs-number">64</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) sort: (index <span class="hljs-number"><span class="hljs-number">70</span></span>, offset <span class="hljs-number"><span class="hljs-number">19</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) add: (index <span class="hljs-number"><span class="hljs-number">76</span></span>, offset <span class="hljs-number"><span class="hljs-number">4</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) appendList: (index <span class="hljs-number"><span class="hljs-number">81</span></span>, offset <span class="hljs-number"><span class="hljs-number">24</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) <span class="hljs-number"><span class="hljs-number">260</span></span> <span class="hljs-type"><span class="hljs-type">Link</span></span>&gt;&gt;do: (<span class="hljs-number"><span class="hljs-number">2</span></span> sites) value (index <span class="hljs-number"><span class="hljs-number">18</span></span>, offset <span class="hljs-number"><span class="hljs-number">72</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">260</span></span>) value: (index <span class="hljs-number"><span class="hljs-number">20</span></span>, offset <span class="hljs-number"><span class="hljs-number">82</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Block</span></span> <span class="hljs-number"><span class="hljs-number">260</span></span>) <span class="hljs-number"><span class="hljs-number">260</span></span> <span class="hljs-type"><span class="hljs-type">List</span></span>&gt;&gt;do: (<span class="hljs-number"><span class="hljs-number">1</span></span> sites) do: (index <span class="hljs-number"><span class="hljs-number">9</span></span>, offset <span class="hljs-number"><span class="hljs-number">25</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">260</span></span>) <span class="hljs-number"><span class="hljs-number">132</span></span> <span class="hljs-type"><span class="hljs-type">Collection</span></span>&gt;&gt;insertSort: (<span class="hljs-number"><span class="hljs-number">4</span></span> sites) isEmpty (index <span class="hljs-number"><span class="hljs-number">3</span></span>, offset <span class="hljs-number"><span class="hljs-number">7</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">132</span></span>) new (index <span class="hljs-number"><span class="hljs-number">16</span></span>, offset <span class="hljs-number"><span class="hljs-number">55</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">MetaList</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) insert:onCondition: (index <span class="hljs-number"><span class="hljs-number">27</span></span>, offset <span class="hljs-number"><span class="hljs-number">130</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">1867</span></span>) do: (index <span class="hljs-number"><span class="hljs-number">30</span></span>, offset <span class="hljs-number"><span class="hljs-number">143</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) <span class="hljs-number"><span class="hljs-number">130</span></span> <span class="hljs-type"><span class="hljs-type">List</span></span>&gt;&gt;popFirst (<span class="hljs-number"><span class="hljs-number">3</span></span> sites) value (index <span class="hljs-number"><span class="hljs-number">14</span></span>, offset <span class="hljs-number"><span class="hljs-number">43</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) next (index <span class="hljs-number"><span class="hljs-number">19</span></span>, offset <span class="hljs-number"><span class="hljs-number">76</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) - (index <span class="hljs-number"><span class="hljs-number">25</span></span>, offset <span class="hljs-number"><span class="hljs-number">111</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">SmallInt</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span>) <span class="hljs-number"><span class="hljs-number">130</span></span> <span class="hljs-type"><span class="hljs-type">SmallInt</span></span>&gt;&gt;- (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">130</span></span> <span class="hljs-type"><span class="hljs-type">List</span></span>&gt;&gt;appendList: (<span class="hljs-number"><span class="hljs-number">7</span></span> sites) firstLink (index <span class="hljs-number"><span class="hljs-number">8</span></span>, offset <span class="hljs-number"><span class="hljs-number">21</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) size (index <span class="hljs-number"><span class="hljs-number">13</span></span>, offset <span class="hljs-number"><span class="hljs-number">40</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) next (index <span class="hljs-number"><span class="hljs-number">36</span></span>, offset <span class="hljs-number"><span class="hljs-number">181</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">8207</span></span>) next (index <span class="hljs-number"><span class="hljs-number">43</span></span>, offset <span class="hljs-number"><span class="hljs-number">234</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">8079</span></span>) firstLink (index <span class="hljs-number"><span class="hljs-number">54</span></span>, offset <span class="hljs-number"><span class="hljs-number">3</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span>) next: (index <span class="hljs-number"><span class="hljs-number">56</span></span>, offset <span class="hljs-number"><span class="hljs-number">12</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">Link</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span>) size (index <span class="hljs-number"><span class="hljs-number">61</span></span>, offset <span class="hljs-number"><span class="hljs-number">49</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-number"><span class="hljs-number">130</span></span> <span class="hljs-type"><span class="hljs-type">List</span></span>&gt;&gt;firstLink (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">Collection</span></span>&gt;&gt;sort (<span class="hljs-number"><span class="hljs-number">1</span></span> sites) sort: (index <span class="hljs-number"><span class="hljs-number">10</span></span>, offset <span class="hljs-number"><span class="hljs-number">27</span></span>) class hits: (<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">Block</span></span>&gt;&gt;value (<span class="hljs-number"><span class="hljs-number">0</span></span> sites) ===-------------------------------------------------------------------------=== ... <span class="hljs-type"><span class="hljs-type">Statistics</span></span> <span class="hljs-type"><span class="hljs-type">Collected</span></span> ... ===-------------------------------------------------------------------------=== <span class="hljs-number"><span class="hljs-number">2</span></span> adce - <span class="hljs-type"><span class="hljs-type">Number</span></span> of instructions removed <span class="hljs-number"><span class="hljs-number">14</span></span> branchfolding - <span class="hljs-type"><span class="hljs-type">Number</span></span> of block tails merged <span class="hljs-number"><span class="hljs-number">6</span></span> branchfolding - <span class="hljs-type"><span class="hljs-type">Number</span></span> of branches optimized <span class="hljs-number"><span class="hljs-number">5</span></span> branchfolding - <span class="hljs-type"><span class="hljs-type">Number</span></span> of dead blocks removed <span class="hljs-number"><span class="hljs-number">1</span></span> cgscc-passmgr - <span class="hljs-type"><span class="hljs-type">Maximum</span></span> <span class="hljs-type"><span class="hljs-type">CGSCCPassMgr</span></span> iterations on one <span class="hljs-type"><span class="hljs-type">SCC</span></span> <span class="hljs-number"><span class="hljs-number">38</span></span> codegen-dce - <span class="hljs-type"><span class="hljs-type">Number</span></span> of dead instructions deleted <span class="hljs-number"><span class="hljs-number">220</span></span> codegenprepare - <span class="hljs-type"><span class="hljs-type">Number</span></span> of <span class="hljs-type"><span class="hljs-type">GEPs</span></span> converted to casts <span class="hljs-number"><span class="hljs-number">2</span></span> codegenprepare - <span class="hljs-type"><span class="hljs-type">Number</span></span> of blocks eliminated <span class="hljs-number"><span class="hljs-number">151</span></span> codegenprepare - <span class="hljs-type"><span class="hljs-type">Number</span></span> of memory instructions whose address computations were sunk <span class="hljs-number"><span class="hljs-number">123</span></span> codegenprepare - <span class="hljs-type"><span class="hljs-type">Number</span></span> of uses of <span class="hljs-type"><span class="hljs-type">Cast</span></span> expressions replaced with uses of sunken <span class="hljs-type"><span class="hljs-type">Casts</span></span> <span class="hljs-number"><span class="hljs-number">854</span></span> dagcombine - <span class="hljs-type"><span class="hljs-type">Number</span></span> of dag nodes combined <span class="hljs-number"><span class="hljs-number">250</span></span> dce - <span class="hljs-type"><span class="hljs-type">Number</span></span> of insts removed <span class="hljs-number"><span class="hljs-number">194</span></span> dse - <span class="hljs-type"><span class="hljs-type">Number</span></span> of other instrs removed <span class="hljs-number"><span class="hljs-number">158</span></span> dse - <span class="hljs-type"><span class="hljs-type">Number</span></span> of stores deleted <span class="hljs-number"><span class="hljs-number">51</span></span> gvn - <span class="hljs-type"><span class="hljs-type">Number</span></span> of blocks merged <span class="hljs-number"><span class="hljs-number">353</span></span> gvn - <span class="hljs-type"><span class="hljs-type">Number</span></span> of instructions deleted <span class="hljs-number"><span class="hljs-number">6</span></span> gvn - <span class="hljs-type"><span class="hljs-type">Number</span></span> of loads <span class="hljs-type"><span class="hljs-type">PRE</span></span><span class="hljs-string"><span class="hljs-string">'d 277 gvn - Number of loads deleted 862 inline - Number of functions inlined 862 inline-cost - Number of call sites analyzed 1085 instcombine - Number of dead inst eliminated 69 instcombine - Number of instructions sunk 2540 instcombine - Number of insts combined 194 isel - Number of blocks selected using DAG 18193 isel - Number of times dag isel has to try another path 461 jit - Number of bytes of global vars initialized 12042 jit - Number of bytes of machine code compiled 25 jit - Number of global vars initialized 375 jit - Number of relocations applied 2 jit - Number of slabs of memory allocated by the JIT 15 llst - Number of removed loads from gc.root protected pointers &lt;&lt;&lt;&lt;&lt;&lt; 222 llst - Number of removed roots &lt;&lt;&lt;&lt;&lt;&lt; 4 machine-cse - Number of common subexpression eliminated 1 machine-licm - Number of hoisted machine instructions CSEed 14 machine-licm - Number of machine instructions hoisted out of loops 71 machine-sink - Number of machine instructions sunk 10 memdep - Number of block queries that were completely cached 81 memdep - Number of fully cached non-local ptr responses 84 memdep - Number of uncached non-local ptr responses 2792 pei - Number of bytes used for stack in all functions 9 phielim - Number of atomic phis lowered 2 phielim - Number of critical edges split 36 pre-RA-sched - Number of loads clustered together 23 reassociate - Number of insts reassociated 21 regalloc - Number of cross class joins performed 250 regalloc - Number of identity moves eliminated after coalescing 124 regalloc - Number of identity moves eliminated after rewriting 6 regalloc - Number of instructions deleted by DCE 1 regalloc - Number of interferences evicted 248 regalloc - Number of interval joins performed 21 regalloc - Number of new live ranges queued 1240 regalloc - Number of original intervals 891 regalloc - Number of registers assigned 1 regalloc - Number of registers unassigned 6 regalloc - Number of rematerialized defs for spilling 4 regalloc - Number of rematerialized defs for splitting 6 regalloc - Number of spilled live ranges 4 regalloc - Number of splits finished 13 simplifycfg - Number of blocks simplified 3 twoaddrinstr - Number of instructions re-materialized 43 twoaddrinstr - Number of two-address instructions 40 x86-codegen - Number of floating point instructions 2697 x86-emitter - Number of machine instructions emitted Patching active methods that have hot call sites Recompiling method for patching: MetaLink&gt;&gt;value:next: Patching MetaLink&gt;&gt;value:next: ...done. Verifying ...done. Recompiling method for patching: List&gt;&gt;add: Patching List&gt;&gt;add: ...done. Verifying ...done. Recompiling method for patching: List&gt;&gt;isEmpty Patching List&gt;&gt;isEmpty ...done. Verifying ...done. Recompiling method for patching: List&gt;&gt;insert:onCondition: Patching List&gt;&gt;insert:onCondition: ...done. Verifying ...done. Recompiling method for patching: MetaList&gt;&gt;new Patching MetaList&gt;&gt;new ...done. Verifying ...done. Recompiling method for patching: Collection&gt;&gt;sort: Patching Collection&gt;&gt;sort: ...done. Verifying ...done. Recompiling method for patching: Link&gt;&gt;do: Patching Link&gt;&gt;do: ...done. Verifying ...done. Recompiling method for patching: List&gt;&gt;do: Patching List&gt;&gt;do: ...done. Verifying ...done. Recompiling method for patching: Collection&gt;&gt;insertSort: Patching Collection&gt;&gt;insertSort: ...done. Verifying ...done. Recompiling method for patching: List&gt;&gt;popFirst Patching List&gt;&gt;popFirst ...done. Verifying ...done. Recompiling method for patching: List&gt;&gt;appendList: Patching List&gt;&gt;appendList: ...done. Verifying ...done. Recompiling method for patching: Collection&gt;&gt;sort Patching Collection&gt;&gt;sort ...done. Verifying ...done. Optimizing MetaLink&gt;&gt;value:next: ...done. Verifying ...done. Optimizing List&gt;&gt;add: ...done. Verifying ...done. Optimizing List&gt;&gt;isEmpty ...done. Verifying ...done. Optimizing List&gt;&gt;insert:onCondition: ...done. Verifying ...done. Optimizing MetaList&gt;&gt;new ...done. Verifying ...done. Optimizing Collection&gt;&gt;sort: ...done. Verifying ...done. Optimizing Link&gt;&gt;do: ...done. Verifying ...done. Optimizing List&gt;&gt;do: ...done. Verifying ...done. Optimizing Collection&gt;&gt;insertSort: ...done. Verifying ...done. Optimizing List&gt;&gt;popFirst ...done. Verifying ...done. Optimizing List&gt;&gt;appendList: ...done. Verifying ...done. Optimizing Collection&gt;&gt;sort ...done. Verifying ...done. Compiling machine code for MetaLink&gt;&gt;value:next: ...done. Compiling machine code for List&gt;&gt;add: ...done. Compiling machine code for List&gt;&gt;isEmpty ...done. Compiling machine code for List&gt;&gt;insert:onCondition: ...done. Compiling machine code for MetaList&gt;&gt;new ...done. Compiling machine code for Collection&gt;&gt;sort: ...done. Compiling machine code for Link&gt;&gt;do: ...done. Compiling machine code for List&gt;&gt;do: ...done. Compiling machine code for Collection&gt;&gt;insertSort: ...done. Compiling machine code for List&gt;&gt;popFirst ...done. Compiling machine code for List&gt;&gt;appendList: ...done. Compiling machine code for Collection&gt;&gt;sort ...done. All is done. Patched cold jit run: 7 Patched hot jit run: 6</span></span></code> </pre></div></div><br>  Here you need to say a few words about what is optimized and how.  First, now the patcher passes only on the functions of the methods.  Blocks remain non-optimized.  Secondly, for each operation of sending a message, an instance of the <code>Array</code> class is created, in which the message arguments are placed.  Time is also being spent on this.  Finally, inline methods are almost never used.  It concerns only official functions (as we shall see later) and some trivial constructions.  All this allows us to conclude that the potential for further optimization is far from exhausted. <br><br>  To understand in more detail what is happening in the compilation process and during program execution, you need to understand the internal kitchen of the virtual machine.  What we now do. <br><br><h4>  Smalltalk virtual machine </h4><br>  The virtual machine operates with objects.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The operation is reduced to the exchange of messages between objects and sweeping debris behind them. </font><font style="vertical-align: inherit;">In fact, the only serious operation that a virtual machine does is sending a message. </font><font style="vertical-align: inherit;">Everything else, one way or another, comes down to the same premise. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To understand how a machine does this, you must first understand what the Smalltalk object is.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Objects </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Any object can simply be represented by the following structure: </font></font><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TObject</span></span></span><span class="hljs-class"> {</span></span> TSize size; TClass* klass; <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { TObject* fields[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> bytes[<span class="hljs-number"><span class="hljs-number">0</span></span>]; }; };</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each object has a title in which the size of the object and a pointer to its class are recorded. Next are the fields of the object containing pointers to other objects. Of course, both the class and the fields are also objects, and therefore are represented by the same structures. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All objects in Smalltalk are a multiple of 4 bytes. This size is stored at zero offset, and the lower two bits have a special role - they store the Binary ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and Indirect ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">flags </font><font style="vertical-align: inherit;">. The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> flag </font><font style="vertical-align: inherit;">means that the object is binary, that is, it stores a raw set of bytes in the space reserved for the fields of ordinary objects. Such objects are, for example, strings (instances </font></font><code>String</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Byte codes of methods are stored in instances.</font></font><code>ByteArray</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which are also binary objects. </font><font style="vertical-align: inherit;">Binary objects are always padded to multiple lengths. </font><font style="vertical-align: inherit;">Flag </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> used by the garbage collector as it passes through the heap to mark those objects that have already been processed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That leaves 30 bits to the size of the object. </font><font style="vertical-align: inherit;">For ordinary objects, the size is considered in the fields (in multiples of 4 bytes), for binary objects - in bytes. </font><font style="vertical-align: inherit;">Since both objects have the same, previously known title, its size is not taken into account in the total amount.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Smallint </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All objects are located in memory aligned to 4 bytes. Thus, the lower two bits of the address are always equal to 0. This fact is used to store numbers up to 31 bits in the fields of the object. At the same time, the recorded number is multiplied by 2 (shifted 1 bit to the left), and the low-order bit is set to 1. The virtual machine is aware of this optimization, and in all places where the fields are accessed, checks whether the pointer to the object is really stored there or this information must be interpreted as a number. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is important to note that this point is completely transparent to the rest of the system. The application programmer is not required to know what, where and how is stored. For example, it would be quite legal to write a command in the console </font></font><code>1 class</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and get the expected response.</font></font><code>SmallInt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, although this unit in the image will be represented by just such an ‚Äúobject‚Äù </font></font><code>SmallInt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This little trick can significantly reduce the amount of memory consumed, since only one bit more is used to write the number than its binary representation. If we use </font></font><a href="http://en.wikipedia.org/wiki/Boxing_(computer_science)"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">boxing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then for each number in addition to 4 bytes of a pointer to an object, another 8 bytes of the header and another 4 bytes of the actual data will be stored. Not the best option, I think.</font></font><br><br><h5>  Messages </h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As already described in the previous article, a message is a receiving object, plus a selector, plus a set of parameters. An important difference in sending a message from a function call is that until the last moment it is not known who will actually process the message. Only the object is known - the recipient of the message. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending a message begins with a search in the hierarchy of such a class that will be able to process the message. The search is conducted from the immediate class of the object, up the hierarchy, up to</font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. I must say that this is a rather expensive operation, since you have to do a large number of memory accesses. Therefore, search results are cached. Thus, a complete search has to be done only once. The method caches are reset only in two cases - with the next garbage collection (method objects could move) and with the addition / removal of the next method (this could affect the hierarchy). Even with regular cleaning of caches during garbage collection, the percentage of hits remains very high (about 99%), so the time spent on finding a method can be considered on average insignificant. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's follow how the search takes place when a </font><font style="vertical-align: inherit;">message </font><font style="vertical-align: inherit;">is sent to an object </font></font><code>'Hello world'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(class instance </font></font><code>String</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><code>#isNil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The search will be as follows:</font></font><br><ol><li>          hash(String, #isNil); </li><li>   ,      ; </li><li>    ,       <code>String</code> : </li><li>      <b>methods</b> ,   ( <code>Dictionary</code> ) . <br>      :     ; <br>    ; </li><li>    <a href="http://ru.wikipedia.org/wiki/%25D0%2591%25D0%25B8%25D0%25BD%25D0%25B0%25D1%2580%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BF%25D0%25BE%25D0%25B8%25D1%2581%25D0%25BA"></a>    ; </li><li>   ,      ,    ,    ;          ; </li><li>    ,      : </li><li>    (   <b>nil</b> ),     4; </li><li>   ,     . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the method was not found in the class hierarchy, the virtual machine sends a message to the object </font></font><code>#doesNotUnderstand:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which is guaranteed to be processed (at least in itself </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">In some cases, classes intentionally intercept this message for specific purposes. </font><font style="vertical-align: inherit;">For example, proxy objects can do this, which then delivers the message to a valid address. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the above message, the </font></font><code>String&gt;&gt;isNil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">search string would be: </font></font><br> <code>String</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí </font></font><code>Array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí </font></font><code>Collection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí </font></font><code>Magnitude</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the method has been found, the virtual machine creates and populates the context object, and then proceeds to execute the method.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Context </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The concept of context is inextricably linked with the operation of sending a message. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In traditional processor architectures, such as x86, there is the concept of a </font></font><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25B5%25D0%25BA_%25D0%25B2%25D1%258B%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">call stack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . When a function is called, the parameters passed along with the return address are pushed onto the stack, after which the transition to the function body is performed. When exiting the function, respectively, the return address is removed from the top of the stack. It turns out that for each function on the stack lies the entire ‚Äúhierarchy‚Äù of transitions from the moment the thread starts to the current function call. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In Smalltalk, everything is different. There is no single call stack. Instead, each time a message is sent, </font><em><font style="vertical-align: inherit;">a context object</font></em><font style="vertical-align: inherit;"> is formed.</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which stores information relevant to that particular package. </font><font style="vertical-align: inherit;">The same object is used by the virtual machine when executing the method body itself. </font><font style="vertical-align: inherit;">Here is what it looks like:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TContext</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TObject { TMethod* method; TObjectArray* arguments; TObjectArray* temporaries; TObjectArray* <span class="hljs-built_in"><span class="hljs-built_in">stack</span></span>; TInteger bytePointer; TInteger stackTop; TContext* previousContext; };</code> </pre><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">method</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - this places the pointer to the method object found earlier that will process this message.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arguments</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a pointer to the mass is stored here (instance </font></font><code>Array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) where the passed arguments are stored.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temporaries</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a repository of temporary method variables. </font><font style="vertical-align: inherit;">In particular, those that are written between characters </font></font><code>| |</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the method header.</font></font></li><li> <b>stack</b> ‚Äî  .             .      .     ,          .      . </li><li> <b>bytePointer</b> ‚Äî  ;   IP  .       .                 . </li><li> <b>stackTop</b> ‚Äî    . </li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">previousContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - and this is where the parent context is stored, from which method the message was sent. </font><font style="vertical-align: inherit;">When returning a value from the current method, it will be put on top of the parent stack.</font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At each time point, the context has all the information regarding the current state of the method execution. </font><font style="vertical-align: inherit;">This makes it possible to easily interrupt the execution of the method (for example, when the number of ticks allocated for it expires), and then return back later. </font><font style="vertical-align: inherit;">There are also exotic use cases, including, for example, the implementation of </font></font><a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D0%25B4%25D0%25BE%25D0%25BB%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">continuations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h5>  Methods </h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The methods are represented by the following objects: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TMethod</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TObject { TSymbol* name; TByteObject* byteCodes; TSymbolArray* literals; TInteger stackSize; TInteger temporarySize; TClass* klass; TString* text; TObject* package; };</code> </pre> <br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the actual name of the method, or rather the pointer to the symbol of this name.</font></font></li><li> <b>byteCodes</b> ‚Äî      <code>ByteArray</code> ,  - . </li><li> <b>literals</b> ‚Äî       .   :  ,  ,  .         ,      . </li><li> <b>stackSize</b> ‚Äî      (.  TContext::stack),      . </li><li> <b>temporarySize</b> ‚Äî  ,    .      . </li><li> <b>klass</b> ‚Äî   ,    . </li><li> <b>text</b> ‚Äî    . </li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">package</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the category of this method. </font><font style="vertical-align: inherit;">It is intended for filtering lists of displayed methods in the user interface. </font><font style="vertical-align: inherit;">Currently not used.</font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Method objects are generated when the primary image is compiled from the source imageSource.st by the ImageBuilder utility, and then saved to the resulting image file. </font><font style="vertical-align: inherit;">A one-time method is also created when executing a command from the command line. </font><font style="vertical-align: inherit;">In essence, the command line text is interpreted as the body of the method, which is then compiled and called in the usual way. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is done like this. </font><font style="vertical-align: inherit;">In the body of the method </font></font><code>Undefined&gt;&gt;main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there is a code:</font></font><br><br><pre> <code class="smalltalk hljs">[ command &lt;- <span class="hljs-type"><span class="hljs-type">String</span></span> readline: <span class="hljs-string"><span class="hljs-string">'-&gt;'</span></span>. command notNil ] whileTrue: [ command isEmpty ifFalse: [ command doIt printNl ] ]</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, using the readline library, we get the command string. </font><font style="vertical-align: inherit;">Then a message is sent to the line object </font></font><code>#doIt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the result of which is displayed on the screen. </font><font style="vertical-align: inherit;">The method itself is </font></font><code>#doIt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as follows:</font></font><br><br><pre> <code class="smalltalk hljs">doIt | method | method &lt;- Undefined parseMethod: 'doItCommand ^ ' + self. ^ method notNil ifTrue: [ ^ Context new perform: method withArguments: (Array new: 1) ]</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All the magic is created in the method </font></font><code>Undefined&gt;&gt;parseMethod:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that, according to the source text, forms the object of the method </font></font><code>#doItCommand</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the compiler implemented here in the text of the image. </font><font style="vertical-align: inherit;">It turns out that Smalltalk compiles its own methods by means of a compiler written in Smalltalk itself and an integral part of the image. </font><font style="vertical-align: inherit;">I find this moment rather amusing. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the method object has been created, to call it, a context object is created with which the created method is executed. </font><font style="vertical-align: inherit;">Since the new method was not added to the lists of methods of any of the classes, it will exist only at the time of its execution (well, until the next garbage collection).</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Virtual Machine Instructions </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A virtual machine can only execute instructions within methods. </font><font style="vertical-align: inherit;">Outside code methods do not exist. </font><font style="vertical-align: inherit;">Instructions are stored in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">byteCodes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field of the </font><font style="vertical-align: inherit;">class instance </font></font><code>Method</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The instance itself also contains additional information, which is also used when initializing the context object (see above). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since the article has already expanded greatly, here I will not describe in detail the format of the representation of bytecodes. </font><font style="vertical-align: inherit;">I note only that one instruction can occupy one or two bytes.</font></font><br><br><h6><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Instructions for working with a stack of values </font></font></h6><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are even </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">push</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instructions pushing one of the objects to the top of the value stack. </font><font style="vertical-align: inherit;">Along with the instruction code, an integer parameter is also specified, which is interpreted as an index for selecting an object from the corresponding data structure:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pushArgument</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - an argument from the current context argument array.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pushInstance</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the field of the current object.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pushTemporary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a temporary variable from an array of current context variables.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pushLiteral</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a literal from a constant array of literals of this method.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There are two more special push instructions that work a little differently: </font></font><br><br><ul><li> <b>pushConstant</b> ‚Äî           : <code>SmallInt</code> ,   <b>0-9</b> ,     <b>nil</b> , <b>true</b>  <b>false</b> ,   <code>Undefined</code> , <code>True</code>  <code>False</code> . </li><li> <b>pushBlock</b> ‚Äî         <code>Block</code> ,    - ,     .     <b>bytePointer</b>     . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are also several inverse operations. </font><font style="vertical-align: inherit;">The following operations allow you to change the values ‚Äã‚Äãof fields and temporary variables </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">without removing the</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> values ‚Äã‚Äãfrom the stack. </font><font style="vertical-align: inherit;">Fields and variables are also indexed with an optional integer parameter.</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assignInstance</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - assigns a value to the field of the current object that lies on top of the stack.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assignTemporary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - assigns a temporary variable the value that lies on top of the stack.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since both the arguments and literals in the framework of a method call are considered constants, assignment operations for them do not exist. </font><font style="vertical-align: inherit;">To remove the value from the stack, a separate operation ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">popTop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) is </font><b><font style="vertical-align: inherit;">provided</font></b><font style="vertical-align: inherit;"> , which will be discussed below.</font></font><br><br><h6><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Transition instructions </font></font></h6><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There are, of course, and transition instructions: </font></font><br><ul><li> <b>branchIfTrue</b> ‚Äî  <b>bytePointer</b>    ,     <b>true</b> . </li><li> <b>branchIfFalse</b> ‚Äî  ,       <b>false</b> . </li><li> <b>branch</b> ‚Äî     . </li></ul><br><h6>    </h6><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Although the procedure for sending a message is universal and can be used everywhere, in some cases its specialized implementations are used to speed up processing. </font><font style="vertical-align: inherit;">Such special cases are the operations of sending unary and binary messages. </font><font style="vertical-align: inherit;">Separate </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sendUnary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sendBinary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instructions are provided for them </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A normal message is sent by the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sendMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instruction </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When a message is sent, the arguments are </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pushed onto the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> stack, after which the </font><b><font style="vertical-align: inherit;">markArguments N</font></b><font style="vertical-align: inherit;"> instruction is </font><b><font style="vertical-align: inherit;">called</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It removes N values ‚Äã‚Äãfrom the stack and forms an object from them </font></font><code>Array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Further, a pointer to this object returns to the top of the stack, which will be used when initializing the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arguments</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field of the </font><font style="vertical-align: inherit;">context object being created.</font></font><br><br><h6><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Return instructions </font></font></h6><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sooner or later, the methods will need to somehow return. This is done using return instructions. The main one is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stackReturn</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which removes the value from the stack and passes it to the calling context, and then terminates the execution of the current method context. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to returning an arbitrary value in Smalltalk, it is very often necessary to return </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">self</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as a result. Therefore, a separate </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selfReturn</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instruction is provided for such an operation </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last return instruction is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blockReturn</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, explain which on the fingers is quite difficult. The basic idea is that control is not transferred to the generating context, but much higher, to the parent context of the method containing the declaration of the currently executing block. This behavior can be compared to the exclusion mechanism in other languages. But unlike exceptions, which occur only in special situations of the program and generally do not belong to the ‚Äúnormal‚Äù course of program execution, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blockReturn</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is quite a regular operation from the point of view of a virtual machine and can be used in common code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The easiest way to show it by example. This is the text of the method.</font></font><code>Collection&gt;&gt;at:ifAbsent:</code> <br><pre> <code class="smalltalk hljs">at: value ifAbsent: exceptionBlock <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> do: [ :element | element = value ifTrue: [ ^element ] ]. ^exceptionBlock value</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An expression </font></font><code>^element</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that is in the nested block itself will be compiled using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blockReturn statement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This is necessary because in reality, the block will be executed not in the current method, but much deeper. The method </font></font><code>Collection&gt;&gt;at:ifAbsent:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calls a method </font></font><code>Collection&gt;&gt;do:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, passing an external block as a parameter. The method </font></font><code>Collection&gt;&gt;do:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in turn will call </font></font><code>Block&gt;&gt;value:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for each element of the collection, passing it as a parameter to the block. And only inside </font></font><code>Block&gt;&gt;value:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is located the primitive number 8, which will already lead to the execution of the block code. Therefore, the code block decides that it is necessary to perform a return value </font></font><code>element</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it will do this using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blockReturn</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instruction </font><font style="vertical-align: inherit;">, which will transfer control to the very top, beyond</font></font><code>Collection&gt;&gt;at:ifAbsent:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, returning the required value as the result of the message. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It should be noted that not every operator </font></font><code>^</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">standing in the body of the block will be converted to a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blockReturn</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instruction </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Whenever possible, the compiler tries to expand the code into simpler instructions: embed the blocks in the body of the executing method and replace the block call with simple transitions according to the instructions. </font><font style="vertical-align: inherit;">In this case, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blockReturn</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will also be replaced by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stackReturn</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selfReturn</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h6><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Special instructions </font></font></h6><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to the above instructions, there are some more auxiliary. </font><font style="vertical-align: inherit;">These include </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">popTop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dup</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instructions </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The first simply removes the value from the top of the stack, which was put there earlier using one of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">push</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instructions (or the virtual machine itself, as a result of sending a message). </font><font style="vertical-align: inherit;">Typically, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">popTop is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> used after </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assignInstance</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assignTemporary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , to remove a value that is no longer needed from the stack. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The instruction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dup</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as you might guess from the name, duplicates the value on the stack, placing it alongside exactly the same. </font><font style="vertical-align: inherit;">This instruction is used by the Smalltalk compiler when parsing complex expressions with conditions.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Execution method </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As noted above, execution begins with the creation of a context object. After that, the virtual machine extracts and decodes the byte code of the first instruction. Then the machine begins to follow the instructions one by one, until it stumbles upon either the message being sent or the transition instruction. The method completes as soon as one of the return instructions is encountered. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will follow the execution of the method and the work of the JIT compiler on the basis of the collection sorting method already familiar to us from the previous article:</font></font><br><br><pre> <code class="smalltalk hljs">-&gt;<span class="hljs-type"><span class="hljs-type">Collection</span></span> viewMethod: <span class="hljs-symbol"><span class="hljs-symbol">#sort</span></span>: sort: criteria | left right mediane | (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> size &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>) ifTrue: [ ^ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> insertSort: criteria ]. mediane &lt;- <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> popFirst. left &lt;- <span class="hljs-type"><span class="hljs-type">List</span></span> new. right &lt;- <span class="hljs-type"><span class="hljs-type">List</span></span> new. <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> do: [ :x | (criteria value: x value: mediane) ifTrue: [ left add: x ] ifFalse: [ right add: x ] ]. left &lt;- left sort: criteria. right &lt;- right sort: criteria. right add: mediane. ^ left appendList: right</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The result of compiling such a method is a whole sheet of instructions. A detailed explanation of the logic of the work is still beyond the scope of this article, so try to simply view the byte codes and understand which parts correspond to what. In fact, it is not so difficult. Unlike the traditional assembler, here the instructions are used rather monotonously and consistently. First, the stack of values ‚Äã‚Äãis filled with arguments of the future call; then, using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">markArguments</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , an array of arguments is formed of them, which is already used in a particular message sending operation. Well, the transition instructions control all this disgrace. For convenience of reading, I repulsed with blank lines blocks of instructions related to one package and supplied them with comments:</font></font><br><br><pre> <code class="smalltalk hljs">-&gt;<span class="hljs-type"><span class="hljs-type">Collection</span></span> methods at: <span class="hljs-symbol"><span class="hljs-symbol">#sort</span></span>:; disassemble <span class="hljs-comment"><span class="hljs-comment">"  "</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-type"><span class="hljs-type">PushArgument</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">"    self"</span></span> <span class="hljs-number"><span class="hljs-number">0001</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0002</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> size <span class="hljs-number"><span class="hljs-number">0003</span></span> <span class="hljs-type"><span class="hljs-type">PushLiteral</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">"  1        32"</span></span> <span class="hljs-number"><span class="hljs-number">0004</span></span> <span class="hljs-type"><span class="hljs-type">SendBinary</span></span> &lt; <span class="hljs-comment"><span class="hljs-comment">" "</span></span> <span class="hljs-number"><span class="hljs-number">0005</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> branchIfFalse <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-comment"><span class="hljs-comment">"     "</span></span> <span class="hljs-comment"><span class="hljs-comment">"  :"</span></span> <span class="hljs-number"><span class="hljs-number">0008</span></span> <span class="hljs-type"><span class="hljs-type">PushArgument</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0009</span></span> <span class="hljs-type"><span class="hljs-type">PushArgument</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0010</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0011</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> insertSort: <span class="hljs-number"><span class="hljs-number">0012</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> stackReturn <span class="hljs-number"><span class="hljs-number">0013</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> branch <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-comment"><span class="hljs-comment">"   :"</span></span> <span class="hljs-number"><span class="hljs-number">0016</span></span> <span class="hljs-type"><span class="hljs-type">PushConstant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span> <span class="hljs-comment"><span class="hljs-comment">" "</span></span> <span class="hljs-number"><span class="hljs-number">0017</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> popTop <span class="hljs-comment"><span class="hljs-comment">"mediane &lt;- self popFirst"</span></span> <span class="hljs-number"><span class="hljs-number">0018</span></span> <span class="hljs-type"><span class="hljs-type">PushArgument</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0019</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0020</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> popFirst <span class="hljs-number"><span class="hljs-number">0021</span></span> <span class="hljs-type"><span class="hljs-type">AssignTemporary</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0022</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> popTop <span class="hljs-comment"><span class="hljs-comment">"left &lt;- List new"</span></span> <span class="hljs-number"><span class="hljs-number">0023</span></span> <span class="hljs-type"><span class="hljs-type">PushLiteral</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">0024</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0025</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> new <span class="hljs-number"><span class="hljs-number">0026</span></span> <span class="hljs-type"><span class="hljs-type">AssignTemporary</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0027</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> popTop <span class="hljs-comment"><span class="hljs-comment">"right &lt;- List new"</span></span> <span class="hljs-number"><span class="hljs-number">0028</span></span> <span class="hljs-type"><span class="hljs-type">PushLiteral</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">0029</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0030</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> new <span class="hljs-number"><span class="hljs-number">0031</span></span> <span class="hljs-type"><span class="hljs-type">AssignTemporary</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0032</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> popTop <span class="hljs-comment"><span class="hljs-comment">"self do: ..."</span></span> <span class="hljs-number"><span class="hljs-number">0033</span></span> <span class="hljs-type"><span class="hljs-type">PushArgument</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0034</span></span> <span class="hljs-type"><span class="hljs-type">PushBlock</span></span> <span class="hljs-comment"><span class="hljs-comment">" "</span></span> <span class="hljs-number"><span class="hljs-number">0037</span></span> <span class="hljs-type"><span class="hljs-type">PushArgument</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">"criteria"</span></span> <span class="hljs-number"><span class="hljs-number">0038</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-comment"><span class="hljs-comment">"x"</span></span> <span class="hljs-number"><span class="hljs-number">0039</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">"mediane"</span></span> <span class="hljs-number"><span class="hljs-number">0040</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0041</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> value:value: <span class="hljs-comment"><span class="hljs-comment">"  "</span></span> <span class="hljs-number"><span class="hljs-number">0042</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> branchIfFalse <span class="hljs-number"><span class="hljs-number">52</span></span> <span class="hljs-comment"><span class="hljs-comment">"left add: x"</span></span> <span class="hljs-number"><span class="hljs-number">0045</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0046</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0047</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0048</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> add: <span class="hljs-number"><span class="hljs-number">0049</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> branch <span class="hljs-number"><span class="hljs-number">56</span></span> <span class="hljs-comment"><span class="hljs-comment">"right add: x"</span></span> <span class="hljs-number"><span class="hljs-number">0052</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0053</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0054</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0055</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> add: <span class="hljs-number"><span class="hljs-number">0056</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> stackReturn <span class="hljs-number"><span class="hljs-number">0057</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0058</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> do: <span class="hljs-number"><span class="hljs-number">0059</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> popTop <span class="hljs-comment"><span class="hljs-comment">"  left"</span></span> <span class="hljs-number"><span class="hljs-number">0060</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0061</span></span> <span class="hljs-type"><span class="hljs-type">PushArgument</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0062</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0063</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> sort: <span class="hljs-number"><span class="hljs-number">0064</span></span> <span class="hljs-type"><span class="hljs-type">AssignTemporary</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0065</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> popTop <span class="hljs-comment"><span class="hljs-comment">"  right"</span></span> <span class="hljs-number"><span class="hljs-number">0066</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0067</span></span> <span class="hljs-type"><span class="hljs-type">PushArgument</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0068</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0069</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> sort: <span class="hljs-number"><span class="hljs-number">0070</span></span> <span class="hljs-type"><span class="hljs-type">AssignTemporary</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0071</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> popTop <span class="hljs-comment"><span class="hljs-comment">"right add: mediane"</span></span> <span class="hljs-number"><span class="hljs-number">0072</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0073</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0074</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0075</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> add: <span class="hljs-number"><span class="hljs-number">0076</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> popTop <span class="hljs-comment"><span class="hljs-comment">"  "</span></span> <span class="hljs-number"><span class="hljs-number">0077</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0078</span></span> <span class="hljs-type"><span class="hljs-type">PushTemporary</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0079</span></span> <span class="hljs-type"><span class="hljs-type">MarkArguments</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0080</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> appendList: <span class="hljs-comment"><span class="hljs-comment">" "</span></span> <span class="hljs-number"><span class="hljs-number">0081</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> stackReturn <span class="hljs-comment"><span class="hljs-comment">"( )"</span></span> <span class="hljs-number"><span class="hljs-number">0082</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> popTop <span class="hljs-number"><span class="hljs-number">0083</span></span> <span class="hljs-type"><span class="hljs-type">DoSpecial</span></span> selfReturn</code> </pre><br><br><h4>  Conclusion </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... In general, this is all I wanted to tell about the internal structure of the Smalltalk virtual machine in this article. The format of the narrative requires conciseness, but this should be done not at the expense of understanding. I hope that I managed to find a middle ground. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We learned how objects look in a Smalltalk image, how numbers appear, figured out the algorithm for sending a message and finding the appropriate class, found out what the context object is; Finally, we got acquainted with the basic instructions of the virtual machine, examined the code of the sorting method already known to us and the instructions to which it is translated by the compiler. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the </font></font><a href="http://habrahabr.ru/post/197474/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">next article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addresses issues of JIT compiling Smalltalk methods into an intermediate IR code, understandable by LLVM. </font><font style="vertical-align: inherit;">In turn, it will be compiled into the actual instructions of the processor. </font><font style="vertical-align: inherit;">We will analyze the bytecodes of the method and try to understand what needs to be done to translate them to the IR in an optimal way. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, a small survey:</font></font></div><p>Source: <a href="https://habr.com/ru/post/191250/">https://habr.com/ru/post/191250/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191236/index.html">How to start developing games even if you were an accountant before</a></li>
<li><a href="../191240/index.html">Elliptical cryptography: practice</a></li>
<li><a href="../191242/index.html">Programmer's brain</a></li>
<li><a href="../191246/index.html">Conflict Resolution in Transitive Dependencies - Good, Bad, Angry</a></li>
<li><a href="../191248/index.html">ASP.NET MVC client-side routing</a></li>
<li><a href="../191252/index.html">Parsing and building syntax trees with PLY. The basics</a></li>
<li><a href="../191254/index.html">The German government warns the country's authorities against using Windows 8</a></li>
<li><a href="../191256/index.html">Features parsing block HTML-code screen access programs</a></li>
<li><a href="../191262/index.html">RosVybory Danger</a></li>
<li><a href="../191266/index.html">Meet-in-the-middle: brute force optimization and more</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>