<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Blink Scroll lock'om with incoming email message (perl + bash)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Based on this question. 

 Task: learn to blink the keyboard LED in case there are new unread messages in our mailbox. 

 Add. conditions: OS - linux,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Blink Scroll lock'om with incoming email message (perl + bash)</h1><div class="post__text post__text-html js-mediator-article">  Based on <a href="http://habrahabr.ru/qa/49182/">this</a> question. <br><br>  Task: learn to blink the keyboard LED in case there are new unread messages in our mailbox. <br><br>  Add.  conditions: OS - linux, language - perl (check of mail) and bash (actually blinking). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  Actually, as advised in the original topic, we divide the task into its components: <br><ol><li>  Learn to blink diode </li><li>  Learn to check for new mail. </li><li>  Make friends both items among themselves </li></ol><br><br><h5>  Learning to blink diode </h5><br>  There is a daemon <a href="http://sampo.kapsi.fi/ledcontrol/">Ledcontrol</a> , but it did not appear in my repositories, so I will blink with the cursor using the <a href="http://www.x.org/archive/X11R7.5/doc/man/man1/xset.1.html">xset</a> command <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash trap 'xset -led named "Scroll Lock"; exit ' SIGINT SIGTERM while(true); do xset led named "Scroll Lock" ; sleep 0.05 ; xset -led named "Scroll Lock"; sleep 0.05; done</span></span></code> </pre> <br>  this code was saved to the beepScroll file, the file was put in one of the directories listed in $ PATH, and the execution rights were given.  Please note that when receiving SIGINT we turn off the LED and turn off via trap. <br><h5>  Learning to check mail for new messages </h5><br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mymail</span></span></span></span>(){ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Mail::IMAPClient; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> IO::Socket::SSL; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">42</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $user = <span class="hljs-string"><span class="hljs-string">'login'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $server = <span class="hljs-string"><span class="hljs-string">'server.ltd'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $pass = <span class="hljs-string"><span class="hljs-string">'P@ssw0rd'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $socket = IO::Socket::SSL-&gt;new( <span class="hljs-string"><span class="hljs-string">PeerAddr =&gt;</span></span> $server, <span class="hljs-string"><span class="hljs-string">PeerPort =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">993</span></span>, ) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> <span class="hljs-string"><span class="hljs-string">"socket(): $@"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $imap = Mail::IMAPClient-&gt;new( <span class="hljs-string"><span class="hljs-string">Socket =&gt;</span></span> $socket, <span class="hljs-string"><span class="hljs-string">Server =&gt;</span></span> $server, <span class="hljs-string"><span class="hljs-string">User =&gt;</span></span> $user, <span class="hljs-string"><span class="hljs-string">Password =&gt;</span></span> $pass, <span class="hljs-string"><span class="hljs-string">Debug =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> <span class="hljs-string"><span class="hljs-string">"Cannot connect to $server as $user: $@"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $not_read; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $f ($imap-&gt;folders) { <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $i = $imap-&gt;unseen_count($f)||<span class="hljs-number"><span class="hljs-number">0</span></span> ; $not_read += $i; } $imap-&gt;logout(); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> $not_read; } }</code> </pre><br>  Here we connect the necessary modules (Mail :: IMAPClient is not included in the standard delivery, it will need to be delivered separately) and run an infinite loop that 1) connects to imap to the server, receives the number of unread messages in the INBOX directory and its subdirectories and returns their number, waiting minute and starts from the beginning. <br><br><h5>  Friends all together </h5><br>  Here I would like to stay more.  We will run 2 threads.  The first will check mail and send the number of unread messages to the second.  The second one will receive messages from the first one to start / stop the blinking script with the cursor. <br>  So: <pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl #   use strict; use threads; #  use Thread::Queue; #       my $mypipe = Thread::Queue-&gt;new; #  #    threads-&gt;create(\&amp;mymail); #   threads-&gt;create(\&amp;myleds)-&gt;join; #    </span></span></code> </pre><br>  join in the second thread means that we need to wait for the end of the work of this thread before continuing. <br>  The code of the myleds function itself: <br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myleds</span></span></span></span>(){ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $beep = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">#1     . my $mypid; # pid ,   while($_ = $mypipe-&gt;dequeue){ #     if ($_ &gt; 1){ if ($beep == 0){ $mypid = `nohup beepScroll &gt; /dev/null 2&gt;&amp;1 &amp;echo \$!`; #     pid'   $beep = 1; } } else { `kill $mypid` if $mypid; #    ,      . $mypid = 0 if $mypid; $beep = 0; } } }</span></span></code> </pre>  , and in the mymail () function should be replaced <pre> <code class="perl hljs">prinr $not_read</code> </pre>  on <pre> <code class="perl hljs">$mypipe-&gt;enqueue($not_read+<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre>  "$ not_read + 1" because if while receives 0, it will consider that the conditions are false. <br><br><div class="spoiler">  <b class="spoiler_title">The final version of the script</b> <div class="spoiler_text"><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use strict; use threads; use Thread::Queue; my $mypipe = Thread::Queue-&gt;new; threads-&gt;create(\&amp;mymail); threads-&gt;create(\&amp;myleds)-&gt;join; sub mymail(){ use Mail::IMAPClient; use IO::Socket::SSL; while (42){ my $user = 'login'; my $server = 'server.ltd'; my $pass = 'P@ssw0rd'; my $socket = IO::Socket::SSL-&gt;new( PeerAddr =&gt; $server, PeerPort =&gt; 993, ) or die "socket(): $@"; my $imap = Mail::IMAPClient-&gt;new( Socket =&gt; $socket, Server =&gt; $server, User =&gt; $user, Password =&gt; $pass, Debug =&gt; 0) or die "Cannot connect to $server as $user: $@"; my $not_read; foreach my $f ($imap-&gt;folders) { my $i = $imap-&gt;unseen_count($f)||0 ; $not_read += $i; } $imap-&gt;logout(); $mypipe-&gt;enqueue($not_read+1); sleep 60; } #     ...     :) $mypipe-&gt;enqueue(undef); exit 1; } sub myleds(){ my $beep = 0; my $mypid; while($_ = $mypipe-&gt;dequeue){ if ($_ &gt; 1){ if ($beep == 0){ $mypid = `nohup beepScroll &gt; /dev/null 2&gt;&amp;1 &amp;echo \$!`; $beep = 1; } } else { $beep = 0; `kill $mypid` if $mypid; $mypid = 0 if $mypid; } } }</span></span></code> </pre></div></div></div><p>Source: <a href="https://habr.com/ru/post/199270/">https://habr.com/ru/post/199270/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../199256/index.html">Motion planning: visibility graph, road maps</a></li>
<li><a href="../199258/index.html">Barcode Android Recognition</a></li>
<li><a href="../199264/index.html">Uzbeks and IT</a></li>
<li><a href="../199266/index.html">Runtime-generating .Net code for those who have no time</a></li>
<li><a href="../199268/index.html">How I did multilanguage on Codeigniter</a></li>
<li><a href="../199272/index.html">Is meditation another way to motivate, or why does Google provide rooms for them?</a></li>
<li><a href="../199278/index.html">System of selling computer and video games with distributed cost</a></li>
<li><a href="../199280/index.html">Re: Developer Interview (Alternative / Addition)</a></li>
<li><a href="../199282/index.html">R: ellipse package for rendering trust areas</a></li>
<li><a href="../199284/index.html">blender + Unity 3D export of human skeleton for further development under wp</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>