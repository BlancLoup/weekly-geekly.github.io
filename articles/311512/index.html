<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing Ruby gem for Yandex Direct API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I really wanted to study Ruby better, but there was no working draft. And I tried to write a gem to work with the Yandex Direct API. 


 There were se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing Ruby gem for Yandex Direct API</h1><div class="post__text post__text-html js-mediator-article"><p>  I really wanted to study Ruby better, but there was no working draft.  And I tried to write a gem to work with the Yandex Direct API. </p><br><p>  There were several reasons.  Among them: Yandex Direct API is very typical for Yandex and modern REST services in general.  If you understand and overcome typical errors, you can easily and quickly write counterparts for other Yandex APIs (and not only).  And one more thing: all the analogs that I managed to find had problems with the support of the Yandex.Direct versions: some were sharpened for 4, others for the new 5, and I never found support for units. </p><br><h1 id="metaprogrammirovanie---velikaya-vesch">  Metaprogramming is a great thing. </h1><br><p>  The main idea of ‚Äã‚Äãgem-a - once in a language like Ruby or Python, you can create new methods and JSON-like objects on the fly, the interface methods for accessing the REST service can repeat the functions of the Rest-service itself.  To be able to write like this: </p><br><pre><code class="ruby hljs">request = { <span class="hljs-string"><span class="hljs-string">"SelectionCriteria"</span></span> =&gt; { <span class="hljs-string"><span class="hljs-string">"Types"</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">"TEXT_CAMPAIGN"</span></span>] }, <span class="hljs-string"><span class="hljs-string">"FieldNames"</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">"Id"</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span>], <span class="hljs-string"><span class="hljs-string">"TextCampaignFieldNames"</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">"BiddingStrategy"</span></span>] } options = { <span class="hljs-symbol"><span class="hljs-symbol">token:</span></span> Token } @direct = Ya::API::Direct::Client.new(options) json = direct.campaigns.get(request)</code> </pre> <br><p>  And instead of writing help, send users to the manuals on the specified API. </p><a name="habracut"></a><br><p>  Methods from old versions call, for example, like this: </p><br><pre> <code class="ruby hljs">json = direct.v4.GetCampaignsList</code> </pre> <br><p>  In case you are not interested in reading, but want to try - you can get a ready-made gem from here: </p><br><ul><li>  <a href="http://rubygems.org/gems/ya-api-direct/">ya-api-direct on RubyGems</a> </li><li>  <a href="http://github.com/rikkimongoose/ya-api-direct">ya-api-direct on github</a> </li></ul><br><p>  You can learn about getting an omniauth-token from rails <a href="https://www.sitepoint.com/rails-authentication-oauth-2-0-omniauth/">from the twitter example</a> .  And the names of the methods and the registration procedure are described in great detail in the <a href="https://tech.yandex.ru/direct/">documentation from Yandex</a> . </p><br><p>  If details are interesting - they are further. </p><br><h2 id="nachinaem-razrabotku">  We start the development </h2><br><p>  Of course, the article describes the most basic experience and the simplest things.  But it can be useful for beginners (like me), as a reminder on creating a typical gem.  It is interesting to collect information on articles, of course, but for a long time. </p><br><p>  Finally, it may be that some of the readers really need to quickly add support for the Yandex Direct API to their project. </p><br><p>  And also it will be useful to me - in terms of feedback. </p><br><h2 id="proverochnyy-skript">  Check script </h2><br><p>  To begin, let's register in Yandex Direct, create a test application there and get a temporary Token for it. </p><br><p>  Then open the <a href="https://tech.yandex.ru/direct/">Yandex Direct API help</a> and learn how to call methods.  Somehow: </p><br><p>  For version 5: </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"openssl"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"json"</span></span> Token = <span class="hljs-string"><span class="hljs-string">"TOKEN"</span></span> <span class="hljs-comment"><span class="hljs-comment">#    TOKEN. def send_api_request_v5(request_data) url = "https://%{api}.direct.yandex.com/json/v5/%{service}" % request_data uri = URI.parse(url) request = Net::HTTP::Post.new(uri.path, initheader = { 'Client-Login' =&gt; request_data[:login], 'Accept-Language' =&gt; "ru", 'Authorization' =&gt; "Bearer #{Token}" }) request.body = { "method" =&gt; request_data[:method], "params" =&gt; request_data[:params] }.to_json http = Net::HTTP.new(uri.host, uri.port) http.use_ssl = true http.verify_mode = OpenSSL::SSL::VERIFY_NONE response = http.request(request) if response.kind_of? Net::HTTPSuccess JSON.parse response.body else raise response.inspect end end p send_api_request_v5 api: "api-sandbox", login: "YOUR LOGIN HERE", service: "campaigns", method: "get", params: { "SelectionCriteria" =&gt; { "Types" =&gt; ["TEXT_CAMPAIGN"] }, "FieldNames" =&gt; ["Id", "Name"], "TextCampaignFieldNames" =&gt; ["BiddingStrategy"] }</span></span></code> </pre> <br><p>  For version 4 Live (Token fits both): </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"openssl"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"json"</span></span> Token = <span class="hljs-string"><span class="hljs-string">"TOKEN"</span></span> <span class="hljs-comment"><span class="hljs-comment">#    TOKEN. def send_api_request_v4(request_data) url = "https://%{api}.direct.yandex.com/%{version}/json/" % request_data uri = URI.parse(url) request = Net::HTTP::Post.new(uri.path) request.body = { "method" =&gt; request_data[:method], "param" =&gt; request_data[:params], "locale" =&gt; "ru", "token" =&gt; Token }.to_json http = Net::HTTP.new(uri.host, uri.port) http.use_ssl = true http.verify_mode = OpenSSL::SSL::VERIFY_NONE response = http.request(request) if response.kind_of? Net::HTTPSuccess JSON.parse(response.body) else raise response.inspect end end p send_api_request_v4 api: "api-sandbox", version: "live/v4", method: "GetCampaignsList", params: []</span></span></code> </pre> <br><p>  These scripts are already suitable for debugging and quick test requests. </p><br><p>  But, as the (mythical) person-month teaches us, the script for itself and the library for others are two different classes of applications.  And to transfer one to the other, to sweat. </p><br><h1 id="sozdayom-gem">  Create a gem </h1><br><p>  For a start it was necessary to determine the name - simple and not busy.  And he came to the conclusion that <strong>ya-api-direct</strong> is what is needed. </p><br><p>  Firstly, the structure itself is logical - and if, for example, ya-api-weather appears, it will be clear what it refers to.  Secondly, I still do not have an official product from Yandex to use the trademark as a prefix.  In addition, it is a hint of <a href="http://ya.ru/">ya.ru</a> , where the old laconic design is carefully kept. </p><br><p>  It‚Äôs a bit lazy to create all the folders with your hands.  Let the bundler do it for us: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">bundle</span></span> gem ya-api-direct</code> </pre> <br><p>  As a tool for UnitTest, I have indicated a minitest.  Then it will be clear why. </p><br><p>  Now we have a folder, and in it is a gem ready for assembly.  Its only flaw is that it is completely empty. </p><br><p>  But now we fix it. </p><br><h2 id="pishem-testy">  We write tests </h2><br><p>  UnitTests are incredibly useful for detecting slyly hidden bugs.  Almost every programmer, who nevertheless was able to write them and fix a couple of dozen bugs that hid in the source, promises himself that he will always write them now.  But still does not write. </p><br><p>  In some projects (probably, they are written by especially non-lazy programmers) there are both test and spec-tests.  But in the latest versions of minitest I suddenly learned the spec interface, and I decided to get along with some specs. </p><br><p>  Since we have an online interface and, moreover, points are written off for each request, we will fake the answers from Yandex Direct API.  For this we need a tricky gem <a href="https://github.com/bblimke/webmock">webmock</a> . </p><br><p>  Add to gems </p><br><pre> <code class="ruby hljs">group <span class="hljs-symbol"><span class="hljs-symbol">:test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gem <span class="hljs-string"><span class="hljs-string">'rspec'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;= 2.14'</span></span> gem <span class="hljs-string"><span class="hljs-string">'rubocop'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;= 0.37'</span></span> gem <span class="hljs-string"><span class="hljs-string">'webmock'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Update, rename the test folder to spec.  Since I was in a hurry, I wrote tests for external interfaces only. </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'ya/api/direct'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'minitest/autorun'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'webmock/minitest'</span></span> describe Ya::API::Direct::Client <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Token = <span class="hljs-string"><span class="hljs-string">"TOKEN"</span></span> <span class="hljs-comment"><span class="hljs-comment">#  , .. API   . before do </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@units</span></span></span><span class="hljs-comment"> = { just_used: 10, units_left: 20828, units_limit: 64000 } units_header = {"Units" =&gt; "%{just_used}/%{units_left}/%{units_limit}" % </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@units</span></span></span><span class="hljs-comment"> } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@campaigns</span></span></span><span class="hljs-comment">_get_body = { #     Yandex Direct API    } #    stub_request(:post, "https://api-sandbox.direct.yandex.ru/json/v5/campaigns") .with( headers: {'Accept'=&gt;'*/*', 'Accept-Encoding'=&gt;'gzip;q=1.0,deflate;q=0.6,identity;q=0.3', 'Accept-Language'=&gt;'en', 'Authorization'=&gt;'Bearer TOKEN', 'Client-Login'=&gt;'', 'User-Agent'=&gt;'Ruby'}, body: {"method" =&gt; "get", "params"=&gt; {}}.to_json) .to_return(:status =&gt; 200, body: </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@campaigns</span></span></span><span class="hljs-comment">_get_body.to_json, headers: units_header) #     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@clientV</span></span></span><span class="hljs-comment">4 = Ya::API::Direct::Client.new(token: Token, api: :v4) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@clientV</span></span></span><span class="hljs-comment">5 = Ya::API::Direct::Client.new(token: Token) end</span></span></code> </pre> <br><p>  webmock replaces the methods of standard libraries for working with HTTP, so that for requests with a specific body and headers the corresponding response is returned. </p><br><p>  If you make a mistake setting, it's not scary.  When you try to send a request that is not in the filter, the webmock will report an error and even tell you how to write the stub correctly. </p><br><p>  And we write specs: </p><br><pre> <code class="ruby hljs">describe <span class="hljs-string"><span class="hljs-string">"when does a request"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it <span class="hljs-string"><span class="hljs-string">"works well with version 4"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert @clientV4.v4.GetCampaignsList == @campaigns_get_body <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> it <span class="hljs-string"><span class="hljs-string">"works well with version 5"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert @clientV5.campaigns.get == @campaigns_get_body <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">#   </span></span></code> </pre> <br><h3 id="rake">  Rake </h3><br><p>  Rake is implemented so flexibly and simply that almost in every library it has its own structure.  So I just told him to run all the files that are called spec _ *. Rb and are in the spec directory: </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"bundler/gem_tasks"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"rake/testtask"</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">:spec</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Dir.glob(<span class="hljs-string"><span class="hljs-string">'./spec/**/spec_*.rb'</span></span>).each { <span class="hljs-params"><span class="hljs-params">|file|</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> file} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">test:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:spec</span></span>] task <span class="hljs-symbol"><span class="hljs-symbol">default:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:spec</span></span>]</code> </pre> <br><p>  Now our spec can be called like this: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">rake</span></span> test</code> </pre> <br><p>  Or even: </p><br><pre> <code class="hljs">rake</code> </pre> <br><p>  True, he has nothing to test. </p><br><h2 id="pishem-gem">  Write gem </h2><br><p>  First, fill in with information about gem (without this bundle will refuse to run).  Then we write to gemspec which third-party libraries we will use. </p><br><pre> <code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">'jruby-openssl'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">platforms:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:jruby</span></span> gem <span class="hljs-string"><span class="hljs-string">'rake'</span></span> gem <span class="hljs-string"><span class="hljs-string">'yard'</span></span> group <span class="hljs-symbol"><span class="hljs-symbol">:test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gem <span class="hljs-string"><span class="hljs-string">'rspec'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;= 2.14'</span></span> gem <span class="hljs-string"><span class="hljs-string">'rubocop'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;= 0.37'</span></span> gem <span class="hljs-string"><span class="hljs-string">'webmock'</span></span> gem <span class="hljs-string"><span class="hljs-string">'yardstick'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Do </p><br><pre> <code class="hljs sql">bundle <span class="hljs-keyword"><span class="hljs-keyword">install</span></span></code> </pre> <br><p>  and go to lib to create files. </p><br><p>  We will have the following files: </p><br><ul><li>  <strong>client.rb</strong> - external interface </li><li>  <strong>direct_service_base.rb</strong> - basic service for working with API </li><li>  <strong>direct_service_v4.rb</strong> - service for working with API 4 and 4 Live </li><li>  <strong>direct_service_v5.rb</strong> - service for working with API 5 </li><li>  <strong>gateway.rb</strong> - forwards and processes network requests = </li><li>  <strong>url_helper.rb</strong> - all sorts of static functions that are not in the <strong>gateway.rb</strong> </li><li>  <strong>constants.rb</strong> - list of available methods Yandex DIrect API </li><li>  <strong>exception.rb</strong> - an exception to show API errors </li><li>  <strong>version.rb</strong> - service file with version settings </li></ul><br><h3 id="kontrollery-dlya-raznyh-versiy">  Controllers for different versions </h3><br><p>  To begin with, we will create a file with constants, in which we will write all the functions from the API. </p><br><p>  <strong>contants.rb</strong> </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ya</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">API</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Direct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">API_V5</span></span></span><span class="hljs-class"> = { "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Campaigns</span></span></span><span class="hljs-class">" =&gt; [ "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">add</span></span></span><span class="hljs-class">", "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update</span></span></span><span class="hljs-class">", "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">delete</span></span></span><span class="hljs-class">", "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">suspend</span></span></span><span class="hljs-class">", "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resume</span></span></span><span class="hljs-class">", "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">archive</span></span></span><span class="hljs-class">", "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unarchive</span></span></span><span class="hljs-class">", "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">" ], </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#  .. } API_V4 = [ "GetBalance", #  .. ] API_V4_LIVE = [ "CreateOrUpdateCampaign", #  .. ] end end end</span></span></span></span></code> </pre> <br><p>  Now we will create a basic service wrapper, from which we will inherit the service for versions 4 and 5. </p><br><p>  <strong>direct_service_base.rb</strong> </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ya::API::Direct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DirectServiceBase</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_items</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods_data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_items</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods_data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init_methods</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protected</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init_methods</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_items</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">each</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">define_method</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> = {}| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">exec_request</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> || {}) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">callback_by_result</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">exec_request</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request_body</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gateway</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request_body</span></span></span><span class="hljs-class">, @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">callback_by_result</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">={}) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  In the constructor, it gets the source client and the list of methods.  And then creates them within itself through: define_method. </p><br><p>  And why can't we do with the method respond_to_missing?  (as many gems still do)?  Because it is slower and not so convenient.  And without that slow interpreter gets into it after an exception and checking in is_respond_to_missing? .. In addition, the methods created in this way fall into the results of the methods call, which is convenient for debugging. </p><br><p>  Now we will create a service for versions 4 and 4 Live. </p><br><p>  <strong>direct_service_v4.rb</strong> </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"ya/api/direct/constants"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"ya/api/direct/direct_service_base"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ya::API::Direct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DirectServiceV4</span></span></span><span class="hljs-class"> &lt; DirectServiceBase </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods_data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">super</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods_data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">exec_request</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request_body</span></span></span><span class="hljs-class"> = {}) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gateway</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request_body</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class">, (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">API_V4_LIVE</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include?</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">) ? :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4live</span></span></span><span class="hljs-class"> : @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  In version 5, the server not only responds to user requests, but also reports how many points were spent on the last request, how many were left and how many were in the current session.  Our service should be able to disassemble them (but we have not yet written how he will do it).  But we will indicate in advance that he must update the fields in the main client class. </p><br><p>  <strong>direct_service_v5.rb</strong> </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"ya/api/direct/direct_service_base"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ya::API::Direct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DirectServiceV5</span></span></span><span class="hljs-class"> &lt; DirectServiceBase </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service_url</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods_data</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">super</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods_data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service_url</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">downcase</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v5</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">exec_request</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request_body</span></span></span><span class="hljs-class">={}) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gateway</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request_body</span></span></span><span class="hljs-class">, @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service_url</span></span></span><span class="hljs-class">, @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">callback_by_result</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">={}) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_key?</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">units_data</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update_units_data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">units_data</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  By the way, have you noticed that some mysterious gateway is responsible for calling the request? </p><br><h3 id="gateway-i-urlhelper">  Gateway and UrlHelper </h3><br><p>  The Gateway class provides queries.  It moved most of the code from our script. <br>  <strong>gateway.rb</strong> </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"openssl"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"json"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"ya/api/direct/constants"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"ya/api/direct/url_helper"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ya::API::Direct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Gateway</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#    def request(method, params, service = "", version = nil) ver = version || (service.nil? ? :v4 : :v5) url = UrlHelper.direct_api_url </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@config</span></span></span></span><span class="hljs-class"><span class="hljs-comment">[:mode], ver, service header = generate_header ver body = generate_body method, params, ver uri = URI.parse url request = Net::HTTP::Post.new(uri.path, initheader = header) request.body = body.to_json http = Net::HTTP.new(uri.host, uri.port) http.use_ssl = true http.verify_mode = </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@config</span></span></span></span><span class="hljs-class"><span class="hljs-comment">[:ssl] ? OpenSSL::SSL::VERIFY_PEER : OpenSSL::SSL::VERIFY_NONE response = http.request(request) if response.kind_of? Net::HTTPSuccess UrlHelper.parse_data response, ver else raise response.inspect end end #     generate_header  generate_body #    ,   end end</span></span></span></span></code> </pre> <br><p>  The standard Net :: HTTP is involved because it is simple as a rake.  Quite possible to send requests from <a href="https://github.com/lostisland/faraday">faraday</a> .  OmniAuth (about which I will discuss below) works on it, and so the application will not overgrow any extra gems. </p><br><p>  Finally, UrlHelper is filled with static functions that generate URLs, parse data and parses Units (which is easy): </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"json"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"ya/api/direct/exception"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ya::API::Direct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegExUnits</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Regexp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> /(\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">+)\/(\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">+)\/(\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">+)/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UrlHelper</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">direct_api_url</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mode</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sandbox</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v5</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class"> = "") </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">format</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class"> = "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">https</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api_prefixes</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sandbox</span></span></span><span class="hljs-class">: "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sandbox</span></span></span><span class="hljs-class">", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">production</span></span></span><span class="hljs-class">: "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api</span></span></span><span class="hljs-class">" } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api_prefix</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api_prefixes</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mode</span></span></span><span class="hljs-class"> || :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sandbox</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class"> = "%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api</span></span></span><span class="hljs-class">}.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">direct</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yandex</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ru</span></span></span><span class="hljs-class">" % {</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api_prefix</span></span></span><span class="hljs-class">} </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api_urls</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class">: '%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class">}://%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">}/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">soap</span></span></span><span class="hljs-class">: '%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class">}://%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">}/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">soap</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wsdl</span></span></span><span class="hljs-class">: '%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class">}://%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">}/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wsdl</span></span></span><span class="hljs-class">', }, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4live</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class">: '%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class">}://%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">}/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">live</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">soap</span></span></span><span class="hljs-class">: '%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class">}://%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">}/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">live</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">soap</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wsdl</span></span></span><span class="hljs-class">: '%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class">}://%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">}/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">live</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wsdl</span></span></span><span class="hljs-class">', }, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v5</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class">: '%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class">}://%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">}/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v5</span></span></span><span class="hljs-class">/%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class">}', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">soap</span></span></span><span class="hljs-class">: '%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class">}://%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">}/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v5</span></span></span><span class="hljs-class">/%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class">}', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wsdl</span></span></span><span class="hljs-class">: '%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class">}://%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">}/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v5</span></span></span><span class="hljs-class">/%{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class">}?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wsdl</span></span></span><span class="hljs-class">', } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api_urls</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class">][</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">format</span></span></span><span class="hljs-class">] % { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extract_response_units</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_header</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">matched</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegExUnits</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_header</span></span></span><span class="hljs-class">["</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Units</span></span></span><span class="hljs-class">"] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">matched</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil?</span></span></span><span class="hljs-class"> ? {} : { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">just_used</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">matched</span></span></span><span class="hljs-class">[1].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">units_left</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">matched</span></span></span><span class="hljs-class">[2].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">units_limit</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">matched</span></span></span><span class="hljs-class">[3].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_i</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parse_data</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ver</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_body</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JSON</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parse</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validate_response!</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_body</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_body</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> [:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v5</span></span></span><span class="hljs-class">].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include?</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ver</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">merge!</span></span></span><span class="hljs-class">({ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">units_data</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extract_response_units</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">) }) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validate_response!</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_body</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_body</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_key?</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_error</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_body</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raise</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Exception</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_error</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error_detail</span></span></span><span class="hljs-class">'], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_error</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error_string</span></span></span><span class="hljs-class">'], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_error</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error_code</span></span></span><span class="hljs-class">']) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  If the server returned an error, we throw an Exception with its text. </p><br><p>  The code looks self-evident and that is quite good.  Self-explanatory code is easier to maintain. </p><br><h3 id="client">  Client </h3><br><p>  Now we need to write the client class itself, with which the external interfaces interact.  Since most of the functionality has already moved to the inner classes, it will be very short. </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"ya/api/direct/constants"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"ya/api/direct/gateway"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"ya/api/direct/direct_service_v4"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"ya/api/direct/direct_service_v5"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"ya/api/direct/exception"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'time'</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ya::API::Direct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AllowedAPIVersions</span></span></span><span class="hljs-class"> = [:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v5</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cache_timestamp</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">units_data</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gateway</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v4</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v5</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class"> = {}) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">token</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app_id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">login</span></span></span><span class="hljs-class">: '', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">locale</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">en</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mode</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sandbox</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">format</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cache</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v5</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ssl</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> }.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">merge</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">units_data</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">just_used</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">units_left</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">units_limit</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raise</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Token</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">can</span></span></span><span class="hljs-class">'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">empty</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">token</span></span></span><span class="hljs-class">].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil?</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raise</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Allowed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Yandex</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Direct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">API</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">versions</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">are</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{AllowedVersions}" unless AllowedAPIVersions.include? </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@config</span></span></span></span><span class="hljs-class"><span class="hljs-comment">[:api] </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@gateway</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Ya::API::Direct::Gateway.new </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@config</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> init_v4 init_v5 start_cache! if </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@config</span></span></span></span><span class="hljs-class"><span class="hljs-comment">[:cache] yield self if block_given? end def update_units_data(units_data = {}) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@units</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_data.merge! units_data end def start_cache! case </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@config</span></span></span></span><span class="hljs-class"><span class="hljs-comment">[:api] when :v4 result = </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@gateway</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.request("GetChanges", {}, nil, :v4live) timestamp = result[:data]['data']['Timestamp'] when :v5 result = </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@gateway</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.request("checkDictionaries", {}, "changes", :v5) timestamp = result[:data]['result']['Timestamp'] update_units_data result[:units_data] end </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@cache</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_timestamp = Time.parse(timestamp) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@cache</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_timestamp end private def init_v4 </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@v</span></span></span></span><span class="hljs-class"><span class="hljs-comment">4 = DirectServiceV4.new self, (API_V4 + API_V4_LIVE) end def init_v5 </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@v</span></span></span></span><span class="hljs-class"><span class="hljs-comment">5 = {} API_V5.each do |service, methods| service_item = DirectServiceV5.new(self, service, methods) service_key = service_item.service_url </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@v</span></span></span></span><span class="hljs-class"><span class="hljs-comment">5[service_key] = service_item self.class.send :define_method, service_key do </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@v</span></span></span></span><span class="hljs-class"><span class="hljs-comment">5[service_key] end end end end end</span></span></span></span></code> </pre> <br><p>  Methods of version 4 are written into the property v4, methods of version 5, grouped by individual services, become methods of the client class through the construction already familiar to us.  Now, when we call client.campaigns.get, Ruby will first execute client.campaigns (), and then call the get method on the received service. </p><br><p>  The last term of the constructor is needed so that the class can be used in the do ... end construction. </p><br><p>  Immediately after initialization, it executes (if it is specified in the settings) start_cache! To send an API command to enable caching.  The version in the settings only affects this, you can call the methods of both versions from the class instance.  The resulting date will be available in the cache_timestamp property. </p><br><p>  And in the units_data property will be the latest information on Units. </p><br><p>  Also in the project there is a class with version settings and exceptions.  With them, everything is so clear that even nothing to say.  The class with the version settings is generated by the bundle along with the project. </p><br><p>  Well, the file <strong>direct.rb</strong> need to specify those classes that should be visible to the user from the outside.  In our case, this is only the client class.  Plus version and exception (they are completely official). </p><br><h2 id="kompiliruem-i-zalivaem">  Compile and fill </h2><br><p>  To compile the gem, you can follow the <a href="http://guides.rubygems.org/make-your-own-gem/">manual with RubyGems.org</a> (there is nothing complicated).  Or use the <a href="https://habrahabr.ru/post/216141/">Mountable Engine from Rails</a> . </p><br><p>  And then we load on rubygems - suddenly this gem can be useful not only to us. </p><br><h2 id="kak-poluchit-token-iz-ruby-on-rails">  How to get token from Ruby on Rails </h2><br><p>  Logging in from Rails to the Yandec API and getting a token is very easy for any developer ... if not for the first time. </p><br><p>  As we already learned, a token is required to access the Direct API.  From the <a href="https://oauth.yandex.ru/">help from Yandex,</a> it follows that we have before us - the good old OAuth2, which is used by a bunch of services, including Twitter and Facebook. </p><br><p>  For Ruby, there is a classic gem <a href="https://github.com/omniauth/omniauth">omniauth</a> , from which they inherit OAuth2 implementations for various services.  <a href="https://github.com/evrone/omniauth-yandex">Omniauth-yandex is</a> already implemented.  With him, we will try to figure it out. </p><br><p>  Create a new rails application (we‚Äôll add to work projects after we learn).  Add to Gemfile: </p><br><pre> <code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">"omniauth-yandex"</span></span></code> </pre> <br><p>  And do bundle install. </p><br><p>  And then we use any manual for installing Omniauth authentication for rails.  <a href="https://www.sitepoint.com/rails-authentication-oauth-2-0-omniauth/">Here is an example for twitter</a> .  I think it‚Äôs not worth translating and retelling it - the article turned out to be so huge. </p><br><p>  I have an example described in the article earned.  The only amendment was that I did not write additional indexes to the User table, because SQLite does not support them. </p><br><p>  True, the article does not indicate where the token is hidden.  But it is not a secret at all.  In SessionController it will be available through </p><br><pre> <code class="ruby hljs"> request.env[<span class="hljs-string"><span class="hljs-string">'omniauth.auth'</span></span>].credentials.token</code> </pre> <br><p>  Just do not forget - each such authentication generates a token again.  And if you then try to use scripts with a direct indication of token, the server will say that the old one is no longer suitable.  You must return to the settings of the Yandex application, specify the debug callback URL again (__ <a href="https://oauth.yandex.ru/verification_code__">https://oauth.yandex.ru/verification_code__</a> ), and then regenerate the token. </p><br><p>  And even better, create a separate application for a static token so that debugging does not interfere. </p><br><h2 id="ssylki">  Links </h2><br><ul><li>  <a href="http://rubygems.org/gems/ya-api-direct/">ya-api-direct on RubyGems</a> </li><li><p>  <a href="http://github.com/rikkimongoose/ya-api-direct">ya-api-direct on github</a> </p><br></li><li>  <a href="https://oauth.yandex.ru/">Yandex OAuth Help</a> </li><li>  <a href="https://tech.yandex.ru/direct/">Help on Yandex Direct API</a> </li><li>  <a href="https://yandex.ru/adv/edu/direct-api">Online course on Yandex Direct API</a> </li><li><p>  <a href="https://www.sitepoint.com/rails-authentication-oauth-2-0-omniauth/">Omniauth-twitter setup</a> </p><br></li><li>  <a href="https://github.com/evrone/omniauth-yandex">omniauth-yandex</a> </li><li>  <a href="https://github.com/bblimke/webmock">webmock</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/311512/">https://habr.com/ru/post/311512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311494/index.html">Random non-randomness in games</a></li>
<li><a href="../311496/index.html">The difference between eastern and western games of the "three in a row" genre</a></li>
<li><a href="../311500/index.html">Routing in the clojure web application</a></li>
<li><a href="../311502/index.html">As I read the sensor readings via SNMP (Python + AgentX + systemd + Raspberry Pi) and built another monitor.</a></li>
<li><a href="../311506/index.html">Writing an extension using the php-cpp library for php7</a></li>
<li><a href="../311514/index.html">New life legacy project</a></li>
<li><a href="../311516/index.html">Success on autopilot. 9 habits that changed my life</a></li>
<li><a href="../311518/index.html">Text that does not exist</a></li>
<li><a href="../311520/index.html">Self-contained distribution of .NET Core applications</a></li>
<li><a href="../311524/index.html">The digest of interesting materials for the mobile developer # 173 (September 26 - October 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>