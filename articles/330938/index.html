<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Java: automatically generate SQL queries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will describe the creation of a framework for the automatic generation of SQL queries based on Java classes and objects. I understan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Java: automatically generate SQL queries</h1><div class="post__text post__text-html js-mediator-article">  In this article I will describe the creation of a framework for the automatic generation of SQL queries based on Java classes and objects.  I understand that there are already many ready-made similar solutions, but I wanted to implement it myself. <br><br>  To create the framework, we will use Java annotations and the Java Reflection API. <br><br>  So, let's begin. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h3>  Let's begin, perhaps, with examples of use </h3><br><h4>  Example ‚Ññ1 </h4><br>  Suppose we have a certain class Person: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String firstName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String lastName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> age; }</code> </pre> <br>  The following call will issue a SQL query to create a table based on this class: <br><br><pre> <code class="java hljs">System.out.println(MySQLQueryGenerator.generateCreateTableQuery(Person.class));</code> </pre><br>  Having started, we get the following output in the console: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`Person_table`</span></span> ( <span class="hljs-string"><span class="hljs-string">`firstName`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>), <span class="hljs-string"><span class="hljs-string">`lastName`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>), <span class="hljs-string"><span class="hljs-string">`age`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>);</code> </pre><br><h4>  Example 2 </h4><br>  Now the example is more complicated, using annotations: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@IfNotExists</span></span> <span class="hljs-comment"><span class="hljs-comment">//   CREATE- IF NOT EXISTS @TableName("persons") //    public static class Person { @AutoIncrement //   AUTO_INCREMENT @PrimaryKey //      PRIMARY KEY public int id; @NotNull //   NOT NULL public long createTime; @NotNull public String firstName; @NotNull public String lastName; @Default("21") //    public Integer age; @Default("") @MaxLength(1024) //  VARCHAR public String address; @ColumnName("letter") //    public Character someLetter; }</span></span></code> </pre><br>  Based on this class, we get the following SQL query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`persons`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`createTime`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`firstName`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`lastName`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`age`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'21'</span></span>, <span class="hljs-string"><span class="hljs-string">`address`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1024</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`letter`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>), PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>));</code> </pre><br><h4>  Example number 3 </h4><br>  I also created the <b>MySQLClient</b> class, which is able to connect to the database server and send generated SQL queries there. <br><br>  The client contains the following methods: <i>createTable</i> , <i>alterTable</i> , <i>insert</i> , <i>update</i> , <i>select</i> . <br><br>  It is used like this: <br><br><pre> <code class="java hljs">MySQLClient client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MySQLClient(<span class="hljs-string"><span class="hljs-string">"login"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>, <span class="hljs-string"><span class="hljs-string">"dbName"</span></span>); client.connect(); <span class="hljs-comment"><span class="hljs-comment">//    client.createTable(PersonV1.class); //   client.alterTable(PersonV1.class, PersonV2.class); //   PersonV2 person = new PersonV2(); person.createTime = new Date().getTime(); person.firstName = "Ivan"; person.lastName = "Ivanov"; client.insert(person); //     person.age = 28; person.createTime = new Date().getTime(); person.address = "Zimbabve"; client.insert(person); person.createTime = new Date().getTime(); person.firstName = "John"; person.lastName = "Johnson"; person.someLetter = 'i'; client.insert(person); List selected = client.select(PersonV2.class); //      System.out.println("Rows: " + selected.size()); for (Object obj: selected) { System.out.println(obj); } client.disconnect(); //   </span></span></code> </pre><br><h3>  How it works </h3><br>  First, the algorithm using the Reflection API enumerates all public and non-static fields of the class.  If the field is of a type supported by the algorithm (all primitive data types are supported, their object analogs, as well as the String type), then a <b>Column</b> object is created from the <b>Field</b> object containing data about the field of the database table.  Conversion between Java data types and MySQL types occurs automatically.  Also, from the annotations of the field and class, all modifiers of the table and its fields are extracted.  Then a SQL query is formed from all <b>Column</b> : <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateCreateTableQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class clazz)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> MoreThanOnePrimaryKeyException </span></span>{ List&lt;Column&gt; columnList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); Field[] fields = clazz.getFields(); <span class="hljs-comment"><span class="hljs-comment">//     for (Field field: fields) { int modifiers = field.getModifiers(); if (Modifier.isPublic(modifiers) &amp;&amp; !Modifier.isStatic(modifiers)) { //  public   static Column column = Column.fromField(field); //  Field  Column if (column!=null) columnList.add(column); } } /*   Column   */ } /***************************/ public static Column fromField(Field field) { Class fieldType = field.getType(); //     ColumnType columnType; if (fieldType == boolean.class || fieldType == Boolean.class) { columnType = ColumnType.BOOL; } /*     */ { } else if (fieldType==String.class) { columnType = ColumnType.VARCHAR; } else { //       return null; } Column column = new Column(); column.columnType = columnType; column.name = field.getName(); column.isAutoIncrement = field.isAnnotationPresent(AutoIncrement.class); /*    */ if (field.isAnnotationPresent(ColumnName.class)) { //      ColumnName columnName = (ColumnName)field.getAnnotation(ColumnName.class); String name = columnName.value(); if (!name.trim().isEmpty()) column.name = name; } return column; }</span></span></code> </pre><br>  Similarly, ALTER TABLE, INSERT and UPDATE queries are generated.  In the case of the last two, in addition to the Column list, the values ‚Äã‚Äãof its fields are also extracted from the object: <br><br><pre> <code class="java hljs">Column column = Column.fromField(field); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (column!=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (column.isAutoIncrement) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; Object value = field.get(obj); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value==<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; column.hasDefaultValue) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   :             if (column.isNotNull &amp;&amp; value==null) { throw new NotNullColumnHasNullValueException(); } String valueString = value!=null ? "'" + value.toString().replace("'","\\'") + "'" : "NULL"; String setValueString = "`"+column.name+"`="+valueString; valueStringList.add(setValueString); }</span></span></code> </pre><br>  Also in the framework, there is a <b>ResultSetExtractor</b> class, whose method <i>extractResultSet (ResultSet resultSet, Class clazz)</i> automatically creates from the resultSet a list of objects of the class clazz.  This is done quite simply, so I will not describe the principle of its operation here. <br><br>  On github you can see the <a href="https://github.com/tabatsky/ReflectData">full source code of the framework</a> .  I have it all. <br></div><p>Source: <a href="https://habr.com/ru/post/330938/">https://habr.com/ru/post/330938/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330928/index.html">IT Management: What ITSM is and the ServiceNow Platform</a></li>
<li><a href="../330930/index.html">It is a little about ServiceNow, ITSM and ServiceDesk in a format of selection of useful materials</a></li>
<li><a href="../330932/index.html">40 unusual questions asked at the interview at Apple</a></li>
<li><a href="../330934/index.html">And terrible Russian firewall will burst</a></li>
<li><a href="../330936/index.html">Optical character recognition on the microcontroller</a></li>
<li><a href="../330940/index.html">We compile, as if in the yard 1992</a></li>
<li><a href="../330942/index.html">The story of how cognitive technologies help preserve karma</a></li>
<li><a href="../330944/index.html">[Administrator's abstract] Domains, addresses and Windows: mix, but do not shake</a></li>
<li><a href="../330946/index.html">‚ÄúWhen a critical crash occurs with databases, it always happens somewhat epically‚Äù - Ilya Kosmodemyansky</a></li>
<li><a href="../330948/index.html">How to ensure that learning in games is not annoying</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>