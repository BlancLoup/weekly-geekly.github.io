<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Invalid mail server, or life without spam</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Fighting spam is the headache of all responsible mail administrators. What they do not invent, to make their lives better loved . However, as shown by...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Invalid mail server, or life without spam</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/storage/habraeffect/40/64/406409d2ee1d52d7ed3507f9ed6951e2.png">  Fighting spam is the headache of all responsible mail administrators.  What they do not invent, to make their <s>lives</s> better <s>loved</s> .  However, as shown by the practice of communicating with many system administrators, for some reason, not everyone can imagine how to properly filter spam. <br><br>  The most common approach is ‚Äúadd a bunch of RBL (DNSBL) and will enjoy life‚Äù.  The approach is not correct a little more than completely.  The second most popular - content filters, often bought for big money.  This approach is also in most cases completely unjustified. <br><br>  But everything is so simple, for a quiet life it is enough just to look closely at the three headers of the incoming SMTP session.  Having rummaged on Habr√© and in the back streets of the Internet, I didn‚Äôt find an exhaustive article on how to properly configure the SMTP server in terms of countering spam.  Therefore, I decided to paint everything that I know on this subject myself and what I successfully use. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      By the way: this article is certainly aimed primarily at administrators who want to make a high-quality spam filter.  However, on the other hand, it contains very important information for those who simply have to work with the mail, but who are not well versed in all the intricacies of the process of e-mailing correspondence. <br><br>  <b>So, if you want to protect your users from spam or vice versa, you want someone to accidentally not protect users from your emails - welcome under the cat.</b> <br> <a href=""><img src="https://habrastorage.org/storage/15d99bea/74da9b7e/c6a0ca3b/ad80903c.png" align="right"></a> <br><a name="habracut"></a>  A small note: the article was written with an eye to setting up a <b>Postfix</b> mail server, but on the whole it is rather theoretical.  The described Postfix options should be specified in the corresponding <b>* _restriction</b> parameters of the configuration file, for any details, refer to any Postfix configuration guide. <br><br><h4>  A bit about the SMTP protocol </h4><br>  E-mail has many similarities with ordinary mail.  The most important thing for us now is that all the information on the electronic "envelope" is just two addresses: the recipient and the sender, as well as the postman's stamp, the envelope delivered. <br><br>  Let's get a little distracted: Imagine that a face of extremely repulsive appearance will come to you and hand in a tightly sealed parcel with the return address ‚ÄúTray from Tilimililitryamdiya‚Äù.  Dare to accept and open?  Hardly.  So, email can also be easily checked and sifted out based on address information only, and the scope for possible actions here is much wider. <br><br>  As you should know, mail on the Internet is transferred between mail servers via SMTP.  Any communication on this protocol begins with three mandatory headers: <b>HELO</b> , <b>MAIL FROM</b> and <b>RCPT TO</b> .  That is, before starting to transmit any data, the server is first presented (HELO), then it reports the return sender address (MAIL FROM) and then the recipient address (RCPT TO).  These three headers are the signature on the electronic envelope, and almost all spam can be eliminated only on the basis of their analysis.  Most attempts to send something to my server do not go beyond MAIL FROM, that is, the letters are eliminated even before the actual acceptance, which significantly reduces the load.  That is, instead of opening the package from Tryam and discovering anthrax spores there, I immediately send the postman to hell. <br><br>  So, what should you do in order not to accept emails that are obviously spam?  Let's go in order. <br><br><h4>  A bit about DNS </h4><br>  Sometime in the early days of the Internet, mail was delivered directly to the sites listed in the mailing address.  That is, to deliver a letter for user@domain.com, the mail server searched for the IP address of domain.com and tried to send a parcel using the found IP.  Then MX records appeared that at once solved most of the problems of similar organization of mail interaction.  However, some programs can still work with A records when delivering mail.  But you, of course, have at least one MX record for your domain, right? <br><br>  MX records contain server addresses <i>to</i> which emails for the specified domain should be delivered.  However, in order to combat spam, a technology has emerged that allows to indicate in DNS also the addresses of servers <i>from</i> which letters from a specified domain can come.  Her name is <a href="http://ru.wikipedia.org/wiki/Sender_Policy_Framework">Sender Policy Framework</a> . <br><br>  I will not go into all the details of the technology in detail; I will only say that the TXT record <br><br> <code>v=spf1 +mx -all <br></code> <br>  for your domain, it will tell all clients that support SPF checking that emails from your domain can come <i>exclusively</i> from the servers specified in the MX records.  You can make the rule softer by writing instead of <b>-all ~ all</b> .  For details, contact Google and the <a href="http://www.openspf.org/">official SPF website</a> . <br><br>  Always register the SPF record for the domain, as well as enable the SPF check on your mail servers.  I recommend to strictly forbid sending emails from your domain from all hosts except your MX servers.  Coupled with SPF checking on your server, such a setting immediately cuts off all emails sent from third-party hosts on behalf of users of your domain to addresses of users of your domain.  And almost half of such spam, because usually SMTP servers are very poorly protected from emails from their own domain, and spammers actively use this.  SPF once and for all relieve you of the letters to Vasya Pupkin, written judging by the envelope Vasya Pupkin, but coming from a server in some Nicaragua. <br><br>  How to configure SPF in Postfix will tell you Google, information in bulk and can not be mistaken, so we will not waste time on technical details. <br><br>  There are a couple of extremely important remarks about DNS.  Most likely you know that DNS master records, the so-called A records, convert the name to an IP address.  In addition to these, there are also CNAME records that assign a nickname to an already existing name.  It is these two types of records that form the basis of the entire domain name system. <br><br>  But few users know that there are also reverse entries that convert IP to a domain name.  They are called PTR.  So, there are two unwritten (strictly speaking) rules, which are still followed by everyone: <br><br><ul><li>  For each A record, there should be a <i>mirrored</i> PTR record, that is, by the host name via DNS we get IP, and by IP - the same host name back. </li><li>  The address in the MX record should always be the <b>name</b> (not IP!) Of the host for which an A record exists.  That is, it is impossible for an MX record to have an IP or alias (CNAME). </li></ul><br><br>  If you do not comply with one of these requirements - be prepared for the fact that at least a quarter of mail from your domain will be recognized as spam.  This is due to a simple thesis: the trustworthy sender always adjusts everything by observing the rules, respectively, if the rules are not followed - then the sender should not be trusted, and therefore also to receive mail from him - as well. <br><br>  Well, to enable PTR checking in your home, use the option <br><br> <code>reject_unknown_client_hostname <br></code> <br>  It requires that the IP from which the connection is made is resolved to the name via PTR, and this name is resolved in turn back to the desired IP. <br><br>  There is a less severe restriction given by the option <br><br> <code>reject_unknown_reverse_client_hostname <br></code> <br>  In this case, the server will check only the presence of the PTR record, but will not require the existence of the corresponding record A. <br><br><h4>  Checking the greeting </h4><br>  So, someone wanted to send a letter to your server.  The transfer begins with a greeting - the header HELO.  In HELO, the full domain name (FQDN) of the sender must be indicated, respectively, if this is not the case, you can safely refuse to accept it immediately.  There are two options for this in Postfix: <br><br> <code>reject_invalid_helo_hostname <br> reject_non_fqdn_helo_hostname <br></code> <br>  The first prohibits the reception of letters from hosts that send greetings with incorrect syntax, the second - from hosts that send non-FQDN in a HELO request. <br><br>  However, it‚Äôs not the FQDN that only the most stupid spammers (and MS products, but, as you know, they don‚Äôt write the laws), in the end it‚Äôs not difficult to introduce yourself to gmail.com.  Therefore, we must take a closer look at HELO.  For this are the option <br><br> <code>reject_unknown_helo_hostname <br></code> <br>  Which forbids the reception of letters from servers that appear to be an address for which there is no A or MX record. <br><br><h4>  Sender - is it worth trusting him? </h4><br>  So, the server successfully presented itself to you, the next item on the program is the sender's address.  From it, you can also extract a lot of useful information.  Just want to note that the sender's address does not have to be from the same domain as the server itself.  This is a common misconception, so keep in mind that it is not.  One mail server can easily serve several domains. <br><br>  However, if a domain is specified in the sender's address, which does not exist at all, then the letter is obviously not worth accepting.  And you certainly should not accept a letter in which something is indicated as the return address, which is not a general address at all.  For refusing to accept for such letters, there are two options: <br><br> <code>reject_non_fqdn_sender <br> reject_unknown_sender_domain <br></code> <br>  The first is checking the address for spelling, the second is checking the existence of a domain. <br><br>  Already not bad, but you can do something else.  You can request a server serving the specified sender address for the existence of a user with this address.  Indeed, it seems to be a good idea to make sure that the return address really exists, otherwise we may well receive a letter from an ephemeral phantom, about which no one ever heard. <br><br>  Technically, this is implemented very simply: our server opens a counter SMTP session, trying to send an email to the sender's address.  If it is possible to successfully pass the stage of sending RCPT TO with this address, i.e.  if the receiving server suddenly does not declare that the specified mailbox is not on it, it is considered that the return address sent to us exists.  The data (that is, the letter) of course, during verification, no data is transmitted, the session is terminated after RCPT TO. <br><br>  For such a return address check is the option <br><br> <code>reject_unverified_sender <br></code> <br>  It follows from the above that for any address from which you send mail from your domain, there must be a box on your server.  Otherwise, your letters will not pass the return address check on the recipient side and, accordingly, will not be delivered to the destination.  This is true for all mailings and other kind of one-way communication that does not require an answer.  Always create mailboxes for all addresses from which you send mail.  If you do not want to receive replies to any address, then just send letters to it in / dev / null, but you <i>must</i> accept these letters. <br><br><h4>  Does the recipient exist at all? </h4><br>  So we got to the last header of the envelope - to the recipient.  Everything is simple: firstly, it would be good to check that the information transmitted to us is generally an e-mail address.  For this is the directive <br><br> <code>reject_non_fqdn_recipient <br></code> <br>  In addition, we would not like to receive mail to addresses for which we do not have mailboxes.  To configure this behavior, you must first create a list of serviced mailboxes, then tell Postfix about it through one of the <b>* _recipient_maps</b> parameters of the configuration file, and then use the configuration file parameter <br><br> <code>smtpd_reject_unlisted_recipient = yes <br></code> <br>  Or prohibit option that has the same effect: <br><br> <code>reject_unlisted_recipient <br></code> <br>  In any case, Postfix will stop accepting emails <i>for</i> accepted <i>domains</i> if there is no mailbox for the recipient.  However, this restriction does not affect the transfer of correspondence to addresses that are not in the accepted domains. <br><br>  And finally, you can even prohibit the open forwarding of letters through your Postfix, leaving only the opportunity to receive letters to known addresses.  For these purposes is the option <br><br> <code>reject_unauth_destination <br></code> <br>  It prohibits sending all unregistered users (yes, you will have to configure SMTP authentication).  <b>Always use this option!</b>  Otherwise, quickly get into all sorts of DNSBL. <br><br><h4>  As a subtotal </h4><br>  So just based on the analysis of the three envelope headers you can filter out a huge amount of spam.  However, spammers are tricky, so this is still not enough. <br><br><h4>  Greylisting </h4><br>  Sometimes mail servers are overloaded and cannot receive a letter.  Do you think that they respond to incoming requests in this case?  Oddly enough, they answer - the server is <i>temporarily</i> unavailable, try again later.  In this case, no normal sender will ever consider that a letter cannot be delivered with all the ensuing consequences.  On the contrary, the sender will attempt to deliver the letter later, putting it in turn to send.  This fact can (and no doubt need!) Be used very effectively: each time you try to connect from an unfamiliar host, our server will send a temporary error message, and skip the email only the second time.  This will eliminate almost all the remaining spam at once, since spam servers almost never make more than one attempt to deliver a letter (otherwise they would simply ‚Äúfall‚Äù from the queue overflow).  This technology is called Greylisting, and it is simply necessary to use it in modern realities. <br><br>  The downside is a small (usually no more than half an hour) delay in the delivery of letters <b>when you first</b> connect from an unknown host.  That is, if a server that is not yet known to our postfix, wants to send a letter, then on the first connection attempt, an error about temporary unavailability is sent to it.  If the server retries the connection, the letter is accepted, and the server is logged in reliable nodes, and then letters from it are received without delay. <br><br>  I also propose to read about setting up greylisting in Postfix on Google, it is easy and it will not turn out to be wrong. <br><br><h4>  Blocklist, or how not to do </h4><br>  Some mail administrators rely on so-called DNSBL (RBL) for spam filtering - blacklists of sites seen in spamming.  So, <b>never</b> add <b>any DNSBL checks</b> to your mail servers.  There are two reasons for this: the first, and most basic, lies in the second part of the first sentence of this section.  Nodes are entered into these lists completely randomly and there are no guarantees that a normal host will not get there (on which, perhaps, at some point the spamming virus has settled, but now the virus has already been cured, or easier and much more real - one external IP for a large network in which the spammer started).  The second reason is more trivial: the filtering mechanism proposed above is much more efficient than any DNSBL and does not rely on unverified data from third parties. <br><br><h4>  On its head, or look at the other side of the barricades </h4><br>  They learned how to filter spam, but now I will try to bring together all the information on what needs to be done so as <i>not</i> to get into spam. <br><br>  For mail server administrators: <br><br><ul><li>  Always make MX records referring to A. </li><li>  The A record for the mail server should always have a mirrored PTR record. </li><li>  The host of the HELO header must have an A or MX record. </li><li>  Always create SPF recordings (yes, this is just not necessary, but just a good tone rule). </li><li>  For all letters sent from the accepted domain, the box for the return address must exist and receive mail. </li></ul><br>  For those who send mail (from programs, from sites, etc.): <br><br><ul><li>  Always send mail with an existing return address. </li><li>  Never send mail from a domain not under your control without checking the SPF rules for it.  For example, gmail.com currently allows you to send letters on its behalf to any server, but yandex.ru and mail.ru report via SPF that sending on their behalf from third-party servers should attract close attention, which is interpreted by smart spam filters as an increase in spam rating for a given letter. </li><li>  Never send mail through incorrectly configured SMTP servers.  Check the server for lice on the list above - it‚Äôs 5 minutes, the <b>dig</b> or <b>nslookup</b> utility will help you. </li></ul><br><br><h4>  Summary </h4><br><br>  Of course, the proposed settings do not filter all spam.  Therefore, it is quite possible that you will need to additionally use a context filter, which will analyze the content of the letters, for example, <a href="http://ru.wikipedia.org/wiki/SpamAssassin">spamassassin</a> , although I do not use anything like that. <br><br>  However, never forget about the settings described in this article when configuring mail, because the above parameters can reduce the server load by orders of magnitude with respect to using only contextual filters, and additionally provide excellent filtering. <br><br>  <b>UPD:</b> First of all, thanks to <a href="http://habrahabr.ru/blogs/linux/101628/">Vanav</a> for critical comments.  Secondly, it was originally implied by me, but apparently still an incomplete summary of the following options: <br><br>  <b><i>You have to decide for yourself what restrictions you are ready to put on your server and which ones are not.</i></b>  <b><i>Many are skeptical of many of the above checks.</i></b>  <b><i>However, they are all used on real SMTP servers on the Internet, so even if you turn on everything at all - you will not be alone.</i></b>  <b><i>Therefore, if you notice a server that is configured incorrectly, do not be lazy to send it to the administrator a letter on this topic, perhaps you will help him avoid anger from users whose correspondence has not reached (if he has not already been expelled from work by the time you write the letter).</i></b>  <b><i>And never forget that broken hosts can be added to the whitelist in order to receive mail from them without checks.</i></b> <br><br><h4>  Current version of the article </h4><br>  <font color="#5E2750"><strong><i>The latest and most current <a href="http://help.ubuntu.ru/wiki/%25D1%2584%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F_%25D1%2581%25D0%25BF%25D0%25B0%25D0%25BC%25D0%25B0_%25D0%25BD%25D0%25B0_%25D1%2583%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BD%25D0%25B5_smtp_%25D0%25BF%25D1%2580%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25BB%25D0%25B0">version of this article</a> is on the official Russian-language Wiki-resource for Ubuntu documentation.</i></strong></font>  <font color="#5E2750"><strong><i>There you can freely improve and supplement the laid out reference and training materials, as well as add your own.</i></strong></font>  <font color="#5E2750"><strong><i>If you have something to tell other Ubuntu users, then a huge request - write or edit the relevant article on <a href="http://help.ubuntu.ru/wiki">help.ubuntu.ru</a> .</i></strong></font>  <font color="#5E2750"><strong><i>Even with small improvements and additions you will help thousands of people, and some of them, in turn, will describe something useful and interesting for you.</i></strong></font> </div><p>Source: <a href="https://habr.com/ru/post/101628/">https://habr.com/ru/post/101628/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../101616/index.html">Dklab_rowlog library for versioning strings in PostgreSQL tables</a></li>
<li><a href="../101620/index.html">IT friend's best friend</a></li>
<li><a href="../101623/index.html">Wrestling Championship on Soviet slot machines - we invite!</a></li>
<li><a href="../101624/index.html">In Korolyov, they made an electric minibus (with nanocapacitors)</a></li>
<li><a href="../101625/index.html">Connect additional IP for hosting on cPanel - now possible!</a></li>
<li><a href="../101629/index.html">Google Chrome 6 has switched to beta status</a></li>
<li><a href="../101630/index.html">Apple iOS 4.0.2</a></li>
<li><a href="../101631/index.html">Expansion of the base for collaborative filtering</a></li>
<li><a href="../101632/index.html">We program under .Net Micro Framework</a></li>
<li><a href="../101633/index.html">We RMAzing in Silicon Valley</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>