<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Receive WebMoney without leaving the site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 I want to tell you about accepting WebMoney without going to the Webmoney merchant site (merchant.webmoney.ru). This method of accepting ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Receive WebMoney without leaving the site</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/9bbb98e5/7f0f44f0/d0241573/55e94dd8.jpg" align="left"><br>  Hi, Habr! <br><br>  I want to tell you about accepting WebMoney without going to the Webmoney merchant site (merchant.webmoney.ru).  This method of accepting payments can be used, and is <a href="http://blog.wmtransfer.com/blog/oplata-topliva-na-azs-za-webmoney-s-mobilnog">used</a> in offline stores, <a href="http://www.youtube.com/watch%3Fv%3DgJTd8QxrpmY%26feature%3Dplayer_embedded">non-browser</a> games. <br><br>  Interesting?  Welcome under cat.  There will be a lot of php code) <br><a name="habracut"></a><br><h5>  How will it look from the client: </h5><br>  For payment, your client will have to enter a mobile phone number \ WMID \ email.  Then he will need to confirm the payment in one of 3 ways: <br><ul><li>  Confirmation by SMS code sent to the client‚Äôs mobile phone </li><li>  Confirmation of USSD-request sent to the client‚Äôs mobile phone </li><li>  Paying a WM-invoice issued to the client.  At the moment, payment of VM accounts is possible in all mobile (and in general any) WebMoney Transfer wallets management applications. </li></ul><br>  After payment you will need to confirm the fact of payment on your site. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For offline stores, the 1st and 2nd confirmation methods are most interesting. <br><br><h5>  Training: </h5><br>  To begin, choose a method of forming a signature, there are 3 of them: <br><ol><li>  Signed with WMSigner </li><li>  MD5 Signature </li><li>  Secret Key Transfer </li></ol><br>  I will consider only the first 2 options, since when using the 3rd method, it is necessary to perform additional checks (checking the authenticity of the connection via https, in order to avoid DNS substitution): <br><br>  1) <a href="http://wiki.webmoney.ru/wiki/show/WMSigner">WMSigner</a> - a module that forms a signature using the WM Keeper Classic key file.  When using it, it is recommended to place the config of the module and the key file above the site directory in order to avoid theft. <br>  The archive with the module contains README.rus, in which everything is perfectly described, you should have no problems. <br><br>  2) <a href="http://ru.wikipedia.org/wiki/MD5">MD5</a> <br>  For the formation of a signature using md5, preliminary preparation is not required, in most programming languages, this hashing technology is present by default (including in php, in which we will program). <br><br>  This method is preferred if you do not use other X interfaces that require only WMSigner to sign. <br><br>  The signature itself will be an md5 hash from gluing <br>  wmid + lmi_payee_purse + lmi_payment_no + lmi_clientnumber + lmi_clientnumber_type + secret_key <br><br>  WMID + seller's wallet + payment_number + telephone_number \ email \ wmid_client + previous_field type + secret key <br><br><h5>  Code </h5><br>  As a programming language for the implementation of the interaction, I chose php.  You can view and download the entire code (in one file) <a href="http://pastie.org/private/yhnmhcysfjz46ls2tswkw">here</a> . <br><br>  Payment form: <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Content-type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/html; charset=utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"purse"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wmr"</span></span></span><span class="hljs-tag">&gt;</span></span>WMR<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wmz"</span></span></span><span class="hljs-tag">&gt;</span></span>WMZ<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag"> /&gt;</span></span>    WMR   :<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"amount"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VALUE</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"12.34"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag"> /&gt;</span></span>   :<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"desc"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" "</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag"> /&gt;</span></span>  :<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"number_type"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span>WMID<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag">&gt;</span></span>Email<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"number"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"79167777777"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag"> /&gt;</span></span>  :<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"confirmation_type"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span>SMS   <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">selected</span></span></span><span class="hljs-tag">&gt;</span></span>USSD   <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag">&gt;</span></span> /   <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" "</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  For a start - 2 common functions. <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wmsign</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($input)</span></span></span><span class="hljs-function"> //    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WMSigner</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $_SETTINGS; <span class="hljs-comment"><span class="hljs-comment">//    WMSigner,    . $f=proc_open("./signer/wmsigner -i ./signer/wmsigner.ini -k ./signer/".$_SETTINGS['wmid'].".kwm", array( 0=&gt;array("pipe", "r"), 1=&gt;array("pipe", "w"), 2=&gt;array("file", "/tmp/error-output.txt", "a")), $pipes); if(is_resource($f)) { $output=""; //        . fwrite($pipes[0], $input); fclose($pipes[0]); //      while(!feof($pipes['1'])) { $output .= fread($pipes[1], '1024'); } //       WMSigner fclose($pipes['1']); proc_close($f); } return $output; } function post($post,$url="https://merchant.webmoney.ru/conf/xml/XMLTransRequest.asp") //  post  { $ch=curl_init(); curl_setopt($ch, CURLOPT_URL, $url); curl_setopt($ch, CURLOPT_FAILONERROR, 1); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt($ch, CURLOPT_TIMEOUT, 3); curl_setopt($ch, CURLOPT_POST, 1); curl_setopt($ch, CURLOPT_POSTFIELDS, $post); $result=curl_exec($ch); curl_close($ch); return $result; }</span></span></code> </pre><br><br>  We check the input parameters, compose an XML request to WebMoney, sign it and send it.  Next, check the status of the request, if everything is without errors - we issue a form to confirm the payment.  If SMS - then we ask also the code received by SMS. <br><br><pre> <code class="php hljs">$_SETTINGS=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'wmid'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'123456789012'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// wmid 'wmr'=&gt;'R123456789012', // R  'wmz'=&gt;'R123456789012', // Z  'amount'=&gt;'123.45', //  'desc'=&gt;' X20', //  'sing_method'=&gt;'sing', //  , md5\sing (by default)\secret_key 'secret_key'=&gt;'t4er43d#4' //  ,     . ); if($_SERVER['REQUEST_METHOD']=="POST") { //     .    -   $error = True; switch($_REQUEST['purse']) //   ,    ,     .   - WMZ { case "wmr": $purse=$_SETTINGS['wmr']; break; default: $purse=$_SETTINGS['wmz']; } if(!(is_numeric($_REQUEST['number_type'])&amp;&amp;$_REQUEST['number_type']&lt;3&amp;&amp;$_REQUEST['number_type']&gt;=0)) //   s { $error=True; $errors['number_type']=" "; } if(!(is_numeric($_REQUEST['confirmation_type'])&amp;&amp;$_REQUEST['confirmation_type']&lt;=4&amp;&amp;$_REQUEST['confirmation_type']&gt;0)) //    { $error=True; $errors['confirmation_type']=" "; } $amount=(is_numeric($_POST['amount']))?$_POST['amount']:$_SETTINGS['amount']; if(!$error) { $pay_no=time(); //   $xml=new DomDocument('1.0', 'utf-8'); $xml-&gt;formatOutput=true; //   $merchant=$xml-&gt;appendChild($xml-&gt;createElement('merchant.request')); $merchant-&gt;appendChild($xml-&gt;createElement('wmid'))-&gt;appendChild($xml-&gt;createTextNode($_SETTINGS['wmid'])); // WMID $merchant-&gt;appendChild($xml-&gt;createElement('lmi_payee_purse'))-&gt;appendChild($xml-&gt;createTextNode($purse)); //   $merchant-&gt;appendChild($xml-&gt;createElement('lmi_payment_no'))-&gt;appendChild($xml-&gt;createTextNode($pay_no)); //       $merchant-&gt;appendChild($xml-&gt;createElement('lmi_payment_amount'))-&gt;appendChild($xml-&gt;createTextNode($amount)); //       ,  - . $merchant-&gt;appendChild($xml-&gt;createElement('lmi_payment_desc'))-&gt;appendChild($xml-&gt;createTextNode($_SETTINGS['desc'])); //  , 255 . $merchant-&gt;appendChild($xml-&gt;createElement('lmi_clientnumber'))-&gt;appendChild($xml-&gt;createTextNode($_REQUEST['number'])); //   (  79167777777,380527777777), WMID, email. $merchant-&gt;appendChild($xml-&gt;createElement('lmi_clientnumber_type'))-&gt;appendChild($xml-&gt;createTextNode($_REQUEST['number_type'])); //  ,   lmi_clientnumber (0-, 1-WMID, 2-email) $merchant-&gt;appendChild($xml-&gt;createElement('lmi_sms_type'))-&gt;appendChild($xml-&gt;createTextNode($_REQUEST['confirmation_type'])); //    (1-, 2-USSD, 3- ,           ..,   - , 4-  WM ) $merchant-&gt;appendChild($xml-&gt;createElement('secret_key'))-&gt;appendChild($xml-&gt;createTextNode('')); //    (1-, 2-USSD, 3- ,           ..,   - , 4-  WM ) //         switch($_SETTINGS['sign_method']) { case "md5": // md5,   ,        md5     $sign = md5($_SETTINGS['wmid'].$purse.$pay_no.$_REQUEST['number'].$_REQUEST['number_type'].$_SETTINGS['secret_key']); $merchant-&gt;appendChild($xml-&gt;createElement('md5'))-&gt;appendChild($xml-&gt;createTextNode($sign)); break; case "sign": //    WMSigner //     ,      . $sign = wmsign($_SETTINGS['wmid'].$purse.$pay_no.$_REQUEST['number'].$_REQUEST['number_type']); $merchant-&gt;appendChild($xml-&gt;createElement('sign'))-&gt;appendChild($xml-&gt;createTextNode($sign)); break; } //     WebMoney,  POST $result=post($xml-&gt;saveXML(),"https://merchant.webmoney.ru/conf/xml/XMLTransRequest.asp"); //   dom, ..    XML  $dom=new domDocument; $dom-&gt;loadXML($result); if(!$dom) die("  XML"); $data=simplexml_import_dom($dom); //    (retval -  , 0    ),      . if($data-&gt;retval!=0) { echo $data-&gt;retval." Error: ".$data-&gt;userdesc."\n\n"; } else { </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;html&gt; &lt;head&gt; &lt;meta http-equiv="Content-type" content="text/html; charset=utf-8" /&gt; &lt;/head&gt; &lt;body&gt; &lt;form method="post" action=""&gt; &lt;input type="hidden" name="confirmation" value="1"&gt; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">= ($data-&gt;realsmstype==1)?' ,   &lt;br /&gt;\n':'' </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">&lt;input type="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">= ($data-&gt;realsmstype==1)?'text':'hidden' </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">" name="code" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">= ($data-&gt;realsmstype==1)?'':0 </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="account" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">=$data-&gt;operation['wminvoiceid']</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="purse" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">= $_REQUEST['purse'] </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="submit" value=" ."&gt; &lt;/form&gt; &lt;/body&gt; &lt;/html&gt; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment"> } }</span></span></code> </pre><br>  The client confirms the payment (if SMS - enters the code that came to him, with the remaining options - just press the button), and we have to notify WebMoney about the payment.  Otherwise, we can not see the money. <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,       . if(!$error) { $xml=new DomDocument('1.0','utf-8'); $xml-&gt;formatOutput = true; //   $merchant = $xml-&gt;appendChild($xml-&gt;createElement('merchant.request')); $merchant-&gt;appendChild($xml-&gt;createElement('wmid'))-&gt;appendChild($xml-&gt;createTextNode($_SETTINGS['wmid'])); // WMID $merchant-&gt;appendChild($xml-&gt;createElement('lmi_payee_purse'))-&gt;appendChild($xml-&gt;createTextNode($purse)); //   $merchant-&gt;appendChild($xml-&gt;createElement('lmi_clientnumber_code'))-&gt;appendChild($xml-&gt;createTextNode($_REQUEST['code'])); //  ,    (WM \USSD = 0, -1  ) $merchant-&gt;appendChild($xml-&gt;createElement('lmi_wminvoiceid'))-&gt;appendChild($xml-&gt;createTextNode($_REQUEST['account'])); //  ,     switch($_SETTINGS['sign_method']) { case "md5": // md5,   ,        md5     $sign=md5($_SETTINGS['wmid'].$purse.$_REQUEST['account'].$_REQUEST['code'].$_SETTINGS['secret_key']); $merchant-&gt;appendChild($xml-&gt;createElement('md5'))-&gt;appendChild($xml-&gt;createTextNode($sign)); break; case "sign": //    WMSigner //     ,      . $sign=wmsign($_SETTINGS['wmid'].$purse.$_REQUEST['account'].$_REQUEST['code']); $merchant-&gt;appendChild($xml-&gt;createElement('sign'))-&gt;appendChild($xml-&gt;createTextNode($sign)); break; } //     WebMoney,  POST $result=post($xml-&gt;saveXML(),"https://merchant.webmoney.ru/conf/xml/XMLTransConfirm.asp"); //   dom, ..    XML  $dom=new domDocument; $dom-&gt;loadXML($result); if(!$dom) die("  XML"); $data=simplexml_import_dom($dom); //    (retval -  , 0    ),      . if($data-&gt;retval!=0) { echo "Error‚Ññ".$data-&gt;retval.": ".$data-&gt;userdesc."\n\n"; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;html&gt; &lt;head&gt; &lt;meta http-equiv="Content-type" content="text/html; charset=utf-8" /&gt; &lt;/head&gt; &lt;body&gt; &lt;form method="post" action=""&gt; &lt;input type="hidden" name="confirmation" value="1"&gt; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">=(!$_POST['code'])?' ,   &lt;br /&gt;':''</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;input type="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">=(!$_POST['code'])?'text':'hidden'</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">" name="code" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">=$_POST['code'];</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="account" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">=$_POST['account']</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="purse" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">= $_REQUEST['purse'] </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="submit" value=" ."&gt; &lt;/form&gt; &lt;/body&gt; &lt;/html&gt; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment"> } else { //     . echo "  "; } }</span></span></code> </pre><br><br><h5>  Test results </h5><br>  <s>Actually, I could not receive a payment using the X20 interface.</s>  <s>Constantly crashed errors.</s>  <s>Or</s> <br><blockquote>  <s>The VM-identifier you specified was found, but there is not enough money on its wallet</s> </blockquote><br>  <s>or</s> <br><blockquote>  <s>Message from WebMoney Transfer: at the moment your seller has stopped accepting payments, please try again later.</s> </blockquote><br><br>  <s>Although there is money in the account, payment acceptance is not suspended.</s>  <s>Now I am waiting for a comment from WM about these errors, and about the commission when using X20.</s> <br><br>  Problems solved.  The reason is in the fixed commission, inability to pay from the wallets registered in the merchant and not quite true logic.  If you choose a payment method - a WM-account, then the payment amount on the wallet + 0.8% commission + fixed commission will be checked.  Although a fixed commission on a WM-account does not apply. <br><br><h5>  Related Links </h5><br>  <a href="https://wiki.webmoney.ru/wiki/show/%25D0%2598%25D0%25BD%25D1%2582%25D0%25B5%25D1%2580%25D1%2584%25D0%25B5%25D0%25B9%25D1%2581%2BX20">X20 Interface Description</a> <br>  <a href="http://wiki.webmoney.ru/wiki/show/WMSigner">Wmsigner</a> <br>  <a href="http://www.youtube.com/watch%3Fv%3DgJTd8QxrpmY%26feature%3Dplayer_embedded">Video showing payment via X20</a> <br>  <a href="http://www.youtube.com/watch%3Fv%3DmAi2YFiDeA8%26feature%3Dplayer_embedded">Video showing payment via X20 in offline stores</a> <br>  <a href="https://merchant.webmoney.ru/conf/paymobile.asp">An example of implementation on the merchant's website</a> <br><br>  <b>UPD</b> When confirming payment via USSD \ SMS an additional fixed fee is charged - 0.9 WMR, 0.04 WMZ, 0.03 WME, 0.25 WMU. </div><p>Source: <a href="https://habr.com/ru/post/121182/">https://habr.com/ru/post/121182/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../121176/index.html">Mozilla promises to make Firefox less voracious.</a></li>
<li><a href="../121178/index.html">ASUS and Intel are sponsors of Sensation</a></li>
<li><a href="../121179/index.html">Work and life in Dubai. My experience</a></li>
<li><a href="../121180/index.html">Modular design of RIA projects</a></li>
<li><a href="../121181/index.html">Integration of E1tele.com service with Microsoft Outlook</a></li>
<li><a href="../121183/index.html">CDC Announces Porting Optimum Technology Platform to Android</a></li>
<li><a href="../121185/index.html">Tornado Web Server 2.0 RC Released</a></li>
<li><a href="../121186/index.html">iPhone. Playing audio in the background</a></li>
<li><a href="../121187/index.html">Began accepting orders for Google Chromebook from $ 380</a></li>
<li><a href="../121188/index.html">Youtube removed its logo from the videos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>