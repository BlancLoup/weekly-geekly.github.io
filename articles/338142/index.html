<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Shopping with full-stack redux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! In this article, I want to use a simple example to tell how to synchronize the status of redux applications between several clients and a serve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Shopping with full-stack redux</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello!  In this article, I want to use a simple example to tell how to synchronize the status of redux applications between several clients and a server, which can be useful when developing realtime applications. </p><br><p><img src="https://habrastorage.org/web/6cb/804/6e9/6cb8046e9d5043a79cec9011a984d12d.png" alt="Redux" title="Redux"></p><a name="habracut"></a><br><h1 id="prilozhenie">  application </h1><br><p>  As an example, we will develop a shopping list, with the ability to change positions from any device in real time, according to the following requirements: </p><br><ul><li>  The ability to simultaneously change and delete positions on multiple devices in real time </li><li>  Ability to save the list in the server's local memory </li><li>  Ability to create multiple lists and access them </li></ul><br><p>  In order to do the minimum effort, we will not do UI to access all the lists, but simply distinguish them by identifier in the URL. </p><br><p>  It can be noted that the application in this form from the point of view of client functionality and UI will differ little from the <a href="http://redux.js.org/docs/basics/">famous todo list</a> .  Therefore, the article will focus more on client-server interaction, saving and processing state on the server. </p><br><p>  I also have plans to write the following article, where, using the example of the same application, we will look at how to save the redux state in DynamoDB and roll out the AWS-packed application in Docker. </p><br><h1 id="pristupaem-k-razrabotke">  Getting to the development </h1><br><p>  To create a development environment, we will use the wonderful tool <a href="https://github.com/facebookincubator/create-react-app">create-react-app</a> .  It‚Äôs quite easy to create prototypes with it: it will prepare everything you need for productive development: webpack with hot-reload, initial set of files, jest tests.  It would be possible to customize it all by yourself for greater control over the assembly process, but in this application it is not critical. </p><br><p>  We create a name for our application and create it by passing as an argument to create-react-app: </p><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-react-app deal-<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>-meal cd deal-<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>-meal</code> </pre> <br><h2 id="struktura-proekta">  Project structure </h2><br><p>  <code>create-react-app</code> created some project structure for us, but in fact for its correct operation it is only necessary that the <code>./src/index.js</code> file <code>./src/index.js</code> the entry point.  Since our project implies the use of both the client and the server, we will change the initial structure to the following: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">src</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">client</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">modules</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">components</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">index</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">create-store</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">socket-client</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">action-emitter</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">constants</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">socket-endpoint-port</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">modules</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">store</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">utils</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">bootstrap</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">connection-handler</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">index</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">registerServiceWorker</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span></code> </pre> <br><p>  Add the package.json command to start the <code>node ./src/server.js</code> server </p><br><h2 id="klient-servernoe-vzaimodeystvie">  Client-server interaction </h2><br><p>  Application state redux stores in the so-called store as a javascript object of any type.  At the same time, any change of state must be carried out by a reducer ‚Äî a pure function, the input of which is the current state and action (also a javascript object).  It returns a new state with changes. </p><br><p>  We can use our client logic for the shopping list, which the reducer implements, both on the browser side and in the node.js environment.  Thus, we will be able to store the state of the list independently of the client and save it in the database. </p><br><p>  To work with the server, we will use the socket.io library, which has already become the standard for working with <a href="https://socket.io/"><code>socket.io</code></a> .  For each list, we will create our own room and send each action to those users who are in the same room.  In addition, for each room on the server we will store our store with the status for this list. </p><br><p>  Synchronization of clients with the server will occur as follows: </p><br><p><img src="https://habrastorage.org/web/7ee/6ef/98a/7ee6ef98a032411caaf5160033b9d01c.png"></p><br><p>  That is, every time an action occurs, then: </p><br><ul><li>  The customer passes it through his store. </li><li>  Through <a href="http://redux.js.org/docs/advanced/Middleware.html">middleware</a> it is transmitted to the server. </li><li>  The server at the page URL understands which room the action came from and passes it through the appropriate store </li><li>  It also broadcasts this action to all clients in the room. </li></ul><br><p>  Mostly in the redux-world, interaction with the server takes place via http, through libraries like <a href="https://github.com/gaearon/redux-thunk">redux-thunk</a> or <a href="https://github.com/redux-saga/redux-saga">redux-saga</a> , which allow you to add some asynchrony and side effects to the synchronous, pure world redux.  Although we do not need this kind of connection with the server, we will also use <code>redux-saga</code> on the client, but only for one task: redirecting to the newly created list in case there is no identifier in the URL. </p><br><h1 id="pishem-kod-klienta">  We write client code </h1><br><p>  I will not focus on the initialization required for redux to work, this is well described in <a href="http://redux.js.org/docs/basics/Store.html">redux official documentation, let me</a> just say that we need to register two middleware: from the mentioned package <code>redux-saga</code> and our <code>emitterMiddleware</code> .  The first is needed for the redirect, as already mentioned, and the last we will write to synchronize actions with the server via <code>socket.io-client</code> . </p><br><h2 id="sinhronizaciya-sostoyaniy-mezhdu-klientami-i-serverom">  State synchronization between clients and server </h2><br><p>  Create a <code>./src/client/action-emitter.js</code> file in which the implementation of the mentioned <code>emitterMiddleware</code> will be: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> syncSocketClientWithStore = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">socket, store</span></span></span><span class="hljs-function">) =&gt;</span></span> { socket.on(<span class="hljs-string"><span class="hljs-string">'action'</span></span>, action =&gt; store.dispatch({ ...action, <span class="hljs-attr"><span class="hljs-attr">emitterExternal</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> })); }; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> createEmitterMiddleware = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">socket</span></span></span><span class="hljs-function"> =&gt;</span></span> store =&gt; <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function"> =&gt;</span></span> action =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!action.emitterExternal) { socket.emit(<span class="hljs-string"><span class="hljs-string">'action'</span></span>, action); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> next(action); };</code> </pre> <br><ul><li>  <code>createEmitterMiddleware</code> is a factory of our middleware and is needed to keep a reference to the socket passed from outside.  There is also another nuance here: actions that come from outside do not need to be sent to the server.  To do this, I suggest marking them (in this case, the <code>emitterExternal</code> field), and in the event of such an action, the middleware should not do anything.  I could use action decorator, but I don‚Äôt see any need for that. </li><li>  <code>syncSocketClientWithStore</code> quite simple: it listens to the socket on the <code>action</code> message and simply passes the action to the store, marking it with the flag already mentioned. </li></ul><br><h2 id="poluchenie-nachalnogo-sostoyaniya-spiska">  Getting the initial state of the list </h2><br><p>  As I have already mentioned, we will use <code>redux-saga</code> on the client so that when you first <code>redux-saga</code> client's <code>redux-saga</code> to the corresponding list that could have been created just now.  In a <code>./src/client/modules/products-list/saga/index.js</code> manner, in <code>./src/client/modules/products-list/saga/index.js</code> we <code>./src/client/modules/products-list/saga/index.js</code> describe a saga that responds to the list of products and the room in which the client is located: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { call, takeLatest } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-saga/effects'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> actionTypes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../action-types'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSuccessGenerator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">action</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> call(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.history.replaceState.bind(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.history), {}, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${action.roomId}</span></span></span><span class="hljs-string">`</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> takeLatest(actionTypes.FETCH_PRODUCTS_SUCCESS, onSuccessGenerator); }</code> </pre> <br><h1 id="server">  Server </h1><br><p>  The entry point for the server will be added to the scripts in package.json <code>./src/server.js</code> : </p><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'babel-register'</span></span>)({ presets: [<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'react'</span></span>], plugins: [<span class="hljs-string"><span class="hljs-string">'transform-object-rest-spread'</span></span>, <span class="hljs-string"><span class="hljs-string">'transform-regenerator'</span></span>] }); <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'babel-polyfill'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> port = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./constants/socket-endpoint-port'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> clientReducer = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./client'</span></span>).rootReducer; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./server/bootstrap'</span></span>).start({ clientReducer, port });</code> </pre><br><p>  It is worth noting that when starting our server, a client reducer is passed to it: this is necessary so that the server can also maintain the current status of the lists, receiving only actions, and not the entire state.  <code>./src/server/bootstrap.js</code> look at <code>./src/server/bootstrap.js</code> : </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> createSocketServer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'socket.io'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> connectionHandler <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./connection-handler'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> createStore <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./store'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> start = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ clientReducer, port }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> socketServer = createSocketServer(port); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = createStore({ <span class="hljs-attr"><span class="hljs-attr">socketNamespace</span></span>: socketServer.of(<span class="hljs-string"><span class="hljs-string">'/'</span></span>), clientReducer }); socketServer.on(<span class="hljs-string"><span class="hljs-string">'connection'</span></span>, connectionHandler(store)); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'listening on:'</span></span>, port); }</code> </pre> <br><h2 id="servernaya-logika">  Server logic </h2><br><p>  Let us proceed to the logic specific to our server and describe the actions that it should support: </p><br><ul><li>  Add user to room </li><li>  Creating a room and its corresponding store when adding a user in case there is no such room yet </li><li>  Remove user from room </li><li>  Remove the store room if there are no users left </li><li>  Changing the state of the room for the action came </li><li>  Relay action to all users in the room </li></ul><br><p>  I also propose to describe all these actions with the help of redux and for this purpose make the module <code>./src/server/modules/room-service</code> , containing the corresponding saga and reducer.  In the same place we will make the elementary storage for our room stores <code>./src/server/modules/room-service/data/in-memory.js</code> : </p><br><pre> <code class="hljs kotlin">export <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InMemoryStorage</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.innerStorage = {}; } getRoom(roomId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.innerStorage[roomId]; } saveRoom(roomId, state) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.innerStorage[roomId] = state; } deleteRoom(roomId) { delete <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.innerStorage[roomId]; } }</code> </pre> <br><h2 id="sinhronizaciya-sostoyaniy-servera-i-klientov">  Synchronization of server and client states </h2><br><p>  At a socket server event, we will simply make dispatch with the appropriate action from the <code>room-service</code> module on the server store.  We describe this in <code>./src/server/connection-handler.js</code> : </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { actions <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> roomActions } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./modules/room-service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> templateParseUrl <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./utils/template-parse-url'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getRoomId = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">socket</span></span></span><span class="hljs-function"> =&gt;</span></span> templateParseUrl(<span class="hljs-string"><span class="hljs-string">'/list/{roomId}'</span></span>, socket.handshake.headers.referer).roomId.toString() || socket.id.toString().slice(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> store =&gt; <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">socket</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> roomId = getRoomId(socket); store.dispatch(roomActions.userJoin({ roomId, <span class="hljs-attr"><span class="hljs-attr">socketId</span></span>: socket.id })); socket.on(<span class="hljs-string"><span class="hljs-string">'action'</span></span>, action =&gt; store.dispatch(roomActions.dispatchClientAction({ roomId, <span class="hljs-attr"><span class="hljs-attr">clientAction</span></span>: action, <span class="hljs-attr"><span class="hljs-attr">socketId</span></span>: socket.id }))); socket.on(<span class="hljs-string"><span class="hljs-string">'disconnect'</span></span>, () =&gt; store.dispatch(roomActions.userLeft({ roomId }))); };</code> </pre> <br><p>  Let us leave the processing of <code>userJoin</code> and <code>userLeft</code> to the conscience of an inquisitive reader, who was not too lazy to look into the repository, but to look at how <code>dispatchClientAction</code> handled.  As we remember, it is necessary to do two actions: </p><br><ul><li>  Change the state in the appropriate store </li><li>  Send this action to all customers in the room. </li></ul><br><p>  Responsible for the first generator <code>./src/server/modules/room-service/saga/dispatch-to-room.js</code> : </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>, put } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-saga/effects'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> actions <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../actions'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../data'</span></span>; const getRoom = <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.getRoom.bind(<span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); export <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>* ({ socketServer, clientReducer }, action) { const storage = yield <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(getRoom, action.roomId); yield <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.store.dispatch.bind(<span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.store), action.clientAction); yield put(actions.emitClientAction({ roomId: action.roomId, clientAction: action.clientAction, socketId: action.socketId })); };</code> </pre> <br><p>  He also puts the following action module <code>room-service</code> - <code>emitClientAction</code> , which responds <code>./src/server/modules/room-service/saga/emit-action.js</code> : </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { call, select } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-saga/effects'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ socketNamespace }, action</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> socket = socketNamespace.connected[action.socketId]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> roomEmitter = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> call(socket.to.bind(socket), action.roomId); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> call(roomEmitter.emit.bind(roomEmitter), <span class="hljs-string"><span class="hljs-string">'action'</span></span>, action.clientAction); };</code> </pre> <br><p>  This is the simple way that action games fall on the rest of the clients in the room.  In my opinion, the simplicity of full-stack redux lies in the simplicity, as well as the power of re-using client logic to reproduce state on the server and other clients. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  At least a little messy, but my story comes to an end.  I did not focus on things that already have a lot of articles and lessons (in any case, the full code of the application can be viewed in the <a href="https://github.com/gleb-smagliy/deal-on-meal">repository</a> ), but stopped on what information, in my opinion, less.  So if you have any questions - please in the comments. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/338142/">https://habr.com/ru/post/338142/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338130/index.html">It's a (focus) Trap</a></li>
<li><a href="../338132/index.html">Introduction to kube-spawn - a utility for creating local Kubernetes-clusters</a></li>
<li><a href="../338134/index.html">How to assemble Ceylon in a container if your container ship is blocked</a></li>
<li><a href="../338136/index.html">OO VS FP</a></li>
<li><a href="../338140/index.html">PHP is alive. PHP 7 in practice</a></li>
<li><a href="../338144/index.html">Rapid development of monitoring scripts with Bash, Outthentic and Sparrow</a></li>
<li><a href="../338146/index.html">Russia's first OpenHack from Microsoft (that is, from us)</a></li>
<li><a href="../338148/index.html">MultiSim + M2M OTA platform</a></li>
<li><a href="../338150/index.html">How JS works: memory management, four types of memory leaks and how to deal with them</a></li>
<li><a href="../338154/index.html">How to launch a patent process in an IT company</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>