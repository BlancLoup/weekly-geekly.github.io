<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we have AB-testing. Yandex lecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="AB testing on Yandex services is ongoing. ‚ÄúRoll out on such a share of the audience‚Äù and look at the reaction of people is so standard practice that n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we have AB-testing. Yandex lecture</h1><div class="post__text post__text-html js-mediator-article">  AB testing on Yandex services is ongoing.  ‚ÄúRoll out on such a share of the audience‚Äù and look at the reaction of people is so standard practice that no one in the team has a question why it is needed.  And so that there are no problems with the testing itself, we have a special infrastructure for experiments.  Details tell the developers Sergey Myts and Danil Valgushev. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/dDm2JIMBac8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Sergei: <br>  - I will try to simplify the description of the task of AB-testing.  There is an abstract system with users, we make some changes to it, and we need to be able to measure the benefits in it.  So far, everything is simple, but too abstract.  Example.  There is a web service comparing a couple of photos of cats.  The user must select the most liked photo.  At the same time, he can choose not only the left or right picture, but also ‚Äúagainst all‚Äù.  So we picked up the pictures are not very good.  Our task is to reasonably improve the service, proving it in numbers. <br><a name="habracut"></a><br>  How do we experiment?  First you need to understand what is good.  We want to improve the system.  It is necessary to choose what to strive for, and not necessarily in numbers, but in what we call the direction to the ideal.  You may want the user to say as little as possible that we did not find anything good at all.  To have as few failures as possible.  It is also probably good when we can correctly predict the user's choice.  Then let's try to make the left picture like him more often.  You can also want the user to want to use our service more and more.  Suddenly, we then want to hang up an advertisement, and the more he uses the service, the more he sees the advertisement.  And he is good, because he likes the service, and we, because we like advertising.  Joke. <br><br>  This concept needs to be displayed in numbers in order to somehow measure it.  You can enter indicators of goodness - metrics.  As metrics, the number of refusals to compare, the number of correctly guessed left results, some weighted average user per service for the number of his actions, time for individual pictures, etc. Some things that we think reflect our ideal. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now we need data to calculate everything.  Highlight user actions.  Perhaps pressing the buttons, switching the mouse.  At the same time, we want to record the fact of what pictures were displayed and how long it was spent on a particular page.  Let's put together everything that can help us in calculating the metrics. <br><br>  Learn how to remember them on the client side.  If this is a web service, most likely it is JavaScript that notes some actions and saves them locally on itself.  Then we learn to communicate them to the server and save them on each typewriter.  And we will learn how to aggregate them and put them in storage so that they can be processed later. <br><br>  We know what we want and on what data to look for it.  Let's now learn to count.  We need the implementation of the calculation of metrics - just some kind of process that, according to our experiments, will say that on average, the user has such metrics indicators.  Results should be stored with convenient access.  Not just counting once, but for example, managers will appear in analytics so that they themselves can easily access this repository and see the results. <br><img src="https://habrastorage.org/webt/xw/8u/ky/xw8ukyvmda9ytk5bagmpevozxt8.jpeg"><br>  I wish that the search for results was not very long.  Therefore, in the repository, you need to provide a quick search and display of results - so that you can move faster.  We introduce several terms to understand the internal terminology.  Experimental sampling is a combination of two things: a set of flags or parameters with experimental functionality, as well as a whole subset of people who are included in these changes. <br><img src="https://habrastorage.org/webt/de/hy/gq/dehygqoid5fkorcgexv9necnb44.jpeg"><br>  An experiment is a collection of several samples.  As a rule, one of them is a control one, and users see our service there without experiments.  All others include experimental actions.  The data slice is an auxiliary analytical tool.  More often than not, we want to see our metrics, perhaps to some limited group of users.  Sometimes we wonder how users behave in a particular country.  Sometimes it is interesting how we change the output for commercial requests, because money comes from them.  It is interesting to look not at the entire data stream, but at individual sections. <br><img src="https://habrastorage.org/webt/br/lc/r8/brlcr86buinws728q99lq9aluna.jpeg"><br>  We must learn to create and conduct an experiment.  In the description of the experimental sample, it is necessary to somehow determine the description of the parameter that will include this experiment.  Let's say the experiment will compare two image matching algorithms.  The first one prefers cats on baleeness, the second one - on fluffiness.  Then in the first experimental sample there may be a flag is Susat = true, in the second is Fuzzy = true. <br><br>  Another experimental sample will include what percentage of users and, possibly, with what restrictions ‚Äî for example, in which country ‚Äî we want to run our experiment.  This all concerns the description and modification of the experimental sample.  And it would be good for us to be able to stop the experiments and run them.  Watch for health.  When there is a big system, it's good to understand when everything breaks down or when as a result of changes something goes wrong, as we planned. <br><br>  If we want to conduct not one, but many experiments - it is very useful to look at what is happening in each of them.  For example, it may happen that the bite classifier will work a little more and squander the response time.  And sometimes it may not be very desirable situation. <br><img src="https://habrastorage.org/webt/62/ww/tk/62wwtkdaqmznswlk5e2x3w75724.jpeg"><br>  It is necessary to learn how to draw conclusions, display the metrics of the experiment and the presence of significant changes.  There should be some kind of interface that says that these metrics have significant changes according to statistical criteria - look and draw some conclusions.  If it is stated that everything is good for all metrics, then it means we need to roll it.  If it is bad and we do not understand why, then we need to understand.  If there is no understanding, the next time you can mess up more. <br><br>  It is also sometimes useful to consider the features on individual important slices - for example, to make sure that the response time on mobile does not squander.  And it is convenient when there is a tool for finding possible problems and anomalies.  Not by yourself looking at all the cuts, but by some tool can suggest that there is most likely something so bad on this cut that it prevented everyone from doing so.  It seems everything is relatively simple. <br><br>  Danil: <br>  - Not really.  My name is Danil Valgushev.  It's complicated.  This is due to the fact that Yandex is a big company, and there are many interesting nuances that I want to talk about with a specific example. <br><img src="https://habrastorage.org/webt/nl/zi/dn/nlzidnfs08zkc_veiqfmlez3wsw.jpeg"><br>  We have not only the main search.  There is a search for pictures and video, mail, maps and many other services. <br><br>  We also have many users, many experimenters and experiments.  Even within each service there are many different areas that we want to improve.  In the search, we can improve the ranking algorithms, the interface, or create new functional features. <br><img src="https://habrastorage.org/webt/vv/xo/8n/vvxo8nz6atkrrubdobo5-igkbym.jpeg"><br>  How do our users interact with the experiment infrastructure?  Simplified scheme looks like this.  There are users, there is Yandex, where the infrastructure of experiments is embedded.  Users specify requests and receive output, which is somehow changed by the experiment.  There are also developers, managers and analysts in Yandex who create applications for experiments.  We then carry them out and give tools for analyzing the results. <br><img src="https://habrastorage.org/webt/vd/nv/-z/vdnv-z9afwph4ye90nqoeirrqki.jpeg"><br>  A typical experiment consists of three steps.  The manager or analyst first conducts an experiment on real users and, upon completion, analyzes the results and makes decisions. <br><img src="https://habrastorage.org/webt/oo/ll/sd/oollsdpwhdfdqau4wpoxo0trxks.jpeg"><br>  For example, we decided to conduct an experiment and improve the layout of search results.  We must create an application and fill in all the fields.  We write that rollout criteria is an improvement on the main interface metrics.  Type of application - interfaces.  Next, create two samples.  One is empty, Ah, clean production.  And sample B, where there is some flag, for example, goodInterface = true.  This flag is then swept through our infrastructure to the destination, to the code that generates the interface, and the code is triggered by this flag.  Also in the application we are talking about target sections that we want to cheat in the metrics, and note on which regions, browsers, platforms and on what percentage we want to start the experiment. <br><img src="https://habrastorage.org/webt/vr/f4/hj/vrf4hj5-yhyixaqdc0_df9axa3c.jpeg"><br>  Suppose we fill out an application.  It turns out that we cannot just roll it out into production.  We must first test it.  Testing has two goals.  There are manual tests and automatic.  Manual - this is when the creator of the experiment himself clicks on everything that he is interested in, the entire necessary interface, so that everything works correctly.  Automatic tests are aimed at avoiding fakapov when the experiment rolls into production. <br><br>  There are two examples: checking for the fall of certain modules of services or collecting assessor estimates from an experiment - in order to prevent very bad experiments from being produced, to test them before rolling out.  There is a problem that, perhaps, we are conducting an experiment for the first time and are not completely sure that we will not break anything.  Then our experts come to the rescue. <br><img src="https://habrastorage.org/webt/9p/bt/wn/9pbtwnljrhrl7es79ze6mlanl7e.jpeg"><br>  For each service and for each aspect of the quality of service, we have experts who, on each application, come and moderate it.  They check the clarity of the description and the correctness of the flags, give advice, see if additional tests are needed, and, in principle, accompany the experiments, helping people who are not well versed in them. <br><br>  When the application is approved, we must get into production.  Here, too, a problem arises: users are limited, and there are many applications.  A queue forms. <br><img src="https://habrastorage.org/webt/i8/p5/yu/i8p5yu0wpkxgqyj3j0udktsdl_w.jpeg"><br>  One of the solutions is a multidimensional scheme.  A one-dimensional scheme is when each user falls into exactly one experiment.  And multidimensional - when each user enters more than one experiment.  Naturally, overlapping experiments should not conflict with each other.  Usually they relate either to different services or to different aspects of the quality of one service. <br><img src="https://habrastorage.org/webt/sq/jr/vu/sqjrvugtco9pq-jh726pnrgm1l8.jpeg"><br>  Let's say we hit production.  How do users break into experiments?  We have some configuration that actually describes the rules.  And we came to the conclusion that it is convenient to describe this configuration in the form of a decision graph.  There are experiments in the leaves of the graph, and in the nodes there are solutions on the request parameters, which include, for example, the user ID, the request text, the page address, the region, the user agent, the time. <br><img src="https://habrastorage.org/webt/w8/dj/ba/w8djbavpuctdvcq8qacp1d-dyfm.jpeg"><br>  The application enters the configuration at the moment when the configuration is being prepared for rolling out.  The configuration is collected by deleting old orders and adding new ones.  Roll out is usually done several times a day. <br><img src="https://habrastorage.org/webt/uf/nv/7v/ufnv7vcgbmjspxjqr7dx-hmp_za.jpeg"><br>  Here too, a problem arises.  We seem to have tested all the experiments, but no one guarantees that if we roll a new configuration, nothing will break.  Therefore, we always monitor the key indicators of the search when rolling out the configuration - so that if anything happens, it can be successfully rolled back.  This usually does not happen, but we still insure. <br><br>  There are smaller breakdowns when one experiment breaks down.  It is more difficult here, it is not immediately apparent, it is necessary to build graphs for each experiment, for key metrics, such as the number of clicks, the number of requests.  And there is a system for automatically detecting anomalies, which notices when a schedule starts to behave badly.  There is also an emergency shutdown system, if something is wrong. <br><br>  How does the split work?  How to break users so that they are mixed up, but at the same time each user got into the same experiment? <br><img src="https://habrastorage.org/webt/0n/ib/xm/0nibxmfuiceuu4a4llhbchm7zea.jpeg"><br>  A simple solution is to take the hash from its identifier, and take it modulo N. We get N possible gatherings and call them slots.  This partition we usually call measurement. <br><br>  Then on the slots you can hang experiments and algorithms.  But there was a problem.  Suppose we had an experiment in which the users in one sample were good, and in the other - a little worse.  After turning off the experiment, users are accustomed to and began to behave differently.  And when we turn on our own, we have an offset, A and B are in unequal conditions. <br><img src="https://habrastorage.org/webt/yj/mo/ms/yjmomsdqwzxdryix3ptnhvtktgy.jpeg"><br>  Due to the fact that our algorithm is a graph, we can make such a feint with our ears: take and mix the users again before they again get into sample A and B. Thus, we will provide them with the same conditions. <br><img src="https://habrastorage.org/webt/dm/t3/qx/dmt3qxwgxyqwfnzv0fdycef_x8s.jpeg"><br>  The multidimensional scheme also looks pretty simple.  There is a special node that parallelizes the bypass of the graph.  Crawling occurs independently on each branch, and then the result is added. <br><img src="https://habrastorage.org/webt/7a/9v/cv/7a9vcv46ejekgf34bt4clvzrrdo.jpeg"><br>  When measurements are made in different branches, they usually have Salt1 and Salt2 - salt, so that they beat independently and do not correlate with each other. <br><img src="https://habrastorage.org/webt/kv/ij/vc/kvijvce_o9qx5pigpbso2v91bkm.jpeg"><br>  The last problem is how to build configurations.  It is important to remember that each experiment still has a set of restrictions: percentages, regions, browsers, platforms, etc. Here is an example - four experiments that go to different regions.  How to place them, for example, on 10 slots? <br><img src="https://habrastorage.org/webt/pm/o5/lp/pmo5lp243dpep_evxaragibemqq.jpeg"><br>  If we place it like this, then we see that each experiment has a little bit eaten from each slot and the last experiment did not work, because it intersects with all three. <br><img src="https://habrastorage.org/webt/mr/tf/29/mrtf29hfruwy3bw4j8n5dztn2_s.jpeg"><br>  Simple heuristics work here quite well.  When we put a new tool in the configuration, we usually try to choose slots where there are already some experiments.  And when the fat experiment comes to broad restrictions, we need to have room for it. <br><img src="https://habrastorage.org/webt/ih/ik/qc/ihikqcm9h-vj4zo82atxbfsuhmq.jpeg"><br>  Here we conducted an experiment, it worked, we look at metrics.  Be sure to look at the usual metrics: the number of user requests, clicks - to understand how much data is collected.  Another standard metric is the percentage of unclipped pages, CTR.  We have many different metrics, and the acceptance is not based on clicks and queries, but on synthetic metrics.  This is a separate topic, not for our report. <br><img src="https://habrastorage.org/webt/3v/wz/f9/3vwzf9c4tqv7jnd2jkikckuo5gu.jpeg"><br>  There are such statistical tests.  When we conducted the experiment, we make a decision.  First of all, we check the criteria for rolling out according to metrics, our product considerations and be sure to consult with experts. <br><img src="https://habrastorage.org/webt/qc/er/st/qcerstb6anvopk1h_svmlrokjue.jpeg"><br>  After completion, the experiment goes to dataset.  We collect the whole story.  It, first of all, allows us to carry out various studies on the methods of the experiment, and is also needed to validate new metrics. <br><img src="https://habrastorage.org/webt/zh/bt/r4/zhbtr4ermai474lvyonsulvrons.jpeg"><br><img src="https://habrastorage.org/webt/pn/a3/wa/pna3walk6jt3ajslr3ijctpbv7m.jpeg"><br>  Sergei: <br>  - This is a kind of generalized overview of the infrastructure tools.  We talked about the first two topics: what can be done with the interaction interface and how the partitioning occurs.  And what problems arise with logging in the real world? <br><br>  Since there are many services and many data sources, we have a data zoo.  They are of different sizes, delivered at different speeds.  Some are ready immediately, some in a day, some in a week.  The big problem is that responsibility is distributed over these source data.  Each team writes its own logs, then we want to collect them.  Therefore, you need to work with each separately. <br><img src="https://habrastorage.org/webt/1f/ge/ed/1fgeed_x99w6q_6yclbvco31xdk.jpeg"><br>  Because of the zoo data, there are issues of delivery and aggregation.  So, you need to start a complex infrastructure and streamlined processes that will collect logs from all teams.  At the same time it would be good to have compatible data formats in order to be able to process data for the entire company, and not to go to each team with its parser.  Here the general library of work with logs is useful. <br><br>  In the end, the data should be aggregated and stored in one place where it is convenient to process them further.  We have separate special teams responsible for separate logging processes at low and high levels, who write libraries and are responsible for the time of data delivery.  Therefore, the experiment team has simplified the task, we have already arrived at the ready.  We have a common library of working with logs - with the help of it, any analyst can parse all the main company logs if he has the appropriate access.  All data is stored in the storage at MapReduce, in the system, and processed in the calculations of MapReduce.  We have our <a href="https://habrahabr.ru/company/yandex/blog/311104/">own YT system</a> , you can search, there were reports about it. <br><br>  Data delivered, you need to count.  Data processing is distributed, the calculation goes to hundreds of terabytes and to petabytes.  From the point of view of the interface, we want to get the numbers we need for any day for any experiment and data slice.  So, you need to somehow prepare the data.  We cope with the fact that we build extracts, where the data are stacked in a special way, so that they can be quickly found in the file system, just a binary search and some other special preprocessed indices. <br><br>  As a result, individual tools can in seconds or minutes, if we have a very complex experiment and a lot of data, unload figures for any experiment that was conducted in the company. <br><img src="https://habrastorage.org/webt/bm/4c/dn/bm4cdntemkjd8rthrf6dakukuis.jpeg"><br>  Many experiments - many potential problems.  Services are very different, are developed separately, their own functionality, each experimenting with them, and we collect them in a common point where everyone can break something in their own way.  Therefore, monitoring is very necessary and important.  The first sentence is that the aggregation of the collected logs takes time, so it would be good to have a monitor for disrupting counters.  We need to at least count how many requests, clicks, or some simple actions.  This data is prepared very quickly, and it can be seen from them that something has gone completely wrong. <br><br>  On the other hand, problems can be complex and something can go wrong not just in separate numbers, but on a specific metric.  For example, users may begin to spend less time in the interface or, conversely, solve some user problem longer.  On the one hand, this means that it is necessary to aggregate the logs and, using fast data, metrics calculations are needed faster.   ,     ,  -  .        ,       .           . <br><br>        ,   ,    :   ,    .         .        ,           ,    .    .      ,             ,    .       ,       -,  -  .           . <br><br>  :       -        .            . ,        ,   ,    ,     ,  - -  . ,  ,  ,   . <br><br>     ‚Äî  ,   ,       .     ,     ,   . ,    ,     . <br><img src="https://habrastorage.org/webt/3m/cz/7i/3mcz7i8vq1prpzg_ojrqmpwbiae.jpeg"><br>       ,     .   ,    ,     .       ,     .    ,      ,         . <br><br>    ,    ,        .    ,   n       ,     ,           .     .    ,       . <br><br>   ‚Äî     .         . -  ,         ,  ,        ,     .   ,       . <br><br>  ,       .  Thank. </div><p>Source: <a href="https://habr.com/ru/post/342704/">https://habr.com/ru/post/342704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342688/index.html">Career or science: why at ITMO University you do not need to choose one thing</a></li>
<li><a href="../342690/index.html">How to limitlessly * surf ** on a smartphone for 20 *** rubles a month</a></li>
<li><a href="../342692/index.html">IaaS Digest: Guides, Trends, and Cases</a></li>
<li><a href="../342696/index.html">[Google programmer‚Äôs answer] Is there life after 35-40 years? (for software developer)</a></li>
<li><a href="../342702/index.html">The digest of interesting materials for the mobile developer # 230 (November 13 - November 19)</a></li>
<li><a href="../342706/index.html">Banner Advertising Expands Borders</a></li>
<li><a href="../342708/index.html">3D graphics from scratch. Part 2: rasterization</a></li>
<li><a href="../342714/index.html">Testing ssd P4800X</a></li>
<li><a href="../342716/index.html">How has the platform for ReadyScript online store changed over the past 3 years</a></li>
<li><a href="../342718/index.html">How to improve the performance of storage systems in the data center</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>