<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We solve the housing problem using the Yandex.Maps API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the life of even the most "terry" IT-Schnick sometimes comes the moment when you need not only to get out of your lair on the street, but to transf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We solve the housing problem using the Yandex.Maps API</h1><div class="post__text post__text-html js-mediator-article"> In the life of even the most "terry" IT-Schnick sometimes comes the moment when you need not only to get out of your lair on the street, but to transfer yourself to a new place of residence.  An ordinary person in such cases is armed with the Internet and combing real estate sites in search of suitable options, which are marked on the map, written out or printed, and then systematically called.  If the end of the cycle comes, and the task has not yet been completed - <code>goto line 1</code> ... And at some stage it bothers the person and he goes to the agency. <br><br>  So in my life it was time to move, but after spending a few days after such a routine activity, I remembered that not <s>knowingly wearing a beard</s> is such a wonderful service as <a href="http://maps.yandex.ru/">Yandex.Maps</a> , and they have a no less wonderful <a href="http://api.yandex.ru/maps/">API</a> .  After sitting one morning and combining everything with a simple grabber for PHP and XPath, I received such a colorful map, where you can mark objects (apartments) with different markers according to any of the criteria, or just one look at which of them are closer to the desired location. in my case it was the subway): <br><br><img src="https://habrastorage.org/storage2/43c/e70/cc4/43ce70cc42a22ec4b070d66131da6be7.png" alt="Screenshot">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  I must say that for me this is the first experience of finding an apartment and therefore I may not know about the service doing something like this - however, after several days of searching I did not find anything like this on the secondary real estate market.  And I would find - there would be no reason to write this post, so we will continue as soon as possible, until one of the habrayers inserts his weighty "nya" ... <br><br><h4>  Grabber </h4><br>  We‚Äôll take information from the Real Estate Bulletin website: they have a convenient search with a bunch of filters, but no map, which is very problematic for people like me who don‚Äôt know every street as a souvenir. <br><br>  The site has the ability to view all search results (no more than 300) on one page in print mode - this is what we will use.  URL has the following form: <br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//www.bn.ru/zap_fl.phtml?print=printall&amp;_</span></span></code> </pre><br><br>  Suppose we got a page with the desired results on the filter.  How to get out of her list of apartments?  I usually solve this problem with regulars, but this site has some special <s>non</s> -HTML structure, so it turned out to be easier to use XPath ( <a href="http://www.w3schools.com/xpath/default.asp">W3Schools</a> ).  With its help, it is easy to get a list of rows in a table ( <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> <pre> <code class="hljs smalltalk"><code>),    -   ,   ,    <span class="hljs-type"><span class="hljs-type">DOMNode</span></span></code> . <br> <br>     : <br> <code class="php">//  . <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array(); <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL = <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'</span></span>; // ,       . <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty = iconv(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'   0'</span></span>); //        . foreach ((array) <span class="hljs-string"><span class="hljs-string">$_</span></span>REQUEST[<span class="hljs-string"><span class="hljs-string">'region'</span></span>] as <span class="hljs-string"><span class="hljs-string">$r</span></span>egion) { <span class="hljs-string"><span class="hljs-string">$u</span></span>rl = <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL.<span class="hljs-comment"><span class="hljs-comment">"region$region=$region&amp;"</span></span>; //  ... //   ,      <span class="hljs-number"><span class="hljs-number">300</span></span> -    //      ,     <span class="hljs-number"><span class="hljs-number">300.</span></span> foreach (range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>) as <span class="hljs-string"><span class="hljs-string">$p</span></span>rice0) { <span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL = <span class="hljs-string"><span class="hljs-string">$u</span></span>rl.<span class="hljs-comment"><span class="hljs-comment">"price1=$price0&amp;price2="</span></span>.(<span class="hljs-string"><span class="hljs-string">$p</span></span>rice0 + <span class="hljs-number"><span class="hljs-number">999</span></span>); //   - .   . <span class="hljs-string"><span class="hljs-string">$d</span></span>ata = dl(<span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL); if (!strpos(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata, <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty)) { //  . <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers = parse(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata); <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array_merge(<span class="hljs-string"><span class="hljs-string">$a</span></span>ll, <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers); } //    . usleep(<span class="hljs-number"><span class="hljs-number">200000</span></span>); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   <span class="hljs-type"><span class="hljs-type">HTML</span></span>   . <br> <code class="php">function parse(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) { //  <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>,      <span class="hljs-type"><span class="hljs-type">UTF</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> ( , //    ). <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">'&lt;?xml encoding="UTF-8"&gt;'</span></span>.iconv(<span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml); <span class="hljs-string"><span class="hljs-string">$d</span></span>oc = new <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>(<span class="hljs-string"><span class="hljs-string">'1.0'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>); @<span class="hljs-string"><span class="hljs-string">$d</span></span>oc-&gt;loadHTML(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) or die(<span class="hljs-string"><span class="hljs-string">'loadHTML: '</span></span>.<span class="hljs-string"><span class="hljs-string">$h</span></span>tml); //      . <span class="hljs-string"><span class="hljs-string">$x</span></span>path = new <span class="hljs-type"><span class="hljs-type">DOMXPath</span></span>(<span class="hljs-string"><span class="hljs-string">$d</span></span>oc); //    ,       -  //  ()    ,   . <span class="hljs-string"><span class="hljs-string">$n</span></span>odes = <span class="hljs-string"><span class="hljs-string">$x</span></span>path-&gt;query(<span class="hljs-string"><span class="hljs-string">'//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'</span></span>); //    . <span class="hljs-string"><span class="hljs-string">$r</span></span>esults = array(); //        (,    ) -  //  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; // <span class="hljs-string"><span class="hljs-string">$n</span></span>odes -  - (tr). foreach (<span class="hljs-string"><span class="hljs-string">$n</span></span>odes as <span class="hljs-string"><span class="hljs-string">$r</span></span>ow) { //     - ,   .. <span class="hljs-string"><span class="hljs-string">$c</span></span>ells = array(); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;firstChild; while (<span class="hljs-string"><span class="hljs-string">$c</span></span>ell) { <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeType == <span class="hljs-type"><span class="hljs-type">XML_ELEMENT_NODE</span></span> and <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[] = trim(<span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeValue); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nextSibling; } if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { //      -       // .  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = (int) reset(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } else { <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount; //    colspan     -   //   . if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">10</span></span>) { array_splice(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, array(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">6</span></span>], <span class="hljs-string"><span class="hljs-string">''</span></span>)); } //   ,       . <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;ownerDocument-&gt;saveXML(<span class="hljs-string"><span class="hljs-string">$r</span></span>ow); if (preg_match(<span class="hljs-string"><span class="hljs-string">'~&lt;a href="([^"]+)~u'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml, <span class="hljs-string"><span class="hljs-string">$m</span></span>atch)) { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru'</span></span>.<span class="hljs-string"><span class="hljs-string">$m</span></span>atch[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } else { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">''</span></span>); } // ,     . <span class="hljs-string"><span class="hljs-string">$k</span></span>eys = array(<span class="hljs-string"><span class="hljs-string">'url'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span>); <span class="hljs-string"><span class="hljs-string">$r</span></span>esult[] = array_combine(<span class="hljs-string"><span class="hljs-string">$k</span></span>eys, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } } return <span class="hljs-string"><span class="hljs-string">$r</span></span>esult; }</code> <br> <br>  <br> ,    -  <code><span class="hljs-string"><span class="hljs-string">$a</span></span>ll</code>        .    -    .      : <br> <code class="php">array( <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/detail/flats/xxxxxx.html?from=search'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'7  ., xxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1\\5'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'30'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'18.3'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'6'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3100'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'xxxxx '</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'(965) xxxxxxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'   '</span></span>, )</code> <br> <br>  <span class="hljs-type"><span class="hljs-type">HTML</span></span>    .: <br> <code class="html">&lt;!<span class="hljs-type"><span class="hljs-type">DOCTYPE</span></span> html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-comment"><span class="hljs-comment">"utf-8"</span></span>&gt; &lt;title&gt;<span class="hljs-type"><span class="hljs-type">Map</span></span> grabber&lt;/title&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU"</span></span> type=<span class="hljs-comment"><span class="hljs-comment">"text/javascript"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"</span></span>&gt;&lt;/script&gt; &lt;style&gt; html, body, .<span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { margin: <span class="hljs-number"><span class="hljs-number">0</span></span>; padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { width: <span class="hljs-number"><span class="hljs-number">100</span></span>%; height: <span class="hljs-number"><span class="hljs-number">800</span></span>px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id=<span class="hljs-comment"><span class="hljs-comment">"map"</span></span>&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach (<span class="hljs-string"><span class="hljs-string">$a</span></span>ll as <span class="hljs-string"><span class="hljs-string">$o</span></span>ffer) {?&gt; coords.push(<span class="hljs-string"><span class="hljs-string">'-, &lt;?=$offer['</span></span>address<span class="hljs-string"><span class="hljs-string">']?&gt;'</span></span>) info.push(&lt;?=json_encode(<span class="hljs-string"><span class="hljs-string">$o</span></span>ffer, <span class="hljs-type"><span class="hljs-type">JSON_UNESCAPED_UNICODE</span></span>)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code><span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span></code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> <span class="hljs-type"><span class="hljs-type">API</span></span> </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.<span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">'map'</span></span>, { center: [<span class="hljs-number"><span class="hljs-number">59.932666</span></span>, <span class="hljs-number"><span class="hljs-number">30.329596</span></span>], zoom: <span class="hljs-number"><span class="hljs-number">13</span></span>, behaviors: [<span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'scrollZoom'</span></span>], }) //     : map.controls .add(<span class="hljs-string"><span class="hljs-string">'zoomControl'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">5</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) .add(<span class="hljs-string"><span class="hljs-string">'mapTools'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">35</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) //        . (new <span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span>({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = <span class="hljs-string"><span class="hljs-string">'&lt;p&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;b&gt;'</span></span>).append( <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;a&gt;'</span></span>) .attr({href: cells.url, target: <span class="hljs-string"><span class="hljs-string">'_blank'</span></span>}) .text(cells.address) )[<span class="hljs-number"><span class="hljs-number">0</span></span>].outerHTML + <span class="hljs-string"><span class="hljs-string">'&lt;/p&gt;'</span></span> //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set(<span class="hljs-string"><span class="hljs-string">'balloonContentBody'</span></span>, text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  <span class="hljs-type"><span class="hljs-type">API</span></span></a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker=<span class="hljs-comment"><span class="hljs-comment">"twirl#redDotIcon"</span></span>&gt;. // twirl<span class="hljs-symbol"><span class="hljs-symbol">#redDotIcon</span></span> -   (preset)    . <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'p[data-marker] input'</span></span>).val(function (i, value) { var marker = <span class="hljs-string"><span class="hljs-string">$(</span></span>this).parent().attr(<span class="hljs-string"><span class="hljs-string">'data-marker'</span></span>) value = <span class="hljs-string"><span class="hljs-string">$.</span></span>trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: <span class="hljs-number"><span class="hljs-number">123</span></span>, rooms: <span class="hljs-number"><span class="hljs-number">2</span></span>, ...}. <span class="hljs-string"><span class="hljs-string">$.</span></span>each(info, function (i, cells) { var colored = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new <span class="hljs-type"><span class="hljs-type">Function</span></span>(<span class="hljs-string"><span class="hljs-string">'cells'</span></span>, <span class="hljs-string"><span class="hljs-string">'return '</span></span> + item[<span class="hljs-number"><span class="hljs-number">1</span></span>]); //      -   ,  . if (func(cells)) { cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, item[<span class="hljs-number"><span class="hljs-number">0</span></span>]) //    . colored = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } } //      -     . colored || cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, <span class="hljs-string"><span class="hljs-string">'twirl#blueIcon'</span></span>) })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b><span class="hljs-type"><span class="hljs-type">UPD</span></span>:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    <span class="hljs-type"><span class="hljs-type">Gist</span></span></a> .    ,        :)</code> </pre> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> <pre> <code class="hljs smalltalk"><code>),    -   ,   ,    <span class="hljs-type"><span class="hljs-type">DOMNode</span></span></code> . <br> <br>     : <br> <code class="php">//  . <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array(); <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL = <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'</span></span>; // ,       . <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty = iconv(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'   0'</span></span>); //        . foreach ((array) <span class="hljs-string"><span class="hljs-string">$_</span></span>REQUEST[<span class="hljs-string"><span class="hljs-string">'region'</span></span>] as <span class="hljs-string"><span class="hljs-string">$r</span></span>egion) { <span class="hljs-string"><span class="hljs-string">$u</span></span>rl = <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL.<span class="hljs-comment"><span class="hljs-comment">"region$region=$region&amp;"</span></span>; //  ... //   ,      <span class="hljs-number"><span class="hljs-number">300</span></span> -    //      ,     <span class="hljs-number"><span class="hljs-number">300.</span></span> foreach (range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>) as <span class="hljs-string"><span class="hljs-string">$p</span></span>rice0) { <span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL = <span class="hljs-string"><span class="hljs-string">$u</span></span>rl.<span class="hljs-comment"><span class="hljs-comment">"price1=$price0&amp;price2="</span></span>.(<span class="hljs-string"><span class="hljs-string">$p</span></span>rice0 + <span class="hljs-number"><span class="hljs-number">999</span></span>); //   - .   . <span class="hljs-string"><span class="hljs-string">$d</span></span>ata = dl(<span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL); if (!strpos(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata, <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty)) { //  . <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers = parse(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata); <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array_merge(<span class="hljs-string"><span class="hljs-string">$a</span></span>ll, <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers); } //    . usleep(<span class="hljs-number"><span class="hljs-number">200000</span></span>); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   <span class="hljs-type"><span class="hljs-type">HTML</span></span>   . <br> <code class="php">function parse(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) { //  <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>,      <span class="hljs-type"><span class="hljs-type">UTF</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> ( , //    ). <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">'&lt;?xml encoding="UTF-8"&gt;'</span></span>.iconv(<span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml); <span class="hljs-string"><span class="hljs-string">$d</span></span>oc = new <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>(<span class="hljs-string"><span class="hljs-string">'1.0'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>); @<span class="hljs-string"><span class="hljs-string">$d</span></span>oc-&gt;loadHTML(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) or die(<span class="hljs-string"><span class="hljs-string">'loadHTML: '</span></span>.<span class="hljs-string"><span class="hljs-string">$h</span></span>tml); //      . <span class="hljs-string"><span class="hljs-string">$x</span></span>path = new <span class="hljs-type"><span class="hljs-type">DOMXPath</span></span>(<span class="hljs-string"><span class="hljs-string">$d</span></span>oc); //    ,       -  //  ()    ,   . <span class="hljs-string"><span class="hljs-string">$n</span></span>odes = <span class="hljs-string"><span class="hljs-string">$x</span></span>path-&gt;query(<span class="hljs-string"><span class="hljs-string">'//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'</span></span>); //    . <span class="hljs-string"><span class="hljs-string">$r</span></span>esults = array(); //        (,    ) -  //  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; // <span class="hljs-string"><span class="hljs-string">$n</span></span>odes -  - (tr). foreach (<span class="hljs-string"><span class="hljs-string">$n</span></span>odes as <span class="hljs-string"><span class="hljs-string">$r</span></span>ow) { //     - ,   .. <span class="hljs-string"><span class="hljs-string">$c</span></span>ells = array(); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;firstChild; while (<span class="hljs-string"><span class="hljs-string">$c</span></span>ell) { <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeType == <span class="hljs-type"><span class="hljs-type">XML_ELEMENT_NODE</span></span> and <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[] = trim(<span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeValue); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nextSibling; } if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { //      -       // .  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = (int) reset(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } else { <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount; //    colspan     -   //   . if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">10</span></span>) { array_splice(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, array(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">6</span></span>], <span class="hljs-string"><span class="hljs-string">''</span></span>)); } //   ,       . <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;ownerDocument-&gt;saveXML(<span class="hljs-string"><span class="hljs-string">$r</span></span>ow); if (preg_match(<span class="hljs-string"><span class="hljs-string">'~&lt;a href="([^"]+)~u'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml, <span class="hljs-string"><span class="hljs-string">$m</span></span>atch)) { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru'</span></span>.<span class="hljs-string"><span class="hljs-string">$m</span></span>atch[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } else { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">''</span></span>); } // ,     . <span class="hljs-string"><span class="hljs-string">$k</span></span>eys = array(<span class="hljs-string"><span class="hljs-string">'url'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span>); <span class="hljs-string"><span class="hljs-string">$r</span></span>esult[] = array_combine(<span class="hljs-string"><span class="hljs-string">$k</span></span>eys, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } } return <span class="hljs-string"><span class="hljs-string">$r</span></span>esult; }</code> <br> <br>  <br> ,    -  <code><span class="hljs-string"><span class="hljs-string">$a</span></span>ll</code>        .    -    .      : <br> <code class="php">array( <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/detail/flats/xxxxxx.html?from=search'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'7  ., xxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1\\5'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'30'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'18.3'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'6'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3100'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'xxxxx '</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'(965) xxxxxxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'   '</span></span>, )</code> <br> <br>  <span class="hljs-type"><span class="hljs-type">HTML</span></span>    .: <br> <code class="html">&lt;!<span class="hljs-type"><span class="hljs-type">DOCTYPE</span></span> html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-comment"><span class="hljs-comment">"utf-8"</span></span>&gt; &lt;title&gt;<span class="hljs-type"><span class="hljs-type">Map</span></span> grabber&lt;/title&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU"</span></span> type=<span class="hljs-comment"><span class="hljs-comment">"text/javascript"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"</span></span>&gt;&lt;/script&gt; &lt;style&gt; html, body, .<span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { margin: <span class="hljs-number"><span class="hljs-number">0</span></span>; padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { width: <span class="hljs-number"><span class="hljs-number">100</span></span>%; height: <span class="hljs-number"><span class="hljs-number">800</span></span>px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id=<span class="hljs-comment"><span class="hljs-comment">"map"</span></span>&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach (<span class="hljs-string"><span class="hljs-string">$a</span></span>ll as <span class="hljs-string"><span class="hljs-string">$o</span></span>ffer) {?&gt; coords.push(<span class="hljs-string"><span class="hljs-string">'-, &lt;?=$offer['</span></span>address<span class="hljs-string"><span class="hljs-string">']?&gt;'</span></span>) info.push(&lt;?=json_encode(<span class="hljs-string"><span class="hljs-string">$o</span></span>ffer, <span class="hljs-type"><span class="hljs-type">JSON_UNESCAPED_UNICODE</span></span>)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code><span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span></code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> <span class="hljs-type"><span class="hljs-type">API</span></span> </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.<span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">'map'</span></span>, { center: [<span class="hljs-number"><span class="hljs-number">59.932666</span></span>, <span class="hljs-number"><span class="hljs-number">30.329596</span></span>], zoom: <span class="hljs-number"><span class="hljs-number">13</span></span>, behaviors: [<span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'scrollZoom'</span></span>], }) //     : map.controls .add(<span class="hljs-string"><span class="hljs-string">'zoomControl'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">5</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) .add(<span class="hljs-string"><span class="hljs-string">'mapTools'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">35</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) //        . (new <span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span>({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = <span class="hljs-string"><span class="hljs-string">'&lt;p&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;b&gt;'</span></span>).append( <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;a&gt;'</span></span>) .attr({href: cells.url, target: <span class="hljs-string"><span class="hljs-string">'_blank'</span></span>}) .text(cells.address) )[<span class="hljs-number"><span class="hljs-number">0</span></span>].outerHTML + <span class="hljs-string"><span class="hljs-string">'&lt;/p&gt;'</span></span> //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set(<span class="hljs-string"><span class="hljs-string">'balloonContentBody'</span></span>, text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  <span class="hljs-type"><span class="hljs-type">API</span></span></a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker=<span class="hljs-comment"><span class="hljs-comment">"twirl#redDotIcon"</span></span>&gt;. // twirl<span class="hljs-symbol"><span class="hljs-symbol">#redDotIcon</span></span> -   (preset)    . <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'p[data-marker] input'</span></span>).val(function (i, value) { var marker = <span class="hljs-string"><span class="hljs-string">$(</span></span>this).parent().attr(<span class="hljs-string"><span class="hljs-string">'data-marker'</span></span>) value = <span class="hljs-string"><span class="hljs-string">$.</span></span>trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: <span class="hljs-number"><span class="hljs-number">123</span></span>, rooms: <span class="hljs-number"><span class="hljs-number">2</span></span>, ...}. <span class="hljs-string"><span class="hljs-string">$.</span></span>each(info, function (i, cells) { var colored = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new <span class="hljs-type"><span class="hljs-type">Function</span></span>(<span class="hljs-string"><span class="hljs-string">'cells'</span></span>, <span class="hljs-string"><span class="hljs-string">'return '</span></span> + item[<span class="hljs-number"><span class="hljs-number">1</span></span>]); //      -   ,  . if (func(cells)) { cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, item[<span class="hljs-number"><span class="hljs-number">0</span></span>]) //    . colored = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } } //      -     . colored || cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, <span class="hljs-string"><span class="hljs-string">'twirl#blueIcon'</span></span>) })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b><span class="hljs-type"><span class="hljs-type">UPD</span></span>:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    <span class="hljs-type"><span class="hljs-type">Gist</span></span></a> .    ,        :)</code> </pre> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> <h4> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> </h4> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> <pre> <code class="hljs smalltalk"><code>),    -   ,   ,    <span class="hljs-type"><span class="hljs-type">DOMNode</span></span></code> . <br> <br>     : <br> <code class="php">//  . <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array(); <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL = <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'</span></span>; // ,       . <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty = iconv(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'   0'</span></span>); //        . foreach ((array) <span class="hljs-string"><span class="hljs-string">$_</span></span>REQUEST[<span class="hljs-string"><span class="hljs-string">'region'</span></span>] as <span class="hljs-string"><span class="hljs-string">$r</span></span>egion) { <span class="hljs-string"><span class="hljs-string">$u</span></span>rl = <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL.<span class="hljs-comment"><span class="hljs-comment">"region$region=$region&amp;"</span></span>; //  ... //   ,      <span class="hljs-number"><span class="hljs-number">300</span></span> -    //      ,     <span class="hljs-number"><span class="hljs-number">300.</span></span> foreach (range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>) as <span class="hljs-string"><span class="hljs-string">$p</span></span>rice0) { <span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL = <span class="hljs-string"><span class="hljs-string">$u</span></span>rl.<span class="hljs-comment"><span class="hljs-comment">"price1=$price0&amp;price2="</span></span>.(<span class="hljs-string"><span class="hljs-string">$p</span></span>rice0 + <span class="hljs-number"><span class="hljs-number">999</span></span>); //   - .   . <span class="hljs-string"><span class="hljs-string">$d</span></span>ata = dl(<span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL); if (!strpos(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata, <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty)) { //  . <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers = parse(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata); <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array_merge(<span class="hljs-string"><span class="hljs-string">$a</span></span>ll, <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers); } //    . usleep(<span class="hljs-number"><span class="hljs-number">200000</span></span>); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   <span class="hljs-type"><span class="hljs-type">HTML</span></span>   . <br> <code class="php">function parse(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) { //  <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>,      <span class="hljs-type"><span class="hljs-type">UTF</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> ( , //    ). <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">'&lt;?xml encoding="UTF-8"&gt;'</span></span>.iconv(<span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml); <span class="hljs-string"><span class="hljs-string">$d</span></span>oc = new <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>(<span class="hljs-string"><span class="hljs-string">'1.0'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>); @<span class="hljs-string"><span class="hljs-string">$d</span></span>oc-&gt;loadHTML(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) or die(<span class="hljs-string"><span class="hljs-string">'loadHTML: '</span></span>.<span class="hljs-string"><span class="hljs-string">$h</span></span>tml); //      . <span class="hljs-string"><span class="hljs-string">$x</span></span>path = new <span class="hljs-type"><span class="hljs-type">DOMXPath</span></span>(<span class="hljs-string"><span class="hljs-string">$d</span></span>oc); //    ,       -  //  ()    ,   . <span class="hljs-string"><span class="hljs-string">$n</span></span>odes = <span class="hljs-string"><span class="hljs-string">$x</span></span>path-&gt;query(<span class="hljs-string"><span class="hljs-string">'//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'</span></span>); //    . <span class="hljs-string"><span class="hljs-string">$r</span></span>esults = array(); //        (,    ) -  //  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; // <span class="hljs-string"><span class="hljs-string">$n</span></span>odes -  - (tr). foreach (<span class="hljs-string"><span class="hljs-string">$n</span></span>odes as <span class="hljs-string"><span class="hljs-string">$r</span></span>ow) { //     - ,   .. <span class="hljs-string"><span class="hljs-string">$c</span></span>ells = array(); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;firstChild; while (<span class="hljs-string"><span class="hljs-string">$c</span></span>ell) { <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeType == <span class="hljs-type"><span class="hljs-type">XML_ELEMENT_NODE</span></span> and <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[] = trim(<span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeValue); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nextSibling; } if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { //      -       // .  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = (int) reset(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } else { <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount; //    colspan     -   //   . if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">10</span></span>) { array_splice(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, array(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">6</span></span>], <span class="hljs-string"><span class="hljs-string">''</span></span>)); } //   ,       . <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;ownerDocument-&gt;saveXML(<span class="hljs-string"><span class="hljs-string">$r</span></span>ow); if (preg_match(<span class="hljs-string"><span class="hljs-string">'~&lt;a href="([^"]+)~u'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml, <span class="hljs-string"><span class="hljs-string">$m</span></span>atch)) { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru'</span></span>.<span class="hljs-string"><span class="hljs-string">$m</span></span>atch[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } else { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">''</span></span>); } // ,     . <span class="hljs-string"><span class="hljs-string">$k</span></span>eys = array(<span class="hljs-string"><span class="hljs-string">'url'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span>); <span class="hljs-string"><span class="hljs-string">$r</span></span>esult[] = array_combine(<span class="hljs-string"><span class="hljs-string">$k</span></span>eys, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } } return <span class="hljs-string"><span class="hljs-string">$r</span></span>esult; }</code> <br> <br>  <br> ,    -  <code><span class="hljs-string"><span class="hljs-string">$a</span></span>ll</code>        .    -    .      : <br> <code class="php">array( <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/detail/flats/xxxxxx.html?from=search'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'7  ., xxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1\\5'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'30'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'18.3'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'6'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3100'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'xxxxx '</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'(965) xxxxxxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'   '</span></span>, )</code> <br> <br>  <span class="hljs-type"><span class="hljs-type">HTML</span></span>    .: <br> <code class="html">&lt;!<span class="hljs-type"><span class="hljs-type">DOCTYPE</span></span> html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-comment"><span class="hljs-comment">"utf-8"</span></span>&gt; &lt;title&gt;<span class="hljs-type"><span class="hljs-type">Map</span></span> grabber&lt;/title&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU"</span></span> type=<span class="hljs-comment"><span class="hljs-comment">"text/javascript"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"</span></span>&gt;&lt;/script&gt; &lt;style&gt; html, body, .<span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { margin: <span class="hljs-number"><span class="hljs-number">0</span></span>; padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { width: <span class="hljs-number"><span class="hljs-number">100</span></span>%; height: <span class="hljs-number"><span class="hljs-number">800</span></span>px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id=<span class="hljs-comment"><span class="hljs-comment">"map"</span></span>&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach (<span class="hljs-string"><span class="hljs-string">$a</span></span>ll as <span class="hljs-string"><span class="hljs-string">$o</span></span>ffer) {?&gt; coords.push(<span class="hljs-string"><span class="hljs-string">'-, &lt;?=$offer['</span></span>address<span class="hljs-string"><span class="hljs-string">']?&gt;'</span></span>) info.push(&lt;?=json_encode(<span class="hljs-string"><span class="hljs-string">$o</span></span>ffer, <span class="hljs-type"><span class="hljs-type">JSON_UNESCAPED_UNICODE</span></span>)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code><span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span></code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> <span class="hljs-type"><span class="hljs-type">API</span></span> </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.<span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">'map'</span></span>, { center: [<span class="hljs-number"><span class="hljs-number">59.932666</span></span>, <span class="hljs-number"><span class="hljs-number">30.329596</span></span>], zoom: <span class="hljs-number"><span class="hljs-number">13</span></span>, behaviors: [<span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'scrollZoom'</span></span>], }) //     : map.controls .add(<span class="hljs-string"><span class="hljs-string">'zoomControl'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">5</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) .add(<span class="hljs-string"><span class="hljs-string">'mapTools'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">35</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) //        . (new <span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span>({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = <span class="hljs-string"><span class="hljs-string">'&lt;p&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;b&gt;'</span></span>).append( <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;a&gt;'</span></span>) .attr({href: cells.url, target: <span class="hljs-string"><span class="hljs-string">'_blank'</span></span>}) .text(cells.address) )[<span class="hljs-number"><span class="hljs-number">0</span></span>].outerHTML + <span class="hljs-string"><span class="hljs-string">'&lt;/p&gt;'</span></span> //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set(<span class="hljs-string"><span class="hljs-string">'balloonContentBody'</span></span>, text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  <span class="hljs-type"><span class="hljs-type">API</span></span></a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker=<span class="hljs-comment"><span class="hljs-comment">"twirl#redDotIcon"</span></span>&gt;. // twirl<span class="hljs-symbol"><span class="hljs-symbol">#redDotIcon</span></span> -   (preset)    . <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'p[data-marker] input'</span></span>).val(function (i, value) { var marker = <span class="hljs-string"><span class="hljs-string">$(</span></span>this).parent().attr(<span class="hljs-string"><span class="hljs-string">'data-marker'</span></span>) value = <span class="hljs-string"><span class="hljs-string">$.</span></span>trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: <span class="hljs-number"><span class="hljs-number">123</span></span>, rooms: <span class="hljs-number"><span class="hljs-number">2</span></span>, ...}. <span class="hljs-string"><span class="hljs-string">$.</span></span>each(info, function (i, cells) { var colored = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new <span class="hljs-type"><span class="hljs-type">Function</span></span>(<span class="hljs-string"><span class="hljs-string">'cells'</span></span>, <span class="hljs-string"><span class="hljs-string">'return '</span></span> + item[<span class="hljs-number"><span class="hljs-number">1</span></span>]); //      -   ,  . if (func(cells)) { cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, item[<span class="hljs-number"><span class="hljs-number">0</span></span>]) //    . colored = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } } //      -     . colored || cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, <span class="hljs-string"><span class="hljs-string">'twirl#blueIcon'</span></span>) })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b><span class="hljs-type"><span class="hljs-type">UPD</span></span>:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    <span class="hljs-type"><span class="hljs-type">Gist</span></span></a> .    ,        :)</code> </pre> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> <pre> <code class="hljs smalltalk"><code>),    -   ,   ,    <span class="hljs-type"><span class="hljs-type">DOMNode</span></span></code> . <br> <br>     : <br> <code class="php">//  . <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array(); <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL = <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'</span></span>; // ,       . <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty = iconv(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'   0'</span></span>); //        . foreach ((array) <span class="hljs-string"><span class="hljs-string">$_</span></span>REQUEST[<span class="hljs-string"><span class="hljs-string">'region'</span></span>] as <span class="hljs-string"><span class="hljs-string">$r</span></span>egion) { <span class="hljs-string"><span class="hljs-string">$u</span></span>rl = <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL.<span class="hljs-comment"><span class="hljs-comment">"region$region=$region&amp;"</span></span>; //  ... //   ,      <span class="hljs-number"><span class="hljs-number">300</span></span> -    //      ,     <span class="hljs-number"><span class="hljs-number">300.</span></span> foreach (range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>) as <span class="hljs-string"><span class="hljs-string">$p</span></span>rice0) { <span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL = <span class="hljs-string"><span class="hljs-string">$u</span></span>rl.<span class="hljs-comment"><span class="hljs-comment">"price1=$price0&amp;price2="</span></span>.(<span class="hljs-string"><span class="hljs-string">$p</span></span>rice0 + <span class="hljs-number"><span class="hljs-number">999</span></span>); //   - .   . <span class="hljs-string"><span class="hljs-string">$d</span></span>ata = dl(<span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL); if (!strpos(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata, <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty)) { //  . <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers = parse(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata); <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array_merge(<span class="hljs-string"><span class="hljs-string">$a</span></span>ll, <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers); } //    . usleep(<span class="hljs-number"><span class="hljs-number">200000</span></span>); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   <span class="hljs-type"><span class="hljs-type">HTML</span></span>   . <br> <code class="php">function parse(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) { //  <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>,      <span class="hljs-type"><span class="hljs-type">UTF</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> ( , //    ). <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">'&lt;?xml encoding="UTF-8"&gt;'</span></span>.iconv(<span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml); <span class="hljs-string"><span class="hljs-string">$d</span></span>oc = new <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>(<span class="hljs-string"><span class="hljs-string">'1.0'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>); @<span class="hljs-string"><span class="hljs-string">$d</span></span>oc-&gt;loadHTML(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) or die(<span class="hljs-string"><span class="hljs-string">'loadHTML: '</span></span>.<span class="hljs-string"><span class="hljs-string">$h</span></span>tml); //      . <span class="hljs-string"><span class="hljs-string">$x</span></span>path = new <span class="hljs-type"><span class="hljs-type">DOMXPath</span></span>(<span class="hljs-string"><span class="hljs-string">$d</span></span>oc); //    ,       -  //  ()    ,   . <span class="hljs-string"><span class="hljs-string">$n</span></span>odes = <span class="hljs-string"><span class="hljs-string">$x</span></span>path-&gt;query(<span class="hljs-string"><span class="hljs-string">'//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'</span></span>); //    . <span class="hljs-string"><span class="hljs-string">$r</span></span>esults = array(); //        (,    ) -  //  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; // <span class="hljs-string"><span class="hljs-string">$n</span></span>odes -  - (tr). foreach (<span class="hljs-string"><span class="hljs-string">$n</span></span>odes as <span class="hljs-string"><span class="hljs-string">$r</span></span>ow) { //     - ,   .. <span class="hljs-string"><span class="hljs-string">$c</span></span>ells = array(); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;firstChild; while (<span class="hljs-string"><span class="hljs-string">$c</span></span>ell) { <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeType == <span class="hljs-type"><span class="hljs-type">XML_ELEMENT_NODE</span></span> and <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[] = trim(<span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeValue); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nextSibling; } if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { //      -       // .  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = (int) reset(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } else { <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount; //    colspan     -   //   . if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">10</span></span>) { array_splice(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, array(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">6</span></span>], <span class="hljs-string"><span class="hljs-string">''</span></span>)); } //   ,       . <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;ownerDocument-&gt;saveXML(<span class="hljs-string"><span class="hljs-string">$r</span></span>ow); if (preg_match(<span class="hljs-string"><span class="hljs-string">'~&lt;a href="([^"]+)~u'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml, <span class="hljs-string"><span class="hljs-string">$m</span></span>atch)) { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru'</span></span>.<span class="hljs-string"><span class="hljs-string">$m</span></span>atch[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } else { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">''</span></span>); } // ,     . <span class="hljs-string"><span class="hljs-string">$k</span></span>eys = array(<span class="hljs-string"><span class="hljs-string">'url'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span>); <span class="hljs-string"><span class="hljs-string">$r</span></span>esult[] = array_combine(<span class="hljs-string"><span class="hljs-string">$k</span></span>eys, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } } return <span class="hljs-string"><span class="hljs-string">$r</span></span>esult; }</code> <br> <br>  <br> ,    -  <code><span class="hljs-string"><span class="hljs-string">$a</span></span>ll</code>        .    -    .      : <br> <code class="php">array( <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/detail/flats/xxxxxx.html?from=search'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'7  ., xxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1\\5'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'30'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'18.3'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'6'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3100'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'xxxxx '</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'(965) xxxxxxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'   '</span></span>, )</code> <br> <br>  <span class="hljs-type"><span class="hljs-type">HTML</span></span>    .: <br> <code class="html">&lt;!<span class="hljs-type"><span class="hljs-type">DOCTYPE</span></span> html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-comment"><span class="hljs-comment">"utf-8"</span></span>&gt; &lt;title&gt;<span class="hljs-type"><span class="hljs-type">Map</span></span> grabber&lt;/title&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU"</span></span> type=<span class="hljs-comment"><span class="hljs-comment">"text/javascript"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"</span></span>&gt;&lt;/script&gt; &lt;style&gt; html, body, .<span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { margin: <span class="hljs-number"><span class="hljs-number">0</span></span>; padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { width: <span class="hljs-number"><span class="hljs-number">100</span></span>%; height: <span class="hljs-number"><span class="hljs-number">800</span></span>px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id=<span class="hljs-comment"><span class="hljs-comment">"map"</span></span>&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach (<span class="hljs-string"><span class="hljs-string">$a</span></span>ll as <span class="hljs-string"><span class="hljs-string">$o</span></span>ffer) {?&gt; coords.push(<span class="hljs-string"><span class="hljs-string">'-, &lt;?=$offer['</span></span>address<span class="hljs-string"><span class="hljs-string">']?&gt;'</span></span>) info.push(&lt;?=json_encode(<span class="hljs-string"><span class="hljs-string">$o</span></span>ffer, <span class="hljs-type"><span class="hljs-type">JSON_UNESCAPED_UNICODE</span></span>)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code><span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span></code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> <span class="hljs-type"><span class="hljs-type">API</span></span> </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.<span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">'map'</span></span>, { center: [<span class="hljs-number"><span class="hljs-number">59.932666</span></span>, <span class="hljs-number"><span class="hljs-number">30.329596</span></span>], zoom: <span class="hljs-number"><span class="hljs-number">13</span></span>, behaviors: [<span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'scrollZoom'</span></span>], }) //     : map.controls .add(<span class="hljs-string"><span class="hljs-string">'zoomControl'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">5</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) .add(<span class="hljs-string"><span class="hljs-string">'mapTools'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">35</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) //        . (new <span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span>({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = <span class="hljs-string"><span class="hljs-string">'&lt;p&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;b&gt;'</span></span>).append( <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;a&gt;'</span></span>) .attr({href: cells.url, target: <span class="hljs-string"><span class="hljs-string">'_blank'</span></span>}) .text(cells.address) )[<span class="hljs-number"><span class="hljs-number">0</span></span>].outerHTML + <span class="hljs-string"><span class="hljs-string">'&lt;/p&gt;'</span></span> //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set(<span class="hljs-string"><span class="hljs-string">'balloonContentBody'</span></span>, text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  <span class="hljs-type"><span class="hljs-type">API</span></span></a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker=<span class="hljs-comment"><span class="hljs-comment">"twirl#redDotIcon"</span></span>&gt;. // twirl<span class="hljs-symbol"><span class="hljs-symbol">#redDotIcon</span></span> -   (preset)    . <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'p[data-marker] input'</span></span>).val(function (i, value) { var marker = <span class="hljs-string"><span class="hljs-string">$(</span></span>this).parent().attr(<span class="hljs-string"><span class="hljs-string">'data-marker'</span></span>) value = <span class="hljs-string"><span class="hljs-string">$.</span></span>trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: <span class="hljs-number"><span class="hljs-number">123</span></span>, rooms: <span class="hljs-number"><span class="hljs-number">2</span></span>, ...}. <span class="hljs-string"><span class="hljs-string">$.</span></span>each(info, function (i, cells) { var colored = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new <span class="hljs-type"><span class="hljs-type">Function</span></span>(<span class="hljs-string"><span class="hljs-string">'cells'</span></span>, <span class="hljs-string"><span class="hljs-string">'return '</span></span> + item[<span class="hljs-number"><span class="hljs-number">1</span></span>]); //      -   ,  . if (func(cells)) { cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, item[<span class="hljs-number"><span class="hljs-number">0</span></span>]) //    . colored = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } } //      -     . colored || cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, <span class="hljs-string"><span class="hljs-string">'twirl#blueIcon'</span></span>) })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b><span class="hljs-type"><span class="hljs-type">UPD</span></span>:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    <span class="hljs-type"><span class="hljs-type">Gist</span></span></a> .    ,        :)</code> </pre> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> <pre> <code class="hljs smalltalk"><code>),    -   ,   ,    <span class="hljs-type"><span class="hljs-type">DOMNode</span></span></code> . <br> <br>     : <br> <code class="php">//  . <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array(); <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL = <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'</span></span>; // ,       . <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty = iconv(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'   0'</span></span>); //        . foreach ((array) <span class="hljs-string"><span class="hljs-string">$_</span></span>REQUEST[<span class="hljs-string"><span class="hljs-string">'region'</span></span>] as <span class="hljs-string"><span class="hljs-string">$r</span></span>egion) { <span class="hljs-string"><span class="hljs-string">$u</span></span>rl = <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL.<span class="hljs-comment"><span class="hljs-comment">"region$region=$region&amp;"</span></span>; //  ... //   ,      <span class="hljs-number"><span class="hljs-number">300</span></span> -    //      ,     <span class="hljs-number"><span class="hljs-number">300.</span></span> foreach (range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>) as <span class="hljs-string"><span class="hljs-string">$p</span></span>rice0) { <span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL = <span class="hljs-string"><span class="hljs-string">$u</span></span>rl.<span class="hljs-comment"><span class="hljs-comment">"price1=$price0&amp;price2="</span></span>.(<span class="hljs-string"><span class="hljs-string">$p</span></span>rice0 + <span class="hljs-number"><span class="hljs-number">999</span></span>); //   - .   . <span class="hljs-string"><span class="hljs-string">$d</span></span>ata = dl(<span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL); if (!strpos(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata, <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty)) { //  . <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers = parse(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata); <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array_merge(<span class="hljs-string"><span class="hljs-string">$a</span></span>ll, <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers); } //    . usleep(<span class="hljs-number"><span class="hljs-number">200000</span></span>); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   <span class="hljs-type"><span class="hljs-type">HTML</span></span>   . <br> <code class="php">function parse(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) { //  <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>,      <span class="hljs-type"><span class="hljs-type">UTF</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> ( , //    ). <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">'&lt;?xml encoding="UTF-8"&gt;'</span></span>.iconv(<span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml); <span class="hljs-string"><span class="hljs-string">$d</span></span>oc = new <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>(<span class="hljs-string"><span class="hljs-string">'1.0'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>); @<span class="hljs-string"><span class="hljs-string">$d</span></span>oc-&gt;loadHTML(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) or die(<span class="hljs-string"><span class="hljs-string">'loadHTML: '</span></span>.<span class="hljs-string"><span class="hljs-string">$h</span></span>tml); //      . <span class="hljs-string"><span class="hljs-string">$x</span></span>path = new <span class="hljs-type"><span class="hljs-type">DOMXPath</span></span>(<span class="hljs-string"><span class="hljs-string">$d</span></span>oc); //    ,       -  //  ()    ,   . <span class="hljs-string"><span class="hljs-string">$n</span></span>odes = <span class="hljs-string"><span class="hljs-string">$x</span></span>path-&gt;query(<span class="hljs-string"><span class="hljs-string">'//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'</span></span>); //    . <span class="hljs-string"><span class="hljs-string">$r</span></span>esults = array(); //        (,    ) -  //  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; // <span class="hljs-string"><span class="hljs-string">$n</span></span>odes -  - (tr). foreach (<span class="hljs-string"><span class="hljs-string">$n</span></span>odes as <span class="hljs-string"><span class="hljs-string">$r</span></span>ow) { //     - ,   .. <span class="hljs-string"><span class="hljs-string">$c</span></span>ells = array(); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;firstChild; while (<span class="hljs-string"><span class="hljs-string">$c</span></span>ell) { <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeType == <span class="hljs-type"><span class="hljs-type">XML_ELEMENT_NODE</span></span> and <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[] = trim(<span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeValue); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nextSibling; } if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { //      -       // .  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = (int) reset(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } else { <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount; //    colspan     -   //   . if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">10</span></span>) { array_splice(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, array(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">6</span></span>], <span class="hljs-string"><span class="hljs-string">''</span></span>)); } //   ,       . <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;ownerDocument-&gt;saveXML(<span class="hljs-string"><span class="hljs-string">$r</span></span>ow); if (preg_match(<span class="hljs-string"><span class="hljs-string">'~&lt;a href="([^"]+)~u'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml, <span class="hljs-string"><span class="hljs-string">$m</span></span>atch)) { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru'</span></span>.<span class="hljs-string"><span class="hljs-string">$m</span></span>atch[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } else { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">''</span></span>); } // ,     . <span class="hljs-string"><span class="hljs-string">$k</span></span>eys = array(<span class="hljs-string"><span class="hljs-string">'url'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span>); <span class="hljs-string"><span class="hljs-string">$r</span></span>esult[] = array_combine(<span class="hljs-string"><span class="hljs-string">$k</span></span>eys, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } } return <span class="hljs-string"><span class="hljs-string">$r</span></span>esult; }</code> <br> <br>  <br> ,    -  <code><span class="hljs-string"><span class="hljs-string">$a</span></span>ll</code>        .    -    .      : <br> <code class="php">array( <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/detail/flats/xxxxxx.html?from=search'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'7  ., xxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1\\5'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'30'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'18.3'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'6'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3100'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'xxxxx '</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'(965) xxxxxxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'   '</span></span>, )</code> <br> <br>  <span class="hljs-type"><span class="hljs-type">HTML</span></span>    .: <br> <code class="html">&lt;!<span class="hljs-type"><span class="hljs-type">DOCTYPE</span></span> html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-comment"><span class="hljs-comment">"utf-8"</span></span>&gt; &lt;title&gt;<span class="hljs-type"><span class="hljs-type">Map</span></span> grabber&lt;/title&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU"</span></span> type=<span class="hljs-comment"><span class="hljs-comment">"text/javascript"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"</span></span>&gt;&lt;/script&gt; &lt;style&gt; html, body, .<span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { margin: <span class="hljs-number"><span class="hljs-number">0</span></span>; padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { width: <span class="hljs-number"><span class="hljs-number">100</span></span>%; height: <span class="hljs-number"><span class="hljs-number">800</span></span>px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id=<span class="hljs-comment"><span class="hljs-comment">"map"</span></span>&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach (<span class="hljs-string"><span class="hljs-string">$a</span></span>ll as <span class="hljs-string"><span class="hljs-string">$o</span></span>ffer) {?&gt; coords.push(<span class="hljs-string"><span class="hljs-string">'-, &lt;?=$offer['</span></span>address<span class="hljs-string"><span class="hljs-string">']?&gt;'</span></span>) info.push(&lt;?=json_encode(<span class="hljs-string"><span class="hljs-string">$o</span></span>ffer, <span class="hljs-type"><span class="hljs-type">JSON_UNESCAPED_UNICODE</span></span>)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code><span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span></code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> <span class="hljs-type"><span class="hljs-type">API</span></span> </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.<span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">'map'</span></span>, { center: [<span class="hljs-number"><span class="hljs-number">59.932666</span></span>, <span class="hljs-number"><span class="hljs-number">30.329596</span></span>], zoom: <span class="hljs-number"><span class="hljs-number">13</span></span>, behaviors: [<span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'scrollZoom'</span></span>], }) //     : map.controls .add(<span class="hljs-string"><span class="hljs-string">'zoomControl'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">5</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) .add(<span class="hljs-string"><span class="hljs-string">'mapTools'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">35</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) //        . (new <span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span>({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = <span class="hljs-string"><span class="hljs-string">'&lt;p&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;b&gt;'</span></span>).append( <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;a&gt;'</span></span>) .attr({href: cells.url, target: <span class="hljs-string"><span class="hljs-string">'_blank'</span></span>}) .text(cells.address) )[<span class="hljs-number"><span class="hljs-number">0</span></span>].outerHTML + <span class="hljs-string"><span class="hljs-string">'&lt;/p&gt;'</span></span> //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set(<span class="hljs-string"><span class="hljs-string">'balloonContentBody'</span></span>, text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  <span class="hljs-type"><span class="hljs-type">API</span></span></a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker=<span class="hljs-comment"><span class="hljs-comment">"twirl#redDotIcon"</span></span>&gt;. // twirl<span class="hljs-symbol"><span class="hljs-symbol">#redDotIcon</span></span> -   (preset)    . <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'p[data-marker] input'</span></span>).val(function (i, value) { var marker = <span class="hljs-string"><span class="hljs-string">$(</span></span>this).parent().attr(<span class="hljs-string"><span class="hljs-string">'data-marker'</span></span>) value = <span class="hljs-string"><span class="hljs-string">$.</span></span>trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: <span class="hljs-number"><span class="hljs-number">123</span></span>, rooms: <span class="hljs-number"><span class="hljs-number">2</span></span>, ...}. <span class="hljs-string"><span class="hljs-string">$.</span></span>each(info, function (i, cells) { var colored = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new <span class="hljs-type"><span class="hljs-type">Function</span></span>(<span class="hljs-string"><span class="hljs-string">'cells'</span></span>, <span class="hljs-string"><span class="hljs-string">'return '</span></span> + item[<span class="hljs-number"><span class="hljs-number">1</span></span>]); //      -   ,  . if (func(cells)) { cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, item[<span class="hljs-number"><span class="hljs-number">0</span></span>]) //    . colored = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } } //      -     . colored || cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, <span class="hljs-string"><span class="hljs-string">'twirl#blueIcon'</span></span>) })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b><span class="hljs-type"><span class="hljs-type">UPD</span></span>:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    <span class="hljs-type"><span class="hljs-type">Gist</span></span></a> .    ,        :)</code> </pre> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> <pre> <code class="hljs smalltalk"><code>),    -   ,   ,    <span class="hljs-type"><span class="hljs-type">DOMNode</span></span></code> . <br> <br>     : <br> <code class="php">//  . <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array(); <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL = <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'</span></span>; // ,       . <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty = iconv(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'   0'</span></span>); //        . foreach ((array) <span class="hljs-string"><span class="hljs-string">$_</span></span>REQUEST[<span class="hljs-string"><span class="hljs-string">'region'</span></span>] as <span class="hljs-string"><span class="hljs-string">$r</span></span>egion) { <span class="hljs-string"><span class="hljs-string">$u</span></span>rl = <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL.<span class="hljs-comment"><span class="hljs-comment">"region$region=$region&amp;"</span></span>; //  ... //   ,      <span class="hljs-number"><span class="hljs-number">300</span></span> -    //      ,     <span class="hljs-number"><span class="hljs-number">300.</span></span> foreach (range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>) as <span class="hljs-string"><span class="hljs-string">$p</span></span>rice0) { <span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL = <span class="hljs-string"><span class="hljs-string">$u</span></span>rl.<span class="hljs-comment"><span class="hljs-comment">"price1=$price0&amp;price2="</span></span>.(<span class="hljs-string"><span class="hljs-string">$p</span></span>rice0 + <span class="hljs-number"><span class="hljs-number">999</span></span>); //   - .   . <span class="hljs-string"><span class="hljs-string">$d</span></span>ata = dl(<span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL); if (!strpos(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata, <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty)) { //  . <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers = parse(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata); <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array_merge(<span class="hljs-string"><span class="hljs-string">$a</span></span>ll, <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers); } //    . usleep(<span class="hljs-number"><span class="hljs-number">200000</span></span>); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   <span class="hljs-type"><span class="hljs-type">HTML</span></span>   . <br> <code class="php">function parse(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) { //  <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>,      <span class="hljs-type"><span class="hljs-type">UTF</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> ( , //    ). <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">'&lt;?xml encoding="UTF-8"&gt;'</span></span>.iconv(<span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml); <span class="hljs-string"><span class="hljs-string">$d</span></span>oc = new <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>(<span class="hljs-string"><span class="hljs-string">'1.0'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>); @<span class="hljs-string"><span class="hljs-string">$d</span></span>oc-&gt;loadHTML(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) or die(<span class="hljs-string"><span class="hljs-string">'loadHTML: '</span></span>.<span class="hljs-string"><span class="hljs-string">$h</span></span>tml); //      . <span class="hljs-string"><span class="hljs-string">$x</span></span>path = new <span class="hljs-type"><span class="hljs-type">DOMXPath</span></span>(<span class="hljs-string"><span class="hljs-string">$d</span></span>oc); //    ,       -  //  ()    ,   . <span class="hljs-string"><span class="hljs-string">$n</span></span>odes = <span class="hljs-string"><span class="hljs-string">$x</span></span>path-&gt;query(<span class="hljs-string"><span class="hljs-string">'//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'</span></span>); //    . <span class="hljs-string"><span class="hljs-string">$r</span></span>esults = array(); //        (,    ) -  //  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; // <span class="hljs-string"><span class="hljs-string">$n</span></span>odes -  - (tr). foreach (<span class="hljs-string"><span class="hljs-string">$n</span></span>odes as <span class="hljs-string"><span class="hljs-string">$r</span></span>ow) { //     - ,   .. <span class="hljs-string"><span class="hljs-string">$c</span></span>ells = array(); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;firstChild; while (<span class="hljs-string"><span class="hljs-string">$c</span></span>ell) { <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeType == <span class="hljs-type"><span class="hljs-type">XML_ELEMENT_NODE</span></span> and <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[] = trim(<span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeValue); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nextSibling; } if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { //      -       // .  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = (int) reset(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } else { <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount; //    colspan     -   //   . if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">10</span></span>) { array_splice(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, array(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">6</span></span>], <span class="hljs-string"><span class="hljs-string">''</span></span>)); } //   ,       . <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;ownerDocument-&gt;saveXML(<span class="hljs-string"><span class="hljs-string">$r</span></span>ow); if (preg_match(<span class="hljs-string"><span class="hljs-string">'~&lt;a href="([^"]+)~u'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml, <span class="hljs-string"><span class="hljs-string">$m</span></span>atch)) { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru'</span></span>.<span class="hljs-string"><span class="hljs-string">$m</span></span>atch[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } else { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">''</span></span>); } // ,     . <span class="hljs-string"><span class="hljs-string">$k</span></span>eys = array(<span class="hljs-string"><span class="hljs-string">'url'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span>); <span class="hljs-string"><span class="hljs-string">$r</span></span>esult[] = array_combine(<span class="hljs-string"><span class="hljs-string">$k</span></span>eys, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } } return <span class="hljs-string"><span class="hljs-string">$r</span></span>esult; }</code> <br> <br>  <br> ,    -  <code><span class="hljs-string"><span class="hljs-string">$a</span></span>ll</code>        .    -    .      : <br> <code class="php">array( <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/detail/flats/xxxxxx.html?from=search'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'7  ., xxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1\\5'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'30'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'18.3'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'6'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3100'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'xxxxx '</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'(965) xxxxxxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'   '</span></span>, )</code> <br> <br>  <span class="hljs-type"><span class="hljs-type">HTML</span></span>    .: <br> <code class="html">&lt;!<span class="hljs-type"><span class="hljs-type">DOCTYPE</span></span> html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-comment"><span class="hljs-comment">"utf-8"</span></span>&gt; &lt;title&gt;<span class="hljs-type"><span class="hljs-type">Map</span></span> grabber&lt;/title&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU"</span></span> type=<span class="hljs-comment"><span class="hljs-comment">"text/javascript"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"</span></span>&gt;&lt;/script&gt; &lt;style&gt; html, body, .<span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { margin: <span class="hljs-number"><span class="hljs-number">0</span></span>; padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { width: <span class="hljs-number"><span class="hljs-number">100</span></span>%; height: <span class="hljs-number"><span class="hljs-number">800</span></span>px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id=<span class="hljs-comment"><span class="hljs-comment">"map"</span></span>&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach (<span class="hljs-string"><span class="hljs-string">$a</span></span>ll as <span class="hljs-string"><span class="hljs-string">$o</span></span>ffer) {?&gt; coords.push(<span class="hljs-string"><span class="hljs-string">'-, &lt;?=$offer['</span></span>address<span class="hljs-string"><span class="hljs-string">']?&gt;'</span></span>) info.push(&lt;?=json_encode(<span class="hljs-string"><span class="hljs-string">$o</span></span>ffer, <span class="hljs-type"><span class="hljs-type">JSON_UNESCAPED_UNICODE</span></span>)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code><span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span></code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> <span class="hljs-type"><span class="hljs-type">API</span></span> </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.<span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">'map'</span></span>, { center: [<span class="hljs-number"><span class="hljs-number">59.932666</span></span>, <span class="hljs-number"><span class="hljs-number">30.329596</span></span>], zoom: <span class="hljs-number"><span class="hljs-number">13</span></span>, behaviors: [<span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'scrollZoom'</span></span>], }) //     : map.controls .add(<span class="hljs-string"><span class="hljs-string">'zoomControl'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">5</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) .add(<span class="hljs-string"><span class="hljs-string">'mapTools'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">35</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) //        . (new <span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span>({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = <span class="hljs-string"><span class="hljs-string">'&lt;p&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;b&gt;'</span></span>).append( <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;a&gt;'</span></span>) .attr({href: cells.url, target: <span class="hljs-string"><span class="hljs-string">'_blank'</span></span>}) .text(cells.address) )[<span class="hljs-number"><span class="hljs-number">0</span></span>].outerHTML + <span class="hljs-string"><span class="hljs-string">'&lt;/p&gt;'</span></span> //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set(<span class="hljs-string"><span class="hljs-string">'balloonContentBody'</span></span>, text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  <span class="hljs-type"><span class="hljs-type">API</span></span></a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker=<span class="hljs-comment"><span class="hljs-comment">"twirl#redDotIcon"</span></span>&gt;. // twirl<span class="hljs-symbol"><span class="hljs-symbol">#redDotIcon</span></span> -   (preset)    . <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'p[data-marker] input'</span></span>).val(function (i, value) { var marker = <span class="hljs-string"><span class="hljs-string">$(</span></span>this).parent().attr(<span class="hljs-string"><span class="hljs-string">'data-marker'</span></span>) value = <span class="hljs-string"><span class="hljs-string">$.</span></span>trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: <span class="hljs-number"><span class="hljs-number">123</span></span>, rooms: <span class="hljs-number"><span class="hljs-number">2</span></span>, ...}. <span class="hljs-string"><span class="hljs-string">$.</span></span>each(info, function (i, cells) { var colored = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new <span class="hljs-type"><span class="hljs-type">Function</span></span>(<span class="hljs-string"><span class="hljs-string">'cells'</span></span>, <span class="hljs-string"><span class="hljs-string">'return '</span></span> + item[<span class="hljs-number"><span class="hljs-number">1</span></span>]); //      -   ,  . if (func(cells)) { cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, item[<span class="hljs-number"><span class="hljs-number">0</span></span>]) //    . colored = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } } //      -     . colored || cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, <span class="hljs-string"><span class="hljs-string">'twirl#blueIcon'</span></span>) })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b><span class="hljs-type"><span class="hljs-type">UPD</span></span>:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    <span class="hljs-type"><span class="hljs-type">Gist</span></span></a> .    ,        :)</code> </pre> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> <h4> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> </h4> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> <pre> <code class="hljs smalltalk"><code>),    -   ,   ,    <span class="hljs-type"><span class="hljs-type">DOMNode</span></span></code> . <br> <br>     : <br> <code class="php">//  . <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array(); <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL = <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'</span></span>; // ,       . <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty = iconv(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'   0'</span></span>); //        . foreach ((array) <span class="hljs-string"><span class="hljs-string">$_</span></span>REQUEST[<span class="hljs-string"><span class="hljs-string">'region'</span></span>] as <span class="hljs-string"><span class="hljs-string">$r</span></span>egion) { <span class="hljs-string"><span class="hljs-string">$u</span></span>rl = <span class="hljs-string"><span class="hljs-string">$b</span></span>aseURL.<span class="hljs-comment"><span class="hljs-comment">"region$region=$region&amp;"</span></span>; //  ... //   ,      <span class="hljs-number"><span class="hljs-number">300</span></span> -    //      ,     <span class="hljs-number"><span class="hljs-number">300.</span></span> foreach (range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>) as <span class="hljs-string"><span class="hljs-string">$p</span></span>rice0) { <span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL = <span class="hljs-string"><span class="hljs-string">$u</span></span>rl.<span class="hljs-comment"><span class="hljs-comment">"price1=$price0&amp;price2="</span></span>.(<span class="hljs-string"><span class="hljs-string">$p</span></span>rice0 + <span class="hljs-number"><span class="hljs-number">999</span></span>); //   - .   . <span class="hljs-string"><span class="hljs-string">$d</span></span>ata = dl(<span class="hljs-string"><span class="hljs-string">$r</span></span>eqURL); if (!strpos(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata, <span class="hljs-string"><span class="hljs-string">$e</span></span>mpty)) { //  . <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers = parse(<span class="hljs-string"><span class="hljs-string">$d</span></span>ata); <span class="hljs-string"><span class="hljs-string">$a</span></span>ll = array_merge(<span class="hljs-string"><span class="hljs-string">$a</span></span>ll, <span class="hljs-string"><span class="hljs-string">$o</span></span>ffers); } //    . usleep(<span class="hljs-number"><span class="hljs-number">200000</span></span>); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   <span class="hljs-type"><span class="hljs-type">HTML</span></span>   . <br> <code class="php">function parse(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) { //  <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>,      <span class="hljs-type"><span class="hljs-type">UTF</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> ( , //    ). <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">'&lt;?xml encoding="UTF-8"&gt;'</span></span>.iconv(<span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml); <span class="hljs-string"><span class="hljs-string">$d</span></span>oc = new <span class="hljs-type"><span class="hljs-type">DOMDocument</span></span>(<span class="hljs-string"><span class="hljs-string">'1.0'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>); @<span class="hljs-string"><span class="hljs-string">$d</span></span>oc-&gt;loadHTML(<span class="hljs-string"><span class="hljs-string">$h</span></span>tml) or die(<span class="hljs-string"><span class="hljs-string">'loadHTML: '</span></span>.<span class="hljs-string"><span class="hljs-string">$h</span></span>tml); //      . <span class="hljs-string"><span class="hljs-string">$x</span></span>path = new <span class="hljs-type"><span class="hljs-type">DOMXPath</span></span>(<span class="hljs-string"><span class="hljs-string">$d</span></span>oc); //    ,       -  //  ()    ,   . <span class="hljs-string"><span class="hljs-string">$n</span></span>odes = <span class="hljs-string"><span class="hljs-string">$x</span></span>path-&gt;query(<span class="hljs-string"><span class="hljs-string">'//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'</span></span>); //    . <span class="hljs-string"><span class="hljs-string">$r</span></span>esults = array(); //        (,    ) -  //  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; // <span class="hljs-string"><span class="hljs-string">$n</span></span>odes -  - (tr). foreach (<span class="hljs-string"><span class="hljs-string">$n</span></span>odes as <span class="hljs-string"><span class="hljs-string">$r</span></span>ow) { //     - ,   .. <span class="hljs-string"><span class="hljs-string">$c</span></span>ells = array(); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;firstChild; while (<span class="hljs-string"><span class="hljs-string">$c</span></span>ell) { <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeType == <span class="hljs-type"><span class="hljs-type">XML_ELEMENT_NODE</span></span> and <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[] = trim(<span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nodeValue); <span class="hljs-string"><span class="hljs-string">$c</span></span>ell = <span class="hljs-string"><span class="hljs-string">$c</span></span>ell-&gt;nextSibling; } if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { //      -       // .  . <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount = (int) reset(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } else { <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">$r</span></span>oomCount; //    colspan     -   //   . if (count(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells) == <span class="hljs-number"><span class="hljs-number">10</span></span>) { array_splice(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, array(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells[<span class="hljs-number"><span class="hljs-number">6</span></span>], <span class="hljs-string"><span class="hljs-string">''</span></span>)); } //   ,       . <span class="hljs-string"><span class="hljs-string">$h</span></span>tml = <span class="hljs-string"><span class="hljs-string">$r</span></span>ow-&gt;ownerDocument-&gt;saveXML(<span class="hljs-string"><span class="hljs-string">$r</span></span>ow); if (preg_match(<span class="hljs-string"><span class="hljs-string">'~&lt;a href="([^"]+)~u'</span></span>, <span class="hljs-string"><span class="hljs-string">$h</span></span>tml, <span class="hljs-string"><span class="hljs-string">$m</span></span>atch)) { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru'</span></span>.<span class="hljs-string"><span class="hljs-string">$m</span></span>atch[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } else { array_unshift(<span class="hljs-string"><span class="hljs-string">$c</span></span>ells, <span class="hljs-string"><span class="hljs-string">''</span></span>); } // ,     . <span class="hljs-string"><span class="hljs-string">$k</span></span>eys = array(<span class="hljs-string"><span class="hljs-string">'url'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span>); <span class="hljs-string"><span class="hljs-string">$r</span></span>esult[] = array_combine(<span class="hljs-string"><span class="hljs-string">$k</span></span>eys, <span class="hljs-string"><span class="hljs-string">$c</span></span>ells); } } return <span class="hljs-string"><span class="hljs-string">$r</span></span>esult; }</code> <br> <br>  <br> ,    -  <code><span class="hljs-string"><span class="hljs-string">$a</span></span>ll</code>        .    -    .      : <br> <code class="php">array( <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://www.bn.ru/detail/flats/xxxxxx.html?from=search'</span></span>, <span class="hljs-string"><span class="hljs-string">'rooms'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'7  ., xxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'floors'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1\\5'</span></span>, <span class="hljs-string"><span class="hljs-string">'houseType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'area'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'30'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaLiving'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'18.3'</span></span>, <span class="hljs-string"><span class="hljs-string">'areaKitchen'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'6'</span></span>, <span class="hljs-string"><span class="hljs-string">'toilet'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3100'</span></span>, <span class="hljs-string"><span class="hljs-string">'conditions'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'seller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'xxxxx '</span></span>, <span class="hljs-string"><span class="hljs-string">'phone'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'(965) xxxxxxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'notes'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'   '</span></span>, )</code> <br> <br>  <span class="hljs-type"><span class="hljs-type">HTML</span></span>    .: <br> <code class="html">&lt;!<span class="hljs-type"><span class="hljs-type">DOCTYPE</span></span> html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-comment"><span class="hljs-comment">"utf-8"</span></span>&gt; &lt;title&gt;<span class="hljs-type"><span class="hljs-type">Map</span></span> grabber&lt;/title&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU"</span></span> type=<span class="hljs-comment"><span class="hljs-comment">"text/javascript"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-comment"><span class="hljs-comment">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"</span></span>&gt;&lt;/script&gt; &lt;style&gt; html, body, .<span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { margin: <span class="hljs-number"><span class="hljs-number">0</span></span>; padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-symbol"><span class="hljs-symbol">#map</span></span> { width: <span class="hljs-number"><span class="hljs-number">100</span></span>%; height: <span class="hljs-number"><span class="hljs-number">800</span></span>px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id=<span class="hljs-comment"><span class="hljs-comment">"map"</span></span>&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach (<span class="hljs-string"><span class="hljs-string">$a</span></span>ll as <span class="hljs-string"><span class="hljs-string">$o</span></span>ffer) {?&gt; coords.push(<span class="hljs-string"><span class="hljs-string">'-, &lt;?=$offer['</span></span>address<span class="hljs-string"><span class="hljs-string">']?&gt;'</span></span>) info.push(&lt;?=json_encode(<span class="hljs-string"><span class="hljs-string">$o</span></span>ffer, <span class="hljs-type"><span class="hljs-type">JSON_UNESCAPED_UNICODE</span></span>)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code><span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span></code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> <span class="hljs-type"><span class="hljs-type">API</span></span> </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.<span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">'map'</span></span>, { center: [<span class="hljs-number"><span class="hljs-number">59.932666</span></span>, <span class="hljs-number"><span class="hljs-number">30.329596</span></span>], zoom: <span class="hljs-number"><span class="hljs-number">13</span></span>, behaviors: [<span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'scrollZoom'</span></span>], }) //     : map.controls .add(<span class="hljs-string"><span class="hljs-string">'zoomControl'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">5</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) .add(<span class="hljs-string"><span class="hljs-string">'mapTools'</span></span>, {left: <span class="hljs-number"><span class="hljs-number">35</span></span>, top: <span class="hljs-number"><span class="hljs-number">5</span></span>}) //        . (new <span class="hljs-type"><span class="hljs-type">MultiGeocoder</span></span>({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = <span class="hljs-string"><span class="hljs-string">'&lt;p&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;b&gt;'</span></span>).append( <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'&lt;a&gt;'</span></span>) .attr({href: cells.url, target: <span class="hljs-string"><span class="hljs-string">'_blank'</span></span>}) .text(cells.address) )[<span class="hljs-number"><span class="hljs-number">0</span></span>].outerHTML + <span class="hljs-string"><span class="hljs-string">'&lt;/p&gt;'</span></span> //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set(<span class="hljs-string"><span class="hljs-string">'balloonContentBody'</span></span>, text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              <span class="hljs-type"><span class="hljs-type">JavaScript</span></span>   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  <span class="hljs-type"><span class="hljs-type">API</span></span></a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker=<span class="hljs-comment"><span class="hljs-comment">"twirl#redDotIcon"</span></span>&gt;. // twirl<span class="hljs-symbol"><span class="hljs-symbol">#redDotIcon</span></span> -   (preset)    . <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">'p[data-marker] input'</span></span>).val(function (i, value) { var marker = <span class="hljs-string"><span class="hljs-string">$(</span></span>this).parent().attr(<span class="hljs-string"><span class="hljs-string">'data-marker'</span></span>) value = <span class="hljs-string"><span class="hljs-string">$.</span></span>trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: <span class="hljs-number"><span class="hljs-number">123</span></span>, rooms: <span class="hljs-number"><span class="hljs-number">2</span></span>, ...}. <span class="hljs-string"><span class="hljs-string">$.</span></span>each(info, function (i, cells) { var colored = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> for (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new <span class="hljs-type"><span class="hljs-type">Function</span></span>(<span class="hljs-string"><span class="hljs-string">'cells'</span></span>, <span class="hljs-string"><span class="hljs-string">'return '</span></span> + item[<span class="hljs-number"><span class="hljs-number">1</span></span>]); //      -   ,  . if (func(cells)) { cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, item[<span class="hljs-number"><span class="hljs-number">0</span></span>]) //    . colored = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } } //      -     . colored || cells.geo.options.set(<span class="hljs-string"><span class="hljs-string">'preset'</span></span>, <span class="hljs-string"><span class="hljs-string">'twirl#blueIcon'</span></span>) })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b><span class="hljs-type"><span class="hljs-type">UPD</span></span>:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    <span class="hljs-type"><span class="hljs-type">Gist</span></span></a> .    ,        :)</code> </pre> <code><code>),    -   ,   ,    DOMNode</code> . <br> <br>     : <br> <code class="php">//  . $all = array(); $baseURL = 'http://www.bn.ru/zap_fl.phtml?print=printall&amp;'; // ,       . $empty = iconv('utf-8', 'cp1251', '   0'); //        . foreach ((array) $_REQUEST['region'] as $region) { $url = $baseURL."region$region=$region&amp;"; //  ... //   ,      300 -    //      ,     300. foreach (range(0, 10000, 1000) as $price0) { $reqURL = $url."price1=$price0&amp;price2=".($price0 + 999); //   - .   . $data = dl($reqURL); if (!strpos($data, $empty)) { //  . $offers = parse($data); $all = array_merge($all, $offers); } //    . usleep(200000); } }</code> <br> <br>  <b>dl()</b>      cURL   <code>file_get_contents()</code> - ,             ,  . <br> <br>  <b>parse()</b>   HTML   . <br> <code class="php">function parse($html) { //  DOMDocument,      UTF-8 ( , //    ). $html = '&lt;?xml encoding="UTF-8"&gt;'.iconv('cp1251', 'utf-8', $html); $doc = new DOMDocument('1.0', 'utf-8'); @$doc-&gt;loadHTML($html) or die('loadHTML: '.$html); //      . $xpath = new DOMXPath($doc); //    ,       -  //  ()    ,   . $nodes = $xpath-&gt;query('//table[@class="results"]/tr[th[@class="head_kvart"] or td[@width or @class="tooltip"]]'); //    . $results = array(); //        (,    ) -  //  . $roomCount = 1; // $nodes -  - (tr). foreach ($nodes as $row) { //     - ,   .. $cells = array(); $cell = $row-&gt;firstChild; while ($cell) { $cell-&gt;nodeType == XML_ELEMENT_NODE and $cells[] = trim($cell-&gt;nodeValue); $cell = $cell-&gt;nextSibling; } if (count($cells) == 1) { //      -       // .  . $roomCount = (int) reset($cells); } else { $cells[0] = $roomCount; //    colspan     -   //   . if (count($cells) == 10) { array_splice($cells, 6, 1, array(0, '', $cells[6], '')); } //   ,       . $html = $row-&gt;ownerDocument-&gt;saveXML($row); if (preg_match('~&lt;a href="([^"]+)~u', $html, $match)) { array_unshift($cells, 'http://www.bn.ru'.$match[1]); } else { array_unshift($cells, ''); } // ,     . $keys = array('url', 'rooms', 'address', 'floors', 'houseType', 'area', 'areaLiving', 'areaKitchen', 'toilet', 'price', 'conditions', 'seller', 'phone', 'notes'); $result[] = array_combine($keys, $cells); } } return $result; }</code> <br> <br>  <br> ,    -  <code>$all</code>        .    -    .      : <br> <code class="php">array( 'url' =&gt; 'http://www.bn.ru/detail/flats/xxxxxx.html?from=search', 'rooms' =&gt; 1, 'address' =&gt; '7  ., xxx', 'floors' =&gt; '1\\5', 'houseType' =&gt; '', 'area' =&gt; '30', 'areaLiving' =&gt; '18.3', 'areaKitchen' =&gt; '6', 'toilet' =&gt; ' ', 'price' =&gt; '3100', 'conditions' =&gt; ' ', 'seller' =&gt; 'xxxxx ', 'phone' =&gt; '(965) xxxxxxx', 'notes' =&gt; '   ', )</code> <br> <br>  HTML    .: <br> <code class="html">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;Map grabber&lt;/title&gt; &lt;script src="//api-maps.yandex.ru/2.0/?load=package.standard&amp;lang=ru-RU" type="text/javascript"&gt;&lt;/script&gt; &lt;script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"&gt;&lt;/script&gt; &lt;style&gt; html, body, .#map { margin: 0; padding: 0; } #map { width: 100%; height: 800px; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="map"&gt;&lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</code> <br> <br> <b>jQuery</b>     ,     <a href="https://habr.com/ru/post/184334/"> </a> . <br> <br> ,       .       JavaScript        : <br> <code class="php">//     . var coords = [] //     . var info = [] &lt;?foreach ($all as $offer) {?&gt; coords.push('-, &lt;?=$offer['address']?&gt;') info.push(&lt;?=json_encode($offer, JSON_UNESCAPED_UNICODE)?&gt;) &lt;?}?&gt; ymaps.ready(init);</code> <br> <br>    - <b> </b>   <code>init()</code> .    <b></b>   <code>MultiGeocoder</code>  <a href="http://api.yandex.ru/maps/jsbox/multigeocode"> API </a> ;      ( <b>coords</b> ),       (  ),       . <br> <br> <code class="javascript">function init() { //       -: var map = new ymaps.Map('map', { center: [59.932666, 30.329596], zoom: 13, behaviors: ['default', 'scrollZoom'], }) //     : map.controls .add('zoomControl', {left: 5, top: 5}) .add('mapTools', {left: 35, top: 5}) //        . (new MultiGeocoder({boundedBy: map.getBounds()})) .geocode(coords) .then( function (res) { //        . for (var i = 0; i &lt; res.geoObjects.getLength(); i++) { var cells = info[i] //         -    //  ,     . var text = '&lt;p&gt;' + $('&lt;b&gt;').append( $('&lt;a&gt;') .attr({href: cells.url, target: '_blank'}) .text(cells.address) )[0].outerHTML + '&lt;/p&gt;' //  -   ,   . var geo = res.geoObjects.get(i) //       . info[i].geo = geo //       . geo.properties.set('balloonContentBody', text) } //      . map.geoObjects.add(res.geoObjects) }, function (err) { alert(err) } ) return map }</code> <br> <br>   .                    .     ,        . <br> <br> <a name="color"></a> <br>   ?.. <br>    ,    ,         .  ! , ,   ,       . <br> <br>              JavaScript   ,     .     ,          .    , ,   ,  -  ,   ,   -   ,     . <br> <br>      -  .      (  <a href="">  API</a> ): <br> <code class="javascript">//       [ [_, _], ... ]. var markers = [] //      &lt;p data-marker="twirl#redDotIcon"&gt;. // twirl#redDotIcon -   (preset)    . $('p[data-marker] input').val(function (i, value) { var marker = $(this).parent().attr('data-marker') value = $.trim(value) value &amp;&amp; markers.push([marker, value]) return value }) //    (. init()). cells - {price: 123, rooms: 2, ...}. $.each(info, function (i, cells) { var colored = false for (var i = 0; i &lt; markers.length &amp;&amp; !colored; i++) { var item = markers[i] var func = new Function('cells', 'return ' + item[1]); //      -   ,  . if (func(cells)) { cells.geo.options.set('preset', item[0]) //    . colored = true } } //      -     . colored || cells.geo.options.set('preset', 'twirl#blueIcon') })</code> <br> <br>              ,    , -,  ! <br> <br> ,    .        ,   . <br> <br> <b>UPD:</b>     <a href="https://gist.github.com/ProgerXP/6011495">    Gist</a> .    ,        :)</code> </div><p>Source: <a href="https://habr.com/ru/post/184334/">https://habr.com/ru/post/184334/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184324/index.html">Half-Life 3 to be!</a></li>
<li><a href="../184326/index.html">Edward Snowden flew from Hong Kong to Moscow</a></li>
<li><a href="../184328/index.html">Gamification in the field of remuneration</a></li>
<li><a href="../184330/index.html">Babuino: 25-dollar USB-device for connecting a smartphone as a keyboard / mouse / camera</a></li>
<li><a href="../184332/index.html">Resume programmers. Part 1 (bad)</a></li>
<li><a href="../184336/index.html">1C 7.7: Organization of auto-exchange via FTP</a></li>
<li><a href="../184338/index.html">Writing asynchronous module for node.js using C ++</a></li>
<li><a href="../184342/index.html">A new look at the vote, or popular about the Condorcet Paradox</a></li>
<li><a href="../184344/index.html">CoffeeScript in the examples. Validation</a></li>
<li><a href="../184346/index.html">Lady checked in baggage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>