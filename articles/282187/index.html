<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VoIP Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Admit it, have you ever had a desire to listen to what friends, wives, husbands, etc. are talking about? without you? It would be cool to dial the pho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VoIP Part 1</h1><div class="post__text post__text-html js-mediator-article">  Admit it, have you ever had a desire to listen to what friends, wives, husbands, etc. are talking about?  without you?  It would be cool to dial the phone number, and that the connection itself was established and not wait for the user to answer the call.  I already actively use this functionality and this, I tell you, is dragging its feet.  Implementing it within the framework of one mobile application, I have been looking for ready-made solutions for a long time, but, of course, I did not find anything.  As a result, over 2 pm (6 hours), I managed to accomplish this task.  But first things first‚Ä¶ <br><br><a name="habracut"></a><br><br>  Let's form the task: Realization of the possibility of forced calls to customers of the VoIP-network.  Clients work on mobile phones IOS and Android. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Conditionally let's split the task into the north side and the client side.  In this part I will write about the server.  So, let's begin‚Ä¶ <br><br>  Before deploying my own server, I was looking for some free counterparts.  It was required to me that within the VoIP network the provider did not take money and provided the API for registering clients.  No, this is not, or one or the other.  Well, I'm not ready to pay, even $ 0.003 per minute, I would have everything at once and for free.  Only one way out, become the most VoIP provider. <br><br>  <b>We deploy a virtual machine</b> <br>  I suggest you first decide what the server is doing.  I did not record telephone conversations and therefore I decided to limit myself to a conventional virtual machine with a small hard disk, a mandatory static IP address, CPU: 400 MHz and RAM: 512 MB. <br>  Nakatil Debian on it and executed a number of standard commands <br><br>  <strong>apt-get update &amp;&amp; apt-get upgrade</strong> - <strong>upgrade</strong> versions of packages. <br><br>  <strong>apt-get install asterisk</strong> - install the latest version of telephony from the repository. <br><br>  <strong>apt-get install asterisk-mysql</strong> - the ability to store users in the database and synchronize with Asterisk <br><br>  <strong>apt-get install mysql-server5</strong> - install the MySQL database server. <br><br>  <strong>apt-get install mc</strong> - install midnight commander, for ease of editing configuration files. <br><br>  If at this stage there were any errors or something did not work out, then you can not read further, first read about installing packages in Debian. <br><br>  <b>Deploy and configure Asterisk</b> <br>  Asterisk from the package is fully functional; I personally did not need to build from source.  Before setting, let's define what we want from it. <br>  The ability to receive calls within our VoiP network. <br>  The subscriber can be anywhere, he does not need to be physically on the same subnet, between the server and the client, the Internet, with its gateways, NATs, and God knows what. <br>  Store users in a special database. <br>  My beautiful name (phone number) in my case ivan@bestmyfamily.com <br><br>  Determined the requirements, let's proceed to the configuration. <br>  Open the MC and go to the directory / etc / asterisk <br><br>  Find the file <strong>asterisk.conf</strong> , press f4 and add these lines to the end of the file <br><br>  [compat] <br>  pbx_realtime = 1.6 <br>  res_agi = 1.6 <br>  app_set = 1.6 <br><br>  This will allow us to synchronize with the database in real time.  Immediately answer the question, why did I put the storage of users in a separate database.  It's very simple, I'll add them to a simple PHP script from another server.  This is extremely necessary if your server, like mine, accepts 10 new users per minute.  I just physically can not bring them all to the configuration file. <br><br>  At the beginning of this file in the [options] section you can set two parameters: <br><br>  verbose = 64 <br>  debug = 64 <br><br>  now in the console, after running the <strong>asterisk -r</strong> command, we will see everything that happens with our server, so to speak, in real time. <br><br>  Now we set up call reception.  In our folder of Asterisk configuration files, we find the <strong>extensions.conf</strong> file and add to its end <br><br>  [myfamily] # Here you can write anything, <br>  # is the name of your call plan, <br>  # but it must match your context field in Sip.conf <br><br>  exten =&gt; _ [az]., 1, Dial (SIP / $ {EXTEN}, 60) <br>  exten =&gt; _ [AZ]., 2, Dial (SIP / $ {EXTEN}, 60) <br><br>  Let's take it through the example of a normal call. <br>  ivan@bestmyfamily.com calls his wife by calling Zaya@bestmyfamily.com <br><br>  The call goes to the server and the following happens: <br>  _ [az].  - here this Asterisk is looking for what to do with this phone number.  Here he will substitute our ‚ÄúZaya‚Äù.  And since Zaya is with a capital letter, it will go to the next line.  Which line to go to indicate you, after the comma, the sequence number.  Accordingly, all calls in my case are run through the first line from # 1 and, if such a number is not found, then we send it to # 2. <br>  In our case, Zaya comes up to the second line and we can do something with it, for example, turn on her waiting music, send it to some department or something else.  This can all be done by special teams.  The simplest of them - Dial.  It is simply trying to reach the user through the given channels in the allotted time. <br>  We specified the SIP channel and 60 seconds of waiting.  If we translate this line of SIP / $ {EXTEN}, 60 into Russian, we get the following: send a call to this phone SIP/Zaya@bestmyfamily.com and wait 60 seconds. <br><br><p>  It remains for us to configure the most important file for SIP telephony - sip.conf.  Here you need to be careful, I had to jump with a tambourine for a couple of hours to make it work.  And if everything works from the same subnet, this does not mean that you can normally receive or connect two subscribers in different networks for NAT.  I set up the work as follows: </p><br><br>  [general] <br>  allowguest = no <br>  allowoverlap = no <br>  context = myfamily;  default context for incoming calls <br>  bindport = 5060;  UDP port that is listening to asterisk <br>  bindaddr = 0.0.0.0 <br><br>  pedantic = no <br>  directmedia = no <br>  rtptimeout = 10 <br>  rtpholdtimeout = 300 <br><br>  ;  for realtime <br>  ;  they force asterisk to cache data <br>  ;  and the sip show peers command will display normally <br>  ;  all registered realtime users <br>  rtcachefriends = yes <br>  rtcache = yes <br><br>  ;  connection to the database; in general, it is not necessary to write them here from version 1.2 <br>  dbhost = 127.0.0.1 <br>  dbname = *** <br>  dbuser = *** <br>  dbpass = *** <br>  dbport = 3306 <br><br>  The rest of the settings we will already specify in the database for each user. <br><br>  We have the last <strong>res_config_mysql.c</strong> file, here we specify the settings for connecting to the database. <br><br>  [general] <br>  dbhost = 127.0.0.1 <br>  dbname = *** <br>  dbuser = *** <br>  dbpass = *** <br>  dbport = 3306 <br><br>  Now we are doing an Asterisk reboot with the /etc/init.d/asterisk restart command if there are no errors, then you can be happy, the server is configured and ready to handle calls. <br><br>  <b>MySQL setup</b> <br>  Our server is ready to receive calls, but there are no callers.  It is necessary to register and store new users somewhere.  For these purposes, we create a database with the following table: <br><br> <code>CREATE TABLE `sipusers` ( <br> `id` INT(11) NOT NULL AUTO_INCREMENT, <br> `accountcode` VARCHAR(20) NULL DEFAULT NULL, <br> `disallow` VARCHAR(100) NULL DEFAULT 'all', <br> `allow` VARCHAR(100) NULL DEFAULT 'g729;ilbc;gsm;ulaw;alaw', <br> `allowoverlap` ENUM('yes','no') NULL DEFAULT 'yes', <br> `allowsubscribe` ENUM('yes','no') NULL DEFAULT 'yes', <br> `allowtransfer` VARCHAR(3) NULL DEFAULT NULL, <br> `amaflags` VARCHAR(13) NULL DEFAULT NULL, <br> `autoframing` VARCHAR(3) NULL DEFAULT NULL, <br> `auth` VARCHAR(40) NULL DEFAULT NULL, <br> `buggymwi` ENUM('yes','no') NULL DEFAULT 'no', <br> `callgroup` VARCHAR(10) NULL DEFAULT NULL, <br> `callerid` VARCHAR(80) NULL DEFAULT NULL, <br> `cid_number` VARCHAR(40) NULL DEFAULT NULL, <br> `fullname` VARCHAR(40) NULL DEFAULT NULL, <br> `call-limit` INT(8) NULL DEFAULT '0', <br> `callingpres` VARCHAR(80) NULL DEFAULT NULL, <br> `canreinvite` CHAR(6) NULL DEFAULT 'yes', <br> `context` VARCHAR(80) NULL DEFAULT NULL, <br> `defaultip` VARCHAR(15) NULL DEFAULT NULL, <br> `dtmfmode` VARCHAR(7) NULL DEFAULT NULL, <br> `fromuser` VARCHAR(80) NULL DEFAULT NULL, <br> `fromdomain` VARCHAR(80) NULL DEFAULT NULL, <br> `fullcontact` VARCHAR(80) NULL DEFAULT NULL, <br> `g726nonstandard` ENUM('yes','no') NULL DEFAULT 'no', <br> `host` VARCHAR(31) NOT NULL DEFAULT 'dynamic', <br> `insecure` VARCHAR(20) NULL DEFAULT NULL, <br> `ipaddr` VARCHAR(15) NOT NULL DEFAULT '', <br> `language` CHAR(2) NULL DEFAULT NULL, <br> `lastms` VARCHAR(20) NULL DEFAULT NULL, <br> `mailbox` VARCHAR(50) NULL DEFAULT NULL, <br> `maxcallbitrate` INT(8) NULL DEFAULT '384', <br> `mohsuggest` VARCHAR(80) NULL DEFAULT NULL, <br> `md5secret` VARCHAR(80) NULL DEFAULT NULL, <br> `musiconhold` VARCHAR(100) NULL DEFAULT NULL, <br> `name` VARCHAR(80) NOT NULL DEFAULT '', <br> `nat` VARCHAR(30) NOT NULL DEFAULT 'no', <br> `outboundproxy` VARCHAR(80) NULL DEFAULT NULL, <br> `deny` VARCHAR(95) NULL DEFAULT NULL, <br> `permit` VARCHAR(95) NULL DEFAULT NULL, <br> `pickupgroup` VARCHAR(10) NULL DEFAULT NULL, <br> `port` VARCHAR(5) NOT NULL DEFAULT '', <br> `progressinband` ENUM('yes','no','never') NULL DEFAULT 'no', <br> `promiscredir` ENUM('yes','no') NULL DEFAULT 'no', <br> `qualify` CHAR(3) NULL DEFAULT NULL, <br> `regexten` VARCHAR(80) NOT NULL DEFAULT '', <br> `regseconds` INT(11) NOT NULL DEFAULT '0', <br> `rfc2833compensate` ENUM('yes','no') NULL DEFAULT 'no', <br> `rtptimeout` CHAR(3) NULL DEFAULT NULL, <br> `rtpholdtimeout` CHAR(3) NULL DEFAULT NULL, <br> `secret` VARCHAR(80) NULL DEFAULT NULL, <br> `sendrpid` ENUM('yes','no') NULL DEFAULT 'yes', <br> `setvar` VARCHAR(100) NOT NULL DEFAULT '', <br> `subscribecontext` VARCHAR(80) NULL DEFAULT NULL, <br> `subscribemwi` VARCHAR(3) NULL DEFAULT NULL, <br> `t38pt_udptl` ENUM('yes','no') NULL DEFAULT 'no', <br> `trustrpid` ENUM('yes','no') NULL DEFAULT 'no', <br> `type` VARCHAR(6) NOT NULL DEFAULT 'friend', <br> `useclientcode` ENUM('yes','no') NULL DEFAULT 'no', <br> `defaultuser` VARCHAR(80) NOT NULL DEFAULT '', <br> `usereqphone` VARCHAR(3) NOT NULL DEFAULT 'no', <br> `videosupport` ENUM('yes','no') NULL DEFAULT 'yes', <br> `vmexten` VARCHAR(80) NULL DEFAULT NULL, <br> `useragent` VARCHAR(80) NULL DEFAULT NULL, <br> `regserver` VARCHAR(80) NULL DEFAULT NULL, <br> `callbackextension` VARCHAR(80) NULL DEFAULT NULL, <br> PRIMARY KEY (`id`), <br> UNIQUE INDEX `name` (`name`), <br> INDEX `name_2` (`name`) <br> ) <br> COLLATE='cp1251_general_ci' <br> ENGINE=MyISAM <br> ROW_FORMAT=DYNAMIC <br> AUTO_INCREMENT=1; <br></code> <br>  And immediately add two of our users.  I add them through a special PHP script to work with the SIP database: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// //    SIP  // class M_SIP { private static $instance; //  . const host = "bestmyfamily.com"; const user = "***"; const password = "***"; const db = "***"; public $dbSIP; //    . // // . // public static function Instance() { if(self::$instance == null) self::$instance = new M_SIP(); return self::$instance; } // //  // function __construct() { //     $this-&gt;dbSIP = mysqli_connect(self::host, self::user, self::password) or exit; $result = mysqli_select_db($this-&gt;dbSIP, self::db) or exit; mysqli_query($this-&gt;dbSIP, 'SET NAMES utf8'); } //     public function RegUserOnServer($pid, $uid) { $arr = array( 'accountcode' =&gt; Null, 'disallow' =&gt; 'all', 'allow' =&gt; 'ulaw;alaw', 'allowoverlap' =&gt; 'no', 'allowsubscribe' =&gt; 'no', 'allowtransfer' =&gt; Null, 'amaflags' =&gt; Null, 'autoframing' =&gt; Null, 'auth' =&gt; Null, 'buggymwi' =&gt; 'no', 'callgroup' =&gt; Null, 'callerid' =&gt; Null, 'cid_number' =&gt; Null, 'fullname' =&gt; Null, 'call-limit' =&gt; 0, 'callingpres' =&gt; Null, 'canreinvite' =&gt; "no", 'context' =&gt; 'myfamily', 'defaultip' =&gt; Null, 'dtmfmode' =&gt; Null, 'fromuser' =&gt; Null, 'fromdomain' =&gt; Null, 'fullcontact' =&gt; Null, 'g726nonstandard' =&gt; 'no', 'host' =&gt; 'dynamic', 'insecure' =&gt; Null, 'ipaddr' =&gt; Null, 'language' =&gt; 'en', 'lastms' =&gt; 0, 'mailbox' =&gt; Null, 'maxcallbitrate' =&gt; 384, 'mohsuggest' =&gt; Null, 'md5secret' =&gt; Null, 'musiconhold' =&gt; Null, 'name' =&gt; "", 'nat' =&gt; 'force_rport,comedia', 'outboundproxy' =&gt; Null, 'deny' =&gt; Null, 'permit' =&gt; Null, 'pickupgroup' =&gt; Null, 'port' =&gt; '', 'progressinband' =&gt; 'no', 'promiscredir' =&gt; 'no', 'qualify' =&gt; Null, 'regexten' =&gt; 1000001, 'regseconds' =&gt; 0, 'rfc2833compensate' =&gt; 'no', 'rtptimeout' =&gt; Null, 'rtpholdtimeout' =&gt; Null, 'secret' =&gt; $uid, 'sendrpid' =&gt; 'yes', 'setvar' =&gt; '', 'subscribecontext' =&gt; Null, 'subscribemwi' =&gt; Null, 't38pt_udptl' =&gt; 'no', 'trustrpid' =&gt; 'no', 'type' =&gt; 'friend', 'useclientcode' =&gt; 'no', 'defaultuser' =&gt; "", 'usereqphone' =&gt; 'no', 'videosupport' =&gt; 'no', 'vmexten' =&gt; Null, 'useragent' =&gt; Null, 'regserver' =&gt; Null, 'callbackextension' =&gt; Null ); return $this-&gt;Insert('sipusers', $arr); } // //   // $table -   // $object -      "  - " //  -    // private function Insert($table, $object, $isReplace = false) { $columns = array(); $values = array(); foreach ($object as $key =&gt; $value) { $key = mysqli_real_escape_string($this-&gt;dbSIP, $key); $columns[] = "`" . $key . "`"; if ($value === null) { $values[] = 'NULL'; } else { $value = mysqli_real_escape_string($this-&gt;dbSIP, $value); $values[] = "'$value'"; } } $columns_s = implode(',', $columns); $values_s = implode(',', $values); //   ? if ($isReplace) $query = "REPLACE INTO $table ($columns_s) VALUES ($values_s)"; else $query = "INSERT IGNORE INTO $table ($columns_s) VALUES ($values_s)"; $result = mysqli_query($this-&gt;dbSIP, $query); if (!$result) die($this-&gt;SqlError(mysqli_error($this-&gt;dbSIP))); $id = mysqli_insert_id($this-&gt;dbSIP); return $id; } // //   SQL // function SqlError($error) { return json_encode(array( 'code' =&gt; 99, 'error' =&gt; $error ) ); } }</span></span></code> </pre><br><br>  The last step in the configuration is to buy our name and link it to the ip address.  I started the third level domain for these purposes voip.bestmyfamily.com and attached an ip address to it.  If you forget this step, your phone numbers will not be so beautiful ivan@192.168.1.1: 5060 <br><br>  For testing, you can install any SIP phones.  Of course, they are not so cool and will not, on the sly, pick up the phone to whom we are calling.  But you have set up the usual telephone connection.  In the second part, we will write our magic clients on Android and IOS. <br>  Immediately make a reservation that you may have problems with approval in the apple.  We sooo long passed the process of coordinating the application.  These are not standard 2 weeks, we studied the code and tested the functionality before placing the application.  As a result, agreed on the ability to run wiretapping only with the child mode. </div><p>Source: <a href="https://habr.com/ru/post/282187/">https://habr.com/ru/post/282187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282173/index.html">You Telegramma: SPARQL-injections and CSRF via Telegram-messages in the NeoQUEST-2016 task</a></li>
<li><a href="../282175/index.html">ITMO University Digest: # 1 Education and Science</a></li>
<li><a href="../282179/index.html">How I hacked Facebook and found someone else's backdoor</a></li>
<li><a href="../282181/index.html">Features of national management</a></li>
<li><a href="../282183/index.html">3D printer calibration</a></li>
<li><a href="../282189/index.html">Graphic VGA-controller on SoC without HDL knowledge</a></li>
<li><a href="../282191/index.html">Rendering UTF-8 text using an SDF font</a></li>
<li><a href="../282193/index.html">"Peeped" - the path from the idea for the VK Mobile Challenge to the real product</a></li>
<li><a href="../282195/index.html">On the way to creating your own online store engine</a></li>
<li><a href="../282197/index.html">The release of Ubuntu 16.04 LTS - Snap, OpenStack and other innovations. There may be problems with AMD video cards</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>