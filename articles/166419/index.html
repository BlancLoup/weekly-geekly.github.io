<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>No need to make promises or vice versa</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every programmer who starts developing under Node.js faces the choice of a strategy for organizing asynchronous code in a project. While in small syst...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>No need to make promises or vice versa</h1><div class="post__text post__text-html js-mediator-article">  Every programmer who starts developing under Node.js faces the choice of a strategy for organizing asynchronous code in a project.  While in small system utilities, it is quite simple to maintain the hygiene of an asynchronous code, with the increase in the mass of the code in a project, the solution of this problem begins to require the introduction of an additional, so-called <i>control flow</i> . <br><br>  This article will discuss the small control flow library <b><a href="https://github.com/geeqie/node-flowy">‚ÄúFlowy‚Äù</a></b> , which is the development of <a href="https://github.com/creationix/step">Step Step</a> Caswell's ideas of the project, and the core of which is based on <a href="http://wiki.commonjs.org/wiki/Promises">CommonJS Promises</a> concepts, and also gives arguments why Promises is so inconvenient. <br><br><img src="https://habrastorage.org/storage2/594/f52/486/594f52486160b415cb892c1062b46042.jpg"><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What it looks like </h4><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leaveMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">username, text, callback</span></span></span><span class="hljs-function">) </span></span>{ Flowy( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// concurrent execution of two queries model.users.findOne(username, this.slot()); model.settings.findOne(username, this.slot()); }, function(err, user, settings) { // error propagating if (!user) throw new Error('user not found'); if (!settings.canReceiveMessages) throw new Error('violating privacy settings'); model.messages.create(user, text, this.slot()); }, function(err, message) { model.notifications.create(message, this.slot()); }, callback //any error will be automatically propagated to this point ); }</span></span></code> </pre> <br><ul><li>  Each step passed to the <code>Flowy</code> wrapper <code>Flowy</code> executed in the context of the library ( <code>this</code> variable).  At the same time, the context provides the ability to transfer data to the next step by generating callbacks that can be passed to the classical nodejs-like functions as the last argument (call <code>this.slot()</code> ). </li><li>  Everything that is performed in one step is performed in parallel. </li><li>  The control will be transferred to the next step only after all its ‚Äúslots‚Äù are filled with data - all callbacks generated by the call to <code>this.slot()</code> completed successfully, or the first one will receive an error message. </li><li>  If an error occurs in any of the steps, the execution of the entire chain will be interrupted and the error will be returned to the last step. </li></ul><br><br><h4>  Why does it look that way? </h4><br>  A beginner acquaintance with the API of the non-blocking I / O Node.js system is offered the following asynchronous call interface: <br><br><pre> <code class="javascript hljs">fs.readFile(<span class="hljs-string"><span class="hljs-string">'/etc/passwd'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(data); });</code> </pre><br>  When using someone else‚Äôs modules, it‚Äôs natural to want to have an interface similar to that described above ‚Äî the <a href="http://en.wikipedia.org/wiki/Principle_of_least_astonishment">rule of least surprise</a> is one of the keys to supporting and easily debugging code.  From here comes the first requirement for the library: <br><br>  <b>We want to keep the ‚Äúnative‚Äù nodejs-like interfaces of functions and callbacks.</b>  Each step of <code>Flowy</code> has a nodejs callback interface, which makes it easy to wrap the entire chain of steps into a traditional nodejs function. <br><br>  In this case, the main idea of ‚Äã‚ÄãPromises (as an example of the implementation will be used in the future library <a href="https://github.com/kriskowal">"Q" by</a> Chris Cowell) is to replace the callback transfer with the last argument to the asynchronous call by creating a chain of calls to the Promise methods: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// chaining promises: Q.fcall(step1).then(step2).then(step3).done() return getUsername() .then(function (username) { return getUser(username) .then(function (user) { // if we get here without an error, the value returned here // or the exception thrown here resolves the promise returned by the first line }) })</span></span></code> </pre><br>  The first thing that catches your eye: functions <i>return Promise</i> .  Thus, to use the library, it is necessary to wrap all the ‚Äúclassic‚Äù functions in the Promise adapter (this process is described in more detail on the project's page), or else to <i>develop code with interfaces that are strictly library-oriented</i> (however, all public interfaces of the module will need to be returned classic view, given the requirement formulated above).  It is not comfortable.  It sounds scary and no less scary.  At the same time, the second requirement for the control flow library immediately comes to mind: <br><br>  <b>The library should be only a ‚Äúglue‚Äù between the existing parts of the system and not become a heavy dependency.</b>  All the features of ‚ÄúFlowy‚Äù functioning are hidden inside the steps - that same glue - which allows functions using it to remain ‚Äúclean‚Äù for the outside world.  Soar should remain in the hut. <br><br>  When working with libraries that allow you to create chains (chaining) of asynchronous calls, it is often necessary to perform part of the calls <i>in parallel</i> .  The Q library provides the following <s>awkward</s> solution: <br><br><pre> <code class="javascript hljs">Q.allResolved(promises) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promises</span></span></span><span class="hljs-function">) </span></span>{ promises.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promise</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (promise.isFulfilled()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value = promise.valueOf(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exception = promise.valueOf().exception; } }) })</code> </pre><br>  In addition to everything, if we suddenly want to break the rule ‚Äúone argument - one return value‚Äù, then we will have to do additional exercises: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getUsername() .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">username</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [username, getUser(username)]; }) .spread(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">username, user</span></span></span><span class="hljs-function">) </span></span>{ })</code> </pre><br>  Reading this code, one more requirement to the library suggests itself: <br><br>  <b>We want to easily execute several parallel queries and pass any number of arguments to callbacks.</b>  ‚ÄúFlowy‚Äù is able without any additional effort on the part of the developer due to its architecture. <br><br>  So, ‚ÄúFlowy‚Äù is a lightweight library for managing the asynchronous flow of program execution, which makes it easy to solve everyday issues of developers under Node.js and has proven itself in the production environment. <br><br>  This article demonstrates only the basic features of ‚ÄúFlowy‚Äù.  For more information, I invite everyone to visit the project page on the githaba, where you will find abundant documentation with many examples. <br><br>  Useful sources: <br><ul><li>  <b>Flowy</b> : <a href="https://github.com/geeqie/node-flowy">https://github.com/geeqie/node-flowy</a> </li><li>  <b>CommonJS</b> : <a href="http://www.commonjs.org/">http://www.commonjs.org</a> </li><li>  <b>Q</b> : <a href="https://github.com/kriskowal/q">https://github.com/kriskowal/q</a> </li><li>  <b>Review article about similar libraries</b> : <a href="http://habrahabr.ru/post/111634">http://habrahabr.ru/post/111634</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/166419/">https://habr.com/ru/post/166419/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../166405/index.html">Return to preinstalled Windows 8</a></li>
<li><a href="../166409/index.html">#MongoUA - The first meeting of the MongoDB developer community in Ukraine (Kiev January 23)</a></li>
<li><a href="../166411/index.html">We reveal the magic of MySQL or the severity and softness of MySQL</a></li>
<li><a href="../166413/index.html">Trends frontend. Javascript APIs for mobile devices</a></li>
<li><a href="../166417/index.html">Getting a list of Internet connections of the router DIR-615 in a readable form</a></li>
<li><a href="../166421/index.html">We understand the development of Windows 8 applications on XAML / –° #, implementing a simple RSS Reader. Part 3</a></li>
<li><a href="../166425/index.html">Opera Ice: New browser for mobile platforms on WebKit</a></li>
<li><a href="../166427/index.html">Triac power controller with microcontroller control</a></li>
<li><a href="../166429/index.html">Competition for students and supervisors: "Microsoft UniApps Challenge"</a></li>
<li><a href="../166433/index.html">Creating a pivot table of attendance of several sites using Yandex.Metrics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>