<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to check if the pointer value is in the specified memory area</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suppose we have a region / memory area defined by two variables, for example: 



byte* regionStart; size_t regionSize;  
 It is required to check whe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to check if the pointer value is in the specified memory area</h1><div class="post__text post__text-html js-mediator-article">  Suppose we have a region / memory area defined by two variables, for example: <br><br><pre><code class="cpp hljs">byte* regionStart; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> regionSize;</code> </pre> <br>  It is required to check whether the pointer value is within this range.  Perhaps your first impulse would be to write this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p &gt;= regionStart &amp;&amp; p &lt; regionStart + regionSize)</code> </pre> <br>  But does the standard guarantee the expected behavior of this code? <br><a name="habracut"></a><br>  The relevant clause of the C standard (6.5.8 Relational Operators) (1) reads as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>If two pointers to an object or an incomplete type refer to the same object or to the position immediately after the last element of the same array, these pointers are equal.</i>  <i>If the referenced objects are members of the same compound object, then pointers to the members of the structure declared later are more pointers to the members declared earlier, and pointers to array elements with large indices are greater than pointers to elements of the same array with smaller indices.</i>  <i>All pointers to members of the same union are equal.</i>  <i>If the expression P points to an element of the array, and the expression Q points to the last element of the same array, then the value of the pointer-expression Q + 1 is greater than the value of the expression P. In all other cases, the behavior is undefined.</i> <br><br>  Now recall that the C language was designed to work with a wide range of architectures, many of which have already become museum exhibits.  For this reason, it is extremely conservative with regard to the choice of acceptable actions, since it is necessary to leave the possibility to write C programs for obsolete systems.  (Although at one time they were quite advanced.) <br><br>  However, when allocating memory, the appearance of such a pointer is possible that will satisfy our condition, although in reality it will not refer to a given area.  This will happen, for example, when running on an 80286 processor in protected mode, which was used by Windows 3.x operating systems in standard mode and OS / 2 1.x. <br><br>  The pointer in such a system is a 32-bit value consisting of two parts of 16 bits each ‚Äî it is customary to write it as <i>XXXX: YYYY</i> .  The first 16-bit half ( <i>XXXX</i> ) is the ‚Äúselector‚Äù, which serves to select a 64- <a href="https://blogs.msdn.microsoft.com/oldnewthing/20090611-00/%3Fp%3D17933">KB</a> memory segment.  The second 16-bit half ( <i>YYYY</i> ) is the ‚Äúoffset‚Äù by which a byte is selected within the segment specified by the first half.  (In fact, this mechanism is more complicated, but in the framework of this discussion we will manage with such an explanation.) <br><br>  Memory blocks larger than 64 KB are divided into 64 KB segments.  To move to the next segment, you must add 8 to the selector of the current segment.  For example, the byte following <i>0101: FFFF</i> is written as <i>0109: 0000</i> . <br><br>  But why add exactly 8?  Why not just increase the selector by one?  The fact is that the lower three bits of the selector are used for other purposes.  In particular, the lowest selector bit is used to select the selector table.  We will not touch bits 1 and 2 here, since they are not related to our question.  For convenience, just imagine that they are always set to zero. (2) <br><br>  The correspondence of selectors to physical memory addresses is described by two tables: <i>Global Descriptor Table</i> ( <i>Global Descriptor Table</i> ; identifies memory segments common to all processes) and <i>Local Descriptor Table</i> ( <i>Local Descriptor Table</i> ; identifies memory segments allocated for personal use of a particular process).  Thus, the selectors for the local memory of the process are <i>0001</i> , <i>0009</i> , <i>0011</i> , <i>0019</i> , etc., and the selectors for the global memory are <i>0008</i> , <i>0010</i> , <i>0018</i> , <i>0020</i> , etc.  (The selector <i>0000</i> is reserved.) <br><br>  Well, now we can build a counterexample.  Let <i>regionStart = 0101: 0000</i> , and <i>regionSize = 0x00020000</i> .  This means that the range of protected addresses is from <i>0101: 0000</i> to <i>0101: FFFF</i> and from <i>0109: 0000</i> to <i>0109: FFFF</i> .  In addition, <i>regionStart + regionSize = 0111: 0000</i> . <br><br>  Now imagine that in the range of <i>0108: 0000</i> a segment of global memory is allocated, - the fact that this is global memory is indicated by an even number in the selector. <br><br>  Note that the global memory area is not in the range of protected addresses, but the value of the pointer to this area satisfies the inequality <i>0101: 0000?</i>  <i>0108: 0000 &lt;0111: 0000</i> . <br><br>  <b>A bit more text:</b> Our check can fail even on flat-memory model architectures.  Modern compilers are too eager to optimize undefined behavior.  Having found a comparison of pointers, they have the right to assume that these pointers refer to the same composite object or array (or position beyond the last element of the array), since any other type of comparison leads to indefinite behavior.  In our case, if <i>regionStart</i> indicates the beginning of an array or a composite object, then only pointers of the form <i>regionStart, regionStart + 1, regionStart + 2, ..., regionStart + regionSize</i> can be correctly compared with it.  All of them satisfy the condition <i>p&gt; = regionStart</i> and therefore can be optimized, with the result that the compiler simplifies our checking to the following code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p &lt; regionStart + regionSize)</code> </pre> <br>  Now the condition will satisfy all pointers, the value of which is less than <i>regionStart</i> . <br><br>  (You may encounter this situation if, as the author of the original question that answers this article, you allocate a region of memory using the expression <i>regionStart = malloc (n)</i> or if the selected region is used as a pool of preallocated objects for quick access and you need to solve Whether to free the pointer using the <i>free</i> function.) <br><br>  <b>Moral:</b> This code is insecure - even on architectures with a flat memory model. <br><br>  <b>But not everything is so bad:</b> The result of converting a pointer to an integer type depends on the implementation used, which means that it should describe its behavior.  If your implementation assumes getting the numerical value of the linear address of the object referenced by the pointer, and you know that you are working on a flat memory model architecture, the output will compare <i>integer values</i> instead of <i>pointers</i> .  Comparing integers does not have such limitations as comparing pointers. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)p &gt;= (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)regionStart &amp;&amp; (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)p &lt; (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)regionStart + (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)regionSize)</code> </pre> <br>  <b>Notes:</b> <br><br><ol><li>  Note that ‚Äúequal‚Äù and ‚Äúnot equal‚Äù are not relational operators. </li><li>  I know that in reality this is not the case - equal to zero I accept them for convenience. </li></ol><br>  (This article is based on <a href="https://stackoverflow.com/questions/39160613/can-the-following-code-be-true-for-pointers-to-different-things">my comments on StackOverflow</a> .) <br><br>  <b>Updated:</b> Clarification: optimization of the ‚Äúbeginning of the memory region‚Äù is performed only when the <i>regionStart</i> pointer refers to the beginning of an array or a composite object. <br><br>  <i>This is a translation of the ‚Äúinto a range of memory‚Äù into Russian.</i>  <i>Click the <a href="https://blogs.msdn.microsoft.com/oldnewthing/20170927-00/%3Fp%3D97095"><i>link</i></a> to see the original English version.</i> </div><p>Source: <a href="https://habr.com/ru/post/340458/">https://habr.com/ru/post/340458/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340444/index.html">We are at Highload ++ this November: ask a question to Badoo engineers</a></li>
<li><a href="../340446/index.html">OpenShift.IO: all-in-one development platform and CI / CD</a></li>
<li><a href="../340448/index.html">Arduino brain: pulse position sensor</a></li>
<li><a href="../340454/index.html">Start of the competition MERC-2017 from the Neurodata Lab</a></li>
<li><a href="../340456/index.html">Empowered pull requests</a></li>
<li><a href="../340460/index.html">The course of the young fighter PostgreSQL</a></li>
<li><a href="../340462/index.html">SoundCloud Sound Quality Study</a></li>
<li><a href="../340464/index.html">SALI is your ~ programming language</a></li>
<li><a href="../340466/index.html">How to calculate (user city) by IP</a></li>
<li><a href="../340474/index.html">How was DevFest Siberia 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>