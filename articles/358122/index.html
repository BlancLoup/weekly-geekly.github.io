<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>8088 MPH: we will break all your emulators</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the points of my wish list after reading the first report from the party in 1991 was a visit to the European demopati and participation in the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>8088 MPH: we will break all your emulators</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/723/8fd/0ed/7238fd0ed4b846eb476806335e9b7c5d.png" alt="image"></div><br>  One of the points of my wish list after reading the first report from the party in 1991 was a visit to the European <a href="http://en.wikipedia.org/wiki/Demoparty">demopati</a> and participation in the <a href="http://en.wikipedia.org/wiki/Demoscene_compo">compo</a> competition.  <a href="">I</a> <a href="http://www.pouet.net/prod.php%3Fwhich%3D2500">participated</a> in <a href="http://www.pouet.net/party.php%3Fwhich%3D159%26amp%3Bwhen%3D1996">NAID '96</a> and even <a href="http://www.pouet.net/party_results.php%3Fwhich%3D159%26amp%3Bwhen%3D1996">took a place there</a> , but my dream was always to compete with the best of the best.  I am pleased to announce that after six months of hard work with good friends and incredibly talented people, we succeeded.  Our demo <a href="http://www.pouet.net/prod.php%3Fwhich%3D65371">8088 MPH</a> won in oldskool demo compo <a href="http://2015.revision-party.net/">Revision 2015</a> .  (My personal victory was that our demo was shown to the compo last, which was a sign of respect for the organizers.) On April 7, 2015, there were no IBM PC emulators in the world capable of running our demo correctly;  they hung up or fell out before the demo was completed, and the colors were distorted.  The same applies to the rest of the gland, except for the target gland (see below).  To see what 8088 MPH is, I recommend that you watch the video recordings of a demo running on real hardware: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/hNRO7lno_DM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  In the demo there are so many technological discoveries made for the first time in the world, and we exploit iron as no one thought of before us, so it will be honest to tell you how we did it.  One of my posts was the ‚Äúorganizer‚Äù of the demo, so I will tell about it scene by scene, briefly explaining the basics of each trick.  I will tell you a bit more about the parts, but for a deep analysis of the technologies I will update this post so that you can leave links to the posts reenigne, VileR and Scali.  We hope that this story will attract interest in "old school" programming of software for the platform.  After reading this review post, I recommend following the links to articles, where the individual parts of the demo are discussed in more detail. <br><a name="habracut"></a><br><ul><li>  <a href="http://www.reenigne.org/blog/1k-colours-on-cga-how-its-done/">1K colors on CGA: How it's done</a> </li><li>  <a href="http://www.reenigne.org/blog/8088-pc-speaker-mod-player-how-its-done/">8088 PC Speaker MOD player: How it's done</a> </li><li>  <a href="http://www.reenigne.org/blog/more-8088-mph-how-its-done/">More 8088 MPH how it's done</a> </li><li>  <a href="https://scalibq.wordpress.com/2015/04/12/8088-mph-how-it-came-about/">8088 MPH: How it came about</a> </li><li>  <a href="http://8088mph.blogspot.com/2015/04/cga-in-1024-colors-new-mode-illustrated.html">CGA in 1024 Colors - a New Mode: the Illustrated Guide</a> </li><li>  <a href="https://scalibq.wordpress.com/2015/04/19/8088-mph-sprites-where-were-going-we-dont-need-sprites/">Sprites?</a>  <a href="https://scalibq.wordpress.com/2015/04/19/8088-mph-sprites-where-were-going-we-dont-need-sprites/">Where are we going, we don‚Äôt need ... sprites!</a> </li><li>  <a href="https://scalibq.wordpress.com/2015/04/23/8088-mph-the-polygons/">8088 MPH: The polygons</a> </li></ul><br>  More general information: <br><br><ul><li>  <a href="http://www.reenigne.org/blog/">reenigne blog</a> </li><li>  <a href="http://8088mph.blogspot.com/2013/10/using-photoshop-as-cga-bitmap-paint.html">Using Photoshop as a CGA Bitmap Paint Program</a> </li><li>  Scali's Openblog <a href="https://scalibq.wordpress.com/category/oldskoolretro-programming/">(retroprogramming category)</a> </li></ul><br><h1>  Target Equipment Specifications </h1><br>  Before proceeding to the individual parts, let's look at what the target system for this demo was: <a href="http://en.wikipedia.org/wiki/IBM_Personal_Computer">IBM 5150</a> 1981 (the very first ‚ÄúIBM PC‚Äù) with 640 KB of RAM, a floppy disk drive, an IBM CGA card and a built-in speaker .  System Content: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  The 8088 CPU at 4.77 MHz.  It seems that 5 MHz is a lot compared to other 8-bit microprocessors, but it takes 4 cycles to read one byte of the CPU.  Therefore, compared to other 8-bit CPUs like 6502 or 6809, capable of reading bytes per cycle, the <em>actual</em> clock frequency of 8088 is closer to (4.77 / 4) = 1.19 MHz. </li><li>  Video adapter with 9-pin RGBI interface and a composite RCA NTSC video interface.  Operated <a href="http://en.wikipedia.org/wiki/Motorola_6845">by Motorola 6845 character generator</a> .  There are no devices for changing text characters, the font is always the same. </li><li>  Built-in speaker;  there is no sound card like Sound Blaster, no special sound equipment like <a href="http://en.wikipedia.org/wiki/MOS_Technology_SID">SID</a> Commodore64.  The speaker can be controlled by a timer contact to create a square wave or by using bit-banging directly through the port or a one-time timer. </li></ul><br>  It seems that the requirements of 640 KB of RAM - this is too cool, but in the first IBM PC it was possible to install them, moreover, for 1985 this is a fairly ordinary amount.  If you still want to be perturbed, then note that the only effect that needs this amount of RAM is the kefrens bars.  It is necessary for the repeating pattern to be repeated less frequently and to be more pleasant to the eye.  We could reduce it, but then the audience would notice that the pattern repeats faster.  With the kefrens bars effect, the demo uses 507 KB of RAM;  without it - only 349 KB.  Most of the effects use much less memory, and some are generally tiny, for example, the plasma takes up only 6 KB (including the banner graphics), and the image of a girl requires only 18 KB (2 KB more than the size of the image data itself).  We deliberately sacrificed size in favor of speed.  It was a conscious decision to fit as many effects as possible in the 8 minutes of running the demo (limited by the compo contest).  If we had a few more minutes of execution time, then we could probably fit all the demo at 256 KB or even less, but the pauses between the effects would be longer.  It is also worth noting that there are <a href="http://www.reenigne.org/blog/comparison-of-cga-card-versions/">two different versions of the IBM CGA</a> , which basically differ in the way they generate composite colors.  We had the same number of IBM ‚Äúold‚Äù and ‚Äúnew‚Äù style CGA cards, so we decided to create graphics for the ‚Äúold‚Äù one.  If you have a ‚Äúnew‚Äù style CGA card, then the demo will still work, but with slightly distorted colors. <br><br><h1>  Technical Overview </h1><br><h2>  Used development tools </h2><br><ul><li>  Turbo c </li><li>  Turbo pascal </li><li>  Turbo assembler </li><li>  Turbo debugger </li><li>  Visual c ++ </li><li>  Openwatcom </li><li>  NASM (and YASM) </li><li>  Dosbox </li><li>  Some real IBM 5160 (this is a hardware analog 5150, but it is easier to find in the real world) </li></ul><br>  All data files were embedded directly in the .exe / .com files.  Thanks to this, it was possible to save everything in one binary file, that is, the data can be subjected to compression (see below).  Most development cycles use design in <a href="http://en.wikipedia.org/wiki/Wetware_%2528brain%2529">wetware</a> (in the head), coding on modern systems (or in DOSBox running on a modern system), testing / debugging in DOSBox, and then transferring it to real hardware for final testing.  When the effect became so sophisticated that it stopped running in the emulator, the development cycle slowed down because testing could only be performed on real hardware.  To transfer the code to the equipment, we used various methods: Scali used a serial interface cable, I had an ethernet card with a packet driver and <a href="http://www.brutman.com/mTCP/">mTCP</a> ;  at the party, we used an 8-bit IDE ISA adapter (Silicon Valley ADP-50) connected to a CF-to-IDE adapter to turn the CF card into a hard disk.  We used a USB CF card reader to transfer information.  The most intriguing was the reenigne method, which used a special controller connected to the keyboard port.  He used the IBM BIOS test mode as a ‚Äúserial port for the poor‚Äù.  (I hope Andrew will write more about this!) <br><br><h2>  Bootloader, API and general structure </h2><br>  We all had our favorite languages ‚Äã‚Äãand environments, so at an early stage we decided to create a common ‚Äúboot loader‚Äù that would execute the .EXE and .COM files so that developers could develop effects in any environment that suits them.  This concept is not new;  for the same reasons, it was used in the famous <a href="http://fabiensanglard.net/second_reality/second_reality_dis.php">Second Reality demo</a> .  The same technique was used even earlier for a lot of demos for other platforms.  (Before you ask: no, we didn‚Äôt copy <a href="https://github.com/fabiensanglard/SecondReality">the Second Reality code</a> ; in fact, we didn‚Äôt even consult with the developers, because we needed to write an unusually compact code to minimize the amount of memory that was supposed to work on 8088 (opcodes 80186 are used in the Second Reality code)).  The loader API services are going to be approximately 450 bytes of code.  The loader is responsible for the following aspects: <br><br><ul><li>  Play background music </li><li>  Masking the boot process and the preliminary effects calculation process using mega-demo text </li><li>  Synchronization services (such as interrupting the reverse of the vertical sweep in the software and a user-defined countdown counter) </li></ul><br>  Performing effects using the loader consists of the following procedure: <br><br><ol><li>  Print the text on the screen and animate it using an interrupt and register the starting address 6845 </li><li>  Effect </li><li>  The effect performs unpacking, preliminary calculations, and then informs the loader that it is ready to begin </li><li>  The loader clears the moving screen text, and then informs the effect that it can begin </li><li>  The effect starts, the magic begins </li></ol><br>  It was extremely important to design this part of the work correctly, because any bugs would have caused the crash of the entire demo.  The structure of this part was completed before writing the first line of code.  For the curious, I posted online <a href="https://docs.google.com/document/d/1645juVSRF2M2shcpZ3sOXHiugm0uUP7kOgHHzHzp4AQ/edit%3Fusp%3Dsharing">dizdok</a> .  (The loader was written by me.) Playing background music should be as simple as possible, so as not to affect any effects.  From a practical point of view, the only option was a simple PC squeak, changing (or disappearing) in each frame, so background music consists only of a 60 Hz squeak.  The <a href="http://www.oldskool.org/pc/MONOTONE">MONOTONE</a> composition program was used to generate the speaker timer values.  Even despite the fact that the playback code consists of only 18 lines in assembler, it occupies two raster lines on the screen, that is, something more complex would take even more CPU resources, and some full-screen 60 Hz effects would be impossible to realize . <br><br><h2>  Compress executable file </h2><br>  Another aspect that was considered at the earliest stages of development was the ability to compress the executable file.  We needed to find out the following: <br><br><ul><li>  Is it possible to perform compression so that it justifies itself? </li><li>  Is decompression fast enough to avoid long pauses in the demo? </li><li>  Does the decompression procedure affect the system in the decompression process?  (for example, does it turn off interrupts and do something as terrible as to completely ruin the demo?) </li></ul><br>  I took most of the classic and modern <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D0%25BF%25D0%25B0%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0_%25D0%25B8%25D1%2581%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BD%25D1%258F%25D0%25B5%25D0%25BC%25D1%258B%25D1%2585_%25D1%2584%25D0%25B0%25D0%25B9%25D0%25BB%25D0%25BE%25D0%25B2">packers of executable files</a> and conducted tests with old programs that were like what we were going to do.  The results pleasantly surprised me.  Compression levels were high enough so that we could afford to embed pre-computed data, rather than counting them on the fly.  At the same time, decompression turned out to be quite fast, so much so that the full load of the program from a floppy disk was in fact even slightly faster than if it was loaded uncompressed.  In the end, we chose the winner - pklite.  For comparison, I posted the <a href="https://docs.google.com/spreadsheets/d/1xrZ81AqnRyje98z2QORzeOw28LGh2_wGrF3p6fozicY/edit%3Fusp%3Dsharing">test results data</a> online.  (If I missed some packers that have <strong>significant</strong> advantages over my set, then tell me about it. About 100 packers are created for DOS, but if they do not compress better than apack or upx, or do not unpack faster than pklite or lzexe, which <em>with all this is compatible with 8088</em> , then I do not want to know anything about them.) <br><br><h2>  Scene breakdown </h2><br>  Below I will explain each effect by scene.  As mentioned above, I will describe in detail only those scenes I worked on myself;  if the rest of the team members want, they will write a technical analysis of their parts.  Description of each effect comes after the effect screenshot. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/960/d17/1bf/960d171bfe7daf0fb4f4640e79e6b38d.png" alt="image"></div><br>  This intro performed two tasks: it was supposed to acquaint the audience with the system and explain what difficulties we had to face, creating a world-class demo on such hardware, and at the same time temper their expectations.  Obviously, the text mode is simulated;  in fact, I duplicated the basic functions of the text mode BIOS, but simulated them in graphics mode.  Flicker of the cursor and the text is implemented in the same way as 6845 does, reinforcing the illusion.  (Almost) it is impossible to change the starting address of the display of the graphics mode so that each individual raster line is taken from another place, so the deployment of the initial screen is realized by brute force - by copying new raster lines into memory hidden by the reverse frame scan.  The initial screen disappears with the help of a ‚Äúdimming effect‚Äù from the top edge, performed by an ‚ÄúAND‚Äù operation with a mask for consecutive lines of screen data. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bd7/617/2c2/bd76172c21b237623bad4c11bca526da.png" alt="image"></div><br>  Many people think that the initial screen is the same picture that <a href="https://www.youtube.com/watch%3Fv%3D9VPn5gkG_Qo">VileR showed several years ago</a> .  But it is not so!  He remade it under a 16-color composite signal specifically for this demo, and also edited it a bit. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/870/165/0d5/8701650d578c33875c28e71aa871d68a.png" alt="image"></div><br>  The rocking effect was achieved by creating a software reversal of the vertical sweep, performed every time in one place on the screen (immediately after the last displayed line), followed by its processing by changing the initial display address 6845. To transmit the interruption of information about whether it was time to delete the letters , were used flags.  Deletion is performed by simply using REP STOSW to fill the screen with black lines.  Since 6845 displays two lines of text on the ‚Äúline‚Äù, the text can only move to even lines, so the movement does not look as smooth as it should.  Honestly, <em>it</em> was <em>possible</em> to make them move to any line, but it would be expensive from the point of view of the CPU.  The whole point of the bootloader is to use as little CPU resources as possible, so I had to make a compromise.  For other effects, the simulated interruption of the reverse sweep of the frame scan is also implemented using the loader API services.  Effects can disable it, reinitialize and bind / untie its own procedures from it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/813/86b/34a/81386b34a899a05297aa82fd4769abf1.png" alt="image"></div><br>  The moire effect was implemented using the 40 √ó 25 text mode framework, stretched ASCII characters in half-character blocks, as well as a bunch of code with loop promotion.  The circles are chosen to demonstrate the classic effect, but in fact this effect can combine any two images.  This effect created reenigne. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c48/2b0/bdb/c482b0bdb593a3a082e9f9d4331e4836.png" alt="image"></div><br>  Rotozoomer - this is the same tortured old procedure, which I showed in 1996 at <a href="http://www.pouet.net/party.php%3Fwhich%3D204%26amp%3Bwhen%3D1996">8086 compo</a> , only optimized and accelerated to draw only every second line.  The misunderstanding between me and VileR led to the use of not the best to demonstrate the effect of the texture, but it still works well.  There were plans to add a 60 Hz version of this effect, but we did not have enough time. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/723/8fd/0ed/7238fd0ed4b846eb476806335e9b7c5d.png" alt="image"></div><br>  The fundamental concept of the 1024-color mode is strong abuse of the 80 √ó 25 text mode with NTSC enabled.  Initially, VileR came up with this trick for 512 colors, but reenigne managed to increase the number of colors to 1024 using a trick with a CRT controller.  Some people thought that everything was done in this mode.  But this is not the case, because the 80-line text mode suffers from the famous <a href="http://en.wikipedia.org/wiki/Color_Graphics_Adapter">CGA snow defect</a> when directly writing to the CGA RAM in this mode.  Unfortunately, this is noticeable in the plasma effect (see below).  By the way, I saw this picture in 2013, and it was then that I realized that I must gather all these people to create a demo.  Look, it's awesome!  When I saw her, my jaw dropped.  If I hadn‚Äôt seen how the collaboration between VileR and reenigne led to this picture, then the 8088 MPH demo might not appear. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f40/edb/fa3/f40edbfa3b2e57feb563ed17edde7c0a.png" alt="image"></div><br>  In fact, these stars are the result of code operation with loop promotion and tables of previously calculated values, which together take bytes from one place and move to another place in the video memory.  Although we had other drawings ready, for example, a whirlwind, we decided that the starry sky is more suitable for a typical oldskool demo.  The effect was created by reenigne. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cd7/305/d86/cd7305d8658e82f982d8ff4927410692.png" alt="image"></div><br>  The part with the sprites is similar to black magic, but in reality it is a combination of using the Scali compiler of sprites and vertical screen adjustment using the initial address register 6845. There is only one video memory screen in the CGA, so when the address is shifted down, the screen scrolls up and the data at the edges of the screen are repeated.  However, the data is not repeated evenly along the border, so processing is required.  Timer tracking was performed to know when the line containing the last pixel of the sprite was drawn, after which the sprite was redrawn.  (In other words, redrawing the sprite was an <a href="http://en.wikipedia.org/wiki/Racing_the_Beam:_The_Atari_Video_Computer_System">‚Äúovertake the ray‚Äù</a> exercise.) The timings were very tight to avoid the screen / sprite breaking effect. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f90/042/1de/f900421de333e2b9e2f1b0124a70c4ee.png" alt="image"></div><br>  Also part of the effect of the compiled sprite, here 30 vector balls are displayed at 30 Hz.  We had another effect demonstrating a smaller number of balls with a frequency of 60 Hz, but Scali had an idea at the last moment to make up some kind of an inscription, for example "8088", "IBM" or something like that, so he wrote the code changes to the party.  Upgrading is performed using double buffering;  The sprites occupy only a small rectangular area on the screen, so the CRT controller parameters of the screen mode were reprogrammed to create a video mode with a small area in the middle of the physical screen, using only half of the available video memory.  So we got a real hidden page in which it was possible to draw / erase vector balls, which then became visible using the register of the initial display address 6845. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/928/f7e/f9b/928f7ef9b0cf9b268e23452554c20d13.png" alt="image"></div><br>  This plasma uses a variation of the 1024-color screen mode, which can only be updated using the attribute byte (which limits the number of colors to 256).  The effect records only when the CRT beam performs a horizontal or vertical reverse.  Unfortunately, the timing necessary for the correct implementation, for some reason, stopped working on the party (perhaps it happened because we changed the order of the effects), so along the left side of the screen you can see a line of noise, and a little noise from above.  This is my fault, because I wrote this effect using a lazy poll procedure.  Alas, the CGA ‚Äúsnow‚Äù is still there, but without all of the reverse sweep processing, the effect could work at 60fps.  In the demo with ‚Äúsnow‚Äù, it works with a frequency of only 20fps.  Perhaps VileR will write in more detail about how this screen mode and color system work, and if this happens, I will update the links at the beginning of the article.  If we take up the final version of the demo, fixing this bug will be one of the top priorities <i>[app.</i>  <i>Per.: The video from the beginning of the article shows the final version]</i> .  In fact, I am sure that reenigne will be able to replace the effect of the survey with the effect of counting cycles, which will not only eliminate the ‚Äúsnow‚Äù, but also increase the speed. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bbc/7be/1c8/bbc7be1c8e18d046e2ab21857c5e165f.png" alt="image"></div><br>  1024-color mode replicates the start address every two lines.  I used this behavior to create a simple ‚Äúrun-off‚Äù effect for a stunning VileR image.  You can say that much more sophisticated effects are possible (here you can recall the <a href="http://www.pouet.net/prod.php%3Fwhich%3D2048">Copper</a> demo), but I did not have enough time to make it even better. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/570/4fc/cd7/5704fccd7cf9ffc6cf73de46e465275e.png" alt="image"></div><br>  This classic <a href="http://en.wikipedia.org/wiki/Raster_bar">Kefrens bars</a> effect was created by reenigne in 320x200x4 mode.  This is an effect with counting cycles, because there is simply no time to track the horizontal retrace.  To ensure a constant number of cycles, we did a lot, including changing the default system DRAM update interval from 18 to 19, so that the DRAM update periods correspond to access to the CRT controller. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a2c/1b0/50a/a2c1b050a597c369121bd5fa3565b09c.png" alt="image"></div><br>  This effect was made by Scali, he was inspired by his own <a href="http://www.pouet.net/prod.php%3Fwhich%3D62165">demo of 1991</a> , in which a big torus was also present.  Here the following happens: <br><br><ul><li>  Only the changed parts of the screen are calculated and drawn.  This minimizes the amount of data transferred needed to update the screen (this is the same delta-drawing idea that was used in the <a href="https://x86dc.wordpress.com/">XDC</a> ).  We did this because the video memory CGA has a wait state, so the less you record it, the better. </li><li>  The 320x200x4 mode is used with a combination of background and palette, which creates such a specific composite color palette with a multitude of shades of blue. </li><li>  When rasterizing, dithering is applied to help with shading. </li></ul><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b99/b9a/319/b99b9a319ba97788b403d60b60dbfa61.png" alt="image"></div><br>  At the party, reenigne stated that it should be possible to restart the starting address of the CRT controller for each raster line.  In this case, it would be possible to obtain a video mode with a height of only 100 drain, which will give us a 1024-color mode with a resolution of 80 √ó 100.  The image above shows the result of such a code plus a <strong>very long</strong> work on creating a program for modeling the composite signal CGA NTSC, written by reenigne a few months before, to perform image conversion.  (No, we don‚Äôt give it to anyone. And before you ask, I will say, pictures of a girl and CGA 1k are not a simple transformation, they were manually painted by VileR in Photoshop, and 4-colors / 16-colors / "Until Now" screens were created in an augmented version of Pablodraw written by him.) We did not have time to put text on this picture.  The people shown above go in the same order as in the credits: Trixter, reenigne, Scali, VileR, Phoenix and virt.  We apologize to coda and puppeh, but, as you can see, if you compress the picture even more, you won‚Äôt recognize the person at all.  Sorry! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bc1/086/c2e/bc1086c2e2c4587ded1ddadcf164ea96.png" alt="image"></div><br>  And finally, the finishing blow: a multichannel music engine for the PC speaker.  We didn‚Äôt want to just copy the engine for the ZX Spectrum, and other engines like the one used by the Music Construction Set, but instead decided to raise the bar incredibly high: we play the protracker mod-file through the speaker.  There are other mod players through the speaker, but they require a 10 MHz 80286, and they barely cope with the output at a 6 KHz sampling frequency.  Our player accurately reproduces all the effects of protracker, mixing and outputting sound to the speaker in real time at a frequency of 16.5 kHz, and all this on a 4.77 MHz processor.  It was the creation of reenigne, which became a true technical achievement, which required 8088 to implement non-standard thinking and serious knowledge. I am sure that he will write a more detailed post about creating a player.  In the meantime, I can mention the following details: <br><br><ul><li>  In order for the data structures and sample data to correspond to the indexing method of the 8088 memory, a preliminary module conversion was performed.  Sample data has also been converted. </li><li>  Calculation and output of each sample should take exactly 288 cycles, otherwise the sound begins to stutter.  To achieve this was very difficult.  4.77 MHz / 288 = 16572 Hz. </li><li>  The sound output was performed by traditional <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B8%25D1%2580%25D0%25BE%25D1%2582%25D0%25BD%25D0%25BE-%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BC%25D0%25BE%25D0%25B4%25D1%2583%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D1%258F">pulse-width modulation</a> (PWM) techniques, for example, those that made Access <a href="http://en.wikipedia.org/wiki/RealSound">Realsound</a> popular.  PWM dynamics is performed by linking the input speaker contact to channel 2 of the programmable interrupt timer (PIT), followed by programming the PIT with 2 byte values.  In a system configured in this way, any value transmitted by PIT 2 transfers the speaker to a high memory area (HIGH) and starts counting, and when the counting ends (that is, the transmitted value is reached), the sensor is again transferred to a low area (LOW).  This leads to a ‚Äúpeep‚Äù of the carrier of the audible frequency;  this is why the output must be fast (16.5 kHz) so that the carrier frequency is above the human hearing range. </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A funny fact: after the preliminary conversion of the melody and its transformation into a self-playing .exe, the final result after compression is less than the original module. </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sprint on the party </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We came to the party with a 90% ready project. Before we came to the party, we created what seemed to us worthy of participation in the competition, as well as two "rescue" videos, one for display on the big screen, and in the second </font></font><a href="https://www.youtube.com/watch%3Fv%3DO4dtJbb6Eow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a demo running on real hardware was recorded as evidence for the judges</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . We were afraid that the equipment that we take with us would be damaged during transportation, so we decided to </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make sure</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and show </font><em><font style="vertical-align: inherit;">at least something</font></em><font style="vertical-align: inherit;"> . Fortunately, the IBM computers 5160 reenigne and Scali arrived unscathed (which is especially noteworthy because the reenigne had to transport the car from Britain to Germany on several trains!). We also brought two CGA-cards, two devices for capturing and three different ways of transferring new pieces of software from our laptops to old hardware.</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can never prepare for everything!</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We spent most of the time coding at the party by adding kefrens and photos at the end of the demo, fixing bugs, adding beautiful transitions, cutting seconds from each part to fit the compo restrictions, and changing the order of the parts so that the </font><a href="http://www.backtothefuture.com/"><font style="vertical-align: inherit;">BTTF</font></a><font style="vertical-align: inherit;"> inspired </font></font><a href="http://www.backtothefuture.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The virt's melodies coincided with the part of the demo with sprites. Almost all the time before compo, we spent on coding, eating and hygiene, and we only managed to communicate with people after. Although we came with a program that was almost ready to participate in the compo, the time spent during the party was invaluable - we were able to turn a raw draft into something that could truly compete for first place. We were all at the same table, which means we could instantly communicate. We have learned a lesson: rarely that can replace face-to-face work! One of the results of such joint work for the party was the decision to change the credits at the end from text-only scrolling at variable speed to smoother ANSI-style scrolling, which, in my opinion, was the best implementation compared to all those parts we took from home.To save time (and for correct video conversion - I'm sorry, but most people don‚Äôt know how to work with interlaced video correctly), I suggested to give Gasman 720 @ 60p video. NTSC CGA output is slightly different; instead of 262.5 lines on the field, it generates 262. This means that it generates 59.92 fields (29.96 frames) per second instead of the NTSC broadcast standard of 59.94 (29.97 fps). This prevents the use of most modern capture devices; for example, Scali had a high-quality Blackmagic Intensity Shuttle, but he could not capture the signal. I knew from experience that some cheap video capture devices, such as the Terratec Grabby or Dazzle DVC100, have a higher tolerance because they were intended for use with VCR signal sources,so I brought these devices with me and sent one reenigne for testing. For the capture, we used the DVC100 with a slight modification of the amplifier-corrector so that the capture looked as close as possible to the output of a CRT monitor. To further improve the video capture, we used VirtualDub as capture software, which has the option of dynamic resampling of the incoming audio signal to match the capture frame rate in case it is slightly offset. This combination of software and hardware worked very well. To capture the sound, we firstwhich has the option of dynamic resampling of the incoming audio signal to match the frame rate of the capture in case it is slightly shifted. This combination of software and hardware worked very well. To capture the sound, we firstwhich has the option of dynamic resampling of the incoming audio signal to match the frame rate of the capture in case it is slightly shifted. This combination of software and hardware worked very well. To capture the sound, we first</font></font><a href="https://www.youtube.com/watch%3Fv%3DfzMZeWFSs1E"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hooked up to the dynamics of the crocodile clips</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but Scali brought along Sound Blaster, which had a real PC speaker contact, and it could be connected with an internal cable, so we used it to capture it.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A look into the future </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After seeing the demo and reading the article, you may wonder if there is still room for improvement? Believe it or not, it exists - there are certainly possible alternative ways of generating sound and additional tricks with loop extraction. We could build more effects into the demo, but we didn‚Äôt have enough time: first, the development time, secondly, the demo playback time, because in the compo discipline on Revision, the limit is 8 minutes or less. In sum, I know all people who have worked together on the demo for 60 years. Working on a demo with them was an honor and a privilege. Will we work together again? I would say that it is definitely possible; the day after compo, we threw out a few ideas, for example, creating a game instead of a demo. Personally, I burned out and spent the next few weeks playing games,who have long wanted to go, and to restore health. In addition, I have several other large projects that I want to launch this summer, one of which is very much waiting for the PC preservation software community, and the second is the online sound card museum. But who knows‚Ä¶</font></font><br><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bonus - what does 8088 MPH look like in DOSBox: </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/78hg-Q2W3oM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/358122/">https://habr.com/ru/post/358122/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358112/index.html">The transition to domestic software, installation "megasiens" and attracting leading foreign scientists: a plan for breakthrough development of the Russian Federation</a></li>
<li><a href="../358114/index.html">We invite you to Android-meetup SuperJob</a></li>
<li><a href="../358116/index.html">Monitoring network traffic on servers in the cloud</a></li>
<li><a href="../358118/index.html">AI, practical course. Foreword</a></li>
<li><a href="../358120/index.html">Information exchange between working threads without pain? CSP channels to help us</a></li>
<li><a href="../358124/index.html">How to make a configuration file of routes in React Router 4 (subtitles)</a></li>
<li><a href="../358126/index.html">Briefly about Shadowsocks, or OpenVPN is not needed (in every home)</a></li>
<li><a href="../358128/index.html">Detection of criminal groups stealing from stores - Data Mining</a></li>
<li><a href="../358130/index.html">RKN unlocks 3.5 million Google IPs</a></li>
<li><a href="../358132/index.html">[Peter] JUG.ru meeting with Oleg Chirukhin - GraalVM Almighty</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>