<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Orange Pi Zero WiFi Speaker / Player or Lost Time Story</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to the respected habrovchanam! 

 Prehistory 
 My story began with the fact that at the request of one friend it was necessary to make a smal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Orange Pi Zero WiFi Speaker / Player or Lost Time Story</h1><div class="post__text post__text-html js-mediator-article">  Good day to the respected habrovchanam! <br><br><h3>  Prehistory </h3><br>  My story began with the fact that at the request of one friend it was necessary to make a small programmable device with audio output and GPIO.  I have long wanted to work with any single-server * Pi and therefore immediately decided to do something similar (result + experience).  A friend almost immediately abandoned the proposed project, but I ended up with an OrangePi Zero board purchased.  For some time she was lying idle until they gave me an old Canon MX320 multifunction printer without network support.  I really didn‚Äôt want to have an extra wire from the laptop to the printer, and as a result, the orange was extracted, configured and works since then as a CUPS server via USB (the result, by the way, is good, but that's another story). <br><br><h3>  Outset </h3><br>  Once I got tired of always connecting my phone to the speakers via minijack.  They cost well, comfortable, and carry them reluctance.  A telephone that always hangs on a lineman is no longer a mobile phone, but something similar to old wired devices.  I also have a laptop so that it would be inconvenient to connect a cable to the speakers to it.  And the machine itself is old (10 years already), an extra audio player - an extra load. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can, of course, buy bluetooth speakers.  Or bluetooth adapter.  But this means a short range and playing music only on the device with which the phone is connected via bluetooth.  Need something more serious.  ‚ÄúIt would be great to hang such a server on an orange, which could receive audio stream from a smartphone via WiFi,‚Äù I thought, ‚Äúbecause it is constantly connected via ethernet to the router, lightly loaded (as Ubuntu Server 16.04 costs on it), you can conveniently place electricity consumes little. ‚ÄùIt is said - done. <br><a name="habracut"></a><br><h3>  Part 0, hardware </h3><br>  For a start, it was necessary to connect the jack to the jack with an orange.  I took a bare fee, so everything had to be soldered by myself.  There is nothing complicated, and I will say straight away: there is no special point in doing this - it is easier to buy a ready-made expansion card.  I advise this method, because on my homemade board the interference affects the sound of the speakers (in particular, when sending a large print job to the printer, or when installing large packages).  Most likely, there are two reasons - my bad work + food is brought right to the board, and not through microUSB. <br><br>  Because the photo board, soldering and manuals will not be, if needed - easily located on the network. <br>  If you choose to buy a board, you will save time and effort, and there will immediately be a mini-jack jack, two more USB connectors, an infrared sensor and a microphone.  I bought the second orange already in a set with a case and an expansion card, I regretted that I didn‚Äôt do that from the very beginning. <br><br><h3>  Part 1, software </h3><br>  We connect via SSH (if the standard login-password is not changed, then this is the root orangepi). <br><br>  Do not forget to do <br><br><pre><code class="bash hljs">apt update</code> </pre> <br>  (anyway you will need it later) <br><br>  By default, the sound is turned off, so to turn it on, do the following: <br><br>  Run alsamixer. <br><br><pre> <code class="bash hljs">alsamixer</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/45a/760/4ca/45a7604cade3a60992011cdefcb4355d.png" alt="image"><br><br>  Turn on the audio line out (the desired switch is in the center), to do this, move the arrows five positions to the right and press m <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ee/884/504/9ee88450410d194a6524b14f453a7a56.png" alt="image"><br><br>  Exit by pressing Esc. <br><br>  Save the current state <br><br><pre> <code class="bash hljs">alsactl store</code> </pre> <br>  The current state will still be reset after a reboot, because we add lines <br><br><pre> <code class="bash hljs">alsactl restore</code> </pre> <br>  in rc.local so that the parameters are restored automatically: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc</code> </pre> <br><pre> <code class="bash hljs">nano rc.local</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh -e # # rc.local # # This script is executed at the end of each multiuser runlevel. # Make sure that the script will "exit 0" on success or any other # value on error. # # In order to enable or disable this script just change the execution # bits. # # By default this script does nothing. # ** Overclock to 1.728 GHz #echo 1728000 &gt; /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq echo 0 &gt; /proc/sys/kernel/hung_task_timeout_secs dmesg -n 1 alsactl restore exit 0</span></span></code> </pre><br>  I advise you to check after this - perform a reboot first <br><br><pre> <code class="bash hljs">reboot</code> </pre> <br>  Install mplayer <br><br><pre> <code class="bash hljs">apt install mplayer</code> </pre> <br>  and check the performance <br><br><pre> <code class="bash hljs">mplayer http://nashe1.hostingradio.ru/nashe-128.mp3</code> </pre> <br>  If the radio has played, then everything is in order. <br><br>  You can, however, just run after a reboot. <br><br><pre> <code class="bash hljs">speaker-test</code> </pre> <br>  but I like the rest of the tuning for radio. <br><br><h3>  Part 2. mpd </h3><br>  Once the audio output is configured, you can begin to install something useful.  And in my case, it was just mpd and mpc (the client for mpc works in the terminal).  What is mpd?  This is a network daemon player that works fine without a graphical interface and therefore does not load the system.  Settings options - a lot, for every taste.  Easy playing music from the network and from the local collection.  There is even an article about the interaction of mpd with Yandex.Music and with Google Music. <br><br>  It can be controlled from any OS - clients are under Windows, Linux, Android, ios, mac os, Symbian, therefore it is very convenient. <br><br>  Install <br><br><pre> <code class="bash hljs">apt install mpd mpc</code> </pre> <br>  All settings are in the file /etc/mpd.conf <br><br><pre> <code class="bash hljs">nano /etc/mpd.conf</code> </pre> <br>  Be sure to change the following directive <br><br><pre> <code class="bash hljs">bind_to_address <span class="hljs-string"><span class="hljs-string">"localhost"</span></span></code> </pre> <br>  on <br><br><pre> <code class="bash hljs">bind_to_address <span class="hljs-string"><span class="hljs-string">"any"</span></span></code> </pre> <br>  because it provides the ability to control mpd over the network. <br><br>  And go to the section <i>Audio Output</i> <br><br>  Customize the output through alsa <br><br><pre> <code class="bash hljs">audio_output { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-string"><span class="hljs-string">"alsa"</span></span> name <span class="hljs-string"><span class="hljs-string">"My ALSA Device"</span></span> normalize <span class="hljs-string"><span class="hljs-string">"yes"</span></span> device <span class="hljs-string"><span class="hljs-string">"hw:0,0"</span></span> <span class="hljs-comment"><span class="hljs-comment"># optional mixer_type "software" # optional # mixer_device "default" # optional # mixer_control "PCM" # optional # mixer_index "0" # optional }</span></span></code> </pre> <br>  If you do not add the directive normalize "yes", then the sound will be very quiet.  Unfortunately, I can‚Äôt write more about this directive, I didn‚Äôt have time to look for information. <br><br>  Directive <br><br><pre> <code class="bash hljs">device <span class="hljs-string"><span class="hljs-string">"hw:0,0"</span></span> <span class="hljs-comment"><span class="hljs-comment"># optional</span></span></code> </pre> <br>  I added quite recently, without it, mpd works fine (if it works alone), and it was needed only because I put additional components, which are described below. <br><br>  Restart mpd <br><br><pre> <code class="bash hljs">service mpd restart</code> </pre> <br>  Everything, we can connect. <br><br>  We go to any client, enter the IP of our server, connect.  First, of course, in playlists, in files and in streams is empty.  For mpd to see your local files, you need to either change the settings in /etc/mpd.conf, specifying in the section <br><br>  <i>Files and directories</i> <br><br>  path to your music folder <br><br>  <i>music_directory "/ home / orangepi / Music</i> <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Files and directories ####################################################### # # This setting controls the top directory which MPD will search to discover the # available audio files and add them to the daemon's online database. This # setting defaults to the XDG directory, otherwise the music directory will be # be disabled and audio files will only be accepted over ipc socket (using # file:// protocol) or streaming files over an accepted protocol. # music_directory "/var/lib/mpd/music" music_directory "/home/orangepi/Music"</span></span></code> </pre> <br>  But I still don‚Äôt have local files, but I‚Äôm using a laptop hard drive mounted by Samba directly into the / var / lib / mpd / music folder.  Plans to buy an external hard and connect it to an orange, but for now finances do not allow. <br><br>  In any case, after the path to the folder with music is added (or the folder itself is mounted), you need to update the collection.  This can be done from any client, the simplest <br><br><pre> <code class="bash hljs">mpc update</code> </pre> <br>  We are waiting for some time (more collection - more time is needed to scan it). <br><br>  Everyone, we can enjoy the music! <br><br>  Me mpd wakes up in the morning instead of an alarm clock.  It is very good and pleasant to wake up to different music / stations at different times and days. <br><br><h3>  Part 3. Actually, WiFi column </h3><br>  So, mpd is, of course, good, but it does not perform the desired task - there is no audio transmission from the phone when playing music on it.  A few sleepless nights - and an article was found about turning * Pi into a receiver of an audio stream. <br><br>  In short: <br><br>  what I need is very similar to Google's Chromecast, because it supports Wi-Fi audio transmission and this program is available in many applications. <br><br>  But I still do not have Chromecast, but an orange.  If I understand correctly, so far the Chromecast protocol is closed.  But this is a modified DLNA protocol, which serves to transfer media content over the network. <br>  Aha <br><br>  Immediately located in the repositories package minidlna. <br><br>  We put <br><br><pre> <code class="bash hljs">apt install minidlna</code> </pre> <br>  So, now there is an orange dlna server.  We put the dlna-player to your phone. <br>  Bummer. <br><br>  The server is, it seems, there is access to the collection and playback of content, but on the phone.  And broadcast audio stream is not yet possible. <br><br>  We understand the protocol: it turns out there is a DLNA server, a DLNA controller (for playback control) and (!) DLNA renderer. <br><br>  The last is what we need. <br><br>  In the repositories it is not, because we put so <br><br><pre> <code class="bash hljs"> wget -O - http://www.chiark.greenend.org.uk/~christi/debian/christi@coraline.org.gpg.key \ | sudo apt-key add - <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> deb http://www.chiark.greenend.org.uk/~christi/debian/ wheezy main &gt; /etc/apt/sources.list.d/upnprender.list apt-get update apt-get install libupnp-dev libgstreamer1.0-dev \ gstreamer1.0-plugins-base gstreamer1.0-plugins-good \ gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly \ gstreamer1.0-alsa apt install git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/hzeller/gmrender-resurrect.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> gmrender-resurrect apt-get install autoconf ./autogen.sh ./configure make install cp scripts/init.d/gmediarenderer /etc/init.d update-rc.d update-rc.d gmediarenderer defaults</code> </pre><br>  The author of gmediarenderer is launched at system startup via init, this method does not work for me yet, because a line has been added to /etc/rc.local <br><br><pre> <code class="bash hljs">/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/gmediarender -f Garden -d -u bd1dcf3e746aa69812943cb1d00f7ebc --gstout-audiosink=alsasink --gstout-audiodevice=sysdefault --gstout-i$</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh -e # # rc.local # # This script is executed at the end of each multiuser runlevel. # Make sure that the script will "exit 0" on success or any other # value on error. # # In order to enable or disable this script just change the execution # bits. # # By default this script does nothing. # ** Overclock to 1.728 GHz #echo 1728000 &gt; /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq echo 0 &gt; /proc/sys/kernel/hung_task_timeout_secs dmesg -n 1 bash /root/sh/script0.sh /usr/local/bin/gmediarender -f Garden -d -u bd1dcf3e746aa69812943cb1d00f7ebc --gstout-audiosink=alsasink --gstout-audiodevice=sysdefault --gstout-i$ exit 0</span></span></code> </pre><br>  In order to now be able to listen to the audio stream from a smartphone on the OrangePi, set BubbleUPnP, or HiFi Cast, a Google Play search gives a lot of results for the DLNA query.  Not everything can be rendered.  Neither VK nor Yandex.Music / Radio is rendered.  But it's still more than nothing.  Currently, any local music from the phone + SoundCloud is played. <br><br>  Unfortunately, after installing gmediarender mpd stopped working normally - there is playback, but there is no sound.  The search did not give anything, the solution was found by chance - you need to uncomment the line in the section Audio Output in the block describing the output via alsa in the /etc/mpd.conf file: <br><br><pre> <code class="bash hljs">device <span class="hljs-string"><span class="hljs-string">"hw:0,0"</span></span> <span class="hljs-comment"><span class="hljs-comment"># optional</span></span></code> </pre> <br>  After uncommenting this line, the sound returned, mpd started working normally. <br><br><h3>  Results </h3><br>  In general, the task can be considered completed. <br><br>  At the moment, you can listen to any music from the tablet / phone via WiFi on the speakers, you can turn on the network player, play music from the orange on the phone / tablet. <br><br>  The plans are to finish the dlna-renderer, configure the parser for mpd (so that I can search for music on the network myself), add a hard disk (the speed on Samba is still low). <br><br>  It turned out quite conveniently, functionally and simply, and cheap (for all together 1900 rubles, the OrangePi itself and the microSD card).  If you take the kit (OrangePi, case, board and microSD), you can meet the same amount if you try. <br><br>  That's all, I will be happy reviews and comments. </div><p>Source: <a href="https://habr.com/ru/post/341650/">https://habr.com/ru/post/341650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341640/index.html">Lenovo ThinkSystem SR950 Server Overview</a></li>
<li><a href="../341642/index.html">PM from Facebook: Counterintuitive conclusions about management (part 1)</a></li>
<li><a href="../341644/index.html">Security Week 44: a quiet hunt, or Carbanak to help, why the Firefox features Tor Browser, a Google loophole - buganizer</a></li>
<li><a href="../341646/index.html">Ten Node.js Questions You Can't Answer</a></li>
<li><a href="../341648/index.html">Statistics identify software vulnerabilities in the framework of certification tests</a></li>
<li><a href="../341652/index.html">From user to CAD developers</a></li>
<li><a href="../341654/index.html">The cat died, the tail peeled off</a></li>
<li><a href="../341656/index.html">We invite to the conference FPConf 2017</a></li>
<li><a href="../341660/index.html">Streaming and analyzing Java application logs in MS Azure using Log4j and Stream Analytics</a></li>
<li><a href="../341662/index.html">Report - overview of the capabilities and architecture of CppComet comets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>