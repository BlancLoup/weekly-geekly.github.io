<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Banana Pi - backup server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task 
 There are three hosts. Two in the home network and one remote. Backup requires an independent backup server, which can be connected directly to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Banana Pi - backup server</h1><div class="post__text post__text-html js-mediator-article"><h3>  Task </h3><br>  There are three hosts.  Two in the home network and one remote.  Backup requires an independent backup server, which can be connected directly to your home network or placed remotely.  The main task: to make regular backups of both home and remote systems.  The server should be as economical as possible.  All hosts and backup server use FreeBSD operating system. <br><br>  The easiest way as a server to adapt the old computer.  However, he must be on duty around the clock and therefore will eat a lot of electricity.  So I turned my attention to single board computers on the ARM processor.  This processor is supported by the FreeBSD operating system. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68a/1fd/814/68a1fd81483d42029fd29d0678adf933.jpg" alt="image"></div><br>  The optimal choice of Banana Pi M1.  Suitable processor and memory.  You can connect a SATA drive.  The parameters are quite satisfactory for the backup server, which has nowhere to rush. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      BackupPC is selected as the software solution.  Everything is fine with it except for one thing: archives are not encrypted.  To upload a copy of the archive to the cloud (and even more so to the non-kosher mail.ru), additional encryption is required.  But this is not a separate question on this topic.  Access to the BackupPC web interface requires a web server.  The classic installation for BackupPC proposes Apache.  But the hand does not rise to a small Banana Pi to pile such a monster.  Therefore, it will be nginx. <br><a name="habracut"></a><br><h3>  Iron </h3><br>  The following equipment was ordered on aliexpress: <br><br>  1. <a href="https://www.aliexpress.com/store/product/Original-BPI-M1-Banana-Pi-A20-Dual-Core-1GB-RAM-Open-source-development-board-singel-board/1659037_32353238101.html">Banana Pi A20 Dual Core 1GB RAM singel-board computer</a> <br>  2. <a href="https://www.aliexpress.com/item/BPI-M1-Banana-PI-M1-Case-Box-Black-Color-Professional-ABS-plastic-Banana-Pi-box-BPI/32351885946.html%3Fws_ab_test%3Dsearchweb201556_8,searchweb201602_1_10048_10057_10047_10056_10065_10055_10054_10069_10059_10046_10058_10045_10017_10070_10060_10061_10052_10062_10053_10050_10051,searchweb201603_1%26btsid%3D786b86d0-3b5c-476d-8817-9601ed289622">Banana PI M1 Case</a> <br>  3. <a href="https://www.aliexpress.com/item/New-10-Sets-40pcs-Mini-PC-Banana-pi-Special-Aluminum-Heat-Sink-Radiator-Heatsink-CPU-and/32626616208.html%3Fws_ab_test%3Dsearchweb201556_8,searchweb201602_1_10048_10057_10047_10056_10065_10055_10054_10069_10059_10046_10058_10045_10017_10070_10060_10061_10052_10062_10053_10050_10051,searchweb201603_1%26btsid%3Dea8b242c-4bb8-4551-81b5-241c5a16bd5e">PC Banana pi Aluminum Heatsink CPU and RAM</a> <br>  4. <a href="https://www.aliexpress.com/store/product/Banana-Pi-SATA-cable-HDD-Cable-hard-disk-cable-Connect-2-5-inch-hard-disk-to/1659037_32353310072.html">Banana Pi M1 SATA cable</a> <br>  5. <a href="https://www.aliexpress.com/item/1set-5v-3a-Micro-Usb-Ac-dc-Power-Adapter-Eu-Plug-Charger-Supply-5v3a-For-Raspberry/32649273228.html%3Fws_ab_test%3Dsearchweb201556_8,searchweb201602_1_10057_10065_10056_10068_10055_10054_112_10069_10059_110_10058_111_10073_10017_109_10070_108_10060_10061_10052_10062_10053_10050_10051,searchweb201603_1%26btsid%3D4cffbbde-f5d3-4d37-b9d3-b2768002fed9">5v 3a Micro USB Ac / dc Power Adapter Eu</a> <br><br>  The computer board is made neatly.  This inspires confidence that it will work normally.  Loaded FreeBSD 11. It works.  The case is also made very well.  Although at first, it seems.  did not want to gather.  In appearance, the body is symmetrical.  But if you look closely, you may find that on one side one side support on the bottom cover of the case has a slightly different shape.  A short side cover (on which the Power and Reset buttons are) sits lower than the opposite cover.  Everything else is quite gathered.  It is only necessary to pull off the screws.  Included are rubber feet that are glued to the holes with screws. <br><br>  The initial assembly of the test, so the legs, of course, did not glue.  It will take more to disassemble to install radiators.  The body is warm.  What is there and how heats up specifically check, when the device starts to work in normal mode.  A lot with two sets of radiators was purchased.  There are four of them in the set.  One for each chip.  A set of radiators with one set is not attached.  Therefore, we have a spare.  Ali also suggests some ceramic radiators that do not understand how they should dissipate heat.  They have no edges - just a thick sticker on the chip.  Most likely it is something inanimate type of Chinese memory, batteries or LED-lamps. <br><br>  The ventilation properties of the case are not the best.  There is a grill on the bottom cover, but it is only one and there is no through-flow of air.  However, the case itself is comfortable.  For everything there are holes Made for sure.  They fit perfectly with the board.  There is only a hole for the microphone.  And he is not needed.  On the top cover there are two additional hatch, closing the connectors, which I will not use.  There is also a light guide that leads to the surface of the case the light from the red LED on the board, indicating the power connection.  Another minus of the case is that there are no holes for mounting it on the wall. <br><br>  The power supply unit is recommended for 2A, but I ordered three, because  I plan to use with an external 2.5 "HDD, for which it is quite good to have a power supply unit with a power reserve. This means a peak mode. In the current mode, the consumption of the entire system should fit in 1A. <br><br><h3>  Task execution </h3><br>  The system is loaded onto an SD card.  The configuration is basic.  Further, it will need to adapt to your needs.  In addition, the option <code>growfs_enable="YES"</code> added to rc.conf.  When you first start the system, it ensures the use of the full amount of your card.  Another one-time option is to get an IP address via DHCP for initial access to the board. <br><br>  In order to be able to connect to the board via SSH, initially the system provides two users freebsd and root.  Passwords match names.  Do not forget to replace them with more secure ones.  First you need to create a new rc.conf.  By default, sendmail is disabled.  It is useful to us for sending BackupPC messages.  Therefore, the disconnect lines from the config are removed.  Now sendmail can send mail from localhost. <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">## common #apcupsd_enable=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"YES"</span></span></span><span class="hljs-meta"> hostname=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"foo.example.com"</span></span></span><span class="hljs-meta"> keymap=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"us.dvorak.kbd"</span></span></span><span class="hljs-meta"> ntpd_enable=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"YES"</span></span></span><span class="hljs-meta"> ntpd_sync_on_start=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"YES"</span></span></span><span class="hljs-meta"> sshd_enable=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"YES"</span></span></span><span class="hljs-meta"> ## net ifconfig_dwc0_ipv6=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"inet6 accept_rtadv"</span></span></span><span class="hljs-meta"> rtsold_enable=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"YES"</span></span></span><span class="hljs-meta"> ipv6_defaultrouter=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"2a01:348:1f9:29::1"</span></span></span><span class="hljs-meta"> ## nginx nginx_enable=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"YES"</span></span></span><span class="hljs-meta"> spawn_fcgi_enable=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"YES"</span></span></span><span class="hljs-meta"> fcgiwrap_enable=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"YES"</span></span></span><span class="hljs-meta"> fcgiwrap_user=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"bpc"</span></span></span></span></code> </pre> <br>  <code>#apcupsd_enable="YES"</code> - while disabled, a backup power supply will be connected when switching to production.  You see <code>keymap="us.dvorak.kbd"</code> - this is purely my personal thing.  In the case of connection from the console, I need to provide the keyboard layout I need.  The fee does not store the current time.  It is requested from the ntp server.  Therefore, it is planned to launch the corresponding demon. <br><br>  Added the usual user who lives on all my hosts.  I also added a .ssh / authorized_keys file, installed the necessary shell for it.  Now you can get rid of the initial user "freebsd".  And you can not start a new user, and stay with the existing one.  And in general, you can do only by the user, who will create BackupPC, but then it will have to be included in the wheel group and give password access for the case of the used console.  We must remember that the resources of a single-board computer are limited.  And this device to perform one task.  Excess software is not needed. <br><br>  I usually use the ports system on all my hosts.  Now I will try to do without them. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># pkg install </span></span></code> </pre> <br>  Packages are a less flexible solution, but they will save time.  So, put zsh, vim and mc.  Vim - must have.  You can do without zsh - this is not desktop.  Once set up, nailed to the wall and let them live there.  MC is sometimes useful for clarity, but you can live without it. <br><br>  SD card is selected in size 2 GB.  Those.  correct gigabytes there will be 1.8.  So some "excesses" in the software you can afford.  Initially, the system took about 1 GB.  The rest for the user.  Some cards Banana does not see.  So if the system does not boot, then you should not panic, but you just need to try another SD card. <br><br>  Install BackupPC.  There are some features.  Please note - in rc.conf there is no launch of BackupPC.  We will run it manually.  Thus launched BackupPC will at any time have access to all the hosts listed in its configuration.  But to go from a backup user to any other host just will not work.  He will ask for the passphrase to access the key.  However, in the case of a server reboot, for example, with a long-term power outage, when the server starts after the system has stopped the backup power supply, you will have to download BackupPC again.  In order not to miss such an event, cron every three hours checks for the presence of an active BackupPC.  If the BackupPC process is not running, the server will send emails. <br><br>  In addition, BackupPC itself, if something is wrong, sends email notifications.  You can check the operation of this service with the command (of course, if the Email section of the backupc configuration is correctly configured): <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">BackupPC_sendEmail</span></span> -u your<span class="hljs-variable"><span class="hljs-variable">@email</span></span>.address</code> </pre> <br>  In the current version, BackupPC does not support IPv6.  We'll have to patch him a little in accordance with the <a href="https://github.com/backuppc/backuppc/pull/29/files%3Fdiff%3Dsplit.">article on Github</a> .  There is one feature.  The configure.pl file is missing from the installed configuration.  Instead, I made a change to /usr/local/libexec/backuppc/update.pl.  After editing files, BackupPC was able to work with sixth IP addresses.  No problems happened. <br><br>  You will also need to install the p5-File-RsyncP-0.74 - Perl Rsync client package, since  the rsync method will be used to implement the backup. <br><br>  When installing BackupPC, a user of the same name is created with minimal rights.  We need a real user.  The name backuppc is too long and inconvenient.  Therefore, it is more convenient to use a shorter bpc.  We can connect to it to run BackupPC.  And BackupPC will go to the serviced hosts under his name.  Due to the user name change, the / usr / local / www / backuppc directory should be renamed to / usr / local / www / bpc. <br><br>  Now the backup host looks in / etc / passwd like this: <br><br><pre> <code class="hljs pgsql">bpc:*:<span class="hljs-number"><span class="hljs-number">301</span></span>:<span class="hljs-number"><span class="hljs-number">301</span></span>:BackupPC <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>:/home/bpc:/usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/zsh</code> </pre> <br>  There are files in the user's home directory: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-rwxr--r--</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> 304 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nov</span></span> 13 19<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:02</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">agent</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-rw-r--r--</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> 110 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nov</span></span> 20 12<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:11</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">agent-info</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-rwxr--r--</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> 158 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nov</span></span> 19 10<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:21</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mailbpc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-rw-r--r--</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> 38 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nov</span></span> 19 09<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:51</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mailtext</span></span></code> </pre> <br>  <code>agent</code> - script to run BackupPC.  It is usually called from your desktop or another computer that is allowed access: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">foo</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">example</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">com</span></span> /home/bpc/agent</code> </pre> <br>  Script content: <br><br><pre> <code class="hljs pgsql">#!/usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/zsh ## ssh-agent <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the file pid=`ps ax| grep ssh-agent | grep -v grep` <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ "$pid" = "" ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ssh-agent | head <span class="hljs-number"><span class="hljs-number">-2</span></span> &gt; ~/agent-<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> ## Setup Environment <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ssh-agent source ~/agent-<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> ssh-<span class="hljs-keyword"><span class="hljs-keyword">add</span></span> fi ## <span class="hljs-keyword"><span class="hljs-keyword">Start</span></span> BackupPC <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> term the <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/BackupPC -d</code> </pre> <br>  Checks for the presence of a running ssh-agent, and if it is not running, starts it, sets the environment for it, starts ssh-add, starts BackupPC.  The connection to the host from which the launch occurs is closed.  If the ssh-agent process is detected, the script ends with a message stating that the agent is already running. <br><br>  <code>agent-info</code> file with environment settings.  It creates an agent. <br>  <code>mailbpc</code> - email warning script that BackupPC has crashed: <br><br><pre> <code class="hljs pgsql">#!/usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/zsh pid=`ps ax | grep perl | grep -v grep` <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ "$pid" = "" ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> mail -s "bpc failure" postmaster@example.com &lt; /home/bpc/mailtext fi</code> </pre> <br>  To perform a check (every three hours), for bpc via crontab -e, add the line: <br><br><pre> <code class="hljs markdown">3 <span class="hljs-emphasis"><span class="hljs-emphasis">*/3 *</span></span> <span class="hljs-bullet"><span class="hljs-bullet">* *</span></span> /home/bpc/mailbpc</code> </pre> <br>  <code>mailtext</code> - here add the text at your discretion.  Something like: ‚ÄúBackupPC does not work.  We need to restart it. ‚ÄùIf everything is in order, emails will not come. <br><br>  ~ Bpc / .ssh content <br><br><pre> <code class="hljs css">~ % <span class="hljs-selector-tag"><span class="hljs-selector-tag">ls</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-l</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.ssh</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">total</span></span> 20 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-rw-r--r--</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> 400 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 28 11<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:43</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">authorized_keys</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-rw-------</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> 35 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nov</span></span> 7 16<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:15</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-rw-------</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> 444 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nov</span></span> 15 12<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:46</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">id_ed25519</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-rw-r--r--</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> 90 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nov</span></span> 15 14<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:49</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">id_ed25519</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-rw-r--r--</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span> 762 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nov</span></span> 20 14<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:39</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">known_hosts</span></span></code> </pre> <br>  <code>authorized_keys</code> - here are added the public keys of the hosts, from which you can start BackupPC. <br>  <code>config</code> - local ssh configuration file.  Required if a new host has been added to BackupPC.  Provides automatic access to the new host.  By default, this keyword uses the ask argument, and backupc cannot answer questions.  Content: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">Host</span></span> * StrictHostKeyChecking <span class="hljs-literal"><span class="hljs-literal">no</span></span></code> </pre> <br>  <code>id_ed25519</code> - private key, which BackupPC encrypts messages to its clients <br>  <code>id_ed25519.pub</code> - public key that clients need to add to their authorized_keys <br>  <code>known_hosts</code> is a list of clients that is updated automatically due to the instructions contained in the config file. <br><br>  BackupPC can be tried before the launch is configured via the agent.  For a trial run, you need to make an initial adjustment backuppc / config.pl - write the modified user name.  Check file paths, specify server name.  IP addresses are enough, but the IP version of the sixth version is more cumbersome than the fourth version.  The domain name must be registered in / etc / hosts or in the DNS zone file of the server of your domain.  Detailed configuration can be configured later via the web interface.  The program‚Äôs web interface is quite usable.  There is context-sensitive help for all items. <br><br>  Check whether it starts or not.  To do this, go to the server under the user bpc. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">foo</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">example</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">com</span></span></code> </pre> <br>  After that do a test run: <br><br><pre> <code class="hljs pgsql">/usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/BackupPC -d</code> </pre> <br>  You can see the result through top or using the ps command: <br><br><pre> <code class="hljs pgsql">~ % ps aux | grep perl bpc <span class="hljs-number"><span class="hljs-number">753</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">15252</span></span> <span class="hljs-number"><span class="hljs-number">11908</span></span> - I <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00.19</span></span> /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/perl /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/BackupPC -d bpc <span class="hljs-number"><span class="hljs-number">754</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-number"><span class="hljs-number">0.8</span></span> <span class="hljs-number"><span class="hljs-number">12748</span></span> <span class="hljs-number"><span class="hljs-number">8084</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00.77</span></span> /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/perl /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/BackupPC_trashClean</code> </pre> <br>  Now we take nginx.  First, run it in the standard configuration: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># service nginx start</span></span></code> </pre> <br>  If all is well, then we bring nginx.conf to this form: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">load_module</span></span> /usr/local/libexec/nginx/ngx_mail_module.so; <span class="hljs-attribute"><span class="hljs-attribute">load_module</span></span> /usr/local/libexec/nginx/ngx_stream_module.so; <span class="hljs-attribute"><span class="hljs-attribute">user</span></span> bpc bpc; <span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> auto; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> mime.types; <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> application/octet-stream; <span class="hljs-attribute"><span class="hljs-attribute">sendfile</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span>; <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> [::]:<span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> foo.example.com; <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.html /index.cgi; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /usr/local/www; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/nginx/access.log; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/error.log; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">auth_basic</span></span> <span class="hljs-string"><span class="hljs-string">"BackupPC admin"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">auth_basic_user_file</span></span> /usr/local/etc/nginx/.passwd; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ \.cgi$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> fastcgi_params; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_pass</span></span> unix:/var/run/fcgiwrap/fcgiwrap.sock; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> REMOTE_ADDR <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> REMOTE_USER <span class="hljs-variable"><span class="hljs-variable">$remote_user</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> SCRIPT_FILENAME /usr/local/www/cgi-bin/BackupPC_Admin; <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> /<span class="hljs-number"><span class="hljs-number">404</span></span>.html; <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">500</span></span> <span class="hljs-number"><span class="hljs-number">502</span></span> <span class="hljs-number"><span class="hljs-number">503</span></span> <span class="hljs-number"><span class="hljs-number">504</span></span> /50x.html; } } }</code> </pre> <br>  Do not forget to install the packages that are referenced by this configuration and rc.conf. <br><br><pre> <code class="hljs pgsql">fcgiwrap<span class="hljs-number"><span class="hljs-number">-1.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>_3 Simple FastCGI <span class="hljs-keyword"><span class="hljs-keyword">wrapper</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CGI scripts spawn-fcgi<span class="hljs-number"><span class="hljs-number">-1.6</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>_2 Spawns fastcgi applications</code> </pre> <br>  Standard port 22 for SSH is better to replace with another, otherwise stupid bruteforcers will jam out.  Rule sshd_config: Port 12345. To let BackupPC go to other hosts, we perform a similar operation with the ssh_config file. <br><br>  Now you need to restrict access to the BackupPC web interface.  For this, I wanted to use htdigest.  But with this turned out a bummer.  The installed package does not have this option.  In nginx, you can connect modules.  I'm trying to do it.  On github is the desired module.  True five years ago.  I'm trying to compile it.  The code is outdated and no longer gives a positive result with modern nginx.  I find a more modern version.  Everything compiles.  But rejoice early.  htdigest is not created as a plug-in.  As a result, I had to get by with the usual htpasswd and create a password using the openssl password.  Alternatively, install from ports or from src.  What is unnecessarily troublesome.  The BackupPC web interface will be available at foo.example.com. <br><br>  I took the first step.  Entered the first host for backup.  Clicked Save.  It seems to be all right.  You need to check the ping for this client. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ping6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">client</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.your</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.domain</span></span></code> </pre> <br>  Further it should be ensured that on the other hand, i.  on the client, someone could call rsync and run around the client to pile up the files needed for backup. <br><br><pre> <code class="hljs javascript">bpc:*:<span class="hljs-number"><span class="hljs-number">1006</span></span>:<span class="hljs-number"><span class="hljs-number">1006</span></span>:backuppc <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> foo:<span class="hljs-regexp"><span class="hljs-regexp">/home/</span></span>bpc:<span class="hljs-regexp"><span class="hljs-regexp">/bin/</span></span>csh</code> </pre> <br>  To do this, a bpc user is created on each client, which must have access rights to all files.  However, these rights must be strictly limited to the scope of the task.  To do this, a line is added to / usr / local / etc / sudoers: <br><br><pre> <code class="hljs pgsql">bpc <span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span>=NOPASSWD: /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/rsync <span class="hljs-comment"><span class="hljs-comment">--server *</span></span></code> </pre> <br>  The next step is to check the access to the client.  Just trying to access ssh on the client.  Ssh will immediately ask for the passphrase for accessing the key.  If everything works out, then BackupPC will also come.  However, in practice, avoiding the fact that BackupPC never reported: ‚ÄúUnable to read 4 bytes‚Äù is very difficult.  This means that he can not connect to the client.  As a rule, the reason in such cases is own inattention.  We fix errors and voil√† - the server connects to the host. <br><br>  One important thing is not done yet - the SATA disk is not connected in the absence of it at the moment.  While for debugging purposes, a USB flash drive is used as a drive. <br><br>  Next, you need the standard configuration and debugging of BackupPC, which is described in detail in the documentation and you can find a lot of things on this topic on the Internet.  When configuring BackupPC it will be useful to use the command: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">BackupPC_dump</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-v</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-f</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bpc</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">your</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span></code> </pre> <br>  It gives a detailed conclusion, the analysis of which helps to get a working backuppc well. <br><br>  So everything is ready.  The system is working.  Stayed the final touch.  You need to backup the SD card. <br><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta"># dd </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">=/dev/da0 of=//bpc.img bs=1m</span></span></code> </pre> <br>  Now the work is really finished and there is a backup copy from which you can restore the system to a new SD card in which case. <br><br>  The article is not all reflected in sufficient detail.  Actually there is almost no BackupPC setup process.  But the main goal is not in detail, but in principle the possibility of deploying a BackupPC on the Banana Pi M1 running the FreeBSD 11 operating system. </div><p>Source: <a href="https://habr.com/ru/post/316102/">https://habr.com/ru/post/316102/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316090/index.html">Riot.js 3.0 released</a></li>
<li><a href="../316092/index.html">As we came up with and made our first game on Android. Part 2: Levels</a></li>
<li><a href="../316094/index.html">What discounts are hosters on this Black Friday</a></li>
<li><a href="../316098/index.html">Inside NetBeans. Prologue</a></li>
<li><a href="../316100/index.html">Connecting the character LCD to the board from WD MyBook Live on AppliedMicro APM82181. Ending</a></li>
<li><a href="../316104/index.html">How IT professionals work. Anton Petrochenko, Panasonic Russia</a></li>
<li><a href="../316106/index.html">A boring one-line calculator on sed</a></li>
<li><a href="../316108/index.html">Trello Clone on Phoenix and React. Parts 10-12. Long Term Finish</a></li>
<li><a href="../316110/index.html">‚ÄúLead me better‚Äù: What will make the work of a novice programmer more effective</a></li>
<li><a href="../316112/index.html">Operating system from scratch (almost)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>